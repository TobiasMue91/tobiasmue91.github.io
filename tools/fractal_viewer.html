<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Fractal Explorer</title>
    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåÄ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = {darkMode: 'class'}</script>
    <style>
        * {
            box-sizing: border-box
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }
            to {
                opacity: 1
            }
        }

        .animate-fadeIn {
            animation: fadeIn .2s ease-out
        }

        .fractal-canvas {
            touch-action: none;
            cursor: grab
        }

        .fractal-canvas.grabbing {
            cursor: grabbing
        }

        input[type="range"] {
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            transition: transform .1s
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            border: none
        }

        input[type="range"]:hover::-webkit-slider-thumb {
            transform: scale(1.1)
        }

        .dark input[type="range"] {
            background: #374151
        }

        .btn {
            font-weight: 500;
            transition: all .1s
        }

        .btn:active {
            transform: scale(.96)
        }

        .btn:disabled {
            opacity: .5;
            pointer-events: none
        }

        .overlay {
            background: rgba(0, 0, 0, .75);
            backdrop-filter: blur(4px)
        }

        .spinner {
            width: 28px;
            height: 28px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin .7s linear infinite
        }

        .spot-btn {
            transition: all .1s
        }

        .spot-btn:hover {
            background: #e0e7ff
        }

        .dark .spot-btn:hover {
            background: #312e81
        }

        kbd {
            padding: 2px 6px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: .7rem;
            font-family: monospace;
            background: #f8fafc
        }

        .dark kbd {
            background: #374151;
            border-color: #4b5563;
            color: #e5e7eb
        }

        .gallery-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            aspect-ratio: 4/3
        }

        .gallery-item img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .status-pill {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors">
<div class="min-h-screen flex flex-col">
    <header class="bg-indigo-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üåÄ</span>
                <div><h1 class="text-lg font-bold tracking-tight">Fractal Explorer</h1></div>
            </div>
            <div class="flex items-center gap-1">
                <button id="historyBack" class="p-2 rounded-lg hover:bg-white/10 disabled:opacity-30" disabled
                        title="Back">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <button id="historyForward" class="p-2 rounded-lg hover:bg-white/10 disabled:opacity-30" disabled
                        title="Forward">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
                <div class="w-px h-5 bg-white/20 mx-1"></div>
                <button id="themeToggle" class="p-2 rounded-lg hover:bg-white/10" title="Toggle theme">
                    <svg id="darkIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                    </svg>
                    <svg id="lightIcon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                              d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                              clip-rule="evenodd"/>
                    </svg>
                </button>
                <button id="helpBtn" class="p-2 rounded-lg hover:bg-white/10" title="Help (H)">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>
    <main class="flex-grow container mx-auto px-4 py-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2 space-y-4">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <div class="relative bg-gray-900">
                        <canvas id="fractalCanvas" class="w-full fractal-canvas"></canvas>
                        <div id="loadingOverlay"
                             class="absolute inset-0 flex items-center justify-center overlay hidden">
                            <div class="text-center text-white">
                                <div class="spinner mx-auto mb-2"></div>
                                <span class="text-xs opacity-80">Rendering high quality...</span>
                            </div>
                        </div>
                        <div id="statusPill" class="absolute top-3 left-3 status-pill bg-indigo-500 text-white hidden">
                            Interactive
                        </div>
                        <div id="coords"
                             class="absolute bottom-3 left-3 bg-gray-900/80 text-white text-xs px-2 py-1 rounded font-mono opacity-0 transition-opacity"></div>
                        <div id="zoomIndicator"
                             class="absolute top-3 right-3 bg-gray-900/80 text-white text-xs px-2 py-1 rounded font-mono">
                            1.0√ó
                        </div>
                    </div>
                    <div class="p-3 border-t border-gray-200 dark:border-gray-700 flex flex-wrap gap-2 justify-center">
                        <button id="zoomIn"
                                class="btn bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg text-sm flex items-center gap-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                      d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                                      clip-rule="evenodd"/>
                            </svg>
                            Zoom
                        </button>
                        <button id="zoomOut"
                                class="btn bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg text-sm flex items-center gap-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z"
                                      clip-rule="evenodd"/>
                            </svg>
                            Out
                        </button>
                        <button id="reset"
                                class="btn bg-gray-500 hover:bg-gray-600 text-white px-3 py-1.5 rounded-lg text-sm flex items-center gap-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                      d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1z"
                                      clip-rule="evenodd"/>
                            </svg>
                            Reset
                        </button>
                        <button id="save"
                                class="btn bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg text-sm flex items-center gap-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                            </svg>
                            Save
                        </button>
                        <button id="share"
                                class="btn bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg text-sm flex items-center gap-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"/>
                            </svg>
                            Share
                        </button>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-gray-900 dark:text-white text-sm">Saved Fractals</h3>
                        <button id="clearGallery" class="text-xs text-gray-400 hover:text-red-500">Clear</button>
                    </div>
                    <div id="gallery" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-2"></div>
                    <div id="emptyGallery" class="text-center py-4 text-gray-400 dark:text-gray-500 text-sm">
                        <svg class="w-8 h-8 mx-auto mb-1 opacity-50" fill="none" stroke="currentColor"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                  d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Saved fractals appear here
                    </div>
                </div>
            </div>
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 space-y-4 sticky top-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fractal
                            Type</label>
                        <select id="fractalType"
                                class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <option value="mandelbrot">Mandelbrot Set</option>
                            <option value="julia">Julia Set</option>
                            <option value="burningShip">Burning Ship</option>
                            <option value="phoenix">Phoenix</option>
                            <option value="newton">Newton</option>
                            <option value="tricorn">Tricorn</option>
                        </select>
                    </div>
                    <div id="juliaParams" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Julia
                            Constant</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="juliaReal" value="-0.7" step="0.01"
                                   class="p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"
                                   placeholder="Real">
                            <input type="number" id="juliaImag" value="0.27" step="0.01"
                                   class="p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"
                                   placeholder="Imag">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Color
                            Scheme</label>
                        <select id="colorScheme"
                                class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <option value="classic">Classic</option>
                            <option value="rainbow">Rainbow</option>
                            <option value="fire">Fire</option>
                            <option value="ocean">Ocean</option>
                            <option value="cosmic">Cosmic</option>
                            <option value="neon">Neon</option>
                            <option value="pastel">Pastel</option>
                            <option value="grayscale">Grayscale</option>
                        </select>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <label class="font-medium text-gray-700 dark:text-gray-300">Iterations</label>
                            <span id="iterValue"
                                  class="text-indigo-600 dark:text-indigo-400 font-mono text-xs">150</span>
                        </div>
                        <input type="range" id="maxIter" min="50" max="500" value="150" step="10" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <label class="font-medium text-gray-700 dark:text-gray-300">Quality</label>
                            <span id="qualityLabel" class="text-indigo-600 dark:text-indigo-400 text-xs">Balanced</span>
                        </div>
                        <input type="range" id="quality" min="1" max="4" value="2" class="w-full">
                        <p class="text-xs text-gray-400 mt-1">Higher = sharper but slower</p>
                    </div>
                    <div class="pt-3 border-t border-gray-200 dark:border-gray-700">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Interesting
                            Spots</label>
                        <div class="grid grid-cols-3 gap-1.5" id="spots">
                            <button class="spot-btn p-1.5 bg-gray-100 dark:bg-gray-700 rounded text-xs text-gray-700 dark:text-gray-300"
                                    data-spot="seahorse">Seahorse
                            </button>
                            <button class="spot-btn p-1.5 bg-gray-100 dark:bg-gray-700 rounded text-xs text-gray-700 dark:text-gray-300"
                                    data-spot="spiral">Spiral
                            </button>
                            <button class="spot-btn p-1.5 bg-gray-100 dark:bg-gray-700 rounded text-xs text-gray-700 dark:text-gray-300"
                                    data-spot="elephant">Elephant
                            </button>
                            <button class="spot-btn p-1.5 bg-gray-100 dark:bg-gray-700 rounded text-xs text-gray-700 dark:text-gray-300"
                                    data-spot="lightning">Lightning
                            </button>
                            <button class="spot-btn p-1.5 bg-gray-100 dark:bg-gray-700 rounded text-xs text-gray-700 dark:text-gray-300"
                                    data-spot="dendrite">Dendrite
                            </button>
                            <button class="spot-btn p-1.5 bg-gray-100 dark:bg-gray-700 rounded text-xs text-gray-700 dark:text-gray-300"
                                    data-spot="minibrot">Mini-brot
                            </button>
                        </div>
                    </div>
                    <button id="randomize"
                            class="w-full btn bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg flex items-center justify-center gap-2 text-sm">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z"/>
                        </svg>
                        Randomize
                    </button>
                    <div class="text-center text-xs text-gray-400 pt-2">
                        Render: <span id="renderTime">0</span>ms
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
<div id="helpModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full max-h-[85vh] overflow-y-auto animate-fadeIn">
        <div class="p-5">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">Help</h3>
                <button id="closeHelp" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="space-y-4 text-gray-600 dark:text-gray-300 text-sm">
                <div>
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-1">Mouse</h4>
                    <ul class="space-y-0.5">
                        <li><strong>Drag</strong> ‚Äî Pan</li>
                        <li><strong>Scroll</strong> ‚Äî Zoom</li>
                        <li><strong>Double-click</strong> ‚Äî Zoom to point</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-1">Keyboard</h4>
                    <div class="grid grid-cols-2 gap-1">
                        <div><kbd>+</kbd> <kbd>-</kbd> Zoom</div>
                        <div><kbd>R</kbd> Reset</div>
                        <div><kbd>‚Üê</kbd> <kbd>‚Üí</kbd> History</div>
                        <div><kbd>Space</kbd> Random</div>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-1">About</h4>
                    <p>Fractals are infinitely complex self-similar patterns. Zoom in to discover endless detail!</p>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="shareModal"
     class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full animate-fadeIn">
        <div class="p-5">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">Share</h3>
                <button id="closeShare" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Copy link to share:</p>
            <div class="flex gap-2">
                <input id="shareUrl" type="text" readonly
                       class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white text-xs font-mono">
                <button id="copyUrl"
                        class="btn bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-lg text-sm">Copy
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    const canvas = document.getElementById('fractalCanvas'), ctx = canvas.getContext('2d');
    const SPOTS = {
        seahorse: {cx: -0.747, cy: 0.1, z: 50, type: 'mandelbrot'},
        spiral: {cx: -0.761574, cy: -0.0847596, z: 1500, type: 'mandelbrot'},
        elephant: {cx: 0.275, cy: 0.006, z: 200, type: 'mandelbrot'},
        lightning: {cx: -0.170337, cy: -1.0651, z: 100, type: 'mandelbrot'},
        dendrite: {cx: -0.1011, cy: 0.9563, z: 50, type: 'mandelbrot'},
        minibrot: {cx: -1.7499, cy: 0, z: 1000, type: 'mandelbrot'}
    };
    const state = {
        centerX: -0.5, centerY: 0, zoom: 1, type: 'mandelbrot', maxIter: 150, colorScheme: 'classic', quality: 2,
        juliaReal: -0.7, juliaImag: 0.27, isDragging: false, lastX: 0, lastY: 0,
        history: [], historyIndex: -1, gallery: JSON.parse(localStorage.getItem('fractal-gallery') || '[]'),
        isDark: localStorage.getItem('darkMode') === 'true',
        isInteracting: false, renderStart: 0
    };
    let workerLQ = null, workerHQ = null, interactionTimeout = null, hqPending = false;

    // Worker code as string
    const workerCode = `
onmessage=function(e){
const{w,h,cx,cy,z,iter,type,colors,q,jReal,jImag,isLQ}=e.data;
const skip=isLQ?Math.max(1,5-q):1;
const img=new ImageData(w,h),d=img.data;
for(let y=0;y<h;y+=skip){
for(let x=0;x<w;x+=skip){
const zx=3*(x-w/2)/(z*w)+cx,zy=2*(y-h/2)/(z*h)+cy;
let val;
switch(type){
case'julia':val=julia(zx,zy,jReal,jImag,iter);break;
case'burningShip':val=burningShip(zx,zy,iter);break;
case'phoenix':val=phoenix(zx,zy,iter);break;
case'newton':val=newton(zx,zy,iter);break;
case'tricorn':val=tricorn(zx,zy,iter);break;
default:val=mandelbrot(zx,zy,iter);
}
const[r,g,b]=getColor(val,iter,colors);
for(let dy=0;dy<skip&&y+dy<h;dy++){
for(let dx=0;dx<skip&&x+dx<w;dx++){
const i=((y+dy)*w+(x+dx))*4;
d[i]=r;d[i+1]=g;d[i+2]=b;d[i+3]=255;
}}}
if(isLQ&&y%32===0)postMessage({type:'progress',img});
}
postMessage({type:'done',img});
};
function mandelbrot(x0,y0,max){let x=0,y=0,x2=0,y2=0,n=0;while(x2+y2<=4&&n<max){y=2*x*y+y0;x=x2-y2+x0;x2=x*x;y2=y*y;n++}return n}
function julia(x,y,cx,cy,max){let x2=x*x,y2=y*y,n=0;while(x2+y2<=4&&n<max){y=2*x*y+cy;x=x2-y2+cx;x2=x*x;y2=y*y;n++}return n}
function burningShip(x0,y0,max){let x=0,y=0,x2=0,y2=0,n=0;while(x2+y2<=4&&n<max){y=Math.abs(2*x*y)-y0;x=x2-y2+x0;x2=x*x;y2=y*y;n++}return n}
function phoenix(x,y,max){let x1=x,y1=y,x2=0,p=-0.5;for(let i=0;i<max;i++){const xx=x1*x1-y1*y1+x+p*x2,yy=2*x1*y1+y;if(xx*xx+yy*yy>4)return i;x2=x1;x1=xx;y1=yy}return max}
function newton(x,y,max){let zx=x,zy=y;for(let i=0;i<max;i++){const zx2=zx*zx,zy2=zy*zy,zx3=zx2*zx-3*zx*zy2,zy3=3*zx2*zy-zy2*zy,m=zx3*zx3+zy3*zy3;if(m<1e-6)return i;const d=3*(zx2+zy2);zx-=(zx3+1)/d;zy-=zy3/d}return max}
function tricorn(x0,y0,max){let x=0,y=0,x2=0,y2=0,n=0;while(x2+y2<=4&&n<max){y=-2*x*y+y0;x=x2-y2+x0;x2=x*x;y2=y*y;n++}return n}
function getColor(n,max,scheme){
if(n===max)return[0,0,0];
const t=n/max,s=Math.sqrt(t);
switch(scheme){
case'rainbow':return hsv(t,1,1);
case'fire':return hsv(t/3,1,Math.min(1,t*2));
case'ocean':return hsv(.55+t*.15,1,Math.min(1,t*2));
case'cosmic':return[Math.floor(128*(1+Math.sin(6.28*t))),Math.floor(128*(1+Math.sin(6.28*t+2.09))),Math.floor(128*(1+Math.sin(6.28*t+4.19)))];
case'neon':return hsv(t,.9,t<.5?.5+t:1);
case'pastel':return hsv(t,.4,1);
case'grayscale':const g=Math.floor(s*255);return[g,g,g];
default:return hsv(.58+t*.42,.85,s);
}}
function hsv(h,s,v){let r,g,b;const i=Math.floor(h*6),f=h*6-i,p=v*(1-s),q=v*(1-f*s),t=v*(1-(1-f)*s);switch(i%6){case 0:r=v;g=t;b=p;break;case 1:r=q;g=v;b=p;break;case 2:r=p;g=v;b=t;break;case 3:r=p;g=q;b=v;break;case 4:r=t;g=p;b=v;break;case 5:r=v;g=p;b=q;break}return[Math.round(r*255),Math.round(g*255),Math.round(b*255)]}`;

    function createWorker() {
        const blob = new Blob([workerCode], {type: 'application/javascript'});
        return new Worker(URL.createObjectURL(blob));
    }

    function initWorkers() {
        workerLQ = createWorker();
        workerHQ = createWorker();
        workerLQ.onmessage = e => {
            if (e.data.type === 'progress' || e.data.type === 'done') {
                ctx.putImageData(e.data.img, 0, 0);
            }
            if (e.data.type === 'done' && !state.isInteracting && hqPending) {
                hqPending = false;
                renderHQ();
            }
        };
        workerHQ.onmessage = e => {
            if (e.data.type === 'done') {
                ctx.putImageData(e.data.img, 0, 0);
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('renderTime').textContent = Math.round(performance.now() - state.renderStart);
            }
        };
    }

    function getParams(isLQ) {
        return {
            w: canvas.width, h: canvas.height, cx: state.centerX, cy: state.centerY, z: state.zoom,
            iter: state.maxIter, type: state.type, colors: state.colorScheme, q: state.quality,
            jReal: state.juliaReal, jImag: state.juliaImag, isLQ
        };
    }

    function renderLQ() {
        workerLQ.postMessage(getParams(true));
        updateZoomDisplay();
    }

    function renderHQ() {
        document.getElementById('loadingOverlay').classList.remove('hidden');
        state.renderStart = performance.now();
        workerHQ.postMessage(getParams(false));
    }

    function updateZoomDisplay() {
        const z = state.zoom;
        document.getElementById('zoomIndicator').textContent = z >= 1000 ? (z / 1000).toFixed(1) + 'k√ó' : z.toFixed(1) + '√ó';
    }

    function startInteraction() {
        state.isInteracting = true;
        document.getElementById('statusPill').classList.remove('hidden');
        clearTimeout(interactionTimeout);
        renderLQ();
    }

    function endInteraction() {
        clearTimeout(interactionTimeout);
        interactionTimeout = setTimeout(() => {
            state.isInteracting = false;
            document.getElementById('statusPill').classList.add('hidden');
            hqPending = true;
// If LQ worker is idle, trigger HQ immediately
            renderHQ();
        }, 120);
    }

    function saveHistory() {
        const snap = {
            centerX: state.centerX,
            centerY: state.centerY,
            zoom: state.zoom,
            type: state.type,
            maxIter: state.maxIter,
            colorScheme: state.colorScheme,
            quality: state.quality,
            juliaReal: state.juliaReal,
            juliaImag: state.juliaImag
        };
        state.history = state.history.slice(0, state.historyIndex + 1);
        state.history.push(snap);
        if (state.history.length > 50) state.history.shift(); else state.historyIndex++;
        updateHistoryBtns();
    }

    function updateHistoryBtns() {
        document.getElementById('historyBack').disabled = state.historyIndex <= 0;
        document.getElementById('historyForward').disabled = state.historyIndex >= state.history.length - 1;
    }

    function goBack() {
        if (state.historyIndex > 0) {
            state.historyIndex--;
            Object.assign(state, state.history[state.historyIndex]);
            syncUI();
            renderHQ();
            updateHistoryBtns()
        }
    }

    function goForward() {
        if (state.historyIndex < state.history.length - 1) {
            state.historyIndex++;
            Object.assign(state, state.history[state.historyIndex]);
            syncUI();
            renderHQ();
            updateHistoryBtns()
        }
    }

    function syncUI() {
        document.getElementById('fractalType').value = state.type;
        document.getElementById('colorScheme').value = state.colorScheme;
        document.getElementById('quality').value = state.quality;
        document.getElementById('maxIter').value = state.maxIter;
        document.getElementById('iterValue').textContent = state.maxIter;
        document.getElementById('juliaReal').value = state.juliaReal;
        document.getElementById('juliaImag').value = state.juliaImag;
        updateQualityLabel();
        document.getElementById('juliaParams').classList.toggle('hidden', state.type !== 'julia');
        updateZoomDisplay();
    }

    function updateQualityLabel() {
        document.getElementById('qualityLabel').textContent = ['Fast', 'Balanced', 'High', 'Ultra'][state.quality - 1]
    }

    function randomize() {
        const types = ['mandelbrot', 'julia', 'burningShip', 'phoenix', 'newton', 'tricorn'];
        const colors = ['classic', 'rainbow', 'fire', 'ocean', 'cosmic', 'neon', 'pastel'];
        state.type = types[Math.floor(Math.random() * types.length)];
        state.colorScheme = colors[Math.floor(Math.random() * colors.length)];
        state.maxIter = 100 + Math.floor(Math.random() * 200);
        state.juliaReal = (Math.random() - .5) * 1.5;
        state.juliaImag = (Math.random() - .5) * 1.5;
        state.centerX = -.5 + Math.random() * .3 - .15;
        state.centerY = Math.random() * .3 - .15;
        state.zoom = .8 + Math.random() * .4;
        saveHistory();
        syncUI();
        renderHQ();
    }

    function saveFractal() {
        const img = canvas.toDataURL('image/png');
        state.gallery.push({
            img,
            settings: {
                centerX: state.centerX,
                centerY: state.centerY,
                zoom: state.zoom,
                type: state.type,
                maxIter: state.maxIter,
                colorScheme: state.colorScheme,
                juliaReal: state.juliaReal,
                juliaImag: state.juliaImag
            },
            date: Date.now()
        });
        if (state.gallery.length > 20) state.gallery = state.gallery.slice(-20);
        localStorage.setItem('fractal-gallery', JSON.stringify(state.gallery));
        loadGallery();
        const a = document.createElement('a');
        a.download = 'fractal-' + Date.now() + '.png';
        a.href = img;
        a.click();
    }

    function loadGallery() {
        const g = document.getElementById('gallery'), e = document.getElementById('emptyGallery');
        g.innerHTML = '';
        if (!state.gallery.length) {
            e.classList.remove('hidden');
            return
        }
        e.classList.add('hidden');
        state.gallery.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = 'gallery-item group cursor-pointer';
            div.innerHTML = `<img src="${item.img}" alt="Fractal"><div class="absolute inset-0 bg-black/0 group-hover:bg-black/50 transition-colors flex items-center justify-center gap-1 opacity-0 group-hover:opacity-100">
<button class="load-btn p-1 bg-white/90 hover:bg-white rounded-full"><svg class="w-3 h-3 text-gray-700" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1z" clip-rule="evenodd"/></svg></button>
<button class="del-btn p-1 bg-white/90 hover:bg-red-100 rounded-full"><svg class="w-3 h-3 text-gray-700" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button>
</div>`;
            div.querySelector('.load-btn').onclick = ev => {
                ev.stopPropagation();
                Object.assign(state, item.settings);
                saveHistory();
                syncUI();
                renderHQ()
            };
            div.querySelector('.del-btn').onclick = ev => {
                ev.stopPropagation();
                state.gallery.splice(i, 1);
                localStorage.setItem('fractal-gallery', JSON.stringify(state.gallery));
                loadGallery()
            };
            g.appendChild(div);
        });
    }

    function showShare() {
        const url = new URL(location);
        url.searchParams.set('v', btoa(JSON.stringify({
            cx: state.centerX,
            cy: state.centerY,
            z: state.zoom,
            t: state.type,
            i: state.maxIter,
            c: state.colorScheme,
            jr: state.juliaReal,
            ji: state.juliaImag
        })));
        document.getElementById('shareUrl').value = url.toString();
        document.getElementById('shareModal').classList.remove('hidden');
    }

    function init() {
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = Math.round(canvas.width * .667);
        if (state.isDark) {
            document.documentElement.classList.add('dark');
            document.getElementById('darkIcon').classList.remove('hidden');
            document.getElementById('lightIcon').classList.add('hidden')
        }
        initWorkers();
        syncUI();
        loadGallery();
        const params = new URLSearchParams(location.search);
        if (params.has('v')) {
            try {
                const d = JSON.parse(atob(params.get('v')));
                Object.assign(state, {
                    centerX: d.cx,
                    centerY: d.cy,
                    zoom: d.z,
                    type: d.t,
                    maxIter: d.i,
                    colorScheme: d.c,
                    juliaReal: d.jr,
                    juliaImag: d.ji
                });
                syncUI()
            } catch (e) {
            }
        }
        saveHistory();
        renderHQ();

// Mouse events
        canvas.addEventListener('mousedown', e => {
            state.isDragging = true;
            state.lastX = e.clientX;
            state.lastY = e.clientY;
            canvas.classList.add('grabbing');
            startInteraction()
        });
        canvas.addEventListener('mousemove', e => {
            const rect = canvas.getBoundingClientRect();
            const x = 3 * (e.clientX - rect.left - canvas.width / 2) / (state.zoom * canvas.width) + state.centerX;
            const y = 2 * (e.clientY - rect.top - canvas.height / 2) / (state.zoom * canvas.height) + state.centerY;
            const coords = document.getElementById('coords');
            coords.textContent = `${x.toFixed(6)}, ${y.toFixed(6)}i`;
            coords.style.opacity = '1';
            if (state.isDragging) {
                const dx = (e.clientX - state.lastX) / canvas.width * 3 / state.zoom;
                const dy = (e.clientY - state.lastY) / canvas.height * 2 / state.zoom;
                state.centerX -= dx;
                state.centerY -= dy;
                state.lastX = e.clientX;
                state.lastY = e.clientY;
                startInteraction();
            }
        });
        canvas.addEventListener('mouseup', () => {
            if (state.isDragging) {
                state.isDragging = false;
                canvas.classList.remove('grabbing');
                saveHistory();
                endInteraction()
            }
        });
        canvas.addEventListener('mouseleave', () => {
            state.isDragging = false;
            canvas.classList.remove('grabbing');
            document.getElementById('coords').style.opacity = '0'
        });
        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left) / canvas.width - .5;
            const my = (e.clientY - rect.top) / canvas.height - .5;
            const zf = e.deltaY < 0 ? 1.2 : .83;
            state.centerX += (1 - zf) * mx * 3 / state.zoom;
            state.centerY += (1 - zf) * my * 2 / state.zoom;
            state.zoom *= zf;
            startInteraction();
            endInteraction();
            saveHistory();
        }, {passive: false});
        canvas.addEventListener('dblclick', e => {
            const rect = canvas.getBoundingClientRect();
            state.centerX += ((e.clientX - rect.left) / canvas.width - .5) * 3 / state.zoom;
            state.centerY += ((e.clientY - rect.top) / canvas.height - .5) * 2 / state.zoom;
            state.zoom *= 2;
            saveHistory();
            renderHQ();
        });

// Touch events
        let touchDist = 0, touchMid = {x: 0, y: 0};
        canvas.addEventListener('touchstart', e => {
            e.preventDefault();
            if (e.touches.length === 1) {
                state.isDragging = true;
                state.lastX = e.touches[0].clientX;
                state.lastY = e.touches[0].clientY;
                startInteraction()
            } else if (e.touches.length === 2) {
                touchDist = Math.hypot(e.touches[1].clientX - e.touches[0].clientX, e.touches[1].clientY - e.touches[0].clientY);
                touchMid = {
                    x: (e.touches[0].clientX + e.touches[1].clientX) / 2,
                    y: (e.touches[0].clientY + e.touches[1].clientY) / 2
                };
            }
        }, {passive: false});
        canvas.addEventListener('touchmove', e => {
            e.preventDefault();
            if (state.isDragging && e.touches.length === 1) {
                const dx = (e.touches[0].clientX - state.lastX) / canvas.width * 3 / state.zoom;
                const dy = (e.touches[0].clientY - state.lastY) / canvas.height * 2 / state.zoom;
                state.centerX -= dx;
                state.centerY -= dy;
                state.lastX = e.touches[0].clientX;
                state.lastY = e.touches[0].clientY;
                startInteraction();
            } else if (e.touches.length === 2) {
                const newDist = Math.hypot(e.touches[1].clientX - e.touches[0].clientX, e.touches[1].clientY - e.touches[0].clientY);
                if (touchDist > 0) {
                    const zf = newDist / touchDist;
                    const rect = canvas.getBoundingClientRect();
                    const mx = (touchMid.x - rect.left) / canvas.width - .5;
                    const my = (touchMid.y - rect.top) / canvas.height - .5;
                    state.centerX += (1 - zf) * mx * 3 / state.zoom;
                    state.centerY += (1 - zf) * my * 2 / state.zoom;
                    state.zoom *= zf;
                    startInteraction();
                }
                touchDist = newDist;
                touchMid = {
                    x: (e.touches[0].clientX + e.touches[1].clientX) / 2,
                    y: (e.touches[0].clientY + e.touches[1].clientY) / 2
                };
            }
        }, {passive: false});
        canvas.addEventListener('touchend', e => {
            state.isDragging = false;
            if (e.touches.length === 0) {
                touchDist = 0;
                saveHistory();
                endInteraction()
            }
        });

// UI events
        document.getElementById('zoomIn').onclick = () => {
            state.zoom *= 1.5;
            saveHistory();
            startInteraction();
            endInteraction()
        };
        document.getElementById('zoomOut').onclick = () => {
            state.zoom /= 1.5;
            saveHistory();
            startInteraction();
            endInteraction()
        };
        document.getElementById('reset').onclick = () => {
            state.centerX = -.5;
            state.centerY = 0;
            state.zoom = 1;
            saveHistory();
            renderHQ()
        };
        document.getElementById('save').onclick = saveFractal;
        document.getElementById('share').onclick = showShare;
        document.getElementById('randomize').onclick = randomize;
        document.getElementById('historyBack').onclick = goBack;
        document.getElementById('historyForward').onclick = goForward;
        document.getElementById('fractalType').onchange = e => {
            state.type = e.target.value;
            document.getElementById('juliaParams').classList.toggle('hidden', state.type !== 'julia');
            saveHistory();
            renderHQ()
        };
        document.getElementById('colorScheme').onchange = e => {
            state.colorScheme = e.target.value;
            saveHistory();
            renderHQ()
        };
        document.getElementById('quality').oninput = e => {
            state.quality = +e.target.value;
            updateQualityLabel()
        };
        document.getElementById('quality').onchange = () => {
            saveHistory();
            renderHQ()
        };
        document.getElementById('maxIter').oninput = e => {
            state.maxIter = +e.target.value;
            document.getElementById('iterValue').textContent = state.maxIter
        };
        document.getElementById('maxIter').onchange = () => {
            saveHistory();
            renderHQ()
        };
        document.getElementById('juliaReal').onchange = e => {
            state.juliaReal = +e.target.value;
            saveHistory();
            renderHQ()
        };
        document.getElementById('juliaImag').onchange = e => {
            state.juliaImag = +e.target.value;
            saveHistory();
            renderHQ()
        };
        document.getElementById('spots').onclick = e => {
            const btn = e.target.closest('[data-spot]');
            if (!btn) return;
            const spot = SPOTS[btn.dataset.spot];
            if (spot) {
                state.centerX = spot.cx;
                state.centerY = spot.cy;
                state.zoom = spot.z;
                state.type = spot.type;
                saveHistory();
                syncUI();
                renderHQ()
            }
        };
        document.getElementById('themeToggle').onclick = () => {
            state.isDark = !state.isDark;
            localStorage.setItem('darkMode', state.isDark);
            document.documentElement.classList.toggle('dark');
            document.getElementById('darkIcon').classList.toggle('hidden');
            document.getElementById('lightIcon').classList.toggle('hidden');
        };
        document.getElementById('helpBtn').onclick = () => document.getElementById('helpModal').classList.remove('hidden');
        document.getElementById('closeHelp').onclick = () => document.getElementById('helpModal').classList.add('hidden');
        document.getElementById('closeShare').onclick = () => document.getElementById('shareModal').classList.add('hidden');
        document.getElementById('copyUrl').onclick = () => {
            navigator.clipboard.writeText(document.getElementById('shareUrl').value);
            const btn = document.getElementById('copyUrl');
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy', 1500);
        };
        document.getElementById('clearGallery').onclick = () => {
            if (confirm('Clear all saved fractals?')) {
                state.gallery = [];
                localStorage.setItem('fractal-gallery', '[]');
                loadGallery()
            }
        };
        document.addEventListener('keydown', e => {
            if (e.target.tagName === 'INPUT') return;
            switch (e.key) {
                case'+':
                case'=':
                    document.getElementById('zoomIn').click();
                    break;
                case'-':
                case'_':
                    document.getElementById('zoomOut').click();
                    break;
                case'r':
                case'R':
                    document.getElementById('reset').click();
                    break;
                case'h':
                case'H':
                    document.getElementById('helpBtn').click();
                    break;
                case' ':
                    e.preventDefault();
                    randomize();
                    break;
                case'ArrowLeft':
                    goBack();
                    break;
                case'ArrowRight':
                    goForward();
                    break;
                case'Escape':
                    document.getElementById('helpModal').classList.add('hidden');
                    document.getElementById('shareModal').classList.add('hidden');
                    break;
            }
        });
        window.addEventListener('resize', () => {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = Math.round(canvas.width * .667);
            renderHQ()
        });
        document.getElementById('helpModal').onclick = e => {
            if (e.target.id === 'helpModal') e.target.classList.add('hidden')
        };
        document.getElementById('shareModal').onclick = e => {
            if (e.target.id === 'shareModal') e.target.classList.add('hidden')
        };
    }

    init();
</script>
<script src="../logo.js"></script>
</body>
</html>