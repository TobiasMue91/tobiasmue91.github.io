<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¨</text></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Color Blindness Simulator</title>
    <style>:root {
        --primary: #4285f4;
        --primary-dark: #3367d6;
        --background: #ffffff;
        --text: #202124;
        --border: #dadce0;
        --card-bg: #f8f9fa;
        --hover: #e8f0fe;
        --button: #f1f3f4;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --primary: #8ab4f8;
            --primary-dark: #669df6;
            --background: #202124;
            --text: #e8eaed;
            --border: #5f6368;
            --card-bg: #303134;
            --hover: #303134;
            --button: #3c4043;
        }
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--background);
        color: var(--text);
        line-height: 1.6;
        padding: 20px;
        transition: background 0.3s, color 0.3s;
    }

    header {
        text-align: center;
        margin-bottom: 30px;
    }

    h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        color: var(--primary);
    }

    header p {
        font-size: 1.1rem;
        opacity: 0.8;
        max-width: 700px;
        margin: 0 auto;
    }

    main {
        max-width: 1200px;
        margin: 0 auto;
    }

    .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 2px solid var(--border);
        white-space: nowrap;
    }

    @media (max-width: 768px) {
        .tabs {
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .tabs::-webkit-scrollbar {
            height: 4px;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: var(--border);
        }
    }

    .tab-btn {
        background: none;
        border: none;
        padding: 10px 20px;
        font-size: 1rem;
        cursor: pointer;
        color: var(--text);
        position: relative;
        transition: 0.3s;
    }

    .tab-btn:hover {
        color: var(--primary);
    }

    .tab-btn.active {
        color: var(--primary);
    }

    .tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 2px;
        background: var(--primary);
    }

    .tab-content {
        display: none;
        padding: 20px;
        background: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .tab-content.active {
        display: block;
    }

    .upload-area {
        border: 2px dashed var(--border);
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        margin-bottom: 20px;
        position: relative;
        transition: 0.3s;
    }

    .upload-area.drag-over {
        background: var(--hover);
        border-color: var(--primary);
    }

    .upload-area input[type="file"] {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        cursor: pointer;
    }

    .upload-area label {
        font-size: 1.2rem;
        color: var(--text);
        cursor: pointer;
    }

    .sample-images {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 20px 0;
        justify-content: center;
    }

    .sample-image {
        width: 80px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: 0.3s;
    }

    .sample-image:hover {
        border-color: var(--primary);
    }

    .simulation-controls {
        margin: 20px 0;
    }

    .simulation-controls h2 {
        margin-bottom: 15px;
        font-size: 1.5rem;
    }

    .control-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .control-btn {
        background: var(--button);
        border: 1px solid var(--border);
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        transition: 0.3s;
        font-size: 0.9rem;
    }

    .control-btn:hover {
        background: var(--hover);
    }

    .control-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary-dark);
    }

    .display-area {
        display: grid;
        grid-template-columns:1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }

    @media (max-width: 768px) {
        .display-area {
            grid-template-columns:1fr;
        }
    }

    .display-box {
        background: var(--background);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .display-box h3 {
        margin-bottom: 10px;
        color: var(--primary);
    }

    .canvas-container {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 75%;
        overflow: hidden;
    }

    canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 1px solid var(--border);
        border-radius: 4px;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 1.5rem;
        border-radius: 4px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
    }

    .loading-overlay.active {
        opacity: 1;
        pointer-events: all;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .action-btn {
        background: var(--button);
        border: 1px solid var(--border);
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .action-btn:hover {
        background: var(--hover);
    }

    .action-btn svg {
        width: 16px;
        height: 16px;
    }

    .color-picker {
        margin-bottom: 20px;
    }

    .color-picker h2 {
        margin-bottom: 15px;
        font-size: 1.5rem;
    }

    .color-picker-container {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
    }

    .color-picker input[type="color"] {
        width: 80px;
        height: 50px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background: none;
    }

    .color-values {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .color-display {
        display: grid;
        grid-template-columns:1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }

    .color-sample {
        text-align: center;
    }

    .color-sample h3 {
        margin-bottom: 10px;
        color: var(--primary);
    }

    #original-color, #simulated-color {
        width: 100%;
        height: 100px;
        border-radius: 8px;
        margin-top: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    footer {
        text-align: center;
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid var(--border);
        font-size: 0.9rem;
        opacity: 0.7;
    }

    footer a {
        color: var(--primary);
        text-decoration: none;
    }

    footer a:hover {
        text-decoration: underline;
    }

    .info-section {
        margin-top: 30px;
        background: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
    }

    .info-section h2 {
        color: var(--primary);
        margin-bottom: 15px;
    }

    .info-grid {
        display: grid;
        grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }

    .info-card {
        background: var(--background);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .info-card h3 {
        color: var(--primary);
        margin-bottom: 10px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 5px;
    }

    .prevalence {
        font-size: 0.9rem;
        color: var(--primary);
        margin-top: 5px;
    }

    .tooltip {
        position: relative;
        display: inline-block;
        margin-left: 5px;
        cursor: help;
    }

    .tooltip .tooltip-icon {
        background: var(--primary);
        color: white;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
    }

    .tooltip .tooltip-text {
        visibility: hidden;
        width: 200px;
        background-color: var(--card-bg);
        color: var(--text);
        text-align: center;
        border-radius: 6px;
        padding: 10px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -100px;
        opacity: 0;
        transition: opacity 0.3s;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border);
    }

    .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }

    .comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .comparison-table th, .comparison-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    .comparison-table th {
        color: var(--primary);
    }

    @media (max-width: 600px) {
        .tabs {
            border-bottom: none;
            flex-direction: column;
        }

        .tab-btn {
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .tab-btn.active::after {
            display: none;
        }

        .control-buttons {
            flex-direction: column;
        }

        .color-picker-container {
            flex-direction: column;
            align-items: flex-start;
        }
    }

    .severity-buttons {
        display: flex;
        gap: 10px;
        margin: 10px 0;
    }

    .severity-btn {
        background: var(--button);
        border: 1px solid var(--border);
        padding: 4px 10px;
        border-radius: 15px;
        cursor: pointer;
        transition: 0.3s;
        font-size: 0.8rem;
    }

    .severity-btn:hover {
        background: var(--hover);
    }

    .severity-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary-dark);
    }</style>
</head>
<body>
<header><h1>Color Blindness Simulator</h1>
    <p>Preview how colors appear to people with different types of color vision deficiencies,helping create more
        accessible designs</p></header>
<main>
    <div class="tabs">
        <button class="tab-btn active" data-tab="image">Image Upload</button>
        <button class="tab-btn" data-tab="color">Color Picker</button>
        <button class="tab-btn" data-tab="info">About Color Blindness</button>
    </div>
    <div class="tab-content active" id="image-tab">
        <div class="upload-area"><input type="file" id="image-upload" accept="image/*"><label for="image-upload">Choose
            an image or drag it here</label></div>
        <div class="sample-images"><p>Or try a sample image:</p><img
                src="https://images.unsplash.com/photo-1513151233558-d860c5398176?w=800&auto=format&fit=crop&q=60"
                alt="Sample 1" class="sample-image"
                data-src="https://images.unsplash.com/photo-1513151233558-d860c5398176?w=800&auto=format&fit=crop&q=60"><img
                src="https://images.unsplash.com/photo-1493946740644-2d8a1f1a6aff?w=800&auto=format&fit=crop&q=60"
                alt="Sample 2" class="sample-image"
                data-src="https://images.unsplash.com/photo-1493946740644-2d8a1f1a6aff?w=800&auto=format&fit=crop&q=60"><img
                src="https://images.unsplash.com/photo-1517694712202-14dd9538aa97?w=800&auto=format&fit=crop&q=60"
                alt="Sample 3" class="sample-image"
                data-src="https://images.unsplash.com/photo-1517694712202-14dd9538aa97?w=800&auto=format&fit=crop&q=60"><img
                src="https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=800&auto=format&fit=crop&q=60"
                alt="Sample 4" class="sample-image"
                data-src="https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=800&auto=format&fit=crop&q=60">
        </div>
        <div class="simulation-controls"><h2>Simulation Type</h2>
            <div class="control-buttons">
                <button class="control-btn active" data-type="normal">Normal Vision</button>
                <button class="control-btn" data-type="protanopia">Protanopia (Red-Blind)</button>
                <button class="control-btn" data-type="deuteranopia">Deuteranopia (Green-Blind)</button>
                <button class="control-btn" data-type="tritanopia">Tritanopia (Blue-Blind)</button>
                <button class="control-btn" data-type="achromatopsia">Achromatopsia (Monochromacy)</button>
            </div>
            <div class="severity-buttons">
                <button class="severity-btn active" data-severity="100">100% Severity</button>
                <button class="severity-btn" data-severity="60">60% Severity</button>
                <button class="severity-btn" data-severity="20">20% Severity</button>
            </div>
        </div>
        <div class="display-area">
            <div class="display-box"><h3>Original</h3>
                <div class="canvas-container">
                    <canvas id="original-canvas"></canvas>
                </div>
            </div>
            <div class="display-box"><h3>Simulated Vision</h3>
                <div class="canvas-container">
                    <canvas id="simulated-canvas"></canvas>
                    <div class="loading-overlay" id="loading-overlay">
                        <div class="spinner"></div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="action-btn" id="download-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        Download
                    </button>
                    <button class="action-btn" id="zoom-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                        </svg>
                        Toggle Zoom
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="tab-content" id="color-tab">
        <div class="color-picker"><h2>Select a Color</h2>
            <div class="color-picker-container"><input type="color" id="color-input" value="#4285f4">
                <div class="color-values"><span id="hex-value">#4285F4</span><span id="rgb-value">RGB(66,133,244)</span>
                </div>
            </div>
        </div>
        <div class="simulation-controls"><h2>Simulation Type</h2>
            <div class="control-buttons">
                <button class="control-btn active" data-type="normal">Normal Vision</button>
                <button class="control-btn" data-type="protanopia">Protanopia (Red-Blind)</button>
                <button class="control-btn" data-type="deuteranopia">Deuteranopia (Green-Blind)</button>
                <button class="control-btn" data-type="tritanopia">Tritanopia (Blue-Blind)</button>
                <button class="control-btn" data-type="achromatopsia">Achromatopsia (Monochromacy)</button>
            </div>
            <div class="severity-buttons">
                <button class="severity-btn active" data-severity="100">100% Severity</button>
                <button class="severity-btn" data-severity="60">60% Severity</button>
                <button class="severity-btn" data-severity="20">20% Severity</button>
            </div>
        </div>
        <div class="color-display">
            <div class="color-sample"><h3>Original</h3>
                <div id="original-color"></div>
            </div>
            <div class="color-sample"><h3>Simulated Vision</h3>
                <div id="simulated-color"></div>
            </div>
        </div>
        <div class="info-section"><h2>Suggested Alternative Colors</h2>
            <div id="alternative-colors" style="display:flex;flex-wrap:wrap;gap:15px;margin-top:15px;"></div>
        </div>
    </div>
    <div class="tab-content" id="info-tab">
        <div class="info-section"><h2>Understanding Color Vision Deficiencies</h2>
            <div class="info-grid">
                <div class="info-card"><h3>Protanopia</h3>
                    <p>A type of red-green color blindness where the L-cones (long-wavelength cones) in the retina are
                        absent or don't function properly. This affects the perception of reds,making them appear darker
                        and often indistinguishable from greens and browns.</p>
                    <p class="prevalence">Affects approximately 1% of males and 0.02% of females</p></div>
                <div class="info-card"><h3>Deuteranopia</h3>
                    <p>A type of red-green color blindness where the M-cones (medium-wavelength cones) in the retina are
                        absent or don't function properly. People with deuteranopia have difficulty distinguishing
                        between reds,greens,browns,and oranges. Unlike protanopia,reds don't appear as dark.</p>
                    <p class="prevalence">Affects approximately 1.2% of males and 0.01% of females</p></div>
                <div class="info-card"><h3>Tritanopia</h3>
                    <p>A rare form of color blindness where the S-cones (short-wavelength cones) in the retina are
                        absent or don't function properly. This affects the perception of blues and yellows. Blues may
                        appear greenish,while yellows and oranges might look pinkish.</p>
                    <p class="prevalence">Affects less than 0.01% of the population regardless of gender</p></div>
                <div class="info-card"><h3>Achromatopsia</h3>
                    <p>A complete form of color blindness (monochromacy) where a person sees no color at all,only shades
                        of gray,white,and black. This condition is usually accompanied by other vision problems like
                        light sensitivity and poor visual acuity.</p>
                    <p class="prevalence">Extremely rare,affecting approximately 0.003% of the population</p></div>
            </div>
        </div>
        <div class="info-section"><h2>Design Tips for Color Accessibility</h2>
            <ul style="padding-left:20px;margin-bottom:20px;">
                <li>Don't rely solely on color to convey information - use text,patterns,icons,or other visual cues</li>
                <li>Maintain high contrast between text and background (WCAG recommends a minimum contrast ratio of
                    4.5:1)
                </li>
                <li>Avoid problematic color combinations:
                    <ul style="padding-left:20px;margin-top:5px;">
                        <li>Red/green (most common issue)</li>
                        <li>Green/brown</li>
                        <li>Blue/purple</li>
                        <li>Light blue/gray</li>
                        <li>Green/blue</li>
                        <li>Light green/yellow</li>
                    </ul>
                </li>
                <li>Use colorblind-friendly palettes in your design system</li>
                <li>Test your designs with simulation tools like this one</li>
                <li>Consider adding patterns or textures to distinguish between similar colors</li>
                <li>Label colors directly when appropriate</li>
            </ul>
            <h3>Recommended Colorblind-friendly Palettes</h3>
            <div style="display:flex;flex-wrap:wrap;gap:20px;margin-top:15px;">
                <div><h4>IBM's Color Blind Safe Palette</h4>
                    <div style="display:flex;margin-top:10px;">
                        <div style="width:50px;height:50px;background-color:#648fff;"></div>
                        <div style="width:50px;height:50px;background-color:#785ef0;"></div>
                        <div style="width:50px;height:50px;background-color:#dc267f;"></div>
                        <div style="width:50px;height:50px;background-color:#fe6100;"></div>
                        <div style="width:50px;height:50px;background-color:#ffb000;"></div>
                    </div>
                </div>
                <div><h4>Wong's Palette</h4>
                    <div style="display:flex;margin-top:10px;">
                        <div style="width:50px;height:50px;background-color:#000000;"></div>
                        <div style="width:50px;height:50px;background-color:#e69f00;"></div>
                        <div style="width:50px;height:50px;background-color:#56b4e9;"></div>
                        <div style="width:50px;height:50px;background-color:#009e73;"></div>
                        <div style="width:50px;height:50px;background-color:#f0e442;"></div>
                        <div style="width:50px;height:50px;background-color:#0072b2;"></div>
                        <div style="width:50px;height:50px;background-color:#d55e00;"></div>
                        <div style="width:50px;height:50px;background-color:#cc79a7;"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="info-section"><h2>Color Blindness Comparison</h2>
            <table class="comparison-table">
                <thead>
                <tr>
                    <th>Type</th>
                    <th>Cone Affected</th>
                    <th>Difficulty with</th>
                    <th>Common Confusions</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>Protanopia</td>
                    <td>L-cones (red)</td>
                    <td>Reds appear darker</td>
                    <td>Red/green,green/brown,purple/blue</td>
                </tr>
                <tr>
                    <td>Deuteranopia</td>
                    <td>M-cones (green)</td>
                    <td>Greens appear more beige</td>
                    <td>Red/green,green/brown,blue/purple</td>
                </tr>
                <tr>
                    <td>Tritanopia</td>
                    <td>S-cones (blue)</td>
                    <td>Blues appear greenish</td>
                    <td>Blue/green,yellow/pink,purple/red</td>
                </tr>
                <tr>
                    <td>Achromatopsia</td>
                    <td>All cones</td>
                    <td>All colors</td>
                    <td>Sees only grayscale</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>
<footer><p>Created for educational purposes. Learn more about <a href="https://www.color-blindness.com/" target="_blank">color
    blindness</a>.</p></footer>
<script>// DOM Elements
const tabButtons = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');
const controlButtons = document.querySelectorAll('.control-btn');
const severityButtons = document.querySelectorAll('.severity-btn');
const imageUpload = document.getElementById('image-upload');
const originalCanvas = document.getElementById('original-canvas');
const simulatedCanvas = document.getElementById('simulated-canvas');
const colorInput = document.getElementById('color-input');
const hexValue = document.getElementById('hex-value');
const rgbValue = document.getElementById('rgb-value');
const originalColor = document.getElementById('original-color');
const simulatedColor = document.getElementById('simulated-color');
const sampleImages = document.querySelectorAll('.sample-image');
const loadingOverlay = document.getElementById('loading-overlay');
const downloadBtn = document.getElementById('download-btn');
const zoomBtn = document.getElementById('zoom-btn');
const alternativeColorsContainer = document.getElementById('alternative-colors');

// Context for canvases
const originalCtx = originalCanvas.getContext('2d');
const simulatedCtx = simulatedCanvas.getContext('2d');

// Create an offscreen canvas for zoom functionality
const offscreenCanvas = document.createElement('canvas');
const offscreenCtx = offscreenCanvas.getContext('2d');

// Current state
let currentImage = null;
let currentSimulation = 'normal';
let currentSeverity = 100;
let isZoomed = false;
let zoomLevel = 2;
let panX = 0;
let panY = 0;
let isPanning = false;
let lastX, lastY;
let simulatedImageData = null;

// Color blindness simulation matrices (based on Brettel, ViÃ©not, and Mollon research)
// Modified for better differentiation between protanopia and deuteranopia
const simulationMatrices = {
    normal: [
        1, 0, 0, 0, 0,
        0, 1, 0, 0, 0,
        0, 0, 1, 0, 0,
        0, 0, 0, 1, 0
    ],
    protanopia: [
        0.152, 1.052, -0.204, 0, 0,
        0.114, 0.786, 0.100, 0, 0,
        0.004, -0.048, 1.044, 0, 0,
        0, 0, 0, 1, 0
    ],
    deuteranopia: [
        0.367, 0.861, -0.228, 0, 0,
        0.280, 0.673, 0.047, 0, 0,
        -0.011, 0.043, 0.968, 0, 0,
        0, 0, 0, 1, 0
    ],
    tritanopia: [
        0.95, 0.05, 0, 0, 0,
        0, 0.433, 0.567, 0, 0,
        0, 0.475, 0.525, 0, 0,
        0, 0, 0, 1, 0
    ],
    achromatopsia: [
        0.299, 0.587, 0.114, 0, 0,
        0.299, 0.587, 0.114, 0, 0,
        0.299, 0.587, 0.114, 0, 0,
        0, 0, 0, 1, 0
    ]
};

// Alternative color suggestions based on common accessibility palettes
const alternativeColors = {
    red: ['#DC267F', '#D55E00', '#FE6100'],
    green: ['#009E73', '#648FFF', '#56B4E9'],
    blue: ['#0072B2', '#648FFF', '#56B4E9'],
    yellow: ['#FFB000', '#E69F00', '#F0E442'],
    purple: ['#785EF0', '#CC79A7', '#AA4499'],
    orange: ['#FE6100', '#E69F00', '#D55E00']
};

// Initialize function
function init() {
    setupEventListeners();
    setupCanvas();
    setupDragAndDrop();
    updateColorSample();
    setupZoomPan();
}

// Set up event listeners
function setupEventListeners() {
    // Tab switching
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            const tabId = button.getAttribute('data-tab') + '-tab';
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === tabId) {
                    content.classList.add('active');
                }
            });
        });
    });

    // Simulation type selection
    controlButtons.forEach(button => {
        button.addEventListener('click', () => {
            const parent = button.parentElement;
            parent.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            currentSimulation = button.getAttribute('data-type');

            if (tabButtons[0].classList.contains('active')) {
                if (currentImage) {
                    applySimulation();
                }
            } else {
                updateColorSample();
                suggestAlternativeColors();
            }
        });
    });

    // Severity selection
    severityButtons.forEach(button => {
        button.addEventListener('click', () => {
            severityButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            currentSeverity = parseInt(button.getAttribute('data-severity'));

            if (tabButtons[0].classList.contains('active')) {
                if (currentImage) {
                    applySimulation();
                }
            } else {
                updateColorSample();
            }
        });
    });

    // Image upload
    imageUpload.addEventListener('change', handleImageUpload);

    // Sample images
    sampleImages.forEach(img => {
        img.addEventListener('click', () => {
            loadSampleImage(img.getAttribute('data-src'));
        });
    });

    // Color picker
    colorInput.addEventListener('input', () => {
        updateColorSample();
        suggestAlternativeColors();
    });

    // Download button
    downloadBtn.addEventListener('click', downloadImage);

    // Zoom button
    zoomBtn.addEventListener('click', toggleZoom);
}

// Set up drag and drop
function setupDragAndDrop() {
    const uploadArea = document.querySelector('.upload-area');

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');

        if (e.dataTransfer.files.length) {
            imageUpload.files = e.dataTransfer.files;
            handleImageUpload({target: {files: e.dataTransfer.files}});
        }
    });
}

// Set up canvas
function setupCanvas() {
    // Set initial canvas sizes
    originalCanvas.width = 500;
    originalCanvas.height = 300;
    simulatedCanvas.width = 500;
    simulatedCanvas.height = 300;
    offscreenCanvas.width = 500;
    offscreenCanvas.height = 300;

    // Clear canvas with a checkerboard pattern (for transparency)
    clearCanvas(originalCtx, originalCanvas.width, originalCanvas.height);
    clearCanvas(simulatedCtx, simulatedCanvas.width, simulatedCanvas.height);
}

// Set up zoom and pan functionality
function setupZoomPan() {
    // Mouse events for panning
    simulatedCanvas.addEventListener('mousedown', (e) => {
        if (!isZoomed) return;
        isPanning = true;
        lastX = e.offsetX;
        lastY = e.offsetY;
        simulatedCanvas.style.cursor = 'grabbing';
    });

    simulatedCanvas.addEventListener('mousemove', (e) => {
        if (!isPanning) return;

        const deltaX = e.offsetX - lastX;
        const deltaY = e.offsetY - lastY;

        panX += deltaX;
        panY += deltaY;

        // Apply boundaries
        const maxPanX = simulatedCanvas.width * (zoomLevel - 1) / 2;
        const maxPanY = simulatedCanvas.height * (zoomLevel - 1) / 2;

        panX = Math.max(-maxPanX, Math.min(maxPanX, panX));
        panY = Math.max(-maxPanY, Math.min(maxPanY, panY));

        drawZoomedImage();

        lastX = e.offsetX;
        lastY = e.offsetY;
    });

    simulatedCanvas.addEventListener('mouseup', () => {
        isPanning = false;
        simulatedCanvas.style.cursor = isZoomed ? 'grab' : 'default';
    });

    simulatedCanvas.addEventListener('mouseleave', () => {
        isPanning = false;
        simulatedCanvas.style.cursor = isZoomed ? 'grab' : 'default';
    });

    // Touch events for mobile panning
    simulatedCanvas.addEventListener('touchstart', (e) => {
        if (!isZoomed) return;
        isPanning = true;
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
        e.preventDefault();
    });

    simulatedCanvas.addEventListener('touchmove', (e) => {
        if (!isPanning) return;

        const deltaX = e.touches[0].clientX - lastX;
        const deltaY = e.touches[0].clientY - lastY;

        panX += deltaX;
        panY += deltaY;

        // Apply boundaries
        const maxPanX = simulatedCanvas.width * (zoomLevel - 1) / 2;
        const maxPanY = simulatedCanvas.height * (zoomLevel - 1) / 2;

        panX = Math.max(-maxPanX, Math.min(maxPanX, panX));
        panY = Math.max(-maxPanY, Math.min(maxPanY, panY));

        drawZoomedImage();

        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
        e.preventDefault();
    });

    simulatedCanvas.addEventListener('touchend', (e) => {
        isPanning = false;
        e.preventDefault();
    });
}

// Draw zoomed image (fixed function for zoom functionality)
function drawZoomedImage() {
    if (!simulatedImageData) return;

    // Clear canvas
    clearCanvas(simulatedCtx, simulatedCanvas.width, simulatedCanvas.height);

    // First put the image data on the offscreen canvas
    offscreenCanvas.width = simulatedCanvas.width;
    offscreenCanvas.height = simulatedCanvas.height;
    offscreenCtx.putImageData(simulatedImageData, 0, 0);

    // Now draw the offscreen canvas onto the displayed canvas with transformations
    simulatedCtx.save();

    // Calculate center point and dimensions
    const centerX = simulatedCanvas.width / 2;
    const centerY = simulatedCanvas.height / 2;
    const scaledWidth = simulatedCanvas.width / zoomLevel;
    const scaledHeight = simulatedCanvas.height / zoomLevel;

    // Calculate source rectangle (the part of the image we want to show)
    const sourceX = centerX - scaledWidth / 2 - panX / zoomLevel;
    const sourceY = centerY - scaledHeight / 2 - panY / zoomLevel;

    // Draw the zoomed portion
    simulatedCtx.drawImage(
        offscreenCanvas,
        sourceX, sourceY, scaledWidth, scaledHeight,
        0, 0, simulatedCanvas.width, simulatedCanvas.height
    );

    simulatedCtx.restore();
}

// Toggle zoom
function toggleZoom() {
    isZoomed = !isZoomed;

    if (isZoomed) {
        zoomBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" /></svg>Reset Zoom`;
        simulatedCanvas.style.cursor = 'grab';
        panX = 0;
        panY = 0;
        drawZoomedImage();
    } else {
        zoomBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" /></svg>Toggle Zoom`;
        simulatedCanvas.style.cursor = 'default';
        panX = 0;
        panY = 0;
        if (simulatedImageData) {
            simulatedCtx.putImageData(simulatedImageData, 0, 0);
        }
    }
}

// Clear canvas with a checkerboard pattern
function clearCanvas(ctx, width, height) {
    ctx.clearRect(0, 0, width, height);

    const squareSize = 10;
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--border');

    for (let x = 0; x < width; x += squareSize * 2) {
        for (let y = 0; y < height; y += squareSize * 2) {
            ctx.fillRect(x, y, squareSize, squareSize);
            ctx.fillRect(x + squareSize, y + squareSize, squareSize, squareSize);
        }
    }
}

// Handle image upload
function handleImageUpload(e) {
    const file = e.target.files[0];
    if (!file || !file.type.match('image.*')) return;

    loadingOverlay.classList.add('active');

    const reader = new FileReader();

    reader.onload = function (event) {
        const img = new Image();

        img.onload = function () {
            currentImage = img;
            drawImageOnCanvas();
            applySimulation();
            loadingOverlay.classList.remove('active');
        };

        img.onerror = function () {
            loadingOverlay.classList.remove('active');
            alert('Error loading image. Please try another file.');
        };

        img.src = event.target.result;
    };

    reader.onerror = function () {
        loadingOverlay.classList.remove('active');
        alert('Error reading file. Please try again.');
    };

    reader.readAsDataURL(file);
}

// Load a sample image
function loadSampleImage(src) {
    loadingOverlay.classList.add('active');

    const img = new Image();
    img.crossOrigin = 'anonymous'; // Allow downloading the image later

    img.onload = function () {
        currentImage = img;
        drawImageOnCanvas();
        applySimulation();
        loadingOverlay.classList.remove('active');
    };

    img.onerror = function () {
        loadingOverlay.classList.remove('active');
        alert('Error loading sample image. Please try another one or upload your own.');
    };

    img.src = src;
}

// Draw image on canvas
function drawImageOnCanvas() {
    if (!currentImage) return;

    // Calculate aspect ratio
    const aspectRatio = currentImage.width / currentImage.height;

    // Set canvas dimensions based on image aspect ratio
    let canvasWidth = originalCanvas.width;
    let canvasHeight = canvasWidth / aspectRatio;

    if (canvasHeight > originalCanvas.height) {
        canvasHeight = originalCanvas.height;
        canvasWidth = canvasHeight * aspectRatio;
    }

    // Update canvas sizes
    originalCanvas.width = canvasWidth;
    originalCanvas.height = canvasHeight;
    simulatedCanvas.width = canvasWidth;
    simulatedCanvas.height = canvasHeight;
    offscreenCanvas.width = canvasWidth;
    offscreenCanvas.height = canvasHeight;

    // Clear canvases
    clearCanvas(originalCtx, canvasWidth, canvasHeight);
    clearCanvas(simulatedCtx, canvasWidth, canvasHeight);

    // Draw original image
    originalCtx.drawImage(currentImage, 0, 0, canvasWidth, canvasHeight);
}

// Apply selected simulation to image
function applySimulation() {
    if (!currentImage) return;

    // Get image data from original canvas
    const imageData = originalCtx.getImageData(0, 0, originalCanvas.width, originalCanvas.height);
    const pixels = imageData.data;

    // Create a copy for the simulated view
    simulatedImageData = new ImageData(new Uint8ClampedArray(pixels), originalCanvas.width, originalCanvas.height);
    const simulatedPixels = simulatedImageData.data;

    // Apply color transformation using the matrices
    const matrix = simulationMatrices[currentSimulation];
    const severity = currentSeverity / 100;

    for (let i = 0; i < simulatedPixels.length; i += 4) {
        const r = simulatedPixels[i];
        const g = simulatedPixels[i + 1];
        const b = simulatedPixels[i + 2];
        // Alpha channel remains unchanged

        // Apply the simulation matrix
        const simR = r * matrix[0] + g * matrix[1] + b * matrix[2] + matrix[3] * 255 + matrix[4];
        const simG = r * matrix[5] + g * matrix[6] + b * matrix[7] + matrix[8] * 255 + matrix[9];
        const simB = r * matrix[10] + g * matrix[11] + b * matrix[12] + matrix[13] * 255 + matrix[14];

        // Mix original with simulated according to severity
        simulatedPixels[i] = Math.round(r * (1 - severity) + simR * severity);
        simulatedPixels[i + 1] = Math.round(g * (1 - severity) + simG * severity);
        simulatedPixels[i + 2] = Math.round(b * (1 - severity) + simB * severity);
    }

    // Clear simulated canvas
    clearCanvas(simulatedCtx, simulatedCanvas.width, simulatedCanvas.height);

    // Draw the simulated image
    if (isZoomed) {
        drawZoomedImage();
    } else {
        simulatedCtx.putImageData(simulatedImageData, 0, 0);
    }
}

// Download the simulated image
function downloadImage() {
    if (!currentImage) return;

    // Create a temporary link
    const link = document.createElement('a');

    // Get the simulation name for the filename
    const simulationName = currentSimulation === 'normal' ? 'original' : currentSimulation;

    // Set link attributes
    link.download = `color-blind-simulation-${simulationName}.png`;

    // If zoomed, we need to create a data URL from the canvas element
    if (isZoomed) {
        link.href = simulatedCanvas.toDataURL('image/png');
    } else if (simulatedImageData) {
        // For non-zoomed, use the image data directly
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = simulatedImageData.width;
        tempCanvas.height = simulatedImageData.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.putImageData(simulatedImageData, 0, 0);
        link.href = tempCanvas.toDataURL('image/png');
    } else {
        return;
    }

    // Trigger the download
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Update color sample
function updateColorSample() {
    const color = colorInput.value;
    hexValue.textContent = color.toUpperCase();

    // Convert hex to RGB
    const r = parseInt(color.slice(1, 3), 16);
    const g = parseInt(color.slice(3, 5), 16);
    const b = parseInt(color.slice(5, 7), 16);

    rgbValue.textContent = `RGB(${r}, ${g}, ${b})`;

    // Set original color
    originalColor.style.backgroundColor = color;

    // Apply simulation matrix
    const matrix = simulationMatrices[currentSimulation];
    const severity = currentSeverity / 100;

    // Calculate simulated color
    const simR = r * matrix[0] + g * matrix[1] + b * matrix[2] + matrix[3] * 255 + matrix[4];
    const simG = r * matrix[5] + g * matrix[6] + b * matrix[7] + matrix[8] * 255 + matrix[9];
    const simB = r * matrix[10] + g * matrix[11] + b * matrix[12] + matrix[13] * 255 + matrix[14];

    // Mix original with simulated according to severity
    const finalR = Math.round(r * (1 - severity) + simR * severity);
    const finalG = Math.round(g * (1 - severity) + simG * severity);
    const finalB = Math.round(b * (1 - severity) + simB * severity);

    // Set simulated color
    simulatedColor.style.backgroundColor = `rgb(${finalR}, ${finalG}, ${finalB})`;
}

// Suggest alternative colors
function suggestAlternativeColors() {
    // Don't suggest alternatives if using normal vision
    if (currentSimulation === 'normal') {
        alternativeColorsContainer.innerHTML = '<p>Select a color blindness type to see suggested alternatives.</p>';
        return;
    }

    const color = colorInput.value;

    // Convert hex to RGB
    const r = parseInt(color.slice(1, 3), 16);
    const g = parseInt(color.slice(3, 5), 16);
    const b = parseInt(color.slice(5, 7), 16);

    // Determine color category
    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    const delta = max - min;

    let category;

    if (delta < 50 && max > 200) {
        // Light/white
        category = 'normal';
    } else if (max < 80) {
        // Dark/black
        category = 'normal';
    } else if (r > max - 20 && g > max - 20 && b < 100) {
        category = 'yellow';
    } else if (r > max - 20 && g < 100 && b < 100) {
        category = 'red';
    } else if (r < 100 && g > max - 20 && b < 100) {
        category = 'green';
    } else if (r < 100 && g < 100 && b > max - 20) {
        category = 'blue';
    } else if (r > max - 50 && b > max - 50 && g < 150) {
        category = 'purple';
    } else if (r > max - 20 && g > r / 2 && b < 150) {
        category = 'orange';
    } else {
        category = 'normal';
    }

    // Clear container
    alternativeColorsContainer.innerHTML = '';

    // If no specific alternatives, show general message
    if (category === 'normal') {
        alternativeColorsContainer.innerHTML = '<p>No specific alternatives needed for this color.</p>';
        return;
    }

    // Add suggestion text
    const suggestionText = document.createElement('p');
    suggestionText.textContent = `Colors that might work better for ${currentSimulation}:`;
    alternativeColorsContainer.appendChild(suggestionText);

    // Create color swatches for alternatives
    alternativeColors[category].forEach(altColor => {
        const swatch = document.createElement('div');
        swatch.style.width = '60px';
        swatch.style.textAlign = 'center';

        const colorBox = document.createElement('div');
        colorBox.style.width = '50px';
        colorBox.style.height = '50px';
        colorBox.style.backgroundColor = altColor;
        colorBox.style.borderRadius = '4px';
        colorBox.style.margin = '0 auto 5px auto';
        colorBox.style.cursor = 'pointer';
        colorBox.title = 'Click to select this color';

        const colorText = document.createElement('div');
        colorText.textContent = altColor;
        colorText.style.fontSize = '0.8rem';

        colorBox.addEventListener('click', () => {
            colorInput.value = altColor;
            updateColorSample();
        });

        swatch.appendChild(colorBox);
        swatch.appendChild(colorText);
        alternativeColorsContainer.appendChild(swatch);
    });
}

// Initialize when the document is loaded
document.addEventListener('DOMContentLoaded', init);</script>
<script src="../logo.js"></script>
</body>
</html>