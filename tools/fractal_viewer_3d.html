<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive 3D Fractal Explorer | Online Fractal Viewer with Zoom</title>
    <meta name="description"
          content="Explore beautiful 3D fractals in real-time with our interactive online fractal viewer. Zoom infinitely, rotate freely, and discover the mathematical beauty of 3D fractals in your browser.">
    <meta name="keywords"
          content="3D fractal explorer, fractal viewer, 3D fractals, interactive fractals, fractal zoom, online fractal viewer, mathematical visualization, real-time fractals, fractal generator, Mandelbulb, Julia set, 3D fractal renderer">
    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŒŒ</text></svg>">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --bg-light: #f9fafb;
            --bg-dark: #111827;
            --text-light: #f3f4f6;
            --text-dark: #1f2937;
            --card-light: #ffffff;
            --card-dark: #1f2937;
            --border-light: #e5e7eb;
            --border-dark: #374151
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            background-color: var(--bg-dark);
            color: var(--text-light);
            transition: background-color .3s
        }

        body.light-mode {
            background-color: var(--bg-light);
            color: var(--text-dark)
        }

        .container {
            position: absolute;
            inset: 0
        }

        #renderCanvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%
        }

        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 340px;
            max-height: calc(100vh - 40px);
            background-color: rgba(31, 41, 55, .9);
            border-radius: 10px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, .3);
            overflow-y: auto;
            backdrop-filter: blur(10px);
            transition: all .3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column
        }

        .light-mode .control-panel {
            background-color: rgba(255, 255, 255, .9);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, .1)
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-dark);
            position: sticky;
            top: 0;
            background: inherit;
            z-index: 10
        }

        .light-mode .panel-header {
            border-bottom: 1px solid var(--border-light)
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-light)
        }

        .light-mode .panel-title {
            color: var(--text-dark)
        }

        .panel-title svg {
            width: 24px;
            height: 24px
        }

        .panel-toggle {
            cursor: pointer;
            color: var(--text-light);
            background: 0 0;
            border: none;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: background-color .2s
        }

        .panel-toggle:hover {
            background-color: rgba(255, 255, 255, .1)
        }

        .light-mode .panel-toggle {
            color: var(--text-dark)
        }

        .light-mode .panel-toggle:hover {
            background-color: rgba(0, 0, 0, .05)
        }

        .panel-body {
            padding: 0 20px;
            flex-grow: 1;
            overflow-y: auto
        }

        .control-group {
            padding: 16px 0;
            border-bottom: 1px solid rgba(255, 255, 255, .1)
        }

        .light-mode .control-group {
            border-bottom: 1px solid rgba(0, 0, 0, .1)
        }

        .control-group:last-child {
            border-bottom: none
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer
        }

        .group-title {
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .control-content {
            display: grid;
            gap: 16px
        }

        .control-item {
            display: grid;
            gap: 8px
        }

        label {
            font-size: 14px;
            display: flex;
            justify-content: space-between
        }

        .value-display {
            font-size: 13px;
            color: var(--primary-light);
            font-variant-numeric: tabular-nums
        }

        .light-mode .value-display {
            color: var(--primary-dark)
        }

        select, button, input[type=text], input[type=number] {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-dark);
            background-color: rgba(17, 24, 39, .8);
            color: var(--text-light);
            font-size: 14px;
            transition: all .2s
        }

        .light-mode select, .light-mode button, .light-mode input[type=text], .light-mode input[type=number] {
            border: 1px solid var(--border-light);
            background-color: #fff;
            color: var(--text-dark)
        }

        select:focus, button:focus, input:focus {
            outline: 0;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, .3)
        }

        button {
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px
        }

        button:hover {
            background-color: rgba(31, 41, 55, 1)
        }

        .light-mode button:hover {
            background-color: #f9fafb
        }

        button svg {
            width: 16px;
            height: 16px
        }

        .button-primary {
            background-color: var(--primary);
            color: #fff;
            border: none
        }

        .button-primary:hover {
            background-color: var(--primary-dark)
        }

        .button-secondary {
            background-color: transparent;
            border: 1px solid var(--border-dark)
        }

        .light-mode .button-secondary {
            border: 1px solid var(--border-light)
        }

        .button-row {
            display: flex;
            gap: 10px
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, .1);
            outline: 0;
            transition: background .2s
        }

        .light-mode input[type=range] {
            background: rgba(0, 0, 0, .1)
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .3)
        }

        input[type=range]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .3)
        }

        input[type=range]::-webkit-slider-thumb:hover, input[type=range]::-moz-range-thumb:hover {
            background: var(--primary-dark)
        }

        .color-input {
            display: flex;
            gap: 10px
        }

        input[type=color] {
            -webkit-appearance: none;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: 0 0;
            cursor: pointer
        }

        input[type=color]::-webkit-color-swatch-wrapper {
            padding: 0;
            border-radius: 6px;
            overflow: hidden
        }

        input[type=color]::-webkit-color-swatch {
            border: none;
            border-radius: 6px
        }

        .controls-grid {
            display: grid;
            grid-template-columns:repeat(1, 1fr);
            gap: 10px
        }

        .mini-button {
            padding: 4px 8px;
            font-size: 12px
        }

        .parameter-item {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .parameter-value {
            flex: 1
        }

        .control-panel.collapsed {
            width: 60px;
            height: 60px;
            overflow: hidden
        }

        .control-panel.collapsed .panel-header {
            border-bottom: none;
            padding: 0;
            height: 60px;
            width: 60px;
            display: flex;
            justify-content: center
        }

        .control-panel.collapsed .panel-title, .control-panel.collapsed .panel-body {
            display: none
        }

        .control-panel.collapsed .panel-toggle {
            transform: rotate(180deg)
        }

        .overlay-ui {
            position: absolute;
            display: flex;
            gap: 10px
        }

        .bottom-controls {
            bottom: 20px;
            right: 20px
        }

        .top-controls {
            top: 20px;
            right: 20px
        }

        .hud {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(31, 41, 55, .7);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            pointer-events: none
        }

        .light-mode .hud {
            background-color: rgba(255, 255, 255, .7)
        }

        .hud-item {
            display: flex;
            justify-content: space-between;
            gap: 20px
        }

        .hud-value {
            font-variant-numeric: tabular-nums;
            font-feature-settings: "tnum";
            font-weight: 500
        }

        .flight-mode-indicator {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(99, 102, 241, .9);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            display: none;
            align-items: center;
            gap: 10px;
            pointer-events: none;
            z-index: 200
        }

        .flight-mode-indicator.active {
            display: flex
        }

        .loading-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, .7);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
            z-index: 1000;
            opacity: 1;
            transition: opacity .5s
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 5px solid rgba(255, 255, 255, .1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite
        }

        @keyframes spin {
            0% {
                transform: rotate(0)
            }
            100% {
                transform: rotate(360deg)
            }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 500;
            color: #fff
        }

        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px
        }

        .preset-button {
            flex: 1;
            min-width: 100px;
            padding: 8px;
            font-size: 13px;
            text-align: center;
            background-color: rgba(255, 255, 255, .05);
            border: 1px solid rgba(255, 255, 255, .1);
            border-radius: 6px;
            cursor: pointer;
            transition: all .2s
        }

        .preset-button:hover {
            background-color: rgba(255, 255, 255, .1)
        }

        .light-mode .preset-button {
            background-color: rgba(0, 0, 0, .03);
            border: 1px solid rgba(0, 0, 0, .1)
        }

        .light-mode .preset-button:hover {
            background-color: rgba(0, 0, 0, .05)
        }

        .hidden {
            display: none !important
        }

        .tooltip {
            position: relative;
            display: inline-block
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            background-color: rgba(0, 0, 0, .8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 6px 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity .3s;
            white-space: nowrap;
            font-size: 12px;
            pointer-events: none
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, .8) transparent transparent transparent
        }

        .modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, .5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all .3s
        }

        .modal.visible {
            opacity: 1;
            visibility: visible
        }

        .modal-content {
            background-color: var(--bg-dark);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, .3)
        }

        .light-mode .modal-content {
            background-color: var(--card-light)
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-dark);
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .light-mode .modal-header {
            border-bottom: 1px solid var(--border-light)
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600
        }

        .modal-close {
            background: 0 0;
            border: none;
            cursor: pointer;
            color: currentColor;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: background-color .2s
        }

        .modal-close:hover {
            background-color: rgba(255, 255, 255, .1)
        }

        .light-mode .modal-close:hover {
            background-color: rgba(0, 0, 0, .05)
        }

        .modal-body {
            padding: 24px
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-dark);
            display: flex;
            justify-content: flex-end;
            gap: 12px
        }

        .light-mode .modal-footer {
            border-top: 1px solid var(--border-light)
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary);
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, .2);
            transform: translateY(100px);
            opacity: 0;
            transition: all .3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 2000
        }

        .notification.visible {
            transform: translateY(0);
            opacity: 1
        }

        .notification-icon {
            display: flex
        }

        .notification-message {
            font-size: 14px;
            font-weight: 500
        }

        .gallery-grid {
            display: grid;
            grid-template-columns:repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 12px
        }

        .gallery-item {
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 1;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, .1);
            transition: transform .2s
        }

        .gallery-item:hover {
            transform: scale(1.03)
        }

        .gallery-image {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .gallery-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, .7) 0%, rgba(0, 0, 0, 0) 50%);
            opacity: 0;
            transition: opacity .2s;
            display: flex;
            align-items: flex-end;
            padding: 10px
        }

        .gallery-item:hover .gallery-overlay {
            opacity: 1
        }

        .gallery-title {
            color: #fff;
            font-size: 12px;
            font-weight: 500;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            width: 100%
        }

        @media (max-width: 768px) {
            .control-panel {
                top: 10px;
                left: 10px;
                width: calc(100% - 20px);
                max-height: 60vh
            }

            .controls-grid {
                grid-template-columns:1fr
            }
        }
    </style>
</head>
<body>
<div class="container">
    <canvas id="renderCanvas"></canvas>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Initializing 3D Fractal Explorer...</div>
    </div>
    <div class="hud" id="performanceHud">
        <div class="hud-item"><span>FPS:</span><span class="hud-value" id="fpsCounter">60</span></div>
        <div class="hud-item"><span>Render Time:</span><span class="hud-value" id="renderTime">0 ms</span></div>
        <div class="hud-item"><span>Iterations:</span><span class="hud-value" id="iterationsCounter">8</span></div>
    </div>
    <div class="flight-mode-indicator" id="flightModeIndicator">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"></path>
        </svg>
        Flight Mode (WASD to move, Mouse to look, ESC to exit)
    </div>
    <div class="overlay-ui bottom-controls">
        <button id="flightModeButton" class="button-primary tooltip">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"></path>
            </svg>
            <span class="tooltip-text">Flight Mode</span></button>
        <button id="shareButton" class="button-primary tooltip">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="18" cy="5" r="3"></circle>
                <circle cx="6" cy="12" r="3"></circle>
                <circle cx="18" cy="19" r="3"></circle>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
            </svg>
            <span class="tooltip-text">Share Fractal</span></button>
        <button id="screenshotButton" class="button-primary tooltip">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
            </svg>
            <span class="tooltip-text">Take Screenshot</span></button>
        <button id="fullscreenButton" class="button-primary tooltip">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M8 3H5a2 2 0 0 0-2 2v3"></path>
                <path d="M21 8V5a2 2 0 0 0-2-2h-3"></path>
                <path d="M3 16v3a2 2 0 0 0 2 2h3"></path>
                <path d="M16 21h3a2 2 0 0 0 2-2v-3"></path>
            </svg>
            <span class="tooltip-text">Fullscreen</span></button>
        <button id="themeToggle" class="button-primary tooltip">
            <svg id="darkIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
            <svg id="lightIcon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                 stroke-linejoin="round">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
            <span class="tooltip-text">Toggle Theme</span></button>
    </div>
    <div class="control-panel" id="controlPanel">
        <div class="panel-header">
            <div class="panel-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 3h.393a7.5 7.5 0 0 0 7.92 12.446A1 1 0 0 1 22 16.93V8a2 2 0 0 0-2-2h-4.195a2 2 0 0 1-1.83-1.206L13.2 3.194A2 2 0 0 0 11.37 2H6a2 2 0 0 0-2 2v10c0 1.1.9 2 2 2h.5"></path>
                    <path d="M6 14v6c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2v-1.5"></path>
                    <path d="M5 11h14"></path>
                </svg>
                3D Fractal Explorer
            </div>
            <button class="panel-toggle" id="panelToggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m9 18 6-6-6-6"></path>
                </svg>
            </button>
        </div>
        <div class="panel-body">
            <div class="control-group">
                <div class="group-header">
                    <div class="group-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon
                                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                        </svg>
                        Fractal Selection
                    </div>
                </div>
                <div class="control-content">
                    <div class="control-item"><label for="fractalType">Fractal Type</label><select id="fractalType">
                        <option value="mandelbulb">Mandelbulb</option>
                        <option value="mandelbox">Mandelbox</option>
                        <option value="juliaQuaternion">Julia Quaternion</option>
                        <option value="mengerSponge">Menger Sponge</option>
                        <option value="sierpinskiTetrahedron">Sierpinski Tetrahedron</option>
                        <option value="apollonian">Apollonian Fractal</option>
                        <option value="kaliSet">Kali Set</option>
                        <option value="xenodreambuie">Xenodreambuie</option>
                    </select></div>
                    <div class="preset-buttons">
                        <button class="preset-button" data-preset="classic">Mandelbulb</button>
                        <button class="preset-button" data-preset="mandelbox">Mandelbox</button>
                        <button class="preset-button" data-preset="julia">Julia</button>
                        <button class="preset-button" data-preset="menger">Menger</button>
                        <button class="preset-button" data-preset="sierpinski">Sierpinski</button>
                        <button class="preset-button" data-preset="apollonian">Apollonian</button>
                        <button class="preset-button" data-preset="coral">Kali Set</button>
                        <button class="preset-button" data-preset="cosmic">Xenodreambuie</button>
                    </div>
                    <div class="preset-buttons" style="margin-top:8px">
                        <button class="preset-button" data-preset="spiky">Spiky</button>
                        <button class="preset-button" data-preset="mandelbox-fire">Fire Mandelbox</button>
                    </div>
                </div>
            </div>
            <div class="control-group">
                <div class="group-header">
                    <div class="group-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        Main Parameters
                    </div>
                </div>
                <div class="control-content">
                    <div class="control-item"><label for="maxIterations">Iterations<span class="value-display"
                                                                                         id="iterDisplay">8</span></label><input
                            type="range" id="maxIterations" min="1" max="64" value="8" step="1"></div>
                    <div class="control-item"><label for="power">Power<span class="value-display"
                                                                            id="powerDisplay">8.0</span></label><input
                            type="range" id="power" min="2" max="16" value="8" step="0.1"></div>
                    <div class="control-item"><label for="scale">Scale<span class="value-display"
                                                                            id="scaleDisplay">2.0</span></label><input
                            type="range" id="scale" min="-5" max="5" value="2" step="0.1"></div>
                    <div class="control-item"><label for="bailout">Bailout Value<span class="value-display"
                                                                                      id="bailoutDisplay">4.0</span></label><input
                            type="range" id="bailout" min="1" max="10" value="4" step="0.1"></div>
                    <div id="juliaParams" class="control-item"><label>Julia Parameters</label>
                        <div class="controls-grid">
                            <div class="parameter-item"><span>X</span><input type="number" id="juliaX"
                                                                             class="parameter-value" value="0.33"
                                                                             step="0.01"></div>
                            <div class="parameter-item"><span>Y</span><input type="number" id="juliaY"
                                                                             class="parameter-value" value="0.42"
                                                                             step="0.01"></div>
                            <div class="parameter-item"><span>Z</span><input type="number" id="juliaZ"
                                                                             class="parameter-value" value="0.18"
                                                                             step="0.01"></div>
                            <div class="parameter-item"><span>W</span><input type="number" id="juliaW"
                                                                             class="parameter-value" value="0.0"
                                                                             step="0.01"></div>
                        </div>
                    </div>
                    <div class="button-row">
                        <button id="resetParameters" class="button-secondary">Reset Parameters</button>
                        <button id="randomizeParameters" class="button-secondary">Randomize</button>
                    </div>
                </div>
            </div>
            <div class="control-group">
                <div class="group-header">
                    <div class="group-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="13.5" cy="6.5" r="2.5"></circle>
                            <circle cx="19" cy="17" r="2"></circle>
                            <circle cx="6" cy="12" r="3"></circle>
                            <line x1="13.5" y1="9" x2="13.5" y2="16"></line>
                            <line x1="19" y1="15" x2="19" y2="7"></line>
                            <line x1="6" y1="9" x2="6" y2="3"></line>
                        </svg>
                        Appearance
                    </div>
                </div>
                <div class="control-content">
                    <div class="control-item"><label for="colorScheme">Color Scheme</label><select id="colorScheme">
                        <option value="normal">Surface Normal</option>
                        <option value="depth">Depth Gradient</option>
                        <option value="iterations">Iteration Count</option>
                        <option value="orbit">Orbit Trap</option>
                        <option value="rainbow">Rainbow</option>
                        <option value="fire">Fire</option>
                        <option value="electric">Electric</option>
                        <option value="cosmic">Cosmic</option>
                        <option value="pastel">Pastel</option>
                    </select></div>
                    <div class="control-item"><label for="colorOffset">Color Offset<span class="value-display"
                                                                                         id="colorOffsetDisplay">0.0</span></label><input
                            type="range" id="colorOffset" min="0" max="1" value="0" step="0.01"></div>
                    <div class="control-item"><label for="colorIntensity">Color Intensity<span class="value-display"
                                                                                               id="colorIntensityDisplay">1.0</span></label><input
                            type="range" id="colorIntensity" min="0.1" max="2" value="1" step="0.05"></div>
                    <div class="control-item"><label>Background Color</label>
                        <div class="color-input"><input type="color" id="backgroundColor" value="#000000"><input
                                type="text" id="backgroundColorText" value="#000000" placeholder="Hex code"></div>
                    </div>
                    <div class="control-item"><label for="backgroundType">Background Type</label><select
                            id="backgroundType">
                        <option value="solid">Solid Color</option>
                        <option value="linear" selected>Linear Gradient</option>
                        <option value="radial">Radial Gradient</option>
                    </select></div>
                    <div id="gradientControls">
                        <div class="control-item"><label>Gradient Start Color</label>
                            <div class="color-input"><input type="color" id="gradientColorStart" value="#FFFFFF"><input
                                    type="text" id="gradientColorStartText" value="#FFFFFF" placeholder="Hex code">
                            </div>
                        </div>
                        <div class="control-item"><label>Gradient End Color</label>
                            <div class="color-input"><input type="color" id="gradientColorEnd" value="#bfccff"><input
                                    type="text" id="gradientColorEndText" value="#bfccff" placeholder="Hex code"></div>
                        </div>
                        <div class="control-item" id="gradientDirectionControl"><label for="gradientDirection">Gradient
                            Direction</label><select id="gradientDirection">
                            <option value="0">Top to Bottom</option>
                            <option value="90" selected>Left to Right</option>
                            <option value="45">Top-Left to Bottom-Right</option>
                            <option value="135">Top-Right to Bottom-Left</option>
                        </select></div>
                    </div>
                </div>
            </div>
            <div class="control-group">
                <div class="group-header">
                    <div class="group-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"></path>
                            <path d="M12 4.5v3"></path>
                            <path d="M12 16.5v3"></path>
                            <path d="M4.5 12h3"></path>
                            <path d="M16.5 12h3"></path>
                            <path d="m19 19-2.8-2.8"></path>
                            <path d="m5 5 2.8 2.8"></path>
                            <path d="m5 19 2.8-2.8"></path>
                            <path d="m19 5-2.8 2.8"></path>
                        </svg>
                        Lighting
                    </div>
                </div>
                <div class="control-content">
                    <div class="control-item"><label for="lightIntensity">Light Intensity<span class="value-display"
                                                                                               id="lightIntensityDisplay">1.0</span></label><input
                            type="range" id="lightIntensity" min="0" max="2" value="1" step="0.05"></div>
                    <div class="control-item"><label for="ambientLight">Ambient Light<span class="value-display"
                                                                                           id="ambientLightDisplay">0.2</span></label><input
                            type="range" id="ambientLight" min="0" max="1" value="0.2" step="0.05"></div>
                    <div class="control-item"><label for="specularIntensity">Specular Intensity<span
                            class="value-display" id="specularIntensityDisplay">0.5</span></label><input type="range"
                                                                                                         id="specularIntensity"
                                                                                                         min="0" max="2"
                                                                                                         value="0.5"
                                                                                                         step="0.05">
                    </div>
                    <div class="control-item"><label>Light Direction</label>
                        <div class="controls-grid">
                            <button id="lightPreset1" class="button-secondary mini-button">Top</button>
                            <button id="lightPreset2" class="button-secondary mini-button">Front</button>
                            <button id="lightPreset3" class="button-secondary mini-button">Left</button>
                            <button id="lightPreset4" class="button-secondary mini-button">Right</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="control-group">
                <div class="group-header">
                    <div class="group-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path>
                            <circle cx="12" cy="13" r="3"></circle>
                        </svg>
                        Camera
                    </div>
                </div>
                <div class="control-content">
                    <div class="control-item"><label for="fov">Field of View<span class="value-display" id="fovDisplay">60Â°</span></label><input
                            type="range" id="fov" min="20" max="120" value="60" step="1"></div>
                    <div class="control-item"><label for="cameraDistance">Camera Distance<span class="value-display"
                                                                                               id="cameraDistanceDisplay">2.5</span></label><input
                            type="range" id="cameraDistance" min="1" max="10" value="2.5" step="0.1"></div>
                    <div class="button-row">
                        <button id="resetCamera" class="button-secondary">Reset Camera</button>
                    </div>
                </div>
            </div>
            <div class="control-group">
                <div class="group-header">
                    <div class="group-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 3a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3H6a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3h12a3 3 0 0 0 3-3 3 3 0 0 0-3-3z"></path>
                        </svg>
                        Quality & Performance
                    </div>
                </div>
                <div class="control-content">
                    <div class="control-item"><label for="quality">Render Quality<span class="value-display"
                                                                                       id="qualityDisplay">Medium</span></label><input
                            type="range" id="quality" min="0" max="4" value="2" step="1"></div>
                    <div class="control-item"><label for="shadowQuality">Shadow Quality<span class="value-display"
                                                                                             id="shadowQualityDisplay">Medium</span></label><input
                            type="range" id="shadowQuality" min="0" max="3" value="1" step="1"></div>
                </div>
            </div>
            <div class="control-group">
                <div class="group-header">
                    <div class="group-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polygon points="10 8 16 12 10 16 10 8"></polygon>
                        </svg>
                        Animation
                    </div>
                </div>
                <div class="control-content">
                    <div class="control-item">
                        <div class="button-row">
                            <button id="animationToggle" class="button-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                     stroke-linejoin="round">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                                Start Animation
                            </button>
                        </div>
                    </div>
                    <div class="control-item"><label for="animationSpeed">Animation Speed<span class="value-display"
                                                                                               id="animationSpeedDisplay">1.0</span></label><input
                            type="range" id="animationSpeed" min="0.1" max="5" value="1" step="0.1"></div>
                </div>
            </div>
            <div class="control-group">
                <div class="group-header">
                    <div class="group-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"></path>
                            <path d="M4 6v12c0 1.1.9 2 2 2h14v-4"></path>
                            <path d="M18 12c-1.1 0-2 .9-2 2s.9 2 2 2h4v-4Z"></path>
                        </svg>
                        Save & Share
                    </div>
                </div>
                <div class="control-content">
                    <div class="control-item"><label for="savePresetName">Save Current Settings</label>
                        <div class="button-row"><input type="text" id="savePresetName" placeholder="Preset name">
                            <button id="savePreset" class="button-primary">Save</button>
                        </div>
                    </div>
                    <div class="control-item"><label>Saved Presets</label><select id="savedPresets">
                        <option value="">-- Select a preset --</option>
                    </select></div>
                    <div class="control-item">
                        <div class="button-row">
                            <button id="galleryButton" class="button-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                     stroke-linejoin="round">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                Gallery
                            </button>
                            <button id="exportSettings" class="button-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                     stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                Export
                            </button>
                            <button id="importSettings" class="button-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                     stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                Import
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="shareModal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Share Fractal</h3>
                <button class="modal-close" id="closeShareModal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="control-item"><label for="shareUrl">Share URL</label>
                    <div class="button-row"><input type="text" id="shareUrl" readonly>
                        <button id="copyShareUrl" class="button-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="control-item" style="margin-top:20px"><label>Image Preview</label>
                    <div style="text-align:center;margin-top:10px"><img id="sharePreview"
                                                                        style="max-width:100%;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,.1)">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="downloadImage" class="button-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download Image
                </button>
            </div>
        </div>
    </div>
    <div class="modal" id="galleryModal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Fractal Gallery</h3>
                <button class="modal-close" id="closeGalleryModal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="galleryEmpty" style="text-align:center;padding:20px;color:#6b7280">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                         style="margin:0 auto 16px">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    <p>Your gallery is empty. Capture some beautiful fractals!</p></div>
                <div class="gallery-grid" id="galleryGrid"></div>
            </div>
        </div>
    </div>
    <div class="notification" id="notification">
        <div class="notification-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        </div>
        <div class="notification-message" id="notificationMessage">Operation completed successfully!</div>
    </div>
</div>
<script type="x-shader/x-fragment" id="fragmentShader">
    precision highp float;
uniform vec2 resolution;
uniform float time;
uniform vec3 cameraPos;
uniform vec3 cameraTarget;
uniform vec3 cameraUp;
uniform float cameraNear;
uniform float cameraFar;
uniform float cameraFov;
uniform int fractalType;
uniform int maxIterations;
uniform float power;
uniform float scale;
uniform float bailout;
uniform vec4 juliaConstant;
uniform int colorScheme;
uniform float colorOffset;
uniform float colorIntensity;
uniform vec3 backgroundColor;
uniform int backgroundType;
uniform vec3 gradientColorStart;
uniform vec3 gradientColorEnd;
uniform float gradientDirection;
uniform vec3 lightDirection;
uniform float lightIntensity;
uniform float ambientLight;
uniform float specularIntensity;
uniform int shadowQuality;
uniform bool isAnimating;
uniform float animationSpeed;
uniform int quality;
uniform bool isInteractive;
const float PI = 3.14159265359;
const float EPSILON = .0001;
const float MAX_DIST = 20.;
float mandelbulbSDF(vec3 pos) {
    vec3 z = pos;
    float dr = 1.;
    float r = 0.;
    for (int i = 0; i < 64; i++) {
        if (i >= maxIterations) break;
        r = length(z);
        if (r > bailout) break;
        float theta = acos(z.z / r);
        float phi = atan(z.y, z.x);
        dr = pow(r, power - 1.) * power * dr + 1.;
        float zr = pow(r, power);
        theta *= power;
        phi *= power;
        z = zr * vec3(sin(theta) * cos(phi), sin(theta) * sin(phi), cos(theta));
        z += pos;
    }
    return .5 * log(r) * r / dr;
}
float mandelboxSDF(vec3 pos) {
    vec3 z = pos;
    float dr = 1.;
    for (int i = 0; i < 64; i++) {
        if (i >= maxIterations) break;
        z = clamp(z, -1., 1.) * 2. - z;
        float r2 = dot(z, z);
        if (r2 < .5) {
            z *= 4.;
            dr *= 4.;
        } else if (r2 < 1.) {
            z *= 1. / r2;
            dr *= 1. / r2;
        }
        z = scale * z + pos;
        dr = dr * abs(scale) + 1.;
        if (dot(z, z) > bailout) break;
    }
    return length(z) / abs(dr);
}
float juliaQuaternionSDF(vec3 pos) {
    vec4 z = vec4(pos, 0.);
    vec4 c = juliaConstant;
    float md2 = 1.;
    float mz2 = dot(z, z);
    for (int i = 0; i < 64; i++) {
        if (i >= maxIterations) break;
        md2 *= 4. * mz2;
        z = vec4(z.x * z.x - z.y * z.y - z.z * z.z - z.w * z.w, 2. * z.x * z.y, 2. * z.x * z.z, 2. * z.x * z.w) + c;
        mz2 = dot(z, z);
        if (mz2 > bailout) break;
    }
    return .25 * sqrt(mz2) / sqrt(md2) * log(mz2);
}
float mengerSpongeSDF(vec3 pos) {
    float d = max(abs(pos.x), max(abs(pos.y), abs(pos.z))) - 1.;
    float s = 1.;
    for (int i = 0; i < 8; i++) {
        if (i >= maxIterations) break;
        vec3 a = mod(pos * s, 2.) - 1.;
        s *= 3.;
        vec3 r = abs(1. - 3. * abs(a));
        float da = max(r.x, r.y);
        float db = max(r.y, r.z);
        float dc = max(r.z, r.x);
        float c = (min(da, min(db, dc)) - 1.) / s;
        d = max(d, c);
    }
    return d;
}
float sierpinskiTetrahedronSDF(vec3 pos) {
    const vec3 a1 = vec3(1., 1., 1.);
    const vec3 a2 = vec3(-1., -1., 1.);
    const vec3 a3 = vec3(1., -1., -1.);
    const vec3 a4 = vec3(-1., 1., -1.);
    vec3 c;
    float dist;
    float d;
    for (int n = 0; n < 10; n++) {
        if (n >= maxIterations) break;
        c = a1;
        dist = length(pos - a1);
        d = length(pos - a2);
        if (d < dist) {
            c = a2;
            dist = d;
        }
        d = length(pos - a3);
        if (d < dist) {
            c = a3;
            dist = d;
        }
        d = length(pos - a4);
        if (d < dist) {
            c = a4;
            dist = d;
        }
        pos = scale * pos - c * (scale - 1.);
    }
    return length(pos) * pow(scale, -float(maxIterations));
}
float apollonianSDF(vec3 pos) {
    float scale = 1.;
    for (int i = 0; i < 8; i++) {
        if (i >= maxIterations) break;
        pos = 2. * clamp(pos, -1., 1.) - pos;
        float r2 = dot(pos, pos);
        float k = max(1.1 / r2, 1.);
        pos *= k;
        scale *= k;
    }
    return .25 * abs(pos.y) / scale;
}
float kaliSetSDF(vec3 pos) {
    vec3 z = pos;
    float dr = 1.;
    float r = 0.;
    for (int i = 0; i < 64; i++) {
        if (i >= maxIterations) break;
        r = length(z);
        if (r > bailout) break;
        float theta = acos(z.z / r);
        float phi = atan(z.y, z.x);
        dr = pow(r, power - 1.) * power * dr + 1.;
        float zr = pow(r, power);
        theta = abs(theta) * power;
        phi = abs(phi) * power;
        z = zr * vec3(sin(theta) * cos(phi), sin(theta) * sin(phi), cos(theta));
        z = abs(z) - vec3(.8, .7, .6);
        z += pos;
    }
    return .5 * log(r) * r / dr;
}
float xenodreambuieSDF(vec3 pos) {
    vec3 z = pos;
    float dr = 1.;
    float r = 0.;
    for (int i = 0; i < 64; i++) {
        if (i >= maxIterations) break;
        r = length(z);
        if (r > bailout) break;
        float theta = acos(z.z / r);
        float phi = atan(z.y, z.x);
        dr = pow(r, power - 1.) * power * dr + 1.;
        float zr = pow(r, power);
        theta = theta * power + sin(phi) * .5;
        phi = phi * power + sin(theta) * .5;
        z = zr * vec3(sin(theta) * cos(phi), sin(theta) * sin(phi), cos(theta));
        z = vec3(z.x * z.x - z.y * z.y, 2. * z.x * z.y, z.z) + pos;
    }
    return .5 * log(r) * r / dr;
}
float sceneSDF(vec3 pos) {
    if (fractalType == 0) {
        return mandelbulbSDF(pos);
    } else if (fractalType == 1) {
        return mandelboxSDF(pos);
    } else if (fractalType == 2) {
        return juliaQuaternionSDF(pos);
    } else if (fractalType == 3) {
        return mengerSpongeSDF(pos);
    } else if (fractalType == 4) {
        return sierpinskiTetrahedronSDF(pos);
    } else if (fractalType == 5) {
        return apollonianSDF(pos);
    } else if (fractalType == 6) {
        return kaliSetSDF(pos);
    } else if (fractalType == 7) {
        return xenodreambuieSDF(pos);
    }
    return mandelbulbSDF(pos);
}
vec3 calcNormal(vec3 pos) {
    vec2 e = vec2(EPSILON, 0.);
    return normalize(vec3(sceneSDF(pos + e.xyy) - sceneSDF(pos - e.xyy), sceneSDF(pos + e.yxy) - sceneSDF(pos - e.yxy), sceneSDF(pos + e.yyx) - sceneSDF(pos - e.yyx)));
}
float ambientOcclusion(vec3 p, vec3 n) {
    float ao = 0.;
    float weight = 1.;
    for (int i = 0; i < 5; i++) {
        float dist = .01 + .12 * float(i) / 4.;
        float d = sceneSDF(p + n * dist);
        ao += weight * (dist - d);
        weight *= .6;
    }
    return clamp(1. - 3. * ao, 0., 1.);
}
float softShadow(vec3 p, vec3 lightDir, float mint, float maxt, float k) {
    float res = 1.;
    float t = mint;
    for (int i = 0; i < 16; i++) {
        if (shadowQuality < 1 && i > 8) break;
        if (shadowQuality < 2 && i > 12) break;
        if (t >= maxt) break;
        float h = sceneSDF(p + lightDir * t);
        if (h < EPSILON) return 0.;
        res = min(res, k * h / t);
        t += h;
    }
    return res;
}
float rayMarch(vec3 ro, vec3 rd, out int iterations) {
    float t = cameraNear;
    iterations = 0;
    float stepFactor = 1.;
    if (quality == 0) stepFactor = 1.5;
    if (quality == 1) stepFactor = 1.2;
    if (quality == 3) stepFactor = .8;
    if (quality == 4) stepFactor = .5;
    if (isInteractive) {
        stepFactor *= 1.5;
    }
    for (int i = 0; i < 256; i++) {
        if (quality == 0 && i > 48) break;
        if (quality == 1 && i > 64) break;
        if (quality == 2 && i > 96) break;
        if (quality == 3 && i > 128) break;
        iterations = i;
        vec3 pos = ro + rd * t;
        float h = sceneSDF(pos);
        if (h < EPSILON * t) return t;
        if (t > cameraFar) break;
        t += h * stepFactor;
    }
    return cameraFar;
}
vec3 applyColorScheme(vec3 pos, vec3 normal, float t, int iterations) {
    vec3 color = .5 + .5 * normal;
    float timeOffset = isAnimating ? time * animationSpeed * .2 : 0.;
    float iterationFactor = float(iterations) / float(maxIterations);
    float colorFactor = iterationFactor + colorOffset + timeOffset;
    if (colorScheme == 0) {
        color = .5 + .5 * normal;
    } else if (colorScheme == 1) {
        float depth = 1. - clamp(t / cameraFar, 0., 1.);
        color = mix(vec3(0., 0., .3), vec3(1., .7, .3), depth);
    } else if (colorScheme == 2) {
        color = .5 + .5 * cos(colorFactor * 6.28318 + vec3(0., .6, 1.));
    } else if (colorScheme == 3) {
        color = .5 + .5 * sin(pos * 2.);
    } else if (colorScheme == 4) {
        color = .5 + .5 * cos(colorFactor * 6.28318 + vec3(0., .6, 1.));
    } else if (colorScheme == 5) {
        color = mix(vec3(.7, 0., 0.), vec3(1., .7, 0.), colorFactor);
    } else if (colorScheme == 6) {
        color = mix(vec3(0., 0., .5), vec3(.5, 0., 1.), colorFactor);
        color += vec3(0., .5, 1.) * pow(1. - iterationFactor, 5.);
    } else if (colorScheme == 7) {
        float c1 = sin(colorFactor * 6.28318);
        float c2 = sin(colorFactor * 8.28318);
        float c3 = sin(colorFactor * 10.28318);
        color = vec3(c1, c2, c3) * .5 + .5;
    } else if (colorScheme == 8) {
        color = .5 + .5 * cos(colorFactor * 6.28318 + vec3(0., .6, 1.));
        color = mix(color, vec3(1.), .5);
    }
    return color;
}
vec3 shade(vec3 pos, vec3 normal, vec3 viewDir, int iterations, float t) {
    vec3 color = applyColorScheme(pos, normal, t, iterations);
    vec3 lightDir = normalize(lightDirection);
    if (isAnimating) {
        float angle = time * animationSpeed * .5;
        lightDir = normalize(vec3(cos(angle) * lightDir.x - sin(angle) * lightDir.z, lightDir.y, sin(angle) * lightDir.x + cos(angle) * lightDir.z));
    }
    float diffuse = max(dot(normal, lightDir), 0.);
    float ambient = ambientLight;
    vec3 reflectDir = reflect(-lightDir, normal);
    float specular = pow(max(dot(viewDir, reflectDir), 0.), 32.) * specularIntensity;
    float shadow = 1.;
    if (shadowQuality > 0) {
        shadow = softShadow(pos, lightDir, .1, 10., 16.);
    }
    float ao = 1.;
    if (quality > 1) {
        ao = ambientOcclusion(pos, normal);
    }
    vec3 lighting = ambient * vec3(.2, .25, .3) * ao + diffuse * vec3(1., .9, .7) * shadow * lightIntensity + specular * vec3(1.) * shadow;
    return color * lighting * colorIntensity;
}
vec3 getRayDirection(vec2 uv, vec3 camPos, vec3 camTarget, vec3 camUp, float fov) {
    vec3 camForward = normalize(camTarget - camPos);
    vec3 camRight = normalize(cross(camForward, camUp));
    camUp = normalize(cross(camRight, camForward));
    float aspect = resolution.x / resolution.y;
    float focalLength = 1. / tan(radians(fov) / 2.);
    return normalize(camForward * focalLength + camRight * uv.x * aspect + camUp * uv.y);
}
void main() {
    vec2 uv = (gl_FragCoord.xy - resolution * 0.5) / resolution.y;
    vec3 effectiveCameraPos = cameraPos;
    if (isAnimating) {
        float angle = time * animationSpeed * .3;
        effectiveCameraPos = vec3(cos(angle) * cameraPos.x - sin(angle) * cameraPos.z, cameraPos.y, sin(angle) * cameraPos.x + cos(angle) * cameraPos.z);
    }
    vec3 rayDir = getRayDirection(uv, effectiveCameraPos, cameraTarget, cameraUp, cameraFov);
    int iterations;
    float t = rayMarch(effectiveCameraPos, rayDir, iterations);
    vec3 finalColor;
    if (t < cameraFar) {
        vec3 pos = effectiveCameraPos + rayDir * t;
        vec3 normal = calcNormal(pos);
        finalColor = shade(pos, normal, -rayDir, iterations, t);
    } else {
        if (backgroundType == 0) {
            finalColor = backgroundColor;
        } else if (backgroundType == 1) {
            float angle = radians(gradientDirection);
            vec2 gradientDir = vec2(cos(angle), sin(angle));
            float t = .5 + .5 * dot(normalize(gradientDir), normalize(uv));
            finalColor = mix(gradientColorStart, gradientColorEnd, t);
        } else if (backgroundType == 2) {
            float t = length(uv) * .7;
            t = clamp(t, 0., 1.);
            finalColor = mix(gradientColorStart, gradientColorEnd, t);
        }
        float vignette = 1. - dot(uv, uv) * .5;
        finalColor *= vignette;
    }
    finalColor = pow(finalColor, vec3(1. / 2.2));
    gl_FragColor = vec4(finalColor, 1.);
}
</script>
<script type="x-shader/x-vertex" id="vertexShader">void main(){gl_Position=vec4(position,1.);}</script>
<script type="module">import *as THREE from 'https://cdn.skypack.dev/three@0.136.0';
import {OrbitControls} from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls.js';

class FractalExplorer {
    constructor() {
        this.canvas = document.getElementById('renderCanvas');
        this.performance = {fps: 0, frameCount: 0, lastFpsTime: 0, renderTime: 0};
        this.config = {
            fractalType: 0,
            maxIterations: 8,
            power: 8,
            scale: 2,
            bailout: 4,
            juliaConstant: new THREE.Vector4(.33, .42, .18, 0),
            colorScheme: 0,
            colorOffset: 0,
            colorIntensity: 1,
            backgroundColor: new THREE.Color(0),
            lightDirection: new THREE.Vector3(1, 1, 1).normalize(),
            lightIntensity: 1,
            ambientLight: .2,
            specularIntensity: .5,
            shadowQuality: 1,
            isAnimating: !1,
            animationSpeed: 1,
            quality: 2,
            isInteractive: !1,
            camera: {
                fov: 60,
                near: .1,
                far: 100,
                position: new THREE.Vector3(2.5, 2.5, 2.5),
                target: new THREE.Vector3(0, 0, 0),
                up: new THREE.Vector3(0, 1, 0)
            },
            backgroundType: 1,
            gradientColorStart: new THREE.Color(16777215),
            gradientColorEnd: new THREE.Color(12570879),
            gradientDirection: 90
        };
        this.flightMode = {
            enabled: !1,
            keys: {},
            mouseMovement: {x: 0, y: 0},
            lastMouseX: 0,
            lastMouseY: 0,
            moveSpeed: .05,
            lookSpeed: .002,
            velocity: new THREE.Vector3
        };
        this.initRendering();
        this.initUI();
        this.initFlightMode();
        this.loadSavedPresets();
        this.checkUrlParameters();
        this.animate();
        setTimeout(() => {
            document.getElementById('loadingOverlay').classList.add('hidden')
        }, 500)
    }

    initRendering() {
        this.scene = new THREE.Scene();
        this.camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
        this.renderer = new THREE.WebGLRenderer({
            canvas: this.canvas,
            antialias: !0,
            alpha: !0,
            preserveDrawingBuffer: !0
        });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.setPixelRatio(window.devicePixelRatio);
        this.initShaderMaterial();
        this.quadGeometry = new THREE.PlaneGeometry(2, 2);
        this.quadMesh = new THREE.Mesh(this.quadGeometry, this.shaderMaterial);
        this.scene.add(this.quadMesh);
        this.controls = new OrbitControls(new THREE.PerspectiveCamera(60, 1, .1, 100), this.canvas);
        this.controls.enableDamping = !0;
        this.controls.dampingFactor = .1;
        this.controls.rotateSpeed = .5;
        this.controls.panSpeed = .5;
        this.controls.zoomSpeed = .5;
        this.controls.object.position.copy(this.config.camera.position);
        this.controls.target.copy(this.config.camera.target);
        this.controls.update();
        this.controls.addEventListener('change', () => {
            this.config.camera.position.copy(this.controls.object.position);
            this.config.isInteractive = !0;
            clearTimeout(this.interactionTimeout);
            this.interactionTimeout = setTimeout(() => {
                this.config.isInteractive = !1
            }, 500)
        });
        window.addEventListener('resize', () => this.onWindowResize());
        this.onWindowResize()
    }

    initShaderMaterial() {
        this.uniforms = {
            resolution: {value: new THREE.Vector2},
            time: {value: 0},
            cameraPos: {value: this.config.camera.position},
            cameraTarget: {value: this.config.camera.target},
            cameraUp: {value: this.config.camera.up},
            cameraNear: {value: this.config.camera.near},
            cameraFar: {value: this.config.camera.far},
            cameraFov: {value: this.config.camera.fov},
            fractalType: {value: this.config.fractalType},
            maxIterations: {value: this.config.maxIterations},
            power: {value: this.config.power},
            scale: {value: this.config.scale},
            bailout: {value: this.config.bailout},
            juliaConstant: {value: this.config.juliaConstant},
            colorScheme: {value: this.config.colorScheme},
            colorOffset: {value: this.config.colorOffset},
            colorIntensity: {value: this.config.colorIntensity},
            backgroundColor: {value: this.config.backgroundColor},
            backgroundType: {value: this.config.backgroundType},
            gradientColorStart: {value: this.config.gradientColorStart},
            gradientColorEnd: {value: this.config.gradientColorEnd},
            gradientDirection: {value: this.config.gradientDirection},
            lightDirection: {value: this.config.lightDirection},
            lightIntensity: {value: this.config.lightIntensity},
            ambientLight: {value: this.config.ambientLight},
            specularIntensity: {value: this.config.specularIntensity},
            shadowQuality: {value: this.config.shadowQuality},
            isAnimating: {value: this.config.isAnimating},
            animationSpeed: {value: this.config.animationSpeed},
            quality: {value: this.config.quality},
            isInteractive: {value: this.config.isInteractive}
        };
        this.shaderMaterial = new THREE.ShaderMaterial({
            uniforms: this.uniforms,
            vertexShader: document.getElementById('vertexShader').textContent,
            fragmentShader: document.getElementById('fragmentShader').textContent
        })
    }

    onWindowResize() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        this.renderer.setSize(width, height);
        this.uniforms.resolution.value.set(width, height);
    }

    initFlightMode() {
        document.getElementById('flightModeButton').addEventListener('click', () => {
            this.toggleFlightMode()
        });
        document.addEventListener('keydown', (e) => {
            if (this.flightMode.enabled) {
                this.flightMode.keys[e.key.toLowerCase()] = !0;
                if (e.key === 'Escape') {
                    this.toggleFlightMode()
                }
            }
        });
        document.addEventListener('keyup', (e) => {
            if (this.flightMode.enabled) {
                this.flightMode.keys[e.key.toLowerCase()] = !1
            }
        });
        this.canvas.addEventListener('mousemove', (e) => {
            if (this.flightMode.enabled) {
                this.flightMode.mouseMovement.x = e.movementX || e.clientX - this.flightMode.lastMouseX;
                this.flightMode.mouseMovement.y = e.movementY || e.clientY - this.flightMode.lastMouseY;
                this.flightMode.lastMouseX = e.clientX;
                this.flightMode.lastMouseY = e.clientY
            }
        })
    }

    toggleFlightMode() {
        this.flightMode.enabled = !this.flightMode.enabled;
        if (this.flightMode.enabled) {
            this.canvas.requestPointerLock();
            document.getElementById('flightModeIndicator').classList.add('active');
            document.getElementById('controlPanel').classList.add('collapsed');
            this.controls.enabled = !1
        } else {
            document.exitPointerLock();
            document.getElementById('flightModeIndicator').classList.remove('active');
            document.getElementById('controlPanel').classList.remove('collapsed');
            this.controls.enabled = !0
        }
    }

    updateFlightMode(deltaTime) {
        if (!this.flightMode.enabled) return;
        const cam = this.config.camera;
        const forward = new THREE.Vector3().subVectors(cam.target, cam.position).normalize();
        const right = new THREE.Vector3().crossVectors(forward, cam.up).normalize();
        const up = cam.up.clone().normalize();
        this.flightMode.velocity.set(0, 0, 0);
        if (this.flightMode.keys['w']) this.flightMode.velocity.add(forward);
        if (this.flightMode.keys['s']) this.flightMode.velocity.sub(forward);
        if (this.flightMode.keys['a']) this.flightMode.velocity.sub(right);
        if (this.flightMode.keys['d']) this.flightMode.velocity.add(right);
        if (this.flightMode.keys['q']) this.flightMode.velocity.sub(up);
        if (this.flightMode.keys['e']) this.flightMode.velocity.add(up);
        if (this.flightMode.velocity.length() > 0) {
            this.flightMode.velocity.normalize();
            const distance = cam.position.distanceTo(cam.target);
            const speed = this.flightMode.moveSpeed * Math.max(.1, distance * .5);
            cam.position.add(this.flightMode.velocity.clone().multiplyScalar(speed));
            cam.target.add(this.flightMode.velocity.clone().multiplyScalar(speed));
            this.uniforms.cameraPos.value.copy(cam.position);
            this.uniforms.cameraTarget.value.copy(cam.target)
        }
        if (Math.abs(this.flightMode.mouseMovement.x) > 0 || Math.abs(this.flightMode.mouseMovement.y) > 0) {
            const yaw = -this.flightMode.mouseMovement.x * this.flightMode.lookSpeed;
            const pitch = -this.flightMode.mouseMovement.y * this.flightMode.lookSpeed;
            const yawQuat = new THREE.Quaternion().setFromAxisAngle(up, yaw);
            forward.applyQuaternion(yawQuat);
            const pitchQuat = new THREE.Quaternion().setFromAxisAngle(right, pitch);
            forward.applyQuaternion(pitchQuat);
            cam.target.copy(cam.position).add(forward);
            this.uniforms.cameraTarget.value.copy(cam.target);
            this.flightMode.mouseMovement.x = 0;
            this.flightMode.mouseMovement.y = 0
        }
    }

    initUI() {
        const fractalType = document.getElementById('fractalType');
        fractalType.addEventListener('change', () => {
            const types = {
                'mandelbulb': 0,
                'mandelbox': 1,
                'juliaQuaternion': 2,
                'mengerSponge': 3,
                'sierpinskiTetrahedron': 4,
                'apollonian': 5,
                'kaliSet': 6,
                'xenodreambuie': 7
            };
            this.config.fractalType = types[fractalType.value];
            this.uniforms.fractalType.value = this.config.fractalType;
            document.getElementById('juliaParams').style.display = fractalType.value === 'juliaQuaternion' ? 'block' : 'none'
        });
        const maxIterations = document.getElementById('maxIterations');
        maxIterations.addEventListener('input', () => {
            const value = parseInt(maxIterations.value);
            this.config.maxIterations = value;
            this.uniforms.maxIterations.value = value;
            document.getElementById('iterDisplay').textContent = value;
            document.getElementById('iterationsCounter').textContent = value
        });
        const power = document.getElementById('power');
        power.addEventListener('input', () => {
            const value = parseFloat(power.value);
            this.config.power = value;
            this.uniforms.power.value = value;
            document.getElementById('powerDisplay').textContent = value.toFixed(1)
        });
        const scale = document.getElementById('scale');
        scale.addEventListener('input', () => {
            const value = parseFloat(scale.value);
            this.config.scale = value;
            this.uniforms.scale.value = value;
            document.getElementById('scaleDisplay').textContent = value.toFixed(1)
        });
        const bailout = document.getElementById('bailout');
        bailout.addEventListener('input', () => {
            const value = parseFloat(bailout.value);
            this.config.bailout = value;
            this.uniforms.bailout.value = value;
            document.getElementById('bailoutDisplay').textContent = value.toFixed(1)
        });
        const juliaX = document.getElementById('juliaX');
        const juliaY = document.getElementById('juliaY');
        const juliaZ = document.getElementById('juliaZ');
        const juliaW = document.getElementById('juliaW');
        const updateJuliaParams = () => {
            this.config.juliaConstant.set(parseFloat(juliaX.value), parseFloat(juliaY.value), parseFloat(juliaZ.value), parseFloat(juliaW.value));
            this.uniforms.juliaConstant.value = this.config.juliaConstant
        };
        juliaX.addEventListener('change', updateJuliaParams);
        juliaY.addEventListener('change', updateJuliaParams);
        juliaZ.addEventListener('change', updateJuliaParams);
        juliaW.addEventListener('change', updateJuliaParams);
        const colorScheme = document.getElementById('colorScheme');
        colorScheme.addEventListener('change', () => {
            const schemes = {
                'normal': 0,
                'depth': 1,
                'iterations': 2,
                'orbit': 3,
                'rainbow': 4,
                'fire': 5,
                'electric': 6,
                'cosmic': 7,
                'pastel': 8
            };
            this.config.colorScheme = schemes[colorScheme.value];
            this.uniforms.colorScheme.value = this.config.colorScheme
        });
        const colorOffset = document.getElementById('colorOffset');
        colorOffset.addEventListener('input', () => {
            const value = parseFloat(colorOffset.value);
            this.config.colorOffset = value;
            this.uniforms.colorOffset.value = value;
            document.getElementById('colorOffsetDisplay').textContent = value.toFixed(2)
        });
        const colorIntensity = document.getElementById('colorIntensity');
        colorIntensity.addEventListener('input', () => {
            const value = parseFloat(colorIntensity.value);
            this.config.colorIntensity = value;
            this.uniforms.colorIntensity.value = value;
            document.getElementById('colorIntensityDisplay').textContent = value.toFixed(1)
        });
        const backgroundColor = document.getElementById('backgroundColor');
        const backgroundColorText = document.getElementById('backgroundColorText');
        backgroundColor.addEventListener('input', () => {
            this.config.backgroundColor.set(backgroundColor.value);
            this.uniforms.backgroundColor.value = this.config.backgroundColor;
            backgroundColorText.value = backgroundColor.value
        });
        backgroundColorText.addEventListener('change', () => {
            let color = backgroundColorText.value;
            if (!color.startsWith('#')) color = '#' + color;
            if (!/^#[0-9A-F]{6}$/i.test(color)) {
                backgroundColorText.value = backgroundColor.value;
                return
            }
            backgroundColor.value = color;
            this.config.backgroundColor.set(color);
            this.uniforms.backgroundColor.value = this.config.backgroundColor
        });
        const lightIntensity = document.getElementById('lightIntensity');
        lightIntensity.addEventListener('input', () => {
            const value = parseFloat(lightIntensity.value);
            this.config.lightIntensity = value;
            this.uniforms.lightIntensity.value = value;
            document.getElementById('lightIntensityDisplay').textContent = value.toFixed(1)
        });
        const ambientLight = document.getElementById('ambientLight');
        ambientLight.addEventListener('input', () => {
            const value = parseFloat(ambientLight.value);
            this.config.ambientLight = value;
            this.uniforms.ambientLight.value = value;
            document.getElementById('ambientLightDisplay').textContent = value.toFixed(1)
        });
        const specularIntensity = document.getElementById('specularIntensity');
        specularIntensity.addEventListener('input', () => {
            const value = parseFloat(specularIntensity.value);
            this.config.specularIntensity = value;
            this.uniforms.specularIntensity.value = value;
            document.getElementById('specularIntensityDisplay').textContent = value.toFixed(1)
        });
        document.getElementById('lightPreset1').addEventListener('click', () => {
            this.config.lightDirection.set(0, 1, 0).normalize();
            this.uniforms.lightDirection.value = this.config.lightDirection
        });
        document.getElementById('lightPreset2').addEventListener('click', () => {
            this.config.lightDirection.set(0, 0, 1).normalize();
            this.uniforms.lightDirection.value = this.config.lightDirection
        });
        document.getElementById('lightPreset3').addEventListener('click', () => {
            this.config.lightDirection.set(-1, .5, .5).normalize();
            this.uniforms.lightDirection.value = this.config.lightDirection
        });
        document.getElementById('lightPreset4').addEventListener('click', () => {
            this.config.lightDirection.set(1, .5, .5).normalize();
            this.uniforms.lightDirection.value = this.config.lightDirection
        });
        const fov = document.getElementById('fov');
        fov.addEventListener('input', () => {
            const value = parseInt(fov.value);
            this.config.camera.fov = value;
            this.uniforms.cameraFov.value = value;
            document.getElementById('fovDisplay').textContent = value + 'Â°';
            this.controls.object.fov = value;
            this.controls.object.updateProjectionMatrix()
        });
        const cameraDistance = document.getElementById('cameraDistance');
        cameraDistance.addEventListener('input', () => {
            const value = parseFloat(cameraDistance.value);
            document.getElementById('cameraDistanceDisplay').textContent = value.toFixed(1);
            const direction = this.config.camera.position.clone().sub(this.config.camera.target).normalize();
            this.config.camera.position.copy(direction.multiplyScalar(value).add(this.config.camera.target));
            this.uniforms.cameraPos.value = this.config.camera.position;
            this.controls.object.position.copy(this.config.camera.position);
            this.controls.update()
        });
        document.getElementById('resetCamera').addEventListener('click', () => {
            this.config.camera.position.set(2.5, 2.5, 2.5);
            this.config.camera.target.set(0, 0, 0);
            this.uniforms.cameraPos.value = this.config.camera.position;
            this.uniforms.cameraTarget.value = this.config.camera.target;
            this.controls.object.position.copy(this.config.camera.position);
            this.controls.target.copy(this.config.camera.target);
            this.controls.update();
            fov.value = 60;
            document.getElementById('fovDisplay').textContent = '60Â°';
            this.config.camera.fov = 60;
            this.uniforms.cameraFov.value = 60;
            cameraDistance.value = 2.5;
            document.getElementById('cameraDistanceDisplay').textContent = '2.5'
        });
        const quality = document.getElementById('quality');
        quality.addEventListener('input', () => {
            const value = parseInt(quality.value);
            this.config.quality = value;
            this.uniforms.quality.value = value;
            const qualityLabels = ['Lowest', 'Low', 'Medium', 'High', 'Ultra'];
            document.getElementById('qualityDisplay').textContent = qualityLabels[value]
        });
        const shadowQuality = document.getElementById('shadowQuality');
        shadowQuality.addEventListener('input', () => {
            const value = parseInt(shadowQuality.value);
            this.config.shadowQuality = value;
            this.uniforms.shadowQuality.value = value;
            const qualityLabels = ['Off', 'Low', 'Medium', 'High'];
            document.getElementById('shadowQualityDisplay').textContent = qualityLabels[value]
        });
        const animationToggle = document.getElementById('animationToggle');
        animationToggle.addEventListener('click', () => {
            this.config.isAnimating = !this.config.isAnimating;
            this.uniforms.isAnimating.value = this.config.isAnimating;
            animationToggle.innerHTML = this.config.isAnimating ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg> Stop Animation` : `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> Start Animation`
        });
        const animationSpeed = document.getElementById('animationSpeed');
        animationSpeed.addEventListener('input', () => {
            const value = parseFloat(animationSpeed.value);
            this.config.animationSpeed = value;
            this.uniforms.animationSpeed.value = value;
            document.getElementById('animationSpeedDisplay').textContent = value.toFixed(1)
        });
        const presetButtons = document.querySelectorAll('.preset-button');
        presetButtons.forEach(button => {
            button.addEventListener('click', () => {
                const preset = button.dataset.preset;
                this.applyPreset(preset)
            })
        });
        document.getElementById('resetParameters').addEventListener('click', () => {
            this.resetParameters()
        });
        document.getElementById('randomizeParameters').addEventListener('click', () => {
            this.randomizeParameters()
        });
        document.getElementById('screenshotButton').addEventListener('click', () => {
            this.takeScreenshot()
        });
        document.getElementById('fullscreenButton').addEventListener('click', () => {
            if (document.fullscreenElement) {
                document.exitFullscreen()
            } else {
                this.canvas.requestFullscreen()
            }
        });
        const darkIcon = document.getElementById('darkIcon');
        const lightIcon = document.getElementById('lightIcon');
        document.getElementById('themeToggle').addEventListener('click', () => {
            const isDark = document.body.classList.toggle('light-mode');
            if (isDark) {
                darkIcon.classList.add('hidden');
                lightIcon.classList.remove('hidden')
            } else {
                darkIcon.classList.remove('hidden');
                lightIcon.classList.add('hidden')
            }
        });
        document.getElementById('panelToggle').addEventListener('click', () => {
            document.getElementById('controlPanel').classList.toggle('collapsed')
        });
        document.getElementById('shareButton').addEventListener('click', () => {
            this.showShareModal()
        });
        document.getElementById('galleryButton').addEventListener('click', () => {
            this.showGalleryModal()
        });
        document.getElementById('closeShareModal').addEventListener('click', () => {
            document.getElementById('shareModal').classList.remove('visible')
        });
        document.getElementById('closeGalleryModal').addEventListener('click', () => {
            document.getElementById('galleryModal').classList.remove('visible')
        });
        document.getElementById('copyShareUrl').addEventListener('click', () => {
            const shareUrl = document.getElementById('shareUrl');
            shareUrl.select();
            document.execCommand('copy');
            this.showNotification('URL copied to clipboard')
        });
        document.getElementById('downloadImage').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = `fractal3d-${new Date().toISOString().slice(0, 10)}.png`;
            link.href = this.canvas.toDataURL('image/png');
            link.click()
        });
        document.getElementById('savePreset').addEventListener('click', () => {
            const name = document.getElementById('savePresetName').value.trim();
            if (!name) {
                this.showNotification('Please enter a preset name', 'error');
                return
            }
            this.saveCurrentPreset(name);
            document.getElementById('savePresetName').value = ''
        });
        document.getElementById('savedPresets').addEventListener('change', (e) => {
            const value = e.target.value;
            if (!value) return;
            this.loadPreset(value);
            e.target.value = ''
        });
        document.getElementById('exportSettings').addEventListener('click', () => {
            const settings = JSON.stringify(this.getSerializableConfig());
            const blob = new Blob([settings], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = `fractal3d-settings-${new Date().toISOString().slice(0, 10)}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url)
        });
        document.getElementById('importSettings').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader;
                reader.onload = (event) => {
                    try {
                        const settings = JSON.parse(event.target.result);
                        this.applyImportedSettings(settings);
                        this.showNotification('Settings imported successfully')
                    } catch (error) {
                        this.showNotification('Error importing settings', 'error');
                        console.error(error)
                    }
                };
                reader.readAsText(file)
            };
            input.click()
        });
        const backgroundType = document.getElementById('backgroundType');
        backgroundType.addEventListener('change', () => {
            const types = {'solid': 0, 'linear': 1, 'radial': 2};
            this.config.backgroundType = types[backgroundType.value];
            this.uniforms.backgroundType.value = this.config.backgroundType;
            document.getElementById('gradientControls').style.display = backgroundType.value !== 'solid' ? 'block' : 'none';
            document.getElementById('gradientDirectionControl').style.display = backgroundType.value === 'linear' ? 'block' : 'none'
        });
        const gradientColorStart = document.getElementById('gradientColorStart');
        const gradientColorStartText = document.getElementById('gradientColorStartText');
        gradientColorStart.addEventListener('input', () => {
            this.config.gradientColorStart.set(gradientColorStart.value);
            this.uniforms.gradientColorStart.value = this.config.gradientColorStart;
            gradientColorStartText.value = gradientColorStart.value
        });
        gradientColorStartText.addEventListener('change', () => {
            let color = gradientColorStartText.value;
            if (!color.startsWith('#')) color = '#' + color;
            if (!/^#[0-9A-F]{6}$/i.test(color)) {
                gradientColorStartText.value = gradientColorStart.value;
                return
            }
            gradientColorStart.value = color;
            this.config.gradientColorStart.set(color);
            this.uniforms.gradientColorStart.value = this.config.gradientColorStart
        });
        const gradientColorEnd = document.getElementById('gradientColorEnd');
        const gradientColorEndText = document.getElementById('gradientColorEndText');
        gradientColorEnd.addEventListener('input', () => {
            this.config.gradientColorEnd.set(gradientColorEnd.value);
            this.uniforms.gradientColorEnd.value = this.config.gradientColorEnd;
            gradientColorEndText.value = gradientColorEnd.value
        });
        gradientColorEndText.addEventListener('change', () => {
            let color = gradientColorEndText.value;
            if (!color.startsWith('#')) color = '#' + color;
            if (!/^#[0-9A-F]{6}$/i.test(color)) {
                gradientColorEndText.value = gradientColorEnd.value;
                return
            }
            gradientColorEnd.value = color;
            this.config.gradientColorEnd.set(color);
            this.uniforms.gradientColorEnd.value = this.config.gradientColorEnd
        });
        document.getElementById('gradientDirection').addEventListener('change', (e) => {
            this.config.gradientDirection = parseFloat(e.target.value);
            this.uniforms.gradientDirection.value = this.config.gradientDirection
        })
    }

    animate(time) {
        requestAnimationFrame(this.animate.bind(this));
        this.updatePerformanceStats(time);
        this.uniforms.time.value = time * .001;
        const deltaTime = time - (this.lastTime || time);
        this.lastTime = time;
        this.updateFlightMode(deltaTime * .001);
        if (!this.flightMode.enabled) {
            this.controls.update()
        }
        const startTime = performance.now();
        this.renderer.render(this.scene, this.camera);
        this.performance.renderTime = performance.now() - startTime;
        document.getElementById('renderTime').textContent = `${Math.round(this.performance.renderTime)} ms`
    }

    updatePerformanceStats(time) {
        this.performance.frameCount++;
        if (time - this.performance.lastFpsTime >= 1e3) {
            this.performance.fps = Math.round(this.performance.frameCount * 1e3 / (time - this.performance.lastFpsTime));
            document.getElementById('fpsCounter').textContent = this.performance.fps;
            this.performance.frameCount = 0;
            this.performance.lastFpsTime = time
        }
    }

    applyPreset(presetName) {
        this.config.isAnimating = !1;
        this.uniforms.isAnimating.value = !1;
        switch (presetName) {
            case'classic':
                this.config.fractalType = 0;
                this.config.power = 8;
                this.config.maxIterations = 10;
                this.config.scale = 2;
                this.config.bailout = 4;
                this.config.colorScheme = 0;
                this.config.colorOffset = 0;
                this.config.colorIntensity = 1;
                this.config.camera.position.set(2.5, 2.5, 2.5);
                this.config.camera.target.set(0, 0, 0);
                this.config.camera.fov = 60;
                document.getElementById('fractalType').value = 'mandelbulb';
                break;
            case'mandelbox':
                this.config.fractalType = 1;
                this.config.maxIterations = 64;
                this.config.power = 3;
                this.config.scale = -1.1;
                this.config.bailout = 10;
                this.config.colorScheme = 2;
                this.config.colorOffset = .3;
                this.config.colorIntensity = 1.2;
                this.config.camera.position.set(3.5, 3.5, 3.5);
                this.config.camera.target.set(0, 0, 0);
                this.config.camera.fov = 70;
                document.getElementById('fractalType').value = 'mandelbox';
                break;
            case'julia':
                this.config.fractalType = 2;
                this.config.maxIterations = 10;
                this.config.power = 2;
                this.config.scale = 1;
                this.config.bailout = 4;
                this.config.juliaConstant.set(.33, .42, .18, 0);
                this.config.colorScheme = 4;
                this.config.colorOffset = .5;
                this.config.colorIntensity = 1.3;
                this.config.camera.position.set(2.2, 2.2, 2.2);
                this.config.camera.target.set(0, 0, 0);
                this.config.camera.fov = 60;
                document.getElementById('fractalType').value = 'juliaQuaternion';
                break;
            case'menger':
                this.config.fractalType = 3;
                this.config.maxIterations = 5;
                this.config.power = 3;
                this.config.scale = 3;
                this.config.bailout = 4;
                this.config.colorScheme = 1;
                this.config.colorOffset = .2;
                this.config.colorIntensity = 1;
                this.config.camera.position.set(2.8, 2.8, 2.8);
                this.config.camera.target.set(0, 0, 0);
                this.config.camera.fov = 60;
                document.getElementById('fractalType').value = 'mengerSponge';
                break;
            case'sierpinski':
                this.config.fractalType = 4;
                this.config.maxIterations = 12;
                this.config.power = 2;
                this.config.scale = 2;
                this.config.bailout = 4;
                this.config.colorScheme = 7;
                this.config.colorOffset = 0;
                this.config.colorIntensity = 1.1;
                this.config.camera.position.set(2.8, 2.8, 2.8);
                this.config.camera.target.set(0, 0, 0);
                this.config.camera.fov = 60;
                document.getElementById('fractalType').value = 'sierpinskiTetrahedron';
                break;
            case'apollonian':
                this.config.fractalType = 5;
                this.config.maxIterations = 8;
                this.config.power = 2;
                this.config.scale = 1.5;
                this.config.bailout = 6;
                this.config.colorScheme = 6;
                this.config.colorOffset = .2;
                this.config.colorIntensity = 1.4;
                this.config.camera.position.set(2.5, 2.5, 2.5);
                this.config.camera.target.set(0, 0, 0);
                this.config.camera.fov = 65;
                document.getElementById('fractalType').value = 'apollonian';
                break;
            case'coral':
                this.config.fractalType = 6;
                this.config.power = 4.5;
                this.config.maxIterations = 10;
                this.config.scale = 2;
                this.config.bailout = 4;
                this.config.colorScheme = 5;
                this.config.colorOffset = .1;
                this.config.colorIntensity = 1.2;
                this.config.camera.position.set(2.5, 2.7, 2.5);
                this.config.camera.target.set(0, 0, 0);
                this.config.camera.fov = 60;
                document.getElementById('fractalType').value = 'kaliSet';
                break;
            case'cosmic':
                this.config.fractalType = 7;
                this.config.power = 6;
                this.config.maxIterations = 12;
                this.config.scale = 2;
                this.config.bailout = 1.2;
                this.config.colorScheme = 4;
                this.config.colorOffset = .3;
                this.config.colorIntensity = 1.3;
                this.config.camera.position.set(2.5, 2.5, 2.5);
                this.config.camera.target.set(0, 0, 0);
                this.config.camera.fov = 60;
                document.getElementById('fractalType').value = 'xenodreambuie';
                break;
            case'spiky':
                this.config.fractalType = 0;
                this.config.power = 12;
                this.config.maxIterations = 12;
                this.config.scale = 2;
                this.config.bailout = 4;
                this.config.colorScheme = 7;
                this.config.colorOffset = .2;
                this.config.colorIntensity = 1.2;
                this.config.camera.position.set(2.8, 2.8, 2.8);
                this.config.camera.target.set(0, 0, 0);
                this.config.camera.fov = 60;
                document.getElementById('fractalType').value = 'mandelbulb';
                break;
            case'mandelbox-fire':
                this.config.fractalType = 1;
                this.config.maxIterations = 32;
                this.config.power = 3;
                this.config.scale = -1.5;
                this.config.bailout = 10;
                this.config.colorScheme = 5;
                this.config.colorOffset = .1;
                this.config.colorIntensity = 1.4;
                this.config.camera.position.set(3, 3.2, 3);
                this.config.camera.target.set(0, 0, 0);
                this.config.camera.fov = 75;
                document.getElementById('fractalType').value = 'mandelbox';
                break
        }
        document.getElementById('maxIterations').value = this.config.maxIterations;
        document.getElementById('iterDisplay').textContent = this.config.maxIterations;
        document.getElementById('power').value = this.config.power;
        document.getElementById('powerDisplay').textContent = this.config.power.toFixed(1);
        document.getElementById('scale').value = this.config.scale;
        document.getElementById('scaleDisplay').textContent = this.config.scale.toFixed(1);
        document.getElementById('bailout').value = this.config.bailout;
        document.getElementById('bailoutDisplay').textContent = this.config.bailout.toFixed(1);
        const colorSchemes = ['normal', 'depth', 'iterations', 'orbit', 'rainbow', 'fire', 'electric', 'cosmic', 'pastel'];
        document.getElementById('colorScheme').value = colorSchemes[this.config.colorScheme];
        document.getElementById('colorOffset').value = this.config.colorOffset;
        document.getElementById('colorOffsetDisplay').textContent = this.config.colorOffset.toFixed(2);
        document.getElementById('colorIntensity').value = this.config.colorIntensity;
        document.getElementById('colorIntensityDisplay').textContent = this.config.colorIntensity.toFixed(1);
        document.getElementById('fov').value = this.config.camera.fov;
        document.getElementById('fovDisplay').textContent = this.config.camera.fov + 'Â°';
        const distance = this.config.camera.position.distanceTo(this.config.camera.target);
        document.getElementById('cameraDistance').value = distance;
        document.getElementById('cameraDistanceDisplay').textContent = distance.toFixed(1);
        if (this.config.fractalType === 2) {
            document.getElementById('juliaX').value = this.config.juliaConstant.x;
            document.getElementById('juliaY').value = this.config.juliaConstant.y;
            document.getElementById('juliaZ').value = this.config.juliaConstant.z;
            document.getElementById('juliaW').value = this.config.juliaConstant.w
        }
        this.uniforms.fractalType.value = this.config.fractalType;
        this.uniforms.maxIterations.value = this.config.maxIterations;
        this.uniforms.power.value = this.config.power;
        this.uniforms.scale.value = this.config.scale;
        this.uniforms.bailout.value = this.config.bailout;
        this.uniforms.colorScheme.value = this.config.colorScheme;
        this.uniforms.colorOffset.value = this.config.colorOffset;
        this.uniforms.colorIntensity.value = this.config.colorIntensity;
        this.uniforms.cameraPos.value = this.config.camera.position;
        this.uniforms.cameraTarget.value = this.config.camera.target;
        this.uniforms.cameraFov.value = this.config.camera.fov;
        this.uniforms.juliaConstant.value = this.config.juliaConstant;
        this.controls.object.position.copy(this.config.camera.position);
        this.controls.target.copy(this.config.camera.target);
        this.controls.object.fov = this.config.camera.fov;
        this.controls.object.updateProjectionMatrix();
        this.controls.update();
        document.getElementById('iterationsCounter').textContent = this.config.maxIterations;
        document.getElementById('juliaParams').style.display = this.config.fractalType === 2 ? 'block' : 'none'
    }

    resetParameters() {
        this.config.maxIterations = 8;
        this.config.power = 8;
        this.config.scale = 2;
        this.config.bailout = 4;
        this.config.juliaConstant.set(.33, .42, .18, 0);
        this.config.colorOffset = 0;
        this.config.colorIntensity = 1;
        document.getElementById('maxIterations').value = this.config.maxIterations;
        document.getElementById('iterDisplay').textContent = this.config.maxIterations;
        document.getElementById('power').value = this.config.power;
        document.getElementById('powerDisplay').textContent = this.config.power.toFixed(1);
        document.getElementById('scale').value = this.config.scale;
        document.getElementById('scaleDisplay').textContent = this.config.scale.toFixed(1);
        document.getElementById('bailout').value = this.config.bailout;
        document.getElementById('bailoutDisplay').textContent = this.config.bailout.toFixed(1);
        document.getElementById('juliaX').value = this.config.juliaConstant.x;
        document.getElementById('juliaY').value = this.config.juliaConstant.y;
        document.getElementById('juliaZ').value = this.config.juliaConstant.z;
        document.getElementById('juliaW').value = this.config.juliaConstant.w;
        document.getElementById('colorOffset').value = this.config.colorOffset;
        document.getElementById('colorOffsetDisplay').textContent = this.config.colorOffset.toFixed(2);
        document.getElementById('colorIntensity').value = this.config.colorIntensity;
        document.getElementById('colorIntensityDisplay').textContent = this.config.colorIntensity.toFixed(1);
        this.uniforms.maxIterations.value = this.config.maxIterations;
        this.uniforms.power.value = this.config.power;
        this.uniforms.scale.value = this.config.scale;
        this.uniforms.bailout.value = this.config.bailout;
        this.uniforms.juliaConstant.value = this.config.juliaConstant;
        this.uniforms.colorOffset.value = this.config.colorOffset;
        this.uniforms.colorIntensity.value = this.config.colorIntensity;
        document.getElementById('iterationsCounter').textContent = this.config.maxIterations
    }

    randomizeParameters() {
        this.config.fractalType = Math.floor(Math.random() * 8);
        this.config.maxIterations = Math.floor(Math.random() * 8) + 6;
        this.config.power = 2 + Math.random() * 12;
        this.config.scale = 1 + Math.random() * 3;
        this.config.bailout = 2 + Math.random() * 6;
        this.config.juliaConstant.set(Math.random() * 2 - 1, Math.random() * 2 - 1, Math.random() * 2 - 1, Math.random() * 2 - 1);
        this.config.colorScheme = Math.floor(Math.random() * 9);
        this.config.colorOffset = Math.random();
        const fractalTypes = ['mandelbulb', 'mandelbox', 'juliaQuaternion', 'mengerSponge', 'sierpinskiTetrahedron', 'apollonian', 'kaliSet', 'xenodreambuie'];
        const colorSchemes = ['normal', 'depth', 'iterations', 'orbit', 'rainbow', 'fire', 'electric', 'cosmic', 'pastel'];
        document.getElementById('fractalType').value = fractalTypes[this.config.fractalType];
        document.getElementById('maxIterations').value = this.config.maxIterations;
        document.getElementById('iterDisplay').textContent = this.config.maxIterations;
        document.getElementById('power').value = this.config.power;
        document.getElementById('powerDisplay').textContent = this.config.power.toFixed(1);
        document.getElementById('scale').value = this.config.scale;
        document.getElementById('scaleDisplay').textContent = this.config.scale.toFixed(1);
        document.getElementById('bailout').value = this.config.bailout;
        document.getElementById('bailoutDisplay').textContent = this.config.bailout.toFixed(1);
        document.getElementById('juliaX').value = this.config.juliaConstant.x.toFixed(2);
        document.getElementById('juliaY').value = this.config.juliaConstant.y.toFixed(2);
        document.getElementById('juliaZ').value = this.config.juliaConstant.z.toFixed(2);
        document.getElementById('juliaW').value = this.config.juliaConstant.w.toFixed(2);
        document.getElementById('colorScheme').value = colorSchemes[this.config.colorScheme];
        document.getElementById('colorOffset').value = this.config.colorOffset;
        document.getElementById('colorOffsetDisplay').textContent = this.config.colorOffset.toFixed(2);
        this.uniforms.fractalType.value = this.config.fractalType;
        this.uniforms.maxIterations.value = this.config.maxIterations;
        this.uniforms.power.value = this.config.power;
        this.uniforms.scale.value = this.config.scale;
        this.uniforms.bailout.value = this.config.bailout;
        this.uniforms.juliaConstant.value = this.config.juliaConstant;
        this.uniforms.colorScheme.value = this.config.colorScheme;
        this.uniforms.colorOffset.value = this.config.colorOffset;
        document.getElementById('iterationsCounter').textContent = this.config.maxIterations;
        document.getElementById('juliaParams').style.display = this.config.fractalType === 2 ? 'block' : 'none';
        this.showNotification('Randomized parameters')
    }

    takeScreenshot() {
        const currentQuality = this.config.quality;
        const currentInteractive = this.config.isInteractive;
        this.config.quality = 4;
        this.config.isInteractive = !1;
        this.uniforms.quality.value = 4;
        this.uniforms.isInteractive.value = !1;
        this.renderer.render(this.scene, this.camera);
        const imageUrl = this.canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `fractal3d-${new Date().toISOString().slice(0, 10)}.png`;
        link.href = imageUrl;
        link.click();
        this.config.quality = currentQuality;
        this.config.isInteractive = currentInteractive;
        this.uniforms.quality.value = currentQuality;
        this.uniforms.isInteractive.value = currentInteractive;
        this.saveToGallery(imageUrl);
        this.showNotification('Screenshot saved')
    }

    showShareModal() {
        const config = this.getSerializableConfig();
        const encoded = btoa(JSON.stringify(config));
        const url = new URL(window.location.href);
        url.search = `?config=${encoded}`;
        document.getElementById('shareUrl').value = url.toString();
        const imageUrl = this.canvas.toDataURL('image/png');
        document.getElementById('sharePreview').src = imageUrl;
        document.getElementById('downloadImage').href = imageUrl;
        document.getElementById('shareModal').classList.add('visible')
    }

    showGalleryModal() {
        const galleryGrid = document.getElementById('galleryGrid');
        const galleryEmpty = document.getElementById('galleryEmpty');
        const galleryItems = JSON.parse(localStorage.getItem('fractal3dGallery') || '[]');
        if (galleryItems.length === 0) {
            galleryGrid.innerHTML = '';
            galleryEmpty.style.display = 'block'
        } else {
            galleryEmpty.style.display = 'none';
            galleryGrid.innerHTML = '';
            galleryItems.forEach((item, index) => {
                const galleryItem = document.createElement('div');
                galleryItem.className = 'gallery-item';
                const image = document.createElement('img');
                image.src = item.imageUrl;
                image.className = 'gallery-image';
                const overlay = document.createElement('div');
                overlay.className = 'gallery-overlay';
                const title = document.createElement('div');
                title.className = 'gallery-title';
                title.textContent = item.name || `Fractal ${index + 1}`;
                overlay.appendChild(title);
                galleryItem.appendChild(image);
                galleryItem.appendChild(overlay);
                galleryItem.addEventListener('click', () => {
                    if (item.settings) {
                        this.applyImportedSettings(item.settings);
                        document.getElementById('galleryModal').classList.remove('visible');
                        this.showNotification('Settings loaded from gallery')
                    }
                });
                galleryGrid.appendChild(galleryItem)
            })
        }
        document.getElementById('galleryModal').classList.add('visible')
    }

    saveToGallery(imageUrl) {
        const settings = this.getSerializableConfig();
        const name = `Fractal ${new Date().toLocaleDateString()}`;
        const galleryItems = JSON.parse(localStorage.getItem('fractal3dGallery') || '[]');
        galleryItems.push({imageUrl, name, settings, date: new Date().toISOString()});
        if (galleryItems.length > 20) {
            galleryItems.shift()
        }
        localStorage.setItem('fractal3dGallery', JSON.stringify(galleryItems))
    }

    getSerializableConfig() {
        return {
            fractalType: this.config.fractalType,
            maxIterations: this.config.maxIterations,
            power: this.config.power,
            scale: this.config.scale,
            bailout: this.config.bailout,
            juliaConstant: {
                x: this.config.juliaConstant.x,
                y: this.config.juliaConstant.y,
                z: this.config.juliaConstant.z,
                w: this.config.juliaConstant.w
            },
            colorScheme: this.config.colorScheme,
            colorOffset: this.config.colorOffset,
            colorIntensity: this.config.colorIntensity,
            backgroundColor: this.config.backgroundColor.getHexString(),
            backgroundType: this.config.backgroundType,
            gradientColorStart: this.config.gradientColorStart.getHexString(),
            gradientColorEnd: this.config.gradientColorEnd.getHexString(),
            gradientDirection: this.config.gradientDirection,
            lightDirection: {
                x: this.config.lightDirection.x,
                y: this.config.lightDirection.y,
                z: this.config.lightDirection.z
            },
            lightIntensity: this.config.lightIntensity,
            ambientLight: this.config.ambientLight,
            specularIntensity: this.config.specularIntensity,
            camera: {
                position: {
                    x: this.config.camera.position.x,
                    y: this.config.camera.position.y,
                    z: this.config.camera.position.z
                },
                target: {
                    x: this.config.camera.target.x,
                    y: this.config.camera.target.y,
                    z: this.config.camera.target.z
                },
                fov: this.config.camera.fov
            },
            quality: this.config.quality
        }
    }

    applyImportedSettings(settings) {
        if (settings.fractalType !== undefined) {
            this.config.fractalType = settings.fractalType;
            this.uniforms.fractalType.value = settings.fractalType;
            const fractalTypes = ['mandelbulb', 'mandelbox', 'juliaQuaternion', 'mengerSponge', 'sierpinskiTetrahedron', 'apollonian', 'kaliSet', 'xenodreambuie'];
            document.getElementById('fractalType').value = fractalTypes[settings.fractalType];
            document.getElementById('juliaParams').style.display = settings.fractalType === 2 ? 'block' : 'none'
        }
        if (settings.maxIterations !== undefined) {
            this.config.maxIterations = settings.maxIterations;
            this.uniforms.maxIterations.value = settings.maxIterations;
            document.getElementById('maxIterations').value = settings.maxIterations;
            document.getElementById('iterDisplay').textContent = settings.maxIterations;
            document.getElementById('iterationsCounter').textContent = settings.maxIterations
        }
        if (settings.power !== undefined) {
            this.config.power = settings.power;
            this.uniforms.power.value = settings.power;
            document.getElementById('power').value = settings.power;
            document.getElementById('powerDisplay').textContent = settings.power.toFixed(1)
        }
        if (settings.scale !== undefined) {
            this.config.scale = settings.scale;
            this.uniforms.scale.value = settings.scale;
            document.getElementById('scale').value = settings.scale;
            document.getElementById('scaleDisplay').textContent = settings.scale.toFixed(1)
        }
        if (settings.bailout !== undefined) {
            this.config.bailout = settings.bailout;
            this.uniforms.bailout.value = settings.bailout;
            document.getElementById('bailout').value = settings.bailout;
            document.getElementById('bailoutDisplay').textContent = settings.bailout.toFixed(1)
        }
        if (settings.juliaConstant) {
            this.config.juliaConstant.set(settings.juliaConstant.x, settings.juliaConstant.y, settings.juliaConstant.z, settings.juliaConstant.w);
            this.uniforms.juliaConstant.value = this.config.juliaConstant;
            document.getElementById('juliaX').value = settings.juliaConstant.x;
            document.getElementById('juliaY').value = settings.juliaConstant.y;
            document.getElementById('juliaZ').value = settings.juliaConstant.z;
            document.getElementById('juliaW').value = settings.juliaConstant.w
        }
        if (settings.colorScheme !== undefined) {
            this.config.colorScheme = settings.colorScheme;
            this.uniforms.colorScheme.value = settings.colorScheme;
            const colorSchemes = ['normal', 'depth', 'iterations', 'orbit', 'rainbow', 'fire', 'electric', 'cosmic', 'pastel'];
            document.getElementById('colorScheme').value = colorSchemes[settings.colorScheme]
        }
        if (settings.colorOffset !== undefined) {
            this.config.colorOffset = settings.colorOffset;
            this.uniforms.colorOffset.value = settings.colorOffset;
            document.getElementById('colorOffset').value = settings.colorOffset;
            document.getElementById('colorOffsetDisplay').textContent = settings.colorOffset.toFixed(2)
        }
        if (settings.colorIntensity !== undefined) {
            this.config.colorIntensity = settings.colorIntensity;
            this.uniforms.colorIntensity.value = settings.colorIntensity;
            document.getElementById('colorIntensity').value = settings.colorIntensity;
            document.getElementById('colorIntensityDisplay').textContent = settings.colorIntensity.toFixed(1)
        }
        if (settings.backgroundColor) {
            this.config.backgroundColor.set('#' + settings.backgroundColor);
            this.uniforms.backgroundColor.value = this.config.backgroundColor;
            document.getElementById('backgroundColor').value = '#' + settings.backgroundColor;
            document.getElementById('backgroundColorText').value = '#' + settings.backgroundColor
        }
        if (settings.lightDirection) {
            this.config.lightDirection.set(settings.lightDirection.x, settings.lightDirection.y, settings.lightDirection.z).normalize();
            this.uniforms.lightDirection.value = this.config.lightDirection
        }
        if (settings.lightIntensity !== undefined) {
            this.config.lightIntensity = settings.lightIntensity;
            this.uniforms.lightIntensity.value = settings.lightIntensity;
            document.getElementById('lightIntensity').value = settings.lightIntensity;
            document.getElementById('lightIntensityDisplay').textContent = settings.lightIntensity.toFixed(1)
        }
        if (settings.ambientLight !== undefined) {
            this.config.ambientLight = settings.ambientLight;
            this.uniforms.ambientLight.value = settings.ambientLight;
            document.getElementById('ambientLight').value = settings.ambientLight;
            document.getElementById('ambientLightDisplay').textContent = settings.ambientLight.toFixed(1)
        }
        if (settings.specularIntensity !== undefined) {
            this.config.specularIntensity = settings.specularIntensity;
            this.uniforms.specularIntensity.value = settings.specularIntensity;
            document.getElementById('specularIntensity').value = settings.specularIntensity;
            document.getElementById('specularIntensityDisplay').textContent = settings.specularIntensity.toFixed(1)
        }
        if (settings.camera) {
            if (settings.camera.position) {
                this.config.camera.position.set(settings.camera.position.x, settings.camera.position.y, settings.camera.position.z);
                this.uniforms.cameraPos.value = this.config.camera.position;
                this.controls.object.position.copy(this.config.camera.position)
            }
            if (settings.camera.target) {
                this.config.camera.target.set(settings.camera.target.x, settings.camera.target.y, settings.camera.target.z);
                this.uniforms.cameraTarget.value = this.config.camera.target;
                this.controls.target.copy(this.config.camera.target)
            }
            if (settings.camera.fov !== undefined) {
                this.config.camera.fov = settings.camera.fov;
                this.uniforms.cameraFov.value = settings.camera.fov;
                document.getElementById('fov').value = settings.camera.fov;
                document.getElementById('fovDisplay').textContent = settings.camera.fov + 'Â°';
                this.controls.object.fov = settings.camera.fov;
                this.controls.object.updateProjectionMatrix()
            }
            this.controls.update();
            const distance = this.config.camera.position.distanceTo(this.config.camera.target);
            document.getElementById('cameraDistance').value = distance;
            document.getElementById('cameraDistanceDisplay').textContent = distance.toFixed(1)
        }
        if (settings.quality !== undefined) {
            this.config.quality = settings.quality;
            this.uniforms.quality.value = settings.quality;
            document.getElementById('quality').value = settings.quality;
            const qualityLabels = ['Lowest', 'Low', 'Medium', 'High', 'Ultra'];
            document.getElementById('qualityDisplay').textContent = qualityLabels[settings.quality]
        }
        if (settings.backgroundType !== undefined) {
            this.config.backgroundType = settings.backgroundType;
            this.uniforms.backgroundType.value = settings.backgroundType;
            const types = ['solid', 'linear', 'radial'];
            document.getElementById('backgroundType').value = types[settings.backgroundType];
            document.getElementById('gradientControls').style.display = settings.backgroundType !== 0 ? 'block' : 'none';
            document.getElementById('gradientDirectionControl').style.display = settings.backgroundType === 1 ? 'block' : 'none'
        }
        if (settings.gradientColorStart) {
            this.config.gradientColorStart.set('#' + settings.gradientColorStart);
            this.uniforms.gradientColorStart.value = this.config.gradientColorStart;
            document.getElementById('gradientColorStart').value = '#' + settings.gradientColorStart;
            document.getElementById('gradientColorStartText').value = '#' + settings.gradientColorStart
        }
        if (settings.gradientColorEnd) {
            this.config.gradientColorEnd.set('#' + settings.gradientColorEnd);
            this.uniforms.gradientColorEnd.value = this.config.gradientColorEnd;
            document.getElementById('gradientColorEnd').value = '#' + settings.gradientColorEnd;
            document.getElementById('gradientColorEndText').value = '#' + settings.gradientColorEnd
        }
        if (settings.gradientDirection !== undefined) {
            this.config.gradientDirection = settings.gradientDirection;
            this.uniforms.gradientDirection.value = settings.gradientDirection;
            document.getElementById('gradientDirection').value = settings.gradientDirection.toString()
        }
    }

    saveCurrentPreset(name) {
        const settings = this.getSerializableConfig();
        const presets = JSON.parse(localStorage.getItem('fractal3dPresets') || '[]');
        const existingIndex = presets.findIndex(p => p.name === name);
        if (existingIndex >= 0) {
            presets[existingIndex].settings = settings
        } else {
            presets.push({name, settings, date: new Date().toISOString()})
        }
        presets.sort((a, b) => a.name.localeCompare(b.name));
        localStorage.setItem('fractal3dPresets', JSON.stringify(presets));
        this.updatePresetsDropdown();
        this.showNotification(`Preset "${name}" saved`)
    }

    loadPreset(name) {
        const presets = JSON.parse(localStorage.getItem('fractal3dPresets') || '[]');
        const preset = presets.find(p => p.name === name);
        if (!preset) return;
        this.applyImportedSettings(preset.settings);
        this.showNotification(`Preset "${name}" loaded`)
    }

    loadSavedPresets() {
        this.updatePresetsDropdown()
    }

    updatePresetsDropdown() {
        const presets = JSON.parse(localStorage.getItem('fractal3dPresets') || '[]');
        const dropdown = document.getElementById('savedPresets');
        while (dropdown.options.length > 1) {
            dropdown.remove(1)
        }
        presets.forEach(preset => {
            const option = document.createElement('option');
            option.value = preset.name;
            option.textContent = preset.name;
            dropdown.appendChild(option)
        })
    }

    checkUrlParameters() {
        const params = new URLSearchParams(window.location.search);
        const configParam = params.get('config');
        if (configParam) {
            try {
                const settings = JSON.parse(atob(configParam));
                this.applyImportedSettings(settings);
                this.showNotification('Settings loaded from URL')
            } catch (error) {
                console.error('Error loading settings from URL:', error)
            }
        }
    }

    showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notificationMessage');
        notificationMessage.textContent = message;
        notification.className = 'notification';
        if (type === 'error') {
            notification.style.backgroundColor = '#e53e3e'
        } else {
            notification.style.backgroundColor = '#6366f1'
        }
        notification.classList.add('visible');
        clearTimeout(this.notificationTimeout);
        this.notificationTimeout = setTimeout(() => {
            notification.classList.remove('visible')
        }, 3e3)
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const app = new FractalExplorer
});</script>
</body>
</html>