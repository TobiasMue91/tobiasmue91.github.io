<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Invoice Generator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“„</text></svg>">
    <meta name="title" content="Invoice Generator - Free Online Invoice Generator | GPT Games">
    <meta name="description" content="Create professional invoices instantly with our free online invoice generator. Customize templates, add your logo, track payments, and export as PDF. No sign-up required.">
    <meta name="keywords" content="invoice generator, free invoice maker, online invoice tool, professional invoice templates, PDF invoice creator, business invoice software">
    <meta name="author" content="Claude 3.7 Sonnet prompted by Tobias MÃ¼ller">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.gptgames.dev/tools/invoice_generator.html">
    <meta property="og:title" content="Invoice Generator - Free Online Invoice Generator">
    <meta property="og:description" content="Create professional invoices in seconds with customizable templates, logo upload, client management, and PDF export. No account or installation needed.">
    <meta property="og:image" content="https://www.gptgames.dev/screenshots/screenshot_176.png">
    <meta property="og:site_name" content="GPT Games">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://www.gptgames.dev/tools/invoice_generator.html">
    <meta name="twitter:title" content="Invoice Generator - Free Online Invoice Generator">
    <meta name="twitter:description" content="Generate professional invoices with this free online tool. Customize, save, and export as PDF. No registration required.">
    <meta name="twitter:image" content="https://www.gptgames.dev/screenshots/screenshot_176.png">
    <link rel="canonical" href="https://www.gptgames.dev/tools/invoice_generator.html">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>:root {
        --primary-color: #4361ee;
        --secondary-color: #7209b7;
        --bg-color: #f8f9fa;
        --text-color: #333;
        --border-color: #dee2e6;
        --card-bg: #ffffff;
        --hover-color: #e9ecef;
        --template-classic-color: #4361ee;
        --template-modern-color: #10b981;
        --template-minimal-color: #6366f1;
        --template-corporate-color: #0369a1;
    }

    .theme-classic {
        --primary-color: var(--template-classic-color);
    }

    .theme-modern {
        --primary-color: var(--template-modern-color);
    }

    .theme-minimal {
        --primary-color: var(--template-minimal-color);
    }

    .theme-corporate {
        --primary-color: var(--template-corporate-color);
    }

    body {
        font-family: 'Segoe UI', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        transition: all 0.3s ease;
    }

    .card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .form-control, .form-select {
        background-color: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }

    .form-control:focus, .form-select:focus {
        background-color: var(--card-bg);
        color: var(--text-color);
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
    }

    .tooltip-icon {
        color: var(--primary-color);
        cursor: pointer;
        margin-left: 5px;
        font-size: 0.9rem;
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .btn-outline-primary {
        color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .btn-outline-primary:hover {
        background-color: var(--primary-color);
        color: white;
    }

    .catalog-item {
        cursor: pointer;
    }

    .catalog-item:hover {
        background-color: var(--hover-color);
    }

    .loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        color: white;
        font-size: 2rem;
    }

    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
    }

    .toast {
        background-color: var(--card-bg);
        color: var(--text-color);
        border-left: 4px solid var(--primary-color);
    }

    .toast-success {
        border-left-color: #10b981;
    }

    .toast-error {
        border-left-color: #ef4444;
    }

    .toast-info {
        border-left-color: #3b82f6;
    }

    #preview {
        padding: 20px;
    }

    #previewContainer {
        transition: all 0.3s ease;
        background-color: white;
    }

    .invoice-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 30px;
    }

    .company-logo img {
        max-height: 80px;
        max-width: 200px;
    }

    #signatureCanvas {
        border: 1px dashed var(--border-color);
        background-color: rgba(255, 255, 255, 0.9);
        width: 100%;
        height: 150px;
    }

    .line-item-row:hover {
        background-color: var(--hover-color);
    }

    .delete-line-item {
        cursor: pointer;
        color: #dc3545;
    }

    .template-preview {
        width: 100%;
        height: 120px;
        border: 2px solid transparent;
        cursor: pointer;
        overflow: hidden;
        transition: all 0.2s ease;
    }

    .template-preview.active {
        border-color: var(--primary-color);
    }

    .template-preview:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .template-classic {
        background-color: #f1f5f9;
        color: #334155;
    }

    .template-modern {
        background-color: #ecfdf5;
        color: #064e3b;
    }

    .template-minimal {
        background-color: #f5f3ff;
        color: #5b21b6;
    }

    .template-corporate {
        background-color: #e0f2fe;
        color: #0c4a6e;
    }

    .autosave-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 5px;
    }

    .autosave-success {
        background-color: #10b981;
    }

    .autosave-saving {
        background-color: #f59e0b;
        animation: pulse 1s infinite;
    }

    .autosave-error {
        background-color: #ef4444;
    }

    @keyframes pulse {
        0% {
            opacity: 0.6;
        }
        50% {
            opacity: 1;
        }
        100% {
            opacity: 0.6;
        }
    }

    #filterInput {
        width: 100%;
        margin-bottom: 10px;
    }

    .template-classic .invoice-title {
        color: var(--template-classic-color);
        border-bottom: 2px solid var(--template-classic-color);
    }

    .template-modern .invoice-title {
        color: var(--template-modern-color);
        padding: 10px;
        background-color: rgba(16, 185, 129, 0.1);
        border-radius: 5px;
    }

    .template-minimal .invoice-title {
        color: var(--template-minimal-color);
        font-weight: 300;
        letter-spacing: 2px;
    }

    .template-corporate .invoice-title {
        color: var(--template-corporate-color);
        font-weight: bold;
        border-left: 5px solid var(--template-corporate-color);
        padding-left: 15px;
    }

    .currency-symbol {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
    }

    .currency-input {
        padding-left: 25px;
    }

    .navbar-brand {
        color: var(--primary-color);
        font-weight: bold;
    }

    .navbar {
        background-color: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
    }

    #qrCode {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 10px;
    }

    #qrCode canvas {
        max-width: 100%;
        height: auto;
    }

    #customCss {
        font-family: monospace;
        font-size: 0.85rem;
    }

    @media (max-width: 767.98px) {
        .invoice-header {
            flex-direction: column;
        }

        .company-logo {
            margin-bottom: 20px;
        }

        .template-preview {
            height: 80px;
        }

        .modal-dialog {
            margin: 10px;
        }
    }

    @media print {
        .no-print {
            display: none !important;
        }

        body {
            background-color: white !important;
            color: black !important;
        }

        .card {
            border: none !important;
            box-shadow: none !important;
        }

        #previewContainer {
            width: 100% !important;
            max-width: none !important;
        }
    }</style>
</head>
<body>
<nav class="navbar navbar-expand-lg mb-4 no-print">
    <div class="container-fluid"><a class="navbar-brand" href="#"><i class="fas fa-file-invoice"></i> Invoice Generator</a><span
            class="ms-auto d-flex align-items-center"><span id="autosaveIndicator"
                                                            class="d-flex align-items-center me-3"><span
            class="autosave-indicator autosave-success"></span><small class="text-muted">Saved</small></span><div
            class="form-check form-switch d-flex align-items-center"><input class="form-check-input me-2"
                                                                            type="checkbox" id="autoSaveSwitch" checked><label
            class="form-check-label text-muted" for="autoSaveSwitch">Auto-save</label></div></span></div>
</nav>
<div class="container-fluid py-2">
    <div class="row">
        <div class="col-md-6 mb-4 no-print">
            <div class="card h-100">
                <div class="card-body">
                    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="business-tab" data-bs-toggle="tab"
                                    data-bs-target="#business" type="button" role="tab">Business
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="client-tab" data-bs-toggle="tab" data-bs-target="#client"
                                    type="button" role="tab">Client
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="items-tab" data-bs-toggle="tab" data-bs-target="#items"
                                    type="button" role="tab">Items
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="totals-tab" data-bs-toggle="tab" data-bs-target="#totals"
                                    type="button" role="tab">Totals
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="template-tab" data-bs-toggle="tab" data-bs-target="#template"
                                    type="button" role="tab">Design
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="myTabContent">
                        <div class="tab-pane fade show active" id="business" role="tabpanel"><h4 class="mb-3">Business
                            Information</h4>
                            <div class="mb-3"><label for="businessName" class="form-label">Business Name</label>
                                <div class="input-group"><input type="text" class="form-control" id="businessName"
                                                                required>
                                    <div class="invalid-feedback">Please enter your business name</div>
                                </div>
                            </div>
                            <div class="mb-3"><label for="businessAddress" class="form-label">Address</label><textarea
                                    class="form-control" id="businessAddress" rows="2"></textarea></div>
                            <div class="row">
                                <div class="col-md-6 mb-3"><label for="businessPhone"
                                                                  class="form-label">Phone</label><input type="text"
                                                                                                         class="form-control"
                                                                                                         id="businessPhone">
                                </div>
                                <div class="col-md-6 mb-3"><label for="businessEmail"
                                                                  class="form-label">Email</label><input type="email"
                                                                                                         class="form-control"
                                                                                                         id="businessEmail">
                                </div>
                            </div>
                            <div class="mb-3"><label for="businessLogo" class="form-label d-flex align-items-center">Logo<span
                                    class="tooltip-icon" data-bs-toggle="tooltip"
                                    title="You can either enter a URL or upload an image"><i
                                    class="fas fa-question-circle"></i></span></label>
                                <div class="input-group mb-2"><input type="text" class="form-control" id="businessLogo"
                                                                     placeholder="https://example.com/logo.png">
                                    <button class="btn btn-outline-secondary" type="button" id="uploadLogoBtn">Upload
                                    </button>
                                </div>
                                <input type="file" id="logoFileInput" accept="image/*" style="display:none"></div>
                            <div id="logoPreview" class="text-center mb-3" style="display:none;"><img
                                    id="logoPreviewImg" style="max-height:100px;max-width:200px;" alt="Logo preview">
                                <button id="removeLogo" class="btn btn-sm btn-outline-danger mt-2">Remove</button>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="client" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3"><h4>Client
                                Information</h4>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button"
                                            id="clientsDropdown" data-bs-toggle="dropdown" aria-expanded="false"><i
                                            class="fas fa-address-book"></i> Saved Clients
                                    </button>
                                    <ul class="dropdown-menu" id="savedClientsList"
                                        aria-labelledby="clientsDropdown"></ul>
                                </div>
                            </div>
                            <div class="mb-3"><label for="clientName" class="form-label">Client Name</label><input
                                    type="text" class="form-control" id="clientName" required></div>
                            <div class="mb-3"><label for="clientAddress" class="form-label">Address</label><textarea
                                    class="form-control" id="clientAddress" rows="2"></textarea></div>
                            <div class="row">
                                <div class="col-md-6 mb-3"><label for="clientPhone"
                                                                  class="form-label">Phone</label><input type="text"
                                                                                                         class="form-control"
                                                                                                         id="clientPhone">
                                </div>
                                <div class="col-md-6 mb-3"><label for="clientEmail"
                                                                  class="form-label">Email</label><input type="email"
                                                                                                         class="form-control"
                                                                                                         id="clientEmail">
                                </div>
                            </div>
                            <div class="form-check mb-3"><input class="form-check-input" type="checkbox"
                                                                id="saveClientCheck"><label class="form-check-label"
                                                                                            for="saveClientCheck">Save
                                client for future invoices</label></div>
                            <h4 class="mb-3 mt-4">Invoice Details</h4>
                            <div class="row">
                                <div class="col-md-4 mb-3"><label for="invoiceNumber" class="form-label">Invoice
                                    #</label>
                                    <div class="input-group"><input type="text" class="form-control" id="invoiceNumber"
                                                                    required>
                                        <button class="btn btn-outline-secondary" type="button"
                                                id="generateInvoiceNumber"><i class="fas fa-sync-alt"></i></button>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3"><label for="invoiceDate" class="form-label">Invoice
                                    Date</label><input type="date" class="form-control" id="invoiceDate" required></div>
                                <div class="col-md-4 mb-3"><label for="invoiceDueDate" class="form-label">Due
                                    Date</label><input type="date" class="form-control" id="invoiceDueDate" required>
                                </div>
                            </div>
                            <div class="mb-3"><label for="paymentTerms" class="form-label">Payment Terms</label><select
                                    class="form-select" id="paymentTerms">
                                <option value="due_on_receipt">Due on Receipt</option>
                                <option value="net_15">Net 15</option>
                                <option value="net_30" selected>Net 30</option>
                                <option value="net_60">Net 60</option>
                                <option value="custom">Custom</option>
                            </select></div>
                        </div>
                        <div class="tab-pane fade" id="items" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3"><h4>Line Items</h4>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" id="toggleCatalog"><i
                                            class="fas fa-book"></i> Catalog
                                    </button>
                                    <button class="btn btn-sm btn-primary" id="addLineItem"><i class="fas fa-plus"></i>
                                        Add Item
                                    </button>
                                </div>
                            </div>
                            <div id="catalogContainer" style="display:none;" class="mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-2"><h5
                                                class="card-title">Product/Service Catalog</h5>
                                            <button class="btn btn-sm btn-outline-primary" id="addToCatalog">Add New
                                            </button>
                                        </div>
                                        <div class="list-group" id="catalogItems"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-borderless" id="lineItemsTable">
                                    <thead>
                                    <tr>
                                        <th style="width:40%">Description</th>
                                        <th style="width:15%">Quantity</th>
                                        <th style="width:20%">Rate</th>
                                        <th style="width:20%">Amount</th>
                                        <th style="width:5%"></th>
                                    </tr>
                                    </thead>
                                    <tbody id="lineItemsBody"></tbody>
                                </table>
                            </div>
                            <div class="mb-3 mt-4"><label for="notes" class="form-label">Notes</label><textarea
                                    class="form-control" id="notes" rows="3"
                                    placeholder="Payment details, thank you note, etc."></textarea></div>
                        </div>
                        <div class="tab-pane fade" id="totals" role="tabpanel"><h4 class="mb-3">Invoice Totals</h4>
                            <div class="mb-3"><label for="currency" class="form-label">Currency</label><select
                                    class="form-select" id="currency">
                                <option value="USD" selected>USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - British Pound</option>
                                <option value="CAD">CAD - Canadian Dollar</option>
                                <option value="AUD">AUD - Australian Dollar</option>
                                <option value="JPY">JPY - Japanese Yen</option>
                                <option value="CNY">CNY - Chinese Yuan</option>
                                <option value="INR">INR - Indian Rupee</option>
                            </select></div>
                            <div class="mb-3"><label for="taxRate" class="form-label">Tax Rate (%)</label><input
                                    type="number" class="form-control" id="taxRate" min="0" step="0.01" value="0"></div>
                            <div class="mb-3"><label for="discountType" class="form-label">Discount Type</label><select
                                    class="form-select" id="discountType">
                                <option value="fixed">Fixed Amount</option>
                                <option value="percentage">Percentage</option>
                            </select></div>
                            <div class="mb-3"><label for="discount" class="form-label">Discount</label>
                                <div class="input-group"><span class="input-group-text"
                                                               id="discountSymbol">$</span><input type="number"
                                                                                                  class="form-control"
                                                                                                  id="discount" min="0"
                                                                                                  step="0.01" value="0">
                                </div>
                            </div>
                            <div class="mb-3"><label for="shipping" class="form-label">Shipping</label>
                                <div class="input-group"><span class="input-group-text">$</span><input type="number"
                                                                                                       class="form-control"
                                                                                                       id="shipping"
                                                                                                       min="0"
                                                                                                       step="0.01"
                                                                                                       value="0"></div>
                            </div>
                            <h5 class="mb-3 mt-4">Payment Options</h5>
                            <div class="mb-3"><label for="paymentMethod" class="form-label">Payment
                                Method</label><select class="form-select" id="paymentMethod">
                                <option value="" selected>None</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="card">Credit Card</option>
                                <option value="paypal">PayPal</option>
                                <option value="custom">Custom</option>
                            </select></div>
                            <div id="paymentDetailsContainer" class="mb-3" style="display:none;"><label
                                    for="paymentDetails" class="form-label">Payment Details</label><textarea
                                    class="form-control" id="paymentDetails" rows="2"></textarea></div>
                            <div class="form-check mb-3"><input class="form-check-input" type="checkbox"
                                                                id="showQrCode"><label class="form-check-label"
                                                                                       for="showQrCode">Generate QR code
                                for payment</label></div>
                            <div class="d-grid gap-2 mt-4">
                                <button class="btn btn-primary" id="updateTotals"><i class="fas fa-calculator"></i>
                                    Calculate Totals
                                </button>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="template" role="tabpanel"><h4 class="mb-3">Invoice Design</h4>
                            <div class="row mb-4">
                                <div class="col-12 mb-2"><label class="form-label">Select Template</label></div>
                                <div class="col-6 col-md-3 mb-3">
                                    <div class="template-preview template-classic active" data-template="classic">
                                        <div class="p-2">
                                            <div class="d-flex justify-content-between">
                                                <div><small>LOGO</small></div>
                                                <div><small class="fw-bold">INVOICE</small></div>
                                            </div>
                                            <div class="mt-2">
                                                <div class="w-75 bg-light rounded mb-1" style="height:3px"></div>
                                                <div class="w-50 bg-light rounded mb-1" style="height:3px"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <small class="d-block text-center">Classic</small></div>
                                <div class="col-6 col-md-3 mb-3">
                                    <div class="template-preview template-modern" data-template="modern">
                                        <div class="p-2">
                                            <div class="d-flex justify-content-between">
                                                <div><small>LOGO</small></div>
                                                <div class="bg-white p-1 rounded"><small class="fw-bold">INVOICE</small>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <div class="w-75 bg-light rounded mb-1" style="height:3px"></div>
                                                <div class="w-50 bg-light rounded mb-1" style="height:3px"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <small class="d-block text-center">Modern</small></div>
                                <div class="col-6 col-md-3 mb-3">
                                    <div class="template-preview template-minimal" data-template="minimal">
                                        <div class="p-2">
                                            <div class="d-flex justify-content-between">
                                                <div><small>LOGO</small></div>
                                                <div><small class="fw-light">INVOICE</small></div>
                                            </div>
                                            <div class="mt-2">
                                                <div class="w-75 bg-light rounded mb-1" style="height:3px"></div>
                                                <div class="w-50 bg-light rounded mb-1" style="height:3px"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <small class="d-block text-center">Minimal</small></div>
                                <div class="col-6 col-md-3 mb-3">
                                    <div class="template-preview template-corporate" data-template="corporate">
                                        <div class="p-2">
                                            <div class="d-flex justify-content-between">
                                                <div><small>LOGO</small></div>
                                                <div>
                                                    <div class="border-start ps-1"><small
                                                            class="fw-bold">INVOICE</small></div>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <div class="w-75 bg-light rounded mb-1" style="height:3px"></div>
                                                <div class="w-50 bg-light rounded mb-1" style="height:3px"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <small class="d-block text-center">Corporate</small></div>
                            </div>
                            <h5 class="mb-3">Additional Options</h5>
                            <div class="mb-3 form-check"><input class="form-check-input" type="checkbox"
                                                                id="showSignature"><label class="form-check-label"
                                                                                          for="showSignature">Include
                                signature</label></div>
                            <div id="signatureContainer" class="mb-3" style="display:none;"><label class="form-label">Signature</label>
                                <div class="d-flex flex-column align-items-center">
                                    <canvas id="signatureCanvas"></canvas>
                                    <div class="btn-group mt-2">
                                        <button class="btn btn-sm btn-outline-secondary" id="clearSignature">Clear
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" id="saveSignature">Save</button>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3 form-check"><input class="form-check-input" type="checkbox"
                                                                id="showBrandingCheck" checked><label
                                    class="form-check-label" for="showBrandingCheck">Show Invoice Generator branding</label>
                            </div>
                            <div class="mb-3"><label for="customCss" class="form-label">Custom CSS
                                (Advanced)</label><textarea class="form-control" id="customCss" rows="3"
                                                            placeholder=".invoice-header{background-color:#f8f9fa;}"
                                                            spellcheck="false"></textarea></div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-4">
                        <div>
                            <div class="dropdown d-inline-block me-2">
                                <button class="btn btn-outline-primary dropdown-toggle" type="button"
                                        id="invoiceActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false"><i
                                        class="fas fa-cog"></i> Actions
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="invoiceActionsDropdown">
                                    <li><a class="dropdown-item" href="#" id="saveInvoice"><i class="fas fa-save"></i>
                                        Save Invoice</a></li>
                                    <li><a class="dropdown-item" href="#" id="loadInvoice"><i
                                            class="fas fa-folder-open"></i> Manage Invoices</a></li>
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li><a class="dropdown-item" href="#" id="duplicateInvoice"><i
                                            class="fas fa-copy"></i> Duplicate Invoice</a></li>
                                    <li><a class="dropdown-item" href="#" id="clearInvoice"><i
                                            class="fas fa-trash-alt"></i> Clear Invoice</a></li>
                                </ul>
                            </div>
                            <button class="btn btn-outline-primary me-2" id="previewToggle"><i class="fas fa-eye"></i>
                                <span id="previewToggleText">Hide Preview</span></button>
                        </div>
                        <div>
                            <button class="btn btn-primary me-2" id="printInvoice"><i class="fas fa-print"></i> Print
                            </button>
                            <div class="dropdown d-inline-block">
                                <button class="btn btn-primary dropdown-toggle" type="button" id="exportDropdown"
                                        data-bs-toggle="dropdown" aria-expanded="false"><i
                                        class="fas fa-file-export"></i> Export
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="exportDropdown">
                                    <li><a class="dropdown-item" href="#" id="downloadPdf"><i
                                            class="fas fa-file-pdf"></i> Download PDF</a></li>
                                    <li><a class="dropdown-item" href="#" id="sendEmail"><i class="fas fa-envelope"></i>
                                        Send via Email</a></li>
                                    <li><a class="dropdown-item" href="#" id="downloadJson"><i
                                            class="fas fa-file-code"></i> Export Data (JSON)</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div id="previewContainer">
                        <div id="preview">
                            <div class="invoice-header">
                                <div class="company-logo" id="previewLogo"></div>
                                <div class="text-end"><h2 class="invoice-title">INVOICE</h2>
                                    <p id="previewInvoiceNumber">#INV-0001</p></div>
                            </div>
                            <div class="row mb-4">
                                <div class="col-md-6"><h5>From:</h5>
                                    <div id="previewBusinessInfo"><p class="mb-0"><strong id="previewBusinessName">Your
                                        Business Name</strong></p>
                                        <p class="mb-0" id="previewBusinessAddress">123 Business Street, City</p>
                                        <p class="mb-0" id="previewBusinessPhone">Phone: (123) 456-7890</p>
                                        <p class="mb-0" id="previewBusinessEmail">email@business.com</p></div>
                                </div>
                                <div class="col-md-6 text-md-end"><h5>To:</h5>
                                    <div id="previewClientInfo"><p class="mb-0"><strong id="previewClientName">Client
                                        Name</strong></p>
                                        <p class="mb-0" id="previewClientAddress">456 Client Avenue, City</p>
                                        <p class="mb-0" id="previewClientPhone">Phone: (987) 654-3210</p>
                                        <p class="mb-0" id="previewClientEmail">client@email.com</p></div>
                                </div>
                            </div>
                            <div class="row mb-4">
                                <div class="col-md-6"><h5>Invoice Date:</h5>
                                    <p id="previewInvoiceDate">January 1, 2023</p></div>
                                <div class="col-md-6 text-md-end"><h5>Due Date:</h5>
                                    <p id="previewDueDate">January 15, 2023</p></div>
                            </div>
                            <div class="table-responsive mb-4">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th style="width:50%">Description</th>
                                        <th style="width:10%">Qty</th>
                                        <th style="width:20%">Rate</th>
                                        <th style="width:20%">Amount</th>
                                    </tr>
                                    </thead>
                                    <tbody id="previewLineItems"></tbody>
                                </table>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div id="previewNotes"><h5>Notes:</h5>
                                        <p>Thank you for your business!</p></div>
                                    <div id="previewPaymentMethod" style="display:none;"><h5>Payment Method:</h5>
                                        <p id="previewPaymentDetails">Please make payment to the bank account details
                                            below.</p></div>
                                    <div id="qrCode" style="display:none;"></div>
                                    <div id="previewSignature" style="display:none;"><h5>Signature:</h5>
                                        <div id="signatureImage" class="mt-2"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-borderless text-end">
                                        <tbody>
                                        <tr>
                                            <td>Subtotal:</td>
                                            <td id="previewSubtotal">$0.00</td>
                                        </tr>
                                        <tr id="previewTaxRow">
                                            <td>Tax:</td>
                                            <td id="previewTax">$0.00</td>
                                        </tr>
                                        <tr id="previewDiscountRow">
                                            <td>Discount:</td>
                                            <td id="previewDiscount">$0.00</td>
                                        </tr>
                                        <tr id="previewShippingRow" style="display:none;">
                                            <td>Shipping:</td>
                                            <td id="previewShipping">$0.00</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Total:</strong></td>
                                            <td><strong id="previewTotal">$0.00</strong></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="text-center mt-5 pt-3 text-muted" id="branding"><small>Created with Invoice Generator</small></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="toast-container"></div>
    <div class="modal fade" id="savedInvoicesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Manage Invoices</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><input type="text" class="form-control" id="filterInput"
                                             placeholder="Search invoices..."></div>
                    <ul class="nav nav-tabs mb-3" id="invoicesTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="recent-tab" data-bs-toggle="tab"
                                    data-bs-target="#recent" type="button" role="tab">Recent
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="all-tab" data-bs-toggle="tab" data-bs-target="#all"
                                    type="button" role="tab">All Invoices
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="invoicesTabContent">
                        <div class="tab-pane fade show active" id="recent" role="tabpanel">
                            <div class="list-group" id="recentInvoicesList"></div>
                        </div>
                        <div class="tab-pane fade" id="all" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Client</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Actions</th>
                                    </tr>
                                    </thead>
                                    <tbody id="savedInvoicesList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger me-auto" id="clearAllInvoices">Clear All
                        Invoices
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="catalogItemModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="catalogItemModalTitle">Add Catalog Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><label for="catalogItemName" class="form-label">Item Name</label><input
                            type="text" class="form-control" id="catalogItemName" required></div>
                    <div class="mb-3"><label for="catalogItemDescription"
                                             class="form-label">Description</label><textarea class="form-control"
                                                                                             id="catalogItemDescription"
                                                                                             rows="2"></textarea></div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label for="catalogItemRate" class="form-label">Rate</label>
                            <div class="input-group"><span class="input-group-text">$</span><input type="number"
                                                                                                   class="form-control"
                                                                                                   id="catalogItemRate"
                                                                                                   min="0" step="0.01"
                                                                                                   required></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveCatalogItem">Save Item</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="emailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Send Invoice via Email</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info" role="alert">This is a demo feature. In a real application, this would
                        send the invoice via email.
                    </div>
                    <div class="mb-3"><label for="emailTo" class="form-label">To</label><input type="email"
                                                                                               class="form-control"
                                                                                               id="emailTo"></div>
                    <div class="mb-3"><label for="emailSubject" class="form-label">Subject</label><input type="text"
                                                                                                         class="form-control"
                                                                                                         id="emailSubject"
                                                                                                         value="Invoice from Your Business">
                    </div>
                    <div class="mb-3"><label for="emailBody" class="form-label">Message</label><textarea
                            class="form-control" id="emailBody" rows="4">Dear client,

Please find attached the invoice for your recent purchase.
Thank you for your business.

Regards,
Your Business</textarea></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="sendEmailBtn">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>document.addEventListener('DOMContentLoaded', function () {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
    const businessNameInput = document.getElementById('businessName');
    const businessAddressInput = document.getElementById('businessAddress');
    const businessPhoneInput = document.getElementById('businessPhone');
    const businessEmailInput = document.getElementById('businessEmail');
    const businessLogoInput = document.getElementById('businessLogo');
    const uploadLogoBtn = document.getElementById('uploadLogoBtn');
    const logoFileInput = document.getElementById('logoFileInput');
    const logoPreview = document.getElementById('logoPreview');
    const logoPreviewImg = document.getElementById('logoPreviewImg');
    const removeLogo = document.getElementById('removeLogo');
    const clientNameInput = document.getElementById('clientName');
    const clientAddressInput = document.getElementById('clientAddress');
    const clientPhoneInput = document.getElementById('clientPhone');
    const clientEmailInput = document.getElementById('clientEmail');
    const saveClientCheck = document.getElementById('saveClientCheck');
    const savedClientsList = document.getElementById('savedClientsList');
    const invoiceNumberInput = document.getElementById('invoiceNumber');
    const generateInvoiceNumberBtn = document.getElementById('generateInvoiceNumber');
    const invoiceDateInput = document.getElementById('invoiceDate');
    const invoiceDueDateInput = document.getElementById('invoiceDueDate');
    const paymentTermsSelect = document.getElementById('paymentTerms');
    const lineItemsBody = document.getElementById('lineItemsBody');
    const addLineItemBtn = document.getElementById('addLineItem');
    const notesInput = document.getElementById('notes');
    const currencySelect = document.getElementById('currency');
    const taxRateInput = document.getElementById('taxRate');
    const discountTypeSelect = document.getElementById('discountType');
    const discountInput = document.getElementById('discount');
    const discountSymbol = document.getElementById('discountSymbol');
    const shippingInput = document.getElementById('shipping');
    const paymentMethodSelect = document.getElementById('paymentMethod');
    const paymentDetailsContainer = document.getElementById('paymentDetailsContainer');
    const paymentDetailsInput = document.getElementById('paymentDetails');
    const showQrCodeCheck = document.getElementById('showQrCode');
    const updateTotalsBtn = document.getElementById('updateTotals');
    const templatePreviewElements = document.querySelectorAll('.template-preview');
    const showSignatureCheck = document.getElementById('showSignature');
    const signatureContainer = document.getElementById('signatureContainer');
    const showBrandingCheck = document.getElementById('showBrandingCheck');
    const customCssInput = document.getElementById('customCss');
    const toggleCatalogBtn = document.getElementById('toggleCatalog');
    const catalogContainer = document.getElementById('catalogContainer');
    const catalogItems = document.getElementById('catalogItems');
    const addToCatalogBtn = document.getElementById('addToCatalog');
    const saveInvoiceBtn = document.getElementById('saveInvoice');
    const loadInvoiceBtn = document.getElementById('loadInvoice');
    const duplicateInvoiceBtn = document.getElementById('duplicateInvoice');
    const clearInvoiceBtn = document.getElementById('clearInvoice');
    const printInvoiceBtn = document.getElementById('printInvoice');
    const downloadPdfBtn = document.getElementById('downloadPdf');
    const downloadJsonBtn = document.getElementById('downloadJson');
    const sendEmailBtn = document.getElementById('sendEmail');
    const previewToggle = document.getElementById('previewToggle');
    const previewToggleText = document.getElementById('previewToggleText');
    const savedInvoicesModal = new bootstrap.Modal(document.getElementById('savedInvoicesModal'));
    const catalogItemModal = new bootstrap.Modal(document.getElementById('catalogItemModal'));
    const emailModal = new bootstrap.Modal(document.getElementById('emailModal'));
    const recentInvoicesList = document.getElementById('recentInvoicesList');
    const savedInvoicesList = document.getElementById('savedInvoicesList');
    const filterInput = document.getElementById('filterInput');
    const clearAllInvoicesBtn = document.getElementById('clearAllInvoices');
    const catalogItemNameInput = document.getElementById('catalogItemName');
    const catalogItemDescriptionInput = document.getElementById('catalogItemDescription');
    const catalogItemRateInput = document.getElementById('catalogItemRate');
    const saveCatalogItemBtn = document.getElementById('saveCatalogItem');
    const emailToInput = document.getElementById('emailTo');
    const emailSubjectInput = document.getElementById('emailSubject');
    const emailBodyInput = document.getElementById('emailBody');
    const sendEmailRealBtn = document.getElementById('sendEmailBtn');
    const previewLogo = document.getElementById('previewLogo');
    const previewBusinessName = document.getElementById('previewBusinessName');
    const previewBusinessAddress = document.getElementById('previewBusinessAddress');
    const previewBusinessPhone = document.getElementById('previewBusinessPhone');
    const previewBusinessEmail = document.getElementById('previewBusinessEmail');
    const previewClientName = document.getElementById('previewClientName');
    const previewClientAddress = document.getElementById('previewClientAddress');
    const previewClientPhone = document.getElementById('previewClientPhone');
    const previewClientEmail = document.getElementById('previewClientEmail');
    const previewInvoiceNumber = document.getElementById('previewInvoiceNumber');
    const previewInvoiceDate = document.getElementById('previewInvoiceDate');
    const previewDueDate = document.getElementById('previewDueDate');
    const previewLineItems = document.getElementById('previewLineItems');
    const previewNotes = document.getElementById('previewNotes');
    const previewSubtotal = document.getElementById('previewSubtotal');
    const previewTax = document.getElementById('previewTax');
    const previewDiscount = document.getElementById('previewDiscount');
    const previewShipping = document.getElementById('previewShipping');
    const previewShippingRow = document.getElementById('previewShippingRow');
    const previewTotal = document.getElementById('previewTotal');
    const previewPaymentMethod = document.getElementById('previewPaymentMethod');
    const previewPaymentDetails = document.getElementById('previewPaymentDetails');
    const previewSignature = document.getElementById('previewSignature');
    const signatureImage = document.getElementById('signatureImage');
    const qrCodeContainer = document.getElementById('qrCode');
    const previewContainer = document.getElementById('previewContainer');
    const branding = document.getElementById('branding');
    const autoSaveSwitch = document.getElementById('autoSaveSwitch');
    const autosaveIndicator = document.getElementById('autosaveIndicator');
    const autosaveIndicatorDot = autosaveIndicator.querySelector('.autosave-indicator');
    const signatureCanvas = document.getElementById('signatureCanvas');
    const clearSignatureBtn = document.getElementById('clearSignature');
    const saveSignatureBtn = document.getElementById('saveSignature');
    let signaturePad = new SignaturePad(signatureCanvas, {
        minWidth: 1,
        maxWidth: 3,
        backgroundColor: 'rgba(255,255,255,0)'
    });
    let invoiceData = {
        business: {name: "", address: "", phone: "", email: "", logoUrl: "", logoData: ""},
        client: {name: "", address: "", email: "", phone: ""},
        info: {
            number: generateInvoiceNumber(),
            date: new Date().toISOString().split('T')[0],
            dueDate: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            terms: "net_30"
        },
        items: [],
        subtotal: 0,
        taxRate: 0,
        taxAmount: 0,
        discount: 0,
        discountType: "fixed",
        shipping: 0,
        total: 0,
        notes: "",
        currency: "USD",
        paymentMethod: "",
        paymentDetails: "",
        template: "classic",
        signature: "",
        showBranding: true,
        showQrCode: false,
        customCss: ""
    };
    let currentEditingItem = null;
    let isAutoSaving = false;
    let autoSaveTimeout = null;
    let lastSavedData = JSON.stringify(invoiceData);
    invoiceNumberInput.value = invoiceData.info.number;
    invoiceDateInput.value = invoiceData.info.date;
    invoiceDueDateInput.value = invoiceData.info.dueDate;
    loadCatalogItems();
    addLineItem();
    [businessNameInput, businessAddressInput, businessPhoneInput, businessEmailInput, businessLogoInput].forEach(el => {
        el.addEventListener('input', function () {
            updateInvoiceData();
            updatePreview();
            scheduleAutoSave();
        });
    });
    [clientNameInput, clientAddressInput, clientPhoneInput, clientEmailInput].forEach(el => {
        el.addEventListener('input', function () {
            updateInvoiceData();
            updatePreview();
            scheduleAutoSave();
        });
    });
    [invoiceNumberInput, invoiceDateInput, invoiceDueDateInput, notesInput].forEach(el => {
        el.addEventListener('input', function () {
            updateInvoiceData();
            updatePreview();
            scheduleAutoSave();
        });
    });
    [taxRateInput, discountTypeSelect, discountInput, shippingInput, currencySelect, paymentMethodSelect, paymentDetailsInput, showQrCodeCheck].forEach(el => {
        el.addEventListener('input', function () {
            updateInvoiceData();
            calculateTotals();
            updatePreview();
            scheduleAutoSave();
        });
        el.addEventListener('change', function () {
            updateInvoiceData();
            calculateTotals();
            updatePreview();
            scheduleAutoSave();
        });
    });
    [showSignatureCheck, showBrandingCheck, customCssInput].forEach(el => {
        el.addEventListener('change', function () {
            updateInvoiceData();
            updatePreview();
            scheduleAutoSave();
        });
        el.addEventListener('input', function () {
            updateInvoiceData();
            updatePreview();
            scheduleAutoSave();
        });
    });
    addLineItemBtn.addEventListener('click', () => addLineItem());
    updateTotalsBtn.addEventListener('click', calculateTotals);
    saveInvoiceBtn.addEventListener('click', saveInvoice);
    loadInvoiceBtn.addEventListener('click', openManageInvoicesModal);
    duplicateInvoiceBtn.addEventListener('click', duplicateInvoice);
    clearInvoiceBtn.addEventListener('click', clearInvoice);
    printInvoiceBtn.addEventListener('click', () => window.print());
    downloadPdfBtn.addEventListener('click', downloadPdf);
    downloadJsonBtn.addEventListener('click', downloadJson);
    sendEmailBtn.addEventListener('click', showEmailModal);
    previewToggle.addEventListener('click', togglePreview);
    generateInvoiceNumberBtn.addEventListener('click', () => {
        invoiceNumberInput.value = generateInvoiceNumber();
        updateInvoiceData();
        updatePreview();
        scheduleAutoSave();
    });
    uploadLogoBtn.addEventListener('click', () => logoFileInput.click());
    logoFileInput.addEventListener('change', handleLogoUpload);
    removeLogo.addEventListener('click', removeBrandLogo);
    clearAllInvoicesBtn.addEventListener('click', clearAllInvoices);
    clearSignatureBtn.addEventListener('click', clearSignature);
    saveSignatureBtn.addEventListener('click', saveSignature);
    paymentTermsSelect.addEventListener('change', updateDueDateFromTerms);
    toggleCatalogBtn.addEventListener('click', toggleCatalog);
    addToCatalogBtn.addEventListener('click', showAddCatalogItemModal);
    saveCatalogItemBtn.addEventListener('click', saveCatalogItem);
    sendEmailRealBtn.addEventListener('click', sendInvoiceEmail);
    discountTypeSelect.addEventListener('change', updateDiscountSymbol);
    filterInput.addEventListener('input', filterInvoices);
    autoSaveSwitch.addEventListener('change', toggleAutoSave);
    templatePreviewElements.forEach(template => {
        template.addEventListener('click', function () {
            templatePreviewElements.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            const templateName = this.dataset.template;
            invoiceData.template = templateName;
            document.getElementById('preview').className = '';
            document.getElementById('preview').classList.add(`template-${templateName}`);
            updateInvoiceData();
            updatePreview();
            scheduleAutoSave();
        });
    });
    paymentMethodSelect.addEventListener('change', function () {
        const selectedMethod = this.value;
        if (selectedMethod) {
            paymentDetailsContainer.style.display = 'block';
            switch (selectedMethod) {
                case'bank':
                    paymentDetailsInput.value = 'Bank Name: [Your Bank]\nAccount Name: [Your Name]\nAccount Number: [Your Account]\nRouting Number: [Routing Number]';
                    break;
                case'paypal':
                    paymentDetailsInput.value = 'Please make payment to our PayPal account: [your.email@example.com]';
                    break;
                case'card':
                    paymentDetailsInput.value = 'We will send you a secure payment link separately.';
                    break;
                case'custom':
                    paymentDetailsInput.value = '';
                    break;
            }
            previewPaymentMethod.style.display = 'block';
        } else {
            paymentDetailsContainer.style.display = 'none';
            paymentDetailsInput.value = '';
            previewPaymentMethod.style.display = 'none';
        }
        updateInvoiceData();
        updatePreview();
        scheduleAutoSave();
    });
    showSignatureCheck.addEventListener('change', function () {
        if (this.checked) {
            signatureContainer.style.display = 'block';
            previewSignature.style.display = 'block';
            if (window.innerWidth < 768) {
                document.getElementById('template-tab').click();
                setTimeout(() => {
                    resizeSignaturePad();
                }, 100);
            }
        } else {
            signatureContainer.style.display = 'none';
            previewSignature.style.display = 'none';
        }
        updateInvoiceData();
        updatePreview();
        scheduleAutoSave();
    });
    showQrCodeCheck.addEventListener('change', function () {
        if (this.checked) {
            generateQRCode();
            qrCodeContainer.style.display = 'flex';
        } else {
            qrCodeContainer.style.display = 'none';
        }
        updateInvoiceData();
        updatePreview();
        scheduleAutoSave();
    });
    showBrandingCheck.addEventListener('change', function () {
        branding.style.display = this.checked ? 'block' : 'none';
        updateInvoiceData();
        updatePreview();
        scheduleAutoSave();
    });

    function generateInvoiceNumber() {
        const date = new Date();
        const year = date.getFullYear().toString().substr(-2);
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        return `INV-${year}${month}-${random}`;
    }

    function addLineItem(item = {description: '', quantity: 1, rate: 0, amount: 0}) {
        const rowIndex = lineItemsBody.children.length;
        const row = document.createElement('tr');
        row.className = 'line-item-row';
        row.innerHTML = `<td><input type="text" class="form-control item-description" data-index="${rowIndex}" value="${item.description || ''}"></td><td><input type="number" class="form-control item-quantity" data-index="${rowIndex}" min="1" step="1" value="${item.quantity || 1}"></td><td><div class="input-group"><span class="input-group-text">${getCurrencySymbol()}</span><input type="number" class="form-control item-rate" data-index="${rowIndex}" min="0" step="0.01" value="${item.rate || 0}"></div></td><td><div class="input-group"><span class="input-group-text">${getCurrencySymbol()}</span><input type="number" class="form-control item-amount" data-index="${rowIndex}" value="${item.amount || 0}" readonly></div></td><td><i class="fas fa-times delete-line-item" data-index="${rowIndex}"></i></td>`;
        lineItemsBody.appendChild(row);
        const descInput = row.querySelector('.item-description');
        const qtyInput = row.querySelector('.item-quantity');
        const rateInput = row.querySelector('.item-rate');
        const deleteBtn = row.querySelector('.delete-line-item');
        [descInput, qtyInput, rateInput].forEach(el => el.addEventListener('input', updateLineItem));
        deleteBtn.addEventListener('click', deleteLineItem);
        if (!item.amount) item.amount = item.quantity * item.rate;
        invoiceData.items.push(item);
        updatePreview();
        scheduleAutoSave();
    }

    function updateLineItem(e) {
        const index = parseInt(e.target.dataset.index);
        const row = e.target.closest('tr');
        const description = row.querySelector('.item-description').value;
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
        const amount = quantity * rate;
        row.querySelector('.item-amount').value = amount.toFixed(2);
        invoiceData.items[index] = {description, quantity, rate, amount};
        calculateTotals();
        updatePreview();
        scheduleAutoSave();
    }

    function deleteLineItem(e) {
        const index = parseInt(e.target.dataset.index);
        e.target.closest('tr').remove();
        invoiceData.items.splice(index, 1);
        document.querySelectorAll('#lineItemsBody tr').forEach((row, i) => {
            row.querySelectorAll('[data-index]').forEach(el => {
                el.dataset.index = i.toString();
            });
        });
        calculateTotals();
        updatePreview();
        scheduleAutoSave();
    }

    function calculateTotals() {
        let subtotal = invoiceData.items.reduce((sum, item) => sum + item.amount, 0);
        const taxRate = parseFloat(taxRateInput.value) || 0;
        const discountType = discountTypeSelect.value;
        const discountValue = parseFloat(discountInput.value) || 0;
        const shipping = parseFloat(shippingInput.value) || 0;
        const taxAmount = subtotal * (taxRate / 100);
        let discountAmount = discountType === 'percentage' ? subtotal * (discountValue / 100) : discountValue;
        const total = subtotal + taxAmount - discountAmount + shipping;
        invoiceData.subtotal = subtotal;
        invoiceData.taxRate = taxRate;
        invoiceData.taxAmount = taxAmount;
        invoiceData.discount = discountValue;
        invoiceData.discountType = discountType;
        invoiceData.shipping = shipping;
        invoiceData.total = total;
        const currencySymbol = getCurrencySymbol();
        previewSubtotal.textContent = formatCurrency(subtotal);
        previewTax.textContent = formatCurrency(taxAmount);
        if (taxRate > 0) {
            document.getElementById('previewTaxRow').style.display = '';
        } else {
            document.getElementById('previewTaxRow').style.display = 'none';
        }
        if (discountValue > 0) {
            document.getElementById('previewDiscountRow').style.display = '';
            previewDiscount.textContent = discountType === 'percentage' ? `${discountValue}% (${formatCurrency(discountAmount)})` : formatCurrency(discountAmount);
        } else {
            document.getElementById('previewDiscountRow').style.display = 'none';
        }
        if (shipping > 0) {
            previewShippingRow.style.display = '';
            previewShipping.textContent = formatCurrency(shipping);
        } else {
            previewShippingRow.style.display = 'none';
        }
        previewTotal.textContent = formatCurrency(total);
        if (invoiceData.showQrCode) {
            generateQRCode();
        }
        scheduleAutoSave();
    }

    function updateInvoiceData() {
        invoiceData.business.name = businessNameInput.value;
        invoiceData.business.address = businessAddressInput.value;
        invoiceData.business.phone = businessPhoneInput.value;
        invoiceData.business.email = businessEmailInput.value;
        invoiceData.business.logoUrl = businessLogoInput.value;
        invoiceData.client.name = clientNameInput.value;
        invoiceData.client.address = clientAddressInput.value;
        invoiceData.client.phone = clientPhoneInput.value;
        invoiceData.client.email = clientEmailInput.value;
        invoiceData.info.number = invoiceNumberInput.value;
        invoiceData.info.date = invoiceDateInput.value;
        invoiceData.info.dueDate = invoiceDueDateInput.value;
        invoiceData.info.terms = paymentTermsSelect.value;
        invoiceData.notes = notesInput.value;
        invoiceData.currency = currencySelect.value;
        invoiceData.taxRate = parseFloat(taxRateInput.value) || 0;
        invoiceData.discountType = discountTypeSelect.value;
        invoiceData.discount = parseFloat(discountInput.value) || 0;
        invoiceData.shipping = parseFloat(shippingInput.value) || 0;
        invoiceData.paymentMethod = paymentMethodSelect.value;
        invoiceData.paymentDetails = paymentDetailsInput.value;
        invoiceData.showSignature = showSignatureCheck.checked;
        invoiceData.showQrCode = showQrCodeCheck.checked;
        invoiceData.showBranding = showBrandingCheck.checked;
        invoiceData.customCss = customCssInput.value;
    }

    function updatePreview() {
        document.getElementById('preview').className = '';
        document.getElementById('preview').classList.add(`template-${invoiceData.template}`);
        applyCustomCSS();
        previewBusinessName.textContent = invoiceData.business.name || 'Your Business Name';
        previewBusinessAddress.textContent = invoiceData.business.address || 'Business Address';
        previewBusinessPhone.textContent = invoiceData.business.phone ? `Phone: ${invoiceData.business.phone}` : 'Phone: -';
        previewBusinessEmail.textContent = invoiceData.business.email || 'email@business.com';
        if (invoiceData.business.logoData) {
            previewLogo.innerHTML = `<img src="${invoiceData.business.logoData}" alt="Business Logo">`;
            logoPreview.style.display = 'block';
            logoPreviewImg.src = invoiceData.business.logoData;
        } else if (invoiceData.business.logoUrl) {
            previewLogo.innerHTML = `<img src="${invoiceData.business.logoUrl}" alt="Business Logo">`;
            logoPreview.style.display = 'none';
        } else {
            previewLogo.innerHTML = '';
            logoPreview.style.display = 'none';
        }
        previewClientName.textContent = invoiceData.client.name || 'Client Name';
        previewClientAddress.textContent = invoiceData.client.address || 'Client Address';
        previewClientPhone.textContent = invoiceData.client.phone ? `Phone: ${invoiceData.client.phone}` : 'Phone: -';
        previewClientEmail.textContent = invoiceData.client.email || 'client@email.com';
        previewInvoiceNumber.textContent = `#${invoiceData.info.number}` || '#INV-0001';
        previewInvoiceDate.textContent = formatDate(invoiceData.info.date) || 'January 1, 2023';
        previewDueDate.textContent = formatDate(invoiceData.info.dueDate) || 'January 15, 2023';
        previewNotes.innerHTML = `<h5>Notes:</h5><p>${invoiceData.notes || 'Thank you for your business!'}</p>`;
        if (invoiceData.paymentMethod) {
            previewPaymentMethod.style.display = 'block';
            previewPaymentDetails.textContent = invoiceData.paymentDetails || 'Please make payment to the account details provided.';
        } else {
            previewPaymentMethod.style.display = 'none';
        }
        if (invoiceData.showSignature) {
            previewSignature.style.display = 'block';
            if (invoiceData.signature) {
                signatureImage.innerHTML = `<img src="${invoiceData.signature}" alt="Signature" style="max-width:100%;max-height:100px;">`;
            }
        } else {
            previewSignature.style.display = 'none';
        }
        if (invoiceData.showQrCode) {
            qrCodeContainer.style.display = 'flex';
            generateQRCode();
        } else {
            qrCodeContainer.style.display = 'none';
        }
        branding.style.display = invoiceData.showBranding ? 'block' : 'none';
        updateLineItemsPreview();
        updateCurrencySymbols();
    }

    function updateLineItemsPreview() {
        previewLineItems.innerHTML = '';
        if (invoiceData.items.length === 0) {
            previewLineItems.innerHTML = '<tr><td colspan="4" class="text-center">No items added</td></tr>';
            return;
        }
        invoiceData.items.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${item.description || 'Item description'}</td><td>${item.quantity}</td><td>${formatCurrency(item.rate)}</td><td>${formatCurrency(item.amount)}</td>`;
            previewLineItems.appendChild(row);
        });
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {style: 'currency', currency: invoiceData.currency}).format(amount);
    }

    function getCurrencySymbol() {
        const currency = invoiceData.currency;
        switch (currency) {
            case'USD':
                return '$';
            case'EUR':
                return 'â‚¬';
            case'GBP':
                return 'Â£';
            case'JPY':
                return 'Â¥';
            case'INR':
                return 'â‚¹';
            case'CAD':
                return 'C$';
            case'AUD':
                return 'A$';
            case'CNY':
                return 'Â¥';
            default:
                return '$';
        }
    }

    function updateCurrencySymbols() {
        const currencySymbol = getCurrencySymbol();
        document.querySelectorAll('.input-group-text').forEach(span => {
            if (span.id !== 'discountSymbol' || discountTypeSelect.value === 'fixed') {
                span.textContent = currencySymbol;
            }
        });
    }

    function updateDiscountSymbol() {
        discountSymbol.textContent = discountTypeSelect.value === 'percentage' ? '%' : getCurrencySymbol();
        calculateTotals();
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return new Intl.DateTimeFormat('en-US', {year: 'numeric', month: 'long', day: 'numeric'}).format(date);
    }

    function saveInvoice() {
        updateInvoiceData();
        const savedInvoices = JSON.parse(localStorage.getItem('invoices') || '{}');
        const invoiceId = invoiceData.info.number || generateInvoiceNumber();
        savedInvoices[invoiceId] = {data: JSON.parse(JSON.stringify(invoiceData)), timestamp: new Date().toISOString()};
        localStorage.setItem('invoices', JSON.stringify(savedInvoices));
        showToast('Invoice saved successfully', 'success');
        lastSavedData = JSON.stringify(invoiceData);
        return invoiceId;
    }

    function openManageInvoicesModal() {
        const savedInvoices = JSON.parse(localStorage.getItem('invoices') || '{}');
        renderSavedInvoices(savedInvoices);
        savedInvoicesModal.show();
    }

    function renderSavedInvoices(savedInvoices) {
        recentInvoicesList.innerHTML = '';
        savedInvoicesList.innerHTML = '';
        if (Object.keys(savedInvoices).length === 0) {
            recentInvoicesList.innerHTML = '<div class="list-group-item">No saved invoices found</div>';
            savedInvoicesList.innerHTML = '<tr><td colspan="5" class="text-center">No saved invoices found</td></tr>';
        } else {
            const sortedInvoices = Object.entries(savedInvoices).sort((a, b) => {
                return new Date(b[1].timestamp) - new Date(a[1].timestamp);
            });
            sortedInvoices.slice(0, 5).forEach(([id, invoice]) => {
                const date = new Date(invoice.timestamp);
                const formattedDate = new Intl.DateTimeFormat('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }).format(date);
                const clientName = invoice.data.client.name || 'Unnamed Client';
                const total = invoice.data.total || 0;
                const item = document.createElement('div');
                item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                item.innerHTML = `<div><strong>#${id}</strong> - ${clientName}<br><small class="text-muted">${formattedDate}</small></div><div><span class="badge bg-primary rounded-pill me-2">${formatCurrencySimple(total, invoice.data.currency)}</span><button class="btn btn-sm btn-outline-primary load-invoice-btn" data-id="${id}">Load</button></div>`;
                recentInvoicesList.appendChild(item);
            });
            sortedInvoices.forEach(([id, invoice]) => {
                const date = new Date(invoice.timestamp);
                const formattedDate = new Intl.DateTimeFormat('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }).format(date);
                const clientName = invoice.data.client.name || 'Unnamed Client';
                const total = invoice.data.total || 0;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>#${id}</td><td>${clientName}</td><td>${formattedDate}</td><td>${formatCurrencySimple(total, invoice.data.currency)}</td><td><div class="btn-group btn-group-sm"><button class="btn btn-outline-primary load-invoice-btn" data-id="${id}">Load</button><button class="btn btn-outline-danger delete-invoice-btn" data-id="${id}"><i class="fas fa-trash-alt"></i></button></div></td>`;
                savedInvoicesList.appendChild(tr);
            });
        }
        document.querySelectorAll('.load-invoice-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                loadInvoice(this.dataset.id);
                savedInvoicesModal.hide();
            });
        });
        document.querySelectorAll('.delete-invoice-btn').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.stopPropagation();
                if (confirm(`Are you sure you want to delete invoice #${this.dataset.id}?`)) {
                    deleteInvoice(this.dataset.id);
                    renderSavedInvoices(JSON.parse(localStorage.getItem('invoices') || '{}'));
                }
            });
        });
        filterInput.value = '';
        setTimeout(() => filterInput.focus(), 300);
    }

    function formatCurrencySimple(amount, currency) {
        const symbols = {USD: '$', EUR: 'â‚¬', GBP: 'Â£', JPY: 'Â¥', INR: 'â‚¹', CAD: 'C$', AUD: 'A$', CNY: 'Â¥'};
        const symbol = symbols[currency] || '$';
        return `${symbol}${amount.toFixed(2)}`;
    }

    function loadInvoice(invoiceId) {
        const savedInvoices = JSON.parse(localStorage.getItem('invoices') || '{}');
        if (savedInvoices[invoiceId]) {
            invoiceData = JSON.parse(JSON.stringify(savedInvoices[invoiceId].data));
            businessNameInput.value = invoiceData.business.name || '';
            businessAddressInput.value = invoiceData.business.address || '';
            businessPhoneInput.value = invoiceData.business.phone || '';
            businessEmailInput.value = invoiceData.business.email || '';
            businessLogoInput.value = invoiceData.business.logoUrl || '';
            clientNameInput.value = invoiceData.client.name || '';
            clientAddressInput.value = invoiceData.client.address || '';
            clientPhoneInput.value = invoiceData.client.phone || '';
            clientEmailInput.value = invoiceData.client.email || '';
            invoiceNumberInput.value = invoiceData.info.number || '';
            invoiceDateInput.value = invoiceData.info.date || '';
            invoiceDueDateInput.value = invoiceData.info.dueDate || '';
            paymentTermsSelect.value = invoiceData.info.terms || 'net_30';
            taxRateInput.value = invoiceData.taxRate || 0;
            discountTypeSelect.value = invoiceData.discountType || 'fixed';
            discountInput.value = invoiceData.discount || 0;
            shippingInput.value = invoiceData.shipping || 0;
            currencySelect.value = invoiceData.currency || 'USD';
            notesInput.value = invoiceData.notes || '';
            paymentMethodSelect.value = invoiceData.paymentMethod || '';
            paymentDetailsInput.value = invoiceData.paymentDetails || '';
            if (invoiceData.paymentMethod) {
                paymentDetailsContainer.style.display = 'block';
            } else {
                paymentDetailsContainer.style.display = 'none';
            }
            templatePreviewElements.forEach(t => t.classList.remove('active'));
            document.querySelector(`.template-preview[data-template="${invoiceData.template || 'classic'}"]`).classList.add('active');
            showSignatureCheck.checked = invoiceData.showSignature || false;
            showBrandingCheck.checked = invoiceData.showBranding !== undefined ? invoiceData.showBranding : true;
            showQrCodeCheck.checked = invoiceData.showQrCode || false;
            if (invoiceData.showSignature) {
                signatureContainer.style.display = 'block';
            } else {
                signatureContainer.style.display = 'none';
            }
            if (invoiceData.signature) {
                signaturePad.fromDataURL(invoiceData.signature);
            } else {
                signaturePad.clear();
            }
            customCssInput.value = invoiceData.customCss || '';
            lineItemsBody.innerHTML = '';
            if (invoiceData.items && invoiceData.items.length > 0) {
                invoiceData.items.forEach(item => addLineItem(item));
            } else {
                addLineItem();
            }
            if (invoiceData.business.logoData) {
                logoPreview.style.display = 'block';
                logoPreviewImg.src = invoiceData.business.logoData;
            } else {
                logoPreview.style.display = 'none';
            }
            updateDiscountSymbol();
            updatePreview();
            showToast(`Invoice #${invoiceId} loaded successfully`, 'success');
            lastSavedData = JSON.stringify(invoiceData);
        } else {
            showToast('Invoice not found', 'error');
        }
    }

    function deleteInvoice(invoiceId) {
        const savedInvoices = JSON.parse(localStorage.getItem('invoices') || '{}');
        if (savedInvoices[invoiceId]) {
            delete savedInvoices[invoiceId];
            localStorage.setItem('invoices', JSON.stringify(savedInvoices));
            showToast(`Invoice #${invoiceId} deleted`, 'success');
            return true;
        }
        return false;
    }

    function duplicateInvoice() {
        updateInvoiceData();
        const newInvoiceNumber = generateInvoiceNumber();
        invoiceData.info.number = newInvoiceNumber;
        invoiceNumberInput.value = newInvoiceNumber;
        const savedId = saveInvoice();
        showToast(`Invoice duplicated with new number #${savedId}`, 'success');
    }

    function clearInvoice() {
        if (confirm('Are you sure you want to clear this invoice? All unsaved changes will be lost.')) {
            invoiceData = {
                business: {name: "", address: "", phone: "", email: "", logoUrl: "", logoData: ""},
                client: {name: "", address: "", email: "", phone: ""},
                info: {
                    number: generateInvoiceNumber(),
                    date: new Date().toISOString().split('T')[0],
                    dueDate: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    terms: "net_30"
                },
                items: [],
                subtotal: 0,
                taxRate: 0,
                taxAmount: 0,
                discount: 0,
                discountType: "fixed",
                shipping: 0,
                total: 0,
                notes: "",
                currency: "USD",
                paymentMethod: "",
                paymentDetails: "",
                template: "classic",
                signature: "",
                showBranding: true,
                showQrCode: false,
                customCss: ""
            };
            businessNameInput.value = '';
            businessAddressInput.value = '';
            businessPhoneInput.value = '';
            businessEmailInput.value = '';
            businessLogoInput.value = '';
            clientNameInput.value = '';
            clientAddressInput.value = '';
            clientPhoneInput.value = '';
            clientEmailInput.value = '';
            invoiceNumberInput.value = invoiceData.info.number;
            invoiceDateInput.value = invoiceData.info.date;
            invoiceDueDateInput.value = invoiceData.info.dueDate;
            paymentTermsSelect.value = 'net_30';
            taxRateInput.value = 0;
            discountTypeSelect.value = 'fixed';
            discountInput.value = 0;
            shippingInput.value = 0;
            currencySelect.value = 'USD';
            notesInput.value = '';
            paymentMethodSelect.value = '';
            paymentDetailsInput.value = '';
            paymentDetailsContainer.style.display = 'none';
            showSignatureCheck.checked = false;
            signatureContainer.style.display = 'none';
            signaturePad.clear();
            showBrandingCheck.checked = true;
            showQrCodeCheck.checked = false;
            qrCodeContainer.style.display = 'none';
            customCssInput.value = '';
            templatePreviewElements.forEach(t => t.classList.remove('active'));
            document.querySelector('.template-preview[data-template="classic"]').classList.add('active');
            logoPreview.style.display = 'none';
            lineItemsBody.innerHTML = '';
            addLineItem();
            updatePreview();
            showToast('Invoice cleared', 'info');
            lastSavedData = JSON.stringify(invoiceData);
        }
    }

    function clearAllInvoices() {
        if (confirm('Are you sure you want to delete ALL saved invoices? This action cannot be undone.')) {
            localStorage.removeItem('invoices');
            renderSavedInvoices({});
            showToast('All invoices deleted', 'success');
        }
    }

    function downloadPdf() {
        const {jsPDF} = window.jspdf;
        showToast('Generating PDF...', 'info');
        const wasHidden = previewContainer.style.display === 'none';
        if (wasHidden) {
            previewContainer.style.display = 'block';
        }
        const userCSS = document.getElementById('userCustomCSS');
        let oldUserCSS = null;
        if (userCSS) {
            oldUserCSS = userCSS.innerText;
            userCSS.remove();
        }
        const doc = new jsPDF({orientation: 'portrait', unit: 'mm', format: 'a4'});
        const element = document.getElementById('preview');
        const pdfName = `Invoice-${invoiceData.info.number || 'unknown'}.pdf`;
        html2canvas(element, {scale: 2, useCORS: true, logging: false, allowTaint: true}).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 210;
            const pageHeight = 297;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;
            doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                doc.addPage();
                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }
            doc.save(pdfName);
            showToast('PDF downloaded successfully', 'success');
            if (wasHidden) {
                previewContainer.style.display = 'none';
            }
            if (oldUserCSS) {
                const style = document.createElement('style');
                style.id = 'userCustomCSS';
                style.innerText = oldUserCSS;
                document.head.appendChild(style);
            }
        }).catch(error => {
            console.error('Error generating PDF:', error);
            showToast('Error generating PDF', 'error');
            if (wasHidden) {
                previewContainer.style.display = 'none';
            }
        });
    }

    function downloadJson() {
        updateInvoiceData();
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(invoiceData, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `invoice-${invoiceData.info.number || 'data'}.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        showToast('Invoice data downloaded as JSON', 'success');
    }

    function togglePreview() {
        if (previewContainer.style.display === 'none') {
            previewContainer.style.display = 'block';
            previewToggleText.textContent = 'Hide Preview';
        } else {
            previewContainer.style.display = 'none';
            previewToggleText.textContent = 'Show Preview';
        }
    }

    function handleLogoUpload(e) {
        const file = e.target.files[0];
        if (file) {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const dataUrl = e.target.result;
                    invoiceData.business.logoData = dataUrl;
                    invoiceData.business.logoUrl = '';
                    businessLogoInput.value = '';
                    logoPreview.style.display = 'block';
                    logoPreviewImg.src = dataUrl;
                    updatePreview();
                    scheduleAutoSave();
                };
                reader.readAsDataURL(file);
            } else {
                showToast('Please select an image file', 'error');
            }
        }
    }

    function removeBrandLogo() {
        invoiceData.business.logoData = '';
        logoPreview.style.display = 'none';
        updatePreview();
        scheduleAutoSave();
    }

    function updateDueDateFromTerms() {
        const selectedTerm = paymentTermsSelect.value;
        const invoiceDate = new Date(invoiceDateInput.value);
        let daysToAdd = 0;
        switch (selectedTerm) {
            case'due_on_receipt':
                daysToAdd = 0;
                break;
            case'net_15':
                daysToAdd = 15;
                break;
            case'net_30':
                daysToAdd = 30;
                break;
            case'net_60':
                daysToAdd = 60;
                break;
            default:
                daysToAdd = 30;
        }
        if (!isNaN(invoiceDate.getTime())) {
            invoiceDate.setDate(invoiceDate.getDate() + daysToAdd);
            const dueDateString = invoiceDate.toISOString().split('T')[0];
            invoiceDueDateInput.value = dueDateString;
            invoiceData.info.dueDate = dueDateString;
            updatePreview();
            scheduleAutoSave();
        }
    }

    function clearSignature() {
        signaturePad.clear();
        invoiceData.signature = '';
        signatureImage.innerHTML = '';
        scheduleAutoSave();
    }

    function saveSignature() {
        if (!signaturePad.isEmpty()) {
            const signatureData = signaturePad.toDataURL();
            invoiceData.signature = signatureData;
            signatureImage.innerHTML = `<img src="${signatureData}" alt="Signature" style="max-width:100%;max-height:100px;">`;
            updatePreview();
            scheduleAutoSave();
            showToast('Signature saved', 'success');
        }
    }

    function resizeSignaturePad() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        signatureCanvas.width = signatureCanvas.offsetWidth * ratio;
        signatureCanvas.height = signatureCanvas.offsetHeight * ratio;
        signatureCanvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear();
    }

    function generateQRCode() {
        if (!invoiceData.showQrCode) return;
        qrCodeContainer.innerHTML = '';
        const totalFormatted = formatCurrency(invoiceData.total);
        const qrData = `Invoice #${invoiceData.info.number}\nAmount: ${totalFormatted}\nFrom: ${invoiceData.business.name}\nTo: ${invoiceData.client.name}`;
        const qr = new QRious({element: document.createElement('canvas'), value: qrData, size: 120,});
        qrCodeContainer.appendChild(qr.element);
    }

    function toggleCatalog() {
        if (catalogContainer.style.display === 'none') {
            catalogContainer.style.display = 'block';
            toggleCatalogBtn.innerHTML = '<i class="fas fa-times"></i> Close Catalog';
        } else {
            catalogContainer.style.display = 'none';
            toggleCatalogBtn.innerHTML = '<i class="fas fa-book"></i> Catalog';
        }
    }

    function showAddCatalogItemModal() {
        currentEditingItem = null;
        catalogItemNameInput.value = '';
        catalogItemDescriptionInput.value = '';
        catalogItemRateInput.value = '';
        catalogItemModal.show();
        setTimeout(() => catalogItemNameInput.focus(), 300);
    }

    function saveCatalogItem() {
        const name = catalogItemNameInput.value.trim();
        const description = catalogItemDescriptionInput.value.trim();
        const rate = parseFloat(catalogItemRateInput.value) || 0;
        if (!name) {
            showToast('Please enter item name', 'error');
            return;
        }
        const catalogItem = {name, description, rate};
        let catalogItems = JSON.parse(localStorage.getItem('catalogItems') || '[]');
        if (currentEditingItem !== null) {
            catalogItems[currentEditingItem] = catalogItem;
        } else {
            catalogItems.push(catalogItem);
        }
        localStorage.setItem('catalogItems', JSON.stringify(catalogItems));
        loadCatalogItems();
        catalogItemModal.hide();
        showToast('Catalog item saved', 'success');
    }

    function loadCatalogItems() {
        const catalogItems = JSON.parse(localStorage.getItem('catalogItems') || '[]');
        document.getElementById('catalogItems').innerHTML = '';
        if (catalogItems.length === 0) {
            document.getElementById('catalogItems').innerHTML = '<div class="list-group-item">No catalog items found</div>';
            return;
        }
        catalogItems.forEach((item, index) => {
            const itemEl = document.createElement('div');
            itemEl.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center catalog-item';
            itemEl.innerHTML = `<div class="me-auto" data-index="${index}"><strong>${item.name}</strong><br><small>${item.description || ''}</small></div><div><span class="badge bg-primary rounded-pill me-2">${formatCurrencySimple(item.rate, 'USD')}</span><div class="btn-group btn-group-sm"><button class="btn btn-sm btn-outline-primary edit-catalog-item" data-index="${index}"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger delete-catalog-item" data-index="${index}"><i class="fas fa-trash-alt"></i></button></div></div>`;
            itemEl.querySelector('[data-index]').addEventListener('click', () => {
                const lineItem = {description: item.name, quantity: 1, rate: item.rate, amount: item.rate};
                addLineItem(lineItem);
                toggleCatalog();
            });
            itemEl.querySelector('.edit-catalog-item').addEventListener('click', (e) => {
                e.stopPropagation();
                editCatalogItem(index);
            });
            itemEl.querySelector('.delete-catalog-item').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteCatalogItem(index);
            });
            document.getElementById('catalogItems').appendChild(itemEl);
        });
    }

    function editCatalogItem(index) {
        const catalogItems = JSON.parse(localStorage.getItem('catalogItems') || '[]');
        if (catalogItems[index]) {
            currentEditingItem = index;
            const item = catalogItems[index];
            catalogItemNameInput.value = item.name || '';
            catalogItemDescriptionInput.value = item.description || '';
            catalogItemRateInput.value = item.rate || '';
            document.getElementById('catalogItemModalTitle').textContent = 'Edit Catalog Item';
            catalogItemModal.show();
        }
    }

    function deleteCatalogItem(index) {
        if (confirm('Are you sure you want to delete this catalog item?')) {
            const catalogItems = JSON.parse(localStorage.getItem('catalogItems') || '[]');
            if (catalogItems[index]) {
                catalogItems.splice(index, 1);
                localStorage.setItem('catalogItems', JSON.stringify(catalogItems));
                loadCatalogItems();
                showToast('Catalog item deleted', 'success');
            }
        }
    }

    function loadClientsFromStorage() {
        const savedClients = JSON.parse(localStorage.getItem('savedClients') || '[]');
        savedClientsList.innerHTML = '';
        if (savedClients.length === 0) {
            savedClientsList.innerHTML = '<li><span class="dropdown-item">No saved clients</span></li>';
            return;
        }
        savedClients.forEach((client, index) => {
            const item = document.createElement('li');
            item.innerHTML = `<a class="dropdown-item client-item" href="#" data-index="${index}">${client.name}</a>`;
            savedClientsList.appendChild(item);
        });
        document.querySelectorAll('.client-item').forEach(item => {
            item.addEventListener('click', function (e) {
                e.preventDefault();
                const index = parseInt(this.dataset.index);
                loadClientData(index);
            });
        });
    }

    function saveClientToStorage() {
        const clientData = {
            name: clientNameInput.value,
            address: clientAddressInput.value,
            phone: clientPhoneInput.value,
            email: clientEmailInput.value
        };
        const savedClients = JSON.parse(localStorage.getItem('savedClients') || '[]');
        let exists = false;
        savedClients.forEach((client, index) => {
            if (client.name === clientData.name) {
                savedClients[index] = clientData;
                exists = true;
            }
        });
        if (!exists) {
            savedClients.push(clientData);
        }
        localStorage.setItem('savedClients', JSON.stringify(savedClients));
        loadClientsFromStorage();
        showToast('Client saved for future use', 'success');
    }

    function loadClientData(index) {
        const savedClients = JSON.parse(localStorage.getItem('savedClients') || '[]');
        if (savedClients[index]) {
            const client = savedClients[index];
            clientNameInput.value = client.name || '';
            clientAddressInput.value = client.address || '';
            clientPhoneInput.value = client.phone || '';
            clientEmailInput.value = client.email || '';
            updateInvoiceData();
            updatePreview();
            scheduleAutoSave();
        }
    }

    function applyCustomCSS() {
        if (document.getElementById('userCustomCSS')) {
            document.getElementById('userCustomCSS').remove();
        }
        if (invoiceData.customCss) {
            const style = document.createElement('style');
            style.id = 'userCustomCSS';
            style.innerText = invoiceData.customCss;
            document.head.appendChild(style);
        }
    }

    function showEmailModal() {
        emailToInput.value = invoiceData.client.email || '';
        emailSubjectInput.value = `Invoice #${invoiceData.info.number} from ${invoiceData.business.name || 'Your Business'}`;
        emailModal.show();
    }

    function sendInvoiceEmail() {
        showToast('Email feature is a demo only. In a real app, this would send the invoice.', 'info');
        emailModal.hide();
    }

    function filterInvoices() {
        const query = filterInput.value.toLowerCase();
        if (document.getElementById('savedInvoicesList').children.length > 0) {
            const allRows = document.querySelectorAll('#savedInvoicesList tr');
            allRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(query)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        if (document.getElementById('recentInvoicesList').children.length > 0) {
            const recentItems = document.querySelectorAll('#recentInvoicesList div.list-group-item');
            recentItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(query)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }
    }

    function showToast(message, type = 'info') {
        const toastContainer = document.querySelector('.toast-container');
        const toastElement = document.createElement('div');
        toastElement.className = `toast toast-${type} show`;
        toastElement.innerHTML = `<div class="toast-header"><strong>${type === 'error' ? 'Error' : (type === 'success' ? 'Success' : 'Information')}</strong><button type="button" class="btn-close ms-auto" data-bs-dismiss="toast"></button></div><div class="toast-body">${message}</div>`;
        toastContainer.appendChild(toastElement);
        setTimeout(() => {
            toastElement.classList.remove('show');
            setTimeout(() => toastElement.remove(), 300);
        }, 5000);
    }

    function scheduleAutoSave() {
        if (!autoSaveSwitch.checked) return;
        if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
        autosaveIndicatorDot.className = 'autosave-indicator autosave-saving';
        autoSaveTimeout = setTimeout(performAutoSave, 2000);
    }

    function performAutoSave() {
        const currentData = JSON.stringify(invoiceData);
        if (currentData !== lastSavedData) {
            updateInvoiceData();
            try {
                saveInvoice();
                autosaveIndicatorDot.className = 'autosave-indicator autosave-success';
            } catch (e) {
                console.error('Auto-save failed:', e);
                autosaveIndicatorDot.className = 'autosave-indicator autosave-error';
            }
        } else {
            autosaveIndicatorDot.className = 'autosave-indicator autosave-success';
        }
    }

    function toggleAutoSave() {
        if (autoSaveSwitch.checked) {
            scheduleAutoSave();
        } else {
            if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
            autosaveIndicatorDot.className = 'autosave-indicator';
        }
    }

    loadClientsFromStorage();
    window.addEventListener('resize', resizeSignaturePad);
    resizeSignaturePad();
    document.addEventListener('keydown', function (e) {
        if (e.ctrlKey || e.metaKey) {
            switch (e.key.toLowerCase()) {
                case's':
                    e.preventDefault();
                    saveInvoice();
                    break;
                case'p':
                    e.preventDefault();
                    window.print();
                    break;
            }
        }
    });
    try {
        const draftData = localStorage.getItem('invoiceDraft');
        if (draftData) {
            const draft = JSON.parse(draftData);
            if (draft && draft.info) {
                invoiceData = draft;
                loadInvoice('draft');
            }
        } else {
            updatePreview();
        }
    } catch (e) {
        console.error('Error loading draft:', e);
        updatePreview();
    }
    saveClientCheck.addEventListener('change', function () {
        if (this.checked && clientNameInput.value.trim()) {
            saveClientToStorage();
        }
    });
});</script>
</body>
</html>