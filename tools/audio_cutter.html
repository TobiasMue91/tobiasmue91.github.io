<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽµ</text></svg>">
    <meta charset="UTF-8">
    <title>Advanced Audio Cutter - Free Online Tool | GPT Games</title>
    <meta name="title" content="Advanced Audio Cutter - Free Online Tool | GPT Games">
    <meta name="description" content="Create perfect audio clips with our free online audio cutter tool. Upload any audio file, create multiple selections, rearrange them, and download the edited audio in seconds.">
    <meta name="keywords" content="audio cutter, free audio editor, online audio trimmer, cut mp3, audio splitter, audio editing tool, wav editor, audio clipper">
    <meta name="author" content="Claude 3.7 Sonnet prompted by Tobias MÃ¼ller">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.gptgames.dev/tools/audio_cutter.html">
    <meta property="og:title" content="Advanced Audio Cutter - Free Online Tool">
    <meta property="og:description" content="Cut, trim, and rearrange your audio files with this easy-to-use free online tool. No software installation required!">
    <meta property="og:image" content="https://www.gptgames.dev/screenshots/screenshot_182.png">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://www.gptgames.dev/tools/audio_cutter.html">
    <meta property="twitter:title" content="Advanced Audio Cutter - Free Online Tool">
    <meta property="twitter:description" content="Cut, trim, and rearrange your audio files with this easy-to-use free online tool. No software installation required!">
    <meta property="twitter:image" content="https://www.gptgames.dev/screenshots/screenshot_182.png">
    <link rel="canonical" href="https://www.gptgames.dev/tools/audio_cutter.html">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3498db;
            --accent: #2ecc71;
            --text: #333;
            --bg: #f5f5f5;
            --card: #fff;
            --border: #ddd;
            --shadow: rgba(0, 0, 0, 0.1);
            --region-1: rgba(46, 204, 113, 0.3);
            --region-border-1: rgba(46, 204, 113, 0.7);
            --region-2: rgba(155, 89, 182, 0.3);
            --region-border-2: rgba(155, 89, 182, 0.7);
            --region-3: rgba(231, 76, 60, 0.3);
            --region-border-3: rgba(231, 76, 60, 0.7);
            --region-4: rgba(241, 196, 15, 0.3);
            --region-border-4: rgba(241, 196, 15, 0.7);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #3498db;
                --accent: #2ecc71;
                --text: #f5f5f5;
                --bg: #121212;
                --card: #1e1e1e;
                --border: #333;
                --shadow: rgba(0, 0, 0, 0.4);
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--card);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px var(--shadow);
        }

        header {
            text-align: center;
            margin-bottom: 25px;
        }

        h1 {
            color: var(--primary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            border: 2px dashed var(--border);
            border-radius: 12px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .upload-area.drag-over {
            border-color: var(--primary);
            background-color: rgba(52, 152, 219, 0.1);
        }

        .upload-area p {
            margin: 12px 0;
        }

        .file-info {
            width: 100%;
            text-align: center;
            margin-top: 15px;
        }

        .waveform-container {
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            position: relative;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            justify-content: space-between;
        }

        .btn {
            padding: 10px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .btn-accent {
            background: var(--accent);
        }

        .btn-accent:hover {
            background: #27ae60;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .time-input {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--card);
            color: var(--text);
            width: 100px;
        }

        .export-section {
            text-align: center;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        #fileInput {
            display: none;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            accent-color: var(--primary);
            height: 6px;
        }

        .hidden {
            display: none !important;
        }

        .progress-bar {
            height: 4px;
            background-color: var(--border);
            margin-top: 5px;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.1s;
        }

        .playback-controls, .selection-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .selection-controls {
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: rgba(46, 204, 113, 0.9);
            color: white;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.error {
            background: rgba(231, 76, 60, 0.9);
        }

        #waveform {
            opacity: 1;
            transition: opacity 0.3s;
        }

        #waveform.loading {
            opacity: 0.5;
        }

        .regions-list {
            margin-top: 20px;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .regions-header {
            background: var(--primary);
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .regions-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .regions-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .region-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card);
            transition: background-color 0.2s;
        }

        .region-item:last-child {
            border-bottom: none;
        }

        .region-item:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .region-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .region-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .region-actions {
            display: flex;
            gap: 8px;
        }

        .region-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 5px;
            border-radius: 4px;
            color: var(--text);
            transition: all 0.2s;
        }

        .region-actions button:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .region-time {
            font-family: monospace;
            font-size: 14px;
        }

        .drag-handle {
            cursor: grab;
            color: #95a5a6;
        }

        .reorder-controls {
            display: flex;
            gap: 5px;
        }

        .instructions {
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 6px;
            border-left: 3px solid var(--primary);
        }

        .instructions ul {
            margin-left: 20px;
            margin-top: 5px;
        }

        .instructions p {
            margin-bottom: 5px;
        }

        .alert {
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 6px;
            background-color: rgba(241, 196, 15, 0.2);
            border-left: 3px solid #f1c40f;
        }

        .sort-controls {
            margin-top: 5px;
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .no-regions-message {
            padding: 20px;
            text-align: center;
            color: #95a5a6;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>Advanced Audio Cutter</h1>
        <p>Upload, create multiple selections, rearrange, and export your audio</p>
    </header>

    <div class="instructions">
        <p><strong>How to use:</strong></p>
        <ul>
            <li>Upload an audio file using drag & drop or the file selector</li>
            <li>Click and drag on the waveform to select regions to cut</li>
            <li>Create multiple selections and rearrange their order</li>
            <li>Use the "Create Final Audio" button to combine all regions</li>
            <li>Download the result as a new audio file</li>
        </ul>
    </div>

    <div class="upload-area" id="uploadArea">
        <i class="fas fa-cloud-upload-alt fa-3x" style="color: var(--primary);"></i>
        <p>Drag and drop your audio file here or</p>
        <button class="btn" id="uploadBtn"><i class="fas fa-file-audio"></i> Choose Audio File</button>
        <input type="file" id="fileInput" accept="audio/*">
        <div class="file-info hidden" id="fileInfo"></div>
    </div>

    <div class="waveform-container hidden" id="waveformContainer">
        <div id="waveform"></div>
        <div id="loadingOverlay" class="loading-overlay hidden">
            <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--primary);"></i>
        </div>
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
    </div>

    <div class="controls hidden" id="controls">
        <div class="playback-controls">
            <button class="btn" id="playBtn" title="Play (Space)"><i class="fas fa-play"></i> Play</button>
            <button class="btn hidden" id="pauseBtn" title="Pause (Space)"><i class="fas fa-pause"></i> Pause</button>
            <button class="btn" id="stopBtn" title="Stop (Esc)"><i class="fas fa-stop"></i> Stop</button>
            <div class="volume-control tooltip">
                <i class="fas fa-volume-up"></i>
                <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" title="Adjust volume">
                <span class="tooltiptext">Adjust playback volume</span>
            </div>
        </div>
        <div class="selection-controls">
            <button class="btn" id="addRegionBtn" title="Add a new region">
                <i class="fas fa-plus-circle"></i> Add Region
            </button>
            <button class="btn" id="playSelectionBtn" title="Play currently selected region">
                <i class="fas fa-play-circle"></i> Play Selected
            </button>
            <button class="btn" id="clearRegionsBtn" title="Remove all regions">
                <i class="fas fa-trash"></i> Clear All
            </button>
        </div>
    </div>

    <div class="regions-list hidden" id="regionsList">
        <div class="regions-header">
            <h3>Audio Selections</h3>
            <div class="sort-controls">
                <button class="btn" id="sortByTimeBtn" title="Sort regions by time">
                    <i class="fas fa-sort-amount-down"></i> Sort by Time
                </button>
            </div>
        </div>
        <div class="regions-container" id="regionsContainer">
            <div class="no-regions-message">No regions created yet. Click and drag on the waveform to create regions.</div>
        </div>
    </div>

    <div class="export-section hidden" id="exportSection">
        <button class="btn btn-accent" id="createFinalBtn">
            <i class="fas fa-scissors"></i> Create Final Audio
        </button>
        <button class="btn hidden" id="downloadBtn">
            <i class="fas fa-download"></i> Download
        </button>
    </div>

    <div id="notification" class="notification"></div>
</div>

<script src="https://unpkg.com/wavesurfer.js@6.6.3"></script>
<script src="https://unpkg.com/wavesurfer.js@6.6.3/dist/plugin/wavesurfer.regions.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Elements
        const uploadArea = document.getElementById('uploadArea');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const waveformContainer = document.getElementById('waveformContainer');
        const waveformElement = document.getElementById('waveform');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const controls = document.getElementById('controls');
        const exportSection = document.getElementById('exportSection');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const playSelectionBtn = document.getElementById('playSelectionBtn');
        const clearRegionsBtn = document.getElementById('clearRegionsBtn');
        const addRegionBtn = document.getElementById('addRegionBtn');
        const createFinalBtn = document.getElementById('createFinalBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const progress = document.getElementById('progress');
        const notification = document.getElementById('notification');
        const regionsList = document.getElementById('regionsList');
        const regionsContainer = document.getElementById('regionsContainer');
        const sortByTimeBtn = document.getElementById('sortByTimeBtn');

        // Variables
        let wavesurfer;
        let audioContext;
        let audioBuffer;
        let sourceFile = null;
        let processedBlob = null;
        let isPlaying = false;
        let regionColors = [
            { background: 'rgba(46, 204, 113, 0.3)', border: 'rgba(46, 204, 113, 0.7)' },
            { background: 'rgba(155, 89, 182, 0.3)', border: 'rgba(155, 89, 182, 0.7)' },
            { background: 'rgba(231, 76, 60, 0.3)', border: 'rgba(231, 76, 60, 0.7)' },
            { background: 'rgba(241, 196, 15, 0.3)', border: 'rgba(241, 196, 15, 0.7)' }
        ];
        let regionsOrder = [];
        let selectedRegion = null;

        // Show notification function
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.className = 'notification' + (isError ? ' error' : '');
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Initialize WaveSurfer
        function initWaveSurfer() {
            wavesurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: 'rgba(52, 152, 219, 0.6)',
                progressColor: 'rgba(52, 152, 219, 1.0)',
                cursorColor: '#FF5722',
                height: 140,
                barWidth: 2,
                barGap: 1,
                responsive: true,
                plugins: [
                    WaveSurfer.regions.create({
                        dragSelection: true,
                        slop: 5,
                        regions: [],
                        // Allow overlapping regions
                        maxRegions: Infinity
                    })
                ]
            });

            // WaveSurfer events
            wavesurfer.on('ready', function () {
                waveformElement.classList.remove('loading');
                loadingOverlay.classList.add('hidden');
                waveformContainer.classList.remove('hidden');
                controls.classList.remove('hidden');
                exportSection.classList.remove('hidden');
                regionsList.classList.remove('hidden');

                const duration = wavesurfer.getDuration();
                fileInfo.innerHTML += `<p>Duration: ${formatTime(duration)}</p>`;

                // Enable controls
                playBtn.disabled = false;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;

                showNotification('Audio loaded successfully');
            });

            wavesurfer.on('error', function (err) {
                console.error('WaveSurfer error:', err);
                showNotification('Error loading audio: ' + (err.message || 'Unknown error'), true);
                loadingOverlay.classList.add('hidden');
            });

            wavesurfer.on('audioprocess', function () {
                updateProgress();
            });

            wavesurfer.on('seek', updateProgress);

            wavesurfer.on('play', function () {
                isPlaying = true;
                playBtn.classList.add('hidden');
                pauseBtn.classList.remove('hidden');
            });

            wavesurfer.on('pause', function () {
                isPlaying = false;
                playBtn.classList.remove('hidden');
                pauseBtn.classList.add('hidden');
            });

            // Region events
            wavesurfer.on('region-created', function (region) {
                const colorIndex = Object.keys(wavesurfer.regions.list).length % regionColors.length;
                const color = regionColors[colorIndex];

                region.color = color.background;
                region.data = {
                    borderColor: color.border
                };
                region.element.style.borderLeft = `1px solid ${color.border}`;
                region.element.style.borderRight = `1px solid ${color.border}`;

                regionsOrder.push(region.id);
                selectedRegion = region;

                updateRegionsList();
            });

            wavesurfer.on('region-updated', function (region) {
                updateRegionsList();
            });

            wavesurfer.on('region-removed', function (region) {
                regionsOrder = regionsOrder.filter(id => id !== region.id);
                updateRegionsList();
            });

            wavesurfer.on('region-click', function (region, e) {
                e.stopPropagation();
                selectedRegion = region;

                // Add a visual feedback for the selected region
                Object.values(wavesurfer.regions.list).forEach(r => {
                    r.element.style.opacity = r === region ? '1' : '0.7';
                });
            });

            // Initially hide pause button
            pauseBtn.classList.add('hidden');
        }

        // Format time as MM:SS.mmm
        function formatTime(time) {
            const minutes = Math.floor(time / 60);
            const seconds = Math.floor(time % 60);
            const milliseconds = Math.floor((time % 1) * 1000);
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(3, '0')}`;
        }

        // Parse time from string (MM:SS.mmm)
        function parseTime(timeStr) {
            try {
                const parts = timeStr.split(':');
                if (parts.length !== 2) return 0;
                const minutesPart = parseInt(parts[0], 10) || 0;
                const secondsParts = parts[1].split('.');
                const secondsPart = parseInt(secondsParts[0], 10) || 0;
                const millisecondsPart = secondsParts.length > 1 ? parseInt(secondsParts[1], 10) || 0 : 0;
                return minutesPart * 60 + secondsPart + millisecondsPart / 1000;
            } catch (e) {
                console.error('Error parsing time:', e);
                return 0;
            }
        }

        // Update regions list
        function updateRegionsList() {
            // Clear the current list
            while (regionsContainer.firstChild) {
                regionsContainer.removeChild(regionsContainer.firstChild);
            }

            const regions = wavesurfer.regions.list;
            const regionIds = Object.keys(regions);

            if (regionIds.length === 0) {
                const noRegionsMsg = document.createElement('div');
                noRegionsMsg.className = 'no-regions-message';
                noRegionsMsg.textContent = 'No regions created yet. Click and drag on the waveform to create regions.';
                regionsContainer.appendChild(noRegionsMsg);
                return;
            }

            // Sort regions based on the user's ordering
            const orderedRegions = regionsOrder
                .filter(id => regions[id]) // Only include regions that still exist
                .map(id => regions[id]);

            // Add any new regions that might not be in the order yet
            regionIds.forEach(id => {
                if (!regionsOrder.includes(id)) {
                    orderedRegions.push(regions[id]);
                }
            });

            // Create elements for each region
            orderedRegions.forEach((region, index) => {
                const regionItem = document.createElement('div');
                regionItem.className = 'region-item';
                regionItem.dataset.regionId = region.id;

                const startFormatted = formatTime(region.start);
                const endFormatted = formatTime(region.end);
                const duration = (region.end - region.start).toFixed(2);

                regionItem.innerHTML = `
                        <div class="region-info">
                            <span class="region-color" style="background-color: ${region.color};"></span>
                            <span class="region-time">
                                ${startFormatted} - ${endFormatted} (${duration}s)
                            </span>
                        </div>
                        <div class="region-actions">
                            <div class="reorder-controls">
                                <button class="move-up" title="Move up" ${index === 0 ? 'disabled' : ''}>
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                                <button class="move-down" title="Move down" ${index === orderedRegions.length - 1 ? 'disabled' : ''}>
                                    <i class="fas fa-arrow-down"></i>
                                </button>
                            </div>
                            <button class="play-region" title="Play region">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="delete-region" title="Delete region">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;

                regionsContainer.appendChild(regionItem);

                // Add event listeners
                const moveUpBtn = regionItem.querySelector('.move-up');
                const moveDownBtn = regionItem.querySelector('.move-down');
                const playRegionBtn = regionItem.querySelector('.play-region');
                const deleteRegionBtn = regionItem.querySelector('.delete-region');

                moveUpBtn.addEventListener('click', () => {
                    const currentIndex = regionsOrder.indexOf(region.id);
                    if (currentIndex > 0) {
                        // Swap with the previous item
                        [regionsOrder[currentIndex], regionsOrder[currentIndex - 1]] =
                            [regionsOrder[currentIndex - 1], regionsOrder[currentIndex]];
                        updateRegionsList();
                    }
                });

                moveDownBtn.addEventListener('click', () => {
                    const currentIndex = regionsOrder.indexOf(region.id);
                    if (currentIndex < regionsOrder.length - 1) {
                        // Swap with the next item
                        [regionsOrder[currentIndex], regionsOrder[currentIndex + 1]] =
                            [regionsOrder[currentIndex + 1], regionsOrder[currentIndex]];
                        updateRegionsList();
                    }
                });

                playRegionBtn.addEventListener('click', () => {
                    wavesurfer.seekTo(region.start / wavesurfer.getDuration());
                    wavesurfer.play(region.start, region.end);
                    selectedRegion = region;
                });

                deleteRegionBtn.addEventListener('click', () => {
                    region.remove();
                });

                // Click on the item to select it
                regionItem.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        selectedRegion = region;

                        // Highlight the selected region
                        document.querySelectorAll('.region-item').forEach(item => {
                            item.style.backgroundColor = '';
                        });
                        regionItem.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';

                        // Visual feedback on waveform
                        Object.values(wavesurfer.regions.list).forEach(r => {
                            r.element.style.opacity = r === region ? '1' : '0.7';
                        });
                    }
                });
            });
        }

        // Update progress bar
        function updateProgress() {
            if (wavesurfer) {
                const currentTime = wavesurfer.getCurrentTime();
                const duration = wavesurfer.getDuration();
                const percentage = (currentTime / duration) * 100;
                progress.style.width = `${percentage}%`;
            }
        }

        // Initialize Web Audio API
        function initAudioContext() {
            try {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
            } catch (e) {
                console.error('Web Audio API is not supported in this browser', e);
                showNotification('Your browser does not support Web Audio API', true);
            }
        }

        // Load audio file
        function loadAudioFile(file) {
            if (!file || !file.type.startsWith('audio/')) {
                showNotification('Please select a valid audio file', true);
                return;
            }

            sourceFile = file;
            fileInfo.innerHTML = `<p>File: ${file.name}</p>`;
            fileInfo.classList.remove('hidden');

            // Show loading state
            waveformContainer.classList.remove('hidden');
            waveformElement.classList.add('loading');
            loadingOverlay.classList.remove('hidden');

            // Reset previous state
            if (wavesurfer) {
                wavesurfer.regions.clear();
                wavesurfer.clearRegions();
            }
            regionsOrder = [];
            selectedRegion = null;

            if (processedBlob) {
                URL.revokeObjectURL(URL.createObjectURL(processedBlob));
                processedBlob = null;
                downloadBtn.classList.add('hidden');
            }

            // Load audio in WaveSurfer
            wavesurfer.loadBlob(file);

            // Also load into audio context for processing
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    audioContext.decodeAudioData(e.target.result, function (buffer) {
                        audioBuffer = buffer;
                    }, function (err) {
                        console.error('Error decoding audio data', err);
                        showNotification('Failed to process audio file. Please try another file.', true);
                        loadingOverlay.classList.add('hidden');
                    });
                } catch (err) {
                    console.error('Error loading audio into context:', err);
                    showNotification('Failed to process audio file. Please try another file.', true);
                    loadingOverlay.classList.add('hidden');
                }
            };

            reader.onerror = function (err) {
                console.error('FileReader error:', err);
                showNotification('Error reading the file. Please try again.', true);
                loadingOverlay.classList.add('hidden');
            };

            reader.readAsArrayBuffer(file);
        }

        // Create audio from selected regions
        function createFinalAudio() {
            return new Promise((resolve, reject) => {
                if (!audioBuffer) {
                    reject('No audio loaded');
                    return;
                }

                try {
                    const regions = wavesurfer.regions.list;
                    const regionIds = regionsOrder.filter(id => regions[id]); // Only include existing regions

                    if (regionIds.length === 0) {
                        reject('No regions to export');
                        return;
                    }

                    // Calculate the total length of all regions
                    let totalFrames = 0;
                    const orderedRegions = regionIds.map(id => regions[id]);

                    for (const region of orderedRegions) {
                        const start = region.start;
                        const end = region.end;
                        const regionFrames = Math.floor((end - start) * audioBuffer.sampleRate);
                        totalFrames += regionFrames;
                    }

                    // Create a new buffer for the combined audio
                    const sampleRate = audioBuffer.sampleRate;
                    const newBuffer = audioContext.createBuffer(
                        audioBuffer.numberOfChannels,
                        totalFrames,
                        sampleRate
                    );

                    // Copy each region's data into the new buffer
                    let frameOffset = 0;

                    for (const region of orderedRegions) {
                        const start = region.start;
                        const end = region.end;
                        const startOffset = Math.floor(start * sampleRate);
                        const endOffset = Math.floor(end * sampleRate);
                        const regionFrames = endOffset - startOffset;

                        for (let channel = 0; channel < audioBuffer.numberOfChannels; channel++) {
                            const originalData = audioBuffer.getChannelData(channel);
                            const newData = newBuffer.getChannelData(channel);

                            // Copy this region's data to the appropriate position in the new buffer
                            for (let i = 0; i < regionFrames; i++) {
                                newData[frameOffset + i] = originalData[startOffset + i];
                            }
                        }

                        frameOffset += regionFrames;
                    }

                    // Convert the buffer to WAV
                    const wavBlob = audioBufferToWav(newBuffer);
                    resolve(wavBlob);

                } catch (error) {
                    console.error('Error creating final audio:', error);
                    reject(error);
                }
            });
        }

        // Properly convert AudioBuffer to WAV
        // This is a crucial fix to ensure the WAV is generated correctly
        function audioBufferToWav(buffer) {
            const numChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const format = 1; // PCM format
            const bitDepth = 16; // 16-bit audio

            // Calculate sizes
            const bytesPerSample = bitDepth / 8;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = buffer.length * blockAlign;
            const bufferSize = 44 + dataSize;

            // Create the buffer for the WAV file
            const arrayBuffer = new ArrayBuffer(bufferSize);
            const view = new DataView(arrayBuffer);

            // Write WAV header
            // "RIFF" chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');

            // "fmt " sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // fmt chunk size
            view.setUint16(20, format, true); // audio format (PCM)
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);

            // "data" sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            // Write audio data
            let offset = 44;
            const channelData = [];

            // Get audio channel data
            for (let channel = 0; channel < numChannels; channel++) {
                channelData.push(buffer.getChannelData(channel));
            }

            // Write interleaved audio data
            let sample = 0;
            for (let i = 0; i < buffer.length; i++) {
                for (let channel = 0; channel < numChannels; channel++) {
                    // Audio is in range of -1.0 to 1.0, convert to 16-bit PCM
                    sample = Math.max(-1, Math.min(1, channelData[channel][i]));
                    sample = (sample < 0) ? sample * 0x8000 : sample * 0x7FFF;
                    sample = Math.floor(sample);
                    view.setInt16(offset, sample, true);
                    offset += 2;
                }
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        // Helper to write strings to DataView
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // Event listeners
        uploadBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', function (e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                if (file.type.startsWith('audio/')) {
                    loadAudioFile(file);
                } else {
                    showNotification('Please select an audio file.', true);
                }
            }
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', function (e) {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', function () {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', function (e) {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                if (file.type.startsWith('audio/')) {
                    loadAudioFile(file);
                } else {
                    showNotification('Please drop an audio file.', true);
                }
            }
        });

        // Playback controls
        playBtn.addEventListener('click', function () {
            if (wavesurfer) {
                wavesurfer.play();
            }
        });

        pauseBtn.addEventListener('click', function () {
            if (wavesurfer) {
                wavesurfer.pause();
            }
        });

        stopBtn.addEventListener('click', function () {
            if (wavesurfer) {
                wavesurfer.stop();
            }
        });

        volumeSlider.addEventListener('input', function () {
            if (wavesurfer) {
                wavesurfer.setVolume(this.value);
            }
        });

        // Selection controls
        playSelectionBtn.addEventListener('click', function () {
            if (wavesurfer && selectedRegion) {
                wavesurfer.seekTo(selectedRegion.start / wavesurfer.getDuration());
                wavesurfer.play(selectedRegion.start, selectedRegion.end);
            } else {
                showNotification('Please select a region first.', true);
            }
        });

        clearRegionsBtn.addEventListener('click', function () {
            if (wavesurfer) {
                wavesurfer.regions.clear();
                regionsOrder = [];
                selectedRegion = null;
                updateRegionsList();
            }
        });

        addRegionBtn.addEventListener('click', function () {
            if (wavesurfer) {
                const duration = wavesurfer.getDuration();
                const start = Math.random() * (duration * 0.7); // Random start time
                const end = start + (duration * 0.1);  // 10% of the total duration

                wavesurfer.addRegion({
                    start: start,
                    end: Math.min(end, duration),
                    color: regionColors[Object.keys(wavesurfer.regions.list).length % regionColors.length].background,
                    drag: true,
                    resize: true
                });
            }
        });

        // Export controls
        createFinalBtn.addEventListener('click', function () {
            if (Object.keys(wavesurfer.regions.list).length === 0) {
                showNotification('Please create at least one region first.', true);
                return;
            }

            createFinalBtn.disabled = true;
            createFinalBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            createFinalAudio()
                .then(blob => {
                    processedBlob = blob;
                    downloadBtn.classList.remove('hidden');
                    createFinalBtn.innerHTML = '<i class="fas fa-scissors"></i> Create Final Audio';
                    createFinalBtn.disabled = false;
                    showNotification('Audio created successfully! Ready for download.');
                })
                .catch(error => {
                    console.error('Error creating audio:', error);
                    showNotification('Failed to create audio: ' + error, true);
                    createFinalBtn.innerHTML = '<i class="fas fa-scissors"></i> Create Final Audio';
                    createFinalBtn.disabled = false;
                });
        });

        downloadBtn.addEventListener('click', function () {
            if (processedBlob) {
                const fileName = sourceFile.name.replace(/\.[^/.]+$/, '') + '_edited.wav';
                const url = URL.createObjectURL(processedBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                showNotification('Download started!');
            }
        });

        // Sort regions
        sortByTimeBtn.addEventListener('click', function() {
            const regions = wavesurfer.regions.list;

            // Sort regions by start time
            regionsOrder = Object.keys(regions).sort((a, b) => {
                return regions[a].start - regions[b].start;
            });

            updateRegionsList();
            showNotification('Regions sorted by time');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            if (!wavesurfer) return;

            // Space - play/pause
            if (e.code === 'Space') {
                e.preventDefault();
                if (isPlaying) {
                    wavesurfer.pause();
                } else {
                    wavesurfer.play();
                }
            }

            // Escape - stop
            if (e.code === 'Escape') {
                e.preventDefault();
                wavesurfer.stop();
            }

            // Delete - remove selected region
            if ((e.code === 'Delete' || e.code === 'Backspace') && selectedRegion) {
                e.preventDefault();
                selectedRegion.remove();
                selectedRegion = null;
            }
        });

        // Initialize
        initWaveSurfer();
        initAudioContext();

        // Disable buttons initially
        playBtn.disabled = true;
        pauseBtn.disabled = true;
        stopBtn.disabled = true;
    });
</script>
<script src="../logo.js"></script>
</body>
</html>