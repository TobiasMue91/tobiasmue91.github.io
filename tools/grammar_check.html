<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammar Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/json5/2.2.3/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/languagedetect/languagedetect.js"></script>
    <style>
        .error-spelling { background: rgba(255, 0, 0, 0.2); }
        .error-grammar { background: rgba(255, 165, 0, 0.2); }
        .error-style { background: rgba(0, 128, 0, 0.2); }
        .error-punctuation { background: rgba(0, 0, 255, 0.2); }
        .tooltip { position: absolute; background: white; border: 1px solid #ccc; padding: 8px; border-radius: 4px; box-shadow: 2px 2px 10px rgba(0,0,0,0.1); z-index: 1000; max-width: 300px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
<div class="container mx-auto max-w-4xl p-6">
    <h1 class="text-3xl font-bold text-center mb-6">Grammar Checker</h1>
    <div class="bg-white rounded-lg shadow-lg p-6">
        <textarea id="textInput" class="w-full h-40 p-4 border rounded-lg mb-4" placeholder="Enter your text here..."></textarea>
        <button id="checkGrammar" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">Check Grammar</button>
        <div id="result" class="mt-6 p-4 border rounded-lg"></div>
    </div>
    <div class="mt-4 flex gap-4 justify-center">
        <div class="flex items-center"><span class="w-4 h-4 inline-block mr-2 error-spelling"></span>Spelling</div>
        <div class="flex items-center"><span class="w-4 h-4 inline-block mr-2 error-grammar"></span>Grammar</div>
        <div class="flex items-center"><span class="w-4 h-4 inline-block mr-2 error-style"></span>Style</div>
        <div class="flex items-center"><span class="w-4 h-4 inline-block mr-2 error-punctuation"></span>Punctuation</div>
    </div>
</div>

<script>
    const grammarChecker = {
        init() {
            this.checkButton = document.getElementById('checkGrammar');
            this.textInput = document.getElementById('textInput');
            this.resultDiv = document.getElementById('result');
            this.checkButton.addEventListener('click', () => this.check());
            this.tooltip = null;
        },

        async check() {
            const text = this.textInput.value.trim();
            if (!text) return;

            this.checkButton.disabled = true;
            this.checkButton.textContent = 'Checking...';

            try {
                const response = await this.callLLM(text);
                this.displayResults(response);
            } catch (error) {
                console.error('Error:', error);
                this.resultDiv.innerHTML = 'An error occurred while checking the text.';
            } finally {
                this.checkButton.disabled = false;
                this.checkButton.textContent = 'Check Grammar';
            }
        },

        async callLLM(text) {
            const prompt = `Act as a grammar checking API. Analyze the following text and return a JSON response in this exact format:
{
    "errors": [
        {
            "type": "spelling|grammar|style|punctuation",
            "start": <number>,
            "end": <number>,
            "text": "<problematic text>",
            "suggestion": "<corrected text>",
            "description": "<error description>"
        }
    ]
}

Example input: "I dont like there attitude."
Example response: {
    "errors": [
        {
            "type": "spelling",
            "start": 2,
            "end": 6,
            "text": "dont",
            "suggestion": "don't",
            "description": "Missing apostrophe in contraction"
        },
        {
            "type": "grammar",
            "start": 7,
            "end": 12,
            "text": "there",
            "suggestion": "their",
            "description": "Incorrect use of 'there' instead of the possessive 'their'"
        }
    ]
}

Text to analyze: ${text}`;

            const response = await fetch('https://chatgpt.tobiasmue91.workers.dev/', {
                method: 'POST',
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: [
                        {role: "user", content: prompt}
                    ]
                })
            });

            const data = await response.json();
            const content = data.choices[0].message.content;
            return JSON.parse(content);
        },

        displayResults(response) {
            const text = this.textInput.value;
            let html = text;
            const errors = response.errors.sort((a, b) => b.start - a.start);

            errors.forEach(error => {
                const errorClass = `error-${error.type}`;
                const replacement = `<span class="${errorClass}" data-error='${JSON.stringify(error)}'>${error.text}</span>`;
                html = html.substring(0, error.start) + replacement + html.substring(error.end);
            });

            this.resultDiv.innerHTML = html;
            this.attachErrorListeners();
        },

        attachErrorListeners() {
            const errorSpans = this.resultDiv.querySelectorAll('span[data-error]');
            errorSpans.forEach(span => {
                span.addEventListener('mouseover', (e) => this.showTooltip(e));
                span.addEventListener('mouseout', () => this.hideTooltip());
                span.addEventListener('click', (e) => this.applyCorrection(e));
            });
        },

        showTooltip(event) {
            const error = JSON.parse(event.target.dataset.error);
            if (this.tooltip) this.hideTooltip();

            this.tooltip = document.createElement('div');
            this.tooltip.className = 'tooltip';
            this.tooltip.innerHTML = `
            <div class="font-bold">${error.type.charAt(0).toUpperCase() + error.type.slice(1)} Error</div>
            <div class="mt-1">${error.description}</div>
            <div class="mt-2 text-sm text-gray-600">Click to replace with: "${error.suggestion}"</div>
        `;

            document.body.appendChild(this.tooltip);
            const rect = event.target.getBoundingClientRect();
            this.tooltip.style.left = `${rect.left}px`;
            this.tooltip.style.top = `${rect.bottom + 5}px`;
        },

        hideTooltip() {
            if (this.tooltip) {
                this.tooltip.remove();
                this.tooltip = null;
            }
        },

        applyCorrection(event) {
            const error = JSON.parse(event.target.dataset.error);
            event.target.textContent = error.suggestion;
            event.target.classList.remove(`error-${error.type}`);
            event.target.removeAttribute('data-error');
            this.hideTooltip();
        }
    };

    document.addEventListener('DOMContentLoaded', () => grammarChecker.init());
</script>
</body>
</html>