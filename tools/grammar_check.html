<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìù</text></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/json5/2.2.3/index.min.js"></script>
    <title>GrammarPro</title>
    <style>
        .error-highlight {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .grammar { border-bottom: 2px solid #ef4444; }
        .spelling { border-bottom: 2px solid #3b82f6; }
        .style { border-bottom: 2px solid #10b981; }
        .punctuation { border-bottom: 2px solid #f59e0b; }

        .tooltip {
            visibility: hidden;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            white-space: nowrap;
            z-index: 100;
            transition: visibility 0.2s;
        }

        .error-highlight:hover .tooltip {
            visibility: visible;
        }
    </style>
</head>
<body class="bg-gray-100 flex justify-center items-center min-h-screen">
<div class="container mx-auto max-w-4xl p-5 bg-white rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold text-center mb-6">GrammarPro</h1>

    <div class="mb-6">
        <label for="input" class="block text-sm font-medium text-gray-700 mb-2">Enter Text:</label>
        <textarea id="input" rows="6" class="w-full p-3 border rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                  placeholder="Type or paste your text here..."></textarea>
    </div>

    <div class="flex justify-between items-center mb-6">
        <button id="check-grammar" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            Check Grammar
        </button>

        <div class="flex gap-4">
            <div class="flex items-center">
                <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                <span class="text-sm">Grammar</span>
            </div>
            <div class="flex items-center">
                <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                <span class="text-sm">Spelling</span>
            </div>
            <div class="flex items-center">
                <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                <span class="text-sm">Style</span>
            </div>
            <div class="flex items-center">
                <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
                <span class="text-sm">Punctuation</span>
            </div>
        </div>
    </div>

    <div id="result" class="p-4 border rounded-md min-h-[100px] bg-gray-50"></div>
</div>

<script>
    document.getElementById('check-grammar').addEventListener('click', checkGrammar);

    async function checkGrammar() {
        const inputElement = document.getElementById('input');
        const resultContainer = document.getElementById('result');
        const button = document.getElementById('check-grammar');

        const inputText = inputElement.value.trim();
        if (!inputText) {
            alert('Please enter some text to check.');
            return;
        }

        button.disabled = true;
        button.textContent = 'Checking...';

        const botMessage = `I am a grammar checking API. I analyze text for grammar, spelling, style, and punctuation errors. I always respond in this JSON format:
            {
                "detectedLanguage": "string",
                "errors": [
                    {
                        "type": "grammar|spelling|style|punctuation",
                        "text": "original text",
                        "suggestion": "suggested correction",
                        "description": "error description"
                    }
                ]
            }

            Example response for "I dont like there attitude":
            {
                "detectedLanguage": "English",
                "errors": [
                    {
                        "type": "spelling",
                        "text": "dont",
                        "suggestion": "don't",
                        "description": "Missing apostrophe in contraction"
                    },
                    {
                        "type": "grammar",
                        "text": "there",
                        "suggestion": "their",
                        "description": "Incorrect use of 'there'. Use 'their' for possession"
                    }
                ]
            }`;

        try {
            const response = await fetch('https://chatgpt.tobiasmue91.workers.dev/', {
                method: 'POST',
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    max_tokens: 800,
                    temperature: 0.3,
                    messages: [
                        {
                            role: "assistant",
                            content: botMessage,
                        },
                        {
                            role: "user",
                            content: `Check this text: ${inputText}`,
                        },
                    ],
                })
            });

            if (!response.ok) throw new Error('Network response was not ok');

            const data = await response.json();
            const responseContent = data.choices[0].message.content;
            const jsonMatch = responseContent.match(/\{[\s\S]*\}/);

            if (!jsonMatch) throw new Error('Invalid response format');

            const grammarData = JSON5.parse(jsonMatch[0]);
            displayResults(inputText, grammarData.errors);

        } catch (error) {
            console.error('Error:', error);
            resultContainer.textContent = 'An error occurred while checking the text. Please try again.';
        } finally {
            button.disabled = false;
            button.textContent = 'Check Grammar';
        }
    }

    function displayResults(originalText, errors) {
        const resultContainer = document.getElementById('result');
        let displayText = originalText;

        // Sort errors by position (longest matches first to avoid nested replacements)
        errors.sort((a, b) => b.text.length - a.text.length);

        // Replace each error with highlighted span
        errors.forEach(error => {
            const highlightHtml = `<span class="error-highlight ${error.type}">
                    ${error.text}
                    <div class="tooltip bg-gray-800 text-white">
                        ${error.description}<br>
                        Suggestion: ${error.suggestion}
                    </div>
                </span>`;

            displayText = displayText.replace(error.text, highlightHtml);
        });

        resultContainer.innerHTML = displayText;

        // Add click handlers for corrections
        document.querySelectorAll('.error-highlight').forEach(highlight => {
            highlight.addEventListener('click', function() {
                const error = errors.find(e => e.text === this.textContent.trim());
                if (error) {
                    const input = document.getElementById('input');
                    input.value = input.value.replace(error.text, error.suggestion);
                }
            });
        });
    }
</script>
</body>
</html>