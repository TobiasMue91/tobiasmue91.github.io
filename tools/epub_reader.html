<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUB Reader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3d7ebc;
            --primary-light: #4c8fce;
            --primary-dark: #2d6eac;
            --text: #333;
            --text-light: #707070;
            --bg: #fff;
            --sidebar-bg: #f7f9fc;
            --header-bg: #f0f4f9;
            --border: #dbe3ef;
            --light-bg: #fff;
            --light-text: #333;
            --sepia-bg: #f8f1e3;
            --sepia-text: #5b4636;
            --dark-bg: #1e1e1e;
            --dark-text: #e0e0e0;
            --font-sans: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --font-serif: 'Georgia', serif;
            --font-mono: 'Consolas', 'Courier New', monospace;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
            --radius: 6px;
            --transition: all 0.3s ease;
            --z-header: 10;
            --z-sidebar: 20;
            --z-modal: 30;
            --z-toast: 40
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: var(--font-sans);
            color: var(--text);
            background: var(--bg);
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
            height: 100vh;
            overflow: hidden
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1.2rem;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border);
            height: 60px;
            position: relative;
            z-index: var(--z-header);
            box-shadow: var(--shadow)
        }

        .logo {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem
        }

        .logo i {
            font-size: 1.4rem
        }

        .toolbar {
            display: flex;
            align-items: center;
            gap: 0.8rem
        }

        .toolbar-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text);
            padding: 0.5rem;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            position: relative;
            font-size: 1.1rem
        }

        .toolbar-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--primary)
        }

        .toolbar-btn.active {
            color: var(--primary);
            background: rgba(61, 126, 188, 0.1)
        }

        .btn {
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: .9rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem
        }

        .btn:hover:not(:disabled) {
            background: var(--primary-light)
        }

        .btn:active:not(:disabled) {
            background: var(--primary-dark)
        }

        .btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary)
        }

        .btn-outline:hover {
            background: rgba(61, 126, 188, 0.1)
        }

        .btn-sm {
            padding: 0.3rem 0.7rem;
            font-size: 0.8rem
        }

        .btn-icon {
            padding: 0.5rem;
            width: 36px;
            height: 36px;
            justify-content: center
        }

        .reader-container {
            flex: 1;
            overflow: hidden;
            position: relative;
            display: flex
        }

        .sidebar {
            width: 280px;
            height: 100%;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            transition: transform 0.3s ease;
            z-index: var(--z-sidebar);
            display: flex;
            flex-direction: column;
            transform: translateX(-100%)
        }

        .sidebar.active {
            transform: translateX(0)
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border)
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border)
        }

        .sidebar-tab {
            flex: 1;
            text-align: center;
            padding: 0.7rem 0;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition)
        }

        .sidebar-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 500
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem
        }

        .viewer-container {
            flex: 1;
            position: relative;
            overflow: hidden
        }

        .viewer {
            width: 100%;
            height: 100%;
            transition: var(--transition);
            padding: 2rem;
            overflow-y: auto
        }

        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--bg);
            z-index: 10;
            gap: 1.5rem;
            transition: opacity 0.3s ease
        }

        .loading-animation {
            position: relative;
            width: 60px;
            height: 60px
        }

        .loading-animation div {
            position: absolute;
            top: 0;
            width: 11px;
            height: 11px;
            border-radius: 50%;
            background: var(--primary);
            animation-timing-function: cubic-bezier(0, 1, 1, 0)
        }

        .loading-animation div:nth-child(1) {
            left: 6px;
            animation: loading1 0.6s infinite
        }

        .loading-animation div:nth-child(2) {
            left: 6px;
            animation: loading2 0.6s infinite
        }

        .loading-animation div:nth-child(3) {
            left: 26px;
            animation: loading2 0.6s infinite
        }

        .loading-animation div:nth-child(4) {
            left: 45px;
            animation: loading3 0.6s infinite
        }

        @keyframes loading1 {
            0% {
                transform: scale(0)
            }
            100% {
                transform: scale(1)
            }
        }

        @keyframes loading3 {
            0% {
                transform: scale(1)
            }
            100% {
                transform: scale(0)
            }
        }

        @keyframes loading2 {
            0% {
                transform: translate(0, 0)
            }
            100% {
                transform: translate(19px, 0)
            }
        }

        .drophere {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--border);
            padding: 2.5rem;
            text-align: center;
            margin: 1rem;
            border-radius: var(--radius);
            transition: var(--transition);
            max-width: 400px
        }

        .drophere i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem
        }

        .drophere.dragover {
            border-color: var(--primary);
            background: rgba(61, 126, 188, 0.05)
        }

        .footer {
            padding: 0.8rem 1.2rem;
            background: var(--header-bg);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .navigation {
            display: flex;
            align-items: center;
            gap: 0.8rem
        }

        .chapter-title {
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
            padding: 0 0.5rem;
            color: var(--text-light)
        }

        .progress-container {
            display: flex;
            align-items: center;
            flex: 1;
            max-width: 300px;
            gap: 0.5rem
        }

        .progress-bar {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            outline: none;
            cursor: pointer
        }

        .progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer
        }

        .progress-bar::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer
        }

        .progress-text {
            font-size: 0.8rem;
            min-width: 40px;
            text-align: right;
            color: var(--text-light)
        }

        .setting-group {
            margin-bottom: 1.5rem
        }

        .setting-group h4 {
            margin-bottom: 0.7rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem
        }

        .setting-group h4 i {
            color: var(--primary);
            font-size: 0.9rem
        }

        .btn-group {
            display: flex;
            gap: 0.5rem
        }

        .btn-group .btn {
            flex: 1
        }

        .setting-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem
        }

        .setting-label {
            flex: 1;
            font-size: 0.9rem
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 0.5rem
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: var(--transition);
            border-radius: 34px
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--primary)
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(18px)
        }

        .font-select {
            padding: 0.3rem 0.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--bg);
            font-size: 0.9rem;
            color: var(--text);
            cursor: pointer
        }

        .toc-list {
            list-style: none
        }

        .toc-list li {
            margin: 0;
            border-radius: var(--radius);
            transition: var(--transition)
        }

        .toc-list a {
            color: var(--text);
            text-decoration: none;
            display: block;
            padding: 0.5rem;
            border-radius: var(--radius);
            transition: var(--transition);
            font-size: 0.9rem
        }

        .toc-list a:hover {
            background: rgba(61, 126, 188, 0.1)
        }

        .toc-list a.current {
            background: rgba(61, 126, 188, 0.15);
            color: var(--primary);
            font-weight: 500
        }

        .bookmark-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--bg);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            transition: var(--transition)
        }

        .bookmark-item:hover {
            border-color: var(--primary-light);
            box-shadow: var(--shadow-hover)
        }

        .bookmark-info {
            flex: 1;
            overflow: hidden
        }

        .bookmark-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .bookmark-location {
            font-size: 0.8rem;
            color: var(--text-light)
        }

        .bookmark-actions {
            display: flex;
            gap: 0.3rem
        }

        .bookmark-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-light);
            padding: 0.3rem;
            border-radius: var(--radius);
            transition: var(--transition);
            font-size: 0.9rem
        }

        .bookmark-btn:hover {
            color: var(--primary);
            background: rgba(61, 126, 188, 0.1)
        }

        .error-msg {
            color: #e74c3c;
            margin: 1rem;
            padding: 0.8rem;
            border-radius: var(--radius);
            background: rgba(231, 76, 60, 0.1);
            border-left: 3px solid #e74c3c;
            font-size: 0.9rem;
            max-width: 400px;
            display: none
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 0.8rem 1rem;
            background: var(--primary);
            color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: var(--z-toast);
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
            max-width: 300px;
            font-size: 0.9rem
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1
        }

        .shortcuts-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: var(--z-modal);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s
        }

        .shortcuts-container.show {
            opacity: 1;
            visibility: visible
        }

        .shortcuts-modal {
            background: var(--bg);
            border-radius: var(--radius);
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow)
        }

        .shortcuts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border)
        }

        .shortcuts-content {
            padding: 1rem
        }

        .shortcuts-group {
            margin-bottom: 1.5rem
        }

        .shortcuts-group h3 {
            margin-bottom: 0.7rem;
            font-size: 1rem
        }

        .shortcuts-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.7rem
        }

        .shortcut-item {
            display: flex;
            align-items: center;
            gap: 0.5rem
        }

        .shortcut-key {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            background: var(--header-bg);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            font-size: 0.8rem;
            font-family: var(--font-mono);
            min-width: 32px;
            text-align: center
        }

        .shortcut-desc {
            font-size: 0.9rem
        }

        .search-container {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            background: var(--bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: var(--z-modal);
            display: none
        }

        .search-header {
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding: 0.8rem
        }

        .search-input {
            flex: 1;
            border: none;
            padding: 0.5rem;
            font-size: 1rem;
            outline: none;
            background: transparent;
            color: var(--text)
        }

        .search-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            color: var(--text-light);
            transition: var(--transition)
        }

        .search-close:hover {
            color: var(--primary)
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
            padding: 0.5rem
        }

        .search-result {
            padding: 0.7rem;
            cursor: pointer;
            border-radius: var(--radius);
            transition: var(--transition)
        }

        .search-result:hover {
            background: rgba(61, 126, 188, 0.1)
        }

        .search-result-text {
            margin-bottom: 0.3rem
        }

        .search-result-location {
            font-size: 0.8rem;
            color: var(--text-light)
        }

        .search-highlight {
            background: #ffeb3b;
            color: black;
            padding: 0 0.2rem;
            border-radius: 2px
        }

        .fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: var(--transition);
            z-index: 5;
            opacity: 0.7
        }

        .fullscreen-btn:hover {
            opacity: 1;
            background: white
        }

        .highlight-marker {
            background-color: rgba(255, 241, 0, 0.3);
            cursor: pointer;
            transition: var(--transition)
        }

        .highlight-marker:hover {
            background-color: rgba(255, 241, 0, 0.5)
        }

        body.light-theme {
            --text: var(--light-text);
            --bg: var(--light-bg);
            --header-bg: #f5f7fa;
            --sidebar-bg: #f7f9fc;
            --border: #e6eaf0
        }

        body.sepia-theme {
            --text: var(--sepia-text);
            --bg: var(--sepia-bg);
            --header-bg: #efe6d5;
            --sidebar-bg: #f3ece0;
            --border: #e2d9c8
        }

        body.dark-theme {
            --text: var(--dark-text);
            --bg: var(--dark-bg);
            --header-bg: #252525;
            --sidebar-bg: #2a2a2a;
            --border: #444
        }

        .keyboard-focus:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px
        }

        @media (max-width: 768px) {
            .header {
                padding: 0.5rem
            }

            .toolbar {
                gap: 0.3rem
            }

            .toolbar-btn {
                font-size: 1rem;
                padding: 0.4rem
            }

            .navigation {
                flex-wrap: wrap;
                gap: 0.5rem
            }

            .progress-container {
                max-width: none;
                order: 2;
                width: 100%
            }

            .chapter-title {
                max-width: 150px;
                font-size: 0.8rem
            }

            .sidebar {
                width: 100%;
                transform: translateX(-100%)
            }

            .sidebar.active {
                transform: translateX(0)
            }

            .shortcuts-list {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>
<body class="light-theme">
<div class="app-container">
    <header class="header">
        <div class="logo">
            <i class="fas fa-book-open"></i>
            <span>EPUB Reader</span>
        </div>
        <div class="toolbar">
            <button id="upload-btn" class="toolbar-btn" title="Open EPUB">
                <i class="fas fa-folder-open"></i>
            </button>
            <input type="file" id="book-file" accept=".epub" hidden>
            <button id="sidebar-toggle" class="toolbar-btn" title="Toggle Sidebar" disabled>
                <i class="fas fa-bars"></i>
            </button>
            <button id="search-btn" class="toolbar-btn" title="Search" disabled>
                <i class="fas fa-search"></i>
            </button>
            <button id="bookmark-btn" class="toolbar-btn" title="Add Bookmark" disabled>
                <i class="fas fa-bookmark"></i>
            </button>
            <button id="settings-btn" class="toolbar-btn" title="Settings" disabled>
                <i class="fas fa-cog"></i>
            </button>
            <button id="keyboard-btn" class="toolbar-btn" title="Keyboard Shortcuts">
                <i class="fas fa-keyboard"></i>
            </button>
        </div>
    </header>
    <main class="reader-container">
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-tabs">
                <div id="tab-toc" class="sidebar-tab active">Contents</div>
                <div id="tab-bookmarks" class="sidebar-tab">Bookmarks</div>
                <div id="tab-settings" class="sidebar-tab">Settings</div>
            </div>
            <div id="sidebar-content" class="sidebar-content">
                <div id="toc-view" class="tab-view">
                    <div id="toc-content"></div>
                </div>
                <div id="bookmarks-view" class="tab-view" style="display:none">
                    <div id="bookmarks-list">
                        <p>No bookmarks yet.</p>
                    </div>
                </div>
                <div id="settings-view" class="tab-view" style="display:none">
                    <div class="setting-group">
                        <h4><i class="fas fa-font"></i> Typography</h4>
                        <div class="setting-row">
                            <div class="setting-label">Font Family</div>
                            <div class="setting-control">
                                <select id="font-family" class="font-select">
                                    <option value="sans">Sans-serif</option>
                                    <option value="serif">Serif</option>
                                    <option value="mono">Monospace</option>
                                </select>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div class="setting-label">Font Size</div>
                            <div class="setting-control">
                                <button id="font-decrease" class="btn btn-sm btn-outline btn-icon">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button id="font-default" class="btn btn-sm btn-outline">Reset</button>
                                <button id="font-increase" class="btn btn-sm btn-outline btn-icon">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div class="setting-label">Line Spacing</div>
                            <div class="setting-control">
                                <button id="spacing-decrease" class="btn btn-sm btn-outline btn-icon">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button id="spacing-default" class="btn btn-sm btn-outline">Reset</button>
                                <button id="spacing-increase" class="btn btn-sm btn-outline btn-icon">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div class="setting-label">Text Alignment</div>
                            <div class="setting-control">
                                <select id="text-align" class="font-select">
                                    <option value="left">Left</option>
                                    <option value="justify">Justified</option>
                                    <option value="right">Right</option>
                                    <option value="center">Center</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="setting-group">
                        <h4><i class="fas fa-palette"></i> Appearance</h4>
                        <div class="setting-row">
                            <div class="setting-label">Theme</div>
                            <div class="setting-control">
                                <button id="theme-light" class="btn btn-sm btn-outline btn-icon" title="Light">
                                    <i class="fas fa-sun"></i>
                                </button>
                                <button id="theme-sepia" class="btn btn-sm btn-outline btn-icon" title="Sepia">
                                    <i class="fas fa-moon"></i>
                                </button>
                                <button id="theme-dark" class="btn btn-sm btn-outline btn-icon" title="Dark">
                                    <i class="fas fa-star"></i>
                                </button>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div class="setting-label">Margins</div>
                            <div class="setting-control">
                                <button id="margin-decrease" class="btn btn-sm btn-outline btn-icon">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button id="margin-default" class="btn btn-sm btn-outline">Reset</button>
                                <button id="margin-increase" class="btn btn-sm btn-outline btn-icon">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div class="setting-label">Full Justification</div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="justify-toggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="setting-group">
                        <h4><i class="fas fa-sliders-h"></i> Behavior</h4>
                        <div class="setting-row">
                            <div class="setting-label">Page Snap</div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="snap-toggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div class="setting-label">Remember Position</div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="remember-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        <div class="viewer-container">
            <div id="viewer" class="viewer"></div>
            <button id="fullscreen-btn" class="fullscreen-btn" title="Toggle Fullscreen" style="display:none">
                <i class="fas fa-expand"></i>
            </button>
            <div class="loading-screen">
                <div id="drop-area" class="drophere">
                    <i class="fas fa-file-upload"></i>
                    <p>Drag and drop an EPUB file here</p>
                    <p>or</p>
                    <button id="upload-prompt" class="btn">
                        <i class="fas fa-folder-open"></i> Open EPUB
                    </button>
                </div>
                <div id="error-display" class="error-msg"></div>
                <div class="loading-animation" style="display:none">
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
            </div>
        </div>
    </main>
    <footer class="footer">
        <div class="navigation">
            <button id="prev-btn" class="btn" disabled>
                <i class="fas fa-chevron-left"></i> Prev
            </button>
            <div id="chapter-title" class="chapter-title"></div>
        </div>
        <div class="progress-container">
            <input type="range" id="progress-bar" class="progress-bar" min="0" max="100" value="0" disabled>
            <span id="progress-text" class="progress-text">0%</span>
        </div>
        <div class="navigation">
            <button id="next-btn" class="btn" disabled>
                Next <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </footer>
</div>
<div id="search-container" class="search-container">
    <div class="search-header">
        <i class="fas fa-search" style="margin-right: 0.5rem; color: var(--text-light)"></i>
        <input type="text" id="search-input" class="search-input" placeholder="Search in book...">
        <button id="search-close" class="search-close">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div id="search-results" class="search-results"></div>
</div>
<div id="shortcuts-container" class="shortcuts-container">
    <div class="shortcuts-modal">
        <div class="shortcuts-header">
            <h3>Keyboard Shortcuts</h3>
            <button id="shortcuts-close" class="btn-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="shortcuts-content">
            <div class="shortcuts-group">
                <h3>Navigation</h3>
                <div class="shortcuts-list">
                    <div class="shortcut-item">
                        <span class="shortcut-key">←</span>
                        <span class="shortcut-desc">Previous page</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">→</span>
                        <span class="shortcut-desc">Next page</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">Home</span>
                        <span class="shortcut-desc">Go to beginning</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">End</span>
                        <span class="shortcut-desc">Go to end</span>
                    </div>
                </div>
            </div>
            <div class="shortcuts-group">
                <h3>Tools</h3>
                <div class="shortcuts-list">
                    <div class="shortcut-item">
                        <span class="shortcut-key">F</span>
                        <span class="shortcut-desc">Toggle fullscreen</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">S</span>
                        <span class="shortcut-desc">Toggle sidebar</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">B</span>
                        <span class="shortcut-desc">Add bookmark</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">/</span>
                        <span class="shortcut-desc">Search</span>
                    </div>
                </div>
            </div>
            <div class="shortcuts-group">
                <h3>Appearance</h3>
                <div class="shortcuts-list">
                    <div class="shortcut-item">
                        <span class="shortcut-key">+</span>
                        <span class="shortcut-desc">Increase font size</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">-</span>
                        <span class="shortcut-desc">Decrease font size</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">L</span>
                        <span class="shortcut-desc">Light theme</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">D</span>
                        <span class="shortcut-desc">Dark theme</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="toast" class="toast"></div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // DOM Elements
        const fileInput = document.getElementById('book-file');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadPrompt = document.getElementById('upload-prompt');
        const viewer = document.getElementById('viewer');
        const loadingScreen = document.querySelector('.loading-screen');
        const loadingAnimation = document.querySelector('.loading-animation');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        const searchBtn = document.getElementById('search-btn');
        const bookmarkBtn = document.getElementById('bookmark-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const keyboardBtn = document.getElementById('keyboard-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const chapterTitle = document.getElementById('chapter-title');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const tocContent = document.getElementById('toc-content');
        const bookmarksList = document.getElementById('bookmarks-list');
        const dropArea = document.getElementById('drop-area');
        const errorDisplay = document.getElementById('error-display');
        const fontFamilySelect = document.getElementById('font-family');
        const fontIncrease = document.getElementById('font-increase');
        const fontDecrease = document.getElementById('font-decrease');
        const fontDefault = document.getElementById('font-default');
        const spacingIncrease = document.getElementById('spacing-increase');
        const spacingDecrease = document.getElementById('spacing-decrease');
        const spacingDefault = document.getElementById('spacing-default');
        const marginIncrease = document.getElementById('margin-increase');
        const marginDecrease = document.getElementById('margin-decrease');
        const marginDefault = document.getElementById('margin-default');
        const textAlignSelect = document.getElementById('text-align');
        const justifyToggle = document.getElementById('justify-toggle');
        const snapToggle = document.getElementById('snap-toggle');
        const rememberToggle = document.getElementById('remember-toggle');
        const themeLight = document.getElementById('theme-light');
        const themeSepia = document.getElementById('theme-sepia');
        const themeDark = document.getElementById('theme-dark');
        const searchContainer = document.getElementById('search-container');
        const searchInput = document.getElementById('search-input');
        const searchClose = document.getElementById('search-close');
        const searchResults = document.getElementById('search-results');
        const shortcutsContainer = document.getElementById('shortcuts-container');
        const shortcutsClose = document.getElementById('shortcuts-close');
        const toast = document.getElementById('toast');

        // Sidebar tab navigation
        const tabToc = document.getElementById('tab-toc');
        const tabBookmarks = document.getElementById('tab-bookmarks');
        const tabSettings = document.getElementById('tab-settings');
        const tocView = document.getElementById('toc-view');
        const bookmarksView = document.getElementById('bookmarks-view');
        const settingsView = document.getElementById('settings-view');

        // State variables
        let book = null;
        let rendition = null;
        let currentLocation = null;
        let currentChapter = null;
        let bookmarks = [];
        let fontSize = 100;
        let lineSpacing = 1.5;
        let margins = 2;
        let isSearching = false;
        let searchResults_ = [];
        let currentSearchIndex = -1;
        let bookReady = false;

        const MIN_FONT_SIZE = 80;
        const MAX_FONT_SIZE = 160;
        const MIN_LINE_SPACING = 1.2;
        const MAX_LINE_SPACING = 2.2;
        const MIN_MARGIN = 0.5;
        const MAX_MARGIN = 5;

        // Get chapter info safely
        const getChapterInfo = async (href) => {
            if (!book || !book.navigation) return null;

            try {
                // Try the standard navigation.get method first
                if (typeof book.navigation.get === 'function') {
                    return await book.navigation.get(href);
                }

                // Fallback: manually search through the TOC
                if (book.navigation.toc) {
                    const findInToc = (items, href) => {
                        for (const item of items) {
                            if (item.href === href) return item;
                            if (item.subitems && item.subitems.length) {
                                const found = findInToc(item.subitems, href);
                                if (found) return found;
                            }
                        }
                        return null;
                    };

                    return findInToc(book.navigation.toc, href);
                }
            } catch (err) {
                console.error('Error getting chapter info:', err);
            }

            // If we got here, we couldn't find the chapter info
            return {
                label: 'Unknown Chapter'
            };
        };

        // Check dependencies
        const checkDependencies = () => {
            if (typeof JSZip === 'undefined') {
                showError('Error: JSZip library not loaded. Check your internet connection and refresh the page.');
                return false;
            }

            if (typeof ePub === 'undefined') {
                showError('Error: EPUB.js library not loaded. Check your internet connection and refresh the page.');
                return false;
            }

            return true;
        };

        // Load saved preferences
        const loadPreferences = () => {
            try {
                const savedPrefs = localStorage.getItem('epubReaderPrefs');
                if (savedPrefs) {
                    const prefs = JSON.parse(savedPrefs);
                    fontSize = prefs.fontSize || 100;
                    lineSpacing = prefs.lineSpacing || 1.5;
                    margins = prefs.margins || 2;
                    fontFamilySelect.value = prefs.fontFamily || 'sans';
                    textAlignSelect.value = prefs.textAlign || 'left';
                    justifyToggle.checked = prefs.justify || false;
                    snapToggle.checked = prefs.snapToPage || false;
                    rememberToggle.checked = prefs.rememberPosition !== false;
                    setTheme(prefs.theme || 'light');
                }
            } catch (e) {
                console.error('Error loading preferences:', e);
            }
        };

        // Load saved bookmarks
        const loadBookmarks = () => {
            try {
                const savedBookmarks = localStorage.getItem('epubReaderBookmarks');
                if (savedBookmarks) {
                    bookmarks = JSON.parse(savedBookmarks);
                }
            } catch (e) {
                console.error('Error loading bookmarks:', e);
                bookmarks = [];
            }
        };

        // Save preferences
        const savePreferences = () => {
            try {
                const prefs = {
                    fontSize,
                    lineSpacing,
                    margins,
                    fontFamily: fontFamilySelect.value,
                    textAlign: textAlignSelect.value,
                    justify: justifyToggle.checked,
                    snapToPage: snapToggle.checked,
                    rememberPosition: rememberToggle.checked,
                    theme: document.body.className.replace('-theme', '')
                };
                localStorage.setItem('epubReaderPrefs', JSON.stringify(prefs));
            } catch (e) {
                console.error('Error saving preferences:', e);
            }
        };

        // Show error message
        const showError = (message) => {
            errorDisplay.textContent = message;
            errorDisplay.style.display = 'block';
            loadingAnimation.style.display = 'none';
            console.error(message);
        };

        // Hide error message
        const hideError = () => {
            errorDisplay.style.display = 'none';
        };

        // Show loading animation
        const showLoading = () => {
            loadingAnimation.style.display = 'block';
            dropArea.style.display = 'none';
        };

        // Hide loading animation
        const hideLoading = () => {
            loadingAnimation.style.display = 'none';
            dropArea.style.display = 'flex';
        };

        // Show toast notification
        const showToast = (message, duration = 3000) => {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        };

        // Handle file upload
        const handleFileUpload = (e) => {
            const file = e.target?.files?.[0] || e;

            if (!file) {
                console.log('No file selected');
                return;
            }

            if (!file.name.endsWith('.epub')) {
                showError('Please select a valid EPUB file (.epub)');
                return;
            }

            console.log('Loading file:', file.name);
            hideError();
            showLoading();

            try {
                loadBook(file);
            } catch (err) {
                console.error('Error in handleFileUpload:', err);
                showError(`Failed to process file: ${err.message}`);
                hideLoading();
            }
        };

        // Load book
        const loadBook = (file) => {
            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    console.log('File loaded, initializing book...');
                    initializeBook(e.target.result, file.name);
                } catch (error) {
                    console.error('Error initializing book:', error);
                    showError(`Failed to load book: ${error.message}`);
                    hideLoading();
                }
            };

            reader.onerror = function (error) {
                console.error('FileReader error:', error);
                showError('Failed to read the file');
                hideLoading();
            };

            try {
                reader.readAsArrayBuffer(file);
            } catch (err) {
                console.error('Error reading file:', err);
                showError(`Failed to read file: ${err.message}`);
                hideLoading();
            }
        };

        // Initialize book
        const initializeBook = (arrayBuffer, filename) => {
            try {
                if (!checkDependencies()) {
                    return;
                }

                // Reset book state
                bookReady = false;

                console.log('Creating book object...');
                book = ePub(arrayBuffer);

                // Set up error handlers
                book.on('openFailed', (err) => {
                    console.error('Book open failed:', err);
                    showError(`Failed to open book: ${err.message || 'Unknown error'}`);
                    hideLoading();
                });

                // Handle metadata
                book.loaded.metadata
                    .then(metadata => {
                        console.log('Metadata loaded');
                        document.title = `${metadata.title || filename} - EPUB Reader`;
                        chapterTitle.textContent = metadata.title || 'Unknown Book';
                    })
                    .catch(err => {
                        console.error('Metadata error:', err);
                        document.title = `${filename} - EPUB Reader`;
                        chapterTitle.textContent = 'Unknown Book';
                    });

                console.log('Creating rendition...');
                rendition = book.renderTo('viewer', {
                    width: '100%',
                    height: '100%',
                    spread: 'none',
                    allowScriptedContent: false,
                    flow: snapToggle.checked ? 'paginated' : 'scrolled-doc'
                });

                // Handle rendition errors
                rendition.on('layoutFailed', (err) => {
                    console.error('Rendition layout failed:', err);
                    showError(`Failed to render book: ${err.message || 'Unknown error'}`);
                });

                // Apply initial styles
                updateStyles();
                fullscreenBtn.style.display = 'flex';

                console.log('Processing book...');
                book.ready
                    .then(() => {
                        console.log('Book ready, generating locations...');
                        return book.locations.generate(1600)
                            .then(() => {
                                console.log('Locations generated, displaying book...');
                                bookReady = true;
                                return rendition.display();
                            })
                            .then(() => {
                                console.log('Book displayed successfully');
                                loadingScreen.style.display = 'none';
                                enableControls();
                                setupEventListeners();
                                generateTableOfContents();
                                updateBookmarksList();

                                if (rememberToggle.checked) {
                                    restoreReadingProgress();
                                }

                                hideLoading();
                                showToast('Book loaded successfully');
                            })
                            .catch(err => {
                                showError(`Failed to display book: ${err.message}`);
                                console.error('Display error:', err);
                            });
                    })
                    .catch(err => {
                        showError(`Book failed to load: ${err.message}`);
                        console.error('Book ready error:', err);
                    });
            } catch (error) {
                showError(`Failed to initialize book: ${error.message}`);
                console.error('Initialization error:', error);
            }
        };

        // Enable controls
        const enableControls = () => {
            sidebarToggle.disabled = false;
            searchBtn.disabled = false;
            bookmarkBtn.disabled = false;
            settingsBtn.disabled = false;
            prevBtn.disabled = false;
            nextBtn.disabled = false;
            progressBar.disabled = false;
        };

        // Set up event listeners
        const setupEventListeners = () => {
            // Navigation
            prevBtn.addEventListener('click', () => {
                if (rendition) rendition.prev();
            });

            nextBtn.addEventListener('click', () => {
                if (rendition) rendition.next();
            });

            // Keyboard navigation and shortcuts
            document.addEventListener('keydown', (e) => {
                if (!book || isSearching) return;

                switch (e.key) {
                    case 'ArrowLeft':
                        if (rendition) rendition.prev();
                        break;
                    case 'ArrowRight':
                        if (rendition) rendition.next();
                        break;
                    case 'Home':
                        if (book) {
                            try {
                                book.cover().then(url => rendition.display(url));
                            } catch (err) {
                                console.error('Error navigating to cover:', err);
                                rendition.display(0); // Fallback: go to first page
                            }
                        }
                        break;
                    case 'End':
                        if (book && book.locations) {
                            try {
                                book.locations.length().then(length => {
                                    if (length > 0) {
                                        const cfi = book.locations.cfiFromLocation(length - 1);
                                        rendition.display(cfi);
                                    }
                                });
                            } catch (err) {
                                console.error('Error navigating to end:', err);
                            }
                        }
                        break;
                    case 'f':
                    case 'F':
                        toggleFullscreen();
                        break;
                    case 's':
                    case 'S':
                        toggleSidebar();
                        break;
                    case 'b':
                    case 'B':
                        addBookmark();
                        break;
                    case '/':
                        openSearch();
                        break;
                    case '+':
                    case '=':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            increaseFontSize();
                        }
                        break;
                    case '-':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            decreaseFontSize();
                        }
                        break;
                    case '0':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            resetFontSize();
                        }
                        break;
                    case 'l':
                    case 'L':
                        setTheme('light');
                        break;
                    case 'd':
                    case 'D':
                        setTheme('dark');
                        break;
                }
            });

            // Book events
            if (rendition) {
                rendition.on('relocated', async (location) => {
                    try {
                        currentLocation = location;

                        if (book && location && bookReady) {
                            // Get chapter info safely
                            const chapter = await getChapterInfo(location.start.href);

                            if (chapter) {
                                currentChapter = chapter;
                                chapterTitle.textContent = chapter.label || '';

                                // Update active chapter in TOC
                                try {
                                    const tocLinks = document.querySelectorAll('.toc-list a');
                                    tocLinks.forEach(link => {
                                        link.classList.remove('current');
                                        if (link.getAttribute('href') === location.start.href) {
                                            link.classList.add('current');
                                        }
                                    });
                                } catch (err) {
                                    console.warn('Error updating TOC highlight:', err);
                                }
                            } else {
                                chapterTitle.textContent = 'Current Location';
                            }

                            // Update progress
                            try {
                                if (book.locations && typeof book.locations.percentageFromCfi === 'function') {
                                    const progress = book.locations.percentageFromCfi(location.start.cfi);
                                    progressBar.value = progress * 100;
                                    progressText.textContent = `${Math.round(progress * 100)}%`;

                                    if (rememberToggle.checked) {
                                        saveReadingProgress(location.start.cfi);
                                    }
                                }
                            } catch (err) {
                                console.warn('Error updating progress:', err);
                            }
                        }
                    } catch (err) {
                        console.error('Error in relocated event:', err);
                    }
                });
            }

            // Sidebar toggle
            sidebarToggle.addEventListener('click', toggleSidebar);

            // Bookmark button
            bookmarkBtn.addEventListener('click', addBookmark);

            // Progress bar navigation
            progressBar.addEventListener('input', () => {
                if (!book || !rendition || !book.locations) return;

                try {
                    const percentage = progressBar.value / 100;
                    if (typeof book.locations.cfiFromPercentage === 'function') {
                        const cfi = book.locations.cfiFromPercentage(percentage);
                        rendition.display(cfi);
                    }
                } catch (err) {
                    console.error('Error navigating with progress bar:', err);
                }
            });

            // Settings tab triggers
            settingsBtn.addEventListener('click', () => {
                if (!sidebar.classList.contains('active')) {
                    toggleSidebar();
                }
                setActiveTab('settings');
            });

            // Appearance settings
            fontIncrease.addEventListener('click', increaseFontSize);
            fontDecrease.addEventListener('click', decreaseFontSize);
            fontDefault.addEventListener('click', resetFontSize);
            spacingIncrease.addEventListener('click', increaseLineSpacing);
            spacingDecrease.addEventListener('click', decreaseLineSpacing);
            spacingDefault.addEventListener('click', resetLineSpacing);
            marginIncrease.addEventListener('click', increaseMargins);
            marginDecrease.addEventListener('click', decreaseMargins);
            marginDefault.addEventListener('click', resetMargins);
            fontFamilySelect.addEventListener('change', updateStyles);
            textAlignSelect.addEventListener('change', updateStyles);
            justifyToggle.addEventListener('change', updateStyles);
            snapToggle.addEventListener('change', toggleSnapToPage);
            themeLight.addEventListener('click', () => setTheme('light'));
            themeSepia.addEventListener('click', () => setTheme('sepia'));
            themeDark.addEventListener('click', () => setTheme('dark'));

            // Sidebar tabs
            tabToc.addEventListener('click', () => {
                setActiveTab('toc');
            });

            tabBookmarks.addEventListener('click', () => {
                setActiveTab('bookmarks');
            });

            tabSettings.addEventListener('click', () => {
                setActiveTab('settings');
            });

            // Search
            searchBtn.addEventListener('click', openSearch);
            searchClose.addEventListener('click', closeSearch);
            searchInput.addEventListener('keyup', e => {
                if (e.key === 'Escape') {
                    closeSearch();
                    return;
                }

                if (e.key === 'Enter') {
                    performSearch(searchInput.value);
                }
            });

            // Fullscreen toggle
            fullscreenBtn.addEventListener('click', toggleFullscreen);

            // Keyboard shortcuts modal
            keyboardBtn.addEventListener('click', openShortcutsModal);
            shortcutsClose.addEventListener('click', closeShortcutsModal);
            shortcutsContainer.addEventListener('click', e => {
                if (e.target === shortcutsContainer) {
                    closeShortcutsModal();
                }
            });
        };

        // Set up drag and drop
        const setupDragAndDrop = () => {
            const preventDefaults = e => {
                e.preventDefault();
                e.stopPropagation();
            };

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.add('dragover');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.remove('dragover');
                }, false);
            });

            dropArea.addEventListener('drop', e => {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length) {
                    handleFileUpload(files[0]);
                }
            }, false);
        };

        // Toggle sidebar visibility
        const toggleSidebar = () => {
            sidebar.classList.toggle('active');

            if (sidebar.classList.contains('active') && !document.querySelector('.sidebar-tab.active')) {
                setActiveTab('toc');
            }
        };

        // Set active sidebar tab
        const setActiveTab = (tab) => {
            const tabs = document.querySelectorAll('.sidebar-tab');
            const views = document.querySelectorAll('.tab-view');

            tabs.forEach(t => t.classList.remove('active'));
            views.forEach(v => v.style.display = 'none');

            switch (tab) {
                case 'toc':
                    tabToc.classList.add('active');
                    tocView.style.display = 'block';
                    break;
                case 'bookmarks':
                    tabBookmarks.classList.add('active');
                    bookmarksView.style.display = 'block';
                    break;
                case 'settings':
                    tabSettings.classList.add('active');
                    settingsView.style.display = 'block';
                    break;
            }
        };

        // Generate table of contents
        const generateTableOfContents = () => {
            if (!book) return;

            const generateToc = (toc) => {
                tocContent.innerHTML = '';

                if (!toc || toc.length === 0) {
                    tocContent.innerHTML = '<p>No table of contents available</p>';
                    return;
                }

                const list = document.createElement('ul');
                list.className = 'toc-list';

                toc.forEach(chapter => {
                    const item = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = chapter.label || 'Unnamed section';
                    link.setAttribute('href', chapter.href);
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        rendition.display(chapter.href);

                        if (window.innerWidth < 768) {
                            toggleSidebar();
                        }
                    });

                    item.appendChild(link);

                    if (chapter.subitems && chapter.subitems.length > 0) {
                        const subList = document.createElement('ul');
                        subList.className = 'toc-list';

                        chapter.subitems.forEach(subchapter => {
                            const subItem = document.createElement('li');
                            const subLink = document.createElement('a');
                            subLink.href = '#';
                            subLink.textContent = subchapter.label || 'Unnamed section';
                            subLink.setAttribute('href', subchapter.href);
                            subLink.style.paddingLeft = '1.5rem';
                            subLink.addEventListener('click', (e) => {
                                e.preventDefault();
                                rendition.display(subchapter.href);

                                if (window.innerWidth < 768) {
                                    toggleSidebar();
                                }
                            });

                            subItem.appendChild(subLink);
                            subList.appendChild(subItem);
                        });

                        item.appendChild(subList);
                    }

                    list.appendChild(item);
                });

                tocContent.appendChild(list);
            };

            try {
                book.loaded.navigation
                    .then(nav => {
                        if (nav && nav.toc) {
                            generateToc(nav.toc);
                        } else {
                            // Fallback: try to generate a simple TOC from the spine
                            if (book.spine && book.spine.items && book.spine.items.length > 0) {
                                const simpleToc = book.spine.items.map((item, index) => {
                                    return {
                                        label: `Section ${index + 1}`,
                                        href: item.href
                                    };
                                });
                                generateToc(simpleToc);
                            } else {
                                tocContent.innerHTML = '<p>No table of contents available</p>';
                            }
                        }
                    })
                    .catch(err => {
                        console.error('Error loading TOC:', err);
                        tocContent.innerHTML = '<p>Failed to load table of contents</p>';
                    });
            } catch (err) {
                console.error('Error generating table of contents:', err);
                tocContent.innerHTML = '<p>Failed to generate table of contents</p>';
            }
        };

        // Add bookmark
        const addBookmark = async () => {
            if (!book || !currentLocation || !bookReady) {
                showToast('Cannot add bookmark at this time');
                return;
            }

            try {
                const existingBookmark = bookmarks.find(b => b.cfi === currentLocation.start.cfi);

                if (existingBookmark) {
                    showToast('Bookmark already exists');
                    return;
                }

                // Get chapter info safely
                let chapterName = 'Unknown location';
                try {
                    const chapter = await getChapterInfo(currentLocation.start.href);
                    if (chapter) {
                        chapterName = chapter.label || 'Unknown section';
                    }
                } catch (err) {
                    console.warn('Error getting chapter for bookmark:', err);
                }

                let progressPercentage = 0;
                try {
                    if (book.locations && typeof book.locations.percentageFromCfi === 'function') {
                        progressPercentage = book.locations.percentageFromCfi(currentLocation.start.cfi);
                    }
                } catch (err) {
                    console.warn('Error calculating progress for bookmark:', err);
                }

                const progressText = `${Math.round(progressPercentage * 100)}%`;

                let bookTitle = 'Unknown Book';
                try {
                    const metadata = book.packaging.metadata;
                    bookTitle = metadata.title || 'Unknown Book';
                } catch (err) {
                    console.warn('Error getting book title for bookmark:', err);
                }

                const bookmark = {
                    bookTitle,
                    chapterName,
                    cfi: currentLocation.start.cfi,
                    href: currentLocation.start.href,
                    progress: progressText,
                    created: new Date().toISOString()
                };

                bookmarks.push(bookmark);
                saveBookmarks();
                updateBookmarksList();
                showToast('Bookmark added');
            } catch (err) {
                console.error('Error adding bookmark:', err);
                showToast('Failed to add bookmark');
            }
        };

        // Remove bookmark
        const removeBookmark = (cfi) => {
            bookmarks = bookmarks.filter(b => b.cfi !== cfi);
            saveBookmarks();
            updateBookmarksList();
            showToast('Bookmark removed');
        };

        // Update bookmarks list
        const updateBookmarksList = () => {
            if (!book) return;

            try {
                let bookTitle = 'Unknown Book';
                try {
                    const metadata = book.packaging.metadata;
                    bookTitle = metadata.title || 'Unknown Book';
                } catch (err) {
                    console.warn('Error getting book title for bookmarks list:', err);
                }

                const currentBookmarks = bookmarks.filter(b => b.bookTitle === bookTitle);

                if (currentBookmarks.length === 0) {
                    bookmarksList.innerHTML = '<p>No bookmarks for this book.</p>';
                    return;
                }

                bookmarksList.innerHTML = '';

                currentBookmarks.forEach(bookmark => {
                    const item = document.createElement('div');
                    item.className = 'bookmark-item';

                    const info = document.createElement('div');
                    info.className = 'bookmark-info';

                    const title = document.createElement('div');
                    title.className = 'bookmark-title';
                    title.textContent = bookmark.chapterName;

                    const location = document.createElement('div');
                    location.className = 'bookmark-location';
                    location.textContent = bookmark.progress;

                    info.appendChild(title);
                    info.appendChild(location);

                    const actions = document.createElement('div');
                    actions.className = 'bookmark-actions';

                    const goToBtn = document.createElement('button');
                    goToBtn.className = 'bookmark-btn';
                    goToBtn.innerHTML = '<i class="fas fa-arrow-right"></i>';
                    goToBtn.title = 'Go to bookmark';
                    goToBtn.addEventListener('click', () => {
                        rendition.display(bookmark.cfi);

                        if (window.innerWidth < 768) {
                            toggleSidebar();
                        }
                    });

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'bookmark-btn';
                    removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    removeBtn.title = 'Remove bookmark';
                    removeBtn.addEventListener('click', () => {
                        removeBookmark(bookmark.cfi);
                    });

                    actions.appendChild(goToBtn);
                    actions.appendChild(removeBtn);

                    item.appendChild(info);
                    item.appendChild(actions);

                    bookmarksList.appendChild(item);
                });
            } catch (err) {
                console.error('Error updating bookmarks list:', err);
                bookmarksList.innerHTML = '<p>Error loading bookmarks.</p>';
            }
        };

        // Save bookmarks
        const saveBookmarks = () => {
            try {
                localStorage.setItem('epubReaderBookmarks', JSON.stringify(bookmarks));
            } catch (err) {
                console.error('Error saving bookmarks:', err);
            }
        };

        // Update styles based on settings
        const updateStyles = () => {
            if (!rendition) return;

            try {
                const fontFamily = fontFamilySelect.value;
                const textAlign = textAlignSelect.value;
                const justify = justifyToggle.checked;
                let fontStack;

                switch (fontFamily) {
                    case 'serif':
                        fontStack = 'Georgia, "Times New Roman", serif';
                        break;
                    case 'mono':
                        fontStack = 'Consolas, "Courier New", monospace';
                        break;
                    default:
                        fontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                }

                rendition.themes.override('body', {
                    fontFamily: fontStack,
                    fontSize: `${fontSize}%`,
                    lineHeight: lineSpacing,
                    textAlign: justify ? 'justify' : textAlign,
                    padding: `0 ${margins}rem`,
                    maxWidth: '100%',
                    color: 'var(--text)',
                    background: 'var(--bg)'
                });

                savePreferences();
            } catch (err) {
                console.error('Error updating styles:', err);
            }
        };

        // Font size controls
        const increaseFontSize = () => {
            fontSize = Math.min(fontSize + 10, MAX_FONT_SIZE);
            updateStyles();
        };

        const decreaseFontSize = () => {
            fontSize = Math.max(fontSize - 10, MIN_FONT_SIZE);
            updateStyles();
        };

        const resetFontSize = () => {
            fontSize = 100;
            updateStyles();
        };

        // Line spacing controls
        const increaseLineSpacing = () => {
            lineSpacing = Math.min(parseFloat((lineSpacing + 0.1).toFixed(1)), MAX_LINE_SPACING);
            updateStyles();
        };

        const decreaseLineSpacing = () => {
            lineSpacing = Math.max(parseFloat((lineSpacing - 0.1).toFixed(1)), MIN_LINE_SPACING);
            updateStyles();
        };

        const resetLineSpacing = () => {
            lineSpacing = 1.5;
            updateStyles();
        };

        // Margin controls
        const increaseMargins = () => {
            margins = Math.min(parseFloat((margins + 0.5).toFixed(1)), MAX_MARGIN);
            updateStyles();
        };

        const decreaseMargins = () => {
            margins = Math.max(parseFloat((margins - 0.5).toFixed(1)), MIN_MARGIN);
            updateStyles();
        };

        const resetMargins = () => {
            margins = 2;
            updateStyles();
        };

        // Toggle snap to page
        const toggleSnapToPage = () => {
            if (!rendition || !book) return;

            try {
                const snap = snapToggle.checked;

                // Save current location
                const currentCfi = currentLocation?.start?.cfi;

                // Re-render with new flow mode
                rendition.destroy();

                rendition = book.renderTo('viewer', {
                    width: '100%',
                    height: '100%',
                    spread: 'none',
                    flow: snap ? 'paginated' : 'scrolled-doc'
                });

                // Restore styles
                updateStyles();

                // Setup relocated event with safe handling
                rendition.on('relocated', async (location) => {
                    try {
                        currentLocation = location;

                        if (book && location && bookReady) {
                            // Get chapter info safely
                            const chapter = await getChapterInfo(location.start.href);

                            if (chapter) {
                                currentChapter = chapter;
                                chapterTitle.textContent = chapter.label || '';

                                // Update active chapter in TOC
                                try {
                                    const tocLinks = document.querySelectorAll('.toc-list a');
                                    tocLinks.forEach(link => {
                                        link.classList.remove('current');
                                        if (link.getAttribute('href') === location.start.href) {
                                            link.classList.add('current');
                                        }
                                    });
                                } catch (err) {
                                    console.warn('Error updating TOC highlight:', err);
                                }
                            } else {
                                chapterTitle.textContent = 'Current Location';
                            }

                            // Update progress
                            try {
                                if (book.locations && typeof book.locations.percentageFromCfi === 'function') {
                                    const progress = book.locations.percentageFromCfi(location.start.cfi);
                                    progressBar.value = progress * 100;
                                    progressText.textContent = `${Math.round(progress * 100)}%`;

                                    if (rememberToggle.checked) {
                                        saveReadingProgress(location.start.cfi);
                                    }
                                }
                            } catch (err) {
                                console.warn('Error updating progress:', err);
                            }
                        }
                    } catch (err) {
                        console.error('Error in relocated event:', err);
                    }
                });

                // Restore location
                if (currentCfi) {
                    rendition.display(currentCfi).catch(err => {
                        console.error('Error restoring position after mode change:', err);
                        rendition.display(); // Fallback to first page
                    });
                } else {
                    rendition.display();
                }

                savePreferences();
                showToast(snap ? 'Page snap enabled' : 'Scrolling enabled');
            } catch (err) {
                console.error('Error toggling page snap:', err);
                showToast('Failed to change page mode');
            }
        };

        // Set theme
        const setTheme = (theme) => {
            document.body.className = '';
            document.body.classList.add(`${theme}-theme`);

            // Update theme buttons
            themeLight.classList.remove('active');
            themeSepia.classList.remove('active');
            themeDark.classList.remove('active');

            switch (theme) {
                case 'light':
                    themeLight.classList.add('active');
                    break;
                case 'sepia':
                    themeSepia.classList.add('active');
                    break;
                case 'dark':
                    themeDark.classList.add('active');
                    break;
            }

            updateStyles();
            savePreferences();
        };

        // Toggle fullscreen
        const toggleFullscreen = () => {
            const viewerContainer = document.querySelector('.viewer-container');

            try {
                if (!document.fullscreenElement) {
                    if (viewerContainer.requestFullscreen) {
                        viewerContainer.requestFullscreen();
                    } else if (viewerContainer.webkitRequestFullscreen) {
                        viewerContainer.webkitRequestFullscreen();
                    } else if (viewerContainer.msRequestFullscreen) {
                        viewerContainer.msRequestFullscreen();
                    }

                    fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }

                    fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                }
            } catch (err) {
                console.error('Error toggling fullscreen:', err);
            }
        };

        // Search functionality
        const openSearch = () => {
            if (!book) return;

            searchContainer.style.display = 'block';
            searchInput.focus();
            isSearching = true;
        };

        const closeSearch = () => {
            searchContainer.style.display = 'none';
            searchInput.value = '';
            searchResults.innerHTML = '';
            isSearching = false;
        };

        const performSearch = (query) => {
            if (!query.trim() || !book) return;

            searchResults.innerHTML = '<p>Searching...</p>';

            try {
                book.search(query).then(results => {
                    searchResults_ = results;
                    searchResults.innerHTML = '';

                    if (results.length === 0) {
                        searchResults.innerHTML = '<p>No results found</p>';
                        return;
                    }

                    results.forEach((result, i) => {
                        const item = document.createElement('div');
                        item.className = 'search-result';

                        // Create excerpt with highlighted search term
                        let excerpt = result.excerpt;
                        const regex = new RegExp(`(${query})`, 'gi');
                        excerpt = excerpt.replace(regex, '<span class="search-highlight">$1</span>');

                        const text = document.createElement('div');
                        text.className = 'search-result-text';
                        text.innerHTML = excerpt;

                        const location = document.createElement('div');
                        location.className = 'search-result-location';
                        location.textContent = 'Go to location';

                        // Try to get chapter info but don't block rendering
                        getChapterInfo(result.cfi).then(chapter => {
                            if (chapter) {
                                location.textContent = chapter.label || 'Unknown location';
                            }
                        }).catch(() => {
                            // If it fails, just leave the default text
                        });

                        item.appendChild(text);
                        item.appendChild(location);

                        item.addEventListener('click', () => {
                            rendition.display(result.cfi);
                            closeSearch();
                        });

                        searchResults.appendChild(item);
                    });
                }).catch(err => {
                    console.error('Search error:', err);
                    searchResults.innerHTML = '<p>Search failed. Please try again.</p>';
                });
            } catch (err) {
                console.error('Error performing search:', err);
                searchResults.innerHTML = '<p>Search functionality is not available for this book.</p>';
            }
        };

        // Keyboard shortcuts modal
        const openShortcutsModal = () => {
            shortcutsContainer.classList.add('show');
        };

        const closeShortcutsModal = () => {
            shortcutsContainer.classList.remove('show');
        };

        // Save reading progress
        const saveReadingProgress = (cfi) => {
            if (!book || !bookReady) return;

            try {
                let bookTitle = 'Unknown Book';
                let author = 'Unknown Author';

                try {
                    const metadata = book.packaging.metadata;
                    bookTitle = metadata.title || 'Unknown Book';
                    author = metadata.creator || 'Unknown Author';
                } catch (err) {
                    console.warn('Error getting book metadata for saving progress:', err);
                }

                let coverPath = null;
                try {
                    coverPath = book.package.coverPath;
                } catch (err) {
                    console.warn('Error getting cover path:', err);
                }

                const bookData = {
                    title: bookTitle,
                    author: author,
                    cover: coverPath,
                    cfi: cfi,
                    progress: progressBar.value,
                    lastRead: new Date().toISOString()
                };

                // Store for current book
                localStorage.setItem(`epubReader_progress_${bookData.title}`, JSON.stringify(bookData));

                // Store last read book
                localStorage.setItem('epubReaderLastBook', JSON.stringify(bookData));
            } catch (e) {
                console.error('Error saving reading progress:', e);
            }
        };

        // Restore reading progress
        const restoreReadingProgress = () => {
            if (!book || !bookReady) return;

            try {
                let bookTitle = 'Unknown Book';

                try {
                    const metadata = book.packaging.metadata;
                    bookTitle = metadata.title || 'Unknown Book';
                } catch (err) {
                    console.warn('Error getting book title for restoring progress:', err);
                }

                const savedProgress = localStorage.getItem(`epubReader_progress_${bookTitle}`);

                if (savedProgress) {
                    const progressData = JSON.parse(savedProgress);

                    if (progressData.cfi) {
                        rendition.display(progressData.cfi)
                            .then(() => {
                                showToast('Resumed from last position');
                            })
                            .catch(err => {
                                console.error('Error restoring position:', err);
                                rendition.display(); // Fallback to first page
                            });
                    }
                }
            } catch (e) {
                console.error('Error restoring reading progress:', e);
            }
        };

        // Initialize the app
        const initApp = () => {
            try {
                console.log('Initializing EPUB Reader...');
                loadPreferences();
                loadBookmarks();

                if (!checkDependencies()) {
                    return;
                }

                // Connect upload buttons
                uploadBtn.addEventListener('click', () => {
                    fileInput.click();
                });

                uploadPrompt.addEventListener('click', () => {
                    fileInput.click();
                });

                // Handle file input change
                fileInput.addEventListener('change', handleFileUpload);

                // Setup keyboard shortcuts button
                keyboardBtn.addEventListener('click', openShortcutsModal);

                // Setup drag and drop
                setupDragAndDrop();

                console.log('EPUB Reader initialized successfully');
            } catch (err) {
                console.error('Error initializing app:', err);
                showError(`Failed to initialize app: ${err.message}`);
            }
        };

        // Run initialization
        window.addEventListener('error', (event) => {
            console.error('Global error caught:', event.error);
            showError(`An error occurred: ${event.error?.message || 'Unknown error'}`);
        });

        initApp();
    });
</script>
</body>
</html>