<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Favicon Studio Pro - Professional Favicon Generator Tool</title>
    <meta name="description" content="Create professional-grade favicons for any website or app with Favicon Studio Pro. Design, customize, and download favicons in multiple sizes and formats.">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.gptgames.dev/tools/favicon_generator.html">
    <meta property="og:title" content="Favicon Studio Pro - Create Professional Favicons">
    <meta property="og:description" content="Design and generate custom favicons with advanced editing tools. Export in multiple sizes and formats for perfect website branding.">
    <meta property="og:image" content="https://www.gptgames.dev/screenshots/screenshot_169.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://www.gptgames.dev/tools/favicon_generator.html">
    <meta name="twitter:title" content="Favicon Studio Pro - Professional Favicon Generator">
    <meta name="twitter:description" content="Create custom favicons with this free online tool. Design, edit, and export website icons in multiple formats and sizes.">
    <meta name="twitter:image" content="https://www.gptgames.dev/screenshots/screenshot_169.png">

    <meta name="keywords" content="favicon generator, favicon maker, website icon, app icon, favicon creator, free favicon tool, custom favicon, icon designer, web design tools">
    <meta name="author" content="Claude 3.7 Sonnet, Tobias M√ºller">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üñºÔ∏è</text></svg>">

    <link rel="canonical" href="https://www.gptgames.dev/tools/favicon_generator.html">

    <meta name="application-name" content="Favicon Studio Pro">
    <meta name="apple-mobile-web-app-title" content="Favicon Studio Pro">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#4361ee">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üñºÔ∏è</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --primary-color: #4361ee;
            --primary-hover: #3a56d4;
            --secondary-color: #f72585;
            --accent-color: #7209b7;
            --panel-bg: #fff;
            --panel-border: #e9ecef;
            --button-bg: #4361ee;
            --button-text: #fff;
            --input-bg: #fff;
            --input-border: #ced4da;
            --shadow: 0 4px 6px rgba(0, 0, 0, .05);
            --radius: 8px;
            --transition: all .3s ease
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121212;
                --text-color: #f8f9fa;
                --primary-color: #4cc9f0;
                --primary-hover: #67d4f3;
                --secondary-color: #f72585;
                --accent-color: #7209b7;
                --panel-bg: #1e1e1e;
                --panel-border: #2d2d2d;
                --button-bg: #4cc9f0;
                --button-text: #121212;
                --input-bg: #2d2d2d;
                --input-border: #3d3d3d;
                --shadow: 0 4px 6px rgba(0, 0, 0, .2)
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color .3s, color .3s
        }

        body {
            font-family: Inter, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6
        }

        header {
            text-align: center;
            padding: 1.5rem;
            background-color: var(--panel-bg);
            box-shadow: var(--shadow);
            position: relative;
            z-index: 10
        }

        h1 {
            font-size: 2rem;
            margin-bottom: .5rem;
            display: inline-block;
            position: relative;
        }

        .beta-badge {
            position: absolute;
            top: 0;
            right: -25px;
            background-color: var(--accent-color);
            color: rgba(255, 255, 255, 1);
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 10px;
            font-weight: bold;
            transform: rotate(15deg);
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--primary-color)
        }

        h3 {
            font-size: 1.2rem;
            margin-bottom: .8rem;
            color: var(--primary-color)
        }

        main {
            max-width: 1400px;
            margin: 1rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns:300px 1fr 300px;
            grid-template-rows:auto 1fr auto;
            gap: 1rem;
            grid-template-areas:"tools canvas preview" "layers canvas history" "export export export"
        }

        .panel {
            background-color: var(--panel-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.2rem;
            border: 1px solid var(--panel-border);
            overflow: hidden
        }

        #tools-panel {
            grid-area: tools
        }

        #layers-panel {
            grid-area: layers;
            display: flex;
            flex-direction: column;
            max-height: 300px
        }

        #layers-list {
            overflow-y: auto;
            flex-grow: 1;
            max-height: calc(300px - 3rem);
            display: flex;
            flex-direction: column-reverse;
            justify-content: flex-end;
        }

        #canvas-panel {
            grid-area: canvas;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        #preview-panel {
            grid-area: preview;
        }

        #history-panel {
            grid-area: history;
            max-height: 300px;
        }

        #export-panel {
            grid-area: export
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
            margin-bottom: 1rem
        }

        button, .btn {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: .6rem 1.2rem;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: .95rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .5rem;
            font-weight: 500
        }

        button:hover, .btn:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, .1)
        }

        button:active, .btn:active {
            transform: translateY(0)
        }

        button i, .btn i {
            font-size: 1rem
        }

        .btn-sm {
            padding: .4rem .8rem;
            font-size: .85rem
        }

        .btn-secondary {
            background-color: var(--secondary-color)
        }

        .btn-secondary:hover {
            background-color: #e01e79
        }

        .btn-accent {
            background-color: var(--accent-color)
        }

        .btn-accent:hover {
            background-color: #6308a1
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color)
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: #fff
        }

        .btn-ghost {
            background-color: transparent;
            color: var(--text-color)
        }

        .btn-ghost:hover {
            background-color: rgba(0, 0, 0, .05);
            transform: none;
            box-shadow: none
        }

        .btn-tool {
            padding: .5rem;
            border-radius: var(--radius);
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--panel-border)
        }

        .btn-tool:hover {
            background-color: var(--primary-color);
            color: #fff;
            transform: none
        }

        .btn-tool.active {
            background-color: var(--primary-color);
            color: #fff
        }

        input, select, textarea {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            padding: .6rem;
            border-radius: var(--radius);
            color: var(--text-color);
            transition: var(--transition);
            width: 100%
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, .3)
        }

        .input-group {
            margin-bottom: 1rem
        }

        .input-group label {
            display: block;
            margin-bottom: .4rem;
            font-weight: 500
        }

        .color-input {
            display: flex;
            align-items: center;
            gap: .5rem
        }

        .color-input input[type=color] {
            width: 40px;
            height: 40px;
            padding: 0;
            border: none;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer
        }

        .input-row {
            display: flex;
            gap: .5rem
        }

        .input-row > * {
            flex: 1
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: .5rem;
            margin-bottom: .5rem
        }

        .checkbox-group input[type=checkbox] {
            width: auto
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid var(--panel-border);
            margin-bottom: 1rem
        }

        .tab-btn {
            padding: .6rem 1rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-color);
            opacity: .7;
            font-weight: 500
        }

        .tab-btn:hover {
            opacity: 1;
            background: none;
            transform: none;
            box-shadow: none
        }

        .tab-btn.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            opacity: 1
        }

        .tab-content {
            display: none
        }

        .tab-content.active {
            display: block
        }

        .canvas-container {
            margin: 0 auto;
            border: 1px dashed var(--panel-border);
            border-radius: 8px;
            overflow: hidden;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><rect width="10" height="10" fill="%23f1f1f1"/><rect width="10" height="10" x="10" y="10" fill="%23f1f1f1"/><rect width="10" height="10" x="10" y="0" fill="%23ffffff"/><rect width="10" height="10" x="0" y="10" fill="%23ffffff"/></svg>');
            box-shadow: var(--shadow)
        }

        .canvas-tools {
            display: flex;
            gap: .5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap
        }

        .preview-section {
            margin-bottom: 1.5rem
        }

        .preview-grid {
            display: grid;
            grid-template-columns:repeat(auto-fit, minmax(60px, 1fr));
            gap: 1rem;
            margin-top: 1rem
        }

        .preview-item {
            text-align: center
        }

        .preview-item img {
            border: 1px solid var(--panel-border);
            border-radius: 4px;
            background-color: var(--input-bg);
            padding: 4px
        }

        .preview-item span {
            display: block;
            font-size: .8rem;
            margin-top: .5rem
        }

        .browser-preview {
            margin-top: 1rem;
            border: 1px solid var(--panel-border);
            border-radius: 8px;
            overflow: hidden
        }

        .browser-toolbar {
            background-color: var(--panel-bg);
            padding: .5rem;
            border-bottom: 1px solid var(--panel-border);
            display: flex;
            align-items: center
        }

        .browser-dots {
            display: flex;
            gap: 5px;
            margin-right: .8rem
        }

        .browser-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--panel-border)
        }

        .browser-dot:nth-child(1) {
            background-color: #ff5f57
        }

        .browser-dot:nth-child(2) {
            background-color: #ffbd2e
        }

        .browser-dot:nth-child(3) {
            background-color: #28c940
        }

        .browser-address {
            flex: 1;
            background-color: var(--input-bg);
            border-radius: 4px;
            padding: .2rem .6rem;
            font-size: .8rem;
            color: var(--text-color);
            display: flex;
            align-items: center
        }

        .browser-favicon {
            width: 16px;
            height: 16px;
            margin-right: .5rem
        }

        .browser-content {
            height: 100px;
            background-color: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem
        }

        .browser-tab {
            display: flex;
            align-items: center;
            background-color: var(--panel-bg);
            border-radius: 6px 6px 0 0;
            padding: .4rem .8rem;
            font-size: .8rem;
            margin-right: .5rem;
            border: 1px solid var(--panel-border);
            border-bottom: none
        }

        .browser-tabs {
            display: flex;
            padding: 0 .5rem;
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--panel-border)
        }

        .layer-item {
            display: flex;
            align-items: center;
            padding: .5rem;
            border-radius: 4px;
            margin-bottom: .5rem;
            background-color: var(--input-bg);
            cursor: pointer;
            transition: var(--transition)
        }

        .layer-item:hover {
            background-color: rgba(67, 97, 238, .1)
        }

        .layer-item.active {
            background-color: rgba(67, 97, 238, .2)
        }

        .layer-visibility {
            margin-right: .5rem;
            cursor: pointer;
            opacity: .7
        }

        .layer-visibility:hover {
            opacity: 1
        }

        .layer-name {
            flex: 1;
            font-size: .9rem
        }

        .layer-actions {
            display: flex;
            gap: .3rem
        }

        .layer-actions button {
            padding: .2rem;
            font-size: .8rem;
            background: none;
            color: var(--text-color);
            opacity: .5
        }

        .layer-actions button:hover {
            opacity: 1;
            background: none;
            transform: none;
            box-shadow: none
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: .4rem .6rem;
            border-radius: 4px;
            margin-bottom: .3rem;
            font-size: .85rem;
            cursor: pointer;
            transition: var(--transition)
        }

        .history-item:hover {
            background-color: rgba(0, 0, 0, .05)
        }

        .history-item i {
            margin-right: .5rem;
            opacity: .7
        }

        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem
        }

        .section-title h3 {
            margin-bottom: 0
        }

        .effects-list {
            margin-bottom: 1rem
        }

        .effect-item {
            margin-bottom: .5rem;
            background-color: var(--input-bg);
            border-radius: 4px;
            padding: .6rem
        }

        .effect-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: .5rem
        }

        .effect-controls {
            padding-top: .5rem
        }

        .slider-control {
            margin-bottom: .5rem
        }

        .slider-row {
            display: flex;
            align-items: center;
            gap: .5rem
        }

        .slider-row input[type=range] {
            flex: 1
        }

        .slider-row input[type=number] {
            width: 60px
        }

        .preset-grid {
            display: grid;
            grid-template-columns:repeat(3, 1fr);
            gap: .5rem;
            margin-bottom: 1rem
        }

        .preset-item {
            aspect-ratio: 1;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 4px rgba(0, 0, 0, .1)
        }

        .preset-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, .15)
        }

        .snippet-box {
            background-color: var(--input-bg);
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative
        }

        .snippet-box pre {
            margin: 0;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: .85rem
        }

        .copy-btn {
            position: absolute;
            top: .5rem;
            right: .5rem;
            padding: .3rem;
            background-color: var(--panel-bg);
            color: var(--text-color);
            border: none;
            border-radius: 4px;
            font-size: .8rem;
            cursor: pointer;
            transition: var(--transition)
        }

        .copy-btn:hover {
            background-color: var(--primary-color);
            color: #fff
        }

        .tooltip {
            position: relative
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, .8);
            color: #fff;
            padding: .3rem .6rem;
            border-radius: 4px;
            font-size: .8rem;
            white-space: nowrap;
            z-index: 100
        }

        .tooltip:hover::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid rgba(0, 0, 0, .8);
            z-index: 100
        }

        .dropdown {
            position: relative;
            display: inline-block
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: var(--panel-bg);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .15);
            z-index: 100;
            min-width: 150px;
            padding: .5rem 0
        }

        .dropdown:hover .dropdown-content {
            display: block
        }

        .dropdown-item {
            padding: .5rem 1rem;
            cursor: pointer;
            transition: var(--transition)
        }

        .dropdown-item:hover {
            background-color: rgba(0, 0, 0, .05)
        }

        .divider {
            height: 1px;
            background-color: var(--panel-border);
            margin: .5rem 0
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%
        }

        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, .1);
            border-radius: 50%;
            border-top: 3px solid var(--primary-color);
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite
        }

        @keyframes spin {
            0% {
                transform: rotate(0)
            }
            100% {
                transform: rotate(360deg)
            }
        }

        .notification {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: var(--panel-bg);
            border-radius: 4px;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .15);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: .8rem;
            transition: var(--transition);
            transform: translateY(100px);
            opacity: 0
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1
        }

        .notification i.success {
            color: #28c940
        }

        .notification i.error {
            color: #ff5f57
        }

        .notification i.info {
            color: var(--primary-color)
        }

        .icon-button {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: .3rem;
            color: var(--text-color);
            transition: var(--transition)
        }

        .icon-button:hover {
            color: var(--primary-color);
            transform: none;
            background: none;
            box-shadow: none
        }

        @media (max-width: 1200px) {
            main {
                grid-template-columns:250px 1fr 250px
            }
        }

        @media (max-width: 992px) {
            main {
                grid-template-columns:220px 1fr;
                grid-template-areas:"tools canvas" "layers canvas" "preview preview" "history export"
            }
        }

        @media (max-width: 768px) {
            main {
                grid-template-columns:1fr;
                grid-template-areas:"canvas" "tools" "layers" "preview" "history" "export"
            }
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
            margin-bottom: 1rem
        }

        .color-swatch {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--panel-border)
        }

        .color-swatch:hover {
            transform: scale(1.1)
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--panel-border);
            transition: var(--transition);
            border-radius: 34px
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: #fff;
            transition: .4s;
            border-radius: 50%
        }

        input:checked + .toggle-slider {
            background-color: var(--primary-color)
        }

        input:checked + .toggle-slider:before {
            transform: translateX(18px)
        }

        .image-filter-preview {
            display: grid;
            grid-template-columns:repeat(3, 1fr);
            gap: .5rem;
            margin-bottom: 1rem
        }

        .filter-option {
            text-align: center;
            cursor: pointer
        }

        .filter-option img {
            width: 100%;
            border-radius: 4px;
            transition: var(--transition)
        }

        .filter-option:hover img {
            transform: scale(1.05)
        }

        .filter-name {
            font-size: .8rem;
            margin-top: .3rem
        }

        .saved-list {
            max-height: 200px;
            overflow-y: auto
        }

        .saved-item {
            display: flex;
            align-items: center;
            gap: .8rem;
            padding: .5rem;
            border-radius: 4px;
            margin-bottom: .3rem;
            transition: var(--transition);
            cursor: pointer
        }

        .saved-item:hover {
            background-color: rgba(0, 0, 0, .05)
        }

        .saved-preview {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            border: 1px solid var(--panel-border)
        }

        .saved-info {
            flex: 1
        }

        .saved-name {
            font-weight: 500;
            font-size: .9rem
        }

        .saved-date {
            font-size: .75rem;
            opacity: .7
        }

        .badge {
            display: inline-block;
            padding: .2rem .5rem;
            border-radius: 30px;
            font-size: .75rem;
            font-weight: 600;
            background-color: var(--primary-color);
            color: #fff
        }

        .badge-sm {
            padding: .1rem .4rem;
            font-size: .7rem
        }

        .badge-secondary {
            background-color: var(--secondary-color)
        }

        .backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, .5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity .3s ease
        }

        .backdrop.show {
            opacity: 1;
            pointer-events: all
        }

        .modal {
            background-color: var(--panel-bg);
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, .2);
            padding: 1.5rem;
            transform: translateY(-20px);
            transition: transform .3s ease
        }

        .backdrop.show .modal {
            transform: translateY(0)
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            opacity: .7;
            transition: var(--transition)
        }

        .close-modal:hover {
            opacity: 1;
            transform: none
        }

        .modal-body {
            margin-bottom: 1.5rem
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: .8rem
        }

        .shortcut-list {
            display: grid;
            grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));
            gap: .8rem
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .shortcut-key {
            font-family: monospace;
            background-color: var(--input-bg);
            padding: .2rem .4rem;
            border-radius: 4px;
            font-size: .8rem
        }

        .shortcut-description {
            font-size: .9rem
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: var(--panel-border);
            border-radius: 3px;
            margin: 1rem 0;
            overflow: hidden
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            transition: width .3s ease
        }

        .shape-grid {
            display: grid;
            grid-template-columns:repeat(4, 1fr);
            gap: .5rem;
            margin-bottom: 1rem
        }

        .shape-btn {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--input-bg);
            border: 1px solid var(--panel-border);
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition)
        }

        .shape-btn:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px)
        }

        .shape-btn.active {
            background-color: rgba(67, 97, 238, .1);
            border-color: var(--primary-color)
        }

        .shape-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .bg-pattern-grid {
            display: grid;
            grid-template-columns:repeat(3, 1fr);
            gap: .5rem;
            margin-bottom: 1rem
        }

        .bg-pattern {
            aspect-ratio: 1;
            border-radius: 4px;
            border: 1px solid var(--panel-border);
            cursor: pointer;
            transition: var(--transition);
            overflow: hidden
        }

        .bg-pattern:hover {
            transform: scale(1.05);
            border-color: var(--primary-color)
        }

        footer {
            text-align: center;
            padding: 2rem;
            font-size: .9rem;
            color: var(--text-color);
            opacity: .8;
            margin-top: 2rem
        }

        .app-version {
            font-size: .7rem;
            opacity: .5
        }
    </style>
</head>
<body>
<header><h1>Favicon Studio Pro<span class="beta-badge">BETA</span></h1>
    <p>Create professional-grade favicons for any website or app</p></header>
<main>
    <section id="tools-panel" class="panel">
        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="basics">Basics</button>
            <button class="tab-btn" data-tab="advanced">Advanced</button>
            <button class="tab-btn" data-tab="presets">Presets</button>
        </div>
        <div class="tab-content active" id="basics-tab">
            <div class="input-group"><label for="image-upload">Upload Image</label><input type="file" id="image-upload"
                                                                                          accept="image/*"></div>
            <div class="input-group"><label for="image-url">Import from URL</label>
                <div class="input-row"><input type="url" id="image-url" placeholder="https://example.com/image.png">
                    <button id="load-url" class="btn-sm">Load</button>
                </div>
            </div>
            <div class="divider"></div>
            <h3>Quick Shape</h3>
            <div class="shape-grid">
                <div class="shape-btn" data-shape="circle">
                    <div class="shape-icon"><i class="fas fa-circle"></i></div>
                </div>
                <div class="shape-btn" data-shape="square">
                    <div class="shape-icon"><i class="fas fa-square"></i></div>
                </div>
                <div class="shape-btn" data-shape="triangle">
                    <div class="shape-icon"><i class="fas fa-caret-up"></i></div>
                </div>
                <div class="shape-btn" data-shape="heart">
                    <div class="shape-icon"><i class="fas fa-heart"></i></div>
                </div>
                <div class="shape-btn" data-shape="star">
                    <div class="shape-icon"><i class="fas fa-star"></i></div>
                </div>
                <div class="shape-btn" data-shape="hexagon">
                    <div class="shape-icon"><i class="fas fa-stop"></i></div>
                </div>
                <div class="shape-btn" data-shape="diamond">
                    <div class="shape-icon"><i class="fas fa-gem"></i></div>
                </div>
                <div class="shape-btn" data-shape="custom">
                    <div class="shape-icon"><i class="fas fa-draw-polygon"></i></div>
                </div>
            </div>
            <h3>Text Icon</h3>
            <div class="input-group"><input type="text" id="text-input" maxlength="2" placeholder="1-2 characters">
                <div class="input-row"><select id="font-select">
                    <option value="Arial">Arial</option>
                    <option value="Helvetica">Helvetica</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Impact">Impact</option>
                    <option value="Trebuchet MS">Trebuchet MS</option>
                </select>
                    <button id="add-text" class="btn-sm">Add</button>
                </div>
            </div>
            <div class="divider"></div>
            <h3>Colors</h3>
            <div class="input-group"><label for="bg-color">Background</label>
                <div class="color-input"><input type="color" id="bg-color" value="#ffffff"> <input type="text"
                                                                                                   id="bg-color-hex"
                                                                                                   value="#ffffff"
                                                                                                   placeholder="#ffffff">
                </div>
            </div>
            <div class="input-group"><label for="foreground-color">Foreground</label>
                <div class="color-input"><input type="color" id="foreground-color" value="#000000"> <input type="text"
                                                                                                           id="foreground-color-hex"
                                                                                                           value="#000000"
                                                                                                           placeholder="#000000">
                </div>
            </div>
            <div class="color-palette">
                <div class="color-swatch" style="background-color:#ff5f57" data-color="#ff5f57"></div>
                <div class="color-swatch" style="background-color:#ffbd2e" data-color="#ffbd2e"></div>
                <div class="color-swatch" style="background-color:#28c940" data-color="#28c940"></div>
                <div class="color-swatch" style="background-color:#4361ee" data-color="#4361ee"></div>
                <div class="color-swatch" style="background-color:#f72585" data-color="#f72585"></div>
                <div class="color-swatch" style="background-color:#7209b7" data-color="#7209b7"></div>
                <div class="color-swatch" style="background-color:#4cc9f0" data-color="#4cc9f0"></div>
                <div class="color-swatch" style="background-color:#000000" data-color="#000000"></div>
            </div>
        </div>
        <div class="tab-content" id="advanced-tab"><h3>Effects</h3>
            <div class="button-group">
                <button class="btn-sm" id="add-shadow">Shadow</button>
                <button class="btn-sm" id="add-gradient">Gradient</button>
                <button class="btn-sm" id="add-pattern">Pattern</button>
            </div>
            <div class="effects-list"></div>
            <h3>Transformations</h3>
            <div class="button-group">
                <button class="btn-tool tooltip" id="rotate-left" data-tooltip="Rotate Left"><i
                        class="fas fa-rotate-left"></i></button>
                <button class="btn-tool tooltip" id="rotate-right" data-tooltip="Rotate Right"><i
                        class="fas fa-rotate-right"></i></button>
                <button class="btn-tool tooltip" id="flip-h" data-tooltip="Flip Horizontal"><i
                        class="fas fa-left-right"></i></button>
                <button class="btn-tool tooltip" id="flip-v" data-tooltip="Flip Vertical"><i class="fas fa-up-down"></i>
                </button>
            </div>
            <h3>Adjustments</h3>
            <div class="input-group"><label for="opacity-slider">Opacity</label>
                <div class="slider-row"><input type="range" id="opacity-slider" min="0" max="100" value="100"> <input
                        type="number" id="opacity-value" min="0" max="100" value="100"></div>
            </div>
            <div class="input-group"><label for="border-toggle">Border</label>
                <div class="checkbox-group"><label class="toggle-switch"><input type="checkbox" id="border-toggle">
                    <span class="toggle-slider"></span></label></div>
                <div id="border-options" style="display:none">
                    <div class="slider-row"><label for="border-width">Width</label> <input type="range"
                                                                                           id="border-width" min="1"
                                                                                           max="20" value="2"> <input
                            type="number" id="border-width-value" min="1" max="20" value="2"></div>
                    <div class="color-input"><input type="color" id="border-color" value="#000000"> <input type="text"
                                                                                                           id="border-color-hex"
                                                                                                           value="#000000"
                                                                                                           placeholder="#000000">
                    </div>
                </div>
            </div>
            <h3>Filters</h3>
            <div class="image-filter-preview">
                <div class="filter-option" data-filter="none"><img src="" id="filter-preview-none" alt="Original">
                    <div class="filter-name">Original</div>
                </div>
                <div class="filter-option" data-filter="grayscale"><img src="" id="filter-preview-grayscale"
                                                                        alt="Grayscale">
                    <div class="filter-name">Grayscale</div>
                </div>
                <div class="filter-option" data-filter="sepia"><img src="" id="filter-preview-sepia" alt="Sepia">
                    <div class="filter-name">Sepia</div>
                </div>
                <div class="filter-option" data-filter="invert"><img src="" id="filter-preview-invert" alt="Invert">
                    <div class="filter-name">Invert</div>
                </div>
                <div class="filter-option" data-filter="blueprint"><img src="" id="filter-preview-blueprint"
                                                                        alt="Blueprint">
                    <div class="filter-name">Blueprint</div>
                </div>
                <div class="filter-option" data-filter="duotone"><img src="" id="filter-preview-duotone" alt="Duotone">
                    <div class="filter-name">Duotone</div>
                </div>
            </div>
        </div>
        <div class="tab-content" id="presets-tab"><h3>Icon Templates</h3>
            <div class="preset-grid">
                <div class="preset-item" data-preset="letter"
                     style="background-color:#4361ee;color:#fff;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700">
                    A
                </div>
                <div class="preset-item" data-preset="circle-letter"
                     style="background-color:#fff;display:flex;align-items:center;justify-content:center">
                    <div style="width:70%;height:70%;background-color:#f72585;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">
                        F
                    </div>
                </div>
                <div class="preset-item" data-preset="gradient"
                     style="background:linear-gradient(45deg,#4361ee,#f72585)"></div>
                <div class="preset-item" data-preset="app-icon"
                     style="background-color:#fff;display:flex;align-items:center;justify-content:center">
                    <div style="width:60%;height:60%;background-color:#4cc9f0;border-radius:12px"></div>
                </div>
                <div class="preset-item" data-preset="initials"
                     style="background-color:#212529;color:#fff;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700">
                    FS
                </div>
                <div class="preset-item" data-preset="star"
                     style="background-color:#ffbd2e;display:flex;align-items:center;justify-content:center"><i
                        class="fas fa-star" style="font-size:30px;color:#fff"></i></div>
            </div>
            <h3>Background Patterns</h3>
            <div class="bg-pattern-grid">
                <div class="bg-pattern" data-pattern="dots"
                     style="background-image:radial-gradient(#0001 1px,transparent 0);background-size:10px 10px"></div>
                <div class="bg-pattern" data-pattern="grid"
                     style="background-image:linear-gradient(#0001 1px,transparent 0),linear-gradient(90deg,#0001 1px,transparent 0);background-size:10px 10px"></div>
                <div class="bg-pattern" data-pattern="stripes"
                     style="background-image:linear-gradient(45deg,#0001 25%,transparent 0,transparent 50%,#0001 0,#0001 75%,transparent 0);background-size:10px 10px"></div>
                <div class="bg-pattern" data-pattern="waves"
                     style="background:#f8f9fa;background-image:repeating-radial-gradient(circle at 0 0,transparent 0,#f8f9fa 10px),repeating-linear-gradient(#0001,#0001 1px,#f8f9fa 0,#f8f9fa 10px)"></div>
                <div class="bg-pattern" data-pattern="zigzag"
                     style="background:linear-gradient(135deg,#0001 25%,transparent 25%) -10px 0,linear-gradient(225deg,#0001 25%,transparent 25%) -10px 0,linear-gradient(315deg,#0001 25%,transparent 25%),linear-gradient(45deg,#0001 25%,transparent 25%);background-size:20px 20px"></div>
                <div class="bg-pattern" data-pattern="noise"
                     style="background-image:url('data:image/svg+xml;charset=utf8,%3Csvg%20viewBox%3D%220%200%20200%20200%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cfilter%20id%3D%22noiseFilter%22%3E%3CfeTurbulence%20type%3D%22fractalNoise%22%20baseFrequency%3D%220.65%22%20numOctaves%3D%223%22%20stitchTiles%3D%22stitch%22%2F%3E%3C%2Ffilter%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20filter%3D%22url%28%23noiseFilter%29%22%2F%3E%3C%2Fsvg%3E')">
                </div>
            </div>
            <h3>Saved Designs</h3>
            <div class="saved-list"></div>
            <div class="button-group">
                <button id="save-design" class="btn-sm"><i class="fas fa-save"></i> Save Current</button>
                <button id="clear-saved" class="btn-sm btn-outline"><i class="fas fa-trash"></i> Clear All</button>
            </div>
        </div>
    </section>
    <section id="layers-panel" class="panel">
        <div class="section-title"><h3>Layers</h3>
            <div style="display: flex; gap: 5px;">
                <button class="btn-sm" id="add-new-layer"><i class="fas fa-plus"></i></button>
                <button class="btn-sm" id="group-layers" title="Group Layers"><i class="fas fa-object-group"></i>
                </button>
            </div>
        </div>
        <div id="layers-list"></div>
        <div class="button-group" style="margin-top:1rem">
            <button id="center-content" class="btn-sm">Center All</button>
            <button id="reset-canvas" class="btn-sm btn-outline">Clear Canvas</button>
        </div>
    </section>
    <section id="canvas-panel" class="panel">
        <div class="canvas-tools">
            <button class="btn-tool tooltip active" id="select-tool" data-tooltip="Select (V)"><i
                    class="fas fa-mouse-pointer"></i></button>
            <button class="btn-tool tooltip" id="move-tool" data-tooltip="Move (M)"><i class="fas fa-arrows-alt"></i>
            </button>
            <button class="btn-tool tooltip" id="draw-tool" data-tooltip="Draw (B)"><i class="fas fa-paint-brush"></i>
            </button>
            <button class="btn-tool tooltip" id="text-tool" data-tooltip="Text (T)"><i class="fas fa-font"></i></button>
            <button class="btn-tool tooltip" id="shape-tool" data-tooltip="Shape (S)"><i class="fas fa-shapes"></i>
            </button>
            <button class="btn-tool tooltip" id="crop-tool" data-tooltip="Crop (C)"><i class="fas fa-crop-alt"></i>
            </button>
            <button class="btn-tool tooltip" id="zoom-in" data-tooltip="Zoom In (+)"><i class="fas fa-search-plus"></i>
            </button>
            <button class="btn-tool tooltip" id="zoom-out" data-tooltip="Zoom Out (-)"><i
                    class="fas fa-search-minus"></i></button>
            <button class="btn-tool tooltip" id="zoom-reset" data-tooltip="Reset Zoom (0)"><i class="fas fa-expand"></i>
            </button>
            <button class="btn-tool tooltip" id="undo-action" data-tooltip="Undo (Ctrl+Z)"><i class="fas fa-undo"></i>
            </button>
            <button class="btn-tool tooltip" id="redo-action" data-tooltip="Redo (Ctrl+Y)"><i class="fas fa-redo"></i>
            </button>
        </div>
        <div class="canvas-container">
            <canvas id="favicon-canvas" width="512" height="512"></canvas>
        </div>
        <div class="canvas-info" style="margin-top:1rem;text-align:center;font-size:.9rem"><span id="canvas-size">512 √ó 512 px</span>
            <span id="zoom-level" style="margin-left:1rem">100%</span></div>
    </section>
    <section id="preview-panel" class="panel">
        <div class="preview-section">
            <div class="section-title"><h3>Size Previews</h3>
                <div class="checkbox-group"><label for="preview-bg-toggle">Dark BG</label> <label class="toggle-switch"><input
                        type="checkbox" id="preview-bg-toggle"> <span class="toggle-slider"></span></label></div>
            </div>
            <div class="preview-grid" id="preview-bg-light">
                <div class="preview-item"><img id="preview-16" width="16" height="16"> <span>16√ó16</span></div>
                <div class="preview-item"><img id="preview-32" width="32" height="32"> <span>32√ó32</span></div>
                <div class="preview-item"><img id="preview-48" width="48" height="48"> <span>48√ó48</span></div>
                <div class="preview-item"><img id="preview-64" width="64" height="64"> <span>64√ó64</span></div>
                <div class="preview-item"><img id="preview-128" width="48" height="48"> <span>128√ó128</span></div>
                <div class="preview-item"><img id="preview-192" width="48" height="48"> <span>192√ó192</span></div>
            </div>
        </div>
        <div class="preview-section"><h3>Browser Preview</h3>
            <div class="browser-preview">
                <div class="browser-tabs">
                    <div class="browser-tab"><img id="browser-tab-favicon" class="browser-favicon" src=""> <span>My Website</span>
                    </div>
                </div>
                <div class="browser-toolbar">
                    <div class="browser-dots">
                        <div class="browser-dot"></div>
                        <div class="browser-dot"></div>
                        <div class="browser-dot"></div>
                    </div>
                    <div class="browser-address"><img id="browser-address-favicon" class="browser-favicon" src="">
                        <span>example.com</span></div>
                </div>
                <div class="browser-content" id="browser-content">
                    <button id="update-tab-favicon" class="btn-sm">Update Tab Favicon</button>
                </div>
            </div>
        </div>
        <div class="preview-section"><h3>Mobile Preview</h3>
            <div style="text-align:center;padding:1rem;border:1px solid var(--panel-border);border-radius:8px;margin-top:.5rem">
                <div style="display:inline-block;width:60px;height:60px;background-color:var(--panel-bg);border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.1)">
                    <img id="mobile-icon-preview" width="60" height="60"></div>
                <div style="margin-top:.5rem;font-size:.9rem">App Icon</div>
            </div>
        </div>
    </section>
    <section id="history-panel" class="panel">
        <div class="section-title"><h3>History</h3>
            <button id="clear-history" class="btn-sm btn-outline"><i class="fas fa-trash"></i></button>
        </div>
        <div id="history-list">
            <div class="history-item"><i class="fas fa-plus-circle"></i> <span>Canvas created</span></div>
        </div>
    </section>
    <section id="export-panel" class="panel">
        <div class="section-title"><h3>Export Options</h3></div>
        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="export-files">Files</button>
            <button class="tab-btn" data-tab="export-code">Code</button>
        </div>
        <div class="tab-content active" id="export-files-tab">
            <div class="input-group"><label>Select sizes to include:</label>
                <div class="checkbox-group"><input type="checkbox" id="size-16" data-size="16" checked> <label
                        for="size-16">16√ó16</label> <input type="checkbox" id="size-32" data-size="32" checked> <label
                        for="size-32">32√ó32</label> <input type="checkbox" id="size-48" data-size="48" checked> <label
                        for="size-48">48√ó48</label></div>
                <div class="checkbox-group"><input type="checkbox" id="size-64" data-size="64" checked> <label
                        for="size-64">64√ó64</label> <input type="checkbox" id="size-128" data-size="128"> <label
                        for="size-128">128√ó128</label> <input type="checkbox" id="size-192" data-size="192"> <label
                        for="size-192">192√ó192</label></div>
                <div class="checkbox-group"><input type="checkbox" id="size-256" data-size="256"> <label for="size-256">256√ó256</label>
                    <input type="checkbox" id="size-512" data-size="512"> <label for="size-512">512√ó512</label></div>
            </div>
            <div class="input-group"><label>Format options:</label>
                <div class="checkbox-group"><input type="checkbox" id="format-png" checked> <label
                        for="format-png">PNG</label> <input type="checkbox" id="format-ico"> <label
                        for="format-ico">ICO</label> <input type="checkbox" id="format-svg"> <label
                        for="format-svg">SVG</label></div>
            </div>
            <div class="button-group">
                <button id="download-png" class="btn"><i class="fas fa-download"></i> Download PNG</button>
                <button id="download-all" class="btn"><i class="fas fa-file-archive"></i> Download Package</button>
            </div>
        </div>
        <div class="tab-content" id="export-code-tab">
            <div class="snippet-box">
                <pre id="html-code-snippet">&lt;link rel="icon" type="image/png" href="favicon.png" sizes="32x32"&gt;</pre>
                <button class="copy-btn" id="copy-html"><i class="fas fa-copy"></i></button>
            </div>
            <div class="input-group"><label>Full HTML Head Code:</label>
                <div class="snippet-box"><pre id="full-html-snippet">&lt;!-- Favicon --&gt;
&lt;link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"&gt;
&lt;link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"&gt;
&lt;link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"&gt;
&lt;link rel="manifest" href="site.webmanifest"&gt;
&lt;meta name="msapplication-TileColor" content="#ffffff"&gt;
&lt;meta name="theme-color" content="#ffffff"&gt;</pre>
                    <button class="copy-btn" id="copy-full-html"><i class="fas fa-copy"></i></button>
                </div>
            </div>
        </div>
    </section>
</main>
<footer>
    <div>
        Favicon Studio Pro ‚Äî Create professional favicons in seconds
        <div class="app-version" title="beta">v0.7.4</div>
    </div>
</footer>
<div class="backdrop" id="save-modal">
    <div class="modal">
        <div class="modal-header"><h3>Save Design</h3>
            <button class="close-modal" id="close-save-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="input-group"><label for="save-name">Design Name</label> <input type="text" id="save-name"
                                                                                       placeholder="My Favicon"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" id="cancel-save">Cancel</button>
            <button class="btn" id="confirm-save">Save</button>
        </div>
    </div>
</div>
<div class="backdrop" id="shortcuts-modal">
    <div class="modal">
        <div class="modal-header"><h3>Keyboard Shortcuts</h3>
            <button class="close-modal" id="close-shortcuts-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="shortcut-list">
                <div class="shortcut-item"><span class="shortcut-description">Select Tool</span> <span
                        class="shortcut-key">V</span></div>
                <div class="shortcut-item"><span class="shortcut-description">Move Tool</span> <span
                        class="shortcut-key">M</span></div>
                <div class="shortcut-item"><span class="shortcut-description">Draw Tool</span> <span
                        class="shortcut-key">B</span></div>
                <div class="shortcut-item"><span class="shortcut-description">Text Tool</span> <span
                        class="shortcut-key">T</span></div>
                <div class="shortcut-item"><span class="shortcut-description">Shape Tool</span> <span
                        class="shortcut-key">S</span></div>
                <div class="shortcut-item"><span class="shortcut-description">Crop Tool</span> <span
                        class="shortcut-key">C</span></div>
                <div class="shortcut-item"><span class="shortcut-description">Undo</span> <span class="shortcut-key">Ctrl+Z</span>
                </div>
                <div class="shortcut-item"><span class="shortcut-description">Redo</span> <span class="shortcut-key">Ctrl+Y</span>
                </div>
                <div class="shortcut-item"><span class="shortcut-description">Zoom In</span> <span class="shortcut-key">+</span>
                </div>
                <div class="shortcut-item"><span class="shortcut-description">Zoom Out</span> <span
                        class="shortcut-key">-</span></div>
                <div class="shortcut-item"><span class="shortcut-description">Reset Zoom</span> <span
                        class="shortcut-key">0</span></div>
                <div class="shortcut-item"><span class="shortcut-description">Delete Selection</span> <span
                        class="shortcut-key">Del</span></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" id="close-shortcuts">Close</button>
        </div>
    </div>
</div>
<div class="notification" id="notification"><i class="fas fa-check-circle success"></i> <span id="notification-message">Operation successful!</span>
</div>
<script>document.addEventListener('DOMContentLoaded', () => {
    const canvas = new fabric.Canvas('favicon-canvas', {backgroundColor: '#ffffff', preserveObjectStacking: !0});
    const canvasSize = 512;
    canvas.setDimensions({width: canvasSize, height: canvasSize});
    let zoomLevel = 1;
    let currentTool = 'select';
    let historyStack = [];
    let historyPosition = -1;
    const maxHistorySteps = 30;
    let activeLayer = null;
    let activeForegroundColor = '#000000';
    let activeBackgroundColor = '#ffffff';
    let activeFilter = 'none';
    let savedDesigns = JSON.parse(localStorage.getItem('faviconDesigns') || '[]');
    let isPolygonDrawing = false;
    let polygonPoints = [];
    let tempPolygonObjects = [];
    const bgColorInput = document.getElementById('bg-color');
    const bgColorHexInput = document.getElementById('bg-color-hex');
    const foregroundColorInput = document.getElementById('foreground-color');
    const foregroundColorHexInput = document.getElementById('foreground-color-hex');
    const imageUpload = document.getElementById('image-upload');
    const imageUrlInput = document.getElementById('image-url');
    const loadUrlBtn = document.getElementById('load-url');
    const textInput = document.getElementById('text-input');
    const fontSelect = document.getElementById('font-select');
    const addTextBtn = document.getElementById('add-text');
    const borderToggle = document.getElementById('border-toggle');
    const borderOptions = document.getElementById('border-options');
    const borderWidthSlider = document.getElementById('border-width');
    const borderWidthValue = document.getElementById('border-width-value');
    const borderColorInput = document.getElementById('border-color');
    const borderColorHexInput = document.getElementById('border-color-hex');
    const centerContentBtn = document.getElementById('center-content');
    const resetCanvasBtn = document.getElementById('reset-canvas');
    const updateTabFaviconBtn = document.getElementById('update-tab-favicon');
    const downloadPngBtn = document.getElementById('download-png');
    const downloadAllBtn = document.getElementById('download-all');
    const opacitySlider = document.getElementById('opacity-slider');
    const opacityValue = document.getElementById('opacity-value');
    const undoBtn = document.getElementById('undo-action');
    const redoBtn = document.getElementById('redo-action');
    const addShadowBtn = document.getElementById('add-shadow');
    const addGradientBtn = document.getElementById('add-gradient');
    const addPatternBtn = document.getElementById('add-pattern');
    const addNewLayerBtn = document.getElementById('add-new-layer');
    const groupLayersBtn = document.getElementById('group-layers');
    const clearHistoryBtn = document.getElementById('clear-history');
    const saveDesignBtn = document.getElementById('save-design');
    const clearSavedBtn = document.getElementById('clear-saved');
    const tabButtons = document.querySelectorAll('.tab-btn');
    const toolButtons = document.querySelectorAll('.btn-tool');
    const shapeButtons = document.querySelectorAll('.shape-btn');
    const colorSwatches = document.querySelectorAll('.color-swatch');
    const presetItems = document.querySelectorAll('.preset-item');
    const bgPatterns = document.querySelectorAll('.bg-pattern');
    const filterOptions = document.querySelectorAll('.filter-option');
    const previewBgToggle = document.getElementById('preview-bg-toggle');
    const copyHtmlBtn = document.getElementById('copy-html');
    const copyFullHtmlBtn = document.getElementById('copy-full-html');
    const rotateLeftBtn = document.getElementById('rotate-left');
    const rotateRightBtn = document.getElementById('rotate-right');
    const flipHBtn = document.getElementById('flip-h');
    const flipVBtn = document.getElementById('flip-v');
    const zoomInBtn = document.getElementById('zoom-in');
    const zoomOutBtn = document.getElementById('zoom-out');
    const zoomResetBtn = document.getElementById('zoom-reset');
    const zoomLevelDisplay = document.getElementById('zoom-level');
    const layersList = document.getElementById('layers-list');
    const historyList = document.getElementById('history-list');
    const saveModal = document.getElementById('save-modal');
    const closeSaveModalBtn = document.getElementById('close-save-modal');
    const cancelSaveBtn = document.getElementById('cancel-save');
    const confirmSaveBtn = document.getElementById('confirm-save');
    const saveNameInput = document.getElementById('save-name');
    const shortcutsModal = document.getElementById('shortcuts-modal');
    const closeShortcutsModalBtn = document.getElementById('close-shortcuts-modal');
    const closeShortcutsBtn = document.getElementById('close-shortcuts');
    const notification = document.getElementById('notification');
    const notificationMessage = document.getElementById('notification-message');

    function updateCanvasAndPreviews() {
        canvas.renderAll();
        updatePreviews();
        updateLayersList();
    }

    function initializeApp() {
        updateCanvasBackgroundColor(activeBackgroundColor);
        updatePreviews();
        updateLayersList();
        updateHistoryList();
        loadSavedDesigns();
        registerEventListeners();
        saveCanvasState('Canvas created')
    }

    function registerEventListeners() {
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabGroup = btn.closest('.tab-buttons');
                const tabContainer = tabGroup.parentElement;
                const targetTabId = btn.dataset.tab;
                tabGroup.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                if (targetTabId.includes('export')) {
                    document.querySelectorAll('#export-panel .tab-content').forEach(tab => {
                        tab.classList.remove('active')
                    });
                    document.getElementById(`${targetTabId}-tab`).classList.add('active')
                } else {
                    tabContainer.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.remove('active')
                    });
                    document.getElementById(`${targetTabId}-tab`).classList.add('active')
                }
            })
        });
        toolButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                toolButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTool = btn.id.replace('-tool', '');
                setCanvasTool(currentTool)
            })
        });
        bgColorInput.addEventListener('input', () => {
            bgColorHexInput.value = bgColorInput.value;
            updateCanvasBackgroundColor(bgColorInput.value)
        });
        bgColorHexInput.addEventListener('input', () => {
            if (/^#[0-9A-F]{6}$/i.test(bgColorHexInput.value)) {
                bgColorInput.value = bgColorHexInput.value;
                updateCanvasBackgroundColor(bgColorHexInput.value)
            }
        });
        foregroundColorInput.addEventListener('input', () => {
            foregroundColorHexInput.value = foregroundColorInput.value;
            activeForegroundColor = foregroundColorInput.value;
            updateObjectColor()
        });
        foregroundColorHexInput.addEventListener('input', () => {
            if (/^#[0-9A-F]{6}$/i.test(foregroundColorHexInput.value)) {
                foregroundColorInput.value = foregroundColorHexInput.value;
                activeForegroundColor = foregroundColorHexInput.value;
                updateObjectColor()
            }
        });
        colorSwatches.forEach(swatch => {
            swatch.addEventListener('click', () => {
                const color = swatch.dataset.color;
                foregroundColorInput.value = color;
                foregroundColorHexInput.value = color;
                activeForegroundColor = color;
                updateObjectColor()
            })
        });
        borderToggle.addEventListener('change', () => {
            borderOptions.style.display = borderToggle.checked ? 'block' : 'none';
            updateBorder()
        });
        borderWidthSlider.addEventListener('input', () => {
            borderWidthValue.value = borderWidthSlider.value;
            updateBorder()
        });
        borderWidthValue.addEventListener('input', () => {
            borderWidthSlider.value = borderWidthValue.value;
            updateBorder()
        });
        borderColorInput.addEventListener('input', () => {
            borderColorHexInput.value = borderColorInput.value;
            updateBorder()
        });
        borderColorHexInput.addEventListener('input', () => {
            if (/^#[0-9A-F]{6}$/i.test(borderColorHexInput.value)) {
                borderColorInput.value = borderColorHexInput.value;
                updateBorder()
            }
        });
        opacitySlider.addEventListener('input', () => {
            opacityValue.value = opacitySlider.value;
            updateOpacity()
        });
        opacityValue.addEventListener('input', () => {
            opacitySlider.value = opacityValue.value;
            updateOpacity()
        });
        shapeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const shape = btn.dataset.shape;
                addShape(shape)
            })
        });
        presetItems.forEach(item => {
            item.addEventListener('click', () => {
                const preset = item.dataset.preset;
                applyPreset(preset)
            })
        });
        bgPatterns.forEach(pattern => {
            pattern.addEventListener('click', () => {
                const patternType = pattern.dataset.pattern;
                applyBackgroundPattern(patternType)
            })
        });
        imageUpload.addEventListener('change', handleImageUpload);
        loadUrlBtn.addEventListener('click', handleImageUrl);
        addTextBtn.addEventListener('click', addText);
        centerContentBtn.addEventListener('click', centerContent);
        resetCanvasBtn.addEventListener('click', resetCanvas);
        updateTabFaviconBtn.addEventListener('click', updateTabFavicon);
        previewBgToggle.addEventListener('change', togglePreviewBackground);
        downloadPngBtn.addEventListener('click', downloadPng);
        downloadAllBtn.addEventListener('click', downloadAllSizes);
        filterOptions.forEach(option => {
            option.addEventListener('click', () => {
                const filter = option.dataset.filter;
                applyFilter(filter)
            })
        });
        undoBtn.addEventListener('click', undo);
        redoBtn.addEventListener('click', redo);
        clearHistoryBtn.addEventListener('click', clearHistory);
        addShadowBtn.addEventListener('click', addShadowEffect);
        addGradientBtn.addEventListener('click', addGradientEffect);
        addPatternBtn.addEventListener('click', addPatternEffect);
        addNewLayerBtn.addEventListener('click', addNewLayer);
        groupLayersBtn.addEventListener('click', groupSelectedLayers);
        rotateLeftBtn.addEventListener('click', () => rotateObject(-90));
        rotateRightBtn.addEventListener('click', () => rotateObject(90));
        flipHBtn.addEventListener('click', () => flipObject('horizontal'));
        flipVBtn.addEventListener('click', () => flipObject('vertical'));
        zoomInBtn.addEventListener('click', zoomIn);
        zoomOutBtn.addEventListener('click', zoomOut);
        zoomResetBtn.addEventListener('click', resetZoom);
        copyHtmlBtn.addEventListener('click', () => copyToClipboard('html-code-snippet'));
        copyFullHtmlBtn.addEventListener('click', () => copyToClipboard('full-html-snippet'));
        saveDesignBtn.addEventListener('click', openSaveModal);
        clearSavedBtn.addEventListener('click', clearSavedDesigns);
        closeSaveModalBtn.addEventListener('click', closeSaveModal);
        cancelSaveBtn.addEventListener('click', closeSaveModal);
        confirmSaveBtn.addEventListener('click', saveCurrentDesign);
        closeShortcutsModalBtn.addEventListener('click', closeShortcutsModal);
        closeShortcutsBtn.addEventListener('click', closeShortcutsModal);
        document.addEventListener('keydown', handleKeyPress);
        canvas.on('object:modified', () => {
            saveCanvasState('Object modified');
            updateCanvasAndPreviews()
        });
        canvas.on('object:added', () => {
            updateLayersList();
            updatePreviews()
        });
        canvas.on('object:removed', () => {
            updateLayersList();
            updatePreviews()
        });
        canvas.on('selection:created', handleSelectionCreated);
        canvas.on('selection:updated', handleSelectionCreated);
        canvas.on('selection:cleared', handleSelectionCleared);
        canvas.on('mouse:down', (options) => {
            if (isPolygonDrawing) {
                handlePolygonDrawing(options)
            }
        });
    }

    function updateCanvasBackgroundColor(color) {
        activeBackgroundColor = color;
        canvas.backgroundColor = color;
        canvas.renderAll();
        updatePreviews();
        const fullHtmlSnippet = document.getElementById('full-html-snippet');
        const html = fullHtmlSnippet.textContent;
        const updatedHtml = html.replace(/(content="#)([0-9A-F]{6})(">)/gi, `$1${color.substring(1)}$3`);
        fullHtmlSnippet.textContent = updatedHtml
    }

    function updateObjectColor() {
        const activeObject = canvas.getActiveObject();
        if (activeObject) {
            if (activeObject.type === 'textbox' || activeObject.type === 'text') {
                activeObject.set('fill', activeForegroundColor)
            } else {
                activeObject.set('fill', activeForegroundColor)
            }
            canvas.renderAll();
            updatePreviews();
            saveCanvasState('Changed object color')
        }
    }

    function updateBorder() {
        const activeObject = canvas.getActiveObject();
        if (activeObject) {
            if (borderToggle.checked) {
                activeObject.set({stroke: borderColorInput.value, strokeWidth: parseInt(borderWidthSlider.value)})
            } else {
                activeObject.set({stroke: null, strokeWidth: 0})
            }
            canvas.renderAll();
            updatePreviews();
            saveCanvasState('Changed border')
        }
    }

    function updateOpacity() {
        const activeObject = canvas.getActiveObject();
        if (activeObject) {
            activeObject.set('opacity', parseInt(opacitySlider.value) / 100);
            canvas.renderAll();
            updatePreviews();
            saveCanvasState('Changed opacity')
        }
    }

    function addShape(shapeType) {
        if (shapeType === 'custom') {
            startCustomPolygonDrawing();
            return;
        }
        let shape;
        switch (shapeType) {
            case'circle':
                shape = new fabric.Circle({
                    radius: canvasSize / 4,
                    fill: activeForegroundColor,
                    left: canvasSize / 2,
                    top: canvasSize / 2,
                    originX: 'center',
                    originY: 'center'
                });
                break;
            case'square':
                shape = new fabric.Rect({
                    width: canvasSize / 2,
                    height: canvasSize / 2,
                    fill: activeForegroundColor,
                    left: canvasSize / 2,
                    top: canvasSize / 2,
                    originX: 'center',
                    originY: 'center'
                });
                break;
            case'triangle':
                shape = new fabric.Triangle({
                    width: canvasSize / 2,
                    height: canvasSize / 2,
                    fill: activeForegroundColor,
                    left: canvasSize / 2,
                    top: canvasSize / 2,
                    originX: 'center',
                    originY: 'center'
                });
                break;
            case'heart':
                const heartPath = 'M272.70141,238.71731C206.46141,238.71731152.70146,292.4773152.70146,358.71723C152.70146,493.47718272.70146,563.71709272.70146,563.71709C272.70146,563.71709392.70138,493.47708392.70138,358.71723C392.70138,292.47731338.94138,238.71731272.70141,238.71731z';
                fabric.loadSVGFromString(`<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="152.70146 238.71731 240 330"><path d="${heartPath}"/></svg>`, (objects, options) => {
                    shape = fabric.util.groupSVGElements(objects, options);
                    shape.set({
                        left: canvasSize / 2,
                        top: canvasSize / 2,
                        originX: 'center',
                        originY: 'center',
                        fill: activeForegroundColor,
                        scaleX: 1.5,
                        scaleY: 1.5
                    });
                    canvas.add(shape);
                    shape.setCoords();
                    canvas.setActiveObject(shape);
                    canvas.renderAll();
                    saveCanvasState('Added heart shape');
                    updatePreviews();
                    updateLayersList()
                });
                return;
            case'star':
                const points = 5;
                const outerRadius = canvasSize / 4;
                const innerRadius = outerRadius / 2;
                shape = new fabric.Polygon(starPoints(points, outerRadius, innerRadius), {
                    fill: activeForegroundColor,
                    left: canvasSize / 2,
                    top: canvasSize / 2,
                    originX: 'center',
                    originY: 'center'
                });
                break;
            case'hexagon':
                shape = new fabric.Polygon(regularPolygonPoints(6, canvasSize / 4), {
                    fill: activeForegroundColor,
                    left: canvasSize / 2,
                    top: canvasSize / 2,
                    originX: 'center',
                    originY: 'center'
                });
                break;
            case'diamond':
                shape = new fabric.Polygon([{x: 0, y: -canvasSize / 4}, {x: canvasSize / 4, y: 0}, {
                    x: 0,
                    y: canvasSize / 4
                }, {x: -canvasSize / 4, y: 0}], {
                    fill: activeForegroundColor,
                    left: canvasSize / 2,
                    top: canvasSize / 2,
                    originX: 'center',
                    originY: 'center'
                });
                break;
        }
        if (shape) {
            canvas.add(shape);
            shape.setCoords();
            canvas.setActiveObject(shape);
            canvas.renderAll();
            saveCanvasState(`Added ${shapeType} shape`);
            updatePreviews();
            updateLayersList()
        }
    }

    function startCustomPolygonDrawing() {
        isPolygonDrawing = true;
        polygonPoints = [];
        tempPolygonObjects = [];
        showNotification('Click to add points to your polygon. Double-click or press Enter to finish.', 'info');
    }

    function handlePolygonDrawing(options) {
        if (!isPolygonDrawing) return;
        const pointer = canvas.getPointer(options.e);
        if (options.e.type === 'dblclick') {
            if (polygonPoints.length >= 3) {
                finishPolygon();
            } else {
                showNotification('A polygon needs at least 3 points', 'error');
            }
            return;
        }
        if (polygonPoints.length > 0) {
            const line = new fabric.Line([polygonPoints[polygonPoints.length - 1].x, polygonPoints[polygonPoints.length - 1].y, pointer.x, pointer.y], {
                stroke: activeForegroundColor,
                strokeWidth: 2,
                selectable: false
            });
            canvas.add(line);
            tempPolygonObjects.push(line);
        }
        const point = new fabric.Circle({
            left: pointer.x,
            top: pointer.y,
            radius: 3,
            fill: activeForegroundColor,
            strokeWidth: 2,
            stroke: 'white',
            originX: 'center',
            originY: 'center',
            selectable: false
        });
        canvas.add(point);
        tempPolygonObjects.push(point);
        polygonPoints.push({x: pointer.x, y: pointer.y});
        if (polygonPoints.length > 1) {
            document.addEventListener('keydown', function polygonEnterHandler(e) {
                if (e.key === 'Enter') {
                    finishPolygon();
                    document.removeEventListener('keydown', polygonEnterHandler);
                }
            });
        }
    }

    function finishPolygon() {
        if (polygonPoints.length < 3) {
            cancelPolygonDrawing();
            return;
        }
        const polygon = new fabric.Polygon(polygonPoints, {fill: activeForegroundColor, stroke: null, left: 0, top: 0});
        tempPolygonObjects.forEach(obj => canvas.remove(obj));
        canvas.add(polygon);
        polygon.setCoords();
        canvas.setActiveObject(polygon);
        canvas.renderAll();
        isPolygonDrawing = false;
        polygonPoints = [];
        tempPolygonObjects = [];
        saveCanvasState('Added custom polygon');
        updatePreviews();
        updateLayersList();
        document.getElementById('select-tool').click();
    }

    function cancelPolygonDrawing() {
        tempPolygonObjects.forEach(obj => canvas.remove(obj));
        isPolygonDrawing = false;
        polygonPoints = [];
        tempPolygonObjects = [];
        canvas.renderAll();
        document.getElementById('select-tool').click();
    }

    function addText() {
        const text = textInput.value || 'A';
        const font = fontSelect.value;
        const textObject = new fabric.Textbox(text, {
            left: canvasSize / 2,
            top: canvasSize / 2,
            fontFamily: font,
            fontSize: 200,
            fill: activeForegroundColor,
            textAlign: 'center',
            originX: 'center',
            originY: 'center',
            width: 300
        });
        canvas.add(textObject);
        textObject.setCoords();
        canvas.setActiveObject(textObject);
        canvas.renderAll();
        saveCanvasState('Added text');
        updatePreviews();
        updateLayersList();
    }

    function handleImageUpload(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
                fabric.Image.fromURL(event.target.result, function (img) {
                    const scale = Math.min(canvasSize / img.width, canvasSize / img.height);
                    img.set({
                        left: canvasSize / 2,
                        top: canvasSize / 2,
                        scaleX: scale,
                        scaleY: scale,
                        originX: 'center',
                        originY: 'center'
                    });
                    canvas.add(img);
                    img.setCoords();
                    canvas.setActiveObject(img);
                    canvas.renderAll();
                    saveCanvasState('Added image');
                    updatePreviews();
                    updateLayersList();
                    updateFilterPreviews(img)
                })
            };
            reader.readAsDataURL(file)
        }
    }

    function handleImageUrl() {
        const url = imageUrlInput.value.trim();
        if (url) {
            fabric.Image.fromURL(url, function (img) {
                if (!img.width || !img.height) {
                    showNotification('Failed to load image from URL', 'error');
                    return
                }
                const scale = Math.min(canvasSize / img.width, canvasSize / img.height);
                img.set({
                    left: canvasSize / 2,
                    top: canvasSize / 2,
                    scaleX: scale,
                    scaleY: scale,
                    originX: 'center',
                    originY: 'center'
                });
                canvas.add(img);
                img.setCoords();
                canvas.setActiveObject(img);
                canvas.renderAll();
                saveCanvasState('Added image from URL');
                updatePreviews();
                updateLayersList();
                updateFilterPreviews(img)
            }, {crossOrigin: 'Anonymous'})
        } else {
            showNotification('Please enter a valid URL', 'error')
        }
    }

    function centerContent() {
        const objects = canvas.getObjects();
        if (objects.length === 0) return;
        objects.forEach(obj => {
            obj.center()
        });
        canvas.renderAll();
        updatePreviews();
        saveCanvasState('Centered content')
    }

    function resetCanvas() {
        Swal.fire({
            title: 'Reset Canvas?',
            text: 'This will clear all your work. Are you sure?',
            icon: 'warning',
            showCancelButton: !0,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, reset it!'
        }).then((result) => {
            if (result.isConfirmed) {
                canvas.clear();
                canvas.backgroundColor = '#ffffff';
                bgColorInput.value = '#ffffff';
                bgColorHexInput.value = '#ffffff';
                foregroundColorInput.value = '#000000';
                foregroundColorHexInput.value = '#000000';
                activeForegroundColor = '#000000';
                activeBackgroundColor = '#ffffff';
                canvas.renderAll();
                updatePreviews();
                updateLayersList();
                saveCanvasState('Reset canvas');
                showNotification('Canvas has been reset', 'success')
            }
        })
    }

    function applyPreset(preset) {
        canvas.clear();
        switch (preset) {
            case'letter':
                canvas.backgroundColor = '#4361ee';
                bgColorInput.value = '#4361ee';
                bgColorHexInput.value = '#4361ee';
                const letter = new fabric.Text('A', {
                    left: canvasSize / 2,
                    top: canvasSize / 2,
                    fontFamily: 'Arial',
                    fontSize: 300,
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    textAlign: 'center',
                    originX: 'center',
                    originY: 'center'
                });
                canvas.add(letter);
                break;
            case'circle-letter':
                canvas.backgroundColor = '#ffffff';
                bgColorInput.value = '#ffffff';
                bgColorHexInput.value = '#ffffff';
                const circle = new fabric.Circle({
                    radius: canvasSize / 3,
                    fill: '#f72585',
                    left: canvasSize / 2,
                    top: canvasSize / 2,
                    originX: 'center',
                    originY: 'center'
                });
                const circleLetter = new fabric.Text('F', {
                    left: canvasSize / 2,
                    top: canvasSize / 2,
                    fontFamily: 'Arial',
                    fontSize: 250,
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    textAlign: 'center',
                    originX: 'center',
                    originY: 'center'
                });
                canvas.add(circle);
                canvas.add(circleLetter);
                break;
            case'gradient':
                const gradientRect = new fabric.Rect({
                    left: 0,
                    top: 0,
                    width: canvasSize,
                    height: canvasSize,
                    selectable: !1
                });
                const gradient = new fabric.Gradient({
                    type: 'linear',
                    coords: {x1: 0, y1: 0, x2: canvasSize, y2: canvasSize},
                    colorStops: [{offset: 0, color: '#4361ee'}, {offset: 1, color: '#f72585'}]
                });
                gradientRect.set('fill', gradient);
                canvas.backgroundColor = '#ffffff';
                bgColorInput.value = '#ffffff';
                bgColorHexInput.value = '#ffffff';
                canvas.add(gradientRect);
                break;
            case'app-icon':
                canvas.backgroundColor = '#ffffff';
                bgColorInput.value = '#ffffff';
                bgColorHexInput.value = '#ffffff';
                const appIconBg = new fabric.Rect({
                    width: canvasSize * 0.6,
                    height: canvasSize * 0.6,
                    fill: '#4cc9f0',
                    left: canvasSize / 2,
                    top: canvasSize / 2,
                    originX: 'center',
                    originY: 'center',
                    rx: 60,
                    ry: 60
                });
                canvas.add(appIconBg);
                break;
            case'initials':
                canvas.backgroundColor = '#212529';
                bgColorInput.value = '#212529';
                bgColorHexInput.value = '#212529';
                const initials = new fabric.Text('FS', {
                    left: canvasSize / 2,
                    top: canvasSize / 2,
                    fontFamily: 'Arial',
                    fontSize: 200,
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    textAlign: 'center',
                    originX: 'center',
                    originY: 'center'
                });
                canvas.add(initials);
                break;
            case'star':
                canvas.backgroundColor = '#ffbd2e';
                bgColorInput.value = '#ffbd2e';
                bgColorHexInput.value = '#ffbd2e';
                const starObj = new fabric.Polygon(starPoints(5, canvasSize / 3, canvasSize / 6), {
                    fill: '#ffffff',
                    left: canvasSize / 2,
                    top: canvasSize / 2,
                    originX: 'center',
                    originY: 'center'
                });
                canvas.add(starObj);
                break
        }
        canvas.renderAll();
        updatePreviews();
        updateLayersList();
        saveCanvasState(`Applied ${preset} preset`);
        showNotification(`Applied ${preset} preset`, 'success')
    }

    function applyBackgroundPattern(patternType) {
        console.log(`1. Pattern function called with type: ${patternType}`);

        try {
            // Step 1: Create pattern canvas
            const patternCanvas = document.createElement('canvas');
            const patternCtx = patternCanvas.getContext('2d');
            patternCanvas.width = 40;
            patternCanvas.height = 40;

            // Set background
            patternCtx.fillStyle = activeBackgroundColor;
            patternCtx.fillRect(0, 0, 40, 40);

            console.log(`2. Created pattern canvas with background: ${activeBackgroundColor}`);

            // Apply pattern design based on type
            switch(patternType) {
                case 'dots':
                    patternCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                    for (let x = 10; x < 40; x += 20) {
                        for (let y = 10; y < 40; y += 20) {
                            patternCtx.beginPath();
                            patternCtx.arc(x, y, 4, 0, Math.PI * 2);
                            patternCtx.fill();
                        }
                    }
                    break;
                case 'grid':
                    patternCtx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                    patternCtx.lineWidth = 1;
                    for (let i = 0.5; i < 40; i += 10) {
                        patternCtx.beginPath();
                        patternCtx.moveTo(i, 0);
                        patternCtx.lineTo(i, 40);
                        patternCtx.stroke();

                        patternCtx.beginPath();
                        patternCtx.moveTo(0, i);
                        patternCtx.lineTo(40, i);
                        patternCtx.stroke();
                    }
                    break;
                case 'stripes':
                    patternCtx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                    for (let i = 0; i < 40; i += 10) {
                        patternCtx.fillRect(i, 0, 5, 40);
                    }
                    break;
                case 'waves':
                    patternCtx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                    patternCtx.lineWidth = 2;
                    for (let y = 10; y < 40; y += 20) {
                        patternCtx.beginPath();
                        patternCtx.moveTo(0, y);
                        patternCtx.bezierCurveTo(10, y-5, 30, y+5, 40, y);
                        patternCtx.stroke();
                    }
                    break;
                case 'zigzag':
                    patternCtx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                    patternCtx.lineWidth = 2;
                    patternCtx.beginPath();
                    for (let x = 0; x <= 40; x += 10) {
                        patternCtx.lineTo(x, x % 20 === 0 ? 10 : 30);
                    }
                    patternCtx.stroke();
                    break;
                case 'noise':
                    for (let i = 0; i < 500; i++) {
                        patternCtx.fillStyle = `rgba(0, 0, 0, ${Math.random() * 0.2})`;
                        patternCtx.fillRect(
                            Math.random() * 40,
                            Math.random() * 40,
                            1,
                            1
                        );
                    }
                    break;
            }

            console.log(`3. Pattern design applied`);

            // Check if the pattern canvas has content
            const imageData = patternCtx.getImageData(0, 0, 40, 40).data;
            let hasContent = false;
            for (let i = 0; i < imageData.length; i += 4) {
                if (imageData[i+3] > 0) { // Check alpha channel
                    hasContent = true;
                    break;
                }
            }

            if (!hasContent) {
                console.error("Pattern canvas appears to be empty");
                return;
            }

            // Step 2: Convert to dataURL
            const patternDataUrl = patternCanvas.toDataURL();
            console.log(`4. Pattern canvas converted to DataURL: ${patternDataUrl.substr(0, 30)}...`);

            // Step 3: Create image element for better compatibility
            const img = new Image();
            img.onload = function() {
                console.log(`5. Image loaded successfully, dimensions: ${img.width}x${img.height}`);

                try {
                    // TWO DIFFERENT APPROACHES - trying both for compatibility

                    // APPROACH 1: Use background Pattern
                    const pattern = new fabric.Pattern({
                        source: img,
                        repeat: 'repeat'
                    });

                    console.log(`6a. Created fabric pattern object`);

                    // Store original background
                    const originalBg = canvas.backgroundColor;

                    // Try to set background
                    canvas.setBackgroundColor(pattern, function() {
                        console.log(`7a. Background pattern applied with callback`);
                        canvas.renderAll();
                        updatePreviews();

                        // Verify if it worked
                        if (canvas.backgroundColor === originalBg) {
                            console.warn("Background didn't change, trying approach 2");
                            useApproach2();
                        } else {
                            console.log(`8a. Success! Background updated`);
                            saveCanvasState(`Applied ${patternType} pattern`);
                            showNotification(`Applied ${patternType} pattern`, 'success');
                        }
                    });

                    // APPROACH 2: Use background image
                    function useApproach2() {
                        console.log(`6b. Trying alternative approach with background rectangle`);

                        // Remove any existing pattern rectangles
                        canvas.getObjects().forEach(obj => {
                            if (obj._patternRect) {
                                canvas.remove(obj);
                            }
                        });

                        // Create pattern rectangle
                        const rect = new fabric.Rect({
                            width: canvas.width,
                            height: canvas.height,
                            left: canvas.width / 2,
                            top: canvas.height / 2,
                            originX: 'center',
                            originY: 'center',
                            fill: pattern,
                            selectable: false,
                            evented: false,
                            _patternRect: true
                        });

                        // Add to canvas at bottom
                        canvas.add(rect);
                        canvas.sendToBack(rect);
                        canvas.renderAll();

                        console.log(`7b. Background pattern rectangle applied`);
                        updatePreviews();
                        saveCanvasState(`Applied ${patternType} pattern`);
                        showNotification(`Applied ${patternType} pattern`, 'success');
                    }
                } catch (err) {
                    console.error("Error creating/applying pattern:", err);

                    // Fallback to solid color on error
                    canvas.backgroundColor = activeBackgroundColor;
                    canvas.renderAll();
                    updatePreviews();
                    showNotification(`Error applying pattern: ${err.message}`, 'error');
                }
            };

            img.onerror = function() {
                console.error("Failed to load pattern image");
                showNotification("Failed to create pattern", 'error');
            };

            // Set source to trigger loading
            img.src = patternDataUrl;

        } catch (err) {
            console.error("Error in pattern creation:", err);
            showNotification("Error creating pattern", 'error');
        }
    }

    function applyFilter(filter) {
        const activeObject = canvas.getActiveObject();
        if (!activeObject || !(activeObject instanceof fabric.Image)) {
            showNotification('Please select an image to apply filters', 'error');
            return
        }
        activeObject.filters = [];
        switch (filter) {
            case'grayscale':
                activeObject.filters.push(new fabric.Image.filters.Grayscale());
                break;
            case'sepia':
                activeObject.filters.push(new fabric.Image.filters.Sepia());
                break;
            case'invert':
                activeObject.filters.push(new fabric.Image.filters.Invert());
                break;
            case'blueprint':
                activeObject.filters.push(new fabric.Image.filters.BlendColor({
                    color: '#0a84ff',
                    mode: 'tint',
                    alpha: 0.5
                }));
                break;
            case'duotone':
                activeObject.filters.push(new fabric.Image.filters.Grayscale());
                activeObject.filters.push(new fabric.Image.filters.BlendColor({
                    color: '#f72585',
                    mode: 'multiply',
                    alpha: 0.5
                }));
                break
        }
        if (filter !== 'none') {
            activeFilter = filter
        } else {
            activeFilter = 'none'
        }
        activeObject.applyFilters();
        canvas.renderAll();
        updatePreviews();
        saveCanvasState(`Applied ${filter} filter`);
        showNotification(`Applied ${filter} filter`, 'success')
    }

    function updateFilterPreviews(img) {
        if (!img) {
            const objects = canvas.getObjects();
            for (let i = 0; i < objects.length; i++) {
                if (objects[i] instanceof fabric.Image) {
                    img = objects[i];
                    break
                }
            }
            if (!img) return
        }
        const filters = ['none', 'grayscale', 'sepia', 'invert', 'blueprint', 'duotone'];
        filters.forEach(filterType => {
            const previewImg = document.getElementById(`filter-preview-${filterType}`);
            if (!previewImg) return;
            const clone = fabric.util.object.clone(img);
            const previewCanvas = document.createElement('canvas');
            previewCanvas.width = 60;
            previewCanvas.height = 60;
            const previewFabricCanvas = new fabric.StaticCanvas(previewCanvas);
            clone.filters = [];
            switch (filterType) {
                case'grayscale':
                    clone.filters.push(new fabric.Image.filters.Grayscale());
                    break;
                case'sepia':
                    clone.filters.push(new fabric.Image.filters.Sepia());
                    break;
                case'invert':
                    clone.filters.push(new fabric.Image.filters.Invert());
                    break;
                case'blueprint':
                    clone.filters.push(new fabric.Image.filters.BlendColor({
                        color: '#0a84ff',
                        mode: 'tint',
                        alpha: 0.5
                    }));
                    break;
                case'duotone':
                    clone.filters.push(new fabric.Image.filters.Grayscale());
                    clone.filters.push(new fabric.Image.filters.BlendColor({
                        color: '#f72585',
                        mode: 'multiply',
                        alpha: 0.5
                    }));
                    break
            }
            if (filterType !== 'none') {
                clone.applyFilters()
            }
            const scale = Math.min(60 / clone.width, 60 / clone.height);
            clone.set({left: 30, top: 30, scaleX: scale, scaleY: scale, originX: 'center', originY: 'center'});
            previewFabricCanvas.add(clone);
            previewFabricCanvas.renderAll();
            previewImg.src = previewCanvas.toDataURL()
        })
    }

    function addShadowEffect() {
        const activeObject = canvas.getActiveObject();
        if (!activeObject) {
            showNotification('Please select an object to add shadow', 'error');
            return
        }
        activeObject.setShadow({color: 'rgba(0,0,0,0.3)', blur: 10, offsetX: 5, offsetY: 5});
        canvas.renderAll();
        updatePreviews();
        saveCanvasState('Added shadow effect');
        showNotification('Shadow effect added', 'success')
    }

    function addGradientEffect() {
        const activeObject = canvas.getActiveObject();
        if (!activeObject) {
            showNotification('Please select an object to add gradient', 'error');
            return
        }
        const gradient = new fabric.Gradient({
            type: 'linear',
            coords: {x1: 0, y1: 0, x2: activeObject.width || 100, y2: activeObject.height || 100},
            colorStops: [{offset: 0, color: '#4361ee'}, {offset: 1, color: '#f72585'}]
        });
        activeObject.set('fill', gradient);
        canvas.renderAll();
        updatePreviews();
        saveCanvasState('Added gradient effect');
        showNotification('Gradient effect added', 'success')
    }

    function addPatternEffect() {
        const activeObject = canvas.getActiveObject();
        if (!activeObject) {
            showNotification('Please select an object to add pattern', 'error');
            return
        }
        const patternCanvas = document.createElement('canvas');
        const patternCtx = patternCanvas.getContext('2d');
        patternCanvas.width = 20;
        patternCanvas.height = 20;
        patternCtx.fillStyle = '#ffffff';
        patternCtx.fillRect(0, 0, 20, 20);
        patternCtx.fillStyle = activeForegroundColor;
        patternCtx.fillRect(0, 0, 10, 10);
        patternCtx.fillRect(10, 10, 10, 10);
        const patternDataUrl = patternCanvas.toDataURL();
        fabric.util.loadImage(patternDataUrl, function (img) {
            if (!img) return;
            const pattern = new fabric.Pattern({source: img, repeat: 'repeat'});
            activeObject.set('fill', pattern);
            canvas.renderAll();
            updatePreviews();
            saveCanvasState('Added pattern effect');
            showNotification('Pattern effect added', 'success');
        });
    }

    function rotateObject(degrees) {
        const activeObject = canvas.getActiveObject();
        if (!activeObject) {
            showNotification('Please select an object to rotate', 'error');
            return
        }
        activeObject.rotate(activeObject.angle + degrees);
        canvas.renderAll();
        updatePreviews();
        saveCanvasState(`Rotated object by ${degrees}¬∞`)
    }

    function flipObject(direction) {
        const activeObject = canvas.getActiveObject();
        if (!activeObject) {
            showNotification('Please select an object to flip', 'error');
            return
        }
        if (direction === 'horizontal') {
            activeObject.set('flipX', !activeObject.flipX)
        } else {
            activeObject.set('flipY', !activeObject.flipY)
        }
        canvas.renderAll();
        updatePreviews();
        saveCanvasState(`Flipped object ${direction}`)
    }

    function zoomIn() {
        if (zoomLevel < 5) {
            zoomLevel += 0.1;
            applyZoom()
        }
    }

    function zoomOut() {
        if (zoomLevel > 0.3) {
            zoomLevel -= 0.1;
            applyZoom()
        }
    }

    function resetZoom() {
        zoomLevel = 1;
        applyZoom()
    }

    function applyZoom() {
        canvas.setZoom(zoomLevel);
        zoomLevelDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
        canvas.renderAll()
    }

    function setCanvasTool(tool) {
        if (isPolygonDrawing && tool !== 'shape') {
            cancelPolygonDrawing();
        }
        switch (tool) {
            case'select':
                canvas.isDrawingMode = !1;
                canvas.selection = true;
                break;
            case'draw':
                canvas.isDrawingMode = !0;
                canvas.freeDrawingBrush.color = activeForegroundColor;
                canvas.freeDrawingBrush.width = 5;
                break;
            case'text':
                addText();
                break;
            case'shape':
                Swal.fire({
                    title: 'Select Shape',
                    html: document.querySelector('.shape-grid').cloneNode(true).outerHTML,
                    showCancelButton: true,
                    cancelButtonText: 'Cancel',
                    showConfirmButton: false,
                    didOpen: () => {
                        const shapeBtns = Swal.getPopup().querySelectorAll('.shape-btn');
                        shapeBtns.forEach(btn => {
                            btn.addEventListener('click', () => {
                                const shape = btn.dataset.shape;
                                addShape(shape);
                                Swal.close()
                            })
                        })
                    }
                });
                break;
            case'crop':
                applyCropTool();
                break;
        }
    }

    function applyCropTool() {
        const activeObject = canvas.getActiveObject();
        if (!activeObject) {
            showNotification('Please select an object to crop', 'error');
            return;
        }
        if (activeObject.type === 'group') {
            showNotification('Cannot crop group objects. Please ungroup first.', 'error');
            return;
        }
        let objectBounds;
        if (activeObject instanceof fabric.Image) {
            objectBounds = {
                width: activeObject.width * activeObject.scaleX,
                height: activeObject.height * activeObject.scaleY,
                left: activeObject.left,
                top: activeObject.top,
                originX: activeObject.originX,
                originY: activeObject.originY
            };
        } else {
            const bound = activeObject.getBoundingRect();
            objectBounds = {
                width: bound.width,
                height: bound.height,
                left: bound.left + bound.width / 2,
                top: bound.top + bound.height / 2,
                originX: 'center',
                originY: 'center'
            };
        }
        const cropControls = document.createElement('div');
        cropControls.className = 'crop-controls';
        cropControls.style.position = 'relative';
        cropControls.style.top = '-100px';
        cropControls.style.zIndex = '1000';
        cropControls.style.display = 'flex';
        cropControls.style.gap = '10px';
        const cropRect = new fabric.Rect({
            left: objectBounds.left,
            top: objectBounds.top,
            width: objectBounds.width * 0.8,
            height: objectBounds.height * 0.8,
            originX: objectBounds.originX,
            originY: objectBounds.originY,
            fill: 'rgba(0,0,0,0.2)',
            stroke: '#ff0000',
            strokeWidth: 2,
            strokeDashArray: [5, 5]
        });
        canvas.add(cropRect);
        canvas.setActiveObject(cropRect);
        canvas.renderAll();
        const applyCropBtn = document.createElement('button');
        applyCropBtn.className = 'btn';
        applyCropBtn.innerHTML = '<i class="fas fa-crop"></i> Apply Crop';
        const cancelCropBtn = document.createElement('button');
        cancelCropBtn.className = 'btn btn-outline';
        cancelCropBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
        cropControls.appendChild(applyCropBtn);
        cropControls.appendChild(cancelCropBtn);
        document.getElementById('canvas-panel').appendChild(cropControls);
        applyCropBtn.addEventListener('click', () => {
            if (cropRect.width < 10 || cropRect.height < 10) {
                showNotification('Crop area too small', 'error');
                return;
            }
            if (activeObject instanceof fabric.Image) {
                const cropRectBounds = cropRect.getBoundingRect();
                const activeBounds = activeObject.getBoundingRect();
                const cropX = (cropRectBounds.left - activeBounds.left) / activeObject.scaleX;
                const cropY = (cropRectBounds.top - activeBounds.top) / activeObject.scaleY;
                const cropWidth = cropRectBounds.width / activeObject.scaleX;
                const cropHeight = cropRectBounds.height / activeObject.scaleY;
                const originalImgElement = activeObject.getElement();
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = cropWidth;
                tempCanvas.height = cropHeight;
                const tempContext = tempCanvas.getContext('2d');
                tempContext.drawImage(originalImgElement, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
                const croppedDataURL = tempCanvas.toDataURL('image/png');
                fabric.Image.fromURL(croppedDataURL, function (img) {
                    img.set({
                        left: cropRect.left,
                        top: cropRect.top,
                        originX: cropRect.originX,
                        originY: cropRect.originY
                    });
                    canvas.add(img);
                    canvas.remove(activeObject);
                    canvas.remove(cropRect);
                    canvas.setActiveObject(img);
                    canvas.renderAll();
                    updatePreviews();
                    updateLayersList();
                    saveCanvasState('Image cropped');
                });
            } else {
                activeObject.clipPath = new fabric.Rect({
                    originX: 'center',
                    originY: 'center',
                    width: cropRect.width / activeObject.scaleX,
                    height: cropRect.height / activeObject.scaleY,
                    left: 0,
                    top: 0
                });
                activeObject.set({left: cropRect.left, top: cropRect.top});
                canvas.remove(cropRect);
                canvas.renderAll();
                updatePreviews();
                updateLayersList();
                saveCanvasState('Object cropped');
            }
            document.getElementById('canvas-panel').removeChild(cropControls);
            document.getElementById('select-tool').click();
        });
        cancelCropBtn.addEventListener('click', () => {
            canvas.remove(cropRect);
            document.getElementById('canvas-panel').removeChild(cropControls);
            canvas.setActiveObject(activeObject);
            canvas.renderAll();
            document.getElementById('select-tool').click();
        });
    }

    function addNewLayer() {
        const rect = new fabric.Rect({
            left: canvasSize / 2,
            top: canvasSize / 2,
            fill: activeForegroundColor,
            width: canvasSize / 4,
            height: canvasSize / 4,
            originX: 'center',
            originY: 'center'
        });
        canvas.add(rect);
        rect.setCoords();
        canvas.setActiveObject(rect);
        canvas.renderAll();
        saveCanvasState('Added new layer');
        showNotification('New layer added', 'success')
    }

    function groupSelectedLayers() {
        if (!canvas.getActiveObject()) {
            showNotification('Please select objects to group', 'error');
            return
        }
        if (canvas.getActiveObject().type !== 'activeSelection') {
            showNotification('Please select multiple objects to group', 'error');
            return
        }
        const group = canvas.getActiveObject().toGroup();
        group.setCoords();
        canvas.renderAll();
        updateLayersList();
        saveCanvasState('Grouped layers');
        showNotification('Layers grouped', 'success')
    }

    function updateLayersList() {
        const objects = canvas.getObjects();
        layersList.innerHTML = '';
        if (objects.length === 0) {
            layersList.innerHTML = '<div class="empty-message">No layers yet</div>';
            return
        }
        objects.forEach((obj, index) => {
            const layerItem = document.createElement('div');
            layerItem.className = 'layer-item';
            if (canvas.getActiveObject() === obj) {
                layerItem.classList.add('active')
            }
            let layerName = '';
            if (obj.type === 'image') {
                layerName = 'Image'
            } else if (obj.type === 'textbox' || obj.type === 'text') {
                layerName = `Text: "${obj.text.substring(0, 10)}${obj.text.length > 10 ? '...' : ''}"`
            } else if (obj.type === 'group') {
                layerName = 'Group'
            } else {
                layerName = obj.type.charAt(0).toUpperCase() + obj.type.slice(1)
            }
            layerItem.innerHTML = `<i class="fas fa-eye layer-visibility"></i><div class="layer-name">${layerName}</div><div class="layer-actions"><button title="Move Up"><i class="fas fa-arrow-up"></i></button><button title="Move Down"><i class="fas fa-arrow-down"></i></button><button title="Delete"><i class="fas fa-trash-alt"></i></button></div>`;
            layerItem.addEventListener('click', () => {
                canvas.setActiveObject(obj);
                canvas.renderAll();
                updateLayersList()
            });
            const visibilityIcon = layerItem.querySelector('.layer-visibility');
            visibilityIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                obj.visible = !obj.visible;
                visibilityIcon.className = obj.visible ? 'fas fa-eye layer-visibility' : 'fas fa-eye-slash layer-visibility';
                canvas.renderAll();
                updatePreviews()
            });
            layerItem.querySelector('.layer-actions button:nth-child(1)').addEventListener('click', (e) => {
                e.stopPropagation();
                if (index < objects.length - 1) {
                    canvas.bringForward(obj);
                    updateLayersList();
                    saveCanvasState('Moved layer up')
                }
            });
            layerItem.querySelector('.layer-actions button:nth-child(2)').addEventListener('click', (e) => {
                e.stopPropagation();
                if (index > 0) {
                    canvas.sendBackwards(obj);
                    updateLayersList();
                    saveCanvasState('Moved layer down')
                }
            });
            layerItem.querySelector('.layer-actions button:nth-child(3)').addEventListener('click', (e) => {
                e.stopPropagation();
                canvas.remove(obj);
                updateLayersList();
                updatePreviews();
                saveCanvasState('Deleted layer')
            });
            layersList.appendChild(layerItem)
        })
    }

    function saveCanvasState(actionName) {
        const canvasJSON = JSON.stringify(canvas);
        if (historyPosition < historyStack.length - 1) {
            historyStack = historyStack.slice(0, historyPosition + 1)
        }
        historyStack.push({state: canvasJSON, action: actionName});
        if (historyStack.length > maxHistorySteps) {
            historyStack.shift()
        }
        historyPosition = historyStack.length - 1;
        updateHistoryList();
        updateUndoRedoButtons()
    }

    function updateHistoryList() {
        historyList.innerHTML = '';
        historyStack.forEach((item, index) => {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            if (index === historyPosition) {
                historyItem.style.fontWeight = 'bold';
                historyItem.style.color = 'var(--primary-color)'
            }
            let icon = 'fa-circle';
            if (item.action.includes('Added')) icon = 'fa-plus-circle';
            if (item.action.includes('Deleted')) icon = 'fa-minus-circle';
            if (item.action.includes('Modified')) icon = 'fa-edit';
            if (item.action.includes('Applied')) icon = 'fa-paint-brush';
            if (item.action.includes('Changed')) icon = 'fa-palette';
            historyItem.innerHTML = `<i class="fas ${icon}"></i><span>${item.action}</span>`;
            historyItem.addEventListener('click', () => {
                goToHistoryState(index)
            });
            historyList.appendChild(historyItem)
        })
    }

    function updateUndoRedoButtons() {
        undoBtn.disabled = historyPosition <= 0;
        redoBtn.disabled = historyPosition >= historyStack.length - 1;
        undoBtn.style.opacity = historyPosition <= 0 ? '0.5' : '1';
        redoBtn.style.opacity = historyPosition >= historyStack.length - 1 ? '0.5' : '1'
    }

    function undo() {
        if (historyPosition > 0) {
            historyPosition--;
            loadCanvasState(historyPosition);
            updateHistoryList();
            updateUndoRedoButtons()
        }
    }

    function redo() {
        if (historyPosition < historyStack.length - 1) {
            historyPosition++;
            loadCanvasState(historyPosition);
            updateHistoryList();
            updateUndoRedoButtons()
        }
    }

    function clearHistory() {
        Swal.fire({
            title: 'Clear History?',
            text: 'This will clear your undo/redo history. Are you sure?',
            icon: 'warning',
            showCancelButton: !0,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, clear it!'
        }).then((result) => {
            if (result.isConfirmed) {
                const currentState = historyStack[historyPosition].state;
                historyStack = [{state: currentState, action: 'Initial state'}];
                historyPosition = 0;
                updateHistoryList();
                updateUndoRedoButtons();
                showNotification('History cleared', 'success')
            }
        })
    }

    function goToHistoryState(index) {
        historyPosition = index;
        loadCanvasState(index);
        updateHistoryList();
        updateUndoRedoButtons()
    }

    function loadCanvasState(index) {
        if (index >= 0 && index < historyStack.length) {
            canvas.loadFromJSON(JSON.parse(historyStack[index].state), () => {
                canvas.renderAll();
                updatePreviews();
                updateLayersList()
            })
        }
    }

    function updatePreviews() {
        const dataUrl = canvas.toDataURL({format: 'png', quality: 1});
        document.getElementById('preview-16').src = dataUrl;
        document.getElementById('preview-32').src = dataUrl;
        document.getElementById('preview-48').src = dataUrl;
        document.getElementById('preview-64').src = dataUrl;
        document.getElementById('preview-128').src = dataUrl;
        document.getElementById('preview-192').src = dataUrl;
        document.getElementById('browser-tab-favicon').src = dataUrl;
        document.getElementById('browser-address-favicon').src = dataUrl;
        document.getElementById('mobile-icon-preview').src = dataUrl;
        updateCodeSnippets()
    }

    function updateTabFavicon() {
        const dataUrl = canvas.toDataURL({format: 'png'});
        const existingFavicon = document.querySelector('link[rel="icon"]');
        if (existingFavicon) {
            document.head.removeChild(existingFavicon)
        }
        const link = document.createElement('link');
        link.rel = 'icon';
        link.href = dataUrl;
        document.head.appendChild(link);
        showNotification('Favicon updated in browser tab!', 'success')
    }

    function togglePreviewBackground() {
        const isDark = previewBgToggle.checked;
        if (isDark) {
            document.getElementById('preview-bg-light').style.backgroundColor = '#333'
        } else {
            document.getElementById('preview-bg-light').style.backgroundColor = ''
        }
    }

    function updateCodeSnippets() {
        const baseCode = `<link rel="icon" type="image/png" href="favicon.png" sizes="32x32">`;
        document.getElementById('html-code-snippet').textContent = baseCode;
        const fullCode = `<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"><link rel="manifest" href="site.webmanifest"><meta name="msapplication-TileColor" content="${activeBackgroundColor}"><meta name="theme-color" content="${activeBackgroundColor}">`;
        document.getElementById('full-html-snippet').textContent = fullCode
    }

    function downloadPng() {
        const size = getSelectedSizes()[0] || 32;
        resizeCanvas(size).then(dataUrl => {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = `favicon-${size}.png`;
            link.click();
            showNotification(`Downloaded ${size}√ó${size} PNG favicon`, 'success')
        })
    }

    function downloadAllSizes() {
        const sizes = getSelectedSizes();
        if (sizes.length === 0) {
            showNotification('Please select at least one size to download', 'error');
            return
        }
        const zip = new JSZip();
        let completed = 0;
        const progressBar = document.createElement('div');
        progressBar.className = 'progress-bar';
        progressBar.innerHTML = `<div class="progress-fill" style="width:0%"></div>`;
        Swal.fire({
            title: 'Preparing Download',
            html: 'Creating your favicon package...',
            showConfirmButton: !1,
            allowOutsideClick: !1,
            willOpen: () => {
                Swal.getHtmlContainer().appendChild(progressBar)
            }
        });
        const progressFill = progressBar.querySelector('.progress-fill');
        const processSize = (index) => {
            if (index >= sizes.length) {
                zip.generateAsync({type: 'blob'}).then(content => {
                    saveAs(content, 'favicons.zip');
                    Swal.close();
                    showNotification('Favicon package downloaded', 'success')
                });
                return
            }
            const size = sizes[index];
            resizeCanvas(size).then(dataUrl => {
                const base64Data = dataUrl.split(',')[1];
                zip.file(`favicon-${size}.png`, base64Data, {base64: !0});
                completed++;
                const progress = (completed / sizes.length) * 100;
                progressFill.style.width = `${progress}%`;
                processSize(index + 1)
            })
        };
        processSize(0)
    }

    function getSelectedSizes() {
        const checkboxes = document.querySelectorAll('#export-panel input[type="checkbox"][data-size]:checked');
        return Array.from(checkboxes).map(cb => parseInt(cb.dataset.size, 10))
    }

    function resizeCanvas(size) {
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = size;
        tempCanvas.height = size;
        const tempCtx = tempCanvas.getContext('2d');
        return new Promise(resolve => {
            const dataUrl = canvas.toDataURL({format: 'png', quality: 1});
            const img = new Image();
            img.src = dataUrl;
            img.onload = () => {
                tempCtx.drawImage(img, 0, 0, size, size);
                resolve(tempCanvas.toDataURL('image/png'))
            }
        })
    }

    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        const text = element.textContent;
        navigator.clipboard.writeText(text).then(() => {
            showNotification('Copied to clipboard!', 'success')
        }).catch(err => {
            showNotification('Failed to copy: ' + err, 'error')
        })
    }

    function openSaveModal() {
        saveModal.classList.add('show');
        saveNameInput.focus()
    }

    function closeSaveModal() {
        saveModal.classList.remove('show')
    }

    function saveCurrentDesign() {
        const name = saveNameInput.value.trim() || 'Untitled Design';
        const dataUrl = canvas.toDataURL({format: 'png', quality: 0.5});
        const timestamp = new Date().toISOString();
        const canvasJSON = JSON.stringify(canvas);
        const design = {id: Date.now().toString(), name, preview: dataUrl, state: canvasJSON, created: timestamp};
        savedDesigns.push(design);
        localStorage.setItem('faviconDesigns', JSON.stringify(savedDesigns));
        loadSavedDesigns();
        closeSaveModal();
        showNotification('Design saved!', 'success')
    }

    function loadSavedDesigns() {
        const savedList = document.querySelector('.saved-list');
        savedList.innerHTML = '';
        if (savedDesigns.length === 0) {
            savedList.innerHTML = '<div class="empty-message">No saved designs</div>';
            return
        }
        savedDesigns.forEach(design => {
            const designItem = document.createElement('div');
            designItem.className = 'saved-item';
            const date = new Date(design.created);
            const formattedDate = date.toLocaleDateString();
            designItem.innerHTML = `<img src="${design.preview}" class="saved-preview"><div class="saved-info"><div class="saved-name">${design.name}</div><div class="saved-date">${formattedDate}</div></div><button class="icon-button delete-design" data-id="${design.id}"><i class="fas fa-trash"></i></button>`;
            designItem.addEventListener('click', (e) => {
                if (!e.target.closest('.delete-design')) {
                    loadDesign(design)
                }
            });
            designItem.querySelector('.delete-design').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteDesign(design.id)
            });
            savedList.appendChild(designItem)
        })
    }

    function loadDesign(design) {
        canvas.loadFromJSON(JSON.parse(design.state), () => {
            canvas.renderAll();
            updatePreviews();
            updateLayersList();
            saveCanvasState('Loaded saved design');
            showNotification(`Loaded "${design.name}"`, 'success')
        })
    }

    function deleteDesign(id) {
        savedDesigns = savedDesigns.filter(design => design.id !== id);
        localStorage.setItem('faviconDesigns', JSON.stringify(savedDesigns));
        loadSavedDesigns();
        showNotification('Design deleted', 'success')
    }

    function clearSavedDesigns() {
        Swal.fire({
            title: 'Clear All Saved Designs?',
            text: 'This will permanently delete all your saved designs. Are you sure?',
            icon: 'warning',
            showCancelButton: !0,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete all!'
        }).then((result) => {
            if (result.isConfirmed) {
                savedDesigns = [];
                localStorage.setItem('faviconDesigns', JSON.stringify(savedDesigns));
                loadSavedDesigns();
                showNotification('All saved designs cleared', 'success')
            }
        })
    }

    function handleSelectionCreated(options) {
        const obj = canvas.getActiveObject();
        activeLayer = obj;
        if (obj && obj.fill && typeof obj.fill === 'string') {
            activeForegroundColor = obj.fill;
            foregroundColorInput.value = obj.fill;
            foregroundColorHexInput.value = obj.fill
        }
        if (obj) {
            if (obj.stroke) {
                borderToggle.checked = !0;
                borderOptions.style.display = 'block';
                borderColorInput.value = obj.stroke;
                borderColorHexInput.value = obj.stroke;
                borderWidthSlider.value = obj.strokeWidth || 1;
                borderWidthValue.value = obj.strokeWidth || 1
            } else {
                borderToggle.checked = !1;
                borderOptions.style.display = 'none'
            }
            if (obj.opacity !== undefined) {
                opacitySlider.value = Math.round(obj.opacity * 100);
                opacityValue.value = Math.round(obj.opacity * 100)
            } else {
                opacitySlider.value = 100;
                opacityValue.value = 100
            }
        }
        updateLayersList()
    }

    function handleSelectionCleared() {
        activeLayer = null;
        borderToggle.checked = !1;
        borderOptions.style.display = 'none';
        opacitySlider.value = 100;
        opacityValue.value = 100;
        updateLayersList()
    }

    function handleKeyPress(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            return
        }
        switch (e.key.toLowerCase()) {
            case'v':
                document.getElementById('select-tool').click();
                break;
            case'm':
                document.getElementById('move-tool').click();
                break;
            case'b':
                document.getElementById('draw-tool').click();
                break;
            case't':
                document.getElementById('text-tool').click();
                break;
            case's':
                document.getElementById('shape-tool').click();
                break;
            case'c':
                document.getElementById('crop-tool').click();
                break;
            case'z':
                if (e.ctrlKey || e.metaKey) {
                    if (e.shiftKey) {
                        redo()
                    } else {
                        undo()
                    }
                }
                break;
            case'y':
                if (e.ctrlKey || e.metaKey) {
                    redo()
                }
                break;
            case'+':
            case'=':
                zoomIn();
                break;
            case'-':
                zoomOut();
                break;
            case'0':
                resetZoom();
                break;
            case'delete':
            case'backspace':
                if (canvas.getActiveObject()) {
                    canvas.remove(canvas.getActiveObject());
                    updateLayersList();
                    updatePreviews();
                    saveCanvasState('Deleted object')
                }
                break
        }
    }

    function closeShortcutsModal() {
        shortcutsModal.classList.remove('show')
    }

    function showNotification(message, type = 'info') {
        notificationMessage.textContent = message;
        notification.querySelector('i').className = '';
        switch (type) {
            case'success':
                notification.querySelector('i').className = 'fas fa-check-circle success';
                break;
            case'error':
                notification.querySelector('i').className = 'fas fa-times-circle error';
                break;
            case'info':
            default:
                notification.querySelector('i').className = 'fas fa-info-circle info';
                break
        }
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show')
        }, 3000)
    }

    function starPoints(points, outer, inner) {
        const results = [];
        const angle = Math.PI * 2 / points;
        for (let i = 0; i < points; i++) {
            results.push({x: Math.cos(angle * i) * outer, y: Math.sin(angle * i) * outer});
            results.push({x: Math.cos(angle * i + angle / 2) * inner, y: Math.sin(angle * i + angle / 2) * inner})
        }
        return results
    }

    function regularPolygonPoints(sides, radius) {
        const results = [];
        const angle = Math.PI * 2 / sides;
        for (let i = 0; i < sides; i++) {
            results.push({x: Math.cos(angle * i) * radius, y: Math.sin(angle * i) * radius})
        }
        return results
    }

    document.addEventListener('DOMContentLoaded', function () {
        const triangleIcon = document.querySelector('.shape-btn[data-shape="triangle"] .shape-icon i');
        if (triangleIcon) triangleIcon.className = 'fas fa-caret-up';
        const hexagonIcon = document.querySelector('.shape-btn[data-shape="hexagon"] .shape-icon i');
        if (hexagonIcon) hexagonIcon.className = 'fas fa-stop';
        const diamondIcon = document.querySelector('.shape-btn[data-shape="diamond"] .shape-icon i');
        if (diamondIcon) diamondIcon.className = 'fas fa-gem';
    });
    initializeApp()
});</script>