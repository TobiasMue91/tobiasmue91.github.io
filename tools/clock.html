<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="description"
          content="Precision clock with automatic time synchronization, customizable alarms with repeat options, 12/24 hour format toggle, and next alarm countdown.">
    <meta name="keywords"
          content="online clock,precision clock,world time,alarm clock,time sync,web clock,digital clock">
    <meta name="author" content="Claude Opus 4.5 prompted by Tobias Müller">
    <meta name="robots" content="index,follow">
    <link rel="canonical" href="https://www.gptgames.dev/tools/clock.html">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.gptgames.dev/tools/clock.html">
    <meta property="og:title" content="Precision Clock - Synchronized Time & Alarms">
    <meta property="og:description"
          content="Precision clock with automatic time synchronization, customizable alarms with repeat options, 12/24 hour format toggle, and next alarm countdown.">
    <meta property="og:image" content="https://www.gptgames.dev/screenshots/screenshot_240.webp">
    <meta property="og:site_name" content="GPT Games">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://www.gptgames.dev/tools/clock.html">
    <meta name="twitter:title" content="Precision Clock - Synchronized Time & Alarms">
    <meta name="twitter:description"
          content="Precision clock with automatic time synchronization, customizable alarms with repeat options, 12/24 hour format toggle, and next alarm countdown.">
    <meta name="twitter:image" content="https://www.gptgames.dev/screenshots/screenshot_240.webp">
    <meta name="application-name" content="Precision Clock">
    <meta name="theme-color" content="#0a0f1a">
    <title>Precision Clock</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;600&display=swap"
          rel="stylesheet">
    <style>* {
        margin: 0;
        padding: 0;
        box-sizing: border-box
    }

    :root {
        --bg: #0a0f1a;
        --card: #131c2e;
        --card-alt: #1a2540;
        --text: #f1f5f9;
        --text-muted: #64748b;
        --text-dim: #475569;
        --accent: #14b8a6;
        --accent-dim: #0f766e;
        --danger: #ef4444;
        --success: #22c55e;
        --warning: #eab308;
        --border: #1e3a5f;
        --shadow: 0 8px 32px rgba(0, 0, 0, 0.4)
    }

    body {
        font-family: 'Inter', sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1.5rem 1rem
    }

    .container {
        max-width: 480px;
        width: 100%
    }

    .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow)
    }

    .clock-card {
        text-align: center;
        padding: 2rem 1.5rem
    }

    .sync-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1.25rem
    }

    .sync-status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.7rem;
        color: var(--text-muted);
        padding: 0.35rem 0.75rem;
        background: var(--card-alt);
        border-radius: 2rem;
        cursor: pointer;
        transition: background 0.15s;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        border: none;
        font-family: inherit
    }

    .sync-status:hover:not(:disabled) {
        background: var(--border)
    }

    .sync-status:disabled {
        cursor: not-allowed;
        opacity: 0.6
    }

    .sync-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--warning);
        flex-shrink: 0
    }

    .sync-dot.synced {
        background: var(--success)
    }

    .sync-dot.error {
        background: var(--danger)
    }

    .sync-dot.local {
        background: var(--text-muted)
    }

    .sync-dot.syncing {
        animation: pulse 1s infinite
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1
        }
        50% {
            opacity: 0.4
        }
    }

    .format-toggle {
        font-size: 0.7rem;
        padding: 0.35rem 0.6rem;
        background: var(--card-alt);
        border: none;
        border-radius: 2rem;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.15s;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        font-family: inherit
    }

    .format-toggle:hover {
        background: var(--border);
        color: var(--text)
    }

    .time-display {
        font-family: 'JetBrains Mono', monospace;
        font-size: clamp(3.5rem, 14vw, 5.5rem);
        font-weight: 600;
        letter-spacing: -0.03em;
        line-height: 1;
        margin-bottom: 0.25rem
    }

    .time-display .seconds {
        color: var(--accent);
        font-weight: 500
    }

    .time-display .period {
        font-size: 0.35em;
        color: var(--text-muted);
        margin-left: 0.25rem;
        font-weight: 500;
        vertical-align: super
    }

    .date-display {
        font-size: 0.95rem;
        color: var(--text-muted);
        margin-bottom: 1.25rem
    }

    .next-alarm {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 1rem;
        background: var(--card-alt);
        border-radius: 0.5rem;
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-bottom: 1.25rem
    }

    .next-alarm svg {
        width: 14px;
        height: 14px;
        color: var(--accent)
    }

    .next-alarm strong {
        color: var(--text);
        font-family: 'JetBrains Mono', monospace;
        font-weight: 500
    }

    .next-alarm .countdown {
        color: var(--accent)
    }

    .next-alarm.none {
        opacity: 0.5
    }

    .tz-badges {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5rem
    }

    .tz-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.4rem 0.7rem;
        background: var(--card-alt);
        border-radius: 0.375rem;
        font-size: 0.75rem;
        color: var(--text-muted)
    }

    .tz-badge svg {
        width: 14px;
        height: 14px;
        color: var(--accent)
    }

    .tz-badge.dst {
        border: 1px solid var(--warning);
        color: var(--warning)
    }

    .tz-badge.source {
        font-size: 0.65rem;
        color: var(--text-dim)
    }

    .alarms-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem
    }

    .alarms-header h2 {
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem
    }

    .alarm-count {
        font-size: 0.7rem;
        background: var(--card-alt);
        padding: 0.2rem 0.5rem;
        border-radius: 1rem;
        color: var(--text-muted);
        font-weight: 500
    }

    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        padding: 0.55rem 0.9rem;
        border: none;
        border-radius: 0.5rem;
        font-family: inherit;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s
    }

    .btn:active {
        transform: scale(0.97)
    }

    .btn-primary {
        background: var(--accent);
        color: var(--bg)
    }

    .btn-primary:hover {
        background: var(--accent-dim)
    }

    .btn-ghost {
        background: transparent;
        color: var(--text-muted);
        padding: 0.5rem
    }

    .btn-ghost:hover {
        background: var(--card-alt);
        color: var(--text)
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        padding: 0
    }

    .alarm-form {
        display: none;
        background: var(--card-alt);
        border-radius: 0.75rem;
        padding: 1.25rem;
        margin-bottom: 1rem
    }

    .alarm-form.active {
        display: block;
        animation: slideDown 0.2s ease-out
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-8px)
        }
        to {
            opacity: 1;
            transform: translateY(0)
        }
    }

    .form-title {
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em
    }

    .form-row {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 0.75rem
    }

    .form-group {
        flex: 1
    }

    .form-group label {
        display: block;
        font-size: 0.7rem;
        color: var(--text-dim);
        margin-bottom: 0.35rem;
        text-transform: uppercase;
        letter-spacing: 0.05em
    }

    .form-group input, .form-group select {
        width: 100%;
        padding: 0.7rem 0.75rem;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        color: var(--text);
        font-family: inherit;
        font-size: 0.9rem;
        transition: border-color 0.15s
    }

    .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: var(--accent)
    }

    .form-group input[type="time"] {
        font-family: 'JetBrains Mono', monospace
    }

    .form-group select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center
    }

    .form-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border)
    }

    .sound-test {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: var(--text-muted);
        cursor: pointer;
        transition: color 0.15s;
        background: none;
        border: none;
        font-family: inherit
    }

    .sound-test:hover {
        color: var(--text)
    }

    .sound-test svg {
        width: 16px;
        height: 16px
    }

    .form-btns {
        display: flex;
        gap: 0.5rem
    }

    .alarms-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem
    }

    .alarm-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem 1rem;
        background: var(--card-alt);
        border-radius: 0.75rem;
        transition: all 0.15s;
        cursor: pointer;
        border: 1px solid transparent
    }

    .alarm-item:hover {
        border-color: var(--border)
    }

    .alarm-item.disabled {
        opacity: 0.45
    }

    .alarm-item.disabled:hover {
        opacity: 0.55
    }

    .alarm-item.next {
        border-color: var(--accent);
        background: rgba(20, 184, 166, 0.08)
    }

    .alarm-item.editing {
        border-color: var(--accent)
    }

    .alarm-info {
        flex: 1;
        min-width: 0
    }

    .alarm-time {
        font-family: 'JetBrains Mono', monospace;
        font-size: 1.35rem;
        font-weight: 500;
        line-height: 1.2
    }

    .alarm-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.15rem
    }

    .alarm-label {
        color: var(--text-muted);
        font-size: 0.75rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap
    }

    .alarm-repeat {
        font-size: 0.65rem;
        padding: 0.15rem 0.4rem;
        background: var(--border);
        border-radius: 0.25rem;
        color: var(--text-dim);
        text-transform: uppercase;
        letter-spacing: 0.03em
    }

    .alarm-actions {
        display: flex;
        align-items: center;
        gap: 0.25rem
    }

    .alarm-toggle {
        position: relative;
        width: 40px;
        height: 22px;
        background: var(--border);
        border-radius: 11px;
        cursor: pointer;
        transition: background 0.2s;
        flex-shrink: 0
    }

    .alarm-toggle.active {
        background: var(--accent)
    }

    .alarm-toggle::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 18px;
        height: 18px;
        background: white;
        border-radius: 50%;
        transition: transform 0.2s
    }

    .alarm-toggle.active::after {
        transform: translateX(18px)
    }

    .delete-btn {
        position: relative;
        overflow: hidden
    }

    .delete-btn.confirm {
        background: var(--danger);
        color: white
    }

    .delete-btn.confirm svg {
        display: none
    }

    .delete-btn.confirm::after {
        content: '?';
        font-size: 0.9rem;
        font-weight: 600
    }

    .empty-state {
        text-align: center;
        padding: 2.5rem 1rem;
        color: var(--text-dim)
    }

    .empty-state svg {
        width: 40px;
        height: 40px;
        margin-bottom: 0.75rem;
        opacity: 0.4;
        color: var(--text-muted)
    }

    .empty-state p {
        font-size: 0.85rem
    }

    .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        z-index: 100;
        align-items: center;
        justify-content: center;
        padding: 1rem
    }

    .modal-overlay.active {
        display: flex
    }

    .modal {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 1rem;
        padding: 2rem;
        max-width: 340px;
        width: 100%;
        text-align: center;
        box-shadow: var(--shadow);
        animation: modalIn 0.25s ease-out
    }

    @keyframes modalIn {
        from {
            opacity: 0;
            transform: scale(0.9) translateY(10px)
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0)
        }
    }

    .modal-icon {
        width: 56px;
        height: 56px;
        margin: 0 auto 1rem;
        color: var(--accent);
        animation: ring 0.4s ease-in-out infinite
    }

    @keyframes ring {
        0%, 100% {
            transform: rotate(0)
        }
        20% {
            transform: rotate(12deg)
        }
        40% {
            transform: rotate(-12deg)
        }
        60% {
            transform: rotate(8deg)
        }
        80% {
            transform: rotate(-8deg)
        }
    }

    .modal h3 {
        font-size: 0.85rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.25rem
    }

    .modal .alarm-modal-time {
        font-family: 'JetBrains Mono', monospace;
        font-size: 3.5rem;
        font-weight: 600;
        color: var(--text);
        margin: 0.5rem 0
    }

    .modal .alarm-modal-label {
        color: var(--text-muted);
        margin-bottom: 1.5rem;
        font-size: 0.9rem
    }

    .modal-actions {
        display: flex;
        gap: 0.75rem
    }

    .modal-actions .btn {
        flex: 1;
        padding: 0.75rem
    }

    footer {
        margin-top: auto;
        padding-top: 1.5rem;
        text-align: center;
        color: var(--text-dim);
        font-size: 0.7rem
    }

    @media (max-width: 400px) {
        .form-row {
            flex-direction: column
        }

        .modal-actions {
            flex-direction: column
        }
    }</style>
</head>
<body>
<div class="container">
    <div class="card clock-card">
        <div class="sync-row">
            <button class="sync-status" id="syncStatus" title="Click to resync"><span class="sync-dot syncing"
                                                                                      id="syncDot"></span><span
                    id="syncText">Syncing</span></button>
            <button class="format-toggle" id="formatToggle">24h</button>
        </div>
        <div class="time-display" id="timeDisplay">--:--<span class="seconds">:--</span></div>
        <div class="date-display" id="dateDisplay">Loading...</div>
        <div class="next-alarm none" id="nextAlarm">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
            </svg>
            <span>No alarms set</span></div>
        <div class="tz-badges" id="tzBadges"></div>
    </div>
    <div class="card">
        <div class="alarms-header"><h2>Alarms<span class="alarm-count" id="alarmCount">0</span></h2>
            <button class="btn btn-primary" id="addAlarmBtn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add
            </button>
        </div>
        <div class="alarm-form" id="alarmForm">
            <div class="form-title" id="formTitle">New Alarm</div>
            <div class="form-row">
                <div class="form-group"><label>Time</label><input type="time" id="alarmTimeInput" required></div>
                <div class="form-group"><label>Repeat</label><select id="alarmRepeatInput">
                    <option value="once">Once</option>
                    <option value="daily">Daily</option>
                    <option value="weekdays">Weekdays</option>
                    <option value="weekends">Weekends</option>
                </select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Label</label><input type="text" id="alarmLabelInput" placeholder="Alarm"
                                                                   maxlength="30"></div>
            </div>
            <div class="form-actions">
                <button class="sound-test" id="soundTest" type="button">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                    </svg>
                    Test sound
                </button>
                <div class="form-btns">
                    <button class="btn btn-ghost" id="cancelAlarmBtn" type="button">Cancel</button>
                    <button class="btn btn-primary" id="saveAlarmBtn" type="button">Save</button>
                </div>
            </div>
        </div>
        <div class="alarms-list" id="alarmsList"></div>
    </div>
</div>
<div class="modal-overlay" id="alarmModal">
    <div class="modal">
        <svg class="modal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
            <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
            <line x1="1" y1="1" x2="4" y2="4"/>
            <line x1="23" y1="1" x2="20" y2="4"/>
        </svg>
        <h3>Alarm</h3>
        <div class="alarm-modal-time" id="modalTime">07:00</div>
        <div class="alarm-modal-label" id="modalLabel">Alarm</div>
        <div class="modal-actions">
            <button class="btn btn-ghost" id="snoozeBtn">Snooze 5m</button>
            <button class="btn btn-primary" id="dismissBtn">Dismiss</button>
        </div>
    </div>
</div>
<footer>Time sync via timeapi.io / gettimeapi.dev / WorldTimeAPI</footer>
<script>
    (function () {
        'use strict';
        const Config = {
            SYNC_INTERVAL: 600000,
            MIN_SYNC_GAP: 60000,
            CACHE_MAX_AGE: 3600000,
            REQUEST_TIMEOUT: 8000,
            STORAGE_KEY: 'precision_alarms',
            PREFS_KEY: 'precision_prefs',
            SYNC_KEY: 'precision_sync'
        };
        const TimeAPIs = [{
            name: 'timeapi.io',
            url: tz => `https://timeapi.io/api/time/current/zone?timeZone=${encodeURIComponent(tz)}`,
            parse: d => {
                if (!d || !d.dateTime) throw new Error('Invalid response');
                const dt = d.dateTime.includes('T') ? d.dateTime : d.dateTime.replace(' ', 'T');
                const unix = Date.parse(dt);
                if (isNaN(unix)) throw new Error('Invalid datetime');
                return {
                    unix,
                    tz: d.timeZone,
                    abbr: d.timeZone?.split('/').pop()?.substring(0, 4) || '',
                    offset: null,
                    dst: d.dstActive || false
                }
            }
        }, {
            name: 'gettimeapi.dev',
            url: tz => `https://gettimeapi.dev/v1/time?timezone=${encodeURIComponent(tz)}`,
            parse: d => {
                if (!d || !d.iso8601) throw new Error('Invalid response');
                const unix = Date.parse(d.iso8601);
                if (isNaN(unix)) throw new Error('Invalid datetime');
                return {
                    unix,
                    tz: d.timezone,
                    abbr: d.timezone?.split('/').pop()?.substring(0, 4) || '',
                    offset: null,
                    dst: null
                }
            }
        }, {
            name: 'WorldTimeAPI',
            url: tz => `https://worldtimeapi.org/api/timezone/${encodeURIComponent(tz)}`,
            parse: d => {
                if (!d || typeof d.unixtime !== 'number') throw new Error('Invalid response');
                return {
                    unix: d.unixtime * 1000,
                    tz: d.timezone,
                    abbr: d.abbreviation || '',
                    offset: d.utc_offset || null,
                    dst: d.dst || false
                }
            }
        }];

        class TimeSync {
            constructor() {
                this.offset = 0;
                this.source = null;
                this.tzData = null;
                this.lastAttempt = 0;
                this.lastSuccess = 0;
                this.failures = 0;
                this.syncing = false;
                this.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone
            }

            async sync(force = false) {
                const now = Date.now();
                if (this.syncing) return false;
                if (!force && now - this.lastAttempt < Config.MIN_SYNC_GAP) return false;
                if (!force && this.source && now - this.lastSuccess < Config.SYNC_INTERVAL) return false;
                this.syncing = true;
                this.lastAttempt = now;
                this.updateUI('syncing', 'Syncing...');
                let success = false;
                for (const api of TimeAPIs) {
                    try {
                        const result = await this.tryAPI(api);
                        this.offset = result.offset;
                        this.source = result.name;
                        this.tzData = {tz: result.tz, abbr: result.abbr, offset: result.utcOffset, dst: result.dst};
                        this.lastSuccess = Date.now();
                        this.failures = 0;
                        success = true;
                        this.saveCache();
                        this.renderBadges();
                        this.updateUI('synced', result.name);
                        break
                    } catch (e) {
                        console.warn(`${api.name} failed:`, e.message)
                    }
                }
                if (!success) {
                    this.failures++;
                    const backoff = Math.min(300000, Config.MIN_SYNC_GAP * Math.pow(2, this.failures - 1));
                    this.lastAttempt = Date.now() - Config.MIN_SYNC_GAP + backoff;
                    if (this.source) {
                        this.updateUI('synced', this.source + ' (stale)')
                    } else {
                        this.offset = 0;
                        this.source = null;
                        this.updateUI('local', 'Device time')
                    }
                }
                this.syncing = false;
                return success
            }

            async tryAPI(api) {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), Config.REQUEST_TIMEOUT);
                const t0 = performance.now();
                try {
                    const url = api.url(this.timezone);
                    const res = await fetch(url, {signal: controller.signal, mode: 'cors', cache: 'no-store'});
                    clearTimeout(timeout);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const data = await res.json();
                    const rtt = performance.now() - t0;
                    const parsed = api.parse(data);
                    const latency = rtt / 2;
                    const serverTime = parsed.unix + latency;
                    const offset = serverTime - Date.now();
                    return {...parsed, offset, latency, name: api.name}
                } catch (e) {
                    clearTimeout(timeout);
                    throw e
                }
            }

            now() {
                return new Date(Date.now() + this.offset)
            }

            updateUI(state, text) {
                const dot = document.getElementById('syncDot');
                const txt = document.getElementById('syncText');
                const btn = document.getElementById('syncStatus');
                if (!dot || !txt || !btn) return;
                dot.className = 'sync-dot ' + (state === 'syncing' ? 'syncing' : state === 'synced' ? 'synced' : state === 'local' ? 'local' : 'error');
                txt.textContent = text;
                btn.disabled = this.syncing;
                btn.title = state === 'synced' ? 'Click to resync' : state === 'error' ? 'Click to retry' : 'Syncing...'
            }

            renderBadges() {
                const el = document.getElementById('tzBadges');
                if (!el || !this.tzData) return;
                const badges = [`<div class="tz-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>${this.tzData.abbr || this.tzData.tz.split('/').pop()}</div>`];
                if (this.tzData.offset) badges.push(`<div class="tz-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>UTC${this.tzData.offset}</div>`);
                if (this.tzData.dst) badges.push(`<div class="tz-badge dst"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/></svg>DST</div>`);
                el.innerHTML = badges.join('')
            }

            saveCache() {
                try {
                    localStorage.setItem(Config.SYNC_KEY, JSON.stringify({
                        offset: this.offset,
                        source: this.source,
                        tzData: this.tzData,
                        time: Date.now()
                    }))
                } catch (e) {
                }
            }

            loadCache() {
                try {
                    const c = JSON.parse(localStorage.getItem(Config.SYNC_KEY));
                    if (c && Date.now() - c.time < Config.CACHE_MAX_AGE) {
                        this.offset = c.offset;
                        this.source = c.source + ' (cached)';
                        this.tzData = c.tzData;
                        this.renderBadges();
                        this.updateUI('synced', this.source);
                        return true
                    }
                } catch (e) {
                }
                return false
            }
        }

        class AlarmManager {
            constructor(timeSync) {
                this.timeSync = timeSync;
                this.alarms = [];
                this.activeAlarmId = null;
                this.editingId = null;
                this.deleteConfirmId = null;
                this.deleteTimeout = null;
                this.audioCtx = null;
                this.soundInterval = null
            }

            load() {
                try {
                    this.alarms = JSON.parse(localStorage.getItem(Config.STORAGE_KEY)) || []
                } catch (e) {
                    this.alarms = []
                }
            }

            save() {
                try {
                    localStorage.setItem(Config.STORAGE_KEY, JSON.stringify(this.alarms))
                } catch (e) {
                }
                this.render();
                this.updateNextAlarm()
            }

            genId() {
                return Date.now().toString(36) + Math.random().toString(36).slice(2, 6)
            }

            add(data) {
                this.alarms.push({id: this.genId(), ...data, enabled: true});
                this.save()
            }

            update(id, data) {
                const alarm = this.alarms.find(a => a.id === id);
                if (alarm) Object.assign(alarm, data);
                this.save()
            }

            delete(id) {
                this.alarms = this.alarms.filter(a => a.id !== id);
                this.save()
            }

            toggle(id) {
                const alarm = this.alarms.find(a => a.id === id);
                if (alarm) alarm.enabled = !alarm.enabled;
                this.save()
            }

            getNext() {
                const now = this.timeSync.now();
                const today = now.getDay();
                const nowMins = now.getHours() * 60 + now.getMinutes();
                let best = null, bestMins = Infinity;
                for (const a of this.alarms.filter(x => x.enabled)) {
                    const [h, m] = a.time.split(':').map(Number);
                    const alarmMins = h * 60 + m;
                    const r = a.repeat || 'once';
                    for (let d = 0; d < 8; d++) {
                        const checkDay = (today + d) % 7;
                        const dayMins = d * 1440 + (alarmMins - nowMins);
                        if (dayMins <= 0 && d === 0) continue;
                        const fires = (r === 'daily') || (r === 'weekdays' && checkDay >= 1 && checkDay <= 5) || (r === 'weekends' && (checkDay === 0 || checkDay === 6)) || (r === 'once' && d < 2);
                        if (fires && dayMins < bestMins) {
                            bestMins = dayMins;
                            best = {alarm: a, mins: dayMins};
                            break
                        }
                    }
                }
                return best
            }

            shouldFire(alarm, day) {
                if (!alarm.enabled) return false;
                const r = alarm.repeat || 'once';
                if (r === 'daily') return true;
                if (r === 'weekdays') return day >= 1 && day <= 5;
                if (r === 'weekends') return day === 0 || day === 6;
                return true
            }

            check() {
                if (this.activeAlarmId) return;
                const now = this.timeSync.now();
                const h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
                if (s !== 0) return;
                const t = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                const day = now.getDay();
                for (const a of this.alarms) {
                    if (a.time === t && this.shouldFire(a, day)) {
                        if (a.repeat === 'once') a.enabled = false;
                        this.trigger(a);
                        break
                    }
                }
            }

            trigger(alarm) {
                this.activeAlarmId = alarm.id;
                document.getElementById('modalTime').textContent = this.formatTimeShort(alarm.time);
                document.getElementById('modalLabel').textContent = alarm.label || 'Alarm';
                document.getElementById('alarmModal').classList.add('active');
                this.playSound();
                this.save()
            }

            dismiss() {
                this.activeAlarmId = null;
                this.stopSound();
                document.getElementById('alarmModal').classList.remove('active')
            }

            snooze() {
                const a = this.alarms.find(x => x.id === this.activeAlarmId);
                if (a) {
                    const now = this.timeSync.now();
                    now.setMinutes(now.getMinutes() + 5);
                    a.time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                    a.enabled = true;
                    a.repeat = 'once';
                    this.save()
                }
                this.dismiss()
            }

            playSound(test = false) {
                if (!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const gain = this.audioCtx.createGain();
                gain.gain.value = 0.25;
                gain.connect(this.audioCtx.destination);
                const beep = (freq, dur) => {
                    const osc = this.audioCtx.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    osc.connect(gain);
                    osc.start();
                    osc.stop(this.audioCtx.currentTime + dur)
                };
                if (test) {
                    beep(880, 0.1);
                    setTimeout(() => beep(660, 0.1), 150);
                    return
                }
                this.stopSound();
                const loop = () => {
                    if (!this.activeAlarmId) return;
                    beep(880, 0.12);
                    setTimeout(() => beep(660, 0.12), 180);
                    this.soundInterval = setTimeout(loop, 1200)
                };
                loop()
            }

            stopSound() {
                if (this.soundInterval) {
                    clearTimeout(this.soundInterval);
                    this.soundInterval = null
                }
            }

            updateNextAlarm() {
                const info = this.getNext();
                const el = document.getElementById('nextAlarm');
                if (!el) return;
                if (!info) {
                    el.className = 'next-alarm none';
                    el.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg><span>No upcoming alarms</span>';
                    return
                }
                const hrs = Math.floor(info.mins / 60), mins = info.mins % 60;
                let countdown = hrs > 0 ? `${hrs}h ` : '';
                countdown += `${mins}m`;
                el.className = 'next-alarm';
                el.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg><span>Next: <strong>${this.formatTimeShort(info.alarm.time)}</strong> in <span class="countdown">${countdown}</span></span>`
            }

            formatTimeShort(timeStr) {
                const [h, m] = timeStr.split(':').map(Number);
                if (App.prefs.format24) return timeStr;
                const period = h >= 12 ? 'PM' : 'AM';
                return `${String(h % 12 || 12).padStart(2, '0')}:${String(m).padStart(2, '0')}${period}`
            }

            render() {
                const list = document.getElementById('alarmsList');
                const countEl = document.getElementById('alarmCount');
                if (!list || !countEl) return;
                const next = this.getNext();
                const nextId = next?.alarm.id;
                countEl.textContent = this.alarms.length;
                if (!this.alarms.length) {
                    list.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg><p>No alarms yet</p></div>';
                    return
                }
                const repeatLabels = {once: 'Once', daily: 'Daily', weekdays: 'Mon–Fri', weekends: 'Sat–Sun'};
                const sorted = [...this.alarms].sort((a, b) => a.time.localeCompare(b.time));
                list.innerHTML = sorted.map(a => {
                    const isNext = a.id === nextId && a.enabled;
                    const cls = ['alarm-item'];
                    if (!a.enabled) cls.push('disabled');
                    if (isNext) cls.push('next');
                    if (a.id === this.editingId) cls.push('editing');
                    return `<div class="${cls.join(' ')}" data-id="${a.id}"><div class="alarm-info"><div class="alarm-time">${this.formatTimeShort(a.time)}</div><div class="alarm-meta"><span class="alarm-label">${a.label || 'Alarm'}</span><span class="alarm-repeat">${repeatLabels[a.repeat || 'once']}</span></div></div><div class="alarm-actions"><div class="alarm-toggle${a.enabled ? ' active' : ''}" data-action="toggle"></div><button class="btn btn-ghost btn-icon delete-btn${this.deleteConfirmId === a.id ? ' confirm' : ''}" data-action="delete"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></div></div>`
                }).join('')
            }
        }

        const App = {
            timeSync: null, alarms: null, prefs: {format24: true},
            init() {
                this.timeSync = new TimeSync();
                this.alarms = new AlarmManager(this.timeSync);
                this.loadPrefs();
                this.alarms.load();
                this.timeSync.loadCache();
                this.updateFormatBtn();
                this.alarms.render();
                this.alarms.updateNextAlarm();
                this.bindEvents();
                this.timeSync.sync();
                this.startClock();
                setInterval(() => this.timeSync.sync(), Config.SYNC_INTERVAL);
                setInterval(() => this.alarms.updateNextAlarm(), 60000)
            },
            loadPrefs() {
                try {
                    this.prefs = JSON.parse(localStorage.getItem(Config.PREFS_KEY)) || {format24: true}
                } catch (e) {
                    this.prefs = {format24: true}
                }
            },
            savePrefs() {
                try {
                    localStorage.setItem(Config.PREFS_KEY, JSON.stringify(this.prefs))
                } catch (e) {
                }
            },
            updateFormatBtn() {
                const btn = document.getElementById('formatToggle');
                if (btn) btn.textContent = this.prefs.format24 ? '24h' : '12h'
            },
            startClock() {
                const update = () => {
                    const now = this.timeSync.now();
                    const h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
                    const timeEl = document.getElementById('timeDisplay');
                    const dateEl = document.getElementById('dateDisplay');
                    if (timeEl) timeEl.innerHTML = this.formatTime(h, m, s);
                    if (dateEl) {
                        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        dateEl.textContent = `${days[now.getDay()]}, ${months[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`
                    }
                    this.alarms.check()
                };
                update();
                setInterval(update, 1000)
            },
            formatTime(h, m, s) {
                const pad = n => String(n).padStart(2, '0');
                let period = '';
                if (!this.prefs.format24) {
                    period = h >= 12 ? 'PM' : 'AM';
                    h = h % 12 || 12
                }
                return `${pad(h)}:${pad(m)}<span class="seconds">:${pad(s)}</span>${this.prefs.format24 ? '' : `<span class="period">${period}</span>`}`
            },
            bindEvents() {
                document.getElementById('formatToggle')?.addEventListener('click', () => {
                    this.prefs.format24 = !this.prefs.format24;
                    this.updateFormatBtn();
                    this.savePrefs();
                    this.alarms.render();
                    this.alarms.updateNextAlarm()
                });
                document.getElementById('syncStatus')?.addEventListener('click', () => this.timeSync.sync(true));
                document.getElementById('addAlarmBtn')?.addEventListener('click', () => this.openForm());
                document.getElementById('cancelAlarmBtn')?.addEventListener('click', () => this.closeForm());
                document.getElementById('saveAlarmBtn')?.addEventListener('click', () => this.saveForm());
                document.getElementById('soundTest')?.addEventListener('click', () => this.alarms.playSound(true));
                document.getElementById('dismissBtn')?.addEventListener('click', () => this.alarms.dismiss());
                document.getElementById('snoozeBtn')?.addEventListener('click', () => this.alarms.snooze());
                document.getElementById('alarmForm')?.addEventListener('keydown', e => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.saveForm()
                    }
                });
                document.getElementById('alarmsList')?.addEventListener('click', e => {
                    const item = e.target.closest('.alarm-item');
                    if (!item) return;
                    const id = item.dataset.id;
                    const action = e.target.closest('[data-action]')?.dataset.action;
                    if (action === 'toggle') {
                        e.stopPropagation();
                        this.alarms.toggle(id)
                    } else if (action === 'delete') {
                        e.stopPropagation();
                        if (this.alarms.deleteConfirmId === id) {
                            clearTimeout(this.alarms.deleteTimeout);
                            this.alarms.deleteConfirmId = null;
                            this.alarms.delete(id)
                        } else {
                            if (this.alarms.deleteTimeout) clearTimeout(this.alarms.deleteTimeout);
                            this.alarms.deleteConfirmId = id;
                            this.alarms.render();
                            this.alarms.deleteTimeout = setTimeout(() => {
                                this.alarms.deleteConfirmId = null;
                                this.alarms.render()
                            }, 2000)
                        }
                    } else {
                        const alarm = this.alarms.alarms.find(a => a.id === id);
                        if (alarm) this.openForm(alarm)
                    }
                });
                document.addEventListener('keydown', e => {
                    if (e.key === 'Escape') {
                        if (this.alarms.activeAlarmId) this.alarms.dismiss(); else if (document.getElementById('alarmForm')?.classList.contains('active')) this.closeForm()
                    }
                })
            },
            openForm(alarm = null) {
                this.alarms.editingId = alarm?.id || null;
                document.getElementById('formTitle').textContent = alarm ? 'Edit Alarm' : 'New Alarm';
                document.getElementById('alarmTimeInput').value = alarm?.time || '';
                document.getElementById('alarmLabelInput').value = alarm?.label || '';
                document.getElementById('alarmRepeatInput').value = alarm?.repeat || 'once';
                document.getElementById('alarmForm')?.classList.add('active');
                document.getElementById('alarmTimeInput')?.focus();
                this.alarms.render()
            },
            closeForm() {
                this.alarms.editingId = null;
                document.getElementById('alarmForm')?.classList.remove('active');
                this.alarms.render()
            },
            saveForm() {
                const time = document.getElementById('alarmTimeInput')?.value;
                if (!time) return;
                const data = {
                    time,
                    label: document.getElementById('alarmLabelInput')?.value.trim() || '',
                    repeat: document.getElementById('alarmRepeatInput')?.value || 'once'
                };
                if (this.alarms.editingId) {
                    this.alarms.update(this.alarms.editingId, data)
                } else {
                    this.alarms.add(data)
                }
                this.closeForm()
            }
        };
        document.addEventListener('DOMContentLoaded', () => App.init());
    })();
</script>
<script src="../logo.js"></script>
</body>
</html>