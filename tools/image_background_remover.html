<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Image Background Remover Tool | Free & Easy to Use</title>
    <meta name="title" content="Online Image Background Remover Tool | Free & Easy to Use">
    <meta name="description" content="Remove image backgrounds instantly with our free online tool. No signup required, works directly in your browser with AI-powered detection for clean, professional results.">
    <meta name="keywords" content="background remover, remove image background, transparent background, image editing tool, free background remover, online photo editor, AI background removal">
    <meta name="author" content="Claude 3.7 Sonnet prompted by Tobias M√ºller">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    <link rel="canonical" href="https://www.gptgames.dev/tools/image_background_remover.html">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.gptgames.dev/tools/image_background_remover.html">
    <meta property="og:title" content="Free Online Image Background Remover Tool">
    <meta property="og:description" content="Remove backgrounds from your images in seconds with our free online tool. No signup, no upload to server - all processing happens in your browser.">
    <meta property="og:image" content="https://www.gptgames.dev/screenshots/screenshot_181.png">
    <meta property="og:image:alt" content="Image Background Remover Tool Screenshot">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://www.gptgames.dev/tools/image_background_remover.html">
    <meta property="twitter:title" content="Free Online Image Background Remover Tool">
    <meta property="twitter:description" content="Remove backgrounds from your images in seconds. Free, private, and runs entirely in your browser.">
    <meta property="twitter:image" content="https://www.gptgames.dev/screenshots/screenshot_181.png">
    <meta property="twitter:image:alt" content="Image Background Remover Tool Screenshot">
    <meta name="application-name" content="Image Background Remover">
    <meta name="theme-color" content="#4361ee">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Background Remover">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üñºÔ∏è</text></svg>">
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --background: #ffffff;
            --card-bg: #f8f9fa;
            --text: #212529;
            --text-light: #6c757d;
            --border: #dee2e6;
            --success: #28a745;
            --error: #dc3545;
            --shadow: rgba(0, 0, 0, 0.1);
            --radius: 8px;
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --background: #121212;
            --card-bg: #1e1e1e;
            --text: #f8f9fa;
            --text-light: #adb5bd;
            --border: #343a40;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            transition: var(--transition);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .tagline {
            color: var(--text-light);
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            outline: none;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: 0 4px 12px var(--shadow);
            padding: 25px;
            margin-bottom: 30px;
            transition: var(--transition);
        }

        .card-title {
            font-size: 1.25rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title svg {
            width: 20px;
            height: 20px;
            fill: var(--primary);
        }

        .upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #drop-area {
            width: 100%;
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 30px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
        }

        #drop-area.highlight {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.05);
        }

        #drop-area p {
            margin-bottom: 15px;
            color: var(--text-light);
        }

        #fileInput {
            display: none;
        }

        .file-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .file-btn:hover {
            background-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .preview-container {
            margin-top: 25px;
            max-width: 100%;
            display: none;
        }

        #preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: var(--radius);
            display: block;
            margin: 0 auto;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }

        .preview-tool {
            display: none;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
            gap: 15px;
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: var(--radius);
            background-color: var(--background);
        }

        .preview-canvas-container {
            width: 100%;
            max-width: 300px;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: 0 4px 8px var(--shadow);
        }

        #preview-canvas {
            display: block;
            width: 100%;
            height: auto;
        }

        .preview-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 5px;
        }

        label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        select, input[type="color"] {
            padding: 8px 12px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background-color: var(--background);
            color: var(--text);
            transition: var(--transition);
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
        }

        input[type="color"] {
            height: 38px;
            padding: 2px;
        }

        input[type="range"] {
            width: 100%;
            appearance: none;
            height: 6px;
            background: var(--border);
            outline: none;
            border-radius: 10px;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .threshold-value {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 5px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: var(--border);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .result-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #output-canvas {
            max-width: 100%;
            max-height: 500px;
            border-radius: var(--radius);
            display: none;
            box-shadow: 0 4px 8px var(--shadow);
        }

        .btn-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        footer {
            text-align: center;
            margin-top: auto;
            padding: 20px;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .info-text {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            padding: 12px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .error-text {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--error);
            padding: 12px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            font-size: 0.9rem;
            display: none;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .progress-text {
            margin-top: 10px;
            font-size: 14px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .tip-text {
            color: var(--text-light);
            font-style: italic;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .threshold-control {
            width: 100%;
            max-width: 300px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 2rem;
            }

            .card {
                padding: 20px;
            }

            .control-item {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>Image Background Remover</h1>
        <p class="tagline">Remove backgrounds from your images in seconds</p>
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        </button>
    </header>

    <div class="card">
        <h2 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 0 0-3.7-3.7 48.678 48.678 0 0 0-7.324 0 4.006 4.006 0 0 0-3.7 3.7c-.017.22-.032.441-.046.662M19.5 12l3-3m-3 3-3-3m-12 3c0 1.232.046 2.453.138 3.662a4.006 4.006 0 0 0 3.7 3.7 48.656 48.656 0 0 0 7.324 0 4.006 4.006 0 0 0 3.7-3.7c.017-.22.032-.441.046-.662M4.5 12l3 3m-3-3-3 3"/>
            </svg>
            Upload Image
        </h2>
        <div class="info-text">
            For best results, upload images with clear subjects. This tool works especially well with people in the
            foreground.
        </div>
        <div class="error-text" id="error-text"></div>
        <div class="upload-container">
            <div id="drop-area">
                <p>Drag & drop your image here<br>or</p>
                <input type="file" id="fileInput" accept="image/*">
                <label for="fileInput" class="file-btn">Choose File</label>
            </div>
            <div class="preview-container" id="preview-container">
                <img id="preview" alt="Preview">
            </div>
        </div>
    </div>

    <div class="card">
        <h2 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 3a3 3 0 0 0-3 3v2.25a3 3 0 0 0 3 3h2.25a3 3 0 0 0 3-3V6a3 3 0 0 0-3-3H6zm9.75 0a3 3 0 0 0-3 3v2.25a3 3 0 0 0 3 3H18a3 3 0 0 0 3-3V6a3 3 0 0 0-3-3h-2.25zM6 12.75a3 3 0 0 0-3 3V18a3 3 0 0 0 3 3h2.25a3 3 0 0 0 3-3v-2.25a3 3 0 0 0-3-3H6zm9.75 0a3 3 0 0 0-3 3V18a3 3 0 0 0 3 3H18a3 3 0 0 0 3-3v-2.25a3 3 0 0 0-3-3h-2.25z"/>
            </svg>
            Settings & Preview
        </h2>
        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label for="bg-option">Background Type</label>
                    <select id="bg-option">
                        <option value="transparent">Transparent</option>
                        <option value="color">Custom Color</option>
                    </select>
                </div>
                <div class="control-item" id="color-picker-container" style="display: none;">
                    <label for="bg-color">Background Color</label>
                    <input type="color" id="bg-color" value="#ffffff">
                </div>
            </div>

            <div class="preview-tool" id="preview-tool">
                <div class="preview-title">Live Preview - Adjust Detection Precision</div>
                <div class="preview-canvas-container">
                    <canvas id="preview-canvas"></canvas>
                </div>
                <div class="threshold-control">
                    <input type="range" id="threshold" min="0.1" max="0.9" step="0.05" value="0.6">
                    <div class="threshold-value">Detection Precision: <span id="threshold-value">0.6</span></div>
                    <p class="tip-text">Move the slider to adjust how precisely the foreground is detected.</p>
                </div>
            </div>

            <button id="process-btn" class="btn btn-primary" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 8V5c0-1 1-2 2-2h10c1 0 2 1 2 2v3"></path>
                    <path d="M19 16v3c0 1-1 2-2 2H7c-1 0-2-1-2-2v-3"></path>
                    <path d="M12 8v8"></path>
                    <path d="M8 12l4-4 4 4"></path>
                </svg>
                Process Full Image
            </button>
        </div>
    </div>

    <div class="card">
        <h2 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path fill-rule="evenodd"
                      d="M1.5 6a2.25 2.25 0 0 1 2.25-2.25h16.5A2.25 2.25 0 0 1 22.5 6v12a2.25 2.25 0 0 1-2.25 2.25H3.75A2.25 2.25 0 0 1 1.5 18V6zM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0 0 21 18v-1.94l-2.69-2.689a1.5 1.5 0 0 0-2.12 0l-.88.879.97.97a.75.75 0 1 1-1.06 1.06l-5.16-5.159a1.5 1.5 0 0 0-2.12 0L3 16.061zm10.125-7.81a1.125 1.125 0 1 1 2.25 0 1.125 1.125 0 0 1-2.25 0z"
                      clip-rule="evenodd"/>
            </svg>
            Result
        </h2>
        <div class="result-container">
            <canvas id="output-canvas"></canvas>
            <div class="btn-row">
                <button id="download-btn" class="btn btn-primary" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download Image
                </button>
                <button id="reset-btn" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 2v6h6"></path>
                        <path d="M3 13a9 9 0 1 0 3-7.7L3 8"></path>
                    </svg>
                    Start Over
                </button>
            </div>
        </div>
    </div>
</div>

<footer>
    <p>All processing happens in your browser - no images are uploaded to any server</p>
</footer>

<div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
    <p id="loading-text">Loading model...</p>
    <p class="progress-text" id="progress-text"></p>
</div>

<!-- TensorFlow.js -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
<!-- BodyPix model -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0/dist/body-pix.min.js"></script>

<script>
    // Global variables
    let model, originalImage, previewSegmentation;
    const MAX_PREVIEW_SIZE = 300; // Maximum size for preview dimension
    let previewImageScaled = false;

    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const previewContainer = document.getElementById('preview-container');
    const previewTool = document.getElementById('preview-tool');
    const previewCanvas = document.getElementById('preview-canvas');
    const processBtn = document.getElementById('process-btn');
    const downloadBtn = document.getElementById('download-btn');
    const resetBtn = document.getElementById('reset-btn');
    const outputCanvas = document.getElementById('output-canvas');
    const dropArea = document.getElementById('drop-area');
    const bgOption = document.getElementById('bg-option');
    const bgColor = document.getElementById('bg-color');
    const colorPickerContainer = document.getElementById('color-picker-container');
    const thresholdInput = document.getElementById('threshold');
    const thresholdValue = document.getElementById('threshold-value');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const progressText = document.getElementById('progress-text');
    const themeToggle = document.getElementById('theme-toggle');
    const errorText = document.getElementById('error-text');

    // Initialize the app
    async function init() {
        setupEventListeners();
        setupTheme();

        // Load the BodyPix model
        try {
            loadingOverlay.style.display = 'flex';
            loadingText.textContent = 'Loading model...';
            model = await bodyPix.load({
                architecture: 'MobileNetV1',
                outputStride: 16,
                multiplier: 0.75,
                quantBytes: 2
            });
            loadingOverlay.style.display = 'none';
        } catch (error) {
            console.error('Error loading model:', error);
            loadingOverlay.style.display = 'none';
            showError('Failed to load the image processing model. Please check your internet connection and try again.');
        }
    }

    // Set up event listeners
    function setupEventListeners() {
        // File input
        fileInput.addEventListener('change', handleFileSelect);

        // Drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        dropArea.addEventListener('dragenter', () => dropArea.classList.add('highlight'), false);
        dropArea.addEventListener('dragover', () => dropArea.classList.add('highlight'), false);
        dropArea.addEventListener('dragleave', () => dropArea.classList.remove('highlight'), false);
        dropArea.addEventListener('drop', handleDrop, false);

        // Process button
        processBtn.addEventListener('click', processFullImage);

        // Background options
        bgOption.addEventListener('change', () => {
            colorPickerContainer.style.display =
                bgOption.value === 'color' ? 'block' : 'none';
            updatePreview();
        });

        bgColor.addEventListener('input', updatePreview);

        // Download button
        downloadBtn.addEventListener('click', downloadResult);

        // Reset button
        resetBtn.addEventListener('click', resetApp);

        // Theme toggle
        themeToggle.addEventListener('click', toggleTheme);

        // Threshold slider
        thresholdInput.addEventListener('input', () => {
            thresholdValue.textContent = thresholdInput.value;
            debounce(updatePreview, 100)();
        });
    }

    // Debounce function to limit how often a function is called
    function debounce(func, wait) {
        let timeout;
        return function () {
            const context = this;
            const args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    // Show error message
    function showError(message) {
        errorText.textContent = message;
        errorText.style.display = 'block';
    }

    // Hide error message
    function hideError() {
        errorText.style.display = 'none';
    }

    // Handle file selection
    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
            loadImage(file);
        }
    }

    // Handle file drop
    function handleDrop(e) {
        dropArea.classList.remove('highlight');
        const file = e.dataTransfer.files[0];
        if (file) {
            loadImage(file);
        }
    }

    // Load the selected image
    function loadImage(file) {
        if (!file.type.match('image.*')) {
            showError('Please select an image file.');
            return;
        }

        hideError();

        const reader = new FileReader();
        reader.onload = function (e) {
            const img = new Image();
            img.onload = function () {
                originalImage = img;
                preview.src = img.src;
                previewContainer.style.display = 'block';

                // Create preview thumbnail and show controls
                createPreviewThumbnail(img);

                processBtn.disabled = false;
                outputCanvas.style.display = 'none';
                downloadBtn.disabled = true;
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    // Create a scaled-down version of the image for the preview
    function createPreviewThumbnail(img) {
        // Calculate thumbnail size (maintain aspect ratio)
        let width = img.width;
        let height = img.height;
        const maxDimension = Math.max(width, height);

        if (maxDimension > MAX_PREVIEW_SIZE) {
            const scale = MAX_PREVIEW_SIZE / maxDimension;
            width = Math.floor(width * scale);
            height = Math.floor(height * scale);
            previewImageScaled = true;
        } else {
            previewImageScaled = false;
        }

        // Set canvas size
        previewCanvas.width = width;
        previewCanvas.height = height;

        // Draw the image on the canvas
        const ctx = previewCanvas.getContext('2d');
        ctx.clearRect(0, 0, width, height);
        ctx.drawImage(img, 0, 0, width, height);

        // Show the preview tool
        previewTool.style.display = 'flex';

        // Initial preview segmentation
        setTimeout(() => updatePreview(), 100);
    }

    // Update the preview with current threshold
    async function updatePreview() {
        if (!originalImage || !model || !previewCanvas.width) return;

        try {
            loadingOverlay.style.display = 'flex';
            loadingText.textContent = 'Updating preview...';

            const threshold = parseFloat(thresholdInput.value);

            // Get segmentation
            previewSegmentation = await model.segmentPerson(previewCanvas, {
                flipHorizontal: false,
                internalResolution: 'low',
                segmentationThreshold: threshold,
                maxDetections: 1
            });

            // Apply to preview
            const ctx = previewCanvas.getContext('2d');

            // Draw the original image first
            ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
            ctx.drawImage(originalImage, 0, 0, previewCanvas.width, previewCanvas.height);

            // Get image data
            const imageData = ctx.getImageData(0, 0, previewCanvas.width, previewCanvas.height);
            const data = imageData.data;

            // Get background option
            let bgColorArray = [0, 0, 0, 0]; // Default transparent

            if (bgOption.value === 'color') {
                const colorHex = bgColor.value;
                bgColorArray = [
                    parseInt(colorHex.slice(1, 3), 16),
                    parseInt(colorHex.slice(3, 5), 16),
                    parseInt(colorHex.slice(5, 7), 16),
                    255
                ];
            }

            // Apply segmentation mask
            for (let i = 0; i < previewSegmentation.data.length; i++) {
                const pixelIndex = i * 4;
                if (!previewSegmentation.data[i]) {
                    data[pixelIndex] = bgColorArray[0];     // R
                    data[pixelIndex + 1] = bgColorArray[1]; // G
                    data[pixelIndex + 2] = bgColorArray[2]; // B
                    data[pixelIndex + 3] = bgColorArray[3]; // A
                }
            }

            // Put the modified image data back
            ctx.putImageData(imageData, 0, 0);

            loadingOverlay.style.display = 'none';
        } catch (error) {
            loadingOverlay.style.display = 'none';
            console.error('Error updating preview:', error);
            showError('Error creating preview. Please try again with a different image.');
        }
    }

    // Process the full image with current settings
    async function processFullImage() {
        if (!originalImage || !model) return;

        loadingOverlay.style.display = 'flex';
        loadingText.textContent = 'Processing image...';
        progressText.textContent = 'This may take a moment for large images';

        try {
            // Get segmentation with the current threshold
            const threshold = parseFloat(thresholdInput.value);

            const segmentation = await model.segmentPerson(originalImage, {
                flipHorizontal: false,
                internalResolution: 'medium',
                segmentationThreshold: threshold,
                maxDetections: 1
            });

            // Draw result to canvas
            const canvas = outputCanvas;
            canvas.width = originalImage.width;
            canvas.height = originalImage.height;
            const ctx = canvas.getContext('2d');

            // Draw the original image
            ctx.drawImage(originalImage, 0, 0);

            // Get image data
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            // Get background option
            let bgColorArray = [0, 0, 0, 0]; // Default transparent

            if (bgOption.value === 'color') {
                const colorHex = bgColor.value;
                bgColorArray = [
                    parseInt(colorHex.slice(1, 3), 16),
                    parseInt(colorHex.slice(3, 5), 16),
                    parseInt(colorHex.slice(5, 7), 16),
                    255
                ];
            }

            // Apply segmentation mask
            for (let i = 0; i < segmentation.data.length; i++) {
                const pixelIndex = i * 4;
                if (!segmentation.data[i]) {
                    data[pixelIndex] = bgColorArray[0];     // R
                    data[pixelIndex + 1] = bgColorArray[1]; // G
                    data[pixelIndex + 2] = bgColorArray[2]; // B
                    data[pixelIndex + 3] = bgColorArray[3]; // A
                }
            }

            // Put the modified image data back
            ctx.putImageData(imageData, 0, 0);

            // Show the result
            canvas.style.display = 'block';
            downloadBtn.disabled = false;

            loadingOverlay.style.display = 'none';
        } catch (error) {
            loadingOverlay.style.display = 'none';
            console.error('Error processing full image:', error);
            showError('Error processing image. Please try again with a different image.');
        }
    }

    // Download the result image
    function downloadResult() {
        const canvas = outputCanvas;

        // Determine file extension based on background option
        const fileExtension = bgOption.value === 'transparent' ? 'png' : 'jpg';
        const mimeType = bgOption.value === 'transparent' ? 'image/png' : 'image/jpeg';

        canvas.toBlob(function (blob) {
            const link = document.createElement('a');
            link.download = `removed-background.${fileExtension}`;
            link.href = URL.createObjectURL(blob);
            link.click();
            URL.revokeObjectURL(link.href);
        }, mimeType, 0.9);
    }

    // Reset the application
    function resetApp() {
        fileInput.value = '';
        preview.src = '';
        previewContainer.style.display = 'none';
        previewTool.style.display = 'none';
        outputCanvas.style.display = 'none';
        processBtn.disabled = true;
        downloadBtn.disabled = true;
        hideError();
    }

    // Set up theme based on system preference
    function setupTheme() {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefersDark) {
            document.documentElement.setAttribute('data-theme', 'dark');
        } else {
            document.documentElement.setAttribute('data-theme', 'light');
        }
        updateThemeIcon(prefersDark);
    }

    // Toggle between light and dark theme
    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        updateThemeIcon(newTheme === 'dark');

        // Save preference to localStorage
        localStorage.setItem('theme', newTheme);
    }

    // Update theme icon
    function updateThemeIcon(isDark) {
        themeToggle.innerHTML = isDark
            ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>'
            : '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
    }

    // Check for saved theme preference
    function checkSavedTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme === 'dark');
        } else {
            setupTheme();
        }
    }

    // Initialize the app when the page loads
    window.addEventListener('DOMContentLoaded', () => {
        checkSavedTheme();
        init();
    });
</script>
<script src="../logo.js"></script>
</body>
</html>