<!DOCTYPE html>
<html lang="en" data-theme="light" data-mode="basic">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Script Generator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¬</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/13.0.0/marked.min.js"></script>
    <style>
        :root {
            --primary-color: #1a1a1a;
            --secondary-color: #f5f5f5;
            --accent-color: #c13a44; /* Toned down red */
            --accent-hover: #a53039;
            --text-color: #333;
            --text-light: #6c757d;
            --white: #fff;
            --border-color: #ddd;
            --card-bg: #fff;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --header-bg: linear-gradient(135deg, #1a1a1a, #333);
            --header-text: #ffffff; /* Brighter white for better contrast */
            --input-bg: #fff;
            --btn-success: #28a745;
            --btn-info: #17a2b8;
            --transition: all 0.3s ease;
        }
        [data-theme="dark"] {
            --primary-color: #121212;
            --secondary-color: #212121;
            --text-color: #e0e0e0;
            --text-light: #aaaaaa;
            --white: #1e1e1e;
            --border-color: #444;
            --card-bg: #2d2d2d;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.2);
            --header-bg: linear-gradient(135deg, #121212, #1d1d1d);
            --header-text: #ffffff;
            --input-bg: #3a3a3a;
        }
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            transition: var(--transition);
            line-height: 1.6;
        }
        header {
            background: var(--header-bg);
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 {
            color: var(--header-text);
            margin: 0;
            font-size: 28px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3); /* Added shadow for better contrast */
        }
        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .theme-toggle, .mode-toggle {
            background: none;
            border: none;
            color: var(--header-text);
            font-size: 22px;
            cursor: pointer;
            padding: 5px;
            transition: var(--transition);
        }
        .theme-toggle:hover {transform: rotate(30deg);}
        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }
        .mode-label {
            font-size: 14px;
            font-weight: 500;
        }
        main {
            max-width: 1100px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 25px;
            overflow-x: auto;
            scroll-behavior: smooth;
        }
        .tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-light);
            font-weight: 500;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            margin-right: 5px;
            white-space: nowrap;
        }
        .tab.active {
            border-bottom: 3px solid var(--accent-color);
            color: var(--text-color);
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        .tab-content.active {display: block;}
        @keyframes fadeIn {from {opacity: 0;} to {opacity: 1;}}
        .card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
        }
        .card:hover {box-shadow: 0 6px 16px rgba(0,0,0,0.12);}
        .section-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-title i {color: var(--accent-color);}
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }
        .input-group:last-child {margin-bottom: 0;}
        label {
            font-weight: 500;
            font-size: 15px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        input, textarea, select {
            font-size: 16px;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: var(--transition);
            outline: none;
            font-family: 'Poppins', sans-serif;
        }
        input:focus, textarea:focus, select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(193,58,68,0.1);
        }
        textarea {resize: vertical; min-height: 100px;}
        button {
            font-size: 16px;
            font-weight: 500;
            background-color: var(--accent-color);
            color: var(--white);
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
        }
        button:hover {background-color: var(--accent-hover);}
        button:disabled {
            background-color: var(--text-light);
            cursor: not-allowed;
        }
        .range-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .range-input {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .range-input input[type="range"] {
            flex-grow: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 5px;
            background-color: var(--border-color);
            outline: none;
            margin: 0;
        }
        .range-input input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: var(--accent-color);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .range-value {
            min-width: 50px;
            text-align: center;
            font-weight: 500;
        }
        .btn-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
        }
        .btn-secondary:hover {
            background-color: rgba(193,58,68,0.1);
        }
        .btn-success {background-color: var(--btn-success);}
        .btn-success:hover {background-color: #218838;}
        .btn-info {background-color: var(--btn-info);}
        .btn-info:hover {background-color: #138496;}
        .loading-container {
            display: none;
            margin: 20px 0;
            text-align: center;
        }
        .loading-animation {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }
        .loading-animation div {
            display: inline-block;
            position: absolute;
            left: 8px;
            width: 16px;
            background: var(--accent-color);
            animation: loading 1.2s cubic-bezier(0, 0.5, 0.5, 1) infinite;
        }
        .loading-animation div:nth-child(1) {
            left: 8px;
            animation-delay: -0.24s;
        }
        .loading-animation div:nth-child(2) {
            left: 32px;
            animation-delay: -0.12s;
        }
        .loading-animation div:nth-child(3) {
            left: 56px;
            animation-delay: 0;
        }
        @keyframes loading {
            0% {top: 8px; height: 64px;}
            50%, 100% {top: 24px; height: 32px;}
        }
        .loading-text {
            color: var(--accent-color);
            font-weight: 500;
            margin-top: 10px;
        }
        .script-preview {
            min-height: 400px;
            max-height: 700px;
            overflow-y: auto;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 1.5;
        }
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .character-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            background: var(--input-bg);
        }
        .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
        }
        .remove-btn:hover {color: var(--accent-color);}
        .history-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }
        .history-item:hover {background-color: rgba(0,0,0,0.03);}
        .history-item-title {
            font-weight: 500;
            margin-bottom: 5px;
        }
        .history-item-info {
            font-size: 14px;
            color: var(--text-light);
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            font-weight: normal;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .helper-text {
            font-size: 14px;
            color: var(--text-light);
            margin-top: 5px;
        }
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card-bg);
            border-left: 4px solid var(--accent-color);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .notification.show {transform: translateX(0);}
        .notification-icon {
            font-size: 24px;
            color: var(--accent-color);
        }
        .notification-content {flex: 1;}
        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .notification-message {
            font-size: 14px;
            color: var(--text-light);
        }
        .notification-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--text-light);
            padding: 5px;
        }
        /* Basic/Advanced Mode Toggle Styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.3);
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent-color);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        /* Mode-specific display rules */
        [data-mode="basic"] .advanced-field {
            display: none;
        }
        [data-mode="basic"] .tab[data-tab="basics"],
        [data-mode="basic"] .tab[data-tab="script"],
        [data-mode="basic"] .tab[data-tab="history"] {
            display: block;
        }
        [data-mode="basic"] .tab[data-tab="characters"],
        [data-mode="basic"] .tab[data-tab="structure"],
        [data-mode="basic"] .tab[data-tab="advanced"] {
            display: none;
        }
        @media (max-width: 768px) {
            .two-col {grid-template-columns: 1fr;}
            .btn-row {flex-direction: column;}
            .range-input {flex-direction: column; align-items: flex-start;}
            .range-input input[type="range"] {width: 100%;}
            .tab {padding: 10px 15px; font-size: 14px;}
        }
    </style>
</head>
<body>
<header>
    <h1><i class="fas fa-film"></i> Movie Script Generator</h1>
    <div class="header-controls">
        <div class="mode-toggle">
            <span class="mode-label">Basic</span>
            <label class="switch">
                <input type="checkbox" id="mode-switch">
                <span class="slider"></span>
            </label>
            <span class="mode-label">Advanced</span>
        </div>
        <button id="save-btn" class="btn-secondary"><i class="fas fa-save"></i> Save</button>
        <button class="theme-toggle" id="theme-toggle"><i class="fas fa-moon"></i></button>
    </div>
</header>

<main>
    <div class="tabs">
        <button class="tab active" data-tab="basics"><i class="fas fa-info-circle"></i> Basics</button>
        <button class="tab advanced-tab" data-tab="characters"><i class="fas fa-users"></i> Characters</button>
        <button class="tab advanced-tab" data-tab="structure"><i class="fas fa-columns"></i> Structure</button>
        <button class="tab advanced-tab" data-tab="advanced"><i class="fas fa-sliders-h"></i> Advanced</button>
        <button class="tab" data-tab="script"><i class="fas fa-scroll"></i> Script</button>
        <button class="tab" data-tab="history"><i class="fas fa-history"></i> History</button>
    </div>

    <!-- Basics Tab -->
    <div id="basics" class="tab-content active">
        <div class="card">
            <h2 class="section-title"><i class="fas fa-file-alt"></i> Basic Information</h2>
            <div class="input-group">
                <label for="movie-title"><i class="fas fa-heading"></i> Movie Title</label>
                <input type="text" id="movie-title" placeholder="Enter your movie title" required>
            </div>
            <div class="input-group">
                <label for="genre" class="tooltip">
                    <i class="fas fa-theater-masks"></i> Genre
                    <span class="tooltiptext">Select a genre for your movie or enter a custom one</span>
                </label>
                <select id="genre">
                    <option value="">Select a genre</option>
                    <option value="Action">Action</option>
                    <option value="Comedy">Comedy</option>
                    <option value="Drama">Drama</option>
                    <option value="Fantasy">Fantasy</option>
                    <option value="Horror">Horror</option>
                    <option value="Mystery">Mystery</option>
                    <option value="Romance">Romance</option>
                    <option value="Science Fiction">Science Fiction</option>
                    <option value="Thriller">Thriller</option>
                    <option value="Other">Other</option>
                </select>
                <input type="text" id="custom-genre" placeholder="Enter custom genre" style="display: none;">
            </div>
            <div class="input-group">
                <label for="additional-criteria"><i class="fas fa-list-ul"></i> Additional Requirements (Optional)</label>
                <textarea id="additional-criteria" placeholder="Enter any additional criteria, themes, or special requirements"></textarea>
            </div>

            <div class="input-group">
                <label class="tooltip">
                    <i class="fas fa-lightbulb"></i> Creativity Level
                    <span class="tooltiptext">Higher values produce more creative but potentially less coherent scripts</span>
                </label>
                <div class="range-container">
                    <div class="range-input">
                        <input type="range" id="creativity" min="0" max="100" step="5" value="30">
                        <span id="creativity-value" class="range-value">30%</span>
                    </div>
                </div>
            </div>

            <div class="input-group advanced-field">
                <label for="tagline"><i class="fas fa-quote-right"></i> Tagline (Optional)</label>
                <input type="text" id="tagline" placeholder="A catchy one-liner for your movie">
                <p class="helper-text">A memorable phrase that captures the essence of your film</p>
            </div>
        </div>
    </div>

    <!-- Characters Tab -->
    <div id="characters" class="tab-content">
        <div class="card">
            <h2 class="section-title"><i class="fas fa-users"></i> Character Management</h2>
            <p class="helper-text">Define the main characters of your movie. Add details to make them more unique.</p>
            <div id="character-container"></div>
            <button id="add-character" class="btn-secondary"><i class="fas fa-plus"></i> Add Character</button>
        </div>
    </div>

    <!-- Structure Tab -->
    <div id="structure" class="tab-content">
        <div class="card">
            <h2 class="section-title"><i class="fas fa-sitemap"></i> Story Structure</h2>
            <div class="input-group">
                <label for="structure-template" class="tooltip">
                    <i class="fas fa-book"></i> Structure Template
                    <span class="tooltiptext">Choose a story structure to guide your script</span>
                </label>
                <select id="structure-template">
                    <option value="three-act">Three-Act Structure</option>
                    <option value="hero-journey">Hero's Journey</option>
                    <option value="save-the-cat">Save the Cat</option>
                    <option value="none">No Structure (Free Form)</option>
                </select>
            </div>
            <div class="input-group">
                <label for="setting"><i class="fas fa-map-marker-alt"></i> Main Setting</label>
                <input type="text" id="setting" placeholder="Where does your story take place?">
            </div>
            <div class="input-group">
                <label for="time-period"><i class="fas fa-clock"></i> Time Period</label>
                <input type="text" id="time-period" placeholder="When does your story take place?">
            </div>
            <div class="input-group">
                <label for="plot-summary"><i class="fas fa-scroll"></i> Plot Summary (Optional)</label>
                <textarea id="plot-summary" placeholder="Briefly describe the main plot of your movie"></textarea>
            </div>
        </div>
    </div>

    <!-- Advanced Tab -->
    <div id="advanced" class="tab-content">
        <div class="card">
            <h2 class="section-title"><i class="fas fa-cogs"></i> Advanced Options</h2>
            <div class="input-group">
                <label for="tone" class="tooltip">
                    <i class="fas fa-theater-masks"></i> Tone
                    <span class="tooltiptext">The overall feeling of your script</span>
                </label>
                <select id="tone">
                    <option value="neutral">Neutral</option>
                    <option value="serious">Serious</option>
                    <option value="light">Light-hearted</option>
                    <option value="dark">Dark</option>
                    <option value="comedic">Comedic</option>
                    <option value="dramatic">Dramatic</option>
                </select>
            </div>
            <div class="input-group">
                <label for="pacing"><i class="fas fa-tachometer-alt"></i> Pacing</label>
                <select id="pacing">
                    <option value="balanced">Balanced</option>
                    <option value="fast">Fast-paced</option>
                    <option value="slow">Slow and deliberate</option>
                </select>
            </div>
            <div class="input-group">
                <label for="length"><i class="fas fa-text-height"></i> Script Length</label>
                <select id="length">
                    <option value="medium">Standard (90-120 pages)</option>
                    <option value="short">Short (30-60 pages)</option>
                    <option value="long">Long (120+ pages)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Script Output Tab -->
    <div id="script" class="tab-content">
        <div class="card">
            <h2 class="section-title"><i class="fas fa-scroll"></i> Script Generation</h2>
            <button id="generate-btn" class="btn-row"><i class="fas fa-magic"></i> Generate Script</button>

            <div class="loading-container" id="loading-container">
                <div class="loading-animation"><div></div><div></div><div></div></div>
                <p class="loading-text">Creating your masterpiece...</p>
            </div>

            <div id="script-display" style="display: none;">
                <h3 id="script-title" class="section-title" style="margin-top: 20px;"></h3>
                <div class="script-preview" id="script-output"></div>
                <div class="btn-row" style="margin-top: 20px;">
                    <button id="copy-text-btn" class="btn-secondary"><i class="fas fa-copy"></i> Copy Text</button>
                    <button id="copy-markdown-btn" class="btn-secondary"><i class="fas fa-code"></i> Copy Markdown</button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Tab -->
    <div id="history" class="tab-content">
        <div class="card">
            <h2 class="section-title"><i class="fas fa-history"></i> Generation History</h2>
            <div id="history-container">
                <p class="helper-text" id="no-history">No scripts have been generated yet.</p>
            </div>
        </div>
    </div>
</main>

<div class="notification" id="notification">
    <div class="notification-icon"><i class="fas fa-info-circle"></i></div>
    <div class="notification-content">
        <div class="notification-title">Title</div>
        <div class="notification-message">Message</div>
    </div>
    <button class="notification-close"><i class="fas fa-times"></i></button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Core selectors
        const movieTitleInput = document.getElementById('movie-title');
        const genreInput = document.getElementById('genre');
        const customGenreInput = document.getElementById('custom-genre');
        const additionalCriteriaInput = document.getElementById('additional-criteria');
        const taglineInput = document.getElementById('tagline');
        const creativityInput = document.getElementById('creativity');
        const creativityValue = document.getElementById('creativity-value');
        const toneSelect = document.getElementById('tone');
        const pacingSelect = document.getElementById('pacing');
        const lengthSelect = document.getElementById('length');
        const structureTemplateSelect = document.getElementById('structure-template');
        const settingInput = document.getElementById('setting');
        const timePeriodInput = document.getElementById('time-period');
        const plotSummaryInput = document.getElementById('plot-summary');
        const generateBtn = document.getElementById('generate-btn');
        const scriptOutput = document.getElementById('script-output');
        const scriptTitle = document.getElementById('script-title');
        const loadingContainer = document.getElementById('loading-container');
        const scriptDisplay = document.getElementById('script-display');
        const historyContainer = document.getElementById('history-container');
        const noHistoryMsg = document.getElementById('no-history');
        const characterContainer = document.getElementById('character-container');
        const addCharacterBtn = document.getElementById('add-character');
        const copyTextBtn = document.getElementById('copy-text-btn');
        const copyMarkdownBtn = document.getElementById('copy-markdown-btn');
        const saveBtn = document.getElementById('save-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const modeSwitch = document.getElementById('mode-switch');
        const advancedTabs = document.querySelectorAll('.advanced-tab');
        const notification = document.getElementById('notification');
        const notificationTitle = document.querySelector('.notification-title');
        const notificationMessage = document.querySelector('.notification-message');
        const notificationClose = document.querySelector('.notification-close');

        // API endpoint
        const API_ENDPOINT = 'https://chatgpt.tobiasmue91.workers.dev/';

        // Store for script data
        let markdownContent = '';
        let scriptHistory = JSON.parse(localStorage.getItem('scriptHistory')) || [];

        // Mode management
        function toggleMode(isAdvanced) {
            document.documentElement.setAttribute('data-mode', isAdvanced ? 'advanced' : 'basic');

            // Show/hide tabs based on mode
            advancedTabs.forEach(tab => {
                tab.style.display = isAdvanced ? 'block' : 'none';
            });

            // If in basic mode and on an advanced tab, switch to basics tab
            if (!isAdvanced) {
                const activeTab = document.querySelector('.tab.active');
                if (activeTab.classList.contains('advanced-tab')) {
                    document.querySelector('.tab[data-tab="basics"]').click();
                }
            }

            showNotification(
                'Mode Changed',
                isAdvanced ? 'Switched to Advanced Mode' : 'Switched to Basic Mode'
            );
        }

        modeSwitch.addEventListener('change', () => {
            toggleMode(modeSwitch.checked);
            localStorage.setItem('uiMode', modeSwitch.checked ? 'advanced' : 'basic');
        });

        // Theme management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function updateThemeIcon(theme) {
            if (theme === 'dark') {
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }

        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            showNotification('Theme Changed', `Switched to ${newTheme} mode`);
        });

        // Tab navigation
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Character management
        function addCharacter(character = {}) {
            const characterId = Date.now();
            const characterElement = document.createElement('div');
            characterElement.className = 'character-card';
            characterElement.dataset.id = characterId;

            characterElement.innerHTML = `
      <button type="button" class="remove-btn"><i class="fas fa-times"></i></button>
      <div class="input-group">
        <label>Name</label>
        <input type="text" class="character-name" placeholder="Character name" value="${character.name || ''}">
      </div>
      <div class="input-group">
        <label>Role</label>
        <select class="character-role">
          <option value="protagonist" ${character.role === 'protagonist' ? 'selected' : ''}>Protagonist</option>
          <option value="antagonist" ${character.role === 'antagonist' ? 'selected' : ''}>Antagonist</option>
          <option value="supporting" ${character.role === 'supporting' ? 'selected' : ''}>Supporting</option>
        </select>
      </div>
      <div class="input-group">
        <label>Description</label>
        <textarea class="character-description" placeholder="Brief description of the character">${character.description || ''}</textarea>
      </div>
    `;

            characterContainer.appendChild(characterElement);

            characterElement.querySelector('.remove-btn').addEventListener('click', () => {
                characterElement.remove();
            });
        }

        addCharacterBtn.addEventListener('click', () => {
            addCharacter();
        });

        // Form validation
        function validateForm() {
            if (!movieTitleInput.value.trim()) {
                showNotification('Error', 'Please enter a movie title', 'error');
                return false;
            }

            if (genreInput.value === 'Other' && !customGenreInput.value.trim()) {
                showNotification('Error', 'Please enter a custom genre', 'error');
                return false;
            }

            return true;
        }

        // Event listeners
        creativityInput.addEventListener('input', () => {
            creativityValue.textContent = `${creativityInput.value}%`;
        });

        genreInput.addEventListener('change', () => {
            customGenreInput.style.display = genreInput.value === 'Other' ? 'block' : 'none';
        });

        // Script generation
        generateBtn.addEventListener('click', async () => {
            if (!validateForm()) return;

            const movieTitle = movieTitleInput.value.trim();
            const genre = genreInput.value === 'Other' ? customGenreInput.value.trim() : genreInput.value;
            const additionalCriteria = additionalCriteriaInput.value.trim();
            const tagline = taglineInput.value.trim();
            const creativity = creativityInput.value / 100;
            const tone = toneSelect.value;
            const pacing = pacingSelect.value;
            const length = lengthSelect.value;
            const structure = structureTemplateSelect.value;
            const setting = settingInput.value.trim();
            const timePeriod = timePeriodInput.value.trim();
            const plotSummary = plotSummaryInput.value.trim();

            // Get characters
            const characters = [];
            document.querySelectorAll('.character-card').forEach(card => {
                characters.push({
                    name: card.querySelector('.character-name').value.trim(),
                    role: card.querySelector('.character-role').value,
                    description: card.querySelector('.character-description').value.trim()
                });
            });

            generateBtn.disabled = true;
            loadingContainer.style.display = 'block';
            scriptDisplay.style.display = 'none';

            // Switch to script tab
            document.querySelector('.tab[data-tab="script"]').click();

            // Build prompt
            let assistantMessage = `I am the Movie Script Generator AI, I will provide a comprehensive movie script for "${movieTitle}"`;

            if (genre) {
                assistantMessage += ` in the ${genre} genre`;
            }

            if (tagline) {
                assistantMessage += ` with the tagline: "${tagline}"`;
            }

            // Add structure info
            if (structure !== 'none') {
                assistantMessage += `, following a ${structure.replace('-', ' ')} structure`;
            }

            // Add setting and time period
            if (setting) {
                assistantMessage += `, set in ${setting}`;
            }

            if (timePeriod) {
                assistantMessage += ` during ${timePeriod}`;
            }

            // Add tone and pacing
            if (document.documentElement.getAttribute('data-mode') === 'advanced') {
                assistantMessage += `. The tone should be ${tone} and the pacing ${pacing}.`;

                // Add characters
                if (characters.length > 0) {
                    assistantMessage += ` The script should include these characters: `;
                    characters.forEach((character, index) => {
                        if (character.name) {
                            assistantMessage += `${character.name} (${character.role}${character.description ? `, ${character.description}` : ''})`;
                            if (index < characters.length - 1) assistantMessage += ', ';
                        }
                    });
                }

                // Add plot summary
                if (plotSummary) {
                    assistantMessage += ` The plot follows this outline: ${plotSummary}`;
                }
            }

            // Add additional criteria
            if (additionalCriteria) {
                assistantMessage += `. Additional criteria: ${additionalCriteria}`;
            }

            // Add formatting instructions
            assistantMessage += `. Format the script in standard screenplay format with SCENE HEADINGS, ACTION, CHARACTER, DIALOGUE, etc. Use markdown for formatting.`;

            // Add length guidance
            if (length === 'short') {
                assistantMessage += ` Create a shorter script (equivalent to about 30-60 pages).`;
            } else if (length === 'long') {
                assistantMessage += ` Create a longer, more detailed script (equivalent to 120+ pages).`;
            } else {
                assistantMessage += ` Create a standard length script (equivalent to about 90-120 pages).`;
            }

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': '*/*'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo-16k',
                        max_tokens: 15800,
                        temperature: creativity * 2,
                        messages: [
                            {
                                role: 'assistant',
                                content: assistantMessage
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error: ${response.status}`);
                }

                const data = await response.json();
                markdownContent = data.choices[0].message.content;

                // Save to history
                const historyItem = {
                    id: Date.now(),
                    title: movieTitle,
                    genre: genre || 'None',
                    date: new Date().toISOString(),
                    markdown: markdownContent
                };

                scriptHistory.unshift(historyItem);
                if (scriptHistory.length > 10) scriptHistory.pop();
                localStorage.setItem('scriptHistory', JSON.stringify(scriptHistory));

                // Update history display
                updateHistoryDisplay();

                // Display script
                scriptTitle.textContent = movieTitle;
                scriptOutput.innerHTML = marked.parse(markdownContent);
                scriptDisplay.style.display = 'block';

                showNotification('Success', 'Script generated successfully!', 'success');
            } catch (error) {
                showNotification('Error', `Failed to generate script: ${error.message}`, 'error');
                scriptOutput.innerHTML = `<p>An error occurred: ${error.message}</p><p>Please try again.</p>`;
                scriptDisplay.style.display = 'block';
            } finally {
                generateBtn.disabled = false;
                loadingContainer.style.display = 'none';
            }
        });

        // History management
        function updateHistoryDisplay() {
            if (scriptHistory.length === 0) {
                noHistoryMsg.style.display = 'block';
                return;
            }

            noHistoryMsg.style.display = 'none';
            historyContainer.innerHTML = '';

            scriptHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.dataset.id = item.id;

                const date = new Date(item.date);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                historyItem.innerHTML = `
        <div class="history-item-title">${item.title}</div>
        <div class="history-item-info">${item.genre} â€¢ ${formattedDate}</div>
      `;

                historyItem.addEventListener('click', () => {
                    loadScriptFromHistory(item);
                });

                historyContainer.appendChild(historyItem);
            });
        }

        function loadScriptFromHistory(item) {
            markdownContent = item.markdown;
            scriptTitle.textContent = item.title;
            scriptOutput.innerHTML = marked.parse(markdownContent);
            scriptDisplay.style.display = 'block';

            // Switch to script tab
            document.querySelector('.tab[data-tab="script"]').click();

            showNotification('Script Loaded', `Loaded "${item.title}" from history`);
        }

        // Save current settings
        saveBtn.addEventListener('click', () => {
            const settings = {
                movieTitle: movieTitleInput.value.trim(),
                genre: genreInput.value,
                customGenre: customGenreInput.value.trim(),
                additionalCriteria: additionalCriteriaInput.value.trim(),
                tagline: taglineInput.value.trim(),
                creativity: creativityInput.value,
                tone: toneSelect.value,
                pacing: pacingSelect.value,
                length: lengthSelect.value,
                structure: structureTemplateSelect.value,
                setting: settingInput.value.trim(),
                timePeriod: timePeriodInput.value.trim(),
                plotSummary: plotSummaryInput.value.trim(),
                characters: []
            };

            document.querySelectorAll('.character-card').forEach(card => {
                settings.characters.push({
                    name: card.querySelector('.character-name').value.trim(),
                    role: card.querySelector('.character-role').value,
                    description: card.querySelector('.character-description').value.trim()
                });
            });

            localStorage.setItem('saved_settings', JSON.stringify(settings));
            showNotification('Settings Saved', 'Your project settings have been saved');
        });

        // Load saved settings if available
        function loadSavedSettings() {
            const savedSettings = JSON.parse(localStorage.getItem('saved_settings'));
            if (!savedSettings) return;

            movieTitleInput.value = savedSettings.movieTitle || '';
            genreInput.value = savedSettings.genre || '';
            customGenreInput.value = savedSettings.customGenre || '';
            additionalCriteriaInput.value = savedSettings.additionalCriteria || '';
            taglineInput.value = savedSettings.tagline || '';
            creativityInput.value = savedSettings.creativity || 30;
            creativityValue.textContent = `${creativityInput.value}%`;
            toneSelect.value = savedSettings.tone || 'neutral';
            pacingSelect.value = savedSettings.pacing || 'balanced';
            lengthSelect.value = savedSettings.length || 'medium';
            structureTemplateSelect.value = savedSettings.structure || 'three-act';
            settingInput.value = savedSettings.setting || '';
            timePeriodInput.value = savedSettings.timePeriod || '';
            plotSummaryInput.value = savedSettings.plotSummary || '';

            customGenreInput.style.display = genreInput.value === 'Other' ? 'block' : 'none';

            // Load characters
            characterContainer.innerHTML = '';
            if (savedSettings.characters && savedSettings.characters.length > 0) {
                savedSettings.characters.forEach(character => {
                    addCharacter(character);
                });
            } else {
                // Add default character
                addCharacter({ name: '', role: 'protagonist', description: '' });
            }
        }

        // Copy functionality
        copyTextBtn.addEventListener('click', () => {
            const tempElement = document.createElement('div');
            tempElement.innerHTML = scriptOutput.innerHTML;
            navigator.clipboard.writeText(tempElement.textContent)
                .then(() => showNotification('Copied', 'Text copied to clipboard'))
                .catch(err => showNotification('Error', 'Failed to copy text: ' + err.message, 'error'));
        });

        copyMarkdownBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(markdownContent)
                .then(() => showNotification('Copied', 'Markdown copied to clipboard'))
                .catch(err => showNotification('Error', 'Failed to copy markdown: ' + err.message, 'error'));
        });

        // Notification system
        function showNotification(title, message, type = 'info') {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;

            // Set icon based on type
            const iconElement = notification.querySelector('.notification-icon i');
            iconElement.className = '';

            switch (type) {
                case 'success':
                    iconElement.className = 'fas fa-check-circle';
                    notification.style.borderLeftColor = '#28a745';
                    break;
                case 'error':
                    iconElement.className = 'fas fa-exclamation-circle';
                    notification.style.borderLeftColor = '#dc3545';
                    break;
                default:
                    iconElement.className = 'fas fa-info-circle';
                    notification.style.borderLeftColor = '#17a2b8';
            }

            notification.classList.add('show');

            // Auto-hide after 4 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        notificationClose.addEventListener('click', () => {
            notification.classList.remove('show');
        });

        // Initialize
        function init() {
            updateHistoryDisplay();
            initTheme();
            loadSavedSettings();

            // Initialize mode
            const savedMode = localStorage.getItem('uiMode') || 'basic';
            modeSwitch.checked = savedMode === 'advanced';
            toggleMode(savedMode === 'advanced');

            // Add a default character if none exists
            if (document.querySelectorAll('.character-card').length === 0) {
                addCharacter({ name: '', role: 'protagonist', description: '' });
            }
        }

        init();
    });
</script>
<script src="../logo.js"></script>
</body>
</html>