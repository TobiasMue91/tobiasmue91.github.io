<!DOCTYPE html>
<html>
<head>
    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîµ</text></svg>">
    <meta charset="UTF-8">
    <title>Catch the Circle</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #0a0a12;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #fff;
            overflow: hidden;
            padding: 12px
        }

        .container {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 24px);
            max-height: 750px
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #151525;
            border-radius: 12px 12px 0 0;
            flex-wrap: wrap;
            gap: 8px
        }

        .logo {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .logo-icon {
            width: 28px;
            height: 28px;
            background: #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px
        }

        .stats-bar {
            display: flex;
            gap: 16px;
            align-items: center
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: flex-end
        }

        .stat-label {
            font-size: 0.65rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1px
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            transition: transform 0.1s
        }

        .stat-value.bump {
            transform: scale(1.2)
        }

        .stat-value.score {
            color: #4ade80
        }

        .stat-value.combo {
            color: #f59e0b
        }

        .timer-bar {
            width: 100px;
            height: 6px;
            background: #252538;
            border-radius: 3px;
            overflow: hidden
        }

        .timer-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.05s linear
        }

        .timer-fill.warning {
            background: #f59e0b
        }

        .timer-fill.danger {
            background: #ef4444
        }

        #game-board {
            flex: 1;
            background: #12121f;
            position: relative;
            overflow: hidden;
            cursor: crosshair;
            transition: background 0.5s
        }

        #game-board.fever {
            background: #1a1525;
            box-shadow: inset 0 0 80px rgba(251, 146, 60, 0.15)
        }

        #game-board.shake {
            animation: shake 0.3s ease
        }

        @keyframes shake {
            0%, 100% {
                transform: translateX(0)
            }
            20%, 60% {
                transform: translateX(-4px)
            }
            40%, 80% {
                transform: translateX(4px)
            }
        }

        .screen-flash {
            position: absolute;
            inset: 0;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s
        }

        .screen-flash.gold {
            background: radial-gradient(circle, rgba(251, 191, 36, 0.3), transparent 70%);
            opacity: 1
        }

        .screen-flash.fever {
            background: rgba(251, 146, 60, 0.2);
            opacity: 1
        }

        .screen-flash.perfect {
            background: radial-gradient(circle, rgba(168, 85, 247, 0.25), transparent 60%);
            opacity: 1
        }

        footer {
            padding: 10px 16px;
            background: #151525;
            border-radius: 0 0 12px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px
        }

        .high-score {
            font-size: 0.8rem;
            color: #64748b
        }

        .high-score span {
            color: #fbbf24;
            font-weight: 600
        }

        .multiplier {
            font-size: 0.8rem;
            padding: 4px 10px;
            background: #252538;
            border-radius: 16px;
            color: #94a3b8;
            transition: all 0.2s
        }

        .multiplier.active {
            background: #f59e0b;
            color: #000;
            font-weight: 600
        }

        .powerup-bar {
            display: flex;
            gap: 6px;
            align-items: center
        }

        .powerup-slot {
            width: 28px;
            height: 28px;
            background: #252538;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            opacity: 0.4;
            transition: all 0.2s
        }

        .powerup-slot.active {
            opacity: 1;
            transform: scale(1.1)
        }

        .powerup-slot.timeslow.active {
            background: #06b6d4;
            box-shadow: 0 0 12px rgba(6, 182, 212, 0.5)
        }

        .powerup-slot.magnet.active {
            background: #a855f7;
            box-shadow: 0 0 12px rgba(168, 85, 247, 0.5)
        }

        .powerup-slot.frenzy.active {
            background: #ef4444;
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.5)
        }

        .combo-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10
        }

        .combo-display.visible {
            opacity: 1
        }

        .combo-display .combo-count {
            font-size: 4rem;
            font-weight: 800;
            color: #f59e0b;
            text-shadow: 0 0 40px rgba(251, 146, 60, 0.5);
            line-height: 1
        }

        .combo-display .combo-label {
            font-size: 0.9rem;
            color: #f59e0b;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.8
        }

        .combo-display.fever .combo-count {
            animation: comboPulse 0.5s ease-in-out infinite
        }

        @keyframes comboPulse {
            0%, 100% {
                transform: scale(1)
            }
            50% {
                transform: scale(1.05)
            }
        }

        .fever-banner {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: #f97316;
            color: #fff;
            padding: 6px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 15
        }

        .fever-banner.visible {
            opacity: 1
        }

        .circle {
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.08s, box-shadow 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            user-select: none
        }

        .circle:hover {
            transform: scale(1.15) !important;
            z-index: 5
        }

        .circle.normal {
            background: #3b82f6;
            box-shadow: 0 0 0 rgba(59, 130, 246, 0)
        }

        .circle.normal:hover {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5)
        }

        .circle.small {
            background: #8b5cf6;
            box-shadow: 0 0 0 rgba(139, 92, 246, 0)
        }

        .circle.small:hover {
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5)
        }

        .circle.golden {
            background: #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
            animation: pulse 0.5s ease-in-out infinite
        }

        .circle.moving {
            transition: transform 0.08s, box-shadow 0.15s, left 0.1s linear, top 0.1s linear
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(251, 191, 36, 0.4)
            }
            50% {
                box-shadow: 0 0 35px rgba(251, 191, 36, 0.6)
            }
        }

        .circle.caught {
            transform: scale(0) !important;
            opacity: 0;
            transition: all 0.12s ease-in
        }

        .circle .lifespan {
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 3px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 2px;
            overflow: hidden
        }

        .circle .lifespan-fill {
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            transition: width 0.05s linear
        }

        .circle .lifespan-fill.danger {
            background: #ef4444
        }

        .powerup {
            position: absolute;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            animation: powerupFloat 1.5s ease-in-out infinite, powerupGlow 1s ease-in-out infinite alternate;
            user-select: none;
            z-index: 8
        }

        .powerup.timeslow {
            background: #06b6d4;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.5)
        }

        .powerup.magnet {
            background: #a855f7;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.5)
        }

        .powerup.frenzy {
            background: #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5)
        }

        @keyframes powerupFloat {
            0%, 100% {
                transform: translateY(0)
            }
            50% {
                transform: translateY(-6px)
            }
        }

        @keyframes powerupGlow {
            from {
                filter: brightness(1)
            }
            to {
                filter: brightness(1.2)
            }
        }

        .powerup.collected {
            transform: scale(0) !important;
            opacity: 0;
            transition: all 0.15s
        }

        .obstacle {
            position: absolute;
            background: #dc2626;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none
        }

        .obstacle:hover {
            transform: scale(1.05)
        }

        .obstacle::before {
            content: "";
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(45deg, transparent, transparent 4px, rgba(0, 0, 0, 0.1) 4px, rgba(0, 0, 0, 0.1) 8px);
            border-radius: 8px
        }

        .obstacle::after {
            content: "‚úï";
            color: rgba(255, 255, 255, 0.5);
            font-size: 1.2rem;
            font-weight: bold;
            position: relative;
            z-index: 1
        }

        .obstacle.hit {
            transform: scale(0.7);
            opacity: 0;
            transition: all 0.2s ease-out
        }

        .popup {
            position: absolute;
            font-weight: 700;
            pointer-events: none;
            animation: popUp 0.6s ease-out forwards;
            z-index: 20;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4)
        }

        .popup.positive {
            color: #4ade80
        }

        .popup.negative {
            color: #ef4444
        }

        .popup.bonus {
            color: #fbbf24
        }

        .popup.perfect {
            color: #a855f7
        }

        .popup.powerup-text {
            color: #fff;
            font-size: 0.9rem
        }

        @keyframes popUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1)
            }
            100% {
                opacity: 0;
                transform: translateY(-45px) scale(0.7)
            }
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            animation: particleFly 0.4s ease-out forwards
        }

        @keyframes particleFly {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1)
            }
            100% {
                opacity: 0;
                transform: translate(var(--tx), var(--ty)) scale(0)
            }
        }

        .ring {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            border: 3px solid;
            animation: ringExpand 0.4s ease-out forwards
        }

        @keyframes ringExpand {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(0.5)
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(2)
            }
        }

        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(10, 10, 18, 0.97);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 1;
            transition: opacity 0.3s
        }

        .overlay.hidden {
            opacity: 0;
            pointer-events: none
        }

        .overlay-content {
            text-align: center;
            transform: translateY(0);
            transition: transform 0.3s;
            padding: 20px
        }

        .overlay.hidden .overlay-content {
            transform: translateY(20px)
        }

        .overlay h2 {
            font-size: 2.2rem;
            margin-bottom: 6px;
            font-weight: 700
        }

        .overlay .subtitle {
            color: #64748b;
            margin-bottom: 28px;
            font-size: 0.95rem
        }

        .final-score-container {
            margin-bottom: 28px
        }

        .final-score {
            font-size: 4.5rem;
            font-weight: 800;
            color: #4ade80;
            line-height: 1
        }

        .final-label {
            color: #64748b;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px
        }

        .new-high {
            color: #fbbf24;
            font-size: 0.85rem;
            margin-top: 8px;
            animation: glow 1s ease-in-out infinite alternate
        }

        @keyframes glow {
            from {
                opacity: 0.7
            }
            to {
                opacity: 1
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns:repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 28px;
            width: 100%;
            max-width: 300px
        }

        .stats-grid .stat-box {
            background: #1a1a2e;
            padding: 14px 10px;
            border-radius: 8px
        }

        .stats-grid .stat-box-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff
        }

        .stats-grid .stat-box-label {
            font-size: 0.65rem;
            color: #64748b;
            text-transform: uppercase;
            margin-top: 2px
        }

        .instructions {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            justify-content: center
        }

        .instruction {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: #94a3b8;
            background: #1a1a2e;
            padding: 6px 12px;
            border-radius: 6px
        }

        .instruction-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700
        }

        .instruction-icon.blue {
            background: #3b82f6
        }

        .instruction-icon.purple {
            background: #8b5cf6;
            width: 16px;
            height: 16px
        }

        .instruction-icon.gold {
            background: #fbbf24
        }

        .instruction-icon.red {
            background: #dc2626;
            border-radius: 4px
        }

        .powerups-info {
            display: flex;
            gap: 10px;
            margin-bottom: 28px;
            flex-wrap: wrap;
            justify-content: center
        }

        .powerup-info {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: #94a3b8
        }

        .powerup-info-icon {
            width: 22px;
            height: 22px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px
        }

        .powerup-info-icon.cyan {
            background: #06b6d4
        }

        .powerup-info-icon.violet {
            background: #a855f7
        }

        .powerup-info-icon.red {
            background: #ef4444
        }

        .btn {
            background: #3b82f6;
            color: #fff;
            border: none;
            padding: 14px 44px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3)
        }

        .btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4)
        }

        .btn:active {
            transform: translateY(0)
        }

        .timeslow-active .circle, .timeslow-active .obstacle {
            transition-duration: 0.3s !important
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="logo">
            <div class="logo-icon">‚óè</div>
            Catch the Circle
        </div>
        <div class="stats-bar">
            <div class="stat"><span class="stat-label">Combo</span><span class="stat-value combo" id="combo">0</span>
            </div>
            <div class="stat"><span class="stat-label">Score</span><span class="stat-value score" id="score">0</span>
            </div>
            <div class="stat"><span class="stat-label">Time</span>
                <div class="timer-bar">
                    <div class="timer-fill" id="timer-fill"></div>
                </div>
            </div>
        </div>
    </header>
    <div id="game-board">
        <div class="screen-flash" id="screen-flash"></div>
        <div class="combo-display" id="combo-display">
            <div class="combo-count" id="combo-count">0</div>
            <div class="combo-label">Combo</div>
        </div>
        <div class="fever-banner" id="fever-banner">üî• FEVER MODE üî•</div>
        <div class="overlay" id="start-screen">
            <div class="overlay-content">
                <h2>Catch the Circle</h2>
                <p class="subtitle">Click circles, build combos, grab power-ups!</p>
                <div class="instructions">
                    <div class="instruction">
                        <div class="instruction-icon blue">+1</div>
                        Normal
                    </div>
                    <div class="instruction">
                        <div class="instruction-icon purple">+3</div>
                        Small
                    </div>
                    <div class="instruction">
                        <div class="instruction-icon gold">+5</div>
                        Golden
                    </div>
                    <div class="instruction">
                        <div class="instruction-icon red">‚úï</div>
                        ‚àí3
                    </div>
                </div>
                <div class="powerups-info">
                    <div class="powerup-info">
                        <div class="powerup-info-icon cyan">‚ùÑ</div>
                        Slow Time
                    </div>
                    <div class="powerup-info">
                        <div class="powerup-info-icon violet">‚óé</div>
                        Magnet
                    </div>
                    <div class="powerup-info">
                        <div class="powerup-info-icon red">‚ö°</div>
                        Frenzy
                    </div>
                </div>
                <button class="btn" id="start-btn">Start Game</button>
            </div>
        </div>
        <div class="overlay hidden" id="end-screen">
            <div class="overlay-content">
                <h2>Game Over</h2>
                <div class="final-score-container">
                    <div class="final-score" id="final-score">0</div>
                    <div class="final-label">points</div>
                    <div class="new-high hidden" id="new-high">‚òÖ New High Score! ‚òÖ</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-box-value" id="stat-caught">0</div>
                        <div class="stat-box-label">Caught</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="stat-missed">0</div>
                        <div class="stat-box-label">Missed</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="stat-max-combo">0</div>
                        <div class="stat-box-label">Max Combo</div>
                    </div>
                </div>
                <button class="btn" id="restart-btn">Play Again</button>
            </div>
        </div>
    </div>
    <footer>
        <div class="high-score">Best: <span id="high-score">0</span></div>
        <div class="powerup-bar">
            <div class="powerup-slot timeslow" id="slot-timeslow">‚ùÑ</div>
            <div class="powerup-slot magnet" id="slot-magnet">‚óé</div>
            <div class="powerup-slot frenzy" id="slot-frenzy">‚ö°</div>
        </div>
        <div class="multiplier" id="multiplier">√ó1</div>
    </footer>
</div>
<script>
    const $ = id => document.getElementById(id), gameBoard = $('game-board'), scoreEl = $('score'),
        comboEl = $('combo'), timerFill = $('timer-fill'), multiplierEl = $('multiplier'),
        highScoreEl = $('high-score'), startScreen = $('start-screen'), endScreen = $('end-screen'),
        finalScoreEl = $('final-score'), newHighEl = $('new-high'), statCaughtEl = $('stat-caught'),
        statMissedEl = $('stat-missed'), statMaxComboEl = $('stat-max-combo'), comboDisplay = $('combo-display'),
        comboCount = $('combo-count'), feverBanner = $('fever-banner'), screenFlash = $('screen-flash'),
        slotTimeslow = $('slot-timeslow'), slotMagnet = $('slot-magnet'), slotFrenzy = $('slot-frenzy'),
        startBtn = $('start-btn'), restartBtn = $('restart-btn');

    const GAME_DURATION = 50, FEVER_THRESHOLD = 15;
    const CIRCLE_TYPES = {
        normal: {size: 48, points: 1, color: '#3b82f6', lifespan: 3200, class: 'normal'},
        small: {size: 30, points: 3, color: '#8b5cf6', lifespan: 2400, class: 'small'},
        golden: {size: 42, points: 5, color: '#fbbf24', lifespan: 1600, class: 'golden'}
    };
    const POWERUP_TYPES = {
        timeslow: {icon: '‚ùÑ', class: 'timeslow', duration: 4000, slot: slotTimeslow},
        magnet: {icon: '‚óé', class: 'magnet', duration: 5000, slot: slotMagnet},
        frenzy: {icon: '‚ö°', class: 'frenzy', duration: 4000, slot: slotFrenzy}
    };

    let state, mouseX = 0, mouseY = 0;

    function initState() {
        return {
            score: 0,
            combo: 0,
            maxCombo: 0,
            caught: 0,
            missed: 0,
            perfects: 0,
            timeLeft: GAME_DURATION,
            highScore: parseInt(localStorage.getItem('catchCircleHS2')) || 0,
            running: false,
            fever: false,
            entities: [],
            powerups: {timeslow: false, magnet: false, frenzy: false},
            powerupTimers: {},
            gameLoop: null,
            spawnLoop: null,
            lastSpawn: 0
        }
    }

    state = initState();
    highScoreEl.textContent = state.highScore;

    gameBoard.addEventListener('mousemove', e => {
        const r = gameBoard.getBoundingClientRect();
        mouseX = e.clientX - r.left;
        mouseY = e.clientY - r.top
    });

    function getMultiplier() {
        const c = state.combo;
        return c >= 25 ? 5 : c >= 15 ? 4 : c >= 8 ? 3 : c >= 4 ? 2 : 1
    }

    function isFever() {
        return state.combo >= FEVER_THRESHOLD
    }

    function updateUI() {
        scoreEl.textContent = state.score;
        comboEl.textContent = state.combo;
        comboCount.textContent = state.combo;
        const pct = (state.timeLeft / GAME_DURATION) * 100;
        timerFill.style.width = pct + '%';
        timerFill.classList.toggle('warning', pct <= 40 && pct > 20);
        timerFill.classList.toggle('danger', pct <= 20);
        const mult = getMultiplier();
        multiplierEl.textContent = '√ó' + mult;
        multiplierEl.classList.toggle('active', mult > 1);
        const fever = isFever();
        if (fever !== state.fever) {
            state.fever = fever;
            gameBoard.classList.toggle('fever', fever);
            feverBanner.classList.toggle('visible', fever);
            comboDisplay.classList.toggle('fever', fever);
            if (fever) flashScreen('fever')
        }
        comboDisplay.classList.toggle('visible', state.combo >= 8);
        slotTimeslow.classList.toggle('active', state.powerups.timeslow);
        slotMagnet.classList.toggle('active', state.powerups.magnet);
        slotFrenzy.classList.toggle('active', state.powerups.frenzy);
        gameBoard.classList.toggle('timeslow-active', state.powerups.timeslow);
    }

    function bumpStat(el) {
        el.classList.add('bump');
        setTimeout(() => el.classList.remove('bump'), 100)
    }

    function flashScreen(type) {
        screenFlash.className = 'screen-flash ' + type;
        setTimeout(() => screenFlash.className = 'screen-flash', 150)
    }

    function createPopup(x, y, text, type = 'positive') {
        const p = document.createElement('div');
        p.className = 'popup ' + type;
        p.textContent = text;
        p.style.cssText = `left:${x}px;top:${y}px;font-size:${type === 'bonus' || type === 'perfect' ? '1.2rem' : '1rem'}`;
        gameBoard.appendChild(p);
        setTimeout(() => p.remove(), 600);
    }

    function createParticles(x, y, color, count = 10) {
        for (let i = 0; i < count; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            const size = 4 + Math.random() * 6;
            p.style.cssText = `left:${x}px;top:${y}px;width:${size}px;height:${size}px;background:${color}`;
            const angle = Math.random() * Math.PI * 2, dist = 25 + Math.random() * 35;
            p.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
            p.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
            gameBoard.appendChild(p);
            setTimeout(() => p.remove(), 400);
        }
    }

    function createRing(x, y, color) {
        const r = document.createElement('div');
        r.className = 'ring';
        r.style.cssText = `left:${x}px;top:${y}px;width:50px;height:50px;border-color:${color}`;
        gameBoard.appendChild(r);
        setTimeout(() => r.remove(), 400);
    }

    function getBoardRect() {
        return gameBoard.getBoundingClientRect()
    }

    function getSpawnDelay() {
        const base = state.powerups.frenzy ? 350 : 750;
        const progress = 1 - state.timeLeft / GAME_DURATION;
        return Math.max(state.powerups.frenzy ? 200 : 350, base - progress * 300)
    }

    function getRandomPos(size) {
        const r = getBoardRect();
        return {x: 10 + Math.random() * (r.width - size - 20), y: 10 + Math.random() * (r.height - size - 20)};
    }

    function spawnCircle() {
        const r = getBoardRect();
        if (r.width < 60 || r.height < 60) return;
        const rand = Math.random();
        let type = rand < 0.06 ? CIRCLE_TYPES.golden : rand < 0.22 ? CIRCLE_TYPES.small : CIRCLE_TYPES.normal;
        const pos = getRandomPos(type.size);
        const el = document.createElement('div');
        el.className = 'circle ' + type.class;
        const isMoving = Math.random() < 0.3;
        if (isMoving) el.classList.add('moving');
        el.style.cssText = `width:${type.size}px;height:${type.size}px;left:${pos.x}px;top:${pos.y}px`;
        if (type.points > 1) el.textContent = '+' + type.points;
        const lifebar = document.createElement('div');
        lifebar.className = 'lifespan';
        lifebar.innerHTML = '<div class="lifespan-fill"></div>';
        el.appendChild(lifebar);
        const lifespan = state.powerups.timeslow ? type.lifespan * 1.8 : type.lifespan;
        const entity = {
            el,
            type,
            caught: false,
            startTime: performance.now(),
            lifespan,
            isMoving,
            vx: (Math.random() - 0.5) * 60,
            vy: (Math.random() - 0.5) * 60,
            x: pos.x,
            y: pos.y
        };
        el.addEventListener('click', () => {
            if (entity.caught || !state.running) return;
            entity.caught = true;
            const elapsed = performance.now() - entity.startTime;
            const remaining = 1 - elapsed / entity.lifespan;
            const isPerfect = remaining <= 0.25 && remaining > 0;
            const mult = getMultiplier();
            let pts = type.points * mult;
            if (state.fever) pts += 1;
            if (isPerfect) pts += 1;
            if (state.powerups.frenzy) pts = Math.floor(pts * 1.5);
            state.score += pts;
            state.combo++;
            state.caught++;
            if (state.combo > state.maxCombo) state.maxCombo = state.combo;
            if (isPerfect) state.perfects++;
            el.classList.add('caught');
            const cx = entity.x + type.size / 2, cy = entity.y + type.size / 2;
            createParticles(cx, cy, type.color, isPerfect ? 16 : 10);
            if (isPerfect || type.class === 'golden') createRing(cx, cy, isPerfect ? '#a855f7' : type.color);
            if (type.class === 'golden') flashScreen('gold');
            if (isPerfect) flashScreen('perfect');
            createPopup(cx, cy - 10, '+' + pts, isPerfect ? 'perfect' : mult > 1 ? 'bonus' : 'positive');
            if (isPerfect) createPopup(cx, cy + 12, 'PERFECT!', 'perfect');
            bumpStat(scoreEl);
            bumpStat(comboEl);
            updateUI();
            setTimeout(() => removeEntity(entity), 120);
        });
        gameBoard.appendChild(el);
        state.entities.push(entity);
    }

    function spawnObstacle() {
        const r = getBoardRect();
        if (r.width < 60 || r.height < 60) return;
        const w = 45 + Math.random() * 25, h = w * 0.55;
        const pos = getRandomPos(w);
        const el = document.createElement('div');
        el.className = 'obstacle';
        el.style.cssText = `width:${w}px;height:${h}px;left:${pos.x}px;top:${pos.y}px`;
        const entity = {
            el,
            isObstacle: true,
            caught: false,
            startTime: performance.now(),
            lifespan: 4500,
            x: pos.x,
            y: pos.y
        };
        el.addEventListener('click', () => {
            if (entity.caught || !state.running) return;
            entity.caught = true;
            state.score = Math.max(0, state.score - 3);
            state.combo = 0;
            el.classList.add('hit');
            gameBoard.classList.add('shake');
            setTimeout(() => gameBoard.classList.remove('shake'), 300);
            createPopup(entity.x + w / 2, entity.y + h / 2, '-3', 'negative');
            bumpStat(scoreEl);
            updateUI();
            setTimeout(() => removeEntity(entity), 200);
        });
        gameBoard.appendChild(el);
        state.entities.push(entity);
    }

    function spawnPowerup() {
        const r = getBoardRect();
        if (r.width < 60 || r.height < 60) return;
        const types = Object.keys(POWERUP_TYPES);
        const typeKey = types[Math.floor(Math.random() * types.length)];
        const type = POWERUP_TYPES[typeKey];
        const pos = getRandomPos(36);
        const el = document.createElement('div');
        el.className = 'powerup ' + type.class;
        el.textContent = type.icon;
        el.style.cssText = `left:${pos.x}px;top:${pos.y}px`;
        const entity = {
            el,
            isPowerup: true,
            powerupType: typeKey,
            caught: false,
            startTime: performance.now(),
            lifespan: 6000,
            x: pos.x,
            y: pos.y
        };
        el.addEventListener('click', () => {
            if (entity.caught || !state.running) return;
            entity.caught = true;
            el.classList.add('collected');
            activatePowerup(typeKey);
            createPopup(entity.x + 18, entity.y, type.icon, 'powerup-text');
            setTimeout(() => removeEntity(entity), 150);
        });
        gameBoard.appendChild(el);
        state.entities.push(entity);
    }

    function activatePowerup(type) {
        const p = POWERUP_TYPES[type];
        state.powerups[type] = true;
        clearTimeout(state.powerupTimers[type]);
        state.powerupTimers[type] = setTimeout(() => {
            state.powerups[type] = false;
            updateUI()
        }, p.duration);
        updateUI();
    }

    function removeEntity(entity) {
        entity.el.remove();
        state.entities = state.entities.filter(e => e !== entity);
    }

    function updateEntities(dt) {
        const now = performance.now();
        const r = getBoardRect();
        state.entities.forEach(entity => {
            if (entity.caught) return;
            const elapsed = now - entity.startTime;
            const remaining = 1 - elapsed / entity.lifespan;
            if (remaining <= 0) {
                if (!entity.isObstacle && !entity.isPowerup && !entity.caught) {
                    state.missed++;
                    state.combo = 0;
                    updateUI()
                }
                entity.el.style.opacity = '0';
                entity.el.style.transform = 'scale(0.5)';
                setTimeout(() => removeEntity(entity), 120);
                return;
            }
            if (entity.type) {
                const fill = entity.el.querySelector('.lifespan-fill');
                if (fill) {
                    fill.style.width = (remaining * 100) + '%';
                    fill.classList.toggle('danger', remaining < 0.25)
                }
                if (entity.isMoving) {
                    const speed = state.powerups.timeslow ? 0.3 : 1;
                    entity.x += entity.vx * dt * speed;
                    entity.y += entity.vy * dt * speed;
                    if (entity.x < 0 || entity.x > r.width - entity.type.size) entity.vx *= -1;
                    if (entity.y < 0 || entity.y > r.height - entity.type.size) entity.vy *= -1;
                    entity.x = Math.max(0, Math.min(r.width - entity.type.size, entity.x));
                    entity.y = Math.max(0, Math.min(r.height - entity.type.size, entity.y));
                }
                if (state.powerups.magnet && !entity.isObstacle) {
                    const cx = entity.x + entity.type.size / 2, cy = entity.y + entity.type.size / 2;
                    const dx = mouseX - cx, dy = mouseY - cy;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 180 && dist > 5) {
                        const pull = 0.15 * (1 - dist / 180);
                        entity.x += dx * pull;
                        entity.y += dy * pull;
                    }
                }
                entity.el.style.left = entity.x + 'px';
                entity.el.style.top = entity.y + 'px';
            }
        });
    }

    let lastTime = 0;

    function tick(now) {
        if (!state.running) return;
        const dt = (now - lastTime) / 1000;
        lastTime = now;
        const timeDecrement = state.powerups.timeslow ? dt * 0.5 : dt;
        state.timeLeft -= timeDecrement;
        if (state.timeLeft <= 0) {
            state.timeLeft = 0;
            updateUI();
            endGame();
            return
        }
        updateUI();
        updateEntities(dt);
        state.gameLoop = requestAnimationFrame(tick);
    }

    function doSpawn() {
        if (!state.running) return;
        spawnCircle();
        if (Math.random() < 0.3) spawnObstacle();
        if (Math.random() < 0.08) spawnPowerup();
        state.spawnLoop = setTimeout(doSpawn, getSpawnDelay());
    }

    function clearBoard() {
        state.entities.forEach(e => e.el.remove());
        state.entities = []
    }

    function startGame() {
        startScreen.classList.add('hidden');
        endScreen.classList.add('hidden');
        state = initState();
        state.running = true;
        state.highScore = parseInt(localStorage.getItem('catchCircleHS2')) || 0;
        clearBoard();
        updateUI();
        lastTime = performance.now();
        state.gameLoop = requestAnimationFrame(tick);
        doSpawn();
    }

    function endGame() {
        state.running = false;
        cancelAnimationFrame(state.gameLoop);
        clearTimeout(state.spawnLoop);
        Object.values(state.powerupTimers).forEach(clearTimeout);
        finalScoreEl.textContent = state.score;
        statCaughtEl.textContent = state.caught;
        statMissedEl.textContent = state.missed;
        statMaxComboEl.textContent = state.maxCombo;
        if (state.score > state.highScore) {
            localStorage.setItem('catchCircleHS2', state.score);
            highScoreEl.textContent = state.score;
            newHighEl.classList.remove('hidden');
        } else {
            newHighEl.classList.add('hidden')
        }
        setTimeout(() => endScreen.classList.remove('hidden'), 300);
    }

    startBtn.addEventListener('click', startGame);
    restartBtn.addEventListener('click', startGame);
</script>
<script src="../logo.js"></script>
</body>
</html>