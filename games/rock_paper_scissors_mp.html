<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <title>Rock Paper Scissors Multiplayer</title>
</head>
<body class="bg-gray-100 h-screen flex items-center justify-center">
<div class="game-container bg-white rounded-lg shadow-lg p-8 mx-4 text-center max-w-md w-full" style="min-height: 400px;">
    <h1 class="text-4xl font-bold mb-8">Rock Paper Scissors</h1>
    <div class="choices mb-8 flex justify-center transition-opacity duration-500 text-xxl">
        <span title="Rock" class="choice mx-4 cursor-pointer transition-transform duration-200 hover:scale-110" data-choice="rock">ü™®</span>
        <span title="Paper" class="choice mx-4 cursor-pointer transition-transform duration-200 hover:scale-110" data-choice="paper">üìÉ</span>
        <span title="Scissors" class="choice mx-4 cursor-pointer transition-transform duration-200 hover:scale-110" data-choice="scissors">‚úÇÔ∏è</span>
    </div>
    <div id="game-info" class="mb-4 transition-opacity duration-500">Creating game...</div>
    <input type="text" id="share-url" class="hidden text-center px-4 py-2 mt-2 mb-4 border rounded-md w-4/5 mx-auto" readonly>
    <div id="your-choice" class="text-xl mb-4 transition-opacity duration-500 opacity-0">Your choice: <span></span></div>
    <div id="result" class="text-2xl mb-8 transition-opacity duration-500 opacity-0"></div>
    <div id="scores">
        <p class="text-lg"><span id="player-label">Your</span> Score: <span id="player-score">0</span></p>
        <p class="text-lg"><span id="opponent-label">Opponent's</span> Score: <span id="opponent-score">0</span></p>
    </div>
</div>

<div id="result-modal" class="modal fixed z-10 inset-0 overflow-y-auto opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="modal-content bg-white m-auto p-4 max-w-sm rounded-lg shadow-xl text-center transition-all duration-300 scale-90">
        <div class="modal-header mb-2">
            <h2 class="text-xl font-bold">Game Result</h2>
            <span class="close-btn absolute top-0 right-0 p-4 cursor-pointer text-gray-500 hover:text-black text-2xl">&times;</span>
        </div>
        <div id="modal-result" class="modal-body mb-4 text-lg"></div>
        <div class="modal-footer">
            <button id="play-again-btn" class="btn btn-primary bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded mr-2">Play Again</button>
            <button id="reset-btn" class="btn btn-secondary bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Reset Game</button>
        </div>
    </div>
</div>

<script type="module">
    import {app} from '../firebase.js';

    import {
        getDatabase,
        ref,
        set,
        get,
        onValue,
        update
    } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

    const db = getDatabase(app);
    const gameIdFromUrl = window.location.hash.substr(1);
    const gameId = gameIdFromUrl || generateGameId();
    const isNewGame = gameIdFromUrl === '';
    const gameRef = ref(db, `games/${gameId}`);
    const scoresRef = ref(db, `scores/${gameId}`);
    let isPlayerTwo = !isNewGame;
    let hasChosen = false;
    let playerScore = 0;
    let opponentScore = 0;

    onValue(scoresRef, (snapshot) => {
        const {player1 = 0, player2 = 0} = snapshot.val() || {};
        [playerScore, opponentScore] = isPlayerTwo ? [player2, player1] : [player1, player2];
        document.getElementById('player-score').textContent = playerScore;
        document.getElementById('opponent-score').textContent = opponentScore;
    });

    if (isNewGame) {
        showShareUrl();
    } else {
        animateElement('#game-info', {opacity: 1}, {opacity: 0}, () => {
            document.getElementById('game-info').textContent = 'Make your choice.';
            animateElement('#game-info', {opacity: 0}, {opacity: 1});
        });
    }

    function displayResult(player1Choice, player2Choice, result) {
        const choicesMap = {rock: 'ü™®', paper: 'üìÉ', scissors: '‚úÇÔ∏è'};
        const resultElement = document.getElementById('result');
        const [player1Emoji, player2Emoji] = [choicesMap[player1Choice], choicesMap[player2Choice]];
        const winnerText = result === 'tie'
            ? "It's a tie!"
            : result === 'player1'
                ? `${isPlayerTwo ? 'Opponent wins' : 'You win'}!`
                : `${isPlayerTwo ? 'You win' : 'Opponent wins'}!`;

        resultElement.innerHTML = `<div>${player1Emoji} vs ${player2Emoji}</div><div>${winnerText}</div>`;
        animateElement('.choices', {opacity: 1}, {opacity: 0});
        animateElement('#share-url', {opacity: 1}, {opacity: 0});
        animateElement('#result', {opacity: 0}, {opacity: 1});
        document.getElementById('modal-result').textContent = winnerText;
        modal.open();
    }

    function initOrUpdateGame(choice) {
        if (hasChosen) {
            alert('You have already made your choice!');
            return Promise.resolve();
        }
        hasChosen = true;
        animateElement('#game-info', {opacity: 1}, {opacity: 0}, () => {
            document.getElementById('game-info').textContent = 'Choice submitted! Please wait for the other player.';
            animateElement('#game-info', {opacity: 0}, {opacity: 1});
        });
        document.getElementById('your-choice').querySelector('span').textContent = choice;
        animateElement('#your-choice', {opacity: 0}, {opacity: 1});

        return get(gameRef).then((snapshot) => {
            const updates = {
                player1Choice: isNewGame ? choice : snapshot.val()?.player1Choice || null,
                player2Choice: isPlayerTwo ? choice : snapshot.val()?.player2Choice || null
            };
            return snapshot.exists() ? update(gameRef, updates) : set(gameRef, updates);
        });
    }

    function processGameUpdate(player1Choice, player2Choice) {
        if (!player1Choice || !player2Choice) return;

        const result = getGameResult(player1Choice, player2Choice);
        if (result !== 'tie' && !isPlayerTwo) {
            [playerScore, opponentScore] = result === 'player1'
                ? [playerScore + 1, opponentScore]
                : [playerScore, opponentScore + 1];
            updateScores(playerScore, opponentScore);
        }
        displayResult(player1Choice, player2Choice, result);
    }

    onValue(ref(db, `games/${gameId}`), (snapshot) => {
        const {player1Choice, player2Choice} = snapshot.val() || {};
        processGameUpdate(player1Choice, player2Choice);
    });

    document.querySelector('.choices').addEventListener('click', (event) => {
        if (!event.target.classList.contains('choice')) return;
        event.target.classList.add('border-4', 'border-green-400', 'rounded-full', 'shadow-xl');
        const choice = event.target.dataset.choice;
        initOrUpdateGame(choice);
    });

    document.getElementById('share-url').addEventListener('click', function() {
        if (!this.value) return;
        navigator.clipboard.writeText(this.value).then(() => {
            alert('Link copied to clipboard!');
        });
    });

    const modal = {
        element: document.getElementById('result-modal'),
        open() {
            animateElement('#result-modal', {opacity: 0, pointerEvents: 'none'}, {opacity: 1, pointerEvents: 'auto'});
            animateElement('.modal-content', {opacity: 0, scale: 0.9}, {opacity: 1, scale: 1});
        },
        close() {
            animateElement('#result-modal', {opacity: 1, pointerEvents: 'auto'}, {opacity: 0, pointerEvents: 'none'});
            animateElement('.modal-content', {opacity: 1, scale: 1}, {opacity: 0, scale: 0.9});
        }
    };

    document.getElementsByClassName('close-btn')[0].addEventListener('click', () => modal.close());
    document.getElementById('play-again-btn').addEventListener('click', () => {
        modal.close();
        resetGame();
    });

    document.getElementById('reset-btn').addEventListener('click', () => {
        modal.close();
        resetGame(true);
    });

    window.addEventListener('click', (event) => {
        if (event.target === modal.element) modal.close();
    });

    function resetGame(isNewGame = false) {
        set(gameRef, {player1Choice: null, player2Choice: null});
        if (isNewGame) {
            updateScores(0, 0);
            isPlayerTwo = false;
        }
        animateElement('#game-info', {opacity: 1}, {opacity: 0}, () => {
            document.getElementById('game-info').textContent = isNewGame ? 'Creating game...' : 'Make your choice.';
            animateElement('#game-info', {opacity: 0}, {opacity: 1});
        });
        animateElement('.choices', {opacity: 0}, {opacity: 1});
        animateElement('#result', {opacity: 1}, {opacity: 0});
        animateElement('#your-choice', {opacity: 1}, {opacity: 0});
        document.querySelectorAll('.choice').forEach(element => {
            element.classList.remove('border-4', 'border-green-400', 'rounded-full', 'shadow-xl');
        });
        hasChosen = false;

        if (isNewGame) {
            const newGameId = generateGameId();
            window.location.hash = newGameId;
            showShareUrl();
        }
    }

    function animateElement(selector, from, to, callback) {
        anime({
            targets: selector,
            ...from,
            ...to,
            duration: 300,
            easing: 'easeInOutSine',
            complete: callback
        });
    }

    // Helper functions
    function generateGameId() {
        return Math.random().toString(36).substr(2, 9);
    }

    function showShareUrl() {
        const shareUrl = `${window.location.origin}${window.location.pathname}#${gameId}`;
        console.log('shareurl', shareUrl);
        document.getElementById('share-url').value = shareUrl;
        animateElement('#share-url', {opacity: 0}, {opacity: 1});
        animateElement('#game-info', {opacity: 1}, {opacity: 0}, () => {
            document.getElementById('game-info').textContent = 'Share this URL with a friend:';
            animateElement('#game-info', {opacity: 0}, {opacity: 1});
        });
    }

    function getGameResult(player1Choice, player2Choice) {
        if (player1Choice === player2Choice) return 'tie';
        const winningCombos = [
            ['rock', 'scissors'],
            ['scissors', 'paper'],
            ['paper', 'rock']
        ];
        return winningCombos.some(([a, b]) => a === player1Choice && b === player2Choice)
            ? 'player1'
            : 'player2';
    }

    function updateScores(player1Score, player2Score) {
        set(scoresRef, {player1: player1Score, player2: player2Score});
    }
</script>
</body>
</html>