<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Play FreeCell Solitaire online for free. A classic single-player card game with undo, hints, game numbers, and statistics tracking. No download required.">
    <meta name="keywords" content="FreeCell, Solitaire, Card Game, Free Online Game, Browser Game, Patience, Classic Game">
    <meta name="author" content="Claude Opus 4.5 prompted by Tobias MÃ¼ller">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://www.gptgames.dev/games/freecell.html">
    <meta property="og:title" content="FreeCell Solitaire - Free Online Card Game">
    <meta property="og:description" content="Play FreeCell Solitaire online for free. Classic card game with undo, hints, and statistics tracking.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.gptgames.dev/games/freecell.html">
    <meta property="og:image" content="https://www.gptgames.dev/screenshots/screenshot_231.webp">
    <meta property="og:site_name" content="GPT Games">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="FreeCell Solitaire - Free Online Card Game">
    <meta name="twitter:description" content="Play FreeCell Solitaire online for free. Classic card game with undo, hints, and statistics tracking.">
    <meta name="twitter:image" content="https://www.gptgames.dev/screenshots/screenshot_231.webp">
    <title>FreeCell</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        :root {
            --felt: #1e7847;
            --felt-dark: #165c38;
            --felt-darker: #0f4528;
            --cell-bg: rgba(0, 0, 0, 0.18);
            --cell-border: rgba(255, 255, 255, 0.15);
            --card-bg: #fff;
            --card-border: #e0e0e0;
            --red: #c62828;
            --black: #1a1a1a;
            --gold: #fbbf24;
            --green: #34d399;
            --blue: #60a5fa;
            --card-w: 72px;
            --card-h: 100px;
            --stack-gap: 22px
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--felt);
            min-height: 100vh;
            color: #fff;
            user-select: none;
            overflow-x: hidden
        }

        .header {
            background: var(--felt-darker);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2)
        }

        .brand {
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px
        }

        .brand span {
            color: var(--green)
        }

        .hgroup {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap
        }

        .stats {
            display: flex;
            gap: 4px
        }

        .stat {
            background: rgba(0, 0, 0, 0.25);
            padding: 6px 12px;
            border-radius: 6px;
            text-align: center;
            min-width: 64px
        }

        .stat:first-child {
            border-radius: 6px 0 0 6px
        }

        .stat:last-child {
            border-radius: 0 6px 6px 0
        }

        .stat:not(:last-child) {
            border-right: 1px solid rgba(255, 255, 255, 0.1)
        }

        .stat-val {
            font-size: 1.05rem;
            font-weight: 600;
            font-variant-numeric: tabular-nums
        }

        .stat-lbl {
            font-size: 0.6rem;
            text-transform: uppercase;
            opacity: 0.6;
            letter-spacing: 0.5px;
            margin-top: 1px
        }

        .game-input {
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 6px;
            overflow: hidden
        }

        .game-input label {
            font-size: 0.75rem;
            padding: 0 8px;
            opacity: 0.7
        }

        .game-input input {
            width: 56px;
            padding: 8px 4px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 0.85rem;
            text-align: center
        }

        .game-input input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.18)
        }

        .game-input button {
            background: var(--green);
            border: none;
            color: #000;
            padding: 8px 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.75rem
        }

        .game-input button:hover {
            background: #4eeab3
        }

        .controls {
            display: flex;
            gap: 6px
        }

        .btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.12s;
            display: flex;
            align-items: center;
            gap: 5px
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.2)
        }

        .btn:active {
            transform: scale(0.96)
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none
        }

        .btn.primary {
            background: var(--green);
            border-color: var(--green);
            color: #000
        }

        .btn.primary:hover {
            background: #4eeab3
        }

        .game-area {
            max-width: 680px;
            margin: 0 auto;
            padding: 24px 16px
        }

        .top-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 24px
        }

        .cell-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px
        }

        .cell-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            opacity: 0.5;
            font-weight: 500
        }

        .cells, .foundations {
            display: flex;
            gap: 8px
        }

        .cell, .foundation {
            width: var(--card-w);
            height: var(--card-h);
            background: var(--cell-bg);
            border-radius: 10px;
            border: 2px dashed var(--cell-border);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: border-color 0.12s, background 0.12s
        }

        .cell:hover, .foundation:hover {
            border-color: rgba(255, 255, 255, 0.25)
        }

        .valid-target {
            border-color: var(--green) !important;
            border-style: solid !important;
            background: rgba(52, 211, 153, 0.1) !important
        }

        .foundation::before {
            content: attr(data-suit);
            font-size: 2.2rem;
            opacity: 0.2;
            position: absolute;
            pointer-events: none
        }

        .foundation:has(.card)::before {
            display: none
        }

        .foundation[data-suit="â™¥"]::before, .foundation[data-suit="â™¦"]::before {
            color: #e57373
        }

        .cascades {
            display: flex;
            gap: 10px;
            justify-content: center
        }

        .cascade {
            width: var(--card-w);
            min-height: calc(var(--card-h) + 220px);
            position: relative
        }

        .empty-cascade {
            width: 100%;
            height: var(--card-h);
            border: 2px dashed var(--cell-border);
            border-radius: 10px;
            background: var(--cell-bg);
            position: absolute;
            top: 0;
            transition: all 0.12s
        }

        .empty-cascade:hover {
            border-color: rgba(255, 255, 255, 0.25)
        }

        .card {
            width: var(--card-w);
            height: var(--card-h);
            background: var(--card-bg);
            border-radius: 8px;
            position: absolute;
            left: 0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15), 0 2px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 5px 7px;
            transition: transform 0.12s, box-shadow 0.12s;
            border: 1px solid var(--card-border)
        }

        .card.red {
            color: var(--red)
        }

        .card.black {
            color: var(--black)
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2)
        }

        .card.selected {
            box-shadow: 0 0 0 3px var(--gold), 0 8px 20px rgba(0, 0, 0, 0.25);
            transform: translateY(-6px);
            z-index: 100 !important
        }

        .card.in-selection {
            box-shadow: 0 0 0 3px var(--gold), 0 8px 20px rgba(0, 0, 0, 0.25);
            transform: translateY(-6px)
        }

        .card.valid-target {
            box-shadow: 0 0 0 3px var(--green);
            border-color: var(--green)
        }

        .card.hint {
            animation: pulse 0.7s ease-in-out infinite
        }

        .card.shake {
            animation: shake 0.3s ease-in-out
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 3px var(--blue)
            }
            50% {
                box-shadow: 0 0 0 5px var(--blue), 0 0 16px rgba(96, 165, 250, 0.5)
            }
        }

        @keyframes shake {
            0%, 100% {
                transform: translateX(0)
            }
            20% {
                transform: translateX(-4px)
            }
            40% {
                transform: translateX(4px)
            }
            60% {
                transform: translateX(-4px)
            }
            80% {
                transform: translateX(4px)
            }
        }

        .corner {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1
        }

        .corner.btm {
            align-self: flex-end;
            transform: rotate(180deg)
        }

        .rank {
            font-size: 1rem;
            font-weight: 700
        }

        .suit {
            font-size: 0.9rem;
            margin-top: -1px
        }

        .card .mid {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8rem;
            opacity: 0.7
        }

        .cell .card, .foundation .card {
            position: relative;
            top: 0 !important;
            left: 0 !important
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s;
            backdrop-filter: blur(4px)
        }

        .modal.show {
            opacity: 1;
            visibility: visible
        }

        .modal-box {
            background: #fff;
            color: var(--black);
            padding: 32px 40px;
            border-radius: 16px;
            text-align: center;
            max-width: 340px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3)
        }

        .modal-box h2 {
            font-size: 1.6rem;
            color: var(--felt-dark);
            margin-bottom: 4px
        }

        .modal-box p {
            color: #666;
            font-size: 0.9rem
        }

        .win-stats {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin: 20px 0
        }

        .win-stat .val {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--felt-dark)
        }

        .win-stat .lbl {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px
        }

        .modal-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px
        }

        .modal-btns .btn {
            color: var(--black);
            border-color: #ddd;
            padding: 10px 20px
        }

        .modal-btns .btn.primary {
            color: #000
        }

        .footer {
            text-align: center;
            padding: 12px;
            font-size: 0.7rem;
            opacity: 0.5;
            letter-spacing: 0.3px
        }

        .confetti {
            position: fixed;
            width: 8px;
            height: 8px;
            z-index: 999;
            pointer-events: none
        }

        @keyframes fall {
            0% {
                transform: translateY(0) rotate(0deg)
            }
            100% {
                transform: translateY(105vh) rotate(720deg)
            }
        }

        @media (max-width: 600px) {
            :root {
                --card-w: 54px;
                --card-h: 76px;
                --stack-gap: 18px
            }

            .header {
                padding: 10px 12px;
                gap: 10px
            }

            .brand {
                font-size: 1.1rem
            }

            .stat {
                padding: 5px 8px;
                min-width: 52px
            }

            .stat-val {
                font-size: 0.9rem
            }

            .game-input label {
                display: none
            }

            .game-input input {
                width: 48px;
                padding: 6px 4px
            }

            .btn {
                padding: 6px 10px;
                font-size: 0.75rem
            }

            .btn span {
                display: none
            }

            .game-area {
                padding: 16px 8px
            }

            .top-row {
                margin-bottom: 18px
            }

            .cells, .foundations {
                gap: 5px
            }

            .cascades {
                gap: 5px
            }

            .card .mid {
                font-size: 1.3rem
            }

            .rank {
                font-size: 0.85rem
            }

            .suit {
                font-size: 0.75rem
            }
        }
    </style>
</head>
<body>
<header class="header">
    <div class="brand">â™  Free<span>Cell</span></div>
    <div class="hgroup">
        <div class="stats">
            <div class="stat">
                <div class="stat-val" id="moves">0</div>
                <div class="stat-lbl">Moves</div>
            </div>
            <div class="stat">
                <div class="stat-val" id="timer">0:00</div>
                <div class="stat-lbl">Time</div>
            </div>
            <div class="stat">
                <div class="stat-val" id="progress">0</div>
                <div class="stat-lbl">Done</div>
            </div>
        </div>
        <div class="game-input">
            <label>Game</label>
            <input id="gameNum" type="text" maxlength="5" placeholder="#">
            <button id="goBtn">GO</button>
        </div>
    </div>
    <div class="controls">
        <button class="btn" id="hintBtn" title="Hint (H)">ðŸ’¡<span>Hint</span></button>
        <button class="btn" id="undoBtn" disabled title="Undo (Z)">â†¶<span>Undo</span></button>
        <button class="btn" id="restartBtn" title="Restart (R)">â†»</button>
        <button class="btn primary" id="newBtn" title="New Game (N)">New</button>
    </div>
</header>
<main class="game-area">
    <div class="top-row">
        <div class="cell-group">
            <div class="cell-label">Free Cells</div>
            <div class="cells" id="cells"></div>
        </div>
        <div class="cell-group">
            <div class="cell-label">Foundation</div>
            <div class="foundations" id="founds"></div>
        </div>
    </div>
    <div class="cascades" id="cascades"></div>
</main>
<footer class="footer" id="footer"></footer>
<div class="modal" id="modal">
    <div class="modal-box">
        <h2>ðŸŽ‰ You Won!</h2>
        <p>Game #<span id="winGame">0</span> completed</p>
        <div class="win-stats">
            <div class="win-stat">
                <div class="val" id="winMoves">0</div>
                <div class="lbl">Moves</div>
            </div>
            <div class="win-stat">
                <div class="val" id="winTime">0:00</div>
                <div class="lbl">Time</div>
            </div>
        </div>
        <div class="modal-btns">
            <button class="btn" id="replayBtn">Replay</button>
            <button class="btn primary" id="newWinBtn">New Game</button>
        </div>
    </div>
</div>
<script>
    const SUITS = ['â™ ', 'â™¥', 'â™¦', 'â™£'], COLORS = {'â™ ': 'black', 'â™¥': 'red', 'â™¦': 'red', 'â™£': 'black'},
        RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
    let state, history = [], sel = null, moves = 0, tmr = null, secs = 0, seed = 0, stats = load();
    const $ = id => document.getElementById(id),
        fmt = s => `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`;

    function load() {
        try {
            return JSON.parse(localStorage.getItem('fc')) || {p: 0, w: 0, b: null}
        } catch (e) {
            return {p: 0, w: 0, b: null}
        }
    }

    function save() {
        try {
            localStorage.setItem('fc', JSON.stringify(stats))
        } catch (e) {
        }
    }

    function showStats() {
        const r = stats.p ? Math.round(stats.w / stats.p * 100) : 0;
        $('footer').textContent = `Played: ${stats.p} Â· Won: ${stats.w} (${r}%)${stats.b ? ` Â· Best: ${fmt(stats.b)}` : ''}`
    }

    function rng(s) {
        return () => (s = (s * 9301 + 49297) % 233280, s / 233280)
    }

    function shuffle(a, s) {
        const r = rng(s), b = [...a];
        for (let i = b.length - 1; i > 0; i--) {
            const j = Math.floor(r() * (i + 1));
            [b[i], b[j]] = [b[j], b[i]]
        }
        return b
    }

    function init(s) {
        seed = s || Date.now();
        const gn = seed % 100000;
        $('gameNum').value = gn;
        const deck = [];
        SUITS.forEach(s => RANKS.forEach(r => deck.push({s, r, c: COLORS[s], v: RANKS.indexOf(r)})));
        state = {cells: [null, null, null, null], founds: [[], [], [], []], cols: [[], [], [], [], [], [], [], []]};
        shuffle(deck, seed).forEach((c, i) => state.cols[i % 8].push(c));
        history = [];
        sel = null;
        moves = 0;
        $('moves').textContent = '0';
        clearInterval(tmr);
        secs = 0;
        $('timer').textContent = '0:00';
        tmr = setInterval(() => {
            secs++;
            $('timer').textContent = fmt(secs)
        }, 1000);
        render();
        $('undoBtn').disabled = true;
        $('modal').classList.remove('show');
        updProg();
        showStats()
    }

    function updProg() {
        $('progress').textContent = state.founds.reduce((a, f) => a + f.length, 0) + '/52'
    }

    function render() {
        $('cells').innerHTML = state.cells.map((_, i) => `<div class="cell" data-t="cell" data-i="${i}"></div>`).join('');
        state.cells.forEach((c, i) => {
            if (c) $('cells').children[i].appendChild(mkCard(c, 'cell', i))
        });
        $('founds').innerHTML = state.founds.map((_, i) => `<div class="foundation" data-t="found" data-i="${i}" data-suit="${SUITS[i]}"></div>`).join('');
        state.founds.forEach((f, i) => {
            if (f.length) $('founds').children[i].appendChild(mkCard(f[f.length - 1], 'found', i))
        });
        $('cascades').innerHTML = state.cols.map((_, i) => `<div class="cascade" data-t="col" data-i="${i}"><div class="empty-cascade"></div></div>`).join('');
        state.cols.forEach((col, ci) => {
            const el = $('cascades').children[ci];
            col.forEach((c, ri) => {
                const cd = mkCard(c, 'col', ci, ri);
                cd.style.top = ri * 22 + 'px';
                cd.style.zIndex = ri;
                el.appendChild(cd)
            })
        });
        hilite()
    }

    function mkCard(c, t, i, r = 0) {
        const el = document.createElement('div');
        el.className = 'card ' + c.c;
        el.dataset.t = t;
        el.dataset.i = i;
        el.dataset.r = r;
        el.innerHTML = `<div class="corner"><span class="rank">${c.r}</span><span class="suit">${c.s}</span></div><span class="mid">${c.s}</span><div class="corner btm"><span class="rank">${c.r}</span><span class="suit">${c.s}</span></div>`;
        el.onclick = e => {
            e.stopPropagation();
            click(t, i, r)
        };
        el.ondblclick = e => {
            e.stopPropagation();
            auto(t, i, r)
        };
        return el
    }

    function get(t, i, r = 0) {
        if (t === 'cell') return state.cells[i];
        if (t === 'found') {
            const f = state.founds[i];
            return f[f.length - 1] || null
        }
        return state.cols[i][r] || null
    }

    function click(t, i, r) {
        clrHint();
        if (sel) {
            if (sel.t === t && sel.i === i && sel.r === r) {
                sel = null;
                render();
                return
            }
            if (canMove(sel, t, i)) {
                doMove(sel, t, i);
                sel = null;
                render();
                post();
                return
            }
            shake(t, i, r)
        }
        const c = get(t, i, r);
        if (!c) {
            if (sel && canMove(sel, t, i)) {
                doMove(sel, t, i);
                sel = null;
                render();
                post()
            }
            return
        }
        if (t === 'col') {
            const col = state.cols[i];
            if (r < col.length - 1 && !validSeq(col.slice(r))) {
                sel = null;
                render();
                return
            }
        }
        if (t === 'found') return;
        sel = {t, i, r};
        render()
    }

    function shake(t, i, r) {
        const cards = document.querySelectorAll(`.card[data-t="${t}"][data-i="${i}"]`);
        cards.forEach(el => {
            if (t !== 'col' || +el.dataset.r >= r) {
                el.classList.add('shake');
                setTimeout(() => el.classList.remove('shake'), 300)
            }
        })
    }

    function validSeq(cs) {
        for (let i = 0; i < cs.length - 1; i++) if (cs[i].c === cs[i + 1].c || cs[i].v !== cs[i + 1].v + 1) return false;
        return true
    }

    function maxMv() {
        const ec = state.cells.filter(c => !c).length, ecc = state.cols.filter(c => !c.length).length;
        return (1 + ec) * Math.pow(2, ecc)
    }

    function canMove(f, tt, ti) {
        const c = get(f.t, f.i, f.r);
        if (!c) return false;
        let n = 1;
        if (f.t === 'col') n = state.cols[f.i].length - f.r;
        if (tt === 'cell') return n === 1 && !state.cells[ti];
        if (tt === 'found') {
            if (n > 1 || c.s !== SUITS[ti]) return false;
            const fd = state.founds[ti];
            return fd.length ? c.v === fd[fd.length - 1].v + 1 : c.v === 0
        }
        if (tt === 'col') {
            const to = state.cols[ti],
                mx = maxMv() - (to.length ? 0 : Math.pow(2, state.cols.filter(x => !x.length).length - 1));
            if (n > mx) return false;
            return !to.length || c.c !== to[to.length - 1].c && c.v === to[to.length - 1].v - 1
        }
        return false
    }

    function doMove(f, tt, ti) {
        history.push(JSON.parse(JSON.stringify(state)));
        let cs = [];
        if (f.t === 'cell') {
            cs = [state.cells[f.i]];
            state.cells[f.i] = null
        } else if (f.t === 'col') cs = state.cols[f.i].splice(f.r);
        if (tt === 'cell') state.cells[ti] = cs[0];
        else if (tt === 'found') state.founds[ti].push(...cs);
        else state.cols[ti].push(...cs);
        moves++;
        $('moves').textContent = moves;
        $('undoBtn').disabled = false;
        tone(380, 0.05)
    }

    function auto(t, i, r) {
        clrHint();
        const c = get(t, i, r);
        if (!c) return;
        if (t === 'col' && r !== state.cols[i].length - 1) return;
        for (let fi = 0; fi < 4; fi++) if (canMove({t, i, r}, 'found', fi)) {
            doMove({t, i, r}, 'found', fi);
            render();
            post();
            return
        }
        for (let ci = 0; ci < 8; ci++) if (ci !== i && canMove({t, i, r}, 'col', ci) && state.cols[ci].length) {
            doMove({t, i, r}, 'col', ci);
            render();
            post();
            return
        }
        for (let ci = 0; ci < 4; ci++) if (canMove({t, i, r}, 'cell', ci)) {
            doMove({t, i, r}, 'cell', ci);
            render();
            post();
            return
        }
    }

    function hilite() {
        document.querySelectorAll('.selected,.in-selection,.valid-target').forEach(el => el.classList.remove('selected', 'in-selection', 'valid-target'));
        if (!sel) return;
        document.querySelectorAll('.card').forEach(el => {
            const t = el.dataset.t, i = +el.dataset.i, r = +el.dataset.r;
            if (t === sel.t && i === sel.i) {
                if (r === sel.r) el.classList.add('selected');
                else if (t === 'col' && r > sel.r) el.classList.add('in-selection')
            } else if (canMove(sel, t, i)) el.classList.add('valid-target')
        });
        document.querySelectorAll('.cell,.foundation').forEach(el => {
            const t = el.dataset.t === 'found' ? 'found' : 'cell';
            if (canMove(sel, t, +el.dataset.i)) el.classList.add('valid-target')
        });
        document.querySelectorAll('.empty-cascade').forEach(el => {
            if (canMove(sel, 'col', +el.parentElement.dataset.i)) el.classList.add('valid-target')
        })
    }

    function post() {
        updProg();
        chkWin()
    }

    function chkWin() {
        if (state.founds.every(f => f.length === 13)) {
            clearInterval(tmr);
            stats.p++;
            stats.w++;
            if (!stats.b || secs < stats.b) stats.b = secs;
            save();
            $('winGame').textContent = seed % 100000;
            $('winMoves').textContent = moves;
            $('winTime').textContent = fmt(secs);
            $('modal').classList.add('show');
            celebrate()
        } else autoComp()
    }

    function autoComp() {
        const mn = Math.min(...state.founds.map(f => f.length ? f[f.length - 1].v : -1));
        for (let ci = 0; ci < 8; ci++) {
            const col = state.cols[ci];
            if (!col.length) continue;
            const c = col[col.length - 1], fi = SUITS.indexOf(c.s), fd = state.founds[fi];
            if ((fd.length ? c.v === fd[fd.length - 1].v + 1 : c.v === 0) && c.v <= mn + 1) {
                doMove({t: 'col', i: ci, r: col.length - 1}, 'found', fi);
                setTimeout(() => {
                    render();
                    post()
                }, 80);
                return
            }
        }
        for (let i = 0; i < 4; i++) {
            const c = state.cells[i];
            if (!c) continue;
            const fi = SUITS.indexOf(c.s), fd = state.founds[fi];
            if ((fd.length ? c.v === fd[fd.length - 1].v + 1 : c.v === 0) && c.v <= mn + 1) {
                doMove({t: 'cell', i, r: 0}, 'found', fi);
                setTimeout(() => {
                    render();
                    post()
                }, 80);
                return
            }
        }
    }

    function undo() {
        if (!history.length) return;
        state = history.pop();
        sel = null;
        render();
        updProg();
        if (!history.length) $('undoBtn').disabled = true
    }

    function hint() {
        clrHint();
        for (let ci = 0; ci < 8; ci++) {
            const col = state.cols[ci];
            if (!col.length) continue;
            for (let ri = col.length - 1; ri >= 0; ri--) {
                if (ri < col.length - 1 && !validSeq(col.slice(ri))) break;
                for (let fi = 0; fi < 4; fi++) if (canMove({
                    t: 'col',
                    i: ci,
                    r: ri
                }, 'found', fi)) return show('col', ci, ri);
                for (let ti = 0; ti < 8; ti++) if (ti !== ci && canMove({
                    t: 'col',
                    i: ci,
                    r: ri
                }, 'col', ti) && (state.cols[ti].length || ri < col.length - 1)) return show('col', ci, ri)
            }
        }
        for (let i = 0; i < 4; i++) {
            const c = state.cells[i];
            if (!c) continue;
            for (let fi = 0; fi < 4; fi++) if (canMove({t: 'cell', i, r: 0}, 'found', fi)) return show('cell', i, 0);
            for (let ci = 0; ci < 8; ci++) if (canMove({
                t: 'cell',
                i,
                r: 0
            }, 'col', ci) && state.cols[ci].length) return show('cell', i, 0)
        }
    }

    function show(t, i, r) {
        document.querySelectorAll(`.card[data-t="${t}"][data-i="${i}"]`).forEach(el => {
            if (t !== 'col' || +el.dataset.r >= r) el.classList.add('hint')
        })
    }

    function clrHint() {
        document.querySelectorAll('.hint').forEach(el => el.classList.remove('hint'))
    }

    function celebrate() {
        for (let i = 0; i < 60; i++) {
            const c = document.createElement('div');
            c.className = 'confetti';
            const colors = ['#ef4444', '#22c55e', '#3b82f6', '#fbbf24', '#ec4899', '#8b5cf6'];
            c.style.cssText = `left:${Math.random() * 100}vw;top:-10px;background:${colors[i % colors.length]};border-radius:${Math.random() > 0.5 ? '50%' : '2px'};animation:fall ${2.5 + Math.random() * 2}s linear ${Math.random() * 0.5}s forwards`;
            document.body.appendChild(c);
            setTimeout(() => c.remove(), 5000)
        }
        tone(523, 0.1);
        setTimeout(() => tone(659, 0.1), 120);
        setTimeout(() => tone(784, 0.15), 240)
    }

    function tone(f, d) {
        try {
            const x = new (window.AudioContext || window.webkitAudioContext)();
            const o = x.createOscillator(), g = x.createGain();
            o.connect(g);
            g.connect(x.destination);
            o.frequency.value = f;
            o.type = 'sine';
            g.gain.setValueAtTime(0.08, x.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, x.currentTime + d);
            o.start();
            o.stop(x.currentTime + d)
        } catch (e) {
        }
    }

    document.addEventListener('click', e => {
        if (!e.target.closest('.card,.cell,.foundation,.empty-cascade,.modal-box')) {
            sel = null;
            clrHint();
            render()
        }
    });
    document.addEventListener('keydown', e => {
        if (e.target.tagName === 'INPUT') return;
        const k = e.key.toLowerCase();
        if (k === 'z' && !e.metaKey && !e.ctrlKey) undo();
        if (k === 'n') {
            stats.p++;
            save();
            init()
        }
        if (k === 'h') hint();
        if (k === 'r') init(seed)
    });
    $('cascades').onclick = e => {
        const ec = e.target.closest('.empty-cascade');
        if (ec && sel) {
            const i = +ec.parentElement.dataset.i;
            if (canMove(sel, 'col', i)) {
                doMove(sel, 'col', i);
                sel = null;
                render();
                post()
            }
        }
    };
    $('cells').onclick = e => {
        if (e.target.classList.contains('cell') && sel) {
            const i = +e.target.dataset.i;
            if (canMove(sel, 'cell', i)) {
                doMove(sel, 'cell', i);
                sel = null;
                render();
                post()
            }
        }
    };
    $('founds').onclick = e => {
        if (e.target.classList.contains('foundation') && sel) {
            const i = +e.target.dataset.i;
            if (canMove(sel, 'found', i)) {
                doMove(sel, 'found', i);
                sel = null;
                render();
                post()
            }
        }
    };
    $('undoBtn').onclick = undo;
    $('hintBtn').onclick = hint;
    $('restartBtn').onclick = () => init(seed);
    $('newBtn').onclick = () => {
        stats.p++;
        save();
        init()
    };
    $('newWinBtn').onclick = () => init();
    $('replayBtn').onclick = () => init(seed);
    $('goBtn').onclick = () => {
        const v = parseInt($('gameNum').value);
        if (v > 0) {
            stats.p++;
            save();
            init(v)
        }
    };
    $('gameNum').onkeydown = e => {
        if (e.key === 'Enter') {
            const v = parseInt($('gameNum').value);
            if (v > 0) {
                stats.p++;
                save();
                init(v)
            }
        }
    };
    init(12345);
</script>
</body>
</html>