<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üñåÔ∏è</text></svg>">
    <title>Doodle Studio Pro</title>
    <meta name="keywords" content="Drawing, Sketching, Digital Art, Canvas, Brush, Color Palette, Save, Export"/>
    <meta name="description"
          content="Doodle Studio Pro: A professional yet simple drawing tool for creating digital art right in your browser. Customize brushes, use layers, and export your creations."/>
    <style>
        :root {
            --primary: #4a6fa5;
            --primary-light: #6989b9;
            --primary-dark: #2d5186;
            --secondary: #5d4a7e;
            --accent: #e63946;
            --text: #333;
            --text-light: #666;
            --background: #f8f9fa;
            --surface: #fff;
            --surface-alt: #f0f0f0;
            --border: #ddd;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-dark: 0 4px 12px rgba(0, 0, 0, 0.15);
            --radius: 8px;
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #5d81bc;
                --primary-light: #7599d1;
                --primary-dark: #3e5d8f;
                --secondary: #6d5c8d;
                --accent: #f05c6c;
                --text: #e0e0e0;
                --text-light: #b0b0b0;
                --background: #1a1a1a;
                --surface: #2a2a2a;
                --surface-alt: #333;
                --border: #444;
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.5;
            transition: background-color 0.3s ease;
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: var(--primary);
            color: #fff;
            padding: var(--space-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            z-index: 10;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-weight: 700;
            font-size: 1.4rem;
        }

        .logo-icon {
            font-size: 1.5rem;
        }

        .main {
            display: flex;
            flex-grow: 1;
            height: calc(100vh - 56px);
            overflow: hidden;
        }

        .sidebar {
            width: 56px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar.expanded {
            width: 220px;
        }

        .toolbar {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
            padding: var(--space-xs);
            overflow-y: auto;
            flex-grow: 1;
        }

        .tool-section {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
            margin-bottom: var(--space-md);
        }

        .tool-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-light);
            margin: var(--space-xs) 0;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .sidebar.expanded .tool-section-title {
            opacity: 1;
        }

        .tool-btn {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm);
            border-radius: var(--radius);
            border: none;
            background: transparent;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            width: 100%;
            text-align: left;
        }

        .tool-btn:hover {
            background: var(--surface-alt);
        }

        .tool-btn.active {
            background: var(--primary-light);
            color: #fff;
        }

        .tool-btn svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .tool-btn span {
            white-space: nowrap;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .sidebar.expanded .tool-btn span {
            opacity: 1;
        }

        .canvas-container {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            background: var(--surface-alt);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .canvas-wrapper {
            position: relative;
            box-shadow: var(--shadow-dark);
        }

        #drawing-canvas {
            background: #fff;
            cursor: crosshair;
            touch-action: none;
        }

        .controls {
            position: absolute;
            bottom: var(--space-md);
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: var(--space-sm);
            background: var(--surface);
            padding: var(--space-xs);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-sm);
        }

        .control-group:not(:last-child) {
            border-right: 1px solid var(--border);
        }

        .control-label {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        input[type="range"] {
            width: 100px;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--surface-alt);
            border-radius: 4px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        input[type="color"] {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: var(--radius);
            padding: 0;
            cursor: pointer;
        }

        .color-preview {
            width: 28px;
            height: 28px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .brush-preview {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--text);
            border: 1px solid var(--border);
        }

        .size-value {
            min-width: 24px;
            text-align: center;
            font-size: 0.8rem;
        }

        .sidebar-toggle {
            position: absolute;
            top: var(--space-md);
            left: var(--space-md);
            background: var(--surface);
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            z-index: 100;
        }

        .zoom-controls {
            position: absolute;
            bottom: var(--space-md);
            right: var(--space-md);
            display: flex;
            gap: var(--space-xs);
            background: var(--surface);
            padding: var(--space-xs);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .zoom-btn {
            background: transparent;
            border: none;
            color: var(--text);
            cursor: pointer;
            padding: var(--space-xs);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-value {
            font-size: 0.9rem;
            min-width: 50px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .layers-panel {
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
            background: var(--surface);
            padding: var(--space-sm);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            width: 200px;
            max-height: 300px;
            overflow-y: auto;
        }

        .layer-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-xs);
            border-radius: var(--radius);
            background: var(--surface-alt);
        }

        .layer-preview {
            width: 30px;
            height: 30px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }

        .layer-name {
            flex-grow: 1;
            font-size: 0.9rem;
        }

        .layer-visible {
            cursor: pointer;
        }

        .notification {
            position: fixed;
            bottom: var(--space-md);
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--surface);
            color: var(--text);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
            opacity: 0;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .notification.success {
            border-left: 4px solid #4caf50;
        }

        .notification.error {
            border-left: 4px solid var(--accent);
        }

        .notification.info {
            border-left: 4px solid var(--primary);
        }

        .dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .dialog.open {
            opacity: 1;
            pointer-events: auto;
        }

        .dialog-content {
            background: var(--surface);
            padding: var(--space-md);
            border-radius: var(--radius);
            box-shadow: var(--shadow-dark);
            width: 90%;
            max-width: 500px;
        }

        .dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .dialog-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .dialog-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .dialog-body {
            margin-bottom: var(--space-md);
        }

        .dialog-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-sm);
        }

        .btn {
            padding: var(--space-xs) var(--space-md);
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--surface-alt);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: var(--accent);
            color: #fff;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
        }

        .color-option {
            width: 24px;
            height: 24px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .color-option.active {
            box-shadow: 0 0 0 2px var(--primary);
        }

        .canvas-bg-preview {
            width: 100%;
            height: 100px;
            margin-bottom: var(--space-md);
            background-size: 16px 16px;
            background-position: 0 0, 8px 8px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
            margin-bottom: var(--space-sm);
        }

        .form-group label {
            font-size: 0.9rem;
        }

        .form-control {
            padding: var(--space-sm);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            font-size: 0.9rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .tooltip {
            position: absolute;
            background: var(--surface);
            color: var(--text);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius);
            font-size: 0.8rem;
            box-shadow: var(--shadow);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
            z-index: 1000;
        }

        .shortcuts-panel {
            padding: var(--space-md);
        }

        .shortcut-group {
            margin-bottom: var(--space-md);
        }

        .shortcut-title {
            font-size: 1.1rem;
            margin-bottom: var(--space-sm);
            color: var(--primary);
        }

        .shortcut-list {
            display: grid;
            grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-sm);
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shortcut-key {
            background: var(--surface-alt);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius);
            font-family: monospace;
            font-size: 0.9rem;
        }

        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 0;
            }

            .sidebar.expanded {
                width: 200px;
            }

            .controls {
                flex-direction: column;
                bottom: var(--space-md);
                left: var(--space-md);
                transform: none;
            }

            .zoom-controls {
                bottom: calc(var(--space-md) * 2 + 50px);
            }
        }
    </style>
</head>
<body>
<div class="app">
    <header class="header">
        <div class="logo">
            <span class="logo-icon">üñåÔ∏è</span>
            <span>Doodle Studio Pro</span>
        </div>
        <div id="header-actions"></div>
    </header>
    <main class="main">
        <div class="sidebar" id="sidebar">
            <div class="toolbar">
                <div class="tool-section">
                    <div class="tool-section-title">Tools</div>
                    <button class="tool-btn active" data-tool="brush">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                            <path d="M2 2l7.586 7.586"></path>
                            <circle cx="11" cy="11" r="2"></circle>
                        </svg>
                        <span>Brush</span>
                    </button>
                    <button class="tool-btn" data-tool="pencil">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                        </svg>
                        <span>Pencil</span>
                    </button>
                    <button class="tool-btn" data-tool="eraser">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 20H7L3 16c-.7-.7-.7-1.8 0-2.5L14.5 2c.7-.7 1.8-.7 2.5 0l5 5c.7.7.7 1.8 0 2.5L10.5 20"></path>
                        </svg>
                        <span>Eraser</span>
                    </button>
                    <button class="tool-btn" data-tool="fill">
                        <svg viewBox="-2 0 32 32" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <g transform="scale(-1, 1) translate(-28, 0)">
                                <path d="M22.347 14.827v0l-10.4-10.453-0.213 0.16v-0.267c0-1.76-1.44-3.2-3.2-3.2s-3.2 1.44-3.2 3.2v6.667l-4.427 4.427c-1.227 1.227-1.227 3.2 0 4.427l6.027 6.027c0.587 0.64 1.44 0.907 2.24 0.907s1.6-0.32 2.24-0.907l7.627-7.68h6.56l-3.253-3.307zM6.4 4.267c0-1.173 0.96-2.133 2.133-2.133s2.133 0.96 2.133 2.133v1.333l-4.267 4.267v-5.6zM18.613 17.067l-8 8c-0.373 0.373-0.907 0.587-1.493 0.587-0.533 0-1.067-0.213-1.44-0.587l-6.027-6.027c-0.8-0.8-0.8-2.133 0-2.933l9.013-8.96v6.72h1.067v-7.787l0.16-0.16 11.147 11.147h-4.427z"></path>
                                <path d="M28.213 26.987c-0.32-2.88-3.413-6.72-3.413-6.72s-3.147 3.893-3.413 6.773c0 0.16 0 0.267 0 0.427 0 1.92 1.547 3.467 3.467 3.467s3.467-1.547 3.467-3.467c-0.053-0.16-0.053-0.32-0.107-0.48zM24.8 29.867c-1.333 0-2.4-1.067-2.4-2.4 0-0.107 0-0.16 0-0.267v0 0c0.16-1.6 1.387-3.68 2.347-5.12 0.96 1.387 2.187 3.52 2.4 5.067 0 0.107 0 0.213 0 0.32 0.053 1.333-1.013 2.4-2.347 2.4z"></path>
                            </g>
                        </svg>
                        <span>Fill</span>
                    </button>
                    <button class="tool-btn" data-tool="line">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        <span>Line</span>
                    </button>
                    <button class="tool-btn" data-tool="rectangle">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        </svg>
                        <span>Rectangle</span>
                    </button>
                    <button class="tool-btn" data-tool="circle">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                        </svg>
                        <span>Circle</span>
                    </button>
                    <button class="tool-btn" data-tool="text">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="4 7 4 4 20 4 20 7"></polyline>
                            <line x1="9" y1="20" x2="15" y2="20"></line>
                            <line x1="12" y1="4" x2="12" y2="20"></line>
                        </svg>
                        <span>Text</span>
                    </button>
                </div>
                <div class="tool-section">
                    <div class="tool-section-title">Actions</div>
                    <button class="tool-btn" id="undo-btn" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 7v6h6"></path>
                            <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path>
                        </svg>
                        <span>Undo</span>
                    </button>
                    <button class="tool-btn" id="redo-btn" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 7v6h-6"></path>
                            <path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"></path>
                        </svg>
                        <span>Redo</span>
                    </button>
                    <button class="tool-btn" id="clear-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        <span>Clear</span>
                    </button>
                </div>
                <div class="tool-section">
                    <div class="tool-section-title">Canvas</div>
                    <button class="tool-btn" id="bg-color-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                        </svg>
                        <span>Background</span>
                    </button>
                    <button class="tool-btn" id="canvas-size-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 3H3v18h18V3z"></path>
                            <path d="M21 11H3"></path>
                            <path d="M11 21V3"></path>
                        </svg>
                        <span>Canvas Size</span>
                    </button>
                </div>
                <div class="tool-section">
                    <div class="tool-section-title">Export</div>
                    <button class="tool-btn" id="save-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        <span>Save</span>
                    </button>
                    <button class="tool-btn" id="export-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        <span>Export</span>
                    </button>
                    <button class="tool-btn" id="load-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <span>Import</span>
                    </button>
                </div>
                <div class="tool-section">
                    <div class="tool-section-title">Help</div>
                    <button class="tool-btn" id="shortcuts-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                        <span>Shortcuts</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="canvas-container">
            <div class="sidebar-toggle" id="sidebar-toggle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                     stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </div>
            <div class="canvas-wrapper" id="canvas-wrapper">
                <canvas id="drawing-canvas" width="800" height="600"></canvas>
            </div>
            <div class="controls">
                <div class="control-group">
                    <input id="size-input" type="range" min="1" max="50" value="5">
                    <span id="size-value" class="size-value">5px</span>
                    <div class="brush-preview" id="brush-preview"></div>
                </div>
                <div class="control-group">
                    <input id="color-input" type="color" value="#000000">
                    <div class="color-palette" id="color-palette">
                        <div class="color-option active" style="background-color: #000000;" data-color="#000000"></div>
                        <div class="color-option" style="background-color: #ffffff;" data-color="#ffffff"></div>
                        <div class="color-option" style="background-color: #ff0000;" data-color="#ff0000"></div>
                        <div class="color-option" style="background-color: #00ff00;" data-color="#00ff00"></div>
                        <div class="color-option" style="background-color: #0000ff;" data-color="#0000ff"></div>
                    </div>
                </div>
            </div>
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoom-out">‚àí</button>
                <span class="zoom-value" id="zoom-value">100%</span>
                <button class="zoom-btn" id="zoom-in">+</button>
                <button class="zoom-btn" id="zoom-reset">‚Ü∫</button>
            </div>
        </div>
    </main>
</div>

<div class="notification" id="notification"></div>

<div class="dialog" id="bg-color-dialog">
    <div class="dialog-content">
        <div class="dialog-header">
            <h3 class="dialog-title">Canvas Background</h3>
            <button class="dialog-close" id="bg-color-close">&times;</button>
        </div>
        <div class="dialog-body">
            <div class="canvas-bg-preview" id="bg-color-preview"></div>
            <div class="form-group">
                <label for="bg-color-input">Background Color</label>
                <input type="color" id="bg-color-input" class="form-control" value="#ffffff">
            </div>
            <div class="form-group">
                <div class="form-check">
                    <input type="checkbox" id="bg-transparent" class="form-control">
                    <label for="bg-transparent">Transparent Background</label>
                </div>
            </div>
            <div class="form-group">
                <div class="form-check">
                    <input type="checkbox" id="bg-pattern" class="form-control">
                    <label for="bg-pattern">Checkerboard Pattern (for transparent areas)</label>
                </div>
            </div>
        </div>
        <div class="dialog-footer">
            <button class="btn btn-secondary" id="bg-color-cancel">Cancel</button>
            <button class="btn btn-primary" id="bg-color-apply">Apply</button>
        </div>
    </div>
</div>

<div class="dialog" id="canvas-size-dialog">
    <div class="dialog-content">
        <div class="dialog-header">
            <h3 class="dialog-title">Canvas Size</h3>
            <button class="dialog-close" id="canvas-size-close">&times;</button>
        </div>
        <div class="dialog-body">
            <div class="form-group">
                <label for="canvas-width">Width (px)</label>
                <input type="number" id="canvas-width" class="form-control" value="800" min="50" max="3000">
            </div>
            <div class="form-group">
                <label for="canvas-height">Height (px)</label>
                <input type="number" id="canvas-height" class="form-control" value="600" min="50" max="3000">
            </div>
            <div class="form-group">
                <div class="form-check">
                    <input type="checkbox" id="canvas-keep-content" class="form-control" checked>
                    <label for="canvas-keep-content">Keep current content</label>
                </div>
            </div>
        </div>
        <div class="dialog-footer">
            <button class="btn btn-secondary" id="canvas-size-cancel">Cancel</button>
            <button class="btn btn-primary" id="canvas-size-apply">Apply</button>
        </div>
    </div>
</div>

<div class="dialog" id="export-dialog">
    <div class="dialog-content">
        <div class="dialog-header">
            <h3 class="dialog-title">Export Drawing</h3>
            <button class="dialog-close" id="export-close">&times;</button>
        </div>
        <div class="dialog-body">
            <div class="form-group">
                <label for="export-format">Format</label>
                <select id="export-format" class="form-control">
                    <option value="png">PNG (with transparency)</option>
                    <option value="jpeg">JPEG (no transparency)</option>
                    <option value="svg">SVG (vector format)</option>
                    <option value="webp">WebP (smaller file size)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="export-quality">Quality (for JPEG/WebP)</label>
                <input type="range" id="export-quality" class="form-control" min="0" max="100" value="90">
                <span id="export-quality-value">90%</span>
            </div>
            <div class="form-group">
                <label for="export-filename">Filename</label>
                <input type="text" id="export-filename" class="form-control" value="doodle-studio-drawing">
            </div>
            <div class="form-group">
                <div class="form-check">
                    <input type="checkbox" id="export-include-bg" class="form-control" checked>
                    <label for="export-include-bg">Include background</label>
                </div>
            </div>
        </div>
        <div class="dialog-footer">
            <button class="btn btn-secondary" id="export-cancel">Cancel</button>
            <button class="btn btn-primary" id="export-download">Download</button>
        </div>
    </div>
</div>

<div class="dialog" id="shortcuts-dialog">
    <div class="dialog-content shortcuts-panel">
        <div class="dialog-header">
            <h3 class="dialog-title">Keyboard Shortcuts</h3>
            <button class="dialog-close" id="shortcuts-close">&times;</button>
        </div>
        <div class="dialog-body">
            <div class="shortcut-group">
                <h4 class="shortcut-title">Tools</h4>
                <div class="shortcut-list">
                    <div class="shortcut-item">
                        <span>Brush</span>
                        <span class="shortcut-key">B</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Pencil</span>
                        <span class="shortcut-key">P</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Eraser</span>
                        <span class="shortcut-key">E</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Fill</span>
                        <span class="shortcut-key">F</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Line</span>
                        <span class="shortcut-key">L</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Rectangle</span>
                        <span class="shortcut-key">R</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Circle</span>
                        <span class="shortcut-key">C</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Text</span>
                        <span class="shortcut-key">T</span>
                    </div>
                </div>
            </div>
            <div class="shortcut-group">
                <h4 class="shortcut-title">Actions</h4>
                <div class="shortcut-list">
                    <div class="shortcut-item">
                        <span>Undo</span>
                        <span class="shortcut-key">Ctrl+Z</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Redo</span>
                        <span class="shortcut-key">Ctrl+Y</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Clear Canvas</span>
                        <span class="shortcut-key">Delete</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Save</span>
                        <span class="shortcut-key">Ctrl+S</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Import</span>
                        <span class="shortcut-key">Ctrl+O</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Export</span>
                        <span class="shortcut-key">Ctrl+E</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Toggle Sidebar</span>
                        <span class="shortcut-key">Tab</span>
                    </div>
                </div>
            </div>
            <div class="shortcut-group">
                <h4 class="shortcut-title">View</h4>
                <div class="shortcut-list">
                    <div class="shortcut-item">
                        <span>Zoom In</span>
                        <span class="shortcut-key">Ctrl+Plus</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Zoom Out</span>
                        <span class="shortcut-key">Ctrl+Minus</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Reset Zoom</span>
                        <span class="shortcut-key">Ctrl+0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const TOOLS = {
        BRUSH: 'brush',
        PENCIL: 'pencil',
        ERASER: 'eraser',
        FILL: 'fill',
        LINE: 'line',
        RECTANGLE: 'rectangle',
        CIRCLE: 'circle',
        TEXT: 'text'
    };
    const DEFAULT_OPTIONS = {
        brushSize: 5,
        brushColor: '#000000',
        brushOpacity: 0.8,
        brushSoftness: 0.5,
        pencilSize: 3,
        pencilHardness: 0.9,
        bgColor: '#FFFFFF',
        isTransparent: false,
        showPattern: true,
        selectedTool: TOOLS.BRUSH,
        zoomLevel: 1,
        maxHistoryStates: 50
    };

    class DoodleStudio {
        constructor() {
            this.canvas = document.getElementById('drawing-canvas');
            this.ctx = this.canvas.getContext('2d');
            this.options = {...DEFAULT_OPTIONS};
            this.isDrawing = false;
            this.lastX = 0;
            this.lastY = 0;
            this.points = [];
            this.history = [];
            this.historyIndex = -1;
            this.redoStack = [];
            this.layers = [{
                name: 'Background',
                canvas: document.createElement('canvas'),
                visible: true
            }, {name: 'Layer 1', canvas: this.canvas, visible: true}];
            this.currentLayerIndex = 1;
            this.lastUpdateTime = 0;
            this.frameId = null;
            this.layers.forEach(layer => {
                if (layer.name === 'Background') {
                    layer.canvas.width = this.canvas.width;
                    layer.canvas.height = this.canvas.height;
                    const bgCtx = layer.canvas.getContext('2d');
                    bgCtx.fillStyle = this.options.bgColor;
                    bgCtx.fillRect(0, 0, layer.canvas.width, layer.canvas.height);
                }
            });
            this.initCanvas();
            this.bindEvents();
            this.saveToHistory();
        }

        initCanvas() {
            this.ctx.lineJoin = 'round';
            this.ctx.lineCap = 'round';
            this.ctx.lineWidth = this.options.brushSize;
            this.ctx.strokeStyle = this.options.brushColor;
            this.updateUI();
        }

        bindEvents() {
            this.canvas.addEventListener('mousedown', this.startDrawing.bind(this));
            this.canvas.addEventListener('mousemove', this.draw.bind(this));
            this.canvas.addEventListener('mouseup', this.stopDrawing.bind(this));
            this.canvas.addEventListener('mouseout', this.stopDrawing.bind(this));
            this.canvas.addEventListener('touchstart', e => {
                e.preventDefault();
                this.startDrawing(e);
            });
            this.canvas.addEventListener('touchmove', e => {
                e.preventDefault();
                this.draw(e);
            });
            this.canvas.addEventListener('touchend', this.stopDrawing.bind(this));
            this.canvas.addEventListener('touchcancel', this.stopDrawing.bind(this));
            document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                btn.addEventListener('click', () => {
                    this.setTool(btn.dataset.tool);
                });
            });
            document.getElementById('size-input').addEventListener('input', e => {
                const size = parseInt(e.target.value);
                if (this.options.selectedTool === TOOLS.PENCIL) {
                    this.options.pencilSize = size;
                } else {
                    this.options.brushSize = size;
                }
                this.updateToolSettings();
                this.updateBrushPreview();
            });
            document.getElementById('color-input').addEventListener('input', e => {
                this.options.brushColor = e.target.value;
                if (this.options.selectedTool !== TOOLS.ERASER) {
                    this.ctx.strokeStyle = this.options.brushColor;
                }
                this.updateBrushPreview();
                this.updateColorPalette();
            });
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', () => {
                    this.options.brushColor = option.dataset.color;
                    document.getElementById('color-input').value = this.options.brushColor;
                    if (this.options.selectedTool !== TOOLS.ERASER) {
                        this.ctx.strokeStyle = this.options.brushColor;
                    }
                    this.updateBrushPreview();
                    this.updateColorPalette();
                });
            });
            document.getElementById('undo-btn').addEventListener('click', this.undo.bind(this));
            document.getElementById('redo-btn').addEventListener('click', this.redo.bind(this));
            document.getElementById('clear-btn').addEventListener('click', this.clearCanvas.bind(this));
            document.getElementById('save-btn').addEventListener('click', this.saveDrawing.bind(this));
            document.getElementById('export-btn').addEventListener('click', () => this.toggleDialog('export-dialog', true));
            document.getElementById('load-btn').addEventListener('click', this.loadDrawing.bind(this));
            document.getElementById('bg-color-btn').addEventListener('click', () => this.toggleDialog('bg-color-dialog', true));
            document.getElementById('canvas-size-btn').addEventListener('click', () => this.toggleDialog('canvas-size-dialog', true));
            document.getElementById('shortcuts-btn').addEventListener('click', () => this.toggleDialog('shortcuts-dialog', true));
            document.getElementById('zoom-in').addEventListener('click', () => this.zoom(0.1));
            document.getElementById('zoom-out').addEventListener('click', () => this.zoom(-0.1));
            document.getElementById('zoom-reset').addEventListener('click', () => this.resetZoom());
            document.querySelectorAll('.dialog-close,[id$="-cancel"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const dialogId = btn.id.split('-close')[0] || btn.id.split('-cancel')[0];
                    this.toggleDialog(`${dialogId}-dialog`, false);
                });
            });
            document.getElementById('bg-color-apply').addEventListener('click', () => {
                const bgColor = document.getElementById('bg-transparent').checked ? 'transparent' : document.getElementById('bg-color-input').value;
                const showPattern = document.getElementById('bg-pattern').checked;
                this.setBgColor(bgColor, showPattern);
                this.toggleDialog('bg-color-dialog', false);
            });
            document.getElementById('canvas-size-apply').addEventListener('click', () => {
                const width = parseInt(document.getElementById('canvas-width').value);
                const height = parseInt(document.getElementById('canvas-height').value);
                const keepContent = document.getElementById('canvas-keep-content').checked;
                this.resizeCanvas(width, height, keepContent);
                this.toggleDialog('canvas-size-dialog', false);
            });
            document.getElementById('export-download').addEventListener('click', () => {
                const format = document.getElementById('export-format').value;
                const quality = parseInt(document.getElementById('export-quality').value) / 100;
                const filename = document.getElementById('export-filename').value;
                const includeBg = document.getElementById('export-include-bg').checked;
                this.exportDrawing(format, quality, filename, includeBg);
                this.toggleDialog('export-dialog', false);
            });
            document.getElementById('export-quality').addEventListener('input', (e) => {
                document.getElementById('export-quality-value').textContent = `${e.target.value}%`;
            });
            document.getElementById('sidebar-toggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('expanded');
            });
            document.addEventListener('keydown', this.handleKeyDown.bind(this));
            document.getElementById('export-format').addEventListener('change', (e) => {
                const qualityGroup = document.getElementById('export-quality').parentElement;
                qualityGroup.style.display = ['jpeg', 'webp'].includes(e.target.value) ? 'block' : 'none';
            });
            window.addEventListener('resize', this.handleResize.bind(this));
        }

        startDrawing(e) {
            this.isDrawing = true;
            const {x, y} = this.getPointerPosition(e);
            this.points = [];
            this.addPoint(x, y);
            this.lastX = x;
            this.lastY = y;
            if ([TOOLS.BRUSH, TOOLS.PENCIL, TOOLS.ERASER].includes(this.options.selectedTool)) {
                this.updateToolSettings();
                if (this.options.selectedTool === TOOLS.BRUSH) {
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, this.options.brushSize / 2 * this.options.brushOpacity, 0, Math.PI * 2);
                    this.ctx.fill();
                } else if (this.options.selectedTool === TOOLS.PENCIL) {
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, this.options.pencilSize / 4, 0, Math.PI * 2);
                    this.ctx.fill();
                } else {
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, this.options.brushSize / 2, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            } else if (this.options.selectedTool === TOOLS.FILL) {
                this.fillArea(x, y);
            } else if (this.options.selectedTool === TOOLS.TEXT) {
                const text = prompt('Enter text:');
                if (text) {
                    this.drawText(text, x, y);
                }
            }
        }

        draw(e) {
            if (!this.isDrawing) return;
            const {x, y} = this.getPointerPosition(e);
            this.addPoint(x, y);
            if ([TOOLS.BRUSH, TOOLS.PENCIL, TOOLS.ERASER].includes(this.options.selectedTool)) {
                if (!this.frameId) {
                    this.frameId = requestAnimationFrame(this.renderStroke.bind(this));
                }
            } else if ([TOOLS.LINE, TOOLS.RECTANGLE, TOOLS.CIRCLE].includes(this.options.selectedTool)) {
                const imageData = this.history[this.historyIndex];
                if (imageData) {
                    const img = new Image();
                    img.onload = () => {
                        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                        this.ctx.drawImage(img, 0, 0);
                        if (this.options.selectedTool === TOOLS.LINE) {
                            this.drawLine(this.lastX, this.lastY, x, y);
                        } else if (this.options.selectedTool === TOOLS.RECTANGLE) {
                            this.drawRectangle(this.lastX, this.lastY, x, y);
                        } else if (this.options.selectedTool === TOOLS.CIRCLE) {
                            this.drawCircle(this.lastX, this.lastY, x, y);
                        }
                    };
                    img.src = imageData;
                }
            }
        }

        renderStroke() {
            const now = Date.now();
            const dt = now - this.lastUpdateTime;
            this.lastUpdateTime = now;
            if (this.points.length < 2) {
                this.frameId = requestAnimationFrame(this.renderStroke.bind(this));
                return;
            }
            const p1 = this.points[this.points.length - 2];
            const p2 = this.points[this.points.length - 1];
            const dx = p2.x - p1.x;
            const dy = p2.y - p1.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const speed = Math.min(Math.max(distance / (dt || 16), 0.2), 1);
            if (this.options.selectedTool === TOOLS.BRUSH) {
                this.ctx.globalAlpha = this.options.brushOpacity * (0.5 + speed * 0.5);
                this.ctx.lineWidth = this.options.brushSize;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                this.ctx.shadowColor = this.options.brushColor;
                this.ctx.shadowBlur = this.options.brushSize * this.options.brushSoftness;
                this.ctx.beginPath();
                this.ctx.moveTo(p1.x, p1.y);
                this.ctx.lineTo(p2.x, p2.y);
                this.ctx.stroke();
                this.ctx.shadowBlur = 0;
            } else if (this.options.selectedTool === TOOLS.PENCIL) {
                this.ctx.globalAlpha = 0.9;
                this.ctx.lineWidth = this.options.pencilSize;
                this.ctx.lineCap = 'butt';
                this.ctx.lineJoin = 'miter';
                this.ctx.shadowBlur = 0;
                this.ctx.beginPath();
                this.ctx.moveTo(p1.x, p1.y);
                this.ctx.lineTo(p2.x, p2.y);
                this.ctx.stroke();
                if (Math.random() > 0.7 && distance > 1) {
                    const spread = this.options.pencilSize * 0.8;
                    for (let i = 0; i < distance / 2; i++) {
                        this.ctx.beginPath();
                        this.ctx.globalAlpha = Math.random() * 0.3;
                        const rx = p1.x + dx * (i / distance) + (Math.random() - 0.5) * spread;
                        const ry = p1.y + dy * (i / distance) + (Math.random() - 0.5) * spread;
                        const size = Math.random() * 0.5;
                        this.ctx.arc(rx, ry, size, 0, Math.PI * 2);
                        this.ctx.fill();
                    }
                }
            } else if (this.options.selectedTool === TOOLS.ERASER) {
                this.ctx.globalAlpha = 1.0;
                this.ctx.lineWidth = this.options.brushSize;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                this.ctx.beginPath();
                this.ctx.moveTo(p1.x, p1.y);
                this.ctx.lineTo(p2.x, p2.y);
                this.ctx.stroke();
            }
            this.points.shift();
            if (this.points.length > 1 || this.isDrawing) {
                this.frameId = requestAnimationFrame(this.renderStroke.bind(this));
            } else {
                this.frameId = null;
            }
        }

        addPoint(x, y) {
            this.points.push({x, y, pressure: 1.0, time: Date.now()});
        }

        stopDrawing() {
            if (this.isDrawing) {
                this.isDrawing = false;
                if (this.frameId) {
                    cancelAnimationFrame(this.frameId);
                    this.frameId = null;
                }
                this.ctx.globalAlpha = 1.0;
                this.ctx.shadowBlur = 0;
                if ([TOOLS.LINE, TOOLS.RECTANGLE, TOOLS.CIRCLE, TOOLS.TEXT, TOOLS.FILL].includes(this.options.selectedTool)) {
                    this.saveToHistory();
                } else if (this.lastDrawTime && Date.now() - this.lastDrawTime > 300) {
                    this.saveToHistory();
                }
            }
        }

        getPointerPosition(e) {
            const rect = this.canvas.getBoundingClientRect();
            const scaleX = this.canvas.width / rect.width / this.options.zoomLevel;
            const scaleY = this.canvas.height / rect.height / this.options.zoomLevel;
            let clientX, clientY;
            if (e.type.includes('touch')) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            const x = (clientX - rect.left) * scaleX;
            const y = (clientY - rect.top) * scaleY;
            return {x, y};
        }

        drawLine(x1, y1, x2, y2) {
            this.updateToolSettings();
            this.ctx.beginPath();
            this.ctx.moveTo(x1, y1);
            this.ctx.lineTo(x2, y2);
            this.ctx.stroke();
        }

        drawRectangle(x1, y1, x2, y2) {
            this.updateToolSettings();
            this.ctx.beginPath();
            this.ctx.rect(Math.min(x1, x2), Math.min(y1, y2), Math.abs(x2 - x1), Math.abs(y2 - y1));
            this.ctx.stroke();
        }

        drawCircle(x1, y1, x2, y2) {
            this.updateToolSettings();
            const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
            this.ctx.beginPath();
            this.ctx.arc(x1, y1, radius, 0, Math.PI * 2);
            this.ctx.stroke();
        }

        drawText(text, x, y) {
            this.updateToolSettings();
            const fontSize = this.options.brushSize * 3;
            this.ctx.font = `${fontSize}px sans-serif`;
            this.ctx.fillStyle = this.options.brushColor;
            this.ctx.fillText(text, x, y);
        }

        fillArea(x, y) {
            const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            const targetColor = this.getPixelColor(imageData, x, y);
            const fillColor = this.hexToRgba(this.options.brushColor);
            if (this.colorEquals(targetColor, fillColor)) return;
            const pixelsToCheck = [{x, y}];
            const visited = new Set();
            while (pixelsToCheck.length > 0) {
                const currentPixel = pixelsToCheck.pop();
                const cx = currentPixel.x;
                const cy = currentPixel.y;
                const key = `${cx},${cy}`;
                if (visited.has(key)) continue;
                if (cx < 0 || cy < 0 || cx >= width || cy >= height) continue;
                const currentColor = this.getPixelColor(imageData, cx, cy);
                if (!this.colorEquals(currentColor, targetColor)) continue;
                this.setPixelColor(imageData, cx, cy, fillColor);
                visited.add(key);
                pixelsToCheck.push({x: cx + 1, y: cy});
                pixelsToCheck.push({x: cx - 1, y: cy});
                pixelsToCheck.push({x: cx, y: cy + 1});
                pixelsToCheck.push({x: cx, y: cy - 1});
            }
            this.ctx.putImageData(imageData, 0, 0);
        }

        getPixelColor(imageData, x, y) {
            const data = imageData.data;
            const index = (Math.floor(y) * imageData.width + Math.floor(x)) * 4;
            return {r: data[index], g: data[index + 1], b: data[index + 2], a: data[index + 3]};
        }

        setPixelColor(imageData, x, y, color) {
            const data = imageData.data;
            const index = (Math.floor(y) * imageData.width + Math.floor(x)) * 4;
            data[index] = color.r;
            data[index + 1] = color.g;
            data[index + 2] = color.b;
            data[index + 3] = color.a;
        }

        colorEquals(c1, c2) {
            const tolerance = 5;
            return Math.abs(c1.r - c2.r) <= tolerance && Math.abs(c1.g - c2.g) <= tolerance && Math.abs(c1.b - c2.b) <= tolerance && Math.abs(c1.a - c2.a) <= tolerance;
        }

        hexToRgba(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return {r, g, b, a: 255};
        }

        saveToHistory() {
            setTimeout(() => {
                if (this.historyIndex < this.history.length - 1) {
                    this.history = this.history.slice(0, this.historyIndex + 1);
                }
                this.history.push(this.canvas.toDataURL());
                if (this.history.length > this.options.maxHistoryStates) {
                    this.history.shift();
                }
                this.historyIndex = this.history.length - 1;
                this.updateUndoRedoButtons();
                this.lastDrawTime = Date.now();
            }, 0);
        }

        undo() {
            if (this.historyIndex > 0) {
                this.historyIndex--;
                this.loadFromHistory();
            }
        }

        redo() {
            if (this.historyIndex < this.history.length - 1) {
                this.historyIndex++;
                this.loadFromHistory();
            }
        }

        loadFromHistory() {
            const img = new Image();
            img.onload = () => {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.drawImage(img, 0, 0);
                this.updateUndoRedoButtons();
            };
            img.src = this.history[this.historyIndex];
        }

        updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            undoBtn.disabled = this.historyIndex <= 0;
            redoBtn.disabled = this.historyIndex >= this.history.length - 1;
            undoBtn.style.opacity = undoBtn.disabled ? 0.5 : 1;
            redoBtn.style.opacity = redoBtn.disabled ? 0.5 : 1;
        }

        updateToolSettings() {
            if (this.options.selectedTool === TOOLS.BRUSH) {
                this.ctx.globalAlpha = this.options.brushOpacity;
                this.ctx.lineWidth = this.options.brushSize;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                this.ctx.strokeStyle = this.options.brushColor;
                this.ctx.fillStyle = this.options.brushColor;
                this.ctx.globalCompositeOperation = 'source-over';
            } else if (this.options.selectedTool === TOOLS.PENCIL) {
                this.ctx.globalAlpha = 1.0;
                this.ctx.lineWidth = this.options.pencilSize;
                this.ctx.lineCap = 'butt';
                this.ctx.lineJoin = 'miter';
                this.ctx.strokeStyle = this.options.brushColor;
                this.ctx.fillStyle = this.options.brushColor;
                this.ctx.globalCompositeOperation = 'source-over';
            } else if (this.options.selectedTool === TOOLS.ERASER) {
                this.ctx.globalAlpha = 1.0;
                this.ctx.lineWidth = this.options.brushSize;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                this.ctx.globalCompositeOperation = 'destination-out';
            } else {
                this.ctx.globalAlpha = 1.0;
                this.ctx.lineWidth = this.options.brushSize;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                this.ctx.strokeStyle = this.options.brushColor;
                this.ctx.fillStyle = this.options.brushColor;
                this.ctx.globalCompositeOperation = 'source-over';
            }
        }

        setTool(tool) {
            document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.tool-btn[data-tool="${tool}"]`)?.classList.add('active');
            this.options.selectedTool = tool;
            this.updateToolSettings();
            const sizeInput = document.getElementById('size-input');
            if (tool === TOOLS.PENCIL) {
                sizeInput.value = this.options.pencilSize;
                document.getElementById('size-value').textContent = `${this.options.pencilSize}px`;
            } else {
                sizeInput.value = this.options.brushSize;
                document.getElementById('size-value').textContent = `${this.options.brushSize}px`;
            }
            this.updateBrushPreview();
        }

        showToolOptions(tool) {
        }

        clearCanvas() {
            if (confirm('Are you sure you want to clear the canvas? This action cannot be undone.')) {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.saveToHistory();
                this.showNotification('Canvas cleared', 'info');
            }
        }

        setBgColor(color, showPattern = false) {
            this.options.bgColor = color;
            this.options.isTransparent = color === 'transparent';
            this.options.showPattern = showPattern;
            if (this.options.isTransparent) {
                this.canvas.style.backgroundColor = 'transparent';
                if (showPattern) {
                    this.canvas.style.backgroundImage = 'linear-gradient(45deg,#ccc 25%,transparent 25%,transparent 75%,#ccc 75%,#ccc),linear-gradient(45deg,#ccc 25%,transparent 25%,transparent 75%,#ccc 75%,#ccc)';
                    this.canvas.style.backgroundSize = '16px 16px';
                    this.canvas.style.backgroundPosition = '0 0,8px 8px';
                } else {
                    this.canvas.style.backgroundImage = 'none';
                }
            } else {
                this.canvas.style.backgroundColor = color;
                this.canvas.style.backgroundImage = 'none';
            }
            this.showNotification('Background updated', 'success');
        }

        resizeCanvas(width, height, keepContent = true) {
            let imageData;
            if (keepContent) {
                imageData = this.canvas.toDataURL();
            }
            this.canvas.width = width;
            this.canvas.height = height;
            if (keepContent && imageData) {
                const img = new Image();
                img.onload = () => {
                    this.ctx.drawImage(img, 0, 0);
                    this.saveToHistory();
                };
                img.src = imageData;
            } else {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.saveToHistory();
            }
            this.updateToolSettings();
            this.showNotification('Canvas resized to ' + width + 'x' + height, 'success');
        }

        saveDrawing() {
            try {
                const link = document.createElement('a');
                link.href = this.canvas.toDataURL('image/png');
                link.download = 'doodle-studio-' + new Date().toISOString().slice(0, 10) + '.png';
                link.click();
                this.showNotification('Drawing saved successfully', 'success');
            } catch (error) {
                this.showNotification('Error saving drawing', 'error');
                console.error('Error saving drawing:', error);
            }
        }

        exportDrawing(format = 'png', quality = 0.9, filename = 'doodle-studio', includeBg = true) {
            try {
                const exportCanvas = document.createElement('canvas');
                exportCanvas.width = this.canvas.width;
                exportCanvas.height = this.canvas.height;
                const exportCtx = exportCanvas.getContext('2d');
                if (includeBg && !this.options.isTransparent) {
                    exportCtx.fillStyle = this.options.bgColor;
                    exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
                }
                exportCtx.drawImage(this.canvas, 0, 0);
                let dataURL;
                let extension;
                switch (format) {
                    case'jpeg':
                        dataURL = exportCanvas.toDataURL('image/jpeg', quality);
                        extension = 'jpg';
                        break;
                    case'webp':
                        dataURL = exportCanvas.toDataURL('image/webp', quality);
                        extension = 'webp';
                        break;
                    case'svg':
                        const svgData = this.canvasToSVG(exportCanvas);
                        dataURL = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgData);
                        extension = 'svg';
                        break;
                    default:
                        dataURL = exportCanvas.toDataURL('image/png');
                        extension = 'png';
                }
                const link = document.createElement('a');
                link.href = dataURL;
                link.download = `${filename}.${extension}`;
                link.click();
                this.showNotification(`Drawing exported as ${extension.toUpperCase()}`, 'success');
            } catch (error) {
                this.showNotification('Error exporting drawing', 'error');
                console.error('Error exporting drawing:', error);
            }
        }

        canvasToSVG(canvas) {
            const width = canvas.width;
            const height = canvas.height;
            let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">`;
            if (!this.options.isTransparent) {
                svg += `<rect width="${width}" height="${height}" fill="${this.options.bgColor}" />`;
            }
            svg += `<image width="${width}" height="${height}" xlink:href="${canvas.toDataURL('image/png')}" />`;
            svg += '</svg>';
            return svg;
        }

        loadDrawing() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            const resizeCanvas = img.width !== this.canvas.width || img.height !== this.canvas.height;
                            if (resizeCanvas && confirm(`The image size (${img.width}x${img.height}) is different from your canvas (${this.canvas.width}x${this.canvas.height}). Would you like to resize the canvas to match the image?`)) {
                                this.resizeCanvas(img.width, img.height, false);
                            }
                            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                            const x = Math.max(0, (this.canvas.width - img.width) / 2);
                            const y = Math.max(0, (this.canvas.height - img.height) / 2);
                            this.ctx.drawImage(img, x, y);
                            this.saveToHistory();
                            this.showNotification('Drawing loaded successfully', 'success');
                        };
                        img.src = event.target.result;
                    };
                    reader.onerror = () => {
                        this.showNotification('Error loading image', 'error');
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        zoom(delta) {
            const newZoom = Math.max(0.1, Math.min(5, this.options.zoomLevel + delta));
            if (newZoom !== this.options.zoomLevel) {
                this.options.zoomLevel = newZoom;
                this.updateZoom();
            }
        }

        resetZoom() {
            this.options.zoomLevel = 1;
            this.updateZoom();
        }

        updateZoom() {
            const wrapper = document.getElementById('canvas-wrapper');
            wrapper.style.transform = `scale(${this.options.zoomLevel})`;
            document.getElementById('zoom-value').textContent = `${Math.round(this.options.zoomLevel * 100)}%`;
        }

        toggleDialog(dialogId, show) {
            const dialog = document.getElementById(dialogId);
            if (show) {
                if (dialogId === 'bg-color-dialog') {
                    document.getElementById('bg-color-input').value = this.options.bgColor;
                    document.getElementById('bg-transparent').checked = this.options.isTransparent;
                    document.getElementById('bg-pattern').checked = this.options.showPattern;
                    document.getElementById('bg-color-preview').style.backgroundColor = this.options.isTransparent ? 'transparent' : this.options.bgColor;
                    if (this.options.showPattern && this.options.isTransparent) {
                        document.getElementById('bg-color-preview').style.backgroundImage = 'linear-gradient(45deg,#ccc 25%,transparent 25%,transparent 75%,#ccc 75%,#ccc),linear-gradient(45deg,#ccc 25%,transparent 25%,transparent 75%,#ccc 75%,#ccc)';
                        document.getElementById('bg-color-preview').style.backgroundSize = '16px 16px';
                        document.getElementById('bg-color-preview').style.backgroundPosition = '0 0,8px 8px';
                    } else {
                        document.getElementById('bg-color-preview').style.backgroundImage = 'none';
                    }
                } else if (dialogId === 'canvas-size-dialog') {
                    document.getElementById('canvas-width').value = this.canvas.width;
                    document.getElementById('canvas-height').value = this.canvas.height;
                }
                dialog.classList.add('open');
            } else {
                dialog.classList.remove('open');
            }
        }

        handleKeyDown(e) {
            if (document.activeElement === document.body || document.activeElement.tagName === 'BUTTON') {
                if (e.key === 'b' || e.key === 'B') this.setTool(TOOLS.BRUSH);
                if (e.key === 'p' || e.key === 'P') this.setTool(TOOLS.PENCIL);
                if (e.key === 'e' || e.key === 'E') this.setTool(TOOLS.ERASER);
                if (e.key === 'f' || e.key === 'F') this.setTool(TOOLS.FILL);
                if (e.key === 'l' || e.key === 'L') this.setTool(TOOLS.LINE);
                if (e.key === 'r' || e.key === 'R') this.setTool(TOOLS.RECTANGLE);
                if (e.key === 'c' || e.key === 'C') this.setTool(TOOLS.CIRCLE);
                if (e.key === 't' || e.key === 'T') this.setTool(TOOLS.TEXT);
                if (e.key === 'Delete') this.clearCanvas();
                if (e.key === 'Tab') {
                    e.preventDefault();
                    document.getElementById('sidebar').classList.toggle('expanded');
                }
                if (e.ctrlKey && (e.key === 'z' || e.key === 'Z')) {
                    e.preventDefault();
                    this.undo();
                }
                if (e.ctrlKey && (e.key === 'y' || e.key === 'Y')) {
                    e.preventDefault();
                    this.redo();
                }
                if (e.ctrlKey && (e.key === 's' || e.key === 'S')) {
                    e.preventDefault();
                    this.saveDrawing();
                }
                if (e.ctrlKey && (e.key === 'e' || e.key === 'E')) {
                    e.preventDefault();
                    this.toggleDialog('export-dialog', true);
                }
                if (e.ctrlKey && (e.key === 'o' || e.key === 'O')) {
                    e.preventDefault();
                    this.loadDrawing();
                }
                if (e.ctrlKey && e.key === '=') {
                    e.preventDefault();
                    this.zoom(0.1);
                }
                if (e.ctrlKey && e.key === '-') {
                    e.preventDefault();
                    this.zoom(-0.1);
                }
                if (e.ctrlKey && e.key === '0') {
                    e.preventDefault();
                    this.resetZoom();
                }
            }
        }

        handleResize() {
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.remove('expanded');
            }
        }

        updateBrushPreview() {
            const preview = document.getElementById('brush-preview');
            let size;
            if (this.options.selectedTool === TOOLS.PENCIL) {
                size = Math.min(this.options.pencilSize, 20);
            } else {
                size = Math.min(this.options.brushSize, 20);
            }
            preview.style.width = size + 'px';
            preview.style.height = size + 'px';
            if (this.options.selectedTool === TOOLS.ERASER) {
                preview.style.backgroundColor = '#FFF';
                preview.style.border = '1px solid #000';
                preview.style.backgroundImage = 'linear-gradient(45deg,#ccc 25%,transparent 25%,transparent 75%,#ccc 75%,#ccc),linear-gradient(45deg,#ccc 25%,transparent 25%,transparent 75%,#ccc 75%,#ccc)';
                preview.style.backgroundSize = '8px 8px';
                preview.style.backgroundPosition = '0 0,4px 4px';
                preview.style.boxShadow = 'none';
            } else if (this.options.selectedTool === TOOLS.PENCIL) {
                preview.style.backgroundColor = this.options.brushColor;
                preview.style.border = '1px solid var(--border)';
                preview.style.backgroundImage = 'none';
                preview.style.opacity = '1.0';
                preview.style.boxShadow = 'inset 0 0 1px rgba(0,0,0,0.7)';
                preview.style.backgroundImage = 'radial-gradient(circle, transparent 40%, rgba(0,0,0,0.1) 100%)';
            } else if (this.options.selectedTool === TOOLS.BRUSH) {
                preview.style.backgroundColor = this.options.brushColor;
                preview.style.border = 'none';
                preview.style.backgroundImage = 'none';
                preview.style.opacity = this.options.brushOpacity;
                preview.style.boxShadow = `0 0 ${size / 2}px ${this.options.brushColor}`;
                preview.style.borderRadius = '50%';
            } else {
                preview.style.backgroundColor = this.options.brushColor;
                preview.style.border = '1px solid var(--border)';
                preview.style.backgroundImage = 'none';
                preview.style.opacity = '1.0';
                preview.style.boxShadow = 'none';
            }
        }

        updateColorPalette() {
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.toggle('active', option.dataset.color === this.options.brushColor);
            });
        }

        showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        updateUI() {
            this.updateBrushPreview();
            this.updateColorPalette();
            this.updateUndoRedoButtons();
            if (this.options.selectedTool === TOOLS.PENCIL) {
                document.getElementById('size-value').textContent = `${this.options.pencilSize}px`;
                document.getElementById('size-input').value = this.options.pencilSize;
            } else {
                document.getElementById('size-value').textContent = `${this.options.brushSize}px`;
                document.getElementById('size-input').value = this.options.brushSize;
            }
            document.getElementById('color-input').value = this.options.brushColor;
            document.getElementById('zoom-value').textContent = `${Math.round(this.options.zoomLevel * 100)}%`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const app = new DoodleStudio();
    });
</script>
<script src="../logo.js"></script>
</body>
</html>