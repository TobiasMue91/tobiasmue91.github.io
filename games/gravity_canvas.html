<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Gravity Canvas</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#08080c;--surface:#12121a;--border:#252535;--text:#f0f0f5;--dim:#666680;--accent:#8b6fff}
@media(prefers-color-scheme:light){:root{--bg:#f5f5fa;--surface:#fff;--border:#ddd;--text:#1a1a2e;--dim:#888}}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:system-ui,sans-serif;display:flex;flex-direction:column}
header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--surface);border-bottom:1px solid var(--border)}
h1{font-size:1rem;font-weight:600}
.actions{display:flex;gap:8px}
.actions button{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:6px;cursor:pointer;font-size:0.8rem}
.actions button:hover{background:var(--accent);border-color:var(--accent);color:#fff}
main{flex:1;position:relative;overflow:hidden}
canvas{position:absolute;top:0;left:0;width:100%;height:100%;display:block}
.onboarding{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none;max-width:320px}
.onboarding h2{font-size:1.4rem;margin-bottom:16px;font-weight:500}
.onboarding .step{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:12px;opacity:0.9}
.onboarding .step.done{opacity:0.3}
.onboarding .num{display:inline-block;width:24px;height:24px;background:var(--accent);color:#fff;border-radius:50%;font-size:0.8rem;line-height:24px;margin-right:8px}
.onboarding p{font-size:0.9rem;color:var(--dim);margin-top:6px}
.onboarding.hidden{display:none}
.colors{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);display:flex;gap:8px;background:var(--surface);padding:10px 14px;border-radius:30px;border:1px solid var(--border)}
.colors div{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:transform 0.15s}
.colors div:hover,.colors div.active{transform:scale(1.2);border-color:var(--text)}
.info{position:absolute;top:12px;right:12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:0.75rem;color:var(--dim)}
.timeline{position:absolute;bottom:70px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 16px;display:none;align-items:center;gap:10px}
.timeline.visible{display:flex}
.timeline input{width:180px;accent-color:var(--accent)}
.timeline span{font-size:0.75rem;color:var(--dim);min-width:50px}
@media(max-width:500px){header{padding:10px 12px}h1{font-size:0.9rem}.onboarding{max-width:280px;padding:0 20px}.onboarding h2{font-size:1.2rem}.colors{bottom:12px;padding:8px 12px}.colors div{width:24px;height:24px}}
</style>
</head>
<body>
<header>
<h1>Gravity Canvas</h1>
<div class="actions">
<button id="btnTime">⏱ Time</button>
<button id="btnClear">✕ Clear</button>
<button id="btnSave">↓ Save</button>
</div>
</header>
<main>
<canvas id="c"></canvas>
<div class="onboarding" id="onboarding">
<h2>Paint with Gravity</h2>
<div class="step" id="step1"><span class="num">1</span>Tap to place a gravity well<p>It will pull particles toward it</p></div>
<div class="step" id="step2"><span class="num">2</span>Drag to launch particles<p>They'll orbit around your wells</p></div>
</div>
<div class="info" id="info">Wells: <strong id="numWells">0</strong> · Particles: <strong id="numParticles">0</strong></div>
<div class="colors" id="colors"></div>
<div class="timeline" id="timeline">
<span id="timeLabel">0s</span>
<input type="range" id="timeSlider" min="0" max="0" value="0">
<button id="btnPlay">▶</button>
</div>
</main>
<script>
const canvas=document.getElementById('c'),ctx=canvas.getContext('2d');
const colors=['#8b6fff','#00ddb5','#ff6b9d','#ffd93d','#4dc3ff','#ff8c42'];
let W,H,dpr=window.devicePixelRatio||1;
let wells=[],particles=[],history=[],historyIdx=0;
let color=0,paused=false,recording=true;
let drag=null,mouse={x:0,y:0};
let hasWell=false,hasParticle=false;

function resize(){
W=canvas.offsetWidth;H=canvas.offsetHeight;
canvas.width=W*dpr;canvas.height=H*dpr;
ctx.setTransform(dpr,0,0,dpr,0,0);
}
resize();
window.addEventListener('resize',resize);

// Colors
const colorsEl=document.getElementById('colors');
colors.forEach((c,i)=>{
const d=document.createElement('div');
d.style.background=c;
if(i===0)d.className='active';
d.onclick=()=>{
colorsEl.querySelectorAll('div').forEach(x=>x.classList.remove('active'));
d.classList.add('active');
color=i;
};
colorsEl.appendChild(d);
});

class Well{
constructor(x,y){this.x=x;this.y=y;this.mass=120;this.phase=Math.random()*6.28}
draw(){
this.phase+=0.04;
const r=14+Math.sin(this.phase)*2;
for(let i=3;i>=0;i--){
ctx.beginPath();
ctx.arc(this.x,this.y,r+i*12,0,6.28);
ctx.fillStyle=`rgba(139,111,255,${0.08-i*0.02})`;
ctx.fill();
}
ctx.beginPath();
ctx.arc(this.x,this.y,r,0,6.28);
ctx.fillStyle='rgba(160,140,255,0.8)';
ctx.fill();
ctx.beginPath();
ctx.arc(this.x,this.y,4,0,6.28);
ctx.fillStyle='#fff';
ctx.fill();
}
}

class Particle{
constructor(x,y,vx,vy,col){
this.x=x;this.y=y;this.vx=vx;this.vy=vy;this.col=col;
this.trail=[];this.alive=true;
}
update(dt){
if(!this.alive)return;
let ax=0,ay=0;
for(const w of wells){
const dx=w.x-this.x,dy=w.y-this.y;
const d=Math.sqrt(dx*dx+dy*dy);
if(d<16){this.alive=false;return}
const f=w.mass*60/(d*d);
ax+=f*dx/d;ay+=f*dy/d;
}
this.vx+=ax*dt;this.vy+=ay*dt;
const spd=Math.sqrt(this.vx*this.vx+this.vy*this.vy);
if(spd>600){this.vx*=600/spd;this.vy*=600/spd}
this.x+=this.vx*dt;this.y+=this.vy*dt;
this.trail.push({x:this.x,y:this.y,spd});
if(this.trail.length>60)this.trail.shift();
if(this.x<-50||this.x>W+50||this.y<-50||this.y>H+50)this.alive=false;
}
draw(){
if(this.trail.length<2)return;
for(let i=1;i<this.trail.length;i++){
const a=this.trail[i-1],b=this.trail[i];
const alpha=i/this.trail.length*0.7;
ctx.beginPath();
ctx.moveTo(a.x,a.y);
ctx.lineTo(b.x,b.y);
ctx.strokeStyle=this.col.replace(')',`,${alpha})`).replace('rgb','rgba');
ctx.lineWidth=2+Math.min(b.spd/200,3);
ctx.lineCap='round';
ctx.stroke();
}
ctx.beginPath();
ctx.arc(this.x,this.y,4,0,6.28);
ctx.fillStyle=this.col;
ctx.shadowColor=this.col;
ctx.shadowBlur=12;
ctx.fill();
ctx.shadowBlur=0;
}
}

function hexToRgb(hex){
const r=parseInt(hex.slice(1,3),16);
const g=parseInt(hex.slice(3,5),16);
const b=parseInt(hex.slice(5,7),16);
return`rgb(${r},${g},${b})`;
}

function addWell(x,y){
wells.push(new Well(x,y));
if(!hasWell){hasWell=true;document.getElementById('step1').classList.add('done')}
updateInfo();
checkOnboarding();
}

function shoot(x,y,vx,vy){
particles.push(new Particle(x,y,vx,vy,hexToRgb(colors[color])));
if(!hasParticle){hasParticle=true;document.getElementById('step2').classList.add('done')}
updateInfo();
checkOnboarding();
}

function checkOnboarding(){
if(hasWell&&hasParticle)document.getElementById('onboarding').classList.add('hidden');
}

function updateInfo(){
document.getElementById('numWells').textContent=wells.length;
document.getElementById('numParticles').textContent=particles.filter(p=>p.alive).length;
}

function saveState(){
if(!recording||paused)return;
const s={
wells:wells.map(w=>({x:w.x,y:w.y,mass:w.mass})),
particles:particles.filter(p=>p.alive).map(p=>({x:p.x,y:p.y,vx:p.vx,vy:p.vy,col:p.col,trail:p.trail.slice()}))
};
history.push(s);
if(history.length>600)history.shift();
historyIdx=history.length-1;
document.getElementById('timeSlider').max=historyIdx;
document.getElementById('timeSlider').value=historyIdx;
}

function loadState(idx){
if(idx<0||idx>=history.length)return;
const s=history[idx];
wells=s.wells.map(w=>Object.assign(new Well(w.x,w.y),w));
particles=s.particles.map(p=>{
const np=new Particle(p.x,p.y,p.vx,p.vy,p.col);
np.trail=p.trail.slice();
return np;
});
updateInfo();
}

let lastT=0;
function loop(t){
requestAnimationFrame(loop);
const dt=Math.min((t-lastT)/1000,0.03);
lastT=t;

ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--bg');
ctx.fillRect(0,0,W,H);

if(!paused){
for(const p of particles)p.update(dt);
particles=particles.filter(p=>p.alive||p.trail.length>0);
if(t%60<20)saveState();
}

for(const w of wells)w.draw();
for(const p of particles)p.draw();

if(drag){
ctx.beginPath();
ctx.moveTo(drag.x,drag.y);
ctx.lineTo(mouse.x,mouse.y);
ctx.strokeStyle='rgba(255,255,255,0.3)';
ctx.lineWidth=2;
ctx.setLineDash([6,6]);
ctx.stroke();
ctx.setLineDash([]);
ctx.beginPath();
ctx.arc(drag.x,drag.y,8,0,6.28);
ctx.fillStyle=colors[color];
ctx.shadowColor=colors[color];
ctx.shadowBlur=16;
ctx.fill();
ctx.shadowBlur=0;
}

updateInfo();
}
requestAnimationFrame(loop);

// Input handling
let touchStart=null,touchMoved=false;

canvas.addEventListener('mousedown',e=>{
const r=canvas.getBoundingClientRect();
const x=e.clientX-r.left,y=e.clientY-r.top;
drag={x,y};
mouse.x=x;mouse.y=y;
});

canvas.addEventListener('mousemove',e=>{
const r=canvas.getBoundingClientRect();
mouse.x=e.clientX-r.left;
mouse.y=e.clientY-r.top;
});

canvas.addEventListener('mouseup',e=>{
if(!drag)return;
const dx=drag.x-mouse.x,dy=drag.y-mouse.y;
const dist=Math.sqrt(dx*dx+dy*dy);
if(dist<10){
addWell(drag.x,drag.y);
}else{
shoot(drag.x,drag.y,dx*2.5,dy*2.5);
}
drag=null;
});

canvas.addEventListener('mouseleave',()=>{drag=null});

canvas.addEventListener('touchstart',e=>{
e.preventDefault();
const t=e.touches[0];
const r=canvas.getBoundingClientRect();
const x=t.clientX-r.left,y=t.clientY-r.top;
touchStart={x,y,time:Date.now()};
drag={x,y};
mouse.x=x;mouse.y=y;
touchMoved=false;
},{passive:false});

canvas.addEventListener('touchmove',e=>{
e.preventDefault();
const t=e.touches[0];
const r=canvas.getBoundingClientRect();
mouse.x=t.clientX-r.left;
mouse.y=t.clientY-r.top;
if(touchStart){
const dx=mouse.x-touchStart.x,dy=mouse.y-touchStart.y;
if(Math.sqrt(dx*dx+dy*dy)>10)touchMoved=true;
}
},{passive:false});

canvas.addEventListener('touchend',e=>{
e.preventDefault();
if(!drag)return;
const dx=drag.x-mouse.x,dy=drag.y-mouse.y;
const dist=Math.sqrt(dx*dx+dy*dy);
if(dist<10&&!touchMoved){
addWell(drag.x,drag.y);
}else if(dist>=10){
shoot(drag.x,drag.y,dx*2.5,dy*2.5);
}
drag=null;
touchStart=null;
},{passive:false});

// Buttons
document.getElementById('btnClear').onclick=()=>{
wells=[];particles=[];history=[];historyIdx=0;
hasWell=false;hasParticle=false;
document.getElementById('step1').classList.remove('done');
document.getElementById('step2').classList.remove('done');
document.getElementById('onboarding').classList.remove('hidden');
document.getElementById('timeSlider').max=0;
document.getElementById('timeSlider').value=0;
updateInfo();
};

document.getElementById('btnSave').onclick=()=>{
const link=document.createElement('a');
link.download='gravity-canvas.png';
link.href=canvas.toDataURL();
link.click();
};

document.getElementById('btnTime').onclick=()=>{
document.getElementById('timeline').classList.toggle('visible');
};

document.getElementById('timeSlider').oninput=e=>{
historyIdx=+e.target.value;
loadState(historyIdx);
recording=false;
paused=true;
document.getElementById('btnPlay').textContent='▶';
document.getElementById('timeLabel').textContent=Math.round(historyIdx/30)+'s';
};

document.getElementById('btnPlay').onclick=()=>{
paused=!paused;
document.getElementById('btnPlay').textContent=paused?'▶':'⏸';
if(!paused){
recording=true;
history=history.slice(0,historyIdx+1);
}
};

document.addEventListener('keydown',e=>{
if(e.code==='Space'){e.preventDefault();document.getElementById('btnPlay').click()}
if(e.key>='1'&&e.key<='6')colorsEl.children[+e.key-1]?.click();
});
</script>
</body>
</html>
