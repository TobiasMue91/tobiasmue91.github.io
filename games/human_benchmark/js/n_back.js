// N-BACK TEST - Working Memory
$(function(){
const LETTERS='BCDFGHJKLMNPQRSTVWXZ';
const TRIALS_PER_ROUND=20;
const MATCH_RATIO=0.3;
const ADVANCE_THRESHOLD=0.8;
const DEMOTE_THRESHOLD=0.5;
const LETTER_DURATION=2500;
const game={level:1,sequence:[],current:0,score:0,hits:0,misses:0,falseAlarms:0,correctRejects:0,responded:false,running:false,bestScore:null,timer:null};
const els={start:$('#start-n-back-test'),gameArea:$('#nb-game-area'),instructions:$('#nb-instructions'),letter:$('#nb-letter'),letterDisplay:$('#nb-letter-display'),matchBtn:$('#nb-match-btn'),feedback:$('#nb-feedback'),levelDisplay:$('#nb-level'),scoreDisplay:$('#nb-score'),bestDisplay:$('#nb-best'),progressBar:$('#nb-progress-bar')};
const loadBest=()=>{const scores=JSON.parse(localStorage.getItem('humanBenchmarkScores'))||{};game.bestScore=scores['N-Back'];if(game.bestScore)els.bestDisplay.text(game.bestScore);};
const updateUI=()=>{els.levelDisplay.text(game.level);els.scoreDisplay.text(game.score);};
const generateSequence=()=>{const seq=[];const matchCount=Math.floor(TRIALS_PER_ROUND*MATCH_RATIO);const matchPositions=new Set();while(matchPositions.size<matchCount){const pos=game.level+Math.floor(Math.random()*(TRIALS_PER_ROUND-game.level));matchPositions.add(pos);}for(let i=0;i<TRIALS_PER_ROUND;i++){if(matchPositions.has(i)&&i>=game.level){seq.push(seq[i-game.level]);}else{let letter;do{letter=LETTERS[Math.floor(Math.random()*LETTERS.length)];}while(i>=game.level&&letter===seq[i-game.level]);seq.push(letter);}}return seq;};
const isMatch=()=>game.current>=game.level&&game.sequence[game.current]===game.sequence[game.current-game.level];
const showFeedback=(text,type)=>{els.feedback.text(text).removeClass('text-green-400 text-red-400 text-yellow-400').addClass(type==='success'?'text-green-400':type==='error'?'text-red-400':'text-yellow-400');};
const handleResponse=()=>{if(!game.running||game.responded)return;game.responded=true;els.matchBtn.prop('disabled',true);if(isMatch()){game.hits++;game.score+=10*game.level;showFeedback('âœ“ Correct Match!','success');HB.playSound('success');}else{game.falseAlarms++;game.score=Math.max(0,game.score-5);showFeedback('âœ— Not a match','error');HB.playSound('fail');}updateUI();};
const nextTrial=()=>{if(game.current>=TRIALS_PER_ROUND-1){endRound();return;}game.current++;game.responded=false;els.feedback.text('');els.letter.text(game.sequence[game.current]);els.letterDisplay.removeClass('border-green-500 border-red-500 border-gray-600').addClass('border-blue-500');els.matchBtn.prop('disabled',false);els.progressBar.css('width',((game.current+1)/TRIALS_PER_ROUND*100)+'%');game.timer=setTimeout(()=>{if(!game.responded){if(isMatch()){game.misses++;game.score=Math.max(0,game.score-5);showFeedback('âœ— Missed match!','error');HB.playSound('fail');}else{game.correctRejects++;showFeedback('','success');}}els.letterDisplay.removeClass('border-blue-500').addClass(game.responded||!isMatch()?'border-gray-600':'border-red-500');els.matchBtn.prop('disabled',true);updateUI();setTimeout(nextTrial,500);},LETTER_DURATION);};
const endRound=()=>{game.running=false;clearTimeout(game.timer);els.matchBtn.prop('disabled',true);const total=game.hits+game.misses+game.falseAlarms+game.correctRejects;const accuracy=(game.hits+game.correctRejects)/total;const prevLevel=game.level;if(accuracy>=ADVANCE_THRESHOLD&&game.level<9){game.level++;HB.showToast(`Level Up! Now ${game.level}-Back ðŸŽ‰`,2000,'success');}else if(accuracy<DEMOTE_THRESHOLD&&game.level>1){game.level--;HB.showToast(`Level Down. Now ${game.level}-Back`,2000,'error');}else{HB.showToast(`Round complete! Accuracy: ${Math.round(accuracy*100)}%`,2000,'info');}updateUI();setTimeout(()=>{if(game.level>=3){checkGameOver();}else{startRound();}},2500);};
const checkGameOver=()=>{const finalScore=game.score;const isNewRecord=saveScore('N-Back',finalScore);if(isNewRecord)game.bestScore=finalScore;HB.showModal({title:isNewRecord?'ðŸŽ‰ New Personal Best!':'Great Performance!',message:`<div class="text-left"><p class="mb-2">Final Score: <strong>${finalScore}</strong></p><p class="mb-2">Max N-Level: <strong>${game.level}-Back</strong></p><p class="text-sm text-gray-400">The N-Back test measures working memory - the ability to hold and manipulate information.</p></div>`,score:finalScore,isNewRecord,onRetry:reset,onHome:HB.goHome,icon:'ðŸ§ '});};
const startRound=()=>{game.sequence=generateSequence();game.current=-1;game.hits=0;game.misses=0;game.falseAlarms=0;game.correctRejects=0;game.running=true;els.progressBar.css('width','0%');els.feedback.text('');els.letter.text('?');updateUI();HB.showToast(`${game.level}-Back: Match letters from ${game.level} step${game.level>1?'s':''} ago`,2500,'info');setTimeout(nextTrial,3000);};
const reset=()=>{clearTimeout(game.timer);game.level=1;game.score=0;game.running=false;els.start.show();els.gameArea.addClass('hidden');els.instructions.show();els.letter.text('?');els.feedback.text('');els.progressBar.css('width','0%');els.letterDisplay.removeClass('border-blue-500 border-green-500 border-red-500').addClass('border-gray-600');loadBest();updateUI();};
els.matchBtn.on('click',handleResponse);
$(document).on('keydown',function(e){if((e.code==='Space'||e.key.toLowerCase()==='m')&&game.running&&!game.responded){e.preventDefault();handleResponse();}});
els.start.on('click',()=>{els.start.hide();els.instructions.hide();els.gameArea.removeClass('hidden');startRound();});
loadBest();updateUI();
});
