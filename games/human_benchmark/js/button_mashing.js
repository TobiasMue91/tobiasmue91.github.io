// BUTTON MASHING TEST - ENHANCED
$(function(){
if(!window.HB){console.error('HB utilities not loaded');return;}
const game={presses:0,startTime:null,interval:null,mashedButton:'',mouseDown:false,keyDown:false,cooldown:false,bestScore:null};
const els={gameArea:$('#bm-game-area'),instruction:$('#bm-instruction'),counter:$('#bm-counter'),countDisplay:$('#bm-count'),timerDisplay:$('#bm-timer'),bestDisplay:$('#bm-best')};
const loadBest=()=>{const scores=JSON.parse(localStorage.getItem('humanBenchmarkScores'))||{};game.bestScore=scores['Button Mashing'];if(game.bestScore)els.bestDisplay.text(game.bestScore);};
const updateUI=()=>{els.countDisplay.text(game.presses);els.counter.text(game.presses);};
const updateTimer=()=>{if(!game.startTime)return;const elapsed=(Date.now()-game.startTime)/1000;const remaining=Math.max(10-elapsed,0);els.timerDisplay.text(remaining.toFixed(2)+'s');if(remaining<=0)gameOver();};
const gameOver=()=>{if(game.interval)clearInterval(game.interval);game.interval=null;const pressesPerMin=Math.round((game.presses/10)*60);const isNewRecord=saveScore('Button Mashing',game.presses);if(isNewRecord)game.bestScore=game.presses;HB.showModal({title:isNewRecord?'ðŸŽ‰ New Personal Best!':'Test Complete',message:`You mashed <strong>${game.presses} times</strong> in 10 seconds!<br>That's ${pressesPerMin} presses per minute using <strong>${game.mashedButton||'unknown input'}</strong>!${game.presses>=100?'<br>ðŸ† Speed demon!':''}`,score:`${game.presses} presses`,isNewRecord,onRetry:reset,onHome:HB.goHome,icon:'ðŸ‘†'});game.cooldown=true;setTimeout(()=>{game.cooldown=false;els.instruction.text('Click or press any key to restart!');},3000);};
const reset=()=>{game.presses=0;game.startTime=null;game.mashedButton='';game.mouseDown=false;game.keyDown=false;if(game.interval)clearInterval(game.interval);game.interval=null;els.instruction.text('Click or press any key to start!');updateUI();els.timerDisplay.text('10.00s');loadBest();};
const start=()=>{if(game.cooldown||game.startTime)return;game.presses=0;game.mashedButton='';updateUI();game.startTime=Date.now();els.instruction.text('Mash as fast as you can!');game.interval=setInterval(updateTimer,50);};
els.gameArea.on('mousedown',e=>{if(!game.startTime&&!game.cooldown)start();game.mouseDown=true;}).on('mouseup',e=>{if(game.startTime&&game.mouseDown){if(!game.mashedButton)game.mashedButton='Mouse Click';if(game.mashedButton==='Mouse Click'){game.presses++;updateUI();HB.playSound('click');}}game.mouseDown=false;});
$(document).on('keydown',e=>{if(e.repeat||e.ctrlKey||e.metaKey||e.altKey)return;if(!game.startTime&&!game.cooldown)start();game.keyDown=true;}).on('keyup',e=>{if(game.startTime&&game.keyDown){if(!game.mashedButton)game.mashedButton=e.key.length===1?e.key.toUpperCase():`Key: ${e.key}`;if(e.key===game.mashedButton||e.key.toUpperCase()===game.mashedButton||`Key: ${e.key}`===game.mashedButton){game.presses++;updateUI();HB.playSound('click');}}game.keyDown=false;});
loadBest();updateUI();
});
