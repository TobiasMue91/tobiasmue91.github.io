<!DOCTYPE html>
<html>
<head>
    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <meta charset="UTF-8">
    <title>Who Wants to Be a Millionaire</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preload" href="img/background/wwtbambg.jpg" as="image">
    <link rel="preload" href="img/background/wwtbambg_md.jpg" as="image">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/json5/2.2.3/index.min.js"></script>
    <style>
        :root {
            --primary: #1565C0;
            --primary-light: #1E88E5;
            --primary-dark: #0D47A1;
            --gold: #FFB300;
            --gold-dark: #FF8F00;
            --success: #2E7D32;
            --danger: #C62828;
            --shadow: 0 8px 16px rgba(0, 0, 0, 0.3)
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000 url('img/background/wwtbambg.jpg') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            color: #fff
        }

        @media (max-width: 768px) {
            body {
                background-image: url('img/background/wwtbambg_md.jpg')
            }
        }

        .game-wrapper {
            display: flex;
            min-height: 100vh;
            padding: 20px;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            align-items: flex-start
        }

        .money-ladder {
            background: rgba(13, 71, 161, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            min-width: 200px;
            box-shadow: var(--shadow);
            border: 2px solid var(--gold);
            position: sticky;
            top: 20px
        }

        .money-ladder h3 {
            font-size: 18px;
            color: var(--gold);
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid var(--gold);
            padding-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px
        }

        .money-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin: 6px 0;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 700;
            transition: all .3s;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent
        }

        .money-item.current {
            background: var(--gold);
            color: #000;
            transform: scale(1.08);
            box-shadow: 0 0 20px rgba(255, 179, 0, 0.6);
            border-color: var(--gold-dark);
            animation: pulse 2s ease-in-out infinite
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 179, 0, 0.6)
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 179, 0, 0.9)
            }
        }

        .money-item.passed {
            background: rgba(30, 136, 229, 0.4);
            color: #90CAF9;
            border-color: rgba(30, 136, 229, 0.3)
        }

        .money-item.safety {
            border: 2px solid var(--gold);
            background: rgba(255, 179, 0, 0.2)
        }

        .money-item.safety.current {
            background: var(--gold);
            color: #000;
            border-color: var(--gold-dark)
        }

        .money-item .level {
            font-size: 14px;
            opacity: .8
        }

        .money-item .amount {
            font-weight: 800;
            font-size: 16px
        }

        .container {
            flex: 1;
            background: rgba(13, 71, 161, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 2px solid rgba(255, 179, 0, 0.3)
        }

        .header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            padding: 25px;
            text-align: center;
            color: #fff;
            border-bottom: 3px solid var(--gold);
            position: relative
        }

        .settings-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 179, 0, 0.2);
            border: 2px solid var(--gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all .3s
        }

        .settings-toggle:hover {
            background: var(--gold);
            transform: scale(1.1)
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            letter-spacing: 1px;
            color: var(--gold)
        }

        .header .subtitle {
            font-size: 15px;
            opacity: .95;
            color: #E3F2FD
        }

        .lifelines {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap
        }

        .lifeline-btn {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: #fff;
            border: 2px solid var(--gold);
            border-radius: 25px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            transition: all .3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .lifeline-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            border-color: #fff;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4)
        }

        .lifeline-btn:disabled {
            background: #546E7A;
            border-color: #78909C;
            cursor: not-allowed;
            opacity: .5;
            transform: none
        }

        .lifeline-btn:focus {
            outline: 2px solid #fff;
            outline-offset: 2px
        }

        .lifeline-btn span {
            font-size: 18px
        }

        .main {
            padding: 30px
        }

        .question-container {
            text-align: center;
            margin-bottom: 30px;
            min-height: 100px
        }

        .question-text {
            font-size: 22px;
            font-weight: 600;
            color: #fff;
            line-height: 1.6;
            padding: 25px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            border: 3px solid var(--gold);
            box-shadow: inset 0 0 20px rgba(255, 179, 0, 0.2);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8)
        }

        .options-grid {
            display: grid;
            grid-template-columns:repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px
        }

        .option {
            background: linear-gradient(135deg, rgba(30, 136, 229, 0.3), rgba(13, 71, 161, 0.3));
            border: 3px solid rgba(255, 179, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all .3s;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            position: relative
        }

        .option:hover:not(.disabled):not(.eliminated) {
            background: linear-gradient(135deg, rgba(255, 179, 0, 0.4), rgba(255, 143, 0, 0.4));
            border-color: var(--gold);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4)
        }

        .option:focus {
            outline: 2px solid #fff;
            outline-offset: 2px
        }

        .option.selected {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            border-color: #fff;
            color: #000;
            text-shadow: none;
            box-shadow: 0 0 20px rgba(255, 179, 0, 0.8)
        }

        .option.correct {
            background: linear-gradient(135deg, #43A047, var(--success));
            color: #fff;
            border-color: #66BB6A;
            animation: correctAnswer .5s ease
        }

        @keyframes correctAnswer {
            0%, 100% {
                transform: scale(1)
            }
            50% {
                transform: scale(1.05)
            }
        }

        .option.incorrect {
            background: linear-gradient(135deg, #E53935, var(--danger));
            color: #fff;
            border-color: #EF5350;
            animation: shake .5s ease
        }

        @keyframes shake {
            0%, 100% {
                transform: translateX(0)
            }
            25% {
                transform: translateX(-10px)
            }
            75% {
                transform: translateX(10px)
            }
        }

        .option.eliminated {
            opacity: .25;
            cursor: not-allowed;
            text-decoration: line-through;
            filter: grayscale(1)
        }

        .option.disabled {
            cursor: not-allowed
        }

        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: #fff;
            border: 2px solid var(--gold);
            border-radius: 25px;
            padding: 14px 28px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: all .3s;
            text-transform: uppercase;
            letter-spacing: .5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3)
        }

        .btn:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            border-color: #fff;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4)
        }

        .btn:focus {
            outline: 2px solid #fff;
            outline-offset: 2px
        }

        .btn:disabled {
            background: #546E7A;
            border-color: #78909C;
            cursor: not-allowed;
            opacity: .5
        }

        .btn-secondary {
            background: linear-gradient(135deg, #546E7A, #37474F)
        }

        .btn-secondary:hover:not(:disabled) {
            background: linear-gradient(135deg, #78909C, #546E7A)
        }

        .result-box {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            margin-top: 25px;
            border: 2px solid var(--gold);
            box-shadow: 0 0 30px rgba(255, 179, 0, 0.3)
        }

        .result-message {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 15px;
            color: var(--gold);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8)
        }

        .result-score {
            font-size: 40px;
            font-weight: 800;
            color: var(--gold);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8)
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px)
        }

        .modal.active {
            display: flex
        }

        .modal-content {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            border-radius: 15px;
            padding: 35px;
            max-width: 550px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
            border: 3px solid var(--gold);
            max-height: 90vh;
            overflow-y: auto
        }

        .modal-header {
            font-size: 28px;
            font-weight: 800;
            color: var(--gold);
            margin-bottom: 25px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5)
        }

        .modal-body {
            margin-bottom: 25px;
            color: #E3F2FD
        }

        .modal-body p {
            font-size: 16px;
            margin-bottom: 15px
        }

        .audience-bars {
            margin-top: 20px
        }

        .audience-bar {
            margin: 12px 0
        }

        .audience-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-weight: 700;
            color: #fff
        }

        .audience-bar-fill {
            height: 35px;
            background: linear-gradient(90deg, var(--gold-dark), var(--gold));
            border-radius: 8px;
            transition: width .8s ease;
            display: flex;
            align-items: center;
            padding-left: 15px;
            color: #000;
            font-weight: 800;
            font-size: 16px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3)
        }

        .friend-suggestion {
            background: rgba(255, 179, 0, 0.2);
            border-left: 4px solid var(--gold);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid var(--gold)
        }

        .friend-suggestion strong {
            color: var(--gold);
            font-size: 20px;
            display: block;
            margin-bottom: 10px
        }

        .friend-confidence {
            margin-top: 12px;
            font-size: 15px;
            color: #E3F2FD;
            font-style: italic
        }

        .settings-panel {
            padding: 25px
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 2px solid rgba(255, 179, 0, 0.3)
        }

        .settings-item label {
            color: #E3F2FD;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            cursor: pointer;
            transition: all .3s;
            border: 2px solid var(--gold)
        }

        .toggle-switch.active {
            background: var(--gold)
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            transition: all .3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3)
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(30px)
        }

        .setup-form {
            padding: 30px
        }

        .form-group {
            margin-bottom: 25px
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: var(--gold);
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--gold);
            border-radius: 8px;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-weight: 600
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.5)
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #fff;
            box-shadow: 0 0 15px rgba(255, 179, 0, 0.5)
        }

        .loading {
            text-align: center;
            padding: 50px
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 179, 0, 0.3);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .loading p {
            color: #E3F2FD;
            font-size: 18px;
            font-weight: 600
        }

        .error-message {
            background: rgba(198, 40, 40, 0.2);
            border: 2px solid var(--danger);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            color: #fff;
            text-align: center
        }

        .error-message strong {
            display: block;
            font-size: 20px;
            margin-bottom: 10px
        }

        .hidden {
            display: none !important
        }

        .about {
            margin: 50px auto;
            max-width: 800px;
            text-align: center;
            color: #fff;
            text-shadow: 0 0 5px rgba(0, 0, 0, 1)
        }

        .about h2 {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--gold)
        }

        .about p {
            font-size: 18px;
            line-height: 1.5;
            margin-bottom: 20px
        }

        @media (max-width: 768px) {
            .game-wrapper {
                flex-direction: column
            }

            .money-ladder {
                position: static;
                min-width: auto;
                max-width: 100%
            }

            .options-grid {
                grid-template-columns:1fr
            }

            .header h1 {
                font-size: 24px
            }

            .money-item .amount {
                font-size: 14px
            }

            .settings-toggle {
                width: 35px;
                height: 35px;
                font-size: 18px
            }
        }
    </style>
</head>
<body>
<div class="game-wrapper">
    <div class="money-ladder">
        <h3>üí∞ Prize Ladder</h3>
        <div id="moneyLadderItems"></div>
    </div>
    <div class="container">
        <div class="header">
            <button class="settings-toggle" id="settingsBtn" title="Settings" aria-label="Settings">‚öôÔ∏è</button>
            <h1>üíé WHO WANTS TO BE A MILLIONAIRE</h1>
            <p class="subtitle" id="gameInfo">Select your preferences and start playing!</p>
            <div class="lifelines hidden" id="lifelinesContainer">
                <button class="lifeline-btn" id="fiftyFifty" title="Remove two incorrect answers" tabindex="0">
                    <span>üéØ</span>50:50
                </button>
                <button class="lifeline-btn" id="askAudience" title="Poll the audience" tabindex="0"><span>üë•</span>Ask
                    Audience
                </button>
                <button class="lifeline-btn" id="phoneFriend" title="Call a friend for help" tabindex="0"><span>üìû</span>Phone
                    Friend
                </button>
            </div>
        </div>
        <div class="main">
            <div id="setupScreen">
                <div class="setup-form">
                    <div class="form-group">
                        <label for="topic">Topic (Optional):</label>
                        <input type="text" id="topic" placeholder="e.g., Science, History, Movies..."
                               aria-label="Game topic">
                    </div>
                    <div class="form-group">
                        <label for="difficulty">Difficulty:</label>
                        <select id="difficulty" aria-label="Game difficulty">
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                            <option value="expert">Expert</option>
                        </select>
                    </div>
                    <div class="controls">
                        <button class="btn" id="startBtn">Start Game</button>
                    </div>
                </div>
            </div>
            <div id="gameScreen" class="hidden">
                <div class="question-container">
                    <div class="question-text" id="questionText" role="heading" aria-level="2">Loading question...</div>
                </div>
                <div class="options-grid" id="optionsContainer" role="radiogroup" aria-label="Answer options"></div>
                <div class="controls">
                    <button class="btn btn-secondary hidden" id="confirmBtn">Final Answer?</button>
                    <button class="btn hidden" id="nextBtn">Next Question</button>
                    <button class="btn btn-secondary" id="walkAwayBtn">Walk Away</button>
                    <button class="btn" id="finishBtn">Finish Game</button>
                </div>
                <div class="result-box hidden" id="resultBox">
                    <div class="result-message" id="resultMessage"></div>
                    <div class="result-score" id="resultScore"></div>
                </div>
            </div>
            <div id="loadingScreen" class="loading hidden">
                <div class="loading-spinner"></div>
                <p>Generating questions... This may take up to 30 seconds.</p>
                <p style="font-size:14px;opacity:.8;margin-top:10px">Tip: Questions are AI-generated and may vary in
                    quality</p>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">‚öôÔ∏è Settings</div>
        <div class="modal-body">
            <div class="settings-panel">
                <div class="settings-item">
                    <label for="soundToggle">
                        <span>üîä</span>
                        <span>Sound Effects</span>
                    </label>
                    <div class="toggle-switch" id="soundToggle" role="switch" aria-checked="true" tabindex="0">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <p style="font-size:14px;color:#B0BEC5;text-align:center;margin-top:20px">
                    Keyboard shortcuts: 1-4 to select answers, Enter to confirm
                </p>
            </div>
        </div>
        <div class="controls">
            <button class="btn" onclick="closeModal('settingsModal')">Close</button>
        </div>
    </div>
</div>
<div class="modal" id="audienceModal">
    <div class="modal-content">
        <div class="modal-header">üë• Ask the Audience</div>
        <div class="modal-body">
            <p>Here's what the audience thinks:</p>
            <div class="audience-bars" id="audienceBars"></div>
        </div>
        <div class="controls">
            <button class="btn" onclick="closeModal('audienceModal')">Close</button>
        </div>
    </div>
</div>
<div class="modal" id="friendModal">
    <div class="modal-content">
        <div class="modal-header">üìû Phone a Friend</div>
        <div class="modal-body">
            <p>Calling your friend...</p>
            <div class="friend-suggestion" id="friendSuggestion"></div>
        </div>
        <div class="controls">
            <button class="btn" onclick="closeModal('friendModal')">Close</button>
        </div>
    </div>
</div>
<div class="about">
    <h2>About Who Wants to Be a Millionaire</h2>
    <p>Test your knowledge and win imaginary cash prizes! This game features AI-generated questions across various
        topics and difficulty levels.</p>
    <p>Use your three lifelines wisely: 50:50 eliminates two wrong answers, Ask the Audience shows you what others
        think, and Phone a Friend gives you expert advice.</p>
    <p>Good luck, and may you reach that million-dollar question!</p>
</div>
<script src="js/fireworks.js"></script>
<script>
    const earnings = [0, 100, 200, 300, 500, 1000, 2000, 4000, 8000, 16000, 32000, 64000, 125000, 250000, 500000, 1000000];
    const safetyNets = [5, 10];
    let gameState = {
        questions: [],
        currentQ: 0,
        score: 0,
        selectedAnswer: null,
        lifelines: {fiftyFifty: true, askAudience: true, phoneFriend: true},
        topic: '',
        difficulty: 'easy',
        acceptingAnswers: false
    };
    const apiUrl = 'https://chatgpt.tobiasmue91.workers.dev/';

    class SoundManager {
        constructor() {
            this.audioCtx = null;
            this.enabled = localStorage.getItem('soundEnabled') !== 'false'
        }

        init() {
            if (!this.audioCtx) {
                try {
                    this.audioCtx = new (window.AudioContext || window.webkitAudioContext)()
                } catch (e) {
                    console.warn('Audio not supported', e)
                }
            }
        }

        toggle() {
            this.enabled = !this.enabled;
            localStorage.setItem('soundEnabled', this.enabled);
            return this.enabled
        }

        isEnabled() {
            return this.enabled
        }

        play(type) {
            if (!this.enabled) return;
            this.init();
            if (!this.audioCtx) return;
            const now = this.audioCtx.currentTime;
            try {
                if (type === 'select') {
                    this.tone(300, .05, now, 'sine', .3)
                } else if (type === 'correct') {
                    const frequencies = [523, 659, 784, 1047];
                    frequencies.forEach((freq, i) => {
                        this.tone(freq, .15, now + i * .1, 'sine', .4)
                    })
                } else if (type === 'wrong') {
                    this.tone(200, .3, now, 'sawtooth', .5);
                    this.tone(150, .3, now + .1, 'sawtooth', .5)
                } else if (type === 'lifeline') {
                    this.tone(800, .1, now, 'square', .3);
                    this.tone(1000, .1, now + .1, 'square', .3)
                } else if (type === 'final') {
                    this.tone(400, .2, now, 'sine', .4);
                    this.tone(500, .2, now + .2, 'sine', .4)
                } else if (type === 'win') {
                    [523, 659, 784, 1047, 1319].forEach((f, i) => {
                        this.tone(f, .2, now + i * .15, 'sine', .5)
                    })
                }
            } catch (e) {
                console.warn('Sound playback error', e)
            }
        }

        tone(freq, dur, time, type = 'sine', vol = .3) {
            try {
                const osc = this.audioCtx.createOscillator();
                const gain = this.audioCtx.createGain();
                osc.connect(gain);
                gain.connect(this.audioCtx.destination);
                osc.frequency.value = freq;
                osc.type = type;
                gain.gain.setValueAtTime(vol, time);
                gain.gain.exponentialRampToValueAtTime(.01, time + dur);
                osc.start(time);
                osc.stop(time + dur)
            } catch (e) {
                console.warn('Tone generation error', e)
            }
        }
    }

    const sound = new SoundManager();

    function initMoneyLadder() {
        const container = document.getElementById('moneyLadderItems');
        container.innerHTML = '';
        earnings.slice(1).reverse().forEach((amount, idx) => {
            const level = 15 - idx;
            const div = document.createElement('div');
            div.className = 'money-item';
            div.setAttribute('role', 'listitem');
            if (safetyNets.includes(level)) div.classList.add('safety');
            div.innerHTML = `<span class="level">${level}</span><span class="amount">$${amount.toLocaleString()}</span>`;
            div.id = `money-${level}`;
            container.appendChild(div)
        })
    }

    function updateMoneyLadder() {
        document.querySelectorAll('.money-item').forEach(item => {
            item.classList.remove('current', 'passed')
        });
        const currentLevel = gameState.currentQ + 1;
        for (let i = 1; i < currentLevel; i++) {
            const item = document.getElementById(`money-${i}`);
            if (item) item.classList.add('passed')
        }
        const currentItem = document.getElementById(`money-${currentLevel}`);
        if (currentItem) {
            currentItem.classList.add('current');
            currentItem.setAttribute('aria-current', 'true')
        }
    }

    function showScreen(screen) {
        ['setupScreen', 'gameScreen', 'loadingScreen'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(screen).classList.remove('hidden')
    }

    function showError(message) {
        const screen = document.getElementById('setupScreen');
        const existing = screen.querySelector('.error-message');
        if (existing) existing.remove();
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.innerHTML = `<strong>‚ö†Ô∏è Error</strong><p>${message}</p>`;
        screen.querySelector('.setup-form').prepend(errorDiv);
        setTimeout(() => errorDiv.remove(), 10000)
    }

    async function startGame() {
        const topicInput = document.getElementById('topic');
        const difficultyInput = document.getElementById('difficulty');
        if (!topicInput || !difficultyInput) return;
        gameState.topic = topicInput.value.trim() || 'random';
        gameState.difficulty = difficultyInput.value;
        showScreen('loadingScreen');
        try {
            const requestData = {
                model: "gpt-4o-mini",
                max_tokens: 2048,
                messages: [{
                    role: "assistant",
                    content: `I am now an API for "Who wants to be a Millionaire?". I will respond in JSON format with exactly 15 questions, 4 answers each (only one correct), sorted easiest to hardest. Format: {"questions":[{"question":"Q?","answers":["A1","A2","A3","A4"],"correct_answer":"A2"},...]}. Topic: "${gameState.topic}". Difficulty: "${gameState.difficulty}". I only use questions I know factual answers to. The correct_answer must be exactly one of the four answers provided.`
                }, {role: "user", content: "OCK!"}]
            };
            const res = await fetch(apiUrl, {
                method: 'POST',
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(requestData)
            });
            if (!res.ok) throw new Error(`API error: ${res.status}`);
            const data = await res.json();
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                throw new Error('Invalid API response format')
            }
            const content = data.choices[0].message.content;
            const jsonStr = content.substring(content.indexOf("{"), content.lastIndexOf("}") + 1);
            const jsonData = JSON5.parse(jsonStr);
            if (!jsonData.questions || !Array.isArray(jsonData.questions) || jsonData.questions.length < 15) {
                throw new Error('Invalid questions format or insufficient questions')
            }
            gameState.questions = jsonData.questions.slice(0, 15).map(q => {
                if (!q.question || !q.answers || !q.correct_answer) {
                    throw new Error('Incomplete question data')
                }
                return {
                    question: q.question.replace(/"/g, '').trim(),
                    answers: q.answers.map(a => String(a).replace(/"/g, '').trim()),
                    correct_answer: String(q.correct_answer).replace(/"/g, '').trim(),
                    eliminated: []
                }
            });
            gameState.currentQ = 0;
            gameState.score = 0;
            gameState.lifelines = {fiftyFifty: true, askAudience: true, phoneFriend: true};
            document.querySelectorAll('.lifeline-btn').forEach(btn => btn.disabled = false);
            document.getElementById('gameInfo').textContent = `${gameState.difficulty.toUpperCase()} | ${gameState.topic === 'random' ? 'Random Topics' : gameState.topic}`;
            document.getElementById('lifelinesContainer').classList.remove('hidden');
            showScreen('gameScreen');
            loadQuestion()
        } catch (e) {
            console.error('Game start error:', e);
            showScreen('setupScreen');
            showError(e.message || 'Failed to generate questions. Please check your connection and try again.')
        }
    }

    function loadQuestion() {
        if (gameState.currentQ >= gameState.questions.length) {
            endGame();
            return
        }
        gameState.selectedAnswer = null;
        gameState.acceptingAnswers = true;
        const q = gameState.questions[gameState.currentQ];
        if (!q || !q.answers) {
            console.error('Invalid question data');
            endGame();
            return
        }
        document.getElementById('questionText').textContent = `Question ${gameState.currentQ + 1} of 15: ${q.question}`;
        const container = document.getElementById('optionsContainer');
        container.innerHTML = '';
        q.answers.forEach((ans, idx) => {
            const div = document.createElement('div');
            div.className = 'option';
            div.setAttribute('role', 'radio');
            div.setAttribute('aria-checked', 'false');
            div.setAttribute('tabindex', '0');
            if (q.eliminated.includes(idx)) div.classList.add('eliminated');
            div.textContent = ans;
            div.onclick = () => selectAnswer(idx);
            div.onkeydown = (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    selectAnswer(idx)
                }
            };
            container.appendChild(div)
        });
        document.getElementById('resultBox').classList.add('hidden');
        document.getElementById('nextBtn').classList.add('hidden');
        document.getElementById('confirmBtn').classList.add('hidden');
        updateMoneyLadder()
    }

    function selectAnswer(idx) {
        if (!gameState.acceptingAnswers) return;
        const q = gameState.questions[gameState.currentQ];
        if (!q || q.eliminated.includes(idx)) return;
        sound.play('select');
        document.querySelectorAll('.option').forEach(o => {
            o.classList.remove('selected');
            o.setAttribute('aria-checked', 'false')
        });
        const selectedOption = document.querySelectorAll('.option')[idx];
        if (selectedOption) {
            selectedOption.classList.add('selected');
            selectedOption.setAttribute('aria-checked', 'true')
        }
        gameState.selectedAnswer = idx;
        document.getElementById('confirmBtn').classList.remove('hidden')
    }

    function confirmAnswer() {
        if (gameState.selectedAnswer === null) return;
        sound.play('final');
        gameState.acceptingAnswers = false;
        const q = gameState.questions[gameState.currentQ];
        const selectedText = q.answers[gameState.selectedAnswer];
        const isCorrect = selectedText === q.correct_answer;
        const correctIdx = q.answers.indexOf(q.correct_answer);
        document.querySelectorAll('.option').forEach((o, i) => {
            o.classList.add('disabled');
            o.setAttribute('tabindex', '-1');
            if (i === correctIdx) o.classList.add('correct');
            if (i === gameState.selectedAnswer && !isCorrect) o.classList.add('incorrect')
        });
        document.getElementById('confirmBtn').classList.add('hidden');
        document.getElementById('walkAwayBtn').classList.add('hidden');
        if (isCorrect) {
            sound.play('correct');
            gameState.score = earnings[gameState.currentQ + 1];
            document.getElementById('resultMessage').textContent = '‚úì Correct!';
            document.getElementById('resultScore').textContent = `$${gameState.score.toLocaleString()}`;
            document.getElementById('resultBox').classList.remove('hidden');
            if (gameState.currentQ === 14) {
                sound.play('win');
                if (window.playFirework) playFirework();
                document.getElementById('resultMessage').textContent = 'üéâ CONGRATULATIONS! YOU WON!';
                setTimeout(() => endGame(), 3000)
            } else {
                document.getElementById('nextBtn').classList.remove('hidden')
            }
        } else {
            sound.play('wrong');
            const lastSafety = safetyNets.filter(s => s <= gameState.currentQ).pop();
            gameState.score = lastSafety ? earnings[lastSafety] : 0;
            document.getElementById('resultMessage').textContent = `‚úó Wrong! The correct answer was: ${q.correct_answer}`;
            document.getElementById('resultScore').textContent = `You leave with $${gameState.score.toLocaleString()}`;
            document.getElementById('resultBox').classList.remove('hidden');
            setTimeout(() => endGame(), 4000)
        }
    }

    function nextQuestion() {
        gameState.currentQ++;
        document.getElementById('walkAwayBtn').classList.remove('hidden');
        loadQuestion()
    }

    function walkAway() {
        if (confirm('Are you sure you want to walk away with your current winnings?')) {
            gameState.score = earnings[gameState.currentQ];
            document.getElementById('resultMessage').textContent = 'You chose to walk away!';
            document.getElementById('resultScore').textContent = `Final Winnings: $${gameState.score.toLocaleString()}`;
            document.getElementById('resultBox').classList.remove('hidden');
            gameState.acceptingAnswers = false;
            document.getElementById('walkAwayBtn').classList.add('hidden');
            document.getElementById('confirmBtn').classList.add('hidden');
            setTimeout(() => endGame(), 3000)
        }
    }

    function endGame() {
        showScreen('setupScreen');
        document.getElementById('lifelinesContainer').classList.add('hidden');
        gameState = {
            questions: [],
            currentQ: 0,
            score: 0,
            selectedAnswer: null,
            lifelines: {fiftyFifty: true, askAudience: true, phoneFriend: true},
            topic: '',
            difficulty: 'easy',
            acceptingAnswers: false
        };
        document.querySelectorAll('.lifeline-btn').forEach(btn => btn.disabled = false);
        initMoneyLadder()
    }

    function useFiftyFifty() {
        if (!gameState.lifelines.fiftyFifty || !gameState.acceptingAnswers) return;
        sound.play('lifeline');
        gameState.lifelines.fiftyFifty = false;
        document.getElementById('fiftyFifty').disabled = true;
        const q = gameState.questions[gameState.currentQ];
        const correctIdx = q.answers.indexOf(q.correct_answer);
        let incorrectIdxs = q.answers.map((a, i) => i).filter(i => i !== correctIdx && !q.eliminated.includes(i));
        if (incorrectIdxs.length >= 2) {
            incorrectIdxs = incorrectIdxs.sort(() => Math.random() - .5).slice(0, 2);
            q.eliminated.push(...incorrectIdxs);
            document.querySelectorAll('.option').forEach((o, i) => {
                if (incorrectIdxs.includes(i)) o.classList.add('eliminated')
            })
        }
    }

    function useAskAudience() {
        if (!gameState.lifelines.askAudience || !gameState.acceptingAnswers) return;
        sound.play('lifeline');
        gameState.lifelines.askAudience = false;
        document.getElementById('askAudience').disabled = true;
        const q = gameState.questions[gameState.currentQ];
        const correctIdx = q.answers.indexOf(q.correct_answer);
        const availableIdxs = q.answers.map((a, i) => i).filter(i => !q.eliminated.includes(i));
        let votes = new Array(4).fill(0);
        let remaining = 100;
        votes[correctIdx] = 50 + Math.floor(Math.random() * 30);
        remaining -= votes[correctIdx];
        availableIdxs.forEach(i => {
            if (i !== correctIdx) {
                const vote = Math.floor(Math.random() * (remaining / (availableIdxs.length - 1) + 10));
                votes[i] = Math.min(vote, remaining);
                remaining -= votes[i]
            }
        });
        if (remaining > 0) {
            votes[correctIdx] += remaining
        }
        const total = votes.reduce((a, b) => a + b, 0);
        votes = votes.map(v => Math.round((v / total) * 100));
        const bars = document.getElementById('audienceBars');
        bars.innerHTML = '';
        q.answers.forEach((ans, i) => {
            if (!q.eliminated.includes(i)) {
                bars.innerHTML += `<div class="audience-bar"><div class="audience-bar-label"><span>${ans}</span><span>${votes[i]}%</span></div><div class="audience-bar-fill" style="width:${votes[i]}%">${votes[i]}%</div></div>`
            }
        });
        document.getElementById('audienceModal').classList.add('active')
    }

    function usePhoneFriend() {
        if (!gameState.lifelines.phoneFriend || !gameState.acceptingAnswers) return;
        sound.play('lifeline');
        gameState.lifelines.phoneFriend = false;
        document.getElementById('phoneFriend').disabled = true;
        const q = gameState.questions[gameState.currentQ];
        const correctIdx = q.answers.indexOf(q.correct_answer);
        const availableIdxs = q.answers.map((a, i) => i).filter(i => !q.eliminated.includes(i));
        const confidence = Math.random() < 0.7 ? 'pretty sure' : 'not completely certain';
        const isCorrect = Math.random() < 0.75;
        const suggestionIdx = isCorrect ? correctIdx : availableIdxs[Math.floor(Math.random() * availableIdxs.length)];
        const suggestion = q.answers[suggestionIdx];
        const confidenceLevel = isCorrect && Math.random() < 0.8 ? 'High' : 'Medium';
        document.getElementById('friendSuggestion').innerHTML = `<strong>"I'm ${confidence} the answer is: ${suggestion}"</strong><div class="friend-confidence">Your friend's confidence level: ${confidenceLevel}</div>`;
        document.getElementById('friendModal').classList.add('active')
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) modal.classList.remove('active')
    }

    function toggleSettings() {
        document.getElementById('settingsModal').classList.add('active')
    }

    function toggleSound() {
        const isEnabled = sound.toggle();
        const toggle = document.getElementById('soundToggle');
        toggle.classList.toggle('active', isEnabled);
        toggle.setAttribute('aria-checked', isEnabled);
        if (isEnabled) sound.play('select')
    }

    function initSettings() {
        const toggle = document.getElementById('soundToggle');
        toggle.classList.toggle('active', sound.isEnabled());
        toggle.setAttribute('aria-checked', sound.isEnabled());
        toggle.onclick = toggleSound;
        toggle.onkeydown = (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggleSound()
            }
        }
    }

    document.getElementById('startBtn').onclick = startGame;
    document.getElementById('nextBtn').onclick = nextQuestion;
    document.getElementById('confirmBtn').onclick = confirmAnswer;
    document.getElementById('walkAwayBtn').onclick = walkAway;
    document.getElementById('finishBtn').onclick = endGame;
    document.getElementById('fiftyFifty').onclick = useFiftyFifty;
    document.getElementById('askAudience').onclick = useAskAudience;
    document.getElementById('phoneFriend').onclick = usePhoneFriend;
    document.getElementById('settingsBtn').onclick = toggleSettings;

    document.addEventListener('keydown', (e) => {
        if (!gameState.acceptingAnswers) return;
        if (e.key >= '1' && e.key <= '4') {
            const idx = parseInt(e.key) - 1;
            if (idx < 4) selectAnswer(idx)
        } else if (e.key === 'Enter' && gameState.selectedAnswer !== null) {
            confirmAnswer()
        }
    });

    initMoneyLadder();
    initSettings();
</script>
<script type="module">
    import {db} from '../firebase.js';
    import {doc, setDoc, getDoc} from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

    window.saveQuestions = async () => {
        try {
            const id = Date.now().toString();
            await setDoc(doc(db, "wwtbam_questions", id), {
                questions: gameState.questions,
                difficulty: gameState.difficulty,
                topic: gameState.topic
            });
            alert('Questions saved! ID: ' + id)
        } catch (e) {
            console.error(e);
            alert('Save failed: ' + e.message)
        }
    };
    window.addEventListener('load', async () => {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('questionsId');
        if (id) {
            try {
                const snap = await getDoc(doc(db, "wwtbam_questions", id));
                if (snap.exists()) {
                    const data = snap.data();
                    gameState.questions = data.questions;
                    gameState.difficulty = data.difficulty;
                    gameState.topic = data.topic;
                    document.getElementById('gameInfo').textContent = `${gameState.difficulty.toUpperCase()} | ${gameState.topic}`;
                    document.getElementById('lifelinesContainer').classList.remove('hidden');
                    showScreen('gameScreen');
                    loadQuestion()
                } else {
                    showError('Saved game not found. Please start a new game.')
                }
            } catch (e) {
                console.error(e);
                showError('Failed to load saved game: ' + e.message)
            }
        }
    });
</script>
<script src="../logo.js"></script>
</body>
</html>