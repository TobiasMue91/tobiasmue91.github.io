<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêç</text></svg>">
    <title>Snake Game</title>
    <meta name="keywords" content="Snake game,HTML,JavaScript,classic game,mobile-friendly,web game,game development"/>
    <meta name="description" content="Play the classic Snake game with this HTML and JavaScript code. Move the snake to eat the food, but be careful not to hit the wall or your tail."/>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4ade80;
            --secondary: #3b82f6;
            --accent: #f97316;
            --bg: #f8fafc;
            --text: #1e293b;
            --board: #e2e8f0;
            --food: #ef4444;
            --obstacle: #8b5cf6;
            --boardBorder: #60a5fa;
        }
        .dark-theme {
            --primary: #22c55e;
            --secondary: #3b82f6;
            --accent: #f97316;
            --bg: #0f172a;
            --text: #f1f5f9;
            --board: #1e293b;
            --food: #ef4444;
            --obstacle: #8b5cf6;
            --boardBorder: #3b82f6;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 15px;
        }
        .container {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }
        p {
            max-width: 600px;
            text-align: center;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.4;
        }
        .stats-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 15px;
        }
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
        .stat-value {
            font-weight: 600;
            font-size: 16px;
        }
        #game-container {
            position: relative;
            width: 300px;
            height: 300px;
        }
        #game-board {
            width: 100%;
            height: 100%;
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            background-color: var(--board);
            border: 2px solid var(--boardBorder);
            background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            transition: all 0.3s ease;
        }
        .game-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 5;
        }
        .game-controls button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: none;
            color: white;
            font-size: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .snake-unit {
            width: 10px;
            height: 10px;
            position: absolute;
            border-radius: 3px;
            transition: background-color 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .snake-unit.default { background-color: var(--primary); }
        .snake-unit.blue { background-color: var(--secondary); }
        .snake-unit.orange { background-color: var(--accent); }
        .snake-head {
            border-radius: 4px;
            transform: scale(1.1);
            z-index: 2;
        }
        .food-unit {
            width: 10px;
            height: 10px;
            background-color: var(--food);
            position: absolute;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(239, 68, 68, 0.5);
            animation: pulse 1.5s infinite;
        }
        .special-food {
            background-color: #fbbf24;
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.7);
            animation: pulse 0.8s infinite;
        }
        .powerup {
            width: 10px;
            height: 10px;
            position: absolute;
            border-radius: 50%;
            animation: spin 2s infinite linear;
            z-index: 1;
        }
        .powerup.speed { background-color: #06b6d4; }
        .powerup.invincibility { background-color: #a855f7; }
        .powerup.points { background-color: #facc15; }
        .obstacle-unit {
            width: 10px;
            height: 10px;
            background-color: var(--obstacle);
            position: absolute;
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .game-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            font-size: 22px;
            color: #FFF;
            z-index: 10;
            backdrop-filter: blur(3px);
            text-align: center;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .game-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        .game-overlay h2 {
            margin-bottom: 15px;
            color: #fff;
        }
        .game-overlay p {
            margin-bottom: 20px;
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
        }
        .controls-container {
            width: 100%;
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .controls-row {
            display: flex;
            margin-bottom: 10px;
            gap: 10px;
            width: 100%;
            justify-content: center;
        }
        button {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        button:active {
            transform: translateY(0);
        }
        .action-btn {
            flex: 1;
            max-width: 150px;
        }
        .direction-btn {
            width: 50px;
            height: 50px;
            font-size: 20px;
        }
        .settings-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            width: 100%;
            margin-top: 15px;
            justify-content: center;
        }
        .setting-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 120px;
            max-width: 180px;
            background-color: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        .setting-label {
            font-size: 13px;
            margin-bottom: 5px;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            width: 16px;
            height: 16px;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text);
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 12px;
            cursor: help;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            pointer-events: none;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        select, input[type="checkbox"] {
            padding: 8px 5px;
            border-radius: 6px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg);
            color: var(--text);
        }
        .achievement {
            background-color: rgba(74, 222, 128, 0.1);
            border-left: 3px solid var(--primary);
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
            opacity: 0;
            transform: translateY(20px);
            animation: achievementAppear 3s forwards;
        }
        .achievement-title {
            font-weight: 600;
            margin-bottom: 3px;
        }
        .achievement-desc {
            opacity: 0.8;
            font-size: 12px;
        }
        #achievements-list {
            max-height: 150px;
            overflow-y: auto;
            width: 100%;
            margin-top: 15px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 45px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            border-radius: 34px;
            transition: .4s;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
        }
        input:checked + .toggle-slider {
            background-color: var(--secondary);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(21px);
        }
        #mobile-controls {
            display: none;
            margin-top: 20px;
            width: 100%;
        }
        .mobile-btn-row {
            display: flex;
            justify-content: center;
            margin: 5px 0;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes achievementAppear {
            0% { opacity: 0; transform: translateY(20px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0.7; transform: translateY(0); }
        }
        .points-popup {
            position: absolute;
            font-size: 12px;
            font-weight: bold;
            color: white;
            padding: 3px 6px;
            border-radius: 10px;
            animation: pointsUp 1s forwards;
            z-index: 5;
        }
        @keyframes pointsUp {
            0% { opacity: 0; transform: translateY(0); }
            20% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        @media (max-width: 500px) {
            .stats-container { flex-wrap: wrap; }
            .stat { margin-bottom: 5px; width: calc(50% - 5px); }
            #mobile-controls { display: block; }
            .game-overlay h2 { font-size: 20px; }
            .game-overlay p { font-size: 14px; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Snake Game</h1>
    <p>Use arrow keys or swipe to control the snake. Collect food to grow and earn points, but avoid hitting walls, obstacles, or yourself!</p>

    <div class="stats-container">
        <div class="stat">
            <span class="stat-label">Score</span>
            <span class="stat-value" id="score">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">High Score</span>
            <span class="stat-value" id="high-score">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">Level</span>
            <span class="stat-value" id="level">1</span>
        </div>
        <div class="stat">
            <span class="stat-label">Time</span>
            <span class="stat-value" id="time">00:00</span>
        </div>
    </div>

    <div id="game-container">
        <div id="game-board">
            <div id="start-screen" class="game-overlay active">
                <h2>Snake Game</h2>
                <p>Press Start to play!</p>
                <p>Current High Score: <span id="start-high-score">0</span></p>
                <button id="start-button" class="action-btn">Start Game</button>
            </div>
            <div id="pause-screen" class="game-overlay">
                <h2>Game Paused</h2>
                <p>Press Resume to continue</p>
                <button id="resume-button">Resume</button>
            </div>
            <div id="game-over-screen" class="game-overlay">
                <h2>Game Over</h2>
                <p>Your Score: <span id="final-score">0</span></p>
                <p>High Score: <span id="final-high-score">0</span></p>
                <button id="restart-button">Play Again</button>
            </div>
        </div>

        <div class="game-controls">
            <button id="pause-button" title="Pause Game" disabled>‚è∏Ô∏è</button>
            <button id="theme-toggle" title="Toggle Dark Mode">üåô</button>
        </div>
    </div>

    <div id="mobile-controls">
        <div class="mobile-btn-row">
            <button id="up-button" class="direction-btn">‚¨ÜÔ∏è</button>
        </div>
        <div class="mobile-btn-row">
            <button id="left-button" class="direction-btn">‚¨ÖÔ∏è</button>
            <button id="down-button" class="direction-btn">‚¨áÔ∏è</button>
            <button id="right-button" class="direction-btn">‚û°Ô∏è</button>
        </div>
    </div>

    <div class="settings-panel">
        <div class="setting-group">
            <span class="setting-label">Grid Size</span>
            <select id="grid-size">
                <option value="10">10x10</option>
                <option value="20">20x20</option>
                <option value="30" selected>30x30</option>
                <option value="40">40x40</option>
                <option value="50">50x50</option>
            </select>
        </div>

        <div class="setting-group">
            <span class="setting-label">Difficulty</span>
            <select id="difficulty-selector">
                <option value="easy">Easy</option>
                <option value="medium" selected>Medium</option>
                <option value="hard">Hard</option>
                <option value="insane">Insane</option>
            </select>
        </div>

        <div class="setting-group">
            <span class="setting-label">Snake Color</span>
            <select id="skin">
                <option value="default">Green</option>
                <option value="blue">Blue</option>
                <option value="orange">Orange</option>
            </select>
        </div>

        <div class="setting-group">
        <span class="setting-label">
          Game Mode
          <span class="tooltip">?
            <span class="tooltip-text">
              Classic: Hit walls or yourself = game over<br>
              No Walls: Snake wraps around edges<br>
              Powerups: Collect special items for boosts
            </span>
          </span>
        </span>
            <select id="game-mode">
                <option value="classic">Classic</option>
                <option value="no-walls">No Walls</option>
                <option value="powerup">Powerups</option>
            </select>
        </div>

        <div class="setting-group">
            <span class="setting-label">Disable Sound</span>
            <label class="toggle-switch">
                <input type="checkbox" id="mute-checkbox">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <div class="setting-group">
            <span class="setting-label">Obstacles</span>
            <label class="toggle-switch">
                <input type="checkbox" id="create-obstacles">
                <span class="toggle-slider"></span>
            </label>
        </div>
    </div>

    <div id="achievements-list"></div>
</div>

<!-- Audio files -->
<audio id="eat" src="sfx/eat.mp3" preload="auto"></audio>
<audio id="special-eat" src="sfx/eat.mp3" preload="auto"></audio>
<audio id="powerup" src="sfx/eat.mp3" preload="auto"></audio>
<audio id="game-over" src="sfx/game-over.mp3" preload="auto"></audio>
<audio id="obstacle" src="sfx/obstacle/collision.mp3" preload="auto"></audio>
<audio id="level-up" src="sfx/eat.mp3" preload="auto"></audio>

<script>
    // Game variables
    const gameBoard = document.getElementById("game-board");
    const scoreElement = document.getElementById("score");
    const highScoreElement = document.getElementById("high-score");
    const levelElement = document.getElementById("level");
    const timeElement = document.getElementById("time");
    const difficultySelector = document.getElementById("difficulty-selector");
    const gameModeSelector = document.getElementById("game-mode");
    const startButton = document.getElementById("start-button");
    const pauseButton = document.getElementById("pause-button");
    const resumeButton = document.getElementById("resume-button");
    const restartButton = document.getElementById("restart-button");
    const themeToggle = document.getElementById("theme-toggle");
    const startScreen = document.getElementById("start-screen");
    const pauseScreen = document.getElementById("pause-screen");
    const gameOverScreen = document.getElementById("game-over-screen");
    const finalScoreElement = document.getElementById("final-score");
    const finalHighScoreElement = document.getElementById("final-high-score");
    const startHighScoreElement = document.getElementById("start-high-score");
    const muteCheckbox = document.getElementById("mute-checkbox");
    const obstacleCheckbox = document.getElementById("create-obstacles");
    const gridSizeSelector = document.getElementById("grid-size");
    const skinSelector = document.getElementById("skin");
    const achievementsList = document.getElementById("achievements-list");

    // Direction buttons
    const upButton = document.getElementById("up-button");
    const leftButton = document.getElementById("left-button");
    const downButton = document.getElementById("down-button");
    const rightButton = document.getElementById("right-button");

    // Sound elements
    const eatSound = document.getElementById("eat");
    const specialEatSound = document.getElementById("special-eat");
    const powerupSound = document.getElementById("powerup");
    const gameOverSound = document.getElementById("game-over");
    const obstacleSound = document.getElementById("obstacle");
    const levelUpSound = document.getElementById("level-up");

    // Game state
    let snake = [];
    let food = null;
    let specialFood = null;
    let powerup = null;
    let obstacles = [];
    let score = 0;
    let level = 1;
    let highScore = 0;
    let unitSize = 10;
    let boardWidth = gameBoard.offsetWidth;
    let boardHeight = gameBoard.offsetHeight;
    let gridSize = parseInt(gridSizeSelector.value, 10);
    let xDirection = unitSize;
    let yDirection = 0;
    let gameInterval = null;
    let gameTimer = null;
    let gameTime = 0;
    let isPaused = false;
    let isGameActive = false;
    let achievementsUnlocked = [];
    let activePowerup = null;
    let powerupTimer = null;

    // Achievement definitions
    const achievements = [
        { id: 'first_meal', title: 'First Bite', description: 'Eat your first food', score: 1 },
        { id: 'level_5', title: 'Growing Up', description: 'Reach level 5', level: 5 },
        { id: 'score_50', title: 'Half Century', description: 'Score 50 points', score: 50 },
        { id: 'score_100', title: 'Century', description: 'Score 100 points', score: 100 },
        { id: 'special_food', title: 'Gourmet', description: 'Eat special food', specialFood: 1 },
        { id: 'powerup', title: 'Power Player', description: 'Collect your first power-up', powerup: 1 },
        { id: 'snake_20', title: 'Long Snake', description: 'Grow your snake to 20 units', length: 20 },
        { id: 'snake_40', title: 'Python', description: 'Grow your snake to 40 units', length: 40 },
        { id: 'play_1_min', title: 'Just Started', description: 'Play for 1 minute', time: 60 }
    ];

    // Check for system dark mode preference
    function checkSystemThemePreference() {
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefersDarkMode) {
            document.body.classList.add('dark-theme');
            themeToggle.textContent = "‚òÄÔ∏è";
            themeToggle.title = "Toggle Light Mode";
        }
    }

    // Load saved data from localStorage
    function loadSavedData() {
        const savedHighScore = localStorage.getItem("snakeHighScore");
        if (savedHighScore) {
            highScore = parseInt(savedHighScore, 10);
            highScoreElement.textContent = highScore;
            startHighScoreElement.textContent = highScore;
            finalHighScoreElement.textContent = highScore;
        }

        const skin = localStorage.getItem("skin");
        if (skin) skinSelector.value = skin;

        const gridSize = localStorage.getItem("gridSize");
        if (gridSize) gridSizeSelector.value = gridSize;

        const difficulty = localStorage.getItem("difficulty");
        if (difficulty) difficultySelector.value = difficulty;

        const muted = localStorage.getItem("muted");
        if (muted !== null) muteCheckbox.checked = muted === "true";

        const obstacles = localStorage.getItem("obstacles");
        if (obstacles !== null) obstacleCheckbox.checked = obstacles === "true";

        const theme = localStorage.getItem("theme");
        if (theme) {
            if (theme === "dark") {
                document.body.classList.add('dark-theme');
                themeToggle.textContent = "‚òÄÔ∏è";
                themeToggle.title = "Toggle Light Mode";
            } else {
                document.body.classList.remove('dark-theme');
                themeToggle.textContent = "üåô";
                themeToggle.title = "Toggle Dark Mode";
            }
        } else {
            // If no theme preference is saved, check system preference
            checkSystemThemePreference();
        }

        const unlockedAchievements = localStorage.getItem("achievements");
        if (unlockedAchievements) achievementsUnlocked = JSON.parse(unlockedAchievements);
        displayAchievements();
    }

    // Toggle dark mode
    function toggleDarkMode() {
        document.body.classList.toggle('dark-theme');
        const isDark = document.body.classList.contains('dark-theme');
        themeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
        themeToggle.title = isDark ? "Toggle Light Mode" : "Toggle Dark Mode";
        localStorage.setItem("theme", isDark ? "dark" : "light");
    }

    // Initialize game board
    function initializeGame() {
        // Clear the board first
        clearBoard();
        updateGridSize();

        // Set default game state
        snake = [];
        food = null;
        specialFood = null;
        powerup = null;
        obstacles = [];
        score = 0;
        level = 1;
        xDirection = unitSize;
        yDirection = 0;

        scoreElement.textContent = "0";
        levelElement.textContent = "1";
        timeElement.textContent = "00:00";

        // Hide all screens
        startScreen.classList.remove('active');
        pauseScreen.classList.remove('active');
        gameOverScreen.classList.remove('active');

        createSnake();
        createFood();

        if (obstacleCheckbox.checked) {
            createObstacles();
        }

        // Set game difficulty
        setGameSpeed();

        // Start game timer
        gameTime = 0;
        if (gameTimer) clearInterval(gameTimer);
        gameTimer = setInterval(updateGameTime, 1000);

        // Enable pause button
        pauseButton.disabled = false;

        isGameActive = true;
    }

    // Update game time
    function updateGameTime() {
        if (!isPaused && isGameActive) {
            gameTime++;
            const minutes = Math.floor(gameTime / 60).toString().padStart(2, '0');
            const seconds = (gameTime % 60).toString().padStart(2, '0');
            timeElement.textContent = `${minutes}:${seconds}`;

            // Check time-based achievements
            checkAchievements();

            // Special food appears every 15 seconds in non-classic modes
            if (gameTime % 15 === 0 && !specialFood && gameModeSelector.value !== 'classic') {
                createSpecialFood();
            }

            // Powerups appear every 20 seconds in powerup mode
            if (gameTime % 20 === 0 && !powerup && gameModeSelector.value === 'powerup') {
                createPowerup();
            }
        }
    }

    // Create snake
    function createSnake() {
        for (let i = 4; i >= 0; i--) {
            let snakeUnit = document.createElement("div");
            snakeUnit.classList.add("snake-unit", skinSelector.value);
            if (i === 0) snakeUnit.classList.add("snake-head");
            snakeUnit.style.left = i * unitSize + "px";
            snakeUnit.style.top = 0 + "px";
            snake.push(snakeUnit);
            gameBoard.appendChild(snakeUnit);
        }
    }

    // Create food
    function createFood() {
        if (food) food.remove();

        food = document.createElement("div");
        food.classList.add("food-unit");

        let foodPosition = getRandomEmptyPosition();
        food.style.left = foodPosition.x + "px";
        food.style.top = foodPosition.y + "px";

        gameBoard.appendChild(food);
    }

    // Create special food (worth more points)
    function createSpecialFood() {
        if (specialFood) specialFood.remove();

        specialFood = document.createElement("div");
        specialFood.classList.add("food-unit", "special-food");

        let foodPosition = getRandomEmptyPosition();
        specialFood.style.left = foodPosition.x + "px";
        specialFood.style.top = foodPosition.y + "px";

        gameBoard.appendChild(specialFood);

        // Special food disappears after 5 seconds
        setTimeout(() => {
            if (specialFood) {
                specialFood.remove();
                specialFood = null;
            }
        }, 5000);
    }

    // Create powerup
    function createPowerup() {
        if (powerup) powerup.remove();

        powerup = document.createElement("div");
        powerup.classList.add("powerup");

        // Random powerup type
        const powerupTypes = ['speed', 'invincibility', 'points'];
        const powerupType = powerupTypes[Math.floor(Math.random() * powerupTypes.length)];
        powerup.classList.add(powerupType);
        powerup.dataset.type = powerupType;

        let position = getRandomEmptyPosition();
        powerup.style.left = position.x + "px";
        powerup.style.top = position.y + "px";

        gameBoard.appendChild(powerup);

        // Powerup disappears after 7 seconds
        setTimeout(() => {
            if (powerup) {
                powerup.remove();
                powerup = null;
            }
        }, 7000);
    }

    // Create obstacles
    function createObstacles() {
        obstacles.forEach(obstacle => obstacle.remove());
        obstacles = [];

        // Number of obstacles based on level and grid size
        const obstacleCount = Math.floor(gridSize / 10) + level - 1;

        for (let i = 0; i < obstacleCount; i++) {
            let obstacle = document.createElement("div");
            obstacle.classList.add("obstacle-unit");

            let position = getRandomEmptyPosition();
            obstacle.style.left = position.x + "px";
            obstacle.style.top = position.y + "px";

            obstacles.push(obstacle);
            gameBoard.appendChild(obstacle);
        }
    }

    // Get random empty position on board
    function getRandomEmptyPosition() {
        let x, y;
        let validPosition = false;
        let attemptCount = 0;
        const maxAttempts = 100; // Prevent infinite loop

        while (!validPosition && attemptCount < maxAttempts) {
            x = Math.floor(Math.random() * ((boardWidth-unitSize) / unitSize)) * unitSize;
            y = Math.floor(Math.random() * ((boardHeight-unitSize) / unitSize)) * unitSize;

            validPosition = true;
            attemptCount++;

            // Check if position overlaps with snake
            for (let i = 0; i < snake.length; i++) {
                if (x === snake[i].offsetLeft && y === snake[i].offsetTop) {
                    validPosition = false;
                    break;
                }
            }

            // Check if position overlaps with food
            if (validPosition && food && x === food.offsetLeft && y === food.offsetTop) {
                validPosition = false;
            }

            // Check if position overlaps with special food
            if (validPosition && specialFood && x === specialFood.offsetLeft && y === specialFood.offsetTop) {
                validPosition = false;
            }

            // Check if position overlaps with powerup
            if (validPosition && powerup && x === powerup.offsetLeft && y === powerup.offsetTop) {
                validPosition = false;
            }

            // Check if position overlaps with obstacles
            for (let i = 0; validPosition && i < obstacles.length; i++) {
                if (x === obstacles[i].offsetLeft && y === obstacles[i].offsetTop) {
                    validPosition = false;
                    break;
                }
            }
        }

        // If we couldn't find a valid position, use a fallback
        if (!validPosition) {
            // Find any position that's not directly in front of the snake
            x = (snake[0].offsetLeft + 5 * unitSize) % boardWidth;
            y = (snake[0].offsetTop + 5 * unitSize) % boardHeight;
        }

        return { x, y };
    }

    // Move snake
    function moveSnake() {
        if (isPaused || !isGameActive) return;

        let x = snake[0].offsetLeft + xDirection;
        let y = snake[0].offsetTop + yDirection;

        // Handle wall collision based on game mode
        const gameMode = gameModeSelector.value;

        if (gameMode === 'classic') {
            // Classic mode: die when hitting walls
            if (x >= boardWidth || x < 0 || y >= boardHeight || y < 0) {
                if (!activePowerup || activePowerup !== 'invincibility') {
                    gameOver();
                    return;
                } else {
                    // Wrap around with invincibility
                    if (x >= boardWidth) x = 0;
                    if (x < 0) x = boardWidth - unitSize;
                    if (y >= boardHeight) y = 0;
                    if (y < 0) y = boardHeight - unitSize;
                }
            }
        } else {
            // Other modes: wrap around walls
            if (x >= boardWidth) x = 0;
            if (x < 0) x = boardWidth - unitSize;
            if (y >= boardHeight) y = 0;
            if (y < 0) y = boardHeight - unitSize;
        }

        // Create new snake head
        let newUnit = document.createElement("div");
        newUnit.classList.add("snake-unit", skinSelector.value);
        newUnit.classList.add("snake-head");
        newUnit.style.left = x + "px";
        newUnit.style.top = y + "px";

        // Remove head class from previous head
        if (snake.length > 0) {
            snake[0].classList.remove("snake-head");
        }

        snake.unshift(newUnit);
        gameBoard.appendChild(newUnit);

        // Check for collisions
        let ate = checkFoodCollision(x, y);
        if (!ate) {
            // Remove tail if we didn't eat
            let removedUnit = snake.pop();
            removedUnit.remove();
        }

        // Check other collisions
        checkCollisions();
    }

    // Check if snake ate food
    function checkFoodCollision(x, y) {
        // Check regular food collision
        if (food && x === food.offsetLeft && y === food.offsetTop) {
            food.remove();
            createFood();
            updateScore(1);
            playSound(eatSound);
            showPointsPopup(x, y, '+1');
            return true;
        }

        // Check special food collision
        if (specialFood && x === specialFood.offsetLeft && y === specialFood.offsetTop) {
            specialFood.remove();
            specialFood = null;
            updateScore(5);
            playSound(specialEatSound);
            showPointsPopup(x, y, '+5');
            unlockAchievement('special_food');
            return true;
        }

        // Check powerup collision
        if (powerup && x === powerup.offsetLeft && y === powerup.offsetTop) {
            const type = powerup.dataset.type;
            activatePowerup(type);
            powerup.remove();
            powerup = null;
            playSound(powerupSound);
            unlockAchievement('powerup');
            return false; // Powerups don't make snake grow
        }

        return false;
    }

    // Activate powerup effects
    function activatePowerup(type) {
        // Clear existing powerup effects
        if (powerupTimer) {
            clearTimeout(powerupTimer);
        }

        activePowerup = type;

        // Apply powerup effect
        switch(type) {
            case 'speed':
                // Double speed for 5 seconds
                setGameSpeed(true);
                showPointsPopup(snake[0].offsetLeft, snake[0].offsetTop, '2x Speed!', '#06b6d4');
                break;
            case 'invincibility':
                // Cannot die for 5 seconds
                snake.forEach(unit => unit.style.opacity = '0.7');
                showPointsPopup(snake[0].offsetLeft, snake[0].offsetTop, 'Invincible!', '#a855f7');
                break;
            case 'points':
                // Double points for 10 seconds
                showPointsPopup(snake[0].offsetLeft, snake[0].offsetTop, '2x Points!', '#facc15');
                break;
        }

        // Set timer to end powerup effect
        const duration = type === 'points' ? 10000 : 5000;
        powerupTimer = setTimeout(() => {
            deactivatePowerup();
        }, duration);
    }

    // Deactivate powerup effects
    function deactivatePowerup() {
        if (activePowerup === 'speed') {
            setGameSpeed();
        } else if (activePowerup === 'invincibility') {
            snake.forEach(unit => unit.style.opacity = '1');
        }

        activePowerup = null;
    }

    // Check for collisions with self or obstacles
    function checkCollisions() {
        if (!isGameActive) return;

        let x = snake[0].offsetLeft;
        let y = snake[0].offsetTop;

        // Check self collision
        for (let i = 1; i < snake.length; i++) {
            if (x === snake[i].offsetLeft && y === snake[i].offsetTop) {
                if (activePowerup !== 'invincibility') {
                    gameOver();
                    return;
                }
            }
        }

        // Check obstacle collision
        for (let i = 0; i < obstacles.length; i++) {
            if (x === obstacles[i].offsetLeft && y === obstacles[i].offsetTop) {
                if (activePowerup !== 'invincibility') {
                    playSound(obstacleSound);
                    gameOver();
                    return;
                }
            }
        }

        // Check achievements
        checkAchievements();
    }

    // Update score
    function updateScore(points) {
        // Apply points multiplier if powerup is active
        if (activePowerup === 'points') points *= 2;

        score += points;
        scoreElement.textContent = score;

        // Update level every 10 points
        if (score % 10 === 0) {
            level++;
            levelElement.textContent = level;
            playSound(levelUpSound);
            showPointsPopup(snake[0].offsetLeft, snake[0].offsetTop, 'Level Up!', '#22c55e');

            // Update game speed
            setGameSpeed();

            // Add more obstacles on level up
            if (obstacleCheckbox.checked) {
                createObstacles();
            }
        }

        // Check score-based achievements
        checkAchievements();
    }

    // Show points popup
    function showPointsPopup(x, y, text, color = '#ef4444') {
        const popup = document.createElement('div');
        popup.classList.add('points-popup');
        popup.textContent = text;
        popup.style.left = `${x}px`;
        popup.style.top = `${y}px`;
        popup.style.backgroundColor = color;

        gameBoard.appendChild(popup);

        // Remove popup after animation completes
        setTimeout(() => {
            popup.remove();
        }, 1000);
    }

    // Check and unlock achievements
    function checkAchievements() {
        achievements.forEach(achievement => {
            if (achievementsUnlocked.includes(achievement.id)) return;

            let unlocked = false;

            if (achievement.score && score >= achievement.score) unlocked = true;
            if (achievement.level && level >= achievement.level) unlocked = true;
            if (achievement.length && snake.length >= achievement.length) unlocked = true;
            if (achievement.time && gameTime >= achievement.time) unlocked = true;

            if (unlocked) {
                unlockAchievement(achievement.id);
            }
        });
    }

    // Unlock achievement
    function unlockAchievement(id) {
        if (achievementsUnlocked.includes(id)) return;

        achievementsUnlocked.push(id);
        localStorage.setItem('achievements', JSON.stringify(achievementsUnlocked));

        const achievement = achievements.find(a => a.id === id);
        if (!achievement) return;

        // Create achievement notification
        const notification = document.createElement('div');
        notification.classList.add('achievement');
        notification.innerHTML = `
        <div class="achievement-title">üèÜ ${achievement.title}</div>
        <div class="achievement-desc">${achievement.description}</div>
      `;

        achievementsList.appendChild(notification);

        // Remove notification after animation completes
        setTimeout(() => {
            notification.style.opacity = 0.7;
        }, 3000);
    }

    // Display all unlocked achievements
    function displayAchievements() {
        achievementsList.innerHTML = '';

        achievementsUnlocked.forEach(id => {
            const achievement = achievements.find(a => a.id === id);
            if (!achievement) return;

            const notification = document.createElement('div');
            notification.classList.add('achievement');
            notification.style.opacity = 0.7;
            notification.innerHTML = `
          <div class="achievement-title">üèÜ ${achievement.title}</div>
          <div class="achievement-desc">${achievement.description}</div>
        `;

            achievementsList.appendChild(notification);
        });
    }

    // Set game speed based on difficulty and level
    function setGameSpeed(speedBoost = false) {
        const difficulty = difficultySelector.value;
        let speed;

        // Base speed by difficulty
        if (difficulty === 'easy') {
            speed = 150;
        } else if (difficulty === 'medium') {
            speed = 120;
        } else if (difficulty === 'hard') {
            speed = 90;
        } else { // insane
            speed = 70;
        }

        // Adjust for level (faster as level increases)
        speed = Math.max(50, speed - (level - 1) * 5);

        // Apply speed boost if active
        if (speedBoost) speed = Math.max(30, Math.floor(speed / 2));

        // Update game interval
        clearInterval(gameInterval);
        gameInterval = setInterval(moveSnake, speed);

        // Save difficulty setting
        localStorage.setItem("difficulty", difficulty);
    }

    // Update grid size
    function updateGridSize() {
        gridSize = parseInt(gridSizeSelector.value, 10);
        const boardSize = gridSize * unitSize + "px";

        // Update board dimensions
        gameBoard.style.width = "100%";
        gameBoard.style.height = "100%";
        gameBoard.style.backgroundSize = `${unitSize}px ${unitSize}px`;

        // Update internal dimensions
        boardWidth = gameBoard.offsetWidth;
        boardHeight = gameBoard.offsetHeight;

        // Save grid size setting
        localStorage.setItem("gridSize", gridSize);
    }

    // Clear game board completely
    function clearBoard() {
        // First, remove all elements except overlays
        const overlays = [startScreen, pauseScreen, gameOverScreen];
        const allElements = Array.from(gameBoard.children);

        for (const element of allElements) {
            if (!overlays.includes(element)) {
                element.remove();
            }
        }

        // Reset game state
        snake = [];
        food = null;
        specialFood = null;
        powerup = null;
        obstacles = [];
    }

    // Game over
    function gameOver() {
        isGameActive = false;
        clearInterval(gameInterval);
        clearInterval(gameTimer);
        playSound(gameOverSound);

        // Update high score
        if (score > highScore) {
            highScore = score;
            localStorage.setItem("snakeHighScore", highScore);
            highScoreElement.textContent = highScore;
            startHighScoreElement.textContent = highScore;
        }

        // Show game over screen
        finalScoreElement.textContent = score;
        finalHighScoreElement.textContent = highScore;
        gameOverScreen.classList.add('active');

        // Reset buttons
        pauseButton.disabled = true;
    }

    // Play sound
    function playSound(sound) {
        if (!muteCheckbox.checked && sound) {
            // First try to pause any ongoing playback
            try {
                sound.pause();
            } catch (e) {}

            // Reset playback position
            sound.currentTime = 0;

            // Try to play the sound
            const playPromise = sound.play();

            // Handle potential play() promise rejection
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("Sound play error:", error);
                });
            }
        }
    }

    // Update snake skin
    function updateSnakeSkin() {
        const skin = skinSelector.value;
        snake.forEach(unit => {
            unit.classList.remove("default", "blue", "orange");
            unit.classList.add(skin);
        });
        localStorage.setItem("skin", skin);
    }

    // Toggle pause
    function togglePause() {
        if (!isGameActive) return;

        isPaused = !isPaused;
        if (isPaused) {
            pauseScreen.classList.add('active');
        } else {
            pauseScreen.classList.remove('active');
        }
    }

    // Event handlers
    startButton.addEventListener("click", () => {
        initializeGame();
    });

    pauseButton.addEventListener("click", () => {
        togglePause();
    });

    resumeButton.addEventListener("click", () => {
        togglePause();
    });

    restartButton.addEventListener("click", () => {
        initializeGame();
    });

    themeToggle.addEventListener("click", toggleDarkMode);

    skinSelector.addEventListener("change", updateSnakeSkin);

    gridSizeSelector.addEventListener("change", () => {
        if (isGameActive) {
            // If changing grid during gameplay, restart game
            initializeGame();
        } else {
            updateGridSize();
        }
    });

    difficultySelector.addEventListener("change", () => {
        if (isGameActive) setGameSpeed();
    });

    muteCheckbox.addEventListener("change", () => {
        localStorage.setItem("muted", muteCheckbox.checked);
    });

    obstacleCheckbox.addEventListener("change", () => {
        localStorage.setItem("obstacles", obstacleCheckbox.checked);
        if (isGameActive && obstacleCheckbox.checked) {
            createObstacles();
        } else if (isGameActive && !obstacleCheckbox.checked) {
            obstacles.forEach(obstacle => obstacle.remove());
            obstacles = [];
        }
    });

    // Keyboard controls
    document.addEventListener("keydown", (event) => {
        switch (event.code) {
            case "Space":
                event.preventDefault();
                if (!isGameActive) {
                    initializeGame();
                } else {
                    togglePause();
                }
                break;
            case "ArrowLeft":
                event.preventDefault();
                if (xDirection === 0 && !isPaused && isGameActive) {
                    xDirection = -unitSize;
                    yDirection = 0;
                }
                break;
            case "ArrowUp":
                event.preventDefault();
                if (yDirection === 0 && !isPaused && isGameActive) {
                    xDirection = 0;
                    yDirection = -unitSize;
                }
                break;
            case "ArrowRight":
                event.preventDefault();
                if (xDirection === 0 && !isPaused && isGameActive) {
                    xDirection = unitSize;
                    yDirection = 0;
                }
                break;
            case "ArrowDown":
                event.preventDefault();
                if (yDirection === 0 && !isPaused && isGameActive) {
                    xDirection = 0;
                    yDirection = unitSize;
                }
                break;
        }
    });

    // Mobile direction buttons
    if (upButton) {
        upButton.addEventListener("click", () => {
            if (yDirection === 0 && !isPaused && isGameActive) {
                xDirection = 0;
                yDirection = -unitSize;
            }
        });
    }

    if (leftButton) {
        leftButton.addEventListener("click", () => {
            if (xDirection === 0 && !isPaused && isGameActive) {
                xDirection = -unitSize;
                yDirection = 0;
            }
        });
    }

    if (downButton) {
        downButton.addEventListener("click", () => {
            if (yDirection === 0 && !isPaused && isGameActive) {
                xDirection = 0;
                yDirection = unitSize;
            }
        });
    }

    if (rightButton) {
        rightButton.addEventListener("click", () => {
            if (xDirection === 0 && !isPaused && isGameActive) {
                xDirection = unitSize;
                yDirection = 0;
            }
        });
    }

    // Handle touch swipes with vanilla JS (no Hammer.js dependency)
    let touchStartX = 0;
    let touchStartY = 0;

    gameBoard.addEventListener('touchstart', function(event) {
        touchStartX = event.changedTouches[0].screenX;
        touchStartY = event.changedTouches[0].screenY;
    }, false);

    gameBoard.addEventListener('touchend', function(event) {
        const touchEndX = event.changedTouches[0].screenX;
        const touchEndY = event.changedTouches[0].screenY;

        handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
    }, false);

    function handleSwipe(startX, startY, endX, endY) {
        if (!isGameActive || isPaused) return;

        const dx = endX - startX;
        const dy = endY - startY;

        // Detect horizontal or vertical swipe based on which has greater magnitude
        if (Math.abs(dx) > Math.abs(dy)) {
            // Horizontal swipe
            if (dx > 0 && xDirection === 0) {
                // Right swipe
                xDirection = unitSize;
                yDirection = 0;
            } else if (dx < 0 && xDirection === 0) {
                // Left swipe
                xDirection = -unitSize;
                yDirection = 0;
            }
        } else {
            // Vertical swipe
            if (dy > 0 && yDirection === 0) {
                // Down swipe
                xDirection = 0;
                yDirection = unitSize;
            } else if (dy < 0 && yDirection === 0) {
                // Up swipe
                xDirection = 0;
                yDirection = -unitSize;
            }
        }
    }

    // Initialize
    checkSystemThemePreference();
    loadSavedData();
    updateGridSize();
    startHighScoreElement.textContent = highScore;
</script>
<script src="../logo.js"></script>
</body>
</html>