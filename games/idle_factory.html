<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle Factory - Incremental Game</title>
    <script src="https://cdn.jsdelivr.net/npm/break_infinity.js@2"></script>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f0f1a;
            --accent-primary: #e94560;
            --accent-secondary: #0f3460;
            --accent-gold: #ffc107;
            --text-primary: #eaeaea;
            --text-secondary: #a0a0a0;
            --text-muted: #606060;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --border-radius: 8px;
            --transition-speed: 0.2s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--accent-secondary);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }

        /* Header */
        .header {
            background-color: var(--bg-secondary);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--accent-secondary);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .header-btn {
            background-color: var(--accent-secondary);
            border: none;
            color: var(--text-primary);
            padding: 8px 14px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header-btn:hover {
            background-color: var(--accent-primary);
            transform: translateY(-1px);
        }

        .header-btn:active {
            transform: scale(0.95);
        }

        .version {
            font-size: 0.7rem;
            color: var(--text-muted);
            position: absolute;
            bottom: 5px;
            right: 10px;
        }

        /* Resource Display */
        .resources-panel {
            background-color: var(--bg-secondary);
            padding: 20px;
            margin: 15px;
            border-radius: var(--border-radius);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .resource-item {
            background-color: var(--bg-tertiary);
            padding: 15px;
            border-radius: var(--border-radius);
            text-align: center;
            transition: all var(--transition-speed) ease;
        }

        .resource-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .resource-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .resource-amount {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent-gold);
            font-variant-numeric: tabular-nums;
        }

        .resource-rate {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .resource-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 3px;
        }

        /* Main Click Area */
        .click-area {
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .main-button {
            background-color: var(--accent-primary);
            border: none;
            color: white;
            padding: 30px 60px;
            font-size: 1.3rem;
            border-radius: 16px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            box-shadow: 0 6px 0 #b8304f, 0 8px 20px rgba(233, 69, 96, 0.3);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 0 #b8304f, 0 10px 25px rgba(233, 69, 96, 0.4);
        }

        .main-button:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #b8304f, 0 4px 10px rgba(233, 69, 96, 0.2);
        }

        .click-value {
            display: block;
            font-size: 0.9rem;
            margin-top: 8px;
            opacity: 0.9;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            justify-content: center;
            gap: 5px;
            padding: 0 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background-color: var(--bg-secondary);
            border: 2px solid var(--accent-secondary);
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.95rem;
            transition: all var(--transition-speed) ease;
        }

        .tab-btn:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background-color: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        /* Main Content Grid */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            padding: 0 15px 80px;
            max-width: 1400px;
            margin: 0 auto;
        }

        @media (min-width: 900px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (min-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        /* Panels */
        .panel {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            overflow: hidden;
            display: none;
        }

        .panel.active {
            display: block;
        }

        .panel-header {
            background-color: var(--bg-tertiary);
            padding: 12px 16px;
            font-weight: 600;
            border-bottom: 2px solid var(--accent-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            padding: 12px;
            max-height: 450px;
            overflow-y: auto;
        }

        /* Buildings */
        .building-item {
            background-color: var(--bg-tertiary);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 10px;
            transition: all var(--transition-speed) ease;
            border: 2px solid transparent;
        }

        .building-item:hover {
            border-color: var(--accent-secondary);
        }

        .building-item.locked {
            opacity: 0.5;
            pointer-events: none;
        }

        .building-item.affordable {
            border-color: var(--success);
        }

        .building-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .building-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .building-icon {
            font-size: 1.8rem;
        }

        .building-name {
            font-weight: 600;
        }

        .building-owned {
            background-color: var(--accent-secondary);
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .building-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-style: italic;
        }

        .building-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .building-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .buy-btn {
            background-color: var(--accent-secondary);
            border: none;
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all var(--transition-speed) ease;
            flex: 1;
            min-width: 60px;
        }

        .buy-btn:hover:not(:disabled) {
            background-color: var(--accent-primary);
        }

        .buy-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .buy-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        /* Upgrades */
        .upgrade-item {
            background-color: var(--bg-tertiary);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 10px;
            transition: all var(--transition-speed) ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .upgrade-item:hover:not(.purchased):not(.locked) {
            border-color: var(--accent-secondary);
        }

        .upgrade-item.affordable {
            border-color: var(--success);
        }

        .upgrade-item.purchased {
            opacity: 0.6;
            border-color: var(--success);
            cursor: default;
        }

        .upgrade-item.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .upgrade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .upgrade-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upgrade-cost {
            font-size: 0.85rem;
            color: var(--accent-gold);
        }

        .upgrade-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .upgrade-flavor {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 4px;
        }

        .upgrade-status {
            font-size: 1.2rem;
        }

        /* Achievements */
        .achievement-item {
            background-color: var(--bg-tertiary);
            border-radius: var(--border-radius);
            padding: 10px 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all var(--transition-speed) ease;
        }

        .achievement-item.unlocked {
            border-left: 3px solid var(--accent-gold);
        }

        .achievement-item.locked {
            opacity: 0.5;
        }

        .achievement-icon {
            font-size: 1.8rem;
        }

        .achievement-info {
            flex: 1;
        }

        .achievement-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .achievement-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .achievement-bonus {
            font-size: 0.7rem;
            color: var(--success);
        }

        /* Stats */
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            font-weight: 600;
            color: var(--accent-gold);
        }

        /* Prestige Panel */
        .prestige-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-secondary);
            padding: 12px 20px;
            border-top: 2px solid var(--accent-gold);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            z-index: 100;
        }

        .prestige-btn {
            background-color: var(--accent-gold);
            color: var(--bg-primary);
            border: none;
            padding: 12px 30px;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }

        .prestige-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.4);
        }

        .prestige-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .prestige-info {
            text-align: center;
        }

        .prestige-available {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-gold);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background-color: var(--bg-secondary);
            border-left: 4px solid var(--accent-gold);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            max-width: 300px;
        }

        .toast.achievement {
            border-color: var(--accent-gold);
        }

        .toast.milestone {
            border-color: var(--success);
        }

        .toast.prestige {
            border-color: var(--accent-primary);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Golden Gear */
        .golden-gear {
            position: fixed;
            font-size: 3rem;
            cursor: pointer;
            animation: float 2s ease-in-out infinite, glow 1s ease-in-out infinite alternate;
            z-index: 500;
            filter: drop-shadow(0 0 10px gold);
            user-select: none;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(180deg); }
        }

        @keyframes glow {
            from { filter: drop-shadow(0 0 5px gold); }
            to { filter: drop-shadow(0 0 20px gold); }
        }

        /* Click Particles */
        .click-particle {
            position: fixed;
            pointer-events: none;
            font-weight: 700;
            color: var(--accent-gold);
            animation: particleFloat 1s ease-out forwards;
            z-index: 600;
        }

        @keyframes particleFloat {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(0.5); }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-speed) ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            transition: transform var(--transition-speed) ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal h2 {
            margin-bottom: 15px;
            color: var(--accent-gold);
        }

        .modal p {
            margin-bottom: 20px;
            color: var(--text-secondary);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 30px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }

        .modal-btn.confirm {
            background-color: var(--accent-primary);
            color: white;
        }

        .modal-btn.cancel {
            background-color: var(--accent-secondary);
            color: var(--text-primary);
        }

        .modal-btn:hover {
            transform: scale(1.05);
        }

        /* Welcome Back Modal */
        .welcome-back-gains {
            background-color: var(--bg-tertiary);
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 15px 0;
        }

        .welcome-back-gains .resource-gain {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }

        /* Options Panel */
        .options-panel {
            position: fixed;
            top: 60px;
            right: 20px;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 20px;
            z-index: 1000;
            min-width: 250px;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .options-panel.active {
            display: block;
        }

        .option-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .option-row:last-child {
            border-bottom: none;
        }

        .volume-slider {
            width: 100px;
            accent-color: var(--accent-primary);
        }

        /* Prestige Upgrades */
        .prestige-upgrade-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .prestige-upgrade {
            background-color: var(--bg-tertiary);
            border: 2px solid var(--accent-gold);
            border-radius: var(--border-radius);
            padding: 12px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }

        .prestige-upgrade:hover:not(.purchased):not(.locked) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .prestige-upgrade.purchased {
            border-color: var(--success);
            opacity: 0.7;
        }

        .prestige-upgrade.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Progress bars */
        .progress-bar {
            height: 4px;
            background-color: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--accent-primary);
            transition: width 0.3s ease;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .header-title span:not(.emoji) {
                display: none;
            }

            .resources-panel {
                grid-template-columns: 1fr 1fr;
                padding: 10px;
                margin: 10px;
            }

            .resource-item {
                padding: 10px;
            }

            .resource-amount {
                font-size: 1.1rem;
            }

            .main-button {
                padding: 20px 40px;
                font-size: 1.1rem;
            }

            .tab-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .prestige-area {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
        }

        /* Hidden utility */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1 class="header-title">
            <span class="emoji">üè≠</span>
            <span>IDLE FACTORY</span>
        </h1>
        <div class="header-controls">
            <button class="header-btn" id="saveBtn" title="Save Game (S)">
                <span>üíæ</span> Save
            </button>
            <button class="header-btn" id="muteBtn" title="Toggle Sound (M)">
                <span id="muteIcon">üîä</span>
            </button>
            <button class="header-btn" id="optionsBtn" title="Options">
                <span>‚öôÔ∏è</span>
            </button>
        </div>
        <span class="version">v1.0.0</span>
    </header>

    <div class="options-panel" id="optionsPanel">
        <h3 style="margin-bottom: 15px;">Options</h3>
        <div class="option-row">
            <span>Master Volume</span>
            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50">
        </div>
        <div class="option-row">
            <span>Number Format</span>
            <select id="numberFormat" style="padding: 5px; border-radius: 4px;">
                <option value="scientific">Scientific (1.23e6)</option>
                <option value="suffix">Suffix (1.23M)</option>
            </select>
        </div>
        <div class="option-row">
            <span>Buy Amount</span>
            <select id="globalBuyAmount" style="padding: 5px; border-radius: 4px;">
                <option value="1">x1</option>
                <option value="10">x10</option>
                <option value="25">x25</option>
                <option value="100">x100</option>
                <option value="max">MAX</option>
            </select>
        </div>
        <div class="option-row">
            <button class="header-btn" id="exportBtn" style="width: 100%;">üì§ Export Save</button>
        </div>
        <div class="option-row">
            <button class="header-btn" id="importBtn" style="width: 100%;">üì• Import Save</button>
        </div>
        <div class="option-row">
            <button class="header-btn" id="resetBtn" style="width: 100%; background-color: var(--danger);">üóëÔ∏è Hard Reset</button>
        </div>
        <div style="margin-top: 15px; font-size: 0.75rem; color: var(--text-muted); text-align: center;">
            Created with ‚ù§Ô∏è by a solo dev<br>
            Shortcuts: M = Mute, S = Save
        </div>
    </div>

    <section class="resources-panel">
        <div class="resource-item">
            <div class="resource-icon">üî©</div>
            <div class="resource-amount" id="componentsDisplay">0</div>
            <div class="resource-rate" id="componentsRate">(+0/sec)</div>
            <div class="resource-label">Components</div>
        </div>
        <div class="resource-item">
            <div class="resource-icon">‚öôÔ∏è</div>
            <div class="resource-amount" id="widgetsDisplay">0</div>
            <div class="resource-rate" id="widgetsRate">(+0/sec)</div>
            <div class="resource-label">Widgets</div>
        </div>
        <div class="resource-item">
            <div class="resource-icon">üíé</div>
            <div class="resource-amount" id="prototypesDisplay">0</div>
            <div class="resource-rate" id="prototypesRate">(+0/sec)</div>
            <div class="resource-label">Prototypes</div>
        </div>
        <div class="resource-item">
            <div class="resource-icon">üìê</div>
            <div class="resource-amount" id="blueprintsDisplay">0</div>
            <div class="resource-rate" id="blueprintsBonus">(+0% bonus)</div>
            <div class="resource-label">Blueprints</div>
        </div>
    </section>

    <section class="click-area">
        <button class="main-button" id="mainClickBtn">
            üîß Click to Build
            <span class="click-value" id="clickValue">+1 per click</span>
        </button>
    </section>

    <nav class="tab-nav">
        <button class="tab-btn active" data-tab="buildings">üèóÔ∏è Buildings</button>
        <button class="tab-btn" data-tab="upgrades">‚¨ÜÔ∏è Upgrades</button>
        <button class="tab-btn" data-tab="prestige">üìê Prestige</button>
        <button class="tab-btn" data-tab="achievements">üèÜ Achievements</button>
        <button class="tab-btn" data-tab="stats">üìä Stats</button>
    </nav>

    <main class="main-content">
        <section class="panel active" id="buildingsPanel">
            <div class="panel-header">
                <span>üèóÔ∏è Production Buildings</span>
                <span id="totalProduction">0/sec</span>
            </div>
            <div class="panel-content" id="buildingsList"></div>
        </section>

        <section class="panel" id="upgradesPanel">
            <div class="panel-header">
                <span>‚¨ÜÔ∏è Upgrades</span>
                <span id="upgradeCount">0/0</span>
            </div>
            <div class="panel-content" id="upgradesList"></div>
        </section>

        <section class="panel" id="prestigePanel">
            <div class="panel-header">
                <span>üìê Prestige Upgrades</span>
                <span id="prestigeUpgradeCount">0/0</span>
            </div>
            <div class="panel-content" id="prestigeUpgradesList"></div>
        </section>

        <section class="panel" id="achievementsPanel">
            <div class="panel-header">
                <span>üèÜ Achievements</span>
                <span id="achievementCount">0/0</span>
            </div>
            <div class="panel-content" id="achievementsList"></div>
        </section>

        <section class="panel" id="statsPanel">
            <div class="panel-header">
                <span>üìä Statistics</span>
            </div>
            <div class="panel-content" id="statsList"></div>
        </section>
    </main>

    <footer class="prestige-area">
        <div class="prestige-info">
            <div>Factory Reset Available</div>
            <div class="prestige-available" id="prestigeAvailable">0 üìê Blueprints</div>
        </div>
        <button class="prestige-btn" id="prestigeBtn" disabled>
            üîÑ Factory Reset
        </button>
    </footer>

    <div class="toast-container" id="toastContainer"></div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modal">
            <h2 id="modalTitle">Confirm</h2>
            <p id="modalMessage">Are you sure?</p>
            <div id="modalContent"></div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="modalCancel">Cancel</button>
                <button class="modal-btn confirm" id="modalConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <script>
    // ============================================================
    // IDLE FACTORY - A lovingly crafted incremental game
    // ============================================================

    // Decimal shorthand for break_infinity.js
    const D = (val) => new Decimal(val);

    // ============================================================
    // AUDIO ENGINE - Procedural sound synthesis
    // ============================================================
    class AudioEngine {
        constructor() {
            this.ctx = null;
            this.masterGain = null;
            this.initialized = false;
            this.muted = false;
            this.volume = 0.5;
        }

        init() {
            if (this.initialized) return;
            try {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.masterGain = this.ctx.createGain();
                this.masterGain.connect(this.ctx.destination);
                this.masterGain.gain.value = this.volume;
                this.initialized = true;
            } catch (e) {
                console.warn('Web Audio not supported');
            }
        }

        setVolume(vol) {
            this.volume = vol;
            if (this.masterGain) {
                this.masterGain.gain.value = this.muted ? 0 : vol;
            }
        }

        toggleMute() {
            this.muted = !this.muted;
            if (this.masterGain) {
                this.masterGain.gain.value = this.muted ? 0 : this.volume;
            }
            return this.muted;
        }

        // Soft click sound for main button
        playClick() {
            if (!this.initialized || this.muted) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain);
            gain.connect(this.masterGain);
            osc.frequency.setValueAtTime(800, this.ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(400, this.ctx.currentTime + 0.05);
            gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.08);
            osc.start();
            osc.stop(this.ctx.currentTime + 0.08);
        }

        // Ka-ching for purchases
        playPurchase() {
            if (!this.initialized || this.muted) return;
            const osc1 = this.ctx.createOscillator();
            const osc2 = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc1.connect(gain);
            osc2.connect(gain);
            gain.connect(this.masterGain);
            osc1.frequency.setValueAtTime(1200, this.ctx.currentTime);
            osc1.frequency.exponentialRampToValueAtTime(1800, this.ctx.currentTime + 0.05);
            osc2.frequency.setValueAtTime(1500, this.ctx.currentTime + 0.05);
            osc2.frequency.exponentialRampToValueAtTime(2000, this.ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.08, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.15);
            osc1.start();
            osc2.start(this.ctx.currentTime + 0.05);
            osc1.stop(this.ctx.currentTime + 0.08);
            osc2.stop(this.ctx.currentTime + 0.15);
        }

        // Whoosh for upgrades
        playUpgrade() {
            if (!this.initialized || this.muted) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = 'sine';
            osc.connect(gain);
            gain.connect(this.masterGain);
            osc.frequency.setValueAtTime(200, this.ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(800, this.ctx.currentTime + 0.2);
            gain.gain.setValueAtTime(0.06, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.25);
            osc.start();
            osc.stop(this.ctx.currentTime + 0.25);
        }

        // Achievement unlocked
        playAchievement() {
            if (!this.initialized || this.muted) return;
            const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
            notes.forEach((freq, i) => {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.connect(gain);
                gain.connect(this.masterGain);
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime + i * 0.1);
                gain.gain.setValueAtTime(0.08, this.ctx.currentTime + i * 0.1);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + i * 0.1 + 0.3);
                osc.start(this.ctx.currentTime + i * 0.1);
                osc.stop(this.ctx.currentTime + i * 0.1 + 0.3);
            });
        }

        // Prestige sound - layered rising tones
        playPrestige() {
            if (!this.initialized || this.muted) return;
            for (let i = 0; i < 5; i++) {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = i % 2 === 0 ? 'sine' : 'triangle';
                osc.connect(gain);
                gain.connect(this.masterGain);
                const startFreq = 200 + i * 100;
                osc.frequency.setValueAtTime(startFreq, this.ctx.currentTime + i * 0.1);
                osc.frequency.exponentialRampToValueAtTime(startFreq * 2, this.ctx.currentTime + i * 0.1 + 0.4);
                gain.gain.setValueAtTime(0.05, this.ctx.currentTime + i * 0.1);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + i * 0.1 + 0.5);
                osc.start(this.ctx.currentTime + i * 0.1);
                osc.stop(this.ctx.currentTime + i * 0.1 + 0.5);
            }
        }

        // Golden gear collect
        playGoldenGear() {
            if (!this.initialized || this.muted) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = 'sine';
            osc.connect(gain);
            gain.connect(this.masterGain);
            osc.frequency.setValueAtTime(880, this.ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1760, this.ctx.currentTime + 0.1);
            osc.frequency.exponentialRampToValueAtTime(880, this.ctx.currentTime + 0.2);
            gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.3);
            osc.start();
            osc.stop(this.ctx.currentTime + 0.3);
        }

        // Subtle tick for milestones
        playTick() {
            if (!this.initialized || this.muted) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = 'sine';
            osc.connect(gain);
            gain.connect(this.masterGain);
            osc.frequency.setValueAtTime(1000, this.ctx.currentTime);
            gain.gain.setValueAtTime(0.03, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.03);
            osc.start();
            osc.stop(this.ctx.currentTime + 0.03);
        }
    }

    const audio = new AudioEngine();

    // ============================================================
    // NUMBER FORMATTING
    // ============================================================
    const SUFFIXES = ['', 'K', 'M', 'B', 'T', 'Qa', 'Qi', 'Sx', 'Sp', 'Oc', 'No', 'Dc'];

    function formatNumber(num, forceScientific = false) {
        if (!(num instanceof Decimal)) num = D(num);
        if (num.lt(0)) return '-' + formatNumber(num.neg());
        if (num.eq(0)) return '0';
        if (num.lt(1000)) return num.toFixed(num.lt(10) ? 2 : 1).replace(/\.?0+$/, '');

        const format = document.getElementById('numberFormat')?.value || 'scientific';

        if (format === 'suffix' && !forceScientific && num.lt(1e36)) {
            const exp = Math.floor(num.log10().toNumber());
            const tier = Math.floor(exp / 3);
            if (tier < SUFFIXES.length) {
                const scaled = num.div(Decimal.pow(10, tier * 3));
                return scaled.toFixed(2).replace(/\.?0+$/, '') + SUFFIXES[tier];
            }
        }

        if (num.lt(1e6)) {
            const scaled = num.div(1000);
            return scaled.toFixed(2).replace(/\.?0+$/, '') + 'K';
        }

        const exp = num.log10().floor();
        const mantissa = num.div(Decimal.pow(10, exp));
        return mantissa.toFixed(2) + 'e' + exp.toString();
    }

    function formatTime(seconds) {
        if (seconds < 60) return Math.floor(seconds) + 's';
        if (seconds < 3600) return Math.floor(seconds / 60) + 'm ' + Math.floor(seconds % 60) + 's';
        if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ' + Math.floor((seconds % 3600) / 60) + 'm';
        return Math.floor(seconds / 86400) + 'd ' + Math.floor((seconds % 86400) / 3600) + 'h';
    }

    // ============================================================
    // BUILDING DEFINITIONS
    // ============================================================
    const BUILDINGS = [
        {
            id: 'workbench',
            name: 'Workbench',
            icon: 'üîß',
            baseCost: D(10),
            baseProduction: D(1),
            costMultiplier: 1.15,
            description: 'A humble beginning. Hand-craft components one bolt at a time.',
            flavor: 'Every empire starts with a single screw.',
            unlockCondition: () => true
        },
        {
            id: 'conveyor',
            name: 'Conveyor Belt',
            icon: 'üèóÔ∏è',
            baseCost: D(100),
            baseProduction: D(5),
            costMultiplier: 1.15,
            description: 'Automated belt system moves parts along the line.',
            flavor: 'The factory floor\'s first taste of automation.',
            unlockCondition: () => game.buildings.workbench >= 5
        },
        {
            id: 'assemblyBot',
            name: 'Assembly Bot',
            icon: 'ü§ñ',
            baseCost: D(1100),
            baseProduction: D(25),
            costMultiplier: 1.15,
            description: 'Tireless robotic arms work around the clock.',
            flavor: 'Beep boop. I am efficiency incarnate.',
            unlockCondition: () => game.buildings.conveyor >= 5
        },
        {
            id: 'miniFactory',
            name: 'Mini Factory',
            icon: 'üè≠',
            baseCost: D(12000),
            baseProduction: D(150),
            costMultiplier: 1.15,
            description: 'A factory within a factory. Production inception.',
            flavor: 'Yo dawg, I heard you like factories...',
            unlockCondition: () => game.buildings.assemblyBot >= 5
        },
        {
            id: 'powerPlant',
            name: 'Power Plant',
            icon: '‚ö°',
            baseCost: D(130000),
            baseProduction: D(800),
            costMultiplier: 1.15,
            description: 'Provides energy boost to all production lines.',
            flavor: 'With great power comes great productivity.',
            unlockCondition: () => game.buildings.miniFactory >= 5
        },
        {
            id: 'researchLab',
            name: 'Research Lab',
            icon: 'üî¨',
            baseCost: D(1400000),
            baseProduction: D(4500),
            costMultiplier: 1.15,
            description: 'Scientists optimize processes and unlock secrets.',
            flavor: 'The white coats are working on something big.',
            unlockCondition: () => game.buildings.powerPlant >= 5
        },
        {
            id: 'distributionHub',
            name: 'Distribution Hub',
            icon: 'üåê',
            baseCost: D(20000000),
            baseProduction: D(25000),
            costMultiplier: 1.15,
            description: 'Global logistics network amplifies output.',
            flavor: 'From here, our reach extends everywhere.',
            unlockCondition: () => game.buildings.researchLab >= 5
        },
        {
            id: 'launchPad',
            name: 'Launch Pad',
            icon: 'üöÄ',
            baseCost: D(330000000),
            baseProduction: D(150000),
            costMultiplier: 1.15,
            description: 'Space-age manufacturing. The final frontier.',
            flavor: 'Houston, we have... incredible production rates.',
            unlockCondition: () => game.buildings.distributionHub >= 5
        },
        {
            id: 'quantumForge',
            name: 'Quantum Forge',
            icon: '‚öõÔ∏è',
            baseCost: D(5100000000),
            baseProduction: D(1000000),
            costMultiplier: 1.15,
            description: 'Harness quantum mechanics to produce in superposition.',
            flavor: 'It both works and doesn\'t until you check.',
            unlockCondition: () => game.buildings.launchPad >= 5
        },
        {
            id: 'dimensionalRift',
            name: 'Dimensional Rift',
            icon: 'üåÄ',
            baseCost: D(75000000000),
            baseProduction: D(6500000),
            costMultiplier: 1.15,
            description: 'Pull components from alternate realities.',
            flavor: 'Infinite dimensions means infinite components.',
            unlockCondition: () => game.buildings.quantumForge >= 5
        },
        {
            id: 'cosmicFoundry',
            name: 'Cosmic Foundry',
            icon: '‚ú®',
            baseCost: D(1e12),
            baseProduction: D(50000000),
            costMultiplier: 1.15,
            description: 'Forge components from the fabric of spacetime.',
            flavor: 'We ARE the universe making things now.',
            unlockCondition: () => game.buildings.dimensionalRift >= 5
        },
        {
            id: 'realityEngine',
            name: 'Reality Engine',
            icon: 'üé≠',
            baseCost: D(2e13),
            baseProduction: D(400000000),
            costMultiplier: 1.15,
            description: 'Rewrite the laws of physics for optimal output.',
            flavor: 'Physics? More like suggestions.',
            unlockCondition: () => game.buildings.cosmicFoundry >= 5
        }
    ];

    // ============================================================
    // UPGRADE DEFINITIONS
    // ============================================================
    const UPGRADES = [
        // Workbench upgrades
        { id: 'wb1', name: 'Ergonomic Tools', icon: 'üõ†Ô∏è', building: 'workbench', cost: D(100), costType: 'components', multiplier: 2, description: 'Double workbench output', flavor: 'Comfort breeds productivity.', requires: () => game.buildings.workbench >= 1 },
        { id: 'wb2', name: 'Tool Organization', icon: 'üóÑÔ∏è', building: 'workbench', cost: D(500), costType: 'components', multiplier: 2, description: 'Double workbench output', flavor: 'A place for everything.', requires: () => game.upgrades.includes('wb1') },
        { id: 'wb3', name: 'Power Tools', icon: 'üîå', building: 'workbench', cost: D(5000), costType: 'components', multiplier: 2, description: 'Double workbench output', flavor: 'Vrrrrrrrm.', requires: () => game.upgrades.includes('wb2') },
        { id: 'wb4', name: 'Master Craftsman', icon: 'üë∑', building: 'workbench', cost: D(50000), costType: 'components', multiplier: 2, description: 'Double workbench output', flavor: '10,000 hours of practice pays off.', requires: () => game.upgrades.includes('wb3') },
        { id: 'wb5', name: 'Legendary Bench', icon: 'üèÜ', building: 'workbench', cost: D(5e8), costType: 'components', multiplier: 5, description: '5x workbench output', flavor: 'Passed down through generations.', requires: () => game.upgrades.includes('wb4') },

        // Conveyor upgrades
        { id: 'cv1', name: 'Faster Belts', icon: '‚è©', building: 'conveyor', cost: D(1000), costType: 'components', multiplier: 2, description: 'Double conveyor output', flavor: 'Gotta go fast.', requires: () => game.buildings.conveyor >= 1 },
        { id: 'cv2', name: 'Multi-lane', icon: 'üõ§Ô∏è', building: 'conveyor', cost: D(5000), costType: 'components', multiplier: 2, description: 'Double conveyor output', flavor: 'Why have one lane when you can have four?', requires: () => game.upgrades.includes('cv1') },
        { id: 'cv3', name: 'Smart Sorting', icon: 'üìä', building: 'conveyor', cost: D(50000), costType: 'components', multiplier: 2, description: 'Double conveyor output', flavor: 'The belt knows what you need.', requires: () => game.upgrades.includes('cv2') },
        { id: 'cv4', name: 'Hyperloop Belt', icon: 'üöÑ', building: 'conveyor', cost: D(5e8), costType: 'components', multiplier: 3, description: '3x conveyor output', flavor: 'Breaking the sound barrier (indoors).', requires: () => game.upgrades.includes('cv3') },

        // Assembly Bot upgrades
        { id: 'ab1', name: 'AI Integration', icon: 'üß†', building: 'assemblyBot', cost: D(11000), costType: 'components', multiplier: 2, description: 'Double assembly bot output', flavor: 'They\'re learning...', requires: () => game.buildings.assemblyBot >= 1 },
        { id: 'ab2', name: 'Extra Arms', icon: 'ü¶æ', building: 'assemblyBot', cost: D(55000), costType: 'components', multiplier: 2, description: 'Double assembly bot output', flavor: 'More arms = more productivity.', requires: () => game.upgrades.includes('ab1') },
        { id: 'ab3', name: 'Swarm Protocol', icon: 'üêù', building: 'assemblyBot', cost: D(5e8), costType: 'components', multiplier: 3, description: '3x assembly bot output', flavor: 'Many bots, one purpose.', requires: () => game.upgrades.includes('ab2') },

        // Mini Factory upgrades
        { id: 'mf1', name: 'Lean Manufacturing', icon: 'üìè', building: 'miniFactory', cost: D(120000), costType: 'components', multiplier: 2, description: 'Double mini factory output', flavor: 'Trim the fat.', requires: () => game.buildings.miniFactory >= 1 },
        { id: 'mf2', name: 'Night Shift', icon: 'üåô', building: 'miniFactory', cost: D(600000), costType: 'components', multiplier: 2, description: 'Double mini factory output', flavor: 'The factory never sleeps.', requires: () => game.upgrades.includes('mf1') },
        { id: 'mf3', name: 'Factory Network', icon: 'üîó', building: 'miniFactory', cost: D(5e9), costType: 'components', multiplier: 3, description: '3x mini factory output', flavor: 'United we produce.', requires: () => game.upgrades.includes('mf2') },

        // Power Plant upgrades
        { id: 'pp1', name: 'Fusion Core', icon: '‚ò¢Ô∏è', building: 'powerPlant', cost: D(1300000), costType: 'components', multiplier: 2, description: 'Double power plant output', flavor: 'Clean, unlimited energy.', requires: () => game.buildings.powerPlant >= 1 },
        { id: 'pp2', name: 'Grid Optimization', icon: '‚ö°', building: 'powerPlant', cost: D(1.3e7), costType: 'components', multiplier: 2, description: 'Double power plant output', flavor: 'Zero waste, maximum power.', requires: () => game.upgrades.includes('pp1') },
        { id: 'pp3', name: 'Antimatter Reactor', icon: 'üí•', building: 'powerPlant', cost: D(1e10), costType: 'components', multiplier: 3, description: '3x power plant output', flavor: 'Handle with extreme care.', requires: () => game.upgrades.includes('pp2') },

        // Research Lab upgrades
        { id: 'rl1', name: 'Eureka Moments', icon: 'üí°', building: 'researchLab', cost: D(14000000), costType: 'components', multiplier: 2, description: 'Double research lab output', flavor: 'The best ideas come in the shower.', requires: () => game.buildings.researchLab >= 1 },
        { id: 'rl2', name: 'Peer Review', icon: 'üìù', building: 'researchLab', cost: D(1.4e8), costType: 'components', multiplier: 2, description: 'Double research lab output', flavor: 'Actually, your hypothesis is wrong.', requires: () => game.upgrades.includes('rl1') },
        { id: 'rl3', name: 'Nobel Prize', icon: 'üèÖ', building: 'researchLab', cost: D(1e11), costType: 'components', multiplier: 3, description: '3x research lab output', flavor: 'Recognition is nice, but funding is better.', requires: () => game.upgrades.includes('rl2') },

        // Distribution Hub upgrades
        { id: 'dh1', name: 'Drone Delivery', icon: 'üõ∏', building: 'distributionHub', cost: D(200000000), costType: 'components', multiplier: 2, description: 'Double distribution hub output', flavor: 'Buzzing through the skies.', requires: () => game.buildings.distributionHub >= 1 },
        { id: 'dh2', name: 'Teleportation', icon: 'üåÄ', building: 'distributionHub', cost: D(2e9), costType: 'components', multiplier: 2, description: 'Double distribution hub output', flavor: 'Instant delivery. Literally.', requires: () => game.upgrades.includes('dh1') },
        { id: 'dh3', name: 'Time Shipping', icon: '‚è∞', building: 'distributionHub', cost: D(2e12), costType: 'components', multiplier: 3, description: '3x distribution hub output', flavor: 'Delivered yesterday.', requires: () => game.upgrades.includes('dh2') },

        // Launch Pad upgrades
        { id: 'lp1', name: 'Reusable Rockets', icon: '‚ôªÔ∏è', building: 'launchPad', cost: D(3.3e9), costType: 'components', multiplier: 2, description: 'Double launch pad output', flavor: 'Reduce, reuse, relaunch.', requires: () => game.buildings.launchPad >= 1 },
        { id: 'lp2', name: 'Orbital Factory', icon: 'üõ∞Ô∏è', building: 'launchPad', cost: D(3.3e10), costType: 'components', multiplier: 2, description: 'Double launch pad output', flavor: 'Zero gravity manufacturing.', requires: () => game.upgrades.includes('lp1') },
        { id: 'lp3', name: 'Dyson Sphere', icon: '‚òÄÔ∏è', building: 'launchPad', cost: D(3e13), costType: 'components', multiplier: 3, description: '3x launch pad output', flavor: 'The ultimate power source.', requires: () => game.upgrades.includes('lp2') },

        // Quantum Forge upgrades
        { id: 'qf1', name: 'Entanglement', icon: 'üîó', building: 'quantumForge', cost: D(5e10), costType: 'components', multiplier: 2, description: 'Double quantum forge output', flavor: 'Spooky action at a distance.', requires: () => game.buildings.quantumForge >= 1 },
        { id: 'qf2', name: 'Superposition', icon: '‚öõÔ∏è', building: 'quantumForge', cost: D(5e11), costType: 'components', multiplier: 2, description: 'Double quantum forge output', flavor: 'Make everything at once.', requires: () => game.upgrades.includes('qf1') },

        // Dimensional Rift upgrades
        { id: 'dr1', name: 'Rift Expansion', icon: 'üåå', building: 'dimensionalRift', cost: D(7.5e11), costType: 'components', multiplier: 2, description: 'Double dimensional rift output', flavor: 'Bigger portal, more stuff.', requires: () => game.buildings.dimensionalRift >= 1 },
        { id: 'dr2', name: 'Multiverse Mining', icon: '‚õèÔ∏è', building: 'dimensionalRift', cost: D(7.5e12), costType: 'components', multiplier: 2, description: 'Double dimensional rift output', flavor: 'Every reality has resources.', requires: () => game.upgrades.includes('dr1') },

        // Global upgrades
        { id: 'click1', name: 'Stronger Hands', icon: '‚úä', building: 'click', cost: D(50), costType: 'components', multiplier: 2, description: 'Double click value', flavor: 'Gym membership paying off.', requires: () => true },
        { id: 'click2', name: 'Mechanical Clicker', icon: 'üñ±Ô∏è', building: 'click', cost: D(1000), costType: 'components', multiplier: 2, description: 'Double click value', flavor: 'Auto-clicking the legal way.', requires: () => game.upgrades.includes('click1') },
        { id: 'click3', name: 'Click Fusion', icon: 'üí•', building: 'click', cost: D(50000), costType: 'components', multiplier: 5, description: '5x click value', flavor: 'Every click is a small explosion.', requires: () => game.upgrades.includes('click2') },
        { id: 'click4', name: 'Finger of God', icon: 'üëÜ', building: 'click', cost: D(5e7), costType: 'components', multiplier: 10, description: '10x click value', flavor: 'Divine intervention.', requires: () => game.upgrades.includes('click3') },
        { id: 'click5', name: 'Click Singularity', icon: 'üï≥Ô∏è', building: 'click', cost: D(5e10), costType: 'components', multiplier: 100, description: '100x click value', flavor: 'One click to rule them all.', requires: () => game.upgrades.includes('click4') },

        // Synergy upgrades
        { id: 'syn1', name: 'Cross-Training', icon: 'üîÑ', building: 'all', cost: D(5000), costType: 'components', multiplier: 1.1, description: '+10% to all production', flavor: 'Learn from each other.', requires: () => game.buildings.conveyor >= 5 },
        { id: 'syn2', name: 'Supply Chain', icon: 'üì¶', building: 'all', cost: D(100000), costType: 'components', multiplier: 1.15, description: '+15% to all production', flavor: 'Everything flows smoothly.', requires: () => game.upgrades.includes('syn1') },
        { id: 'syn3', name: 'Vertical Integration', icon: 'üìà', building: 'all', cost: D(5e6), costType: 'components', multiplier: 1.25, description: '+25% to all production', flavor: 'Own the whole pipeline.', requires: () => game.upgrades.includes('syn2') },
        { id: 'syn4', name: 'Industrial Revolution', icon: 'üèõÔ∏è', building: 'all', cost: D(1e9), costType: 'components', multiplier: 1.5, description: '+50% to all production', flavor: 'A new era dawns.', requires: () => game.upgrades.includes('syn3') },
        { id: 'syn5', name: 'Singularity', icon: 'üåü', building: 'all', cost: D(1e12), costType: 'components', multiplier: 2, description: '2x all production', flavor: 'We have become one.', requires: () => game.upgrades.includes('syn4') },

        // Widget-related upgrades
        { id: 'wid1', name: 'Widget Workshop', icon: '‚öôÔ∏è', building: 'widget', cost: D(1e6), costType: 'components', multiplier: 1, description: 'Unlock widget production', flavor: 'Time to diversify.', requires: () => game.totalComponents.gte(1e5) },
        { id: 'wid2', name: 'Widget Efficiency', icon: 'üìê', building: 'widget', cost: D(10), costType: 'widgets', multiplier: 2, description: 'Double widget production', flavor: 'Work smarter.', requires: () => game.upgrades.includes('wid1') && game.widgets.gte(5) },
        { id: 'wid3', name: 'Widget Mastery', icon: 'üéì', building: 'widget', cost: D(100), costType: 'widgets', multiplier: 2, description: 'Double widget production', flavor: 'PhD in widgetology.', requires: () => game.upgrades.includes('wid2') },

        // Automation upgrades
        { id: 'auto1', name: 'Auto-buyer: Workbench', icon: 'ü§ñ', building: 'automation', cost: D(1e8), costType: 'components', multiplier: 1, description: 'Automatically buys workbenches', flavor: 'Set it and forget it.', requires: () => game.buildings.workbench >= 50 },
        { id: 'auto2', name: 'Offline Boost I', icon: 'üò¥', building: 'offline', cost: D(1e9), costType: 'components', multiplier: 1.25, description: 'Increase offline efficiency to 25%', flavor: 'Your factory works while you sleep.', requires: () => game.totalOfflineTime > 3600 },
        { id: 'auto3', name: 'Offline Boost II', icon: 'üåô', building: 'offline', cost: D(1e11), costType: 'components', multiplier: 1.5, description: 'Increase offline efficiency to 50%', flavor: 'Dreaming of production.', requires: () => game.upgrades.includes('auto2') },
        { id: 'auto4', name: 'Offline Cap +4h', icon: '‚è∞', building: 'offlineCap', cost: D(1e10), costType: 'components', multiplier: 4, description: 'Increase offline cap by 4 hours', flavor: 'Extended vacation allowed.', requires: () => game.totalOfflineTime > 14400 },

        // Bonus structures
        { id: 'bonus1', name: 'Golden Touch', icon: '‚ú®', building: 'goldenGear', cost: D(1e7), costType: 'components', multiplier: 2, description: 'Double golden gear rewards', flavor: 'Midas would be proud.', requires: () => game.goldenGearsClicked >= 5 },
        { id: 'bonus2', name: 'Lucky Star', icon: 'üçÄ', building: 'goldenGear', cost: D(1e9), costType: 'components', multiplier: 1.5, description: 'Golden gears appear 50% more often', flavor: 'Fortune favors the prepared.', requires: () => game.upgrades.includes('bonus1') },
    ];

    // ============================================================
    // PRESTIGE UPGRADE DEFINITIONS
    // ============================================================
    const PRESTIGE_UPGRADES = [
        { id: 'pu1', name: 'Head Start', icon: 'üèÉ', cost: 5, description: 'Start with 5 workbenches after reset', flavor: 'Hit the ground running.', requires: () => true },
        { id: 'pu2', name: 'Early Automation', icon: '‚ö°', cost: 10, description: 'Start with 3 conveyor belts', flavor: 'Skip the manual labor phase.', requires: () => game.prestigeUpgrades.includes('pu1') },
        { id: 'pu3', name: 'Efficiency Expert', icon: 'üìà', cost: 15, description: '+25% base production', flavor: 'Experience makes everything easier.', requires: () => game.prestigeUpgrades.includes('pu2') },
        { id: 'pu4', name: 'Click Legacy', icon: 'üëÜ', cost: 20, description: 'Clicks gain +1% of production/sec', flavor: 'Your clicks echo through resets.', requires: () => game.prestigeUpgrades.includes('pu1') },
        { id: 'pu5', name: 'Blueprint Bonus', icon: 'üìê', cost: 25, description: '+50% blueprint gain', flavor: 'Better planning yields better results.', requires: () => game.prestigeUpgrades.includes('pu3') },
        { id: 'pu6', name: 'Offline Dynasty', icon: 'üåô', cost: 30, description: '+4 hours offline cap', flavor: 'Your legacy continues while you rest.', requires: () => game.prestigeUpgrades.includes('pu3') },
        { id: 'pu7', name: 'Golden Age', icon: '‚≠ê', cost: 35, description: 'Golden gears 2x more common', flavor: 'The stars align in your favor.', requires: () => game.prestigeUpgrades.includes('pu1') },
        { id: 'pu8', name: 'Production Titan', icon: 'üèõÔ∏è', cost: 50, description: '+100% base production', flavor: 'You have become legend.', requires: () => game.prestigeUpgrades.includes('pu3') && game.prestigeUpgrades.includes('pu5') },
        { id: 'pu9', name: 'Transcendence', icon: '‚ú®', cost: 100, description: 'All multipliers +10%', flavor: 'Beyond mortal limits.', requires: () => game.prestigeUpgrades.includes('pu8') },
        { id: 'pu10', name: 'Eternal Factory', icon: '‚ôæÔ∏è', cost: 200, description: '3x all production', flavor: 'Your factory transcends time itself.', requires: () => game.prestigeUpgrades.includes('pu9') },
    ];

    // ============================================================
    // ACHIEVEMENT DEFINITIONS
    // ============================================================
    const ACHIEVEMENTS = [
        // Component milestones
        { id: 'comp1', name: 'First Component', icon: 'üî©', tier: 'bronze', description: 'Produce 1 component', bonus: 0.01, check: () => game.totalComponents.gte(1) },
        { id: 'comp2', name: 'Getting Started', icon: 'üî©', tier: 'bronze', description: 'Produce 100 components', bonus: 0.01, check: () => game.totalComponents.gte(100) },
        { id: 'comp3', name: 'Production Line', icon: 'üî©', tier: 'silver', description: 'Produce 10,000 components', bonus: 0.02, check: () => game.totalComponents.gte(1e4) },
        { id: 'comp4', name: 'Mass Production', icon: 'üî©', tier: 'silver', description: 'Produce 1 million components', bonus: 0.02, check: () => game.totalComponents.gte(1e6) },
        { id: 'comp5', name: 'Industrial Giant', icon: 'üî©', tier: 'gold', description: 'Produce 1 billion components', bonus: 0.05, check: () => game.totalComponents.gte(1e9) },
        { id: 'comp6', name: 'Component Emperor', icon: 'üî©', tier: 'gold', description: 'Produce 1 trillion components', bonus: 0.05, check: () => game.totalComponents.gte(1e12) },
        { id: 'comp7', name: 'Universal Factory', icon: 'üî©', tier: 'gold', description: 'Produce 1e20 components', bonus: 0.1, check: () => game.totalComponents.gte(1e20) },

        // Click milestones
        { id: 'click1', name: 'Finger Exercise', icon: 'üëÜ', tier: 'bronze', description: 'Click 10 times', bonus: 0.01, check: () => game.totalClicks >= 10 },
        { id: 'click2', name: 'Click Apprentice', icon: 'üëÜ', tier: 'bronze', description: 'Click 100 times', bonus: 0.01, check: () => game.totalClicks >= 100 },
        { id: 'click3', name: 'Click Master', icon: 'üëÜ', tier: 'silver', description: 'Click 1,000 times', bonus: 0.02, check: () => game.totalClicks >= 1000 },
        { id: 'click4', name: 'Click Legend', icon: 'üëÜ', tier: 'gold', description: 'Click 10,000 times', bonus: 0.05, check: () => game.totalClicks >= 10000 },

        // Building milestones
        { id: 'build1', name: 'First Steps', icon: 'üèóÔ∏è', tier: 'bronze', description: 'Own 10 buildings total', bonus: 0.01, check: () => getTotalBuildings() >= 10 },
        { id: 'build2', name: 'Construction Crew', icon: 'üèóÔ∏è', tier: 'silver', description: 'Own 50 buildings total', bonus: 0.02, check: () => getTotalBuildings() >= 50 },
        { id: 'build3', name: 'Building Empire', icon: 'üèóÔ∏è', tier: 'gold', description: 'Own 200 buildings total', bonus: 0.05, check: () => getTotalBuildings() >= 200 },
        { id: 'build4', name: 'Mega Corporation', icon: 'üèóÔ∏è', tier: 'gold', description: 'Own 500 buildings total', bonus: 0.1, check: () => getTotalBuildings() >= 500 },

        // Upgrade milestones
        { id: 'upg1', name: 'Upgrade Curious', icon: '‚¨ÜÔ∏è', tier: 'bronze', description: 'Purchase 5 upgrades', bonus: 0.01, check: () => game.upgrades.length >= 5 },
        { id: 'upg2', name: 'Upgrade Enthusiast', icon: '‚¨ÜÔ∏è', tier: 'silver', description: 'Purchase 15 upgrades', bonus: 0.02, check: () => game.upgrades.length >= 15 },
        { id: 'upg3', name: 'Upgrade Collector', icon: '‚¨ÜÔ∏è', tier: 'gold', description: 'Purchase 30 upgrades', bonus: 0.05, check: () => game.upgrades.length >= 30 },

        // Time milestones
        { id: 'time1', name: 'Coffee Break', icon: '‚òï', tier: 'bronze', description: 'Play for 10 minutes', bonus: 0.01, check: () => game.totalPlayTime >= 600 },
        { id: 'time2', name: 'Lunch Hour', icon: 'üçî', tier: 'silver', description: 'Play for 1 hour', bonus: 0.02, check: () => game.totalPlayTime >= 3600 },
        { id: 'time3', name: 'Workaholic', icon: 'üíº', tier: 'gold', description: 'Play for 8 hours', bonus: 0.05, check: () => game.totalPlayTime >= 28800 },
        { id: 'time4', name: 'Dedicated', icon: 'üèÜ', tier: 'gold', description: 'Play for 24 hours', bonus: 0.1, check: () => game.totalPlayTime >= 86400 },

        // Prestige milestones
        { id: 'pres1', name: 'Fresh Start', icon: 'üîÑ', tier: 'silver', description: 'Perform first prestige', bonus: 0.05, check: () => game.totalPrestiges >= 1 },
        { id: 'pres2', name: 'Experienced', icon: 'üîÑ', tier: 'gold', description: 'Perform 5 prestiges', bonus: 0.1, check: () => game.totalPrestiges >= 5 },
        { id: 'pres3', name: 'Prestige Master', icon: 'üîÑ', tier: 'gold', description: 'Perform 10 prestiges', bonus: 0.15, check: () => game.totalPrestiges >= 10 },

        // Special achievements
        { id: 'golden1', name: 'Lucky Find', icon: '‚≠ê', tier: 'bronze', description: 'Click a golden gear', bonus: 0.02, check: () => game.goldenGearsClicked >= 1 },
        { id: 'golden2', name: 'Golden Hunter', icon: '‚≠ê', tier: 'silver', description: 'Click 10 golden gears', bonus: 0.05, check: () => game.goldenGearsClicked >= 10 },
        { id: 'golden3', name: 'Golden Master', icon: '‚≠ê', tier: 'gold', description: 'Click 50 golden gears', bonus: 0.1, check: () => game.goldenGearsClicked >= 50 },

        // Hidden achievements
        { id: 'secret1', name: 'Night Owl', icon: 'ü¶â', tier: 'silver', description: 'Play at 3 AM', bonus: 0.05, check: () => new Date().getHours() === 3, hidden: true },
        { id: 'secret2', name: 'Speed Runner', icon: '‚ö°', tier: 'gold', description: 'Reach 1M components in under 10 minutes', bonus: 0.1, check: () => game.totalComponents.gte(1e6) && game.totalPlayTime < 600, hidden: true },
        { id: 'secret3', name: 'Perfectionist', icon: 'üíØ', tier: 'gold', description: 'Have exactly 100 of each building', bonus: 0.15, check: () => BUILDINGS.every(b => game.buildings[b.id] === 100), hidden: true },
    ];

    // ============================================================
    // GAME STATE
    // ============================================================
    function createInitialState() {
        return {
            components: D(0),
            widgets: D(0),
            prototypes: D(0),
            blueprints: 0,

            totalComponents: D(0),
            lifetimeComponents: D(0),

            buildings: {},
            upgrades: [],
            achievements: [],
            prestigeUpgrades: [],

            totalClicks: 0,
            totalPlayTime: 0,
            totalOfflineTime: 0,
            totalPrestiges: 0,
            goldenGearsClicked: 0,

            lastSaveTime: Date.now(),
            lastTickTime: Date.now(),
            gameStartTime: Date.now(),

            settings: {
                muted: false,
                volume: 0.5,
                numberFormat: 'scientific',
                buyAmount: '1'
            },

            // Active bonuses
            activeBonus: null,
            bonusEndTime: 0,

            // Stats
            highestComponents: D(0),
            fastestPrestige: Infinity,

            version: '1.0.0'
        };
    }

    let game = createInitialState();

    // Initialize buildings
    BUILDINGS.forEach(b => {
        game.buildings[b.id] = 0;
    });

    // ============================================================
    // CORE CALCULATIONS
    // ============================================================
    function getClickValue() {
        let base = D(1);

        // Click upgrades
        if (game.upgrades.includes('click1')) base = base.mul(2);
        if (game.upgrades.includes('click2')) base = base.mul(2);
        if (game.upgrades.includes('click3')) base = base.mul(5);
        if (game.upgrades.includes('click4')) base = base.mul(10);
        if (game.upgrades.includes('click5')) base = base.mul(100);

        // Blueprint bonus
        base = base.mul(1 + game.blueprints * 0.01);

        // Achievement bonus
        base = base.mul(1 + getAchievementBonus());

        // Click legacy prestige upgrade
        if (game.prestigeUpgrades.includes('pu4')) {
            base = base.add(getProductionPerSecond().mul(0.01));
        }

        // Active bonus
        if (game.activeBonus === 'production' && Date.now() < game.bonusEndTime) {
            base = base.mul(2);
        }

        return base;
    }

    function getBuildingCost(buildingId, amount = 1) {
        const building = BUILDINGS.find(b => b.id === buildingId);
        if (!building) return D(Infinity);

        const owned = game.buildings[buildingId] || 0;
        let totalCost = D(0);

        for (let i = 0; i < amount; i++) {
            const cost = building.baseCost.mul(Decimal.pow(building.costMultiplier, owned + i));
            totalCost = totalCost.add(cost);
        }

        return totalCost;
    }

    function getMaxAffordable(buildingId) {
        const building = BUILDINGS.find(b => b.id === buildingId);
        if (!building) return 0;

        const owned = game.buildings[buildingId] || 0;
        let count = 0;
        let totalCost = D(0);

        while (count < 1000) { // Safety limit
            const cost = building.baseCost.mul(Decimal.pow(building.costMultiplier, owned + count));
            if (totalCost.add(cost).gt(game.components)) break;
            totalCost = totalCost.add(cost);
            count++;
        }

        return count;
    }

    function getBuildingProduction(buildingId) {
        const building = BUILDINGS.find(b => b.id === buildingId);
        if (!building) return D(0);

        let production = building.baseProduction.mul(game.buildings[buildingId] || 0);

        // Apply building-specific upgrades
        UPGRADES.forEach(upg => {
            if (game.upgrades.includes(upg.id) && upg.building === buildingId) {
                production = production.mul(upg.multiplier);
            }
        });

        // Apply global upgrades
        UPGRADES.forEach(upg => {
            if (game.upgrades.includes(upg.id) && upg.building === 'all') {
                production = production.mul(upg.multiplier);
            }
        });

        // Prestige upgrades
        if (game.prestigeUpgrades.includes('pu3')) production = production.mul(1.25);
        if (game.prestigeUpgrades.includes('pu8')) production = production.mul(2);
        if (game.prestigeUpgrades.includes('pu9')) production = production.mul(1.1);
        if (game.prestigeUpgrades.includes('pu10')) production = production.mul(3);

        return production;
    }

    function getProductionPerSecond() {
        let total = D(0);

        BUILDINGS.forEach(b => {
            total = total.add(getBuildingProduction(b.id));
        });

        // Blueprint bonus
        total = total.mul(1 + game.blueprints * 0.01);

        // Achievement bonus
        total = total.mul(1 + getAchievementBonus());

        // Active bonus
        if (game.activeBonus === 'production' && Date.now() < game.bonusEndTime) {
            total = total.mul(2);
        }

        return total;
    }

    function getWidgetProductionPerSecond() {
        if (!game.upgrades.includes('wid1')) return D(0);

        let base = D(1);
        if (game.upgrades.includes('wid2')) base = base.mul(2);
        if (game.upgrades.includes('wid3')) base = base.mul(2);

        // Scale with component production
        base = base.mul(Decimal.log10(getProductionPerSecond().add(10)).div(10));

        return base;
    }

    function getAchievementBonus() {
        let bonus = 0;
        ACHIEVEMENTS.forEach(ach => {
            if (game.achievements.includes(ach.id)) {
                bonus += ach.bonus;
            }
        });
        return bonus;
    }

    function getTotalBuildings() {
        let total = 0;
        Object.values(game.buildings).forEach(count => {
            total += count;
        });
        return total;
    }

    function getPrestigeGain() {
        if (game.lifetimeComponents.lt(1e9)) return 0;

        let gain = Math.floor(game.lifetimeComponents.div(1e9).sqrt().toNumber());

        // Blueprint bonus prestige upgrade
        if (game.prestigeUpgrades.includes('pu5')) {
            gain = Math.floor(gain * 1.5);
        }

        return gain;
    }

    function getOfflineEfficiency() {
        let efficiency = 0.1; // Base 10%
        if (game.upgrades.includes('auto2')) efficiency = 0.25;
        if (game.upgrades.includes('auto3')) efficiency = 0.5;
        return efficiency;
    }

    function getOfflineCap() {
        let cap = 8 * 3600; // Base 8 hours in seconds
        if (game.upgrades.includes('auto4')) cap += 4 * 3600;
        if (game.prestigeUpgrades.includes('pu6')) cap += 4 * 3600;
        return cap;
    }

    // ============================================================
    // GAME ACTIONS
    // ============================================================
    function handleClick(event) {
        audio.init();

        const gained = getClickValue();
        game.components = game.components.add(gained);
        game.totalComponents = game.totalComponents.add(gained);
        game.lifetimeComponents = game.lifetimeComponents.add(gained);
        game.totalClicks++;

        audio.playClick();
        createClickParticle(event, gained);
        updateDisplay();
    }

    function buyBuilding(buildingId, amount = 1) {
        audio.init();

        const building = BUILDINGS.find(b => b.id === buildingId);
        if (!building || !building.unlockCondition()) return;

        if (amount === 'max') {
            amount = getMaxAffordable(buildingId);
        }

        const cost = getBuildingCost(buildingId, amount);
        if (game.components.gte(cost) && amount > 0) {
            game.components = game.components.sub(cost);
            game.buildings[buildingId] += amount;
            audio.playPurchase();
            updateDisplay();
        }
    }

    function buyUpgrade(upgradeId) {
        audio.init();

        const upgrade = UPGRADES.find(u => u.id === upgradeId);
        if (!upgrade || game.upgrades.includes(upgradeId) || !upgrade.requires()) return;

        const currency = upgrade.costType === 'widgets' ? game.widgets : game.components;
        if (currency.gte(upgrade.cost)) {
            if (upgrade.costType === 'widgets') {
                game.widgets = game.widgets.sub(upgrade.cost);
            } else {
                game.components = game.components.sub(upgrade.cost);
            }
            game.upgrades.push(upgradeId);
            audio.playUpgrade();
            showToast(`Upgrade purchased: ${upgrade.name}`, 'milestone');
            updateDisplay();
        }
    }

    function buyPrestigeUpgrade(upgradeId) {
        audio.init();

        const upgrade = PRESTIGE_UPGRADES.find(u => u.id === upgradeId);
        if (!upgrade || game.prestigeUpgrades.includes(upgradeId) || !upgrade.requires()) return;

        if (game.blueprints >= upgrade.cost) {
            game.blueprints -= upgrade.cost;
            game.prestigeUpgrades.push(upgradeId);
            audio.playUpgrade();
            showToast(`Prestige upgrade: ${upgrade.name}`, 'prestige');
            updateDisplay();
        }
    }

    function performPrestige() {
        const gain = getPrestigeGain();
        if (gain <= 0) return;

        audio.playPrestige();

        // Track prestige stats
        const prestigeTime = (Date.now() - game.gameStartTime) / 1000;
        if (prestigeTime < game.fastestPrestige) {
            game.fastestPrestige = prestigeTime;
        }
        game.totalPrestiges++;

        // Add blueprints
        game.blueprints += gain;

        // Reset game state but keep persistent things
        const keepSettings = { ...game.settings };
        const keepPrestiges = game.totalPrestiges;
        const keepBlueprints = game.blueprints;
        const keepPrestigeUpgrades = [...game.prestigeUpgrades];
        const keepAchievements = [...game.achievements];
        const keepTotalPlayTime = game.totalPlayTime;
        const keepTotalOfflineTime = game.totalOfflineTime;
        const keepTotalClicks = game.totalClicks;
        const keepGoldenGearsClicked = game.goldenGearsClicked;
        const keepHighestComponents = game.highestComponents.max(game.totalComponents);
        const keepFastestPrestige = game.fastestPrestige;

        // Reset to initial state
        game = createInitialState();
        BUILDINGS.forEach(b => {
            game.buildings[b.id] = 0;
        });

        // Restore persistent data
        game.settings = keepSettings;
        game.totalPrestiges = keepPrestiges;
        game.blueprints = keepBlueprints;
        game.prestigeUpgrades = keepPrestigeUpgrades;
        game.achievements = keepAchievements;
        game.totalPlayTime = keepTotalPlayTime;
        game.totalOfflineTime = keepTotalOfflineTime;
        game.totalClicks = keepTotalClicks;
        game.goldenGearsClicked = keepGoldenGearsClicked;
        game.highestComponents = keepHighestComponents;
        game.fastestPrestige = keepFastestPrestige;

        // Apply prestige starting bonuses
        if (game.prestigeUpgrades.includes('pu1')) {
            game.buildings.workbench = 5;
        }
        if (game.prestigeUpgrades.includes('pu2')) {
            game.buildings.conveyor = 3;
        }

        showToast(`Factory Reset! +${gain} üìê Blueprints`, 'prestige');
        updateDisplay();
        saveGame();
    }

    // ============================================================
    // GOLDEN GEAR
    // ============================================================
    let goldenGearTimeout = null;

    function spawnGoldenGear() {
        if (document.querySelector('.golden-gear')) return;

        const gear = document.createElement('div');
        gear.className = 'golden-gear';
        gear.textContent = '‚≠ê';

        // Random position
        const maxX = window.innerWidth - 60;
        const maxY = window.innerHeight - 150;
        gear.style.left = Math.random() * maxX + 'px';
        gear.style.top = Math.random() * (maxY - 100) + 100 + 'px';

        gear.onclick = () => collectGoldenGear(gear);
        document.body.appendChild(gear);

        // Remove after 10 seconds if not clicked
        setTimeout(() => {
            if (gear.parentNode) gear.remove();
        }, 10000);
    }

    function collectGoldenGear(gear) {
        audio.init();
        audio.playGoldenGear();
        gear.remove();
        game.goldenGearsClicked++;

        // Random effect
        const roll = Math.random();
        let goldenMult = 1;
        if (game.upgrades.includes('bonus1')) goldenMult = 2;

        if (roll < 0.4) {
            // Production bonus for 30 seconds
            game.activeBonus = 'production';
            game.bonusEndTime = Date.now() + 30000;
            showToast('üåü 2x Production for 30 seconds!', 'achievement');
        } else if (roll < 0.7) {
            // Instant resources
            const bonus = getProductionPerSecond().mul(60 * goldenMult);
            game.components = game.components.add(bonus);
            game.totalComponents = game.totalComponents.add(bonus);
            game.lifetimeComponents = game.lifetimeComponents.add(bonus);
            showToast(`üåü +${formatNumber(bonus)} Components!`, 'achievement');
        } else if (roll < 0.9) {
            // Instant clicks worth
            const bonus = getClickValue().mul(100 * goldenMult);
            game.components = game.components.add(bonus);
            game.totalComponents = game.totalComponents.add(bonus);
            game.lifetimeComponents = game.lifetimeComponents.add(bonus);
            showToast(`üåü +${formatNumber(bonus)} Components (100 clicks)!`, 'achievement');
        } else {
            // Rare: blueprint fragment (adds to next prestige)
            showToast('üåü Blueprint Fragment found! +10% to next prestige!', 'achievement');
            // This would require additional tracking, simplified for now
        }

        updateDisplay();
    }

    function scheduleNextGoldenGear() {
        let baseTime = 120000 + Math.random() * 180000; // 2-5 minutes
        if (game.upgrades.includes('bonus2')) baseTime *= 0.67;
        if (game.prestigeUpgrades.includes('pu7')) baseTime *= 0.5;

        clearTimeout(goldenGearTimeout);
        goldenGearTimeout = setTimeout(() => {
            spawnGoldenGear();
            scheduleNextGoldenGear();
        }, baseTime);
    }

    // ============================================================
    // ACHIEVEMENTS
    // ============================================================
    function checkAchievements() {
        let newAchievement = false;

        ACHIEVEMENTS.forEach(ach => {
            if (!game.achievements.includes(ach.id) && ach.check()) {
                game.achievements.push(ach.id);
                newAchievement = true;
                audio.playAchievement();
                showToast(`üèÜ Achievement: ${ach.name}`, 'achievement');
            }
        });

        if (newAchievement) {
            updateDisplay();
        }
    }

    // ============================================================
    // UI UPDATES
    // ============================================================
    function updateDisplay() {
        // Resources
        document.getElementById('componentsDisplay').textContent = formatNumber(game.components);
        document.getElementById('componentsRate').textContent = `(+${formatNumber(getProductionPerSecond())}/sec)`;
        document.getElementById('widgetsDisplay').textContent = formatNumber(game.widgets);
        document.getElementById('widgetsRate').textContent = `(+${formatNumber(getWidgetProductionPerSecond())}/sec)`;
        document.getElementById('prototypesDisplay').textContent = formatNumber(game.prototypes);
        document.getElementById('blueprintsDisplay').textContent = game.blueprints;
        document.getElementById('blueprintsBonus').textContent = `(+${game.blueprints}% bonus)`;

        // Click button
        document.getElementById('clickValue').textContent = `+${formatNumber(getClickValue())} per click`;

        // Total production
        document.getElementById('totalProduction').textContent = `${formatNumber(getProductionPerSecond())}/sec`;

        // Prestige
        const prestigeGain = getPrestigeGain();
        document.getElementById('prestigeAvailable').textContent = `${prestigeGain} üìê Blueprints`;
        document.getElementById('prestigeBtn').disabled = prestigeGain <= 0;

        // Update counts
        document.getElementById('upgradeCount').textContent = `${game.upgrades.length}/${UPGRADES.length}`;
        document.getElementById('prestigeUpgradeCount').textContent = `${game.prestigeUpgrades.length}/${PRESTIGE_UPGRADES.length}`;
        document.getElementById('achievementCount').textContent = `${game.achievements.length}/${ACHIEVEMENTS.length}`;

        updateBuildings();
        updateUpgrades();
        updatePrestigeUpgrades();
        updateAchievements();
        updateStats();

        // Track highest
        if (game.totalComponents.gt(game.highestComponents)) {
            game.highestComponents = game.totalComponents;
        }
    }

    function updateBuildings() {
        const container = document.getElementById('buildingsList');
        const buyAmount = document.getElementById('globalBuyAmount')?.value || game.settings.buyAmount;

        container.innerHTML = '';

        BUILDINGS.forEach(building => {
            const unlocked = building.unlockCondition();
            const owned = game.buildings[building.id] || 0;
            const amount = buyAmount === 'max' ? getMaxAffordable(building.id) : parseInt(buyAmount);
            const cost = getBuildingCost(building.id, amount);
            const affordable = game.components.gte(cost) && amount > 0;
            const production = getBuildingProduction(building.id);

            if (!unlocked && owned === 0) return; // Hide locked buildings

            const div = document.createElement('div');
            div.className = `building-item ${unlocked ? '' : 'locked'} ${affordable && unlocked ? 'affordable' : ''}`;

            div.innerHTML = `
                <div class="building-header">
                    <div class="building-info">
                        <span class="building-icon">${building.icon}</span>
                        <span class="building-name">${building.name}</span>
                    </div>
                    <span class="building-owned">${owned}</span>
                </div>
                <div class="building-desc">${building.flavor}</div>
                <div class="building-stats">
                    <span>+${formatNumber(production)}/sec</span>
                    <span>Cost: ${formatNumber(cost)} üî©</span>
                </div>
                <div class="building-buttons">
                    <button class="buy-btn" data-building="${building.id}" data-amount="1" ${!unlocked || !game.components.gte(getBuildingCost(building.id, 1)) ? 'disabled' : ''}>Buy 1</button>
                    <button class="buy-btn" data-building="${building.id}" data-amount="10" ${!unlocked || !game.components.gte(getBuildingCost(building.id, 10)) ? 'disabled' : ''}>Buy 10</button>
                    <button class="buy-btn" data-building="${building.id}" data-amount="100" ${!unlocked || !game.components.gte(getBuildingCost(building.id, 100)) ? 'disabled' : ''}>Buy 100</button>
                    <button class="buy-btn" data-building="${building.id}" data-amount="max" ${!unlocked || getMaxAffordable(building.id) <= 0 ? 'disabled' : ''}>MAX</button>
                </div>
            `;

            container.appendChild(div);
        });

        // Add event listeners for buy buttons
        container.querySelectorAll('.buy-btn').forEach(btn => {
            btn.onclick = () => {
                const amount = btn.dataset.amount === 'max' ? 'max' : parseInt(btn.dataset.amount);
                buyBuilding(btn.dataset.building, amount);
            };
        });
    }

    function updateUpgrades() {
        const container = document.getElementById('upgradesList');
        container.innerHTML = '';

        // Sort: available first, then purchased, then locked
        const sorted = [...UPGRADES].sort((a, b) => {
            const aState = getUpgradeState(a);
            const bState = getUpgradeState(b);
            if (aState !== bState) return aState - bState;
            return 0;
        });

        sorted.forEach(upgrade => {
            const purchased = game.upgrades.includes(upgrade.id);
            const available = upgrade.requires();
            const currency = upgrade.costType === 'widgets' ? game.widgets : game.components;
            const affordable = currency.gte(upgrade.cost);

            // Hide unavailable upgrades that aren't close to being unlocked
            if (!available && !purchased) return;

            const div = document.createElement('div');
            div.className = `upgrade-item ${purchased ? 'purchased' : ''} ${!available ? 'locked' : ''} ${affordable && !purchased && available ? 'affordable' : ''}`;

            const costIcon = upgrade.costType === 'widgets' ? '‚öôÔ∏è' : 'üî©';

            div.innerHTML = `
                <div class="upgrade-header">
                    <span class="upgrade-name">${upgrade.icon} ${upgrade.name}</span>
                    <span class="upgrade-status">${purchased ? '‚úÖ' : (!available ? 'üîí' : '')}</span>
                </div>
                <div class="upgrade-desc">${upgrade.description}</div>
                <div class="upgrade-flavor">${upgrade.flavor}</div>
                ${!purchased ? `<div class="upgrade-cost">${formatNumber(upgrade.cost)} ${costIcon}</div>` : ''}
            `;

            if (!purchased && available) {
                div.onclick = () => buyUpgrade(upgrade.id);
            }

            container.appendChild(div);
        });
    }

    function getUpgradeState(upgrade) {
        if (game.upgrades.includes(upgrade.id)) return 2; // Purchased
        if (!upgrade.requires()) return 3; // Locked
        return 1; // Available
    }

    function updatePrestigeUpgrades() {
        const container = document.getElementById('prestigeUpgradesList');
        container.innerHTML = '';

        PRESTIGE_UPGRADES.forEach(upgrade => {
            const purchased = game.prestigeUpgrades.includes(upgrade.id);
            const available = upgrade.requires();
            const affordable = game.blueprints >= upgrade.cost;

            const div = document.createElement('div');
            div.className = `prestige-upgrade ${purchased ? 'purchased' : ''} ${!available ? 'locked' : ''} ${affordable && !purchased && available ? 'affordable' : ''}`;

            div.innerHTML = `
                <div class="upgrade-header">
                    <span class="upgrade-name">${upgrade.icon} ${upgrade.name}</span>
                    <span class="upgrade-status">${purchased ? '‚úÖ' : (!available ? 'üîí' : '')}</span>
                </div>
                <div class="upgrade-desc">${upgrade.description}</div>
                <div class="upgrade-flavor">${upgrade.flavor}</div>
                ${!purchased ? `<div class="upgrade-cost">${upgrade.cost} üìê</div>` : ''}
            `;

            if (!purchased && available) {
                div.onclick = () => buyPrestigeUpgrade(upgrade.id);
            }

            container.appendChild(div);
        });
    }

    function updateAchievements() {
        const container = document.getElementById('achievementsList');
        container.innerHTML = '';

        const tierColors = {
            bronze: '#cd7f32',
            silver: '#c0c0c0',
            gold: '#ffd700'
        };

        ACHIEVEMENTS.forEach(ach => {
            const unlocked = game.achievements.includes(ach.id);

            // Hide hidden achievements that aren't unlocked
            if (ach.hidden && !unlocked) return;

            const div = document.createElement('div');
            div.className = `achievement-item ${unlocked ? 'unlocked' : 'locked'}`;

            div.innerHTML = `
                <span class="achievement-icon" style="color: ${unlocked ? tierColors[ach.tier] : '#555'}">${ach.icon}</span>
                <div class="achievement-info">
                    <div class="achievement-name">${unlocked ? ach.name : (ach.hidden ? '???' : ach.name)}</div>
                    <div class="achievement-desc">${unlocked || !ach.hidden ? ach.description : 'Hidden achievement'}</div>
                    ${unlocked ? `<div class="achievement-bonus">+${(ach.bonus * 100).toFixed(0)}% production</div>` : ''}
                </div>
            `;

            container.appendChild(div);
        });
    }

    function updateStats() {
        const container = document.getElementById('statsList');

        const stats = [
            { label: 'Total Components', value: formatNumber(game.totalComponents) },
            { label: 'Lifetime Components', value: formatNumber(game.lifetimeComponents) },
            { label: 'Highest Components', value: formatNumber(game.highestComponents) },
            { label: 'Components/sec', value: formatNumber(getProductionPerSecond()) },
            { label: 'Click Value', value: formatNumber(getClickValue()) },
            { label: 'Total Clicks', value: formatNumber(D(game.totalClicks)) },
            { label: 'Total Buildings', value: getTotalBuildings() },
            { label: 'Upgrades Purchased', value: `${game.upgrades.length}/${UPGRADES.length}` },
            { label: 'Achievements', value: `${game.achievements.length}/${ACHIEVEMENTS.length}` },
            { label: 'Achievement Bonus', value: `+${(getAchievementBonus() * 100).toFixed(1)}%` },
            { label: 'Blueprints', value: game.blueprints },
            { label: 'Blueprint Bonus', value: `+${game.blueprints}%` },
            { label: 'Total Prestiges', value: game.totalPrestiges },
            { label: 'Play Time', value: formatTime(game.totalPlayTime) },
            { label: 'Offline Time', value: formatTime(game.totalOfflineTime) },
            { label: 'Golden Gears Clicked', value: game.goldenGearsClicked },
            { label: 'Fastest Prestige', value: game.fastestPrestige < Infinity ? formatTime(game.fastestPrestige) : 'N/A' },
        ];

        container.innerHTML = stats.map(s => `
            <div class="stat-item">
                <span class="stat-label">${s.label}</span>
                <span class="stat-value">${s.value}</span>
            </div>
        `).join('');
    }

    // ============================================================
    // UI HELPERS
    // ============================================================
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => toast.remove(), 3000);
    }

    function createClickParticle(event, value) {
        const particle = document.createElement('div');
        particle.className = 'click-particle';
        particle.textContent = `+${formatNumber(value)}`;

        const rect = event.target.getBoundingClientRect();
        particle.style.left = event.clientX + 'px';
        particle.style.top = event.clientY + 'px';

        document.body.appendChild(particle);
        setTimeout(() => particle.remove(), 1000);
    }

    function showModal(title, message, content = '', onConfirm = null) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').textContent = message;
        document.getElementById('modalContent').innerHTML = content;
        document.getElementById('modalOverlay').classList.add('active');

        document.getElementById('modalConfirm').onclick = () => {
            document.getElementById('modalOverlay').classList.remove('active');
            if (onConfirm) onConfirm();
        };

        document.getElementById('modalCancel').onclick = () => {
            document.getElementById('modalOverlay').classList.remove('active');
        };
    }

    // ============================================================
    // SAVE/LOAD SYSTEM
    // ============================================================
    function saveGame() {
        const saveData = {
            ...game,
            components: game.components.toString(),
            widgets: game.widgets.toString(),
            prototypes: game.prototypes.toString(),
            totalComponents: game.totalComponents.toString(),
            lifetimeComponents: game.lifetimeComponents.toString(),
            highestComponents: game.highestComponents.toString(),
            lastSaveTime: Date.now()
        };

        try {
            localStorage.setItem('idleFactorySave', JSON.stringify(saveData));
            showToast('Game saved!', 'milestone');
        } catch (e) {
            console.error('Failed to save:', e);
            showToast('Failed to save game!', 'error');
        }
    }

    function loadGame() {
        try {
            const saved = localStorage.getItem('idleFactorySave');
            if (!saved) return false;

            const data = JSON.parse(saved);

            // Restore Decimal values
            game.components = D(data.components || 0);
            game.widgets = D(data.widgets || 0);
            game.prototypes = D(data.prototypes || 0);
            game.totalComponents = D(data.totalComponents || 0);
            game.lifetimeComponents = D(data.lifetimeComponents || 0);
            game.highestComponents = D(data.highestComponents || 0);

            // Restore other values
            game.blueprints = data.blueprints || 0;
            game.buildings = data.buildings || {};
            game.upgrades = data.upgrades || [];
            game.achievements = data.achievements || [];
            game.prestigeUpgrades = data.prestigeUpgrades || [];

            game.totalClicks = data.totalClicks || 0;
            game.totalPlayTime = data.totalPlayTime || 0;
            game.totalOfflineTime = data.totalOfflineTime || 0;
            game.totalPrestiges = data.totalPrestiges || 0;
            game.goldenGearsClicked = data.goldenGearsClicked || 0;

            game.lastSaveTime = data.lastSaveTime || Date.now();
            game.lastTickTime = Date.now();
            game.gameStartTime = data.gameStartTime || Date.now();

            game.settings = { ...game.settings, ...data.settings };
            game.fastestPrestige = data.fastestPrestige || Infinity;

            // Initialize any missing buildings
            BUILDINGS.forEach(b => {
                if (game.buildings[b.id] === undefined) {
                    game.buildings[b.id] = 0;
                }
            });

            // Apply saved settings
            audio.setVolume(game.settings.volume);
            audio.muted = game.settings.muted;

            return true;
        } catch (e) {
            console.error('Failed to load save:', e);
            return false;
        }
    }

    function calculateOfflineProgress() {
        const now = Date.now();
        const offlineTime = Math.min((now - game.lastSaveTime) / 1000, getOfflineCap());

        if (offlineTime < 60) return; // Less than a minute, don't bother

        game.totalOfflineTime += offlineTime;

        const production = getProductionPerSecond();
        const efficiency = getOfflineEfficiency();
        const offlineGain = production.mul(offlineTime * efficiency);

        game.components = game.components.add(offlineGain);
        game.totalComponents = game.totalComponents.add(offlineGain);
        game.lifetimeComponents = game.lifetimeComponents.add(offlineGain);

        const widgetGain = getWidgetProductionPerSecond().mul(offlineTime * efficiency);
        game.widgets = game.widgets.add(widgetGain);

        // Show welcome back modal
        showModal(
            'üëã Welcome Back!',
            `You were away for ${formatTime(offlineTime)}`,
            `
                <div class="welcome-back-gains">
                    <div class="resource-gain">
                        <span>üî© Components</span>
                        <span>+${formatNumber(offlineGain)}</span>
                    </div>
                    ${widgetGain.gt(0) ? `
                    <div class="resource-gain">
                        <span>‚öôÔ∏è Widgets</span>
                        <span>+${formatNumber(widgetGain)}</span>
                    </div>
                    ` : ''}
                    <div class="resource-gain">
                        <span>Efficiency</span>
                        <span>${(efficiency * 100).toFixed(0)}%</span>
                    </div>
                </div>
            `,
            () => {}
        );
        document.getElementById('modalCancel').style.display = 'none';
        document.getElementById('modalConfirm').textContent = 'Continue';
    }

    function exportSave() {
        saveGame();
        const saved = localStorage.getItem('idleFactorySave');
        const encoded = btoa(saved);
        navigator.clipboard.writeText(encoded).then(() => {
            showToast('Save copied to clipboard!', 'milestone');
        }).catch(() => {
            prompt('Copy this save string:', encoded);
        });
    }

    function importSave() {
        const encoded = prompt('Paste your save string:');
        if (!encoded) return;

        try {
            const decoded = atob(encoded);
            localStorage.setItem('idleFactorySave', decoded);
            location.reload();
        } catch (e) {
            showToast('Invalid save string!', 'error');
        }
    }

    function hardReset() {
        showModal(
            '‚ö†Ô∏è Hard Reset',
            'This will permanently delete ALL progress. Are you absolutely sure?',
            '<p style="color: var(--danger);">This action cannot be undone!</p>',
            () => {
                localStorage.removeItem('idleFactorySave');
                location.reload();
            }
        );
    }

    // ============================================================
    // GAME LOOP
    // ============================================================
    let lastFrameTime = performance.now();

    function gameLoop(currentTime) {
        const deltaMs = currentTime - lastFrameTime;
        const deltaSec = deltaMs / 1000;
        lastFrameTime = currentTime;

        // Update play time
        game.totalPlayTime += deltaSec;

        // Production
        const production = getProductionPerSecond().mul(deltaSec);
        game.components = game.components.add(production);
        game.totalComponents = game.totalComponents.add(production);
        game.lifetimeComponents = game.lifetimeComponents.add(production);

        // Widget production
        const widgetProduction = getWidgetProductionPerSecond().mul(deltaSec);
        game.widgets = game.widgets.add(widgetProduction);

        // Auto-buyers
        if (game.upgrades.includes('auto1')) {
            const workbenchCost = getBuildingCost('workbench', 1);
            if (game.components.gte(workbenchCost)) {
                buyBuilding('workbench', 1);
            }
        }

        // Check active bonus expiry
        if (game.activeBonus && Date.now() >= game.bonusEndTime) {
            game.activeBonus = null;
        }

        // Check achievements periodically (every ~1 second)
        if (Math.random() < deltaSec) {
            checkAchievements();
        }

        updateDisplay();
        requestAnimationFrame(gameLoop);
    }

    // ============================================================
    // EVENT LISTENERS
    // ============================================================
    function setupEventListeners() {
        // Main click button
        document.getElementById('mainClickBtn').addEventListener('click', handleClick);
        document.getElementById('mainClickBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            handleClick(e);
        });

        // Header buttons
        document.getElementById('saveBtn').addEventListener('click', saveGame);
        document.getElementById('muteBtn').addEventListener('click', () => {
            audio.init();
            const muted = audio.toggleMute();
            game.settings.muted = muted;
            document.getElementById('muteIcon').textContent = muted ? 'üîá' : 'üîä';
        });
        document.getElementById('optionsBtn').addEventListener('click', () => {
            document.getElementById('optionsPanel').classList.toggle('active');
        });

        // Options
        document.getElementById('volumeSlider').addEventListener('input', (e) => {
            const vol = e.target.value / 100;
            audio.setVolume(vol);
            game.settings.volume = vol;
        });

        document.getElementById('numberFormat').addEventListener('change', (e) => {
            game.settings.numberFormat = e.target.value;
            updateDisplay();
        });

        document.getElementById('globalBuyAmount').addEventListener('change', (e) => {
            game.settings.buyAmount = e.target.value;
            updateDisplay();
        });

        document.getElementById('exportBtn').addEventListener('click', exportSave);
        document.getElementById('importBtn').addEventListener('click', importSave);
        document.getElementById('resetBtn').addEventListener('click', hardReset);

        // Tab navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

                btn.classList.add('active');
                const tabId = btn.dataset.tab + 'Panel';
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Prestige button
        document.getElementById('prestigeBtn').addEventListener('click', () => {
            const gain = getPrestigeGain();
            showModal(
                'üîÑ Factory Reset',
                `Are you sure you want to reset? You will gain ${gain} üìê Blueprints.`,
                '<p>Your buildings and upgrades will be reset, but Blueprints and prestige upgrades are permanent.</p>',
                performPrestige
            );
        });

        // Close options panel when clicking outside
        document.addEventListener('click', (e) => {
            const optionsPanel = document.getElementById('optionsPanel');
            const optionsBtn = document.getElementById('optionsBtn');
            if (!optionsPanel.contains(e.target) && !optionsBtn.contains(e.target)) {
                optionsPanel.classList.remove('active');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;

            switch(e.key.toLowerCase()) {
                case 'm':
                    document.getElementById('muteBtn').click();
                    break;
                case 's':
                    saveGame();
                    break;
            }
        });

        // Auto-save every 30 seconds
        setInterval(saveGame, 30000);
    }

    // ============================================================
    // INITIALIZATION
    // ============================================================
    function init() {
        const hasSave = loadGame();

        if (hasSave) {
            calculateOfflineProgress();
        }

        // Apply saved settings to UI
        document.getElementById('volumeSlider').value = game.settings.volume * 100;
        document.getElementById('numberFormat').value = game.settings.numberFormat;
        document.getElementById('globalBuyAmount').value = game.settings.buyAmount;
        document.getElementById('muteIcon').textContent = game.settings.muted ? 'üîá' : 'üîä';

        setupEventListeners();
        updateDisplay();

        // Start game loop
        requestAnimationFrame(gameLoop);

        // Start golden gear spawning
        scheduleNextGoldenGear();

        console.log('üè≠ Idle Factory v1.0.0 initialized');
    }

    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    </script>
</body>
</html>
