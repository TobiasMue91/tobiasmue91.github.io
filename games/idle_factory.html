<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle Factory - Incremental Game</title>
    <script src="https://cdn.jsdelivr.net/npm/break_infinity.js@2"></script>
    <style>
        /* ============================================
           IDLE FACTORY - Industrial Blueprint Theme
           A technical, schematic-inspired design
           ============================================ */

        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Orbitron:wght@500;700&display=swap');

        :root {
            --bg-dark: #0d1117;
            --bg-panel: #161b22;
            --bg-card: #21262d;
            --border: #30363d;
            --border-highlight: #58a6ff;
            --text: #c9d1d9;
            --text-dim: #8b949e;
            --text-bright: #f0f6fc;
            --accent: #58a6ff;
            --accent-dim: #1f6feb;
            --success: #3fb950;
            --warning: #d29922;
            --danger: #f85149;
            --gold: #ffd700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.4;
            font-size: 14px;
            background-image:
                linear-gradient(rgba(88, 166, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(88, 166, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* Header - Minimal technical bar */
        .header {
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 10px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-bright);
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-title::before {
            content: '//';
            color: var(--accent);
            font-weight: 400;
        }

        .header-controls {
            display: flex;
            gap: 4px;
        }

        .icon-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-dim);
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: border-color 0.15s, color 0.15s;
        }

        .icon-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .version {
            font-size: 10px;
            color: var(--text-dim);
            position: absolute;
            right: 16px;
            bottom: -14px;
        }

        /* Resource Display - Data readout style */
        .resources {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1px;
            background: var(--border);
            margin: 16px;
            border: 1px solid var(--border);
        }

        .resource {
            background: var(--bg-panel);
            padding: 12px 16px;
        }

        .resource-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .resource-icon {
            font-size: 18px;
        }

        .resource-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .resource-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-bright);
            font-variant-numeric: tabular-nums;
            transition: color 0.2s;
        }

        .resource.producing .resource-value {
            color: var(--success);
        }

        .resource-rate {
            font-size: 11px;
            color: var(--success);
        }

        .resource-rate.active {
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Main Production Button */
        .production-section {
            padding: 20px 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            position: relative;
        }

        .boost-indicator {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--warning), #e5ac26);
            color: var(--bg-dark);
            padding: 6px 16px;
            border-radius: 20px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            font-weight: 700;
            display: none;
            align-items: center;
            gap: 8px;
            animation: boostPulse 1s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(210, 153, 34, 0.5);
            z-index: 10;
        }

        .boost-indicator.active {
            display: flex;
        }

        .boost-icon {
            animation: boostZap 0.5s ease-in-out infinite;
        }

        @keyframes boostPulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }

        @keyframes boostZap {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .boost-timer {
            background: rgba(0,0,0,0.2);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .main-btn {
            background: var(--bg-card);
            border: 2px solid var(--accent);
            color: var(--text-bright);
            padding: 20px 48px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            position: relative;
            transition: background 0.15s;
        }

        .main-btn:hover {
            background: var(--accent-dim);
        }

        .main-btn:active {
            transform: scale(0.98);
        }

        .main-btn .label {
            display: block;
            font-size: 12px;
            color: var(--text-dim);
            margin-top: 4px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            gap: 2px;
            padding: 0 16px;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            background: none;
            border: none;
            color: var(--text-dim);
            padding: 10px 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: color 0.15s;
        }

        .tab:hover {
            color: var(--text);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* Main Content */
        .content {
            padding: 16px;
            padding-bottom: 80px;
        }

        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        /* Building Cards */
        .building-grid {
            display: grid;
            gap: 8px;
        }

        .building {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            padding: 12px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .building.can-afford {
            border-color: var(--success);
        }

        .building.locked {
            opacity: 0.4;
            pointer-events: none;
        }

        .building-icon {
            font-size: 28px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: transform 0.1s, border-color 0.15s, background 0.15s;
        }

        .building-icon:hover {
            transform: scale(1.1);
            border-color: var(--accent);
        }

        .building.can-afford .building-icon:hover {
            background: var(--accent-dim);
            border-color: var(--success);
        }

        .building-icon:active {
            transform: scale(0.95);
        }

        .building-info {
            min-width: 0;
            flex: 1;
            max-width: 300px;
        }

        .building-name {
            font-weight: 600;
            color: var(--text-bright);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .building-count {
            background: var(--accent-dim);
            color: var(--text-bright);
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 700;
        }

        .building-desc {
            font-size: 11px;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .building-stats {
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .building-stats .rate {
            color: var(--success);
        }

        .building-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
            margin-left: auto;
        }

        .buy-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            cursor: pointer;
            transition: border-color 0.15s, background 0.15s;
        }

        .buy-btn:hover:not(:disabled) {
            border-color: var(--accent);
            background: var(--accent-dim);
        }

        .buy-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Upgrades */
        .upgrade-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 8px;
        }

        .upgrade {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            padding: 12px;
            cursor: pointer;
            transition: border-color 0.15s;
        }

        .upgrade:hover:not(.purchased):not(.locked) {
            border-color: var(--accent);
        }

        .upgrade.can-afford {
            border-color: var(--success);
        }

        .upgrade.purchased {
            opacity: 0.5;
            cursor: default;
        }

        .upgrade.locked {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .upgrade-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .upgrade-name {
            font-weight: 600;
            color: var(--text-bright);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .upgrade-cost {
            font-size: 11px;
            color: var(--warning);
        }

        .upgrade-desc {
            font-size: 12px;
            color: var(--text-dim);
        }

        .upgrade-flavor {
            font-size: 10px;
            color: var(--text-dim);
            font-style: italic;
            margin-top: 4px;
            opacity: 0.7;
        }

        /* Achievements */
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 8px;
        }

        .achievement {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .achievement.unlocked {
            border-left: 3px solid var(--gold);
        }

        .achievement.locked {
            opacity: 0.4;
        }

        .achievement-icon {
            font-size: 24px;
        }

        .achievement-info {
            flex: 1;
            min-width: 0;
        }

        .achievement-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-bright);
        }

        .achievement-desc {
            font-size: 11px;
            color: var(--text-dim);
        }

        .achievement-bonus {
            font-size: 10px;
            color: var(--success);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
        }

        .stat {
            background: var(--bg-panel);
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
        }

        .stat-label {
            color: var(--text-dim);
            font-size: 12px;
        }

        .stat-value {
            color: var(--text-bright);
            font-weight: 600;
        }

        /* Prestige Bar */
        .prestige-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            padding: 12px 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .prestige-info {
            text-align: center;
        }

        .prestige-label {
            font-size: 11px;
            color: var(--text-dim);
        }

        .prestige-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            color: var(--gold);
        }

        .prestige-btn {
            background: var(--bg-card);
            border: 2px solid var(--gold);
            color: var(--gold);
            padding: 10px 24px;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .prestige-btn:hover:not(:disabled) {
            background: rgba(255, 215, 0, 0.1);
        }

        .prestige-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Toast Notifications */
        .toasts {
            position: fixed;
            top: 60px;
            right: 16px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            padding: 10px 14px;
            font-size: 12px;
            animation: slideIn 0.2s ease, fadeOut 0.3s ease 2.7s forwards;
            max-width: 280px;
        }

        .toast.achievement { border-left-color: var(--gold); }
        .toast.success { border-left-color: var(--success); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; }
        }

        /* Golden Gear */
        .golden-gear {
            position: fixed;
            font-size: 40px;
            cursor: pointer;
            z-index: 500;
            animation: spin 4s linear infinite;
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.5));
            will-change: transform;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Click Particles */
        .particle {
            position: fixed;
            pointer-events: none;
            font-size: 12px;
            font-weight: 700;
            color: var(--success);
            animation: floatUp 0.8s ease-out forwards;
            z-index: 600;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-40px); }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            padding: 24px;
            max-width: 400px;
            width: 90%;
        }

        .modal h2 {
            font-family: 'Orbitron', sans-serif;
            margin-bottom: 12px;
            color: var(--text-bright);
        }

        .modal p {
            color: var(--text-dim);
            margin-bottom: 16px;
            font-size: 13px;
        }

        .modal-content {
            margin-bottom: 16px;
        }

        .modal-btns {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 8px 20px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            cursor: pointer;
        }

        .modal-btn.confirm {
            border-color: var(--accent);
            color: var(--accent);
        }

        .modal-btn:hover {
            background: var(--accent-dim);
        }

        /* Options Panel */
        .options-panel {
            position: fixed;
            top: 50px;
            right: 16px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            padding: 16px;
            z-index: 1000;
            min-width: 220px;
            display: none;
        }

        .options-panel.active {
            display: block;
        }

        .option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }

        .option:last-child {
            border-bottom: none;
        }

        .option select, .option input[type="range"] {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 4px;
            font-size: 11px;
        }

        .option input[type="range"] {
            width: 80px;
        }

        .option-btn {
            width: 100%;
            margin-top: 8px;
            padding: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 11px;
            cursor: pointer;
        }

        .option-btn:hover {
            border-color: var(--accent);
        }

        .option-btn.danger {
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Prestige Upgrades */
        .prestige-upgrade-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 8px;
        }

        .prestige-upgrade {
            background: var(--bg-panel);
            border: 1px solid var(--gold);
            padding: 12px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .prestige-upgrade:hover:not(.purchased):not(.locked) {
            background: rgba(255, 215, 0, 0.05);
        }

        .prestige-upgrade.purchased {
            opacity: 0.5;
            cursor: default;
        }

        .prestige-upgrade.locked {
            opacity: 0.3;
            border-color: var(--border);
            cursor: not-allowed;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            color: var(--text-dim);
            letter-spacing: 1px;
        }

        .section-count {
            font-size: 11px;
            color: var(--text-dim);
        }

        /* Game Hints */
        .game-hint {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-panel);
            border: 1px solid var(--accent);
            border-left: 4px solid var(--accent);
            padding: 12px 20px;
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            z-index: 500;
            cursor: pointer;
            animation: hintFade 8s ease-out forwards;
            max-width: 90%;
            text-align: center;
        }

        @keyframes hintFade {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            85% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Achievement Celebration */
        .achievement-celebration {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            animation: achieveSlide 3s ease-out forwards;
        }

        @keyframes achieveSlide {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        .achievement-popup {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3), inset 0 0 20px rgba(255, 215, 0, 0.1);
        }

        .achievement-popup .achievement-icon {
            font-size: 48px;
            animation: achieveIconBounce 0.5s ease-out;
        }

        @keyframes achieveIconBounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .achievement-popup .achievement-content {
            text-align: left;
        }

        .achievement-popup .achievement-label {
            font-size: 10px;
            color: var(--gold);
            letter-spacing: 2px;
            margin-bottom: 4px;
        }

        .achievement-popup .achievement-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--text-bright);
            font-weight: 700;
        }

        .achievement-popup .achievement-bonus {
            font-size: 12px;
            color: var(--success);
            margin-top: 4px;
        }

        /* Quality Control Minigame */
        .minigame-btn {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-panel));
            border: 2px solid var(--warning);
            color: var(--warning);
            padding: 12px 24px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            margin-left: 16px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .minigame-btn:hover:not(:disabled) {
            background: var(--warning);
            color: var(--bg-dark);
            box-shadow: 0 0 20px rgba(210, 153, 34, 0.4);
        }

        .minigame-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: var(--border);
            color: var(--text-dim);
        }

        .minigame-btn .cooldown-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--accent);
            transition: width 0.1s linear;
        }

        .minigame-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-dark);
            z-index: 1000;
            display: none;
            flex-direction: column;
        }

        .minigame-overlay.active {
            display: flex;
        }

        .minigame-header {
            background: var(--bg-panel);
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border);
        }

        .minigame-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--warning);
        }

        .minigame-stats {
            display: flex;
            gap: 24px;
            font-family: 'Orbitron', sans-serif;
        }

        .minigame-stat {
            text-align: center;
        }

        .minigame-stat-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .minigame-stat-value {
            font-size: 1.5rem;
            color: var(--text-bright);
        }

        .minigame-stat-value.time {
            color: var(--warning);
        }

        .minigame-stat-value.score {
            color: var(--success);
        }

        .minigame-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            background:
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 80px,
                    rgba(88, 166, 255, 0.05) 80px,
                    rgba(88, 166, 255, 0.05) 82px
                ),
                var(--bg-dark);
        }

        .conveyor-lane {
            position: absolute;
            left: 0;
            right: 0;
            height: 90px;
            background: linear-gradient(
                180deg,
                var(--bg-panel) 0%,
                var(--bg-card) 20%,
                var(--bg-card) 80%,
                var(--bg-panel) 100%
            );
            border-top: 2px solid var(--border);
            border-bottom: 2px solid var(--border);
        }

        .conveyor-lane::before {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 30px,
                rgba(0,0,0,0.2) 30px,
                rgba(0,0,0,0.2) 32px
            );
            animation: conveyorMove 1s linear infinite;
        }

        @keyframes conveyorMove {
            from { transform: translateX(0); }
            to { transform: translateX(32px); }
        }

        .minigame-item {
            position: absolute;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            cursor: pointer;
            transition: transform 0.1s;
            border-radius: 12px;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        @media (max-width: 600px) {
            .minigame-item {
                width: 65px;
                height: 65px;
                font-size: 36px;
            }
        }

        .minigame-item.good {
            background: rgba(63, 185, 80, 0.2);
            border: 2px solid var(--success);
            animation: itemGlow 1s ease-in-out infinite;
        }

        .minigame-item.bad {
            background: rgba(248, 81, 73, 0.2);
            border: 2px solid var(--danger);
            animation: itemShake 0.3s ease-in-out infinite;
        }

        @keyframes itemGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(63, 185, 80, 0.3); }
            50% { box-shadow: 0 0 20px rgba(63, 185, 80, 0.6); }
        }

        @keyframes itemShake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-2px) rotate(-2deg); }
            75% { transform: translateX(2px) rotate(2deg); }
        }

        .minigame-item:active {
            transform: scale(0.9);
        }

        .minigame-item.clicked {
            animation: itemPop 0.3s ease-out forwards;
        }

        @keyframes itemPop {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); }
            100% { transform: scale(0); opacity: 0; }
        }

        .minigame-feedback {
            position: absolute;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: bold;
            pointer-events: none;
            animation: feedbackFloat 0.8s ease-out forwards;
        }

        .minigame-feedback.good {
            color: var(--success);
        }

        .minigame-feedback.bad {
            color: var(--danger);
        }

        @keyframes feedbackFloat {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
        }

        .minigame-results {
            position: absolute;
            inset: 0;
            background: rgba(13, 17, 23, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .minigame-results.active {
            display: flex;
        }

        .minigame-results h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            margin: 0;
        }

        .minigame-results.bronze h2 { color: #cd7f32; }
        .minigame-results.silver h2 { color: #c0c0c0; }
        .minigame-results.gold h2 { color: #ffd700; }
        .minigame-results.perfect h2 { color: #ff6b9d; text-shadow: 0 0 20px #ff6b9d; }

        .minigame-reward {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            padding: 20px 40px;
            text-align: center;
        }

        .minigame-reward-label {
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .minigame-reward-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: var(--success);
        }

        .minigame-close {
            background: var(--accent);
            border: none;
            color: var(--bg-dark);
            padding: 12px 32px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 20px;
        }

        .minigame-close:hover {
            background: var(--text-bright);
        }

        .minigame-instructions {
            position: absolute;
            inset: 0;
            background: rgba(13, 17, 23, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            text-align: center;
            padding: 20px;
        }

        .minigame-instructions h3 {
            font-family: 'Orbitron', sans-serif;
            color: var(--warning);
            margin: 0;
        }

        .minigame-instructions p {
            color: var(--text);
            max-width: 400px;
            line-height: 1.6;
        }

        .minigame-legend {
            display: flex;
            gap: 30px;
            margin: 10px 0;
        }

        .minigame-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .minigame-legend-item.good { color: var(--success); }
        .minigame-legend-item.bad { color: var(--danger); }

        .minigame-start {
            background: var(--warning);
            border: none;
            color: var(--bg-dark);
            padding: 16px 48px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 10px;
        }

        .minigame-start:hover {
            background: #e5ac26;
        }

        /* Touch optimizations */
        button, .buy-btn, .upgrade, .building-icon, .tab {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* Reduce animations on mobile for performance */
        @media (max-width: 600px), (hover: none) {
            .resources {
                grid-template-columns: 1fr 1fr;
            }

            .building {
                flex-wrap: wrap;
            }

            .building-info {
                max-width: none;
                flex-basis: calc(100% - 60px);
            }

            .building-actions {
                flex-basis: 100%;
                margin-top: 4px;
                margin-left: 0;
            }

            .prestige-bar {
                flex-direction: column;
                gap: 10px;
            }

            /* Reduce animation overhead on mobile */
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.8; }
            }

            .building-icon:hover {
                transform: none;
            }

            /* Faster transitions */
            * {
                transition-duration: 0.1s !important;
            }
        }

        /* Prefer reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1 class="header-title">IDLE FACTORY</h1>
        <div class="header-controls">
            <button class="icon-btn" id="saveBtn" title="Save (S)">üíæ</button>
            <button class="icon-btn" id="muteBtn" title="Mute (M)">üîä</button>
            <button class="icon-btn" id="optionsBtn" title="Options">‚öôÔ∏è</button>
        </div>
    </header>

    <div class="options-panel" id="optionsPanel">
        <div class="option">
            <span>Volume</span>
            <input type="range" id="volumeSlider" min="0" max="100" value="50">
        </div>
        <div class="option">
            <span>Numbers</span>
            <select id="numberFormat">
                <option value="scientific">1.23e6</option>
                <option value="suffix">1.23M</option>
            </select>
        </div>
        <button class="option-btn" id="exportBtn">Export Save</button>
        <button class="option-btn" id="importBtn">Import Save</button>
        <button class="option-btn danger" id="resetBtn">Hard Reset</button>
    </div>

    <section class="resources">
        <div class="resource" id="compResource">
            <div class="resource-header">
                <span class="resource-icon">üî©</span>
                <span class="resource-label">Components</span>
            </div>
            <div class="resource-value" id="componentsVal">0</div>
            <div class="resource-rate" id="componentsRate">+0/s</div>
        </div>
        <div class="resource" id="widgetResource">
            <div class="resource-header">
                <span class="resource-icon">‚öôÔ∏è</span>
                <span class="resource-label">Widgets</span>
            </div>
            <div class="resource-value" id="widgetsVal">0</div>
            <div class="resource-rate" id="widgetsRate">+0/s</div>
        </div>
        <div class="resource" id="bpResource">
            <div class="resource-header">
                <span class="resource-icon">üìê</span>
                <span class="resource-label">Blueprints</span>
            </div>
            <div class="resource-value" id="blueprintsVal">0</div>
            <div class="resource-rate" id="blueprintsBonus">+0% prod</div>
        </div>
    </section>

    <section class="production-section">
        <div class="boost-indicator" id="boostIndicator">
            <span class="boost-icon">‚ö°</span>
            <span class="boost-text" id="boostText">2x PRODUCTION</span>
            <span class="boost-timer" id="boostTimer">30s</span>
        </div>
        <button class="main-btn" id="mainBtn">
            üîß FABRICATE
            <span class="label" id="clickVal">+1 per click</span>
        </button>
        <button class="minigame-btn" id="minigameBtn" title="Quality Control Rush">
            üéØ QC RUSH
            <div class="cooldown-bar" id="cooldownBar"></div>
        </button>
    </section>

    <!-- Quality Control Minigame -->
    <div class="minigame-overlay" id="minigameOverlay">
        <header class="minigame-header">
            <div class="minigame-title">‚ö° QUALITY CONTROL RUSH</div>
            <div class="minigame-stats">
                <div class="minigame-stat">
                    <div class="minigame-stat-label">Time</div>
                    <div class="minigame-stat-value time" id="mgTime">30</div>
                </div>
                <div class="minigame-stat">
                    <div class="minigame-stat-label">Score</div>
                    <div class="minigame-stat-value score" id="mgScore">0</div>
                </div>
                <div class="minigame-stat">
                    <div class="minigame-stat-label">Combo</div>
                    <div class="minigame-stat-value" id="mgCombo">x1</div>
                </div>
            </div>
        </header>
        <div class="minigame-area" id="minigameArea">
            <div class="minigame-instructions" id="mgInstructions">
                <h3>üè≠ QUALITY CONTROL</h3>
                <p>Components are rolling off the production line! Tap the <strong>GOOD</strong> parts to earn points. Avoid the <strong>DEFECTIVE</strong> ones!</p>
                <div class="minigame-legend">
                    <div class="minigame-legend-item good">
                        <span>üî©‚öôÔ∏èüîß</span>
                        <span>= TAP!</span>
                    </div>
                    <div class="minigame-legend-item bad">
                        <span>üí•‚ö†Ô∏èüî•</span>
                        <span>= AVOID!</span>
                    </div>
                </div>
                <p>Build combos for bonus points. Higher scores = better rewards!</p>
                <button class="minigame-start" id="mgStart">START INSPECTION</button>
            </div>
            <div class="minigame-results" id="mgResults">
                <h2 id="mgRank">GOLD RANK</h2>
                <div class="minigame-stat">
                    <div class="minigame-stat-label">Final Score</div>
                    <div class="minigame-stat-value score" id="mgFinalScore">0</div>
                </div>
                <div class="minigame-reward">
                    <div class="minigame-reward-label">Rewards</div>
                    <div class="minigame-reward-value" id="mgReward">+1,000 üî©</div>
                </div>
                <button class="minigame-close" id="mgClose">COLLECT & EXIT</button>
            </div>
        </div>
    </div>

    <nav class="tabs">
        <button class="tab active" data-tab="buildings">Buildings</button>
        <button class="tab" data-tab="upgrades">Upgrades</button>
        <button class="tab" data-tab="prestige">Prestige</button>
        <button class="tab" data-tab="achievements">Achievements</button>
        <button class="tab" data-tab="stats">Stats</button>
    </nav>

    <main class="content">
        <section class="panel active" id="buildingsPanel">
            <div class="section-header">
                <span class="section-title">PRODUCTION UNITS</span>
                <span class="section-count" id="prodRate">0/s total</span>
            </div>
            <div class="building-grid" id="buildingGrid"></div>
        </section>

        <section class="panel" id="upgradesPanel">
            <div class="section-header">
                <span class="section-title">UPGRADES</span>
                <span class="section-count" id="upgradeCount">0/0</span>
            </div>
            <div class="upgrade-grid" id="upgradeGrid"></div>
        </section>

        <section class="panel" id="prestigePanel">
            <div class="section-header">
                <span class="section-title">PRESTIGE UPGRADES</span>
                <span class="section-count" id="prestigeCount">0/0</span>
            </div>
            <div class="prestige-upgrade-grid" id="prestigeGrid"></div>
        </section>

        <section class="panel" id="achievementsPanel">
            <div class="section-header">
                <span class="section-title">ACHIEVEMENTS</span>
                <span class="section-count" id="achieveCount">0/0</span>
            </div>
            <div class="achievement-grid" id="achieveGrid"></div>
        </section>

        <section class="panel" id="statsPanel">
            <div class="section-header">
                <span class="section-title">STATISTICS</span>
            </div>
            <div class="stats-grid" id="statsGrid"></div>
        </section>
    </main>

    <footer class="prestige-bar">
        <div class="prestige-info">
            <div class="prestige-label">Factory Reset Reward</div>
            <div class="prestige-value" id="prestigeReward">0 üìê</div>
        </div>
        <button class="prestige-btn" id="prestigeBtn" disabled>FACTORY RESET</button>
    </footer>

    <div class="toasts" id="toasts"></div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <h2 id="modalTitle">Confirm</h2>
            <p id="modalMsg"></p>
            <div id="modalContent"></div>
            <div class="modal-btns">
                <button class="modal-btn" id="modalCancel">Cancel</button>
                <button class="modal-btn confirm" id="modalConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <script>
    // ============================================
    // IDLE FACTORY - Core Game Engine
    // ============================================

    const D = (v) => new Decimal(v);

    // Audio Engine
    class Audio {
        constructor() {
            this.ctx = null;
            this.gain = null;
            this.muted = false;
            this.vol = 0.5;
        }

        init() {
            if (this.ctx) return;
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.gain = this.ctx.createGain();
            this.gain.connect(this.ctx.destination);
            this.gain.gain.value = this.vol;
        }

        setVol(v) {
            this.vol = v;
            if (this.gain) this.gain.gain.value = this.muted ? 0 : v;
        }

        mute() {
            this.muted = !this.muted;
            if (this.gain) this.gain.gain.value = this.muted ? 0 : this.vol;
            return this.muted;
        }

        play(freq, dur, type = 'sine') {
            if (!this.ctx || this.muted) return;
            const o = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            o.type = type;
            o.connect(g);
            g.connect(this.gain);
            o.frequency.setValueAtTime(freq, this.ctx.currentTime);
            g.gain.setValueAtTime(0.1, this.ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
            o.start();
            o.stop(this.ctx.currentTime + dur);
        }

        click() { this.play(600, 0.06); }
        buy() { this.play(800, 0.08); this.play(1200, 0.08); }
        upgrade() { this.play(400, 0.15); this.play(600, 0.1); }
        achieve() { [523, 659, 784].forEach((f, i) => setTimeout(() => this.play(f, 0.2), i * 80)); }
        prestige() { [200, 300, 400, 500, 600].forEach((f, i) => setTimeout(() => this.play(f, 0.3), i * 100)); }
        golden() { this.play(880, 0.15); this.play(1100, 0.15); }
    }

    const audio = new Audio();

    // Number Formatting
    const SUFFIX = ['', 'K', 'M', 'B', 'T', 'Qa', 'Qi', 'Sx', 'Sp', 'Oc', 'No', 'Dc'];

    function fmt(n, forceExp = false) {
        if (!(n instanceof Decimal)) n = D(n);
        if (n.lt(0)) return '-' + fmt(n.neg());
        if (n.eq(0)) return '0';
        // Show plain numbers up to 1 trillion before switching to notation
        if (n.lt(1e12)) {
            if (n.lt(1000)) return n.toFixed(n.lt(10) ? 1 : 0);
            // Format with commas for large numbers
            const num = n.toNumber();
            return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        const mode = document.getElementById('numberFormat')?.value || 'scientific';

        // break_infinity.js log10() returns a plain number, not a Decimal
        if (mode === 'suffix' && !forceExp && n.lt(1e36)) {
            const e = Math.floor(n.log10());
            const t = Math.floor(e / 3);
            if (t < SUFFIX.length) {
                return n.div(Decimal.pow(10, t * 3)).toFixed(2) + SUFFIX[t];
            }
        }

        const e = Math.floor(n.log10());
        const m = n.div(Decimal.pow(10, e));
        return m.toFixed(2) + 'e' + e;
    }

    function fmtTime(s) {
        if (s < 60) return Math.floor(s) + 's';
        if (s < 3600) return Math.floor(s / 60) + 'm';
        if (s < 86400) return Math.floor(s / 3600) + 'h ' + Math.floor((s % 3600) / 60) + 'm';
        return Math.floor(s / 86400) + 'd ' + Math.floor((s % 86400) / 3600) + 'h';
    }

    // Building Definitions
    const BUILDINGS = [
        { id: 'bench', name: 'Workbench', icon: 'üîß', cost: D(10), prod: D(1), mult: 1.15, desc: 'Manual assembly station', unlock: () => true },
        { id: 'conveyor', name: 'Conveyor', icon: 'üèóÔ∏è', cost: D(100), prod: D(5), mult: 1.15, desc: 'Automated belt system', unlock: () => g.buildings.bench >= 5 },
        { id: 'bot', name: 'Assembly Bot', icon: 'ü§ñ', cost: D(1100), prod: D(25), mult: 1.15, desc: 'Tireless robotic arms', unlock: () => g.buildings.conveyor >= 5 },
        { id: 'factory', name: 'Mini Factory', icon: 'üè≠', cost: D(12000), prod: D(150), mult: 1.15, desc: 'Compact production line', unlock: () => g.buildings.bot >= 5 },
        { id: 'power', name: 'Power Plant', icon: '‚ö°', cost: D(130000), prod: D(800), mult: 1.15, desc: 'Industrial energy source', unlock: () => g.buildings.factory >= 5 },
        { id: 'lab', name: 'Research Lab', icon: 'üî¨', cost: D(1400000), prod: D(4500), mult: 1.15, desc: 'Scientific advancement', unlock: () => g.buildings.power >= 5 },
        { id: 'hub', name: 'Dist. Hub', icon: 'üåê', cost: D(20000000), prod: D(25000), mult: 1.15, desc: 'Global logistics', unlock: () => g.buildings.lab >= 5 },
        { id: 'launch', name: 'Launch Pad', icon: 'üöÄ', cost: D(330000000), prod: D(150000), mult: 1.15, desc: 'Orbital manufacturing', unlock: () => g.buildings.hub >= 5 },
        { id: 'quantum', name: 'Quantum Forge', icon: '‚öõÔ∏è', cost: D(5.1e9), prod: D(1e6), mult: 1.15, desc: 'Subatomic fabrication', unlock: () => g.buildings.launch >= 5 },
        { id: 'rift', name: 'Dimensional Rift', icon: 'üåÄ', cost: D(7.5e10), prod: D(6.5e6), mult: 1.15, desc: 'Multiverse extraction', unlock: () => g.buildings.quantum >= 5 },
        { id: 'cosmic', name: 'Cosmic Foundry', icon: '‚ú®', cost: D(1e12), prod: D(5e7), mult: 1.15, desc: 'Stellar forging', unlock: () => g.buildings.rift >= 5 },
        { id: 'reality', name: 'Reality Engine', icon: 'üé≠', cost: D(2e13), prod: D(4e8), mult: 1.15, desc: 'Rewrite physics itself', unlock: () => g.buildings.cosmic >= 5 },
    ];

    // Upgrade Definitions
    const UPGRADES = [
        // Click upgrades
        { id: 'c1', name: 'Better Hands', icon: '‚úä', cost: D(50), type: 'click', mult: 2, desc: '2x click power', flavor: 'Ergonomic improvement', req: () => true },
        { id: 'c2', name: 'Power Grip', icon: 'üñ±Ô∏è', cost: D(1000), type: 'click', mult: 2, desc: '2x click power', flavor: 'Mechanical assistance', req: () => g.upgrades.includes('c1') },
        { id: 'c3', name: 'Click Fusion', icon: 'üí•', cost: D(50000), type: 'click', mult: 5, desc: '5x click power', flavor: 'Explosive clicking', req: () => g.upgrades.includes('c2') },
        { id: 'c4', name: 'Divine Touch', icon: 'üëÜ', cost: D(5e7), type: 'click', mult: 10, desc: '10x click power', flavor: 'Transcendent productivity', req: () => g.upgrades.includes('c3') },
        { id: 'c5', name: 'Singularity', icon: 'üï≥Ô∏è', cost: D(5e10), type: 'click', mult: 100, desc: '100x click power', flavor: 'Every click = big bang', req: () => g.upgrades.includes('c4') },

        // Building upgrades - Workbench
        { id: 'b1', name: 'Tool Rack', icon: 'üõ†Ô∏è', bld: 'bench', cost: D(100), mult: 2, desc: '2x workbench', flavor: 'Organization matters', req: () => g.buildings.bench >= 1 },
        { id: 'b2', name: 'Power Tools', icon: 'üîå', bld: 'bench', cost: D(500), mult: 2, desc: '2x workbench', flavor: 'Vrrrrrm', req: () => g.upgrades.includes('b1') },
        { id: 'b3', name: 'Master Craft', icon: 'üë∑', bld: 'bench', cost: D(5000), mult: 2, desc: '2x workbench', flavor: '10,000 hours', req: () => g.upgrades.includes('b2') },
        { id: 'b4', name: 'Legendary Bench', icon: 'üèÜ', bld: 'bench', cost: D(5e8), mult: 5, desc: '5x workbench', flavor: 'Passed down generations', req: () => g.upgrades.includes('b3') },

        // Conveyor
        { id: 'cv1', name: 'Speed Belt', icon: '‚è©', bld: 'conveyor', cost: D(1000), mult: 2, desc: '2x conveyor', flavor: 'Faster delivery', req: () => g.buildings.conveyor >= 1 },
        { id: 'cv2', name: 'Multi-lane', icon: 'üõ§Ô∏è', bld: 'conveyor', cost: D(5000), mult: 2, desc: '2x conveyor', flavor: 'Parallel processing', req: () => g.upgrades.includes('cv1') },
        { id: 'cv3', name: 'Smart Sort', icon: 'üìä', bld: 'conveyor', cost: D(50000), mult: 2, desc: '2x conveyor', flavor: 'AI routing', req: () => g.upgrades.includes('cv2') },
        { id: 'cv4', name: 'Hyperloop', icon: 'üöÑ', bld: 'conveyor', cost: D(5e8), mult: 3, desc: '3x conveyor', flavor: 'Supersonic belts', req: () => g.upgrades.includes('cv3') },

        // Bot
        { id: 'bt1', name: 'AI Brain', icon: 'üß†', bld: 'bot', cost: D(11000), mult: 2, desc: '2x bots', flavor: 'Machine learning', req: () => g.buildings.bot >= 1 },
        { id: 'bt2', name: 'Extra Arms', icon: 'ü¶æ', bld: 'bot', cost: D(55000), mult: 2, desc: '2x bots', flavor: 'Octo-bot upgrade', req: () => g.upgrades.includes('bt1') },
        { id: 'bt3', name: 'Swarm AI', icon: 'üêù', bld: 'bot', cost: D(5e8), mult: 3, desc: '3x bots', flavor: 'Hive mind protocol', req: () => g.upgrades.includes('bt2') },

        // Factory
        { id: 'f1', name: 'Lean Mfg', icon: 'üìè', bld: 'factory', cost: D(120000), mult: 2, desc: '2x factory', flavor: 'Trim the fat', req: () => g.buildings.factory >= 1 },
        { id: 'f2', name: 'Night Shift', icon: 'üåô', bld: 'factory', cost: D(600000), mult: 2, desc: '2x factory', flavor: '24/7 operation', req: () => g.upgrades.includes('f1') },
        { id: 'f3', name: 'Network', icon: 'üîó', bld: 'factory', cost: D(5e9), mult: 3, desc: '3x factory', flavor: 'Factory collective', req: () => g.upgrades.includes('f2') },

        // Power Plant
        { id: 'p1', name: 'Fusion Core', icon: '‚ò¢Ô∏è', bld: 'power', cost: D(1.3e6), mult: 2, desc: '2x power', flavor: 'Clean energy', req: () => g.buildings.power >= 1 },
        { id: 'p2', name: 'Grid Opt', icon: '‚ö°', bld: 'power', cost: D(1.3e7), mult: 2, desc: '2x power', flavor: 'Zero waste', req: () => g.upgrades.includes('p1') },
        { id: 'p3', name: 'Antimatter', icon: 'üí•', bld: 'power', cost: D(1e10), mult: 3, desc: '3x power', flavor: 'Handle with care', req: () => g.upgrades.includes('p2') },

        // Lab
        { id: 'l1', name: 'Eureka', icon: 'üí°', bld: 'lab', cost: D(1.4e7), mult: 2, desc: '2x lab', flavor: 'Shower thoughts', req: () => g.buildings.lab >= 1 },
        { id: 'l2', name: 'Peer Review', icon: 'üìù', bld: 'lab', cost: D(1.4e8), mult: 2, desc: '2x lab', flavor: 'Actually, no', req: () => g.upgrades.includes('l1') },
        { id: 'l3', name: 'Nobel Prize', icon: 'üèÖ', bld: 'lab', cost: D(1e11), mult: 3, desc: '3x lab', flavor: 'For science!', req: () => g.upgrades.includes('l2') },

        // Hub
        { id: 'h1', name: 'Drones', icon: 'üõ∏', bld: 'hub', cost: D(2e8), mult: 2, desc: '2x hub', flavor: 'Sky delivery', req: () => g.buildings.hub >= 1 },
        { id: 'h2', name: 'Teleport', icon: 'üåÄ', bld: 'hub', cost: D(2e9), mult: 2, desc: '2x hub', flavor: 'Instant shipping', req: () => g.upgrades.includes('h1') },
        { id: 'h3', name: 'Time Ship', icon: '‚è∞', bld: 'hub', cost: D(2e12), mult: 3, desc: '3x hub', flavor: 'Arrived yesterday', req: () => g.upgrades.includes('h2') },

        // Launch
        { id: 'lp1', name: 'Reusable', icon: '‚ôªÔ∏è', bld: 'launch', cost: D(3.3e9), mult: 2, desc: '2x launch', flavor: 'Cost savings', req: () => g.buildings.launch >= 1 },
        { id: 'lp2', name: 'Orbital', icon: 'üõ∞Ô∏è', bld: 'launch', cost: D(3.3e10), mult: 2, desc: '2x launch', flavor: 'Zero-G factory', req: () => g.upgrades.includes('lp1') },
        { id: 'lp3', name: 'Dyson', icon: '‚òÄÔ∏è', bld: 'launch', cost: D(3e13), mult: 3, desc: '3x launch', flavor: 'Solar megastructure', req: () => g.upgrades.includes('lp2') },

        // Quantum
        { id: 'q1', name: 'Entangle', icon: 'üîó', bld: 'quantum', cost: D(5e10), mult: 2, desc: '2x quantum', flavor: 'Spooky action', req: () => g.buildings.quantum >= 1 },
        { id: 'q2', name: 'Superpos', icon: '‚öõÔ∏è', bld: 'quantum', cost: D(5e11), mult: 2, desc: '2x quantum', flavor: 'Exists everywhere', req: () => g.upgrades.includes('q1') },

        // Rift
        { id: 'r1', name: 'Expansion', icon: 'üåå', bld: 'rift', cost: D(7.5e11), mult: 2, desc: '2x rift', flavor: 'Bigger portal', req: () => g.buildings.rift >= 1 },
        { id: 'r2', name: 'Multiverse', icon: '‚õèÔ∏è', bld: 'rift', cost: D(7.5e12), mult: 2, desc: '2x rift', flavor: 'Infinite resources', req: () => g.upgrades.includes('r1') },

        // Global
        { id: 'g1', name: 'Synergy I', icon: 'üîÑ', type: 'all', cost: D(5000), mult: 1.1, desc: '+10% all', flavor: 'Teamwork', req: () => g.buildings.conveyor >= 5 },
        { id: 'g2', name: 'Synergy II', icon: 'üì¶', type: 'all', cost: D(1e5), mult: 1.15, desc: '+15% all', flavor: 'Supply chain', req: () => g.upgrades.includes('g1') },
        { id: 'g3', name: 'Synergy III', icon: 'üìà', type: 'all', cost: D(5e6), mult: 1.25, desc: '+25% all', flavor: 'Integration', req: () => g.upgrades.includes('g2') },
        { id: 'g4', name: 'Revolution', icon: 'üèõÔ∏è', type: 'all', cost: D(1e9), mult: 1.5, desc: '+50% all', flavor: 'New era', req: () => g.upgrades.includes('g3') },
        { id: 'g5', name: 'Singularity', icon: 'üåü', type: 'all', cost: D(1e12), mult: 2, desc: '2x all', flavor: 'Transcendence', req: () => g.upgrades.includes('g4') },

        // Widget unlock
        { id: 'w1', name: 'Widget Lab', icon: '‚öôÔ∏è', type: 'widget', cost: D(1e6), mult: 1, desc: 'Unlock widgets', flavor: 'New resource', req: () => g.totalComp.gte(1e5) },
        { id: 'w2', name: 'Widget Eff', icon: 'üìê', type: 'widget', costType: 'widgets', cost: D(10), mult: 2, desc: '2x widgets', flavor: 'Optimization', req: () => g.upgrades.includes('w1') && g.widgets.gte(5) },
        { id: 'w3', name: 'Widget Pro', icon: 'üéì', type: 'widget', costType: 'widgets', cost: D(100), mult: 2, desc: '2x widgets', flavor: 'PhD level', req: () => g.upgrades.includes('w2') },

        // Automation
        { id: 'a1', name: 'Auto-Bench', icon: 'ü§ñ', type: 'auto', cost: D(1e8), mult: 1, desc: 'Auto-buy benches', flavor: 'Set and forget', req: () => g.buildings.bench >= 50 },
        { id: 'a2', name: 'Offline I', icon: 'üò¥', type: 'offline', cost: D(1e9), mult: 1.25, desc: '25% offline eff', flavor: 'Works while you sleep', req: () => g.offlineTime > 3600 },
        { id: 'a3', name: 'Offline II', icon: 'üåô', type: 'offline', cost: D(1e11), mult: 1.5, desc: '50% offline eff', flavor: 'Dream factory', req: () => g.upgrades.includes('a2') },
        { id: 'a4', name: 'Offline +4h', icon: '‚è∞', type: 'offCap', cost: D(1e10), mult: 4, desc: '+4h offline cap', flavor: 'Extended vacation', req: () => g.offlineTime > 14400 },

        // Golden
        { id: 'gl1', name: 'Golden Touch', icon: '‚ú®', type: 'golden', cost: D(1e7), mult: 2, desc: '2x golden rewards', flavor: 'Midas touch', req: () => g.goldenClicks >= 5 },
        { id: 'gl2', name: 'Lucky Star', icon: 'üçÄ', type: 'golden', cost: D(1e9), mult: 1.5, desc: '50% more gears', flavor: 'Fortune favors', req: () => g.upgrades.includes('gl1') },
    ];

    // Prestige Upgrades
    const PRESTIGE_UPG = [
        { id: 'p1', name: 'Head Start', icon: 'üèÉ', cost: 5, desc: 'Start with 5 benches', req: () => true },
        { id: 'p2', name: 'Fast Start', icon: '‚ö°', cost: 10, desc: 'Start with 3 conveyors', req: () => g.pUpgrades.includes('p1') },
        { id: 'p3', name: 'Efficiency', icon: 'üìà', cost: 15, desc: '+25% base prod', req: () => g.pUpgrades.includes('p2') },
        { id: 'p4', name: 'Click Echo', icon: 'üëÜ', cost: 20, desc: 'Clicks +1% of prod/s', req: () => g.pUpgrades.includes('p1') },
        { id: 'p5', name: 'BP Bonus', icon: 'üìê', cost: 25, desc: '+50% blueprint gain', req: () => g.pUpgrades.includes('p3') },
        { id: 'p6', name: 'Offline+', icon: 'üåô', cost: 30, desc: '+4h offline cap', req: () => g.pUpgrades.includes('p3') },
        { id: 'p7', name: 'Golden Age', icon: '‚≠ê', cost: 35, desc: '2x gear spawn rate', req: () => g.pUpgrades.includes('p1') },
        { id: 'p8', name: 'Titan', icon: 'üèõÔ∏è', cost: 50, desc: '+100% base prod', req: () => g.pUpgrades.includes('p3') && g.pUpgrades.includes('p5') },
        { id: 'p9', name: 'Transcend', icon: '‚ú®', cost: 100, desc: '+10% all mults', req: () => g.pUpgrades.includes('p8') },
        { id: 'p10', name: 'Eternal', icon: '‚ôæÔ∏è', cost: 200, desc: '3x all prod', req: () => g.pUpgrades.includes('p9') },
    ];

    // Achievements
    const ACHIEVES = [
        { id: 'c1', name: 'First Part', icon: 'üî©', tier: 1, desc: 'Produce 1 component', bonus: 0.01, check: () => g.totalComp.gte(1) },
        { id: 'c2', name: 'Hundred', icon: 'üî©', tier: 1, desc: 'Produce 100', bonus: 0.01, check: () => g.totalComp.gte(100) },
        { id: 'c3', name: 'Thousand', icon: 'üî©', tier: 2, desc: 'Produce 10K', bonus: 0.02, check: () => g.totalComp.gte(1e4) },
        { id: 'c4', name: 'Million', icon: 'üî©', tier: 2, desc: 'Produce 1M', bonus: 0.02, check: () => g.totalComp.gte(1e6) },
        { id: 'c5', name: 'Billion', icon: 'üî©', tier: 3, desc: 'Produce 1B', bonus: 0.05, check: () => g.totalComp.gte(1e9) },
        { id: 'c6', name: 'Trillion', icon: 'üî©', tier: 3, desc: 'Produce 1T', bonus: 0.05, check: () => g.totalComp.gte(1e12) },
        { id: 'c7', name: 'Universal', icon: 'üî©', tier: 3, desc: 'Produce 1e20', bonus: 0.1, check: () => g.totalComp.gte(1e20) },

        { id: 'k1', name: 'Click 10', icon: 'üëÜ', tier: 1, desc: 'Click 10 times', bonus: 0.01, check: () => g.clicks >= 10 },
        { id: 'k2', name: 'Click 100', icon: 'üëÜ', tier: 1, desc: 'Click 100 times', bonus: 0.01, check: () => g.clicks >= 100 },
        { id: 'k3', name: 'Click 1K', icon: 'üëÜ', tier: 2, desc: 'Click 1,000 times', bonus: 0.02, check: () => g.clicks >= 1000 },
        { id: 'k4', name: 'Click 10K', icon: 'üëÜ', tier: 3, desc: 'Click 10,000 times', bonus: 0.05, check: () => g.clicks >= 10000 },

        { id: 'b1', name: 'Builder 10', icon: 'üèóÔ∏è', tier: 1, desc: 'Own 10 buildings', bonus: 0.01, check: () => totalBld() >= 10 },
        { id: 'b2', name: 'Builder 50', icon: 'üèóÔ∏è', tier: 2, desc: 'Own 50 buildings', bonus: 0.02, check: () => totalBld() >= 50 },
        { id: 'b3', name: 'Builder 200', icon: 'üèóÔ∏è', tier: 3, desc: 'Own 200 buildings', bonus: 0.05, check: () => totalBld() >= 200 },
        { id: 'b4', name: 'Builder 500', icon: 'üèóÔ∏è', tier: 3, desc: 'Own 500 buildings', bonus: 0.1, check: () => totalBld() >= 500 },

        { id: 'u1', name: 'Upgrader 5', icon: '‚¨ÜÔ∏è', tier: 1, desc: 'Buy 5 upgrades', bonus: 0.01, check: () => g.upgrades.length >= 5 },
        { id: 'u2', name: 'Upgrader 15', icon: '‚¨ÜÔ∏è', tier: 2, desc: 'Buy 15 upgrades', bonus: 0.02, check: () => g.upgrades.length >= 15 },
        { id: 'u3', name: 'Upgrader 30', icon: '‚¨ÜÔ∏è', tier: 3, desc: 'Buy 30 upgrades', bonus: 0.05, check: () => g.upgrades.length >= 30 },

        { id: 't1', name: '10 Minutes', icon: '‚òï', tier: 1, desc: 'Play 10 min', bonus: 0.01, check: () => g.playTime >= 600 },
        { id: 't2', name: '1 Hour', icon: 'üçî', tier: 2, desc: 'Play 1 hour', bonus: 0.02, check: () => g.playTime >= 3600 },
        { id: 't3', name: '8 Hours', icon: 'üíº', tier: 3, desc: 'Play 8 hours', bonus: 0.05, check: () => g.playTime >= 28800 },
        { id: 't4', name: '24 Hours', icon: 'üèÜ', tier: 3, desc: 'Play 24 hours', bonus: 0.1, check: () => g.playTime >= 86400 },

        { id: 'r1', name: 'Reset 1', icon: 'üîÑ', tier: 2, desc: 'First prestige', bonus: 0.05, check: () => g.prestiges >= 1 },
        { id: 'r2', name: 'Reset 5', icon: 'üîÑ', tier: 3, desc: '5 prestiges', bonus: 0.1, check: () => g.prestiges >= 5 },
        { id: 'r3', name: 'Reset 10', icon: 'üîÑ', tier: 3, desc: '10 prestiges', bonus: 0.15, check: () => g.prestiges >= 10 },

        { id: 'g1', name: 'Lucky 1', icon: '‚≠ê', tier: 1, desc: 'Click a golden gear', bonus: 0.02, check: () => g.goldenClicks >= 1 },
        { id: 'g2', name: 'Lucky 10', icon: '‚≠ê', tier: 2, desc: 'Click 10 gears', bonus: 0.05, check: () => g.goldenClicks >= 10 },
        { id: 'g3', name: 'Lucky 50', icon: '‚≠ê', tier: 3, desc: 'Click 50 gears', bonus: 0.1, check: () => g.goldenClicks >= 50 },

        { id: 's1', name: 'Night Owl', icon: 'ü¶â', tier: 2, desc: 'Play at 3 AM', bonus: 0.05, check: () => new Date().getHours() === 3, hidden: true },
        { id: 's2', name: 'Speedrun', icon: '‚ö°', tier: 3, desc: '1M in 10 min', bonus: 0.1, check: () => g.totalComp.gte(1e6) && g.playTime < 600, hidden: true },

        // QC Rush achievements
        { id: 'qc1', name: 'Inspector', icon: 'üéØ', tier: 1, desc: 'Complete QC Rush', bonus: 0.02, check: () => mgState.bestScore > 0 },
        { id: 'qc2', name: 'Sharp Eye', icon: 'üéØ', tier: 2, desc: 'Score 150 in QC', bonus: 0.03, check: () => mgState.bestScore >= 150 },
        { id: 'qc3', name: 'Quality Master', icon: 'üéØ', tier: 3, desc: 'Score 300 in QC', bonus: 0.05, check: () => mgState.bestScore >= 300 },
        { id: 'qc4', name: 'Perfect QC', icon: 'üåü', tier: 3, desc: 'Score 500 in QC', bonus: 0.1, check: () => mgState.bestScore >= 500, hidden: true },
    ];

    // Game State
    function newGame() {
        return {
            comp: D(0),
            widgets: D(0),
            proto: D(0),
            bp: 0,
            totalComp: D(0),
            lifeComp: D(0),
            highComp: D(0),
            buildings: {},
            upgrades: [],
            achieves: [],
            pUpgrades: [],
            clicks: 0,
            playTime: 0,
            offlineTime: 0,
            prestiges: 0,
            goldenClicks: 0,
            lastSave: Date.now(),
            started: Date.now(),
            settings: { muted: false, vol: 0.5 },
            activeBonus: null,
            bonusEnd: 0,
            fastestReset: Infinity,
        };
    }

    let g = newGame();
    BUILDINGS.forEach(b => g.buildings[b.id] = 0);

    // Game Calculations
    function clickVal() {
        let v = D(1);
        if (g.upgrades.includes('c1')) v = v.mul(2);
        if (g.upgrades.includes('c2')) v = v.mul(2);
        if (g.upgrades.includes('c3')) v = v.mul(5);
        if (g.upgrades.includes('c4')) v = v.mul(10);
        if (g.upgrades.includes('c5')) v = v.mul(100);
        v = v.mul(1 + g.bp * 0.01);
        v = v.mul(1 + achieveBonus());
        if (g.pUpgrades.includes('p4')) v = v.add(prodPerSec().mul(0.01));
        if (g.activeBonus === 'prod' && Date.now() < g.bonusEnd) v = v.mul(2);
        return v;
    }

    function bldCost(id, n = 1) {
        const b = BUILDINGS.find(x => x.id === id);
        if (!b) return D(Infinity);
        let total = D(0);
        const owned = g.buildings[id] || 0;
        for (let i = 0; i < n; i++) {
            total = total.add(b.cost.mul(Decimal.pow(b.mult, owned + i)));
        }
        return total;
    }

    function maxBuy(id) {
        const b = BUILDINGS.find(x => x.id === id);
        if (!b) return 0;
        let n = 0, total = D(0);
        const owned = g.buildings[id] || 0;
        while (n < 1000) {
            const cost = b.cost.mul(Decimal.pow(b.mult, owned + n));
            if (total.add(cost).gt(g.comp)) break;
            total = total.add(cost);
            n++;
        }
        return n;
    }

    function bldProd(id) {
        const b = BUILDINGS.find(x => x.id === id);
        if (!b) return D(0);
        let p = b.prod.mul(g.buildings[id] || 0);
        UPGRADES.forEach(u => {
            if (g.upgrades.includes(u.id) && u.bld === id) p = p.mul(u.mult);
        });
        UPGRADES.forEach(u => {
            if (g.upgrades.includes(u.id) && u.type === 'all') p = p.mul(u.mult);
        });
        if (g.pUpgrades.includes('p3')) p = p.mul(1.25);
        if (g.pUpgrades.includes('p8')) p = p.mul(2);
        if (g.pUpgrades.includes('p9')) p = p.mul(1.1);
        if (g.pUpgrades.includes('p10')) p = p.mul(3);
        return p;
    }

    function prodPerSec() {
        let t = D(0);
        BUILDINGS.forEach(b => t = t.add(bldProd(b.id)));
        t = t.mul(1 + g.bp * 0.01);
        t = t.mul(1 + achieveBonus());
        if (g.activeBonus === 'prod' && Date.now() < g.bonusEnd) t = t.mul(2);
        return t;
    }

    function widgetProd() {
        if (!g.upgrades.includes('w1')) return D(0);
        let b = D(1);
        if (g.upgrades.includes('w2')) b = b.mul(2);
        if (g.upgrades.includes('w3')) b = b.mul(2);
        // log10() returns a plain number, not a Decimal
        const logVal = prodPerSec().add(10).log10();
        return b.mul(logVal / 10);
    }

    function achieveBonus() {
        let b = 0;
        ACHIEVES.forEach(a => { if (g.achieves.includes(a.id)) b += a.bonus; });
        return b;
    }

    function totalBld() {
        let t = 0;
        Object.values(g.buildings).forEach(n => t += n);
        return t;
    }

    function prestigeGain() {
        if (g.lifeComp.lt(1e9)) return 0;
        let gain = Math.floor(g.lifeComp.div(1e9).sqrt().toNumber());
        if (g.pUpgrades.includes('p5')) gain = Math.floor(gain * 1.5);
        return gain;
    }

    function offlineEff() {
        let e = 0.1;
        if (g.upgrades.includes('a2')) e = 0.25;
        if (g.upgrades.includes('a3')) e = 0.5;
        return e;
    }

    function offlineCap() {
        let c = 8 * 3600;
        if (g.upgrades.includes('a4')) c += 4 * 3600;
        if (g.pUpgrades.includes('p6')) c += 4 * 3600;
        return c;
    }

    // Actions
    function doClick(e) {
        audio.init();
        const gain = clickVal();
        g.comp = g.comp.add(gain);
        g.totalComp = g.totalComp.add(gain);
        g.lifeComp = g.lifeComp.add(gain);
        g.clicks++;
        audio.click();
        spawnParticle(e, gain);
        updateResources();
    }

    function buyBld(id, n = 1) {
        audio.init();
        const b = BUILDINGS.find(x => x.id === id);
        if (!b || !b.unlock()) return;
        if (n === 'max') n = maxBuy(id);
        const cost = bldCost(id, n);
        if (g.comp.gte(cost) && n > 0) {
            g.comp = g.comp.sub(cost);
            g.buildings[id] += n;
            audio.buy();
            renderBuildings();
            updateResources();
        }
    }

    function buyUpg(id) {
        audio.init();
        const u = UPGRADES.find(x => x.id === id);
        if (!u || g.upgrades.includes(id) || !u.req()) return;
        const curr = u.costType === 'widgets' ? g.widgets : g.comp;
        if (curr.gte(u.cost)) {
            if (u.costType === 'widgets') g.widgets = g.widgets.sub(u.cost);
            else g.comp = g.comp.sub(u.cost);
            g.upgrades.push(id);
            audio.upgrade();
            toast('Upgrade: ' + u.name, 'success');
            renderUpgrades();
            updateResources();
        }
    }

    function buyPUpg(id) {
        audio.init();
        const u = PRESTIGE_UPG.find(x => x.id === id);
        if (!u || g.pUpgrades.includes(id) || !u.req()) return;
        if (g.bp >= u.cost) {
            g.bp -= u.cost;
            g.pUpgrades.push(id);
            audio.upgrade();
            toast('Prestige: ' + u.name, 'achievement');
            renderPrestige();
            updateResources();
        }
    }

    function doPrestige() {
        const gain = prestigeGain();
        if (gain <= 0) return;
        audio.prestige();

        const time = (Date.now() - g.started) / 1000;
        if (time < g.fastestReset) g.fastestReset = time;
        g.prestiges++;
        g.bp += gain;

        const keep = {
            settings: { ...g.settings },
            prestiges: g.prestiges,
            bp: g.bp,
            pUpgrades: [...g.pUpgrades],
            achieves: [...g.achieves],
            playTime: g.playTime,
            offlineTime: g.offlineTime,
            clicks: g.clicks,
            goldenClicks: g.goldenClicks,
            highComp: g.highComp.max(g.totalComp),
            fastestReset: g.fastestReset,
        };

        g = newGame();
        BUILDINGS.forEach(b => g.buildings[b.id] = 0);
        Object.assign(g, keep);

        if (g.pUpgrades.includes('p1')) g.buildings.bench = 5;
        if (g.pUpgrades.includes('p2')) g.buildings.conveyor = 3;

        toast('Factory Reset! +' + gain + ' üìê', 'achievement');
        renderAll();
        save();
    }

    // UI Rendering
    let needsRender = { buildings: true, upgrades: true, prestige: true, achieves: true, stats: true };

    function updateResources() {
        // Update resource values
        document.getElementById('componentsVal').textContent = fmt(g.comp);
        document.getElementById('widgetsVal').textContent = fmt(g.widgets);
        // Prototypes resource removed - was not implemented
        document.getElementById('blueprintsVal').textContent = g.bp;
        document.getElementById('blueprintsBonus').textContent = '+' + g.bp + '% prod';
        document.getElementById('clickVal').textContent = '+' + fmt(clickVal()) + '/click';

        // Update production rates with visual feedback
        const compProd = prodPerSec();
        const widgetProdRate = widgetProd();

        document.getElementById('componentsRate').textContent = '+' + fmt(compProd) + '/s';
        document.getElementById('widgetsRate').textContent = '+' + fmt(widgetProdRate) + '/s';
        document.getElementById('prodRate').textContent = fmt(compProd) + '/s total';

        // Add visual indicator for active production
        const compRateEl = document.getElementById('componentsRate');
        const compResEl = document.getElementById('compResource');
        if (compProd.gt(0)) {
            compRateEl.classList.add('active');
            compResEl.classList.add('producing');
        } else {
            compRateEl.classList.remove('active');
            compResEl.classList.remove('producing');
        }

        const widgetRateEl = document.getElementById('widgetsRate');
        if (widgetProdRate.gt(0)) {
            widgetRateEl.classList.add('active');
        } else {
            widgetRateEl.classList.remove('active');
        }

        // Update prestige info
        const pGain = prestigeGain();
        document.getElementById('prestigeReward').textContent = pGain + ' üìê';
        document.getElementById('prestigeBtn').disabled = pGain <= 0;

        if (g.totalComp.gt(g.highComp)) g.highComp = g.totalComp;

        // Update button states without rebuilding DOM
        updateButtonStates();
    }

    function updateButtonStates() {
        const grid = document.getElementById('buildingGrid');
        if (!grid) return;

        // Update building buy buttons and affordability in one pass
        const buildings = grid.children;
        for (let i = 0; i < buildings.length; i++) {
            const div = buildings[i];
            const buttons = div.querySelectorAll('.buy-btn');
            let id = null;

            for (let j = 0; j < buttons.length; j++) {
                const btn = buttons[j];
                id = btn.dataset.id;
                const n = btn.dataset.n === 'max' ? maxBuy(id) : parseInt(btn.dataset.n);
                btn.disabled = !g.comp.gte(bldCost(id, n)) || n <= 0;
            }

            if (id) {
                const canAfford = g.comp.gte(bldCost(id, 1));
                if (canAfford && !div.classList.contains('can-afford')) {
                    div.classList.add('can-afford');
                } else if (!canAfford && div.classList.contains('can-afford')) {
                    div.classList.remove('can-afford');
                }
            }
        }

        // Update upgrade affordability using data attributes
        const upgradeGrid = document.getElementById('upgradeGrid');
        if (!upgradeGrid) return;

        const upgrades = upgradeGrid.children;
        for (let i = 0; i < upgrades.length; i++) {
            const div = upgrades[i];
            if (div.classList.contains('purchased')) continue;

            const uid = div.dataset.uid;
            if (!uid) continue;

            const u = UPGRADES.find(x => x.id === uid);
            if (u) {
                const curr = u.costType === 'widgets' ? g.widgets : g.comp;
                const canAfford = curr.gte(u.cost);
                if (canAfford && !div.classList.contains('can-afford')) {
                    div.classList.add('can-afford');
                } else if (!canAfford && div.classList.contains('can-afford')) {
                    div.classList.remove('can-afford');
                }
            }
        }
    }

    function renderBuildings() {
        const grid = document.getElementById('buildingGrid');
        grid.innerHTML = '';

        BUILDINGS.forEach(b => {
            if (!b.unlock() && g.buildings[b.id] === 0) return;

            const owned = g.buildings[b.id] || 0;
            const cost1 = bldCost(b.id, 1);
            const canAfford = g.comp.gte(cost1);
            const prod = bldProd(b.id);

            const div = document.createElement('div');
            div.className = 'building' + (canAfford ? ' can-afford' : '') + (!b.unlock() ? ' locked' : '');
            div.innerHTML = `
                <div class="building-icon" data-id="${b.id}" title="Click to buy 1">${b.icon}</div>
                <div class="building-info">
                    <div class="building-name">${b.name} <span class="building-count">${owned}</span></div>
                    <div class="building-desc">${b.desc}</div>
                    <div class="building-stats"><span class="rate">+${fmt(prod)}/s</span> ¬∑ Cost: ${fmt(cost1)} üî©</div>
                </div>
                <div class="building-actions">
                    <button class="buy-btn" data-id="${b.id}" data-n="1">√ó1</button>
                    <button class="buy-btn" data-id="${b.id}" data-n="10">√ó10</button>
                    <button class="buy-btn" data-id="${b.id}" data-n="max">MAX</button>
                </div>
            `;
            grid.appendChild(div);
        });

        grid.querySelectorAll('.buy-btn').forEach(btn => {
            btn.onclick = () => {
                const n = btn.dataset.n === 'max' ? 'max' : parseInt(btn.dataset.n);
                buyBld(btn.dataset.id, n);
            };
            const id = btn.dataset.id;
            const n = btn.dataset.n === 'max' ? maxBuy(id) : parseInt(btn.dataset.n);
            btn.disabled = !g.comp.gte(bldCost(id, n)) || n <= 0;
        });

        // Click building icon to buy 1
        grid.querySelectorAll('.building-icon').forEach(icon => {
            icon.onclick = () => buyBld(icon.dataset.id, 1);
        });
    }

    function renderUpgrades() {
        const grid = document.getElementById('upgradeGrid');
        grid.innerHTML = '';
        document.getElementById('upgradeCount').textContent = g.upgrades.length + '/' + UPGRADES.length;

        const sorted = [...UPGRADES].sort((a, b) => {
            const aS = g.upgrades.includes(a.id) ? 2 : (a.req() ? 0 : 1);
            const bS = g.upgrades.includes(b.id) ? 2 : (b.req() ? 0 : 1);
            return aS - bS;
        });

        sorted.forEach(u => {
            const bought = g.upgrades.includes(u.id);
            const avail = u.req();
            if (!avail && !bought) return;

            const curr = u.costType === 'widgets' ? g.widgets : g.comp;
            const canAfford = curr.gte(u.cost);
            const icon = u.costType === 'widgets' ? '‚öôÔ∏è' : 'üî©';

            const div = document.createElement('div');
            div.className = 'upgrade' + (bought ? ' purchased' : '') + (!avail ? ' locked' : '') + (canAfford && !bought ? ' can-afford' : '');
            div.dataset.uid = u.id;
            div.innerHTML = `
                <div class="upgrade-header">
                    <span class="upgrade-name">${u.icon} ${u.name}</span>
                    ${bought ? '<span>‚úì</span>' : `<span class="upgrade-cost">${fmt(u.cost)} ${icon}</span>`}
                </div>
                <div class="upgrade-desc">${u.desc}</div>
                <div class="upgrade-flavor">${u.flavor}</div>
            `;
            if (!bought && avail) div.onclick = () => buyUpg(u.id);
            grid.appendChild(div);
        });
    }

    function renderPrestige() {
        const grid = document.getElementById('prestigeGrid');
        grid.innerHTML = '';
        document.getElementById('prestigeCount').textContent = g.pUpgrades.length + '/' + PRESTIGE_UPG.length;

        PRESTIGE_UPG.forEach(u => {
            const bought = g.pUpgrades.includes(u.id);
            const avail = u.req();

            const div = document.createElement('div');
            div.className = 'prestige-upgrade' + (bought ? ' purchased' : '') + (!avail ? ' locked' : '');
            div.innerHTML = `
                <div class="upgrade-header">
                    <span class="upgrade-name">${u.icon} ${u.name}</span>
                    ${bought ? '<span>‚úì</span>' : `<span class="upgrade-cost">${u.cost} üìê</span>`}
                </div>
                <div class="upgrade-desc">${u.desc}</div>
            `;
            if (!bought && avail) div.onclick = () => buyPUpg(u.id);
            grid.appendChild(div);
        });
    }

    function renderAchieves() {
        const grid = document.getElementById('achieveGrid');
        grid.innerHTML = '';
        document.getElementById('achieveCount').textContent = g.achieves.length + '/' + ACHIEVES.length;

        const tierColor = ['#666', '#cd7f32', '#c0c0c0', '#ffd700'];

        ACHIEVES.forEach(a => {
            if (a.hidden && !g.achieves.includes(a.id)) return;
            const unlocked = g.achieves.includes(a.id);

            const div = document.createElement('div');
            div.className = 'achievement' + (unlocked ? ' unlocked' : ' locked');
            div.innerHTML = `
                <span class="achievement-icon" style="color:${unlocked ? tierColor[a.tier] : '#444'}">${a.icon}</span>
                <div class="achievement-info">
                    <div class="achievement-name">${a.name}</div>
                    <div class="achievement-desc">${a.desc}</div>
                    ${unlocked ? `<div class="achievement-bonus">+${(a.bonus * 100).toFixed(0)}%</div>` : ''}
                </div>
            `;
            grid.appendChild(div);
        });
    }

    function renderStats() {
        const grid = document.getElementById('statsGrid');
        const stats = [
            ['Total Components', fmt(g.totalComp)],
            ['Lifetime Components', fmt(g.lifeComp)],
            ['Best Components', fmt(g.highComp)],
            ['Production/s', fmt(prodPerSec())],
            ['Click Value', fmt(clickVal())],
            ['Total Clicks', fmt(D(g.clicks))],
            ['Total Buildings', totalBld()],
            ['Upgrades', g.upgrades.length + '/' + UPGRADES.length],
            ['Achievements', g.achieves.length + '/' + ACHIEVES.length],
            ['Achievement Bonus', '+' + (achieveBonus() * 100).toFixed(1) + '%'],
            ['Blueprints', g.bp],
            ['Blueprint Bonus', '+' + g.bp + '%'],
            ['Prestiges', g.prestiges],
            ['QC Rush Best', mgState.bestScore],
            ['Play Time', fmtTime(g.playTime)],
            ['Offline Time', fmtTime(g.offlineTime)],
            ['Golden Gears', g.goldenClicks],
            ['Fastest Reset', g.fastestReset < Infinity ? fmtTime(g.fastestReset) : 'N/A'],
        ];

        grid.innerHTML = stats.map(([l, v]) => `
            <div class="stat"><span class="stat-label">${l}</span><span class="stat-value">${v}</span></div>
        `).join('');
    }

    function renderAll() {
        renderBuildings();
        renderUpgrades();
        renderPrestige();
        renderAchieves();
        renderStats();
        updateResources();
    }

    // Toasts
    function toast(msg, type = '') {
        const t = document.createElement('div');
        t.className = 'toast ' + type;
        t.textContent = msg;
        document.getElementById('toasts').appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    // Particles
    function spawnParticle(e, val) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.textContent = '+' + fmt(val);
        p.style.left = e.clientX + 'px';
        p.style.top = e.clientY + 'px';
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 800);
    }

    // Golden Gear
    let gearTimer = null;

    function spawnGear() {
        if (document.querySelector('.golden-gear')) return;
        const gear = document.createElement('div');
        gear.className = 'golden-gear';
        gear.textContent = '‚öôÔ∏è';
        // Safe positioning for mobile screens
        const maxX = Math.max(60, window.innerWidth - 60);
        const maxY = Math.max(150, window.innerHeight - 100);
        gear.style.left = (30 + Math.random() * (maxX - 60)) + 'px';
        gear.style.top = (100 + Math.random() * (maxY - 100)) + 'px';
        // Support both click and touch
        gear.onclick = gear.ontouchend = (e) => { e.preventDefault(); collectGear(gear); };
        document.body.appendChild(gear);
        setTimeout(() => { if (gear.parentNode) gear.remove(); }, 10000);
    }

    function collectGear(gear) {
        audio.init();
        audio.golden();
        gear.remove();
        g.goldenClicks++;

        const mult = g.upgrades.includes('gl1') ? 2 : 1;
        const roll = Math.random();

        if (roll < 0.4) {
            g.activeBonus = 'prod';
            g.bonusEnd = Date.now() + 30000;
            toast('‚≠ê 2x Production for 30s!', 'achievement');
        } else if (roll < 0.7) {
            const bonus = prodPerSec().mul(60 * mult);
            g.comp = g.comp.add(bonus);
            g.totalComp = g.totalComp.add(bonus);
            g.lifeComp = g.lifeComp.add(bonus);
            toast('‚≠ê +' + fmt(bonus) + ' Components!', 'achievement');
        } else {
            const bonus = clickVal().mul(100 * mult);
            g.comp = g.comp.add(bonus);
            g.totalComp = g.totalComp.add(bonus);
            g.lifeComp = g.lifeComp.add(bonus);
            toast('‚≠ê +' + fmt(bonus) + ' (100 clicks)!', 'achievement');
        }
        updateResources();
    }

    function scheduleGear() {
        let time = 120000 + Math.random() * 180000;
        if (g.upgrades.includes('gl2')) time *= 0.67;
        if (g.pUpgrades.includes('p7')) time *= 0.5;
        clearTimeout(gearTimer);
        gearTimer = setTimeout(() => { spawnGear(); scheduleGear(); }, time);
    }

    // Achievements Check
    function checkAchieves() {
        let found = false;
        ACHIEVES.forEach(a => {
            if (!g.achieves.includes(a.id) && a.check()) {
                g.achieves.push(a.id);
                found = true;
                audio.achieve();
                // Enhanced achievement notification
                const bonusText = a.bonus > 0 ? ` (+${(a.bonus * 100).toFixed(0)}% prod)` : '';
                celebrateAchievement(a.name, a.icon, bonusText);
            }
        });
        if (found) renderAchieves();
    }

    function celebrateAchievement(name, icon, bonus) {
        // Create celebration overlay
        const celebration = document.createElement('div');
        celebration.className = 'achievement-celebration';
        celebration.innerHTML = `
            <div class="achievement-popup">
                <div class="achievement-icon">${icon}</div>
                <div class="achievement-content">
                    <div class="achievement-label">ACHIEVEMENT UNLOCKED</div>
                    <div class="achievement-name">${name}</div>
                    <div class="achievement-bonus">${bonus}</div>
                </div>
            </div>
        `;
        document.body.appendChild(celebration);

        // Remove after animation
        setTimeout(() => celebration.remove(), 3000);
    }

    // Save/Load
    function save() {
        const data = {
            ...g,
            comp: g.comp.toString(),
            widgets: g.widgets.toString(),
            proto: g.proto.toString(),
            totalComp: g.totalComp.toString(),
            lifeComp: g.lifeComp.toString(),
            highComp: g.highComp.toString(),
            lastSave: Date.now(),
            mgBestScore: mgState.bestScore,
            mgCooldownEnd: mgState.cooldownEnd,
        };
        try {
            localStorage.setItem('idleFactory', JSON.stringify(data));
            toast('Saved!', 'success');
        } catch (e) {
            console.error('Save failed', e);
        }
    }

    function load() {
        try {
            const data = JSON.parse(localStorage.getItem('idleFactory'));
            if (!data) return false;

            g.comp = D(data.comp || 0);
            g.widgets = D(data.widgets || 0);
            g.proto = D(data.proto || 0);
            g.totalComp = D(data.totalComp || 0);
            g.lifeComp = D(data.lifeComp || 0);
            g.highComp = D(data.highComp || 0);
            g.bp = data.bp || 0;
            g.buildings = data.buildings || {};
            g.upgrades = data.upgrades || [];
            g.achieves = data.achieves || [];
            g.pUpgrades = data.pUpgrades || [];
            g.clicks = data.clicks || 0;
            g.playTime = data.playTime || 0;
            g.offlineTime = data.offlineTime || 0;
            g.prestiges = data.prestiges || 0;
            g.goldenClicks = data.goldenClicks || 0;
            g.lastSave = data.lastSave || Date.now();
            g.started = data.started || Date.now();
            g.settings = { ...g.settings, ...data.settings };
            g.fastestReset = data.fastestReset || Infinity;

            BUILDINGS.forEach(b => { if (g.buildings[b.id] === undefined) g.buildings[b.id] = 0; });

            // Load minigame state
            mgState.bestScore = data.mgBestScore || 0;
            mgState.cooldownEnd = data.mgCooldownEnd || 0;

            audio.setVol(g.settings.vol);
            audio.muted = g.settings.muted;

            return true;
        } catch (e) {
            console.error('Load failed', e);
            return false;
        }
    }

    function calcOffline() {
        const now = Date.now();
        const away = Math.min((now - g.lastSave) / 1000, offlineCap());
        if (away < 60) return;

        g.offlineTime += away;
        const prod = prodPerSec().mul(away * offlineEff());
        g.comp = g.comp.add(prod);
        g.totalComp = g.totalComp.add(prod);
        g.lifeComp = g.lifeComp.add(prod);

        const widget = widgetProd().mul(away * offlineEff());
        g.widgets = g.widgets.add(widget);

        showModal('Welcome Back!', 'You were away for ' + fmtTime(away),
            `<div style="background:var(--bg-card);padding:12px;margin:10px 0;">
                <div style="display:flex;justify-content:space-between;padding:4px 0;">
                    <span>üî© Components</span><span>+${fmt(prod)}</span>
                </div>
                ${widget.gt(0) ? `<div style="display:flex;justify-content:space-between;padding:4px 0;">
                    <span>‚öôÔ∏è Widgets</span><span>+${fmt(widget)}</span>
                </div>` : ''}
                <div style="display:flex;justify-content:space-between;padding:4px 0;color:var(--text-dim);">
                    <span>Efficiency</span><span>${(offlineEff() * 100).toFixed(0)}%</span>
                </div>
            </div>`,
            () => {}
        );
        document.getElementById('modalCancel').style.display = 'none';
        document.getElementById('modalConfirm').textContent = 'Continue';
    }

    // Modal
    function showModal(title, msg, content, onConfirm) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMsg').textContent = msg;
        document.getElementById('modalContent').innerHTML = content;
        document.getElementById('modalOverlay').classList.add('active');
        document.getElementById('modalCancel').style.display = '';
        document.getElementById('modalConfirm').textContent = 'Confirm';

        document.getElementById('modalConfirm').onclick = () => {
            document.getElementById('modalOverlay').classList.remove('active');
            if (onConfirm) onConfirm();
        };
        document.getElementById('modalCancel').onclick = () => {
            document.getElementById('modalOverlay').classList.remove('active');
        };
    }

    // Game Loop - Optimized for mobile
    let lastFrame = performance.now();
    let lastUIUpdate = 0;
    let lastButtonUpdate = 0;
    const UI_UPDATE_INTERVAL = 50;      // Update resource display every 50ms (20fps)
    const BUTTON_UPDATE_INTERVAL = 200; // Update button states every 200ms (5fps)

    function loop(now) {
        try {
            const dt = Math.min((now - lastFrame) / 1000, 0.1); // Cap dt to prevent huge jumps
            lastFrame = now;

            g.playTime += dt;

            // Calculate and add production
            const prod = prodPerSec().mul(dt);
            if (prod.gt(0)) {
                g.comp = g.comp.add(prod);
                g.totalComp = g.totalComp.add(prod);
                g.lifeComp = g.lifeComp.add(prod);
            }

            // Widget production
            const widgetProdAmt = widgetProd().mul(dt);
            if (widgetProdAmt.gt(0)) {
                g.widgets = g.widgets.add(widgetProdAmt);
            }

            // Auto-buy (throttled)
            if (g.upgrades.includes('a1') && now - lastButtonUpdate > 500) {
                const cost = bldCost('bench', 1);
                if (g.comp.gte(cost)) buyBld('bench', 1);
            }

            // Bonus expiry
            if (g.activeBonus && Date.now() >= g.bonusEnd) g.activeBonus = null;

            // Throttled UI updates for mobile performance
            if (now - lastUIUpdate >= UI_UPDATE_INTERVAL) {
                lastUIUpdate = now;
                updateResourcesLight();

                // Check achievements occasionally
                if (Math.random() < 0.1) checkAchieves();
            }

            // Even more throttled button state updates
            if (now - lastButtonUpdate >= BUTTON_UPDATE_INTERVAL) {
                lastButtonUpdate = now;
                updateButtonStates();
            }
        } catch (e) {
            console.error('Game loop error:', e);
        }

        requestAnimationFrame(loop);
    }

    // Lightweight resource update (no button states)
    function updateResourcesLight() {
        document.getElementById('componentsVal').textContent = fmt(g.comp);
        document.getElementById('widgetsVal').textContent = fmt(g.widgets);
        document.getElementById('blueprintsVal').textContent = g.bp;

        const compProd = prodPerSec();
        document.getElementById('componentsRate').textContent = '+' + fmt(compProd) + '/s';
        document.getElementById('prodRate').textContent = fmt(compProd) + '/s total';

        if (g.totalComp.gt(g.highComp)) g.highComp = g.totalComp;

        // Update boost indicator
        updateBoostIndicator();
    }

    function updateBoostIndicator() {
        const indicator = document.getElementById('boostIndicator');
        const textEl = document.getElementById('boostText');
        const timerEl = document.getElementById('boostTimer');

        if (g.activeBonus === 'prod' && Date.now() < g.bonusEnd) {
            const remaining = Math.ceil((g.bonusEnd - Date.now()) / 1000);
            indicator.classList.add('active');
            textEl.textContent = '2x PRODUCTION';
            timerEl.textContent = remaining + 's';
        } else {
            indicator.classList.remove('active');
        }
    }

    // ============================================
    // QUALITY CONTROL MINIGAME
    // ============================================

    const MINIGAME = {
        DURATION: 30,           // seconds
        COOLDOWN: 180,          // seconds (3 minutes)
        SPAWN_RATE: 800,        // ms between spawns (gets faster)
        GOOD_ITEMS: ['üî©', '‚öôÔ∏è', 'üîß', 'üî®', '‚õèÔ∏è', 'üõ†Ô∏è'],
        BAD_ITEMS: ['üí•', '‚ö†Ô∏è', 'üî•', 'üíÄ', '‚ò†Ô∏è', 'üö´'],
        LANES: 4,
        ITEM_SPEED: 3,          // seconds to cross screen
    };

    let mgState = {
        active: false,
        score: 0,
        combo: 1,
        maxCombo: 1,
        timeLeft: MINIGAME.DURATION,
        items: [],
        spawnTimer: null,
        gameTimer: null,
        tickTimer: null,
        cooldownEnd: 0,
        bestScore: 0,
    };

    function openMinigame() {
        if (Date.now() < mgState.cooldownEnd) return;

        document.getElementById('minigameOverlay').classList.add('active');
        document.getElementById('mgInstructions').style.display = 'flex';
        document.getElementById('mgResults').classList.remove('active');

        // Reset state
        mgState.active = false;
        mgState.score = 0;
        mgState.combo = 1;
        mgState.maxCombo = 1;
        mgState.timeLeft = MINIGAME.DURATION;
        mgState.items = [];

        updateMinigameUI();
    }

    function startMinigame() {
        document.getElementById('mgInstructions').style.display = 'none';
        mgState.active = true;

        // Create conveyor lanes
        const area = document.getElementById('minigameArea');
        const areaHeight = area.clientHeight;
        const laneHeight = 90; // Larger lanes for bigger touch targets
        const totalLanesHeight = MINIGAME.LANES * laneHeight;
        const startY = (areaHeight - totalLanesHeight) / 2;

        // Clear old lanes
        area.querySelectorAll('.conveyor-lane').forEach(l => l.remove());

        for (let i = 0; i < MINIGAME.LANES; i++) {
            const lane = document.createElement('div');
            lane.className = 'conveyor-lane';
            lane.style.top = (startY + i * laneHeight) + 'px';
            lane.style.height = laneHeight + 'px';
            area.appendChild(lane);
        }

        // Start spawning
        spawnMinigameItem();
        mgState.spawnTimer = setInterval(() => {
            if (mgState.active) spawnMinigameItem();
        }, MINIGAME.SPAWN_RATE);

        // Start timer
        mgState.tickTimer = setInterval(() => {
            if (!mgState.active) return;
            mgState.timeLeft -= 0.1;
            updateMinigameUI();

            if (mgState.timeLeft <= 0) {
                endMinigame();
            }
        }, 100);

        // Speed up spawns over time
        mgState.gameTimer = setInterval(() => {
            if (!mgState.active) return;
            clearInterval(mgState.spawnTimer);
            const newRate = Math.max(300, MINIGAME.SPAWN_RATE - (MINIGAME.DURATION - mgState.timeLeft) * 15);
            mgState.spawnTimer = setInterval(() => {
                if (mgState.active) spawnMinigameItem();
            }, newRate);
        }, 5000);

        audio.init();
    }

    function spawnMinigameItem() {
        const area = document.getElementById('minigameArea');
        const areaHeight = area.clientHeight;
        const laneHeight = 90;
        const totalLanesHeight = MINIGAME.LANES * laneHeight;
        const startY = (areaHeight - totalLanesHeight) / 2;

        const isGood = Math.random() > 0.35; // 65% good, 35% bad
        const lane = Math.floor(Math.random() * MINIGAME.LANES);
        const items = isGood ? MINIGAME.GOOD_ITEMS : MINIGAME.BAD_ITEMS;
        const icon = items[Math.floor(Math.random() * items.length)];

        const item = document.createElement('div');
        item.className = 'minigame-item ' + (isGood ? 'good' : 'bad');
        item.textContent = icon;
        item.dataset.good = isGood;
        item.style.left = '-80px';
        item.style.top = (startY + lane * laneHeight + 10) + 'px';

        // Animate across screen
        const speed = MINIGAME.ITEM_SPEED - (MINIGAME.DURATION - mgState.timeLeft) * 0.03;
        item.style.transition = `left ${Math.max(1.5, speed)}s linear`;

        const handleClick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (item.classList.contains('clicked')) return;

            item.classList.add('clicked');
            const rect = item.getBoundingClientRect();

            if (isGood) {
                // Good item clicked = points!
                const points = 10 * mgState.combo;
                mgState.score += points;
                mgState.combo = Math.min(mgState.combo + 1, 10);
                mgState.maxCombo = Math.max(mgState.maxCombo, mgState.combo);
                showMinigameFeedback(rect.left + 30, rect.top, '+' + points, 'good');
                audio.click();
            } else {
                // Bad item clicked = penalty!
                mgState.score = Math.max(0, mgState.score - 20);
                mgState.combo = 1;
                showMinigameFeedback(rect.left + 30, rect.top, '-20', 'bad');
                audio.prestige(); // Use prestige sound as "error"
            }

            updateMinigameUI();
            setTimeout(() => item.remove(), 300);
        };

        item.onclick = handleClick;
        item.ontouchend = handleClick;

        area.appendChild(item);

        // Start animation after append
        requestAnimationFrame(() => {
            item.style.left = (area.clientWidth + 70) + 'px';
        });

        // Remove when off screen and penalize missed good items
        setTimeout(() => {
            if (!item.classList.contains('clicked') && item.parentNode) {
                if (isGood) {
                    // Missed a good item!
                    mgState.combo = 1;
                }
                item.remove();
            }
        }, (Math.max(1.5, speed) + 0.5) * 1000);
    }

    function showMinigameFeedback(x, y, text, type) {
        const fb = document.createElement('div');
        fb.className = 'minigame-feedback ' + type;
        fb.textContent = text;
        fb.style.left = x + 'px';
        fb.style.top = y + 'px';
        document.getElementById('minigameArea').appendChild(fb);
        setTimeout(() => fb.remove(), 800);
    }

    function updateMinigameUI() {
        document.getElementById('mgTime').textContent = Math.ceil(mgState.timeLeft);
        document.getElementById('mgScore').textContent = mgState.score;
        document.getElementById('mgCombo').textContent = 'x' + mgState.combo;

        // Update combo color based on value
        const comboEl = document.getElementById('mgCombo');
        if (mgState.combo >= 8) {
            comboEl.style.color = '#ff6b9d';
        } else if (mgState.combo >= 5) {
            comboEl.style.color = '#ffd700';
        } else if (mgState.combo >= 3) {
            comboEl.style.color = '#3fb950';
        } else {
            comboEl.style.color = '';
        }

        // Update cooldown bar
        updateCooldownBar();
    }

    function updateCooldownBar() {
        const now = Date.now();
        const btn = document.getElementById('minigameBtn');
        const bar = document.getElementById('cooldownBar');

        if (now < mgState.cooldownEnd) {
            const remaining = mgState.cooldownEnd - now;
            const total = MINIGAME.COOLDOWN * 1000;
            const pct = (remaining / total) * 100;
            bar.style.width = (100 - pct) + '%';
            btn.disabled = true;
            btn.title = `Cooldown: ${Math.ceil(remaining / 1000)}s`;
        } else {
            bar.style.width = '100%';
            btn.disabled = false;
            btn.title = 'Quality Control Rush';
        }
    }

    function endMinigame() {
        mgState.active = false;
        clearInterval(mgState.spawnTimer);
        clearInterval(mgState.gameTimer);
        clearInterval(mgState.tickTimer);

        // Clear remaining items
        document.querySelectorAll('.minigame-item').forEach(i => i.remove());

        // Determine rank and rewards
        const score = mgState.score;
        let rank, rankClass, compReward, multiplier, duration, bpChance;

        if (score >= 500) {
            rank = 'üåü PERFECT INSPECTOR';
            rankClass = 'perfect';
            compReward = prodPerSec().mul(180); // 3 min production
            multiplier = 3;
            duration = 120;
            bpChance = 0.25;
        } else if (score >= 300) {
            rank = 'ü•á GOLD RANK';
            rankClass = 'gold';
            compReward = prodPerSec().mul(120); // 2 min production
            multiplier = 2;
            duration = 90;
            bpChance = 0.1;
        } else if (score >= 150) {
            rank = 'ü•à SILVER RANK';
            rankClass = 'silver';
            compReward = prodPerSec().mul(60); // 1 min production
            multiplier = 1.5;
            duration = 60;
            bpChance = 0;
        } else {
            rank = 'ü•â BRONZE RANK';
            rankClass = 'bronze';
            compReward = prodPerSec().mul(30); // 30s production
            multiplier = 1.25;
            duration = 30;
            bpChance = 0;
        }

        // Apply rewards
        if (compReward.lt(100)) compReward = D(100); // Minimum reward
        g.comp = g.comp.add(compReward);
        g.totalComp = g.totalComp.add(compReward);
        g.lifeComp = g.lifeComp.add(compReward);

        // Production boost
        g.activeBonus = 'prod';
        g.bonusEnd = Date.now() + duration * 1000;

        // Chance for blueprint
        let bpGained = 0;
        if (Math.random() < bpChance) {
            bpGained = 1;
            g.bp += 1;
        }

        // Update best score
        if (score > mgState.bestScore) mgState.bestScore = score;

        // Show results
        const results = document.getElementById('mgResults');
        results.className = 'minigame-results active ' + rankClass;
        document.getElementById('mgRank').textContent = rank;
        document.getElementById('mgFinalScore').textContent = score;

        let rewardText = `+${fmt(compReward)} üî©\n${multiplier}x prod for ${duration}s`;
        if (bpGained > 0) rewardText += '\n+1 üìê BLUEPRINT!';
        document.getElementById('mgReward').innerHTML = rewardText.replace(/\n/g, '<br>');

        // Set cooldown
        mgState.cooldownEnd = Date.now() + MINIGAME.COOLDOWN * 1000;

        audio.upgrade();
    }

    function closeMinigame() {
        document.getElementById('minigameOverlay').classList.remove('active');
        document.querySelectorAll('.conveyor-lane').forEach(l => l.remove());
        updateResources();
    }

    // Event Setup
    function setup() {
        document.getElementById('mainBtn').onclick = doClick;
        document.getElementById('mainBtn').ontouchstart = (e) => { e.preventDefault(); doClick(e); };

        // Minigame button
        document.getElementById('minigameBtn').onclick = openMinigame;
        document.getElementById('mgStart').onclick = startMinigame;
        document.getElementById('mgClose').onclick = closeMinigame;

        // Update cooldown bar periodically
        setInterval(updateCooldownBar, 1000);

        document.getElementById('saveBtn').onclick = save;
        document.getElementById('muteBtn').onclick = () => {
            audio.init();
            g.settings.muted = audio.mute();
            document.getElementById('muteBtn').textContent = g.settings.muted ? 'üîá' : 'üîä';
        };

        document.getElementById('optionsBtn').onclick = () => {
            document.getElementById('optionsPanel').classList.toggle('active');
        };

        document.addEventListener('click', (e) => {
            const panel = document.getElementById('optionsPanel');
            const btn = document.getElementById('optionsBtn');
            if (!panel.contains(e.target) && !btn.contains(e.target)) {
                panel.classList.remove('active');
            }
        });

        document.getElementById('volumeSlider').oninput = (e) => {
            g.settings.vol = e.target.value / 100;
            audio.setVol(g.settings.vol);
        };

        document.getElementById('numberFormat').onchange = () => renderAll();

        document.getElementById('exportBtn').onclick = () => {
            save();
            const data = btoa(localStorage.getItem('idleFactory'));
            navigator.clipboard.writeText(data).then(() => toast('Copied!', 'success'))
                .catch(() => prompt('Copy:', data));
        };

        document.getElementById('importBtn').onclick = () => {
            const data = prompt('Paste save:');
            if (!data) return;
            try {
                localStorage.setItem('idleFactory', atob(data));
                location.reload();
            } catch (e) {
                toast('Invalid save!');
            }
        };

        document.getElementById('resetBtn').onclick = () => {
            showModal('Hard Reset', 'Delete ALL progress?', '<p style="color:var(--danger)">This cannot be undone!</p>', () => {
                localStorage.removeItem('idleFactory');
                location.reload();
            });
        };

        document.querySelectorAll('.tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + 'Panel').classList.add('active');
            };
        });

        document.getElementById('prestigeBtn').onclick = () => {
            const gain = prestigeGain();
            showModal('Factory Reset', 'Reset progress for ' + gain + ' üìê Blueprints?',
                '<p style="font-size:12px;color:var(--text-dim)">Buildings & upgrades reset. Blueprints & prestige upgrades are permanent.</p>',
                doPrestige
            );
        };

        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            const key = e.key.toLowerCase();
            if (key === 'm') document.getElementById('muteBtn').click();
            if (key === 's') save();
            if (key === 'q') openMinigame();
            if (key === ' ' || key === 'f') {
                e.preventDefault();
                document.getElementById('mainBtn').click();
            }
            // Number keys for tabs
            if (key >= '1' && key <= '5') {
                const tabs = document.querySelectorAll('.tab');
                const idx = parseInt(key) - 1;
                if (tabs[idx]) tabs[idx].click();
            }
        });

        setInterval(save, 30000);
    }

    // Init
    // Hint System for new players
    const HINTS = [
        { check: () => g.clicks < 5 && g.playTime < 30, text: 'üí° Click FABRICATE or press SPACE to produce components!' },
        { check: () => g.buildings.bench === 0 && g.comp.gte(10) && g.playTime < 120, text: 'üí° You have enough for a Workbench! Buildings produce components automatically.' },
        { check: () => g.buildings.bench >= 1 && g.buildings.conveyor === 0 && g.buildings.bench < 5, text: 'üí° Tip: Get 5 Workbenches to unlock the next building tier!' },
        { check: () => g.upgrades.length === 0 && g.comp.gte(50) && g.playTime > 60, text: 'üí° Check the Upgrades tab - upgrades multiply your production!' },
        { check: () => g.playTime > 180 && mgState.bestScore === 0, text: 'üí° Try the QC Rush minigame for bonus components and production boosts!' },
        { check: () => g.lifeComp.gte(1e8) && g.prestiges === 0, text: 'üí° You\'re doing great! Consider prestiging for permanent Blueprint bonuses.' },
    ];

    let lastHintTime = 0;
    let shownHints = new Set();

    function checkHints() {
        if (Date.now() - lastHintTime < 60000) return; // Max one hint per minute

        for (const hint of HINTS) {
            if (!shownHints.has(hint.text) && hint.check()) {
                showHint(hint.text);
                shownHints.add(hint.text);
                lastHintTime = Date.now();
                break;
            }
        }
    }

    function showHint(text) {
        const hint = document.createElement('div');
        hint.className = 'game-hint';
        hint.textContent = text;
        hint.onclick = () => hint.remove();
        document.body.appendChild(hint);
        setTimeout(() => { if (hint.parentNode) hint.remove(); }, 8000);
    }

    function init() {
        const hasSave = load();
        if (hasSave) calcOffline();

        document.getElementById('volumeSlider').value = g.settings.vol * 100;
        document.getElementById('muteBtn').textContent = g.settings.muted ? 'üîá' : 'üîä';

        setup();
        renderAll();
        requestAnimationFrame(loop);
        scheduleGear();

        // Check hints periodically
        setInterval(checkHints, 10000);

        console.log('// IDLE FACTORY v1.0.0');
        console.log('// Keyboard: F=Fabricate, Q=QC Rush, S=Save, M=Mute, 1-5=Tabs');
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    </script>
</body>
</html>
