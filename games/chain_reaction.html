<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <title>Chain Reaction</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #080810;
            color: #fff;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            height: 100dvh;
            user-select: none;
            touch-action: none
        }

        #gameCanvas {
            display: block;
            background: #0a0a12;
            cursor: crosshair
        }

        #ui {
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 10;
            pointer-events: none
        }

        #score {
            font-size: 48px;
            font-weight: 800;
            color: #00E5FF;
            letter-spacing: -2px;
            text-shadow: 0 0 30px rgba(0, 229, 255, .4);
            transition: color .3s, transform .1s
        }

        #score.pop {
            transform: scale(1.08)
        }

        #multiplier {
            font-size: 13px;
            color: #444;
            margin-top: 2px;
            height: 16px
        }

        #multiplier span {
            color: #00E5FF
        }

        #waveLine {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 10px 0
        }

        #wave {
            font-size: 13px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px
        }

        #waveProgress {
            flex: 1;
            max-width: 140px;
            height: 4px;
            background: #1a1a2e;
            border-radius: 2px;
            overflow: hidden
        }

        #waveProgressBar {
            height: 100%;
            background: #00E5FF;
            transition: width .3s, background .3s
        }

        #lives {
            display: flex;
            gap: 6px;
            margin: 12px 0
        }

        .life {
            width: 22px;
            height: 22px;
            background: #FF1744;
            border-radius: 50%;
            transition: all .2s
        }

        .life.lost {
            background: #1a1a2e;
            transform: scale(.6);
            opacity: .3
        }

        #chainBox {
            margin-top: 12px;
            padding: 10px 14px;
            background: rgba(255, 215, 0, .08);
            border-left: 3px solid #FFD700;
            opacity: 0;
            transform: translateX(-8px);
            transition: all .25s
        }

        #chainBox.visible {
            opacity: 1;
            transform: translateX(0)
        }

        #chainLabel {
            font-size: 10px;
            color: #998200;
            text-transform: uppercase;
            letter-spacing: 2px
        }

        #chainCount {
            font-size: 32px;
            font-weight: 800;
            color: #FFD700
        }

        #powerupSlots {
            display: flex;
            gap: 8px;
            margin-top: 14px
        }

        .pu-slot {
            width: 42px;
            height: 42px;
            background: #12121a;
            border: 2px solid #252530;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            position: relative;
            opacity: .35;
            transition: all .2s;
            overflow: hidden
        }

        .pu-slot.ready {
            opacity: 1;
            border-color: #00E5FF;
            cursor: pointer;
            pointer-events: all
        }

        .pu-slot.ready:hover {
            transform: scale(1.1);
            border-color: #fff
        }

        .pu-slot.active {
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, .3)
        }

        .pu-slot .cd {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, .8)
        }

        .pu-slot .key {
            position: absolute;
            bottom: -18px;
            font-size: 9px;
            color: #333;
            font-weight: 600
        }

        #stats {
            position: absolute;
            top: 16px;
            right: 16px;
            text-align: right;
            font-size: 12px;
            color: #444;
            pointer-events: none
        }

        #stats div {
            margin-bottom: 5px
        }

        #stats span {
            color: #00E5FF;
            font-weight: 700;
            font-size: 14px
        }

        #bottomLeft {
            position: absolute;
            bottom: 16px;
            left: 16px;
            pointer-events: none
        }

        #waveBonus {
            font-size: 11px;
            color: #333;
            margin-bottom: 6px
        }

        #waveBonus.perfect {
            color: #4CAF50
        }

        #waveBonus span {
            font-weight: 700
        }

        #circleCount {
            font-size: 10px;
            color: #252530
        }

        #zoomMeter {
            position: absolute;
            bottom: 16px;
            right: 16px;
            pointer-events: none;
            text-align: right
        }

        #zoomLabel {
            font-size: 10px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 3px
        }

        #zoomBar {
            width: 100px;
            height: 5px;
            background: #1a1a2e;
            border-radius: 3px;
            overflow: hidden
        }

        #zoomFill {
            height: 100%;
            background: #00E5FF;
            transition: width .5s, background .3s
        }

        #centerText {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 20;
            text-align: center
        }

        .announce {
            font-size: 64px;
            font-weight: 900;
            color: #fff;
            opacity: 0;
            animation: pop .9s ease-out forwards
        }

        .announce.chain {
            color: #FFD700;
            text-shadow: 0 0 60px rgba(255, 215, 0, .6)
        }

        .announce.zone {
            color: #AA00FF;
            text-shadow: 0 0 60px rgba(170, 0, 255, .6)
        }

        .announce.bonus {
            color: #4CAF50;
            text-shadow: 0 0 60px rgba(76, 175, 80, .6)
        }

        .announce.powerup {
            color: #00E5FF;
            font-size: 42px
        }

        .sub-text {
            font-size: 18px;
            color: #555;
            margin-top: 8px;
            opacity: 0;
            animation: fadeUp .5s .15s forwards
        }

        @keyframes pop {
            0% {
                opacity: 0;
                transform: scale(1.4)
            }
            12% {
                opacity: 1;
                transform: scale(1)
            }
            75% {
                opacity: 1
            }
            100% {
                opacity: 0;
                transform: scale(.98)
            }
        }

        @keyframes fadeUp {
            to {
                opacity: 1
            }
        }

        #achievements {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end
        }

        .achieve {
            background: linear-gradient(135deg, #1a1a2e, #12121a);
            border: 2px solid #FFD700;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 13px;
            color: #FFD700;
            font-weight: 600;
            opacity: 0;
            transform: translateX(30px);
            animation: achieveIn .5s forwards, achieveOut .5s 2.8s forwards
        }

        .achieve .icon {
            margin-right: 6px
        }

        @keyframes achieveIn {
            to {
                opacity: 1;
                transform: translateX(0)
            }
        }

        @keyframes achieveOut {
            to {
                opacity: 0;
                transform: translateX(30px)
            }
        }

        #menu, #gameOver, #pauseMenu {
            position: absolute;
            inset: 0;
            background: #080810;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100
        }

        #menu h1 {
            font-size: min(76px, 14vw);
            margin-bottom: 6px;
            color: #00E5FF;
            font-weight: 900;
            letter-spacing: -3px;
            text-shadow: 0 0 50px rgba(0, 229, 255, .4)
        }

        .subtitle {
            font-size: min(15px, 3.2vw);
            color: #AA00FF;
            margin-bottom: 32px;
            font-weight: 600;
            letter-spacing: 5px;
            text-transform: uppercase
        }

        #menu p {
            font-size: 14px;
            margin-bottom: 28px;
            color: #555;
            max-width: 460px;
            text-align: center;
            line-height: 1.9;
            padding: 0 20px
        }

        .hints {
            display: flex;
            gap: 28px;
            margin-bottom: 32px;
            flex-wrap: wrap;
            justify-content: center
        }

        .hint {
            text-align: center;
            width: 64px
        }

        .hint-icon {
            font-size: 26px;
            margin-bottom: 6px
        }

        .hint-text {
            font-size: 9px;
            color: #444;
            text-transform: uppercase;
            letter-spacing: 1px;
            line-height: 1.4
        }

        .btn {
            padding: 14px 52px;
            font-size: 18px;
            background: #00E5FF;
            color: #080810;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: all .15s;
            text-transform: uppercase;
            letter-spacing: 2px
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 40px rgba(0, 229, 255, .35)
        }

        .btn:active {
            transform: scale(.97)
        }

        .btn-s {
            padding: 12px 36px;
            font-size: 15px
        }

        .btn-ghost {
            background: transparent;
            color: #555;
            box-shadow: none;
            margin-top: 10px
        }

        .btn-ghost:hover {
            color: #888;
            background: rgba(255, 255, 255, .05);
            box-shadow: none
        }

        #controls {
            font-size: 11px;
            color: #333;
            margin-top: 28px;
            text-align: center;
            line-height: 2
        }

        #highScoreBox {
            font-size: 13px;
            color: #555;
            margin-bottom: 28px
        }

        #highScoreBox span {
            color: #FFD700;
            font-weight: 700;
            font-size: 16px
        }

        #gameOver h1 {
            font-size: min(52px, 11vw);
            color: #FF1744;
            margin-bottom: 6px;
            font-weight: 900
        }

        #finalScore {
            font-size: min(68px, 15vw);
            color: #FFD700;
            font-weight: 900;
            margin: 6px 0 4px;
            text-shadow: 0 0 40px rgba(255, 215, 0, .35)
        }

        #newHigh {
            font-size: 12px;
            color: #00E5FF;
            text-transform: uppercase;
            letter-spacing: 3px;
            height: 20px;
            margin-bottom: 12px
        }

        .stats-grid {
            display: grid;
            grid-template-columns:repeat(2, 1fr);
            gap: 8px;
            margin: 12px 0 20px;
            width: 100%;
            max-width: 300px;
            padding: 0 16px
        }

        .stat-item {
            background: #0c0c14;
            padding: 14px 10px;
            border-radius: 6px;
            border: 1px solid #1a1a2e
        }

        .stat-label {
            font-size: 9px;
            color: #444;
            text-transform: uppercase;
            letter-spacing: 1px
        }

        .stat-value {
            font-size: 22px;
            color: #00E5FF;
            font-weight: 700;
            margin-top: 2px
        }

        #pauseMenu h2 {
            font-size: 44px;
            margin-bottom: 28px;
            color: #00E5FF;
            font-weight: 800
        }

        .hidden {
            display: none !important
        }

        #screenFlash {
            position: absolute;
            inset: 0;
            pointer-events: none;
            opacity: 0;
            transition: opacity .07s;
            z-index: 15
        }

        #slowMo {
            position: absolute;
            inset: 0;
            pointer-events: none;
            border: 3px solid rgba(255, 215, 0, .15);
            opacity: 0;
            transition: opacity .3s;
            z-index: 4;
            box-shadow: inset 0 0 80px rgba(255, 215, 0, .08)
        }

        #slowMo.active {
            opacity: 1
        }

        @media (max-width: 600px) {
            #ui {
                top: 10px;
                left: 10px
            }

            #score {
                font-size: 38px
            }

            #stats {
                top: 10px;
                right: 10px;
                font-size: 11px
            }

            #stats span {
                font-size: 12px
            }

            .stat-value {
                font-size: 18px
            }

            .pu-slot {
                width: 38px;
                height: 38px;
                font-size: 16px
            }
        }
    </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="screenFlash"></div>
<div id="slowMo"></div>
<div id="ui">
    <div id="score">0</div>
    <div id="multiplier"></div>
    <div id="waveLine"><span id="wave">Wave 1</span>
        <div id="waveProgress">
            <div id="waveProgressBar"></div>
        </div>
    </div>
    <div id="lives"></div>
    <div id="chainBox">
        <div id="chainLabel">Chain</div>
        <div id="chainCount">√ó5</div>
    </div>
    <div id="powerupSlots"></div>
</div>
<div id="stats">
    <div>Best <span id="bestChain">0</span></div>
    <div>Cleared <span id="cleared">0</span></div>
    <div>Accuracy <span id="accuracy">100%</span></div>
</div>
<div id="bottomLeft">
    <div id="waveBonus">Wave: <span id="missCount">0</span> missed</div>
    <div id="circleCount"></div>
</div>
<div id="zoomMeter">
    <div id="zoomLabel">World</div>
    <div id="zoomBar">
        <div id="zoomFill"></div>
    </div>
</div>
<div id="centerText"></div>
<div id="achievements"></div>
<div id="menu">
    <h1>CHAIN REACTION</h1>
    <div class="subtitle">Explosive Arcade</div>
    <div class="hints">
        <div class="hint">
            <div class="hint-icon">üëÜ</div>
            <div class="hint-text">Click to explode</div>
        </div>
        <div class="hint">
            <div class="hint-icon">üí•</div>
            <div class="hint-text">Trigger chains</div>
        </div>
        <div class="hint">
            <div class="hint-icon">üåç</div>
            <div class="hint-text">World grows</div>
        </div>
        <div class="hint">
            <div class="hint-icon">‚ö°</div>
            <div class="hint-text">Use powers</div>
        </div>
    </div>
    <p>Click circles before they expire. Nearby circles explode in chain reactions! Collect power-ups, achieve perfect
        waves, and chase the high score as chaos intensifies.</p>
    <div id="highScoreBox">High Score: <span id="menuHighScore">0</span></div>
    <button class="btn" onclick="game.start()">Play</button>
    <div id="controls">Click or tap to play ¬∑ Keys 1-3 for power-ups ¬∑ ESC to pause</div>
</div>
<div id="pauseMenu" class="hidden">
    <h2>PAUSED</h2>
    <button class="btn btn-s" onclick="game.resume()">Resume</button>
    <button class="btn btn-s btn-ghost" onclick="game.quit()">Quit</button>
</div>
<div id="gameOver" class="hidden">
    <h1>GAME OVER</h1>
    <div id="newHigh"></div>
    <div id="finalScore">0</div>
    <div class="stats-grid">
        <div class="stat-item">
            <div class="stat-label">High Score</div>
            <div class="stat-value" id="statHigh">0</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Best Chain</div>
            <div class="stat-value" id="statChain">0</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Wave</div>
            <div class="stat-value" id="statWave">1</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Cleared</div>
            <div class="stat-value" id="statCleared">0</div>
        </div>
    </div>
    <button class="btn btn-s" onclick="game.start()">Play Again</button>
</div>
<script>
    const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
    const ZONES = [
        {name: 'CYAN', color: '#00E5FF', dim: '#006070', bg: '#080810', rgb: '0,229,255'},
        {name: 'VIOLET', color: '#AA00FF', dim: '#4a0080', bg: '#0a0812', rgb: '170,0,255'},
        {name: 'CRIMSON', color: '#FF1744', dim: '#801030', bg: '#100808', rgb: '255,23,68'},
        {name: 'GOLD', color: '#FFD700', dim: '#806800', bg: '#100e08', rgb: '255,215,0'}
    ];
    const POWERUPS = {
        freeze: {icon: '‚ùÑ', name: 'Freeze', desc: 'Stop all timers', dur: 4.5, cd: 22},
        boost: {icon: '‚ö°', name: 'Chain+', desc: '2√ó chain radius', dur: 7, cd: 28},
        bomb: {icon: 'üí£', name: 'Bomb', desc: 'Clear the center', dur: 0, cd: 18}
    };
    const ACHIEVEMENTS = {
        chain10: {t: '10√ó Chain!', n: 10, s: 'chain'},
        chain25: {t: '25√ó Chain!', n: 25, s: 'chain'},
        chain50: {t: '50√ó MEGA!', n: 50, s: 'chain'},
        chain100: {t: '100√ó LEGENDARY!', n: 100, s: 'chain'},
        clear100: {t: '100 Cleared', n: 100, s: 'cleared'},
        clear500: {t: '500 Cleared', n: 500, s: 'cleared'},
        wave5: {t: 'Wave 5', n: 5, s: 'wave'},
        wave10: {t: 'Wave 10', n: 10, s: 'wave'},
        wave20: {t: 'Wave 20', n: 20, s: 'wave'}
    };

    function resize() {
        const r = Math.min(window.innerWidth / 1200, window.innerHeight / 800, 1);
        canvas.style.width = (1200 * r) + 'px';
        canvas.style.height = (800 * r) + 'px';
        canvas.width = 1200;
        canvas.height = 800
    }

    resize();
    window.addEventListener('resize', resize);

    const game = {
        state: 'menu', score: 0, highScore: +localStorage.getItem('chainHighV4') || 0,
        lives: 3, wave: 1, zone: 0,
        circles: [], particles: [], explosions: [], texts: [], shockwaves: [],
        time: 0, waveTime: 0, dt: 0,
        chain: 0, bestChain: 0, cleared: 0, clicks: 0, hits: 0, misses: 0,
        shake: 0, slowMo: 0,
        scale: 1, targetScale: 1, worldW: 1200, worldH: 800,
        spawnT: 0,
        pups: {freeze: {rdy: 1, cd: 0, on: 0}, boost: {rdy: 1, cd: 0, on: 0}, bomb: {rdy: 1, cd: 0, on: 0}},
        achieved: [],
        audio: null,

        init() {
            try {
                this.audio = new (window.AudioContext || window.webkitAudioContext)()
            } catch (e) {
            }
            canvas.addEventListener('click', e => this.onClick(e));
            canvas.addEventListener('touchstart', e => {
                e.preventDefault();
                this.onClick(e.touches[0])
            }, {passive: false});
            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') {
                    if (this.state === 'play') this.pause(); else if (this.state === 'pause') this.resume()
                }
                if (this.state === 'play') {
                    if (e.key === '1') this.usePup('freeze');
                    if (e.key === '2') this.usePup('boost');
                    if (e.key === '3') this.usePup('bomb')
                }
            });
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && this.state === 'play') this.pause()
            });
            document.getElementById('menuHighScore').textContent = this.highScore.toLocaleString();
            this.updateLives();
            this.updatePups();
            this.loop(0)
        },

        start() {
            this.state = 'play';
            this.score = 0;
            this.lives = 3;
            this.wave = 1;
            this.zone = 0;
            this.circles = [];
            this.particles = [];
            this.explosions = [];
            this.texts = [];
            this.shockwaves = [];
            this.time = 0;
            this.waveTime = 0;
            this.chain = 0;
            this.bestChain = 0;
            this.cleared = 0;
            this.clicks = 0;
            this.hits = 0;
            this.misses = 0;
            this.shake = 0;
            this.slowMo = 0;
            this.scale = 1;
            this.targetScale = 1;
            this.worldW = 1200;
            this.worldH = 800;
            this.spawnT = 0;
            this.pups = {freeze: {rdy: 1, cd: 0, on: 0}, boost: {rdy: 1, cd: 0, on: 0}, bomb: {rdy: 1, cd: 0, on: 0}};
            this.achieved = [];
            this.hide('menu');
            this.hide('gameOver');
            this.hide('pauseMenu');
            this.updateUI();
            this.updatePups();
            this.announce(`${ZONES[0].name} ZONE`, 'Wave 1', 'zone')
        },

        pause() {
            this.state = 'pause';
            this.show('pauseMenu')
        },
        resume() {
            this.state = 'play';
            this.hide('pauseMenu')
        },
        quit() {
            this.state = 'menu';
            this.hide('pauseMenu');
            this.show('menu')
        },
        show(id) {
            document.getElementById(id).classList.remove('hidden')
        },
        hide(id) {
            document.getElementById(id).classList.add('hidden')
        },

        targetScaleForWave() {
            return this.wave < 3 ? 1 : this.wave < 5 ? .8 : this.wave < 7 ? .65 : this.wave < 10 ? .52 : .42
        },
        zoneForWave() {
            return Math.min(Math.floor((this.wave - 1) / 3), 3)
        },
        maxCircles() {
            return Math.floor(28 + this.wave * 6 + (1 / this.scale - 1) * 40)
        },
        spawnInterval() {
            return Math.max(50, 130 - this.wave * 7)
        },
        circleLife() {
            return Math.max(3.2, 6.2 - this.wave * .12)
        },
        chainRadius() {
            return (this.pups.boost.on > 0 ? 280 : 155) / this.scale
        },

        loop(t) {
            if (!this.lt) this.lt = t;
            let dt = (t - this.lt) / 1000;
            this.lt = t;
            if (this.slowMo > 0) {
                dt *= .3;
                this.slowMo -= dt / .3;
                document.getElementById('slowMo').classList.add('active')
            } else document.getElementById('slowMo').classList.remove('active');
            dt = Math.min(dt, .05);
            this.dt = dt;
            if (this.state === 'play') this.update(dt);
            this.render();
            requestAnimationFrame(t => this.loop(t))
        },

        update(dt) {
            this.time += dt;
            this.waveTime += dt;
            const waveLen = 26;
            if (this.waveTime >= waveLen) {
                if (this.misses === 0) {
                    const b = 500 * this.wave;
                    this.score += b;
                    this.announce('PERFECT!', `+${b} bonus`, 'bonus');
                    this.snd(900, .12);
                    this.snd(1100, .1);
                    this.snd(1300, .08)
                }
                this.wave++;
                this.waveTime = 0;
                this.misses = 0;
                const nz = this.zoneForWave();
                if (nz !== this.zone) {
                    this.zone = nz;
                    this.announce(`${ZONES[nz].name} ZONE`, 'Wave ' + this.wave, 'zone')
                } else this.announce('WAVE ' + this.wave);
                this.targetScale = this.targetScaleForWave();
                this.checkAchieve('wave', this.wave)
            }
            document.getElementById('waveProgressBar').style.width = (this.waveTime / waveLen * 100) + '%';
            const wb = document.getElementById('waveBonus');
            wb.classList.toggle('perfect', this.misses === 0);
            document.getElementById('missCount').textContent = this.misses === 0 ? 'Perfect!' : this.misses;
            this.scale += (this.targetScale - this.scale) * 1.8 * dt;
            this.worldW = 1200 / this.scale;
            this.worldH = 800 / this.scale;
            document.getElementById('zoomFill').style.width = ((1 - this.scale) / .58 * 100) + '%';
// Spawning
            const maxC = this.maxCircles();
            const active = this.circles.filter(c => !c.dead);
            this.spawnT -= dt * 1000;
            if (active.length < maxC && this.spawnT <= 0) {
                const batch = active.length < maxC * .35 ? 5 : active.length < maxC * .6 ? 3 : active.length < maxC * .8 ? 2 : 1;
                for (let i = 0; i < batch && active.length + i < maxC; i++) this.spawn(active);
                this.spawnT = this.spawnInterval()
            }
            document.getElementById('circleCount').textContent = active.length + ' circles';
// Powerups
            for (const k in this.pups) {
                const p = this.pups[k];
                if (p.on > 0) p.on -= dt;
                if (p.cd > 0) {
                    p.cd -= dt;
                    if (p.cd <= 0) p.rdy = 1
                }
            }
            this.updatePups();
// Shockwaves
            for (let i = this.shockwaves.length - 1; i >= 0; i--) {
                const sw = this.shockwaves[i];
                sw.r += dt * 600;
                sw.life -= dt * 2.2;
                if (sw.life <= 0) this.shockwaves.splice(i, 1)
            }
// Circles
            const frozen = this.pups.freeze.on > 0;
            for (let i = this.circles.length - 1; i >= 0; i--) {
                const c = this.circles[i];
                if (c.dead) {
                    c.dt += dt * 2.8;
                    if (c.dt > 1) this.circles.splice(i, 1);
                    continue
                }
// Shockwave interaction - visual pulse
                for (const sw of this.shockwaves) {
                    const d = Math.hypot(c.x - sw.x, c.y - sw.y);
                    if (d < sw.r && d > sw.r - 60 && !c.pulsed) {
                        c.pulse = 1;
                        c.pulsed = true
                    }
                }
                if (c.pulse > 0) c.pulse -= dt * 5;
                if (!frozen) c.t += dt;
                if (c.t >= c.life) {
                    this.miss(c);
                    c.dead = true;
                    c.dt = 0;
                    c.missed = true
                }
            }
// Explosions
            for (let i = this.explosions.length - 1; i >= 0; i--) {
                const e = this.explosions[i];
                e.t += dt * 2.8;
                if (e.t >= 1) this.explosions.splice(i, 1)
            }
// Particles
            for (let i = this.particles.length - 1; i >= 0; i--) {
                const p = this.particles[i];
                p.x += p.vx * dt;
                p.y += p.vy * dt;
                p.vy += 450 * dt;
                p.life -= dt * 2.2;
                if (p.life <= 0) this.particles.splice(i, 1)
            }
// Texts
            for (let i = this.texts.length - 1; i >= 0; i--) {
                const t = this.texts[i];
                t.y -= 55 * dt;
                t.life -= dt * 1.4;
                if (t.life <= 0) this.texts.splice(i, 1)
            }
            if (this.shake > 0) this.shake = Math.max(0, this.shake - dt * 12);
// Chain display
            const cb = document.getElementById('chainBox');
            if (this.chain > 2) {
                cb.classList.add('visible');
                document.getElementById('chainCount').textContent = '√ó' + this.chain
            } else cb.classList.remove('visible')
        },

        spawn(active) {
            const pad = 55, w = this.worldW, h = this.worldH, cr = this.chainRadius();
            let x, y, ok = false;
            if (active.length === 0) {
                x = w / 2 + (Math.random() - .5) * 300;
                y = h / 2 + (Math.random() - .5) * 200;
                ok = true
            } else {
                for (let a = 0; a < 35; a++) {
                    const anchor = active[Math.floor(Math.random() * active.length)];
                    const ang = Math.random() * Math.PI * 2;
                    const dist = 35 + Math.random() * (cr * .8 - 35);
                    x = anchor.x + Math.cos(ang) * dist;
                    y = anchor.y + Math.sin(ang) * dist;
                    x = Math.max(pad, Math.min(w - pad, x));
                    y = Math.max(pad, Math.min(h - pad, y));
                    if (!active.some(c => Math.hypot(c.x - x, c.y - y) < 48)) {
                        if (active.some(c => Math.hypot(c.x - x, c.y - y) < cr)) {
                            ok = true;
                            break
                        }
                    }
                }
            }
            if (!ok) return;
            let type = 'normal', radius = 26, life = this.circleLife();
            const r = Math.random();
            if (this.wave >= 3 && r < .1) {
                type = 'bonus';
                life *= 1.2;
                radius = 31
            } else if (this.wave >= 5 && r < .14) {
                type = 'fast';
                life *= .5
            } else if (this.wave >= 7 && r < .1) {
                type = 'mini';
                radius = 17
            }
            this.circles.push({
                x,
                y,
                radius,
                life,
                maxLife: life,
                t: 0,
                type,
                dead: false,
                dt: 0,
                missed: false,
                pulse: 0,
                pulsed: false
            })
        },

        onClick(e) {
            if (this.state !== 'play') return;
            this.clicks++;
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left) / rect.width * 1200 / this.scale;
            const my = (e.clientY - rect.top) / rect.height * 800 / this.scale;
// Create shockwave on every click
            this.shockwaves.push({x: mx, y: my, r: 0, life: 1, color: ZONES[this.zone].color});
            this.circles.forEach(c => {
                if (!c.dead) c.pulsed = false
            }); // Reset pulse state
// Small click sound
            this.snd(200, .03);
// Check hits
            for (let i = this.circles.length - 1; i >= 0; i--) {
                const c = this.circles[i];
                if (c.dead) continue;
                if (Math.hypot(c.x - mx, c.y - my) < c.radius + 8) {
                    this.hits++;
                    this.chain = 0;
                    this.explode(c, 0);
                    setTimeout(() => {
                        if (this.chain >= 10) this.slowMo = .7;
                        if (this.chain >= 5) this.announce(this.chain + '√ó CHAIN!', '', 'chain');
                        this.checkAchieve('chain', this.chain)
                    }, 120);
                    this.updateUI();
                    return
                }
            }
        },

        explode(c, depth) {
            if (c.dead) return;
            c.dead = true;
            c.dt = 0;
            c.missed = false;
            this.chain++;
            this.cleared++;
            if (this.chain > this.bestChain) this.bestChain = this.chain;
            this.checkAchieve('cleared', this.cleared);
            const chainMult = Math.pow(1.35, Math.min(depth, 22));
            const typeMult = c.type === 'bonus' ? 3 : 1;
            const clutch = (c.life - c.t) / c.life < .12 ? 1.6 : 1;
            const waveMult = 1 + this.wave * .04;
            const pts = Math.round(10 * chainMult * typeMult * clutch * waveMult);
            this.score += pts;
            if (this.score > this.highScore) {
                this.highScore = this.score;
                localStorage.setItem('chainHighV4', this.highScore)
            }
// Popup score
            const scoreEl = document.getElementById('score');
            scoreEl.classList.add('pop');
            setTimeout(() => scoreEl.classList.remove('pop'), 100);
// Explosion visual
            const col = c.type === 'bonus' ? '#FFD700' : ZONES[this.zone].color;
            this.explosions.push({x: c.x, y: c.y, r: this.chainRadius(), t: 0, color: col});
            if (depth > 0 || clutch > 1) {
                let txt = '+' + pts;
                if (clutch > 1 && depth === 0) txt = 'CLUTCH! +' + pts;
                this.texts.push({x: c.x, y: c.y - 28, text: txt, size: 15 + Math.min(depth * 1.8, 22), life: 1})
            }
// Particles
            const pCount = 12 + Math.min(depth * 3, 20);
            for (let i = 0; i < pCount; i++) {
                const ang = Math.PI * 2 * i / pCount + Math.random() * .3, spd = 120 + Math.random() * 220;
                this.particles.push({
                    x: c.x,
                    y: c.y,
                    vx: Math.cos(ang) * spd,
                    vy: Math.sin(ang) * spd - 70,
                    life: .7 + Math.random() * .4,
                    color: col,
                    size: 2 + Math.random() * 3
                })
            }
// Sound
            this.snd(250 + depth * 50, .045 + Math.min(depth * .01, .12));
// Effects
            if (depth > 4) this.shake = Math.min(depth * .5, 5);
            if (depth > 7) this.flash(col, .06 + depth * .012);
// Chain
            const cr = this.chainRadius();
            setTimeout(() => {
                this.circles.forEach(o => {
                    if (!o.dead && Math.hypot(o.x - c.x, o.y - c.y) < cr) this.explode(o, depth + 1)
                })
            }, 30)
        },

        miss(c) {
            this.misses++;
            this.loseLife()
        },

        usePup(k) {
            const p = this.pups[k], cfg = POWERUPS[k];
            if (!p.rdy || p.on > 0) return;
            p.rdy = 0;
            p.cd = cfg.cd;
            if (k === 'bomb') {
                const cx = this.worldW / 2, cy = this.worldH / 2, br = 350 / this.scale;
                let n = 0;
                this.circles.forEach(c => {
                    if (!c.dead && Math.hypot(c.x - cx, c.y - cy) < br) {
                        this.explode(c, 0);
                        n++
                    }
                });
                this.shockwaves.push({x: cx, y: cy, r: 0, life: 1.2, color: '#FF1744'});
                this.flash('#FF1744', .3);
                this.shake = 5;
                this.announce('BOMB!', n + ' cleared', 'powerup');
                this.snd(120, .2);
                this.snd(80, .15)
            } else {
                p.on = cfg.dur;
                this.announce(cfg.name.toUpperCase() + '!', cfg.desc, 'powerup');
                if (k === 'freeze') {
                    this.flash('#00E5FF', .12);
                    this.snd(600, .08)
                }
                if (k === 'boost') {
                    this.flash('#FFD700', .12);
                    this.snd(500, .08);
                    this.snd(750, .06)
                }
            }
            this.updatePups()
        },

        updatePups() {
            const c = document.getElementById('powerupSlots');
            c.innerHTML = '';
            let i = 1;
            for (const k in POWERUPS) {
                const p = this.pups[k], cfg = POWERUPS[k];
                const d = document.createElement('div');
                d.className = 'pu-slot' + (p.rdy && !p.on ? ' ready' : '') + (p.on > 0 ? ' active' : '');
                d.innerHTML = cfg.icon + `<span class="key">${i}</span>`;
                if (!p.rdy && p.cd > 0) d.innerHTML += `<div class="cd" style="height:${p.cd / cfg.cd * 100}%"></div>`;
                if (p.rdy && !p.on) d.onclick = () => this.usePup(k);
                c.appendChild(d);
                i++
            }
        },

        checkAchieve(stat, val) {
            for (const k in ACHIEVEMENTS) {
                const a = ACHIEVEMENTS[k];
                if (a.s === stat && val >= a.n && !this.achieved.includes(k)) {
                    this.achieved.push(k);
                    this.showAchieve(a.t)
                }
            }
        },

        showAchieve(txt) {
            const c = document.getElementById('achievements');
            const d = document.createElement('div');
            d.className = 'achieve';
            d.innerHTML = '<span class="icon">üèÜ</span>' + txt;
            c.appendChild(d);
            setTimeout(() => d.remove(), 3500);
            this.snd(880, .08);
            this.snd(1100, .06)
        },

        announce(main, sub = '', type = '') {
            const el = document.getElementById('centerText');
            el.innerHTML = `<div class="announce ${type}">${main}</div>${sub ? `<div class="sub-text">${sub}</div>` : ''}`;
            setTimeout(() => el.innerHTML = '', 1100)
        },

        flash(col, a) {
            const el = document.getElementById('screenFlash');
            el.style.background = col;
            el.style.opacity = Math.min(a, .45);
            setTimeout(() => el.style.opacity = 0, 70)
        },

        loseLife() {
            this.lives--;
            this.updateLives();
            this.snd(80, .18);
            this.shake = 3.5;
            this.flash('#FF1744', .4);
            if (this.lives <= 0) this.gameOver()
        },

        updateLives() {
            document.getElementById('lives').innerHTML = [0, 1, 2].map(i => `<div class="life${i >= this.lives ? ' lost' : ''}"></div>`).join('')
        },

        updateUI() {
            const z = ZONES[this.zone];
            document.getElementById('score').textContent = this.score.toLocaleString();
            document.getElementById('score').style.color = z.color;
            document.getElementById('score').style.textShadow = `0 0 30px rgba(${z.rgb},.4)`;
            document.getElementById('waveProgressBar').style.background = z.color;
            document.getElementById('zoomFill').style.background = z.color;
            document.getElementById('wave').textContent = 'Wave ' + this.wave;
            document.getElementById('multiplier').innerHTML = this.wave > 1 ? `Zone √ó<span>${(1 + this.wave * .04).toFixed(2)}</span>` : '';
            document.getElementById('bestChain').textContent = this.bestChain;
            document.getElementById('cleared').textContent = this.cleared;
            document.getElementById('accuracy').textContent = this.clicks ? Math.round(this.hits / this.clicks * 100) + '%' : '‚Äî'
        },

        render() {
            ctx.save();
            if (this.shake > 0) ctx.translate((Math.random() - .5) * this.shake * 5, (Math.random() - .5) * this.shake * 5);
            const z = ZONES[this.zone], s = this.scale;
            ctx.fillStyle = z.bg;
            ctx.fillRect(0, 0, 1200, 800);
// Grid
            ctx.strokeStyle = 'rgba(255,255,255,.025)';
            ctx.lineWidth = 1;
            const g = 100 * s;
            for (let x = g; x < 1200; x += g) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, 800);
                ctx.stroke()
            }
            for (let y = g; y < 800; y += g) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(1200, y);
                ctx.stroke()
            }
// Connection hints
            ctx.strokeStyle = 'rgba(255,255,255,.025)';
            const cr = this.chainRadius(), actives = this.circles.filter(c => !c.dead);
            for (let i = 0; i < actives.length; i++) {
                for (let j = i + 1; j < actives.length; j++) {
                    const a = actives[i], b = actives[j];
                    if (Math.hypot(a.x - b.x, a.y - b.y) < cr) {
                        ctx.beginPath();
                        ctx.moveTo(a.x * s, a.y * s);
                        ctx.lineTo(b.x * s, b.y * s);
                        ctx.stroke()
                    }
                }
            }
// Click shockwaves
            for (const sw of this.shockwaves) {
                const alpha = sw.life * .4;
                ctx.beginPath();
                ctx.arc(sw.x * s, sw.y * s, sw.r * s, 0, Math.PI * 2);
                ctx.strokeStyle = sw.color;
                ctx.globalAlpha = alpha;
                ctx.lineWidth = 3 * (sw.life) + 1;
                ctx.stroke();
                ctx.globalAlpha = 1
            }
// Chain explosions
            for (const e of this.explosions) {
                const r = e.r * s * (.25 + e.t * .75);
                const alpha = (1 - e.t) * .55;
                ctx.beginPath();
                ctx.arc(e.x * s, e.y * s, r, 0, Math.PI * 2);
                ctx.strokeStyle = e.color;
                ctx.globalAlpha = alpha;
                ctx.lineWidth = 4 * (1 - e.t) + 2;
                ctx.stroke();
                ctx.globalAlpha = alpha * .15;
                ctx.fillStyle = e.color;
                ctx.fill();
                ctx.globalAlpha = 1
            }
// Circles
            for (const c of this.circles) {
                const sx = c.x * s, sy = c.y * s;
                let sr = c.radius * s;
                if (c.dead) {
                    const t = Math.min(c.dt, 1);
                    ctx.globalAlpha = 1 - t;
                    ctx.beginPath();
                    ctx.arc(sx, sy, sr * (1 + t * .5), 0, Math.PI * 2);
                    ctx.fillStyle = c.missed ? '#FF1744' : '#fff';
                    ctx.fill();
                    ctx.globalAlpha = 1;
                    continue
                }
                const ratio = 1 - c.t / c.life;
                const urgent = ratio < .18;
// Shockwave pulse effect
                const pulseBoost = c.pulse > 0 ? c.pulse * .15 : 0;
                const pulse = urgent ? 1 + Math.sin(this.time * 18) * .1 + pulseBoost : 1 + pulseBoost;
                sr *= pulse;
// Urgent glow
                if (urgent) {
                    ctx.beginPath();
                    ctx.arc(sx, sy, sr * 1.7, 0, Math.PI * 2);
                    const grad = ctx.createRadialGradient(sx, sy, sr * .6, sx, sy, sr * 1.7);
                    grad.addColorStop(0, 'rgba(255,23,68,.35)');
                    grad.addColorStop(1, 'rgba(255,23,68,0)');
                    ctx.fillStyle = grad;
                    ctx.fill()
                }
// Main
                ctx.beginPath();
                ctx.arc(sx, sy, sr, 0, Math.PI * 2);
                let fill = z.color;
                if (c.type === 'bonus') fill = '#FFD700';
                else if (c.type === 'fast') fill = '#FF1744';
                else if (ratio < .18) fill = '#FF1744';
                else if (ratio < .38) fill = '#FF9100';
                ctx.fillStyle = fill;
                ctx.fill();
                ctx.strokeStyle = 'rgba(255,255,255,.18)';
                ctx.lineWidth = 2 * s;
                ctx.stroke();
// Progress arc
                ctx.beginPath();
                ctx.arc(sx, sy, sr + 4 * s, -Math.PI / 2, -Math.PI / 2 + Math.PI * 2 * ratio);
                ctx.strokeStyle = urgent ? '#FF1744' : fill;
                ctx.lineWidth = 2.5 * s;
                ctx.lineCap = 'round';
                ctx.stroke();
                ctx.lineCap = 'butt';
// Timer
                if (c.radius > 18) {
                    ctx.fillStyle = c.type === 'bonus' ? '#000' : 'rgba(255,255,255,.9)';
                    ctx.font = `bold ${Math.floor(13 * s)}px system-ui`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(Math.ceil(c.life - c.t), sx, sy)
                }
            }
// Particles
            for (const p of this.particles) {
                ctx.beginPath();
                ctx.arc(p.x * s, p.y * s, p.size * s, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.globalAlpha = Math.min(p.life, 1);
                ctx.fill()
            }
            ctx.globalAlpha = 1;
// Texts
            for (const t of this.texts) {
                ctx.font = `bold ${Math.floor(t.size * s)}px system-ui`;
                ctx.textAlign = 'center';
                ctx.fillStyle = '#fff';
                ctx.globalAlpha = Math.min(t.life, 1);
                ctx.fillText(t.text, t.x * s, t.y * s)
            }
            ctx.globalAlpha = 1;
            ctx.restore()
        },

        gameOver() {
            this.state = 'over';
            const isNew = this.score > 0 && this.score >= this.highScore;
            document.getElementById('finalScore').textContent = this.score.toLocaleString();
            document.getElementById('newHigh').textContent = isNew ? '‚òÖ NEW HIGH SCORE ‚òÖ' : '';
            document.getElementById('statHigh').textContent = this.highScore.toLocaleString();
            document.getElementById('statChain').textContent = this.bestChain;
            document.getElementById('statWave').textContent = this.wave;
            document.getElementById('statCleared').textContent = this.cleared;
            document.getElementById('menuHighScore').textContent = this.highScore.toLocaleString();
            this.show('gameOver')
        },

        snd(freq, vol) {
            if (!this.audio || this.audio.state === 'suspended') return;
            try {
                const o = this.audio.createOscillator(), g = this.audio.createGain();
                o.connect(g);
                g.connect(this.audio.destination);
                o.frequency.value = freq;
                o.type = 'sine';
                g.gain.setValueAtTime(vol, this.audio.currentTime);
                g.gain.exponentialRampToValueAtTime(.001, this.audio.currentTime + .1);
                o.start();
                o.stop(this.audio.currentTime + .1)
            } catch (e) {
            }
        }
    };
    game.init();
</script>
<script src="../logo.js"></script>
</body>
</html>