<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Death by AI - Single Player</title>
    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíÄ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center">
<div id="appContainer" class="container mx-auto p-4 max-w-2xl"></div>
<script>
    const appContainer = document.getElementById('appContainer');

    // Game State
    let currentRound = 0;
    let playerScore = 0;
    let streak = 0;
    let difficulty = 'medium';
    let playerName = '';
    let playerAvatar = 'üòÄ';
    let timerInterval = null;
    let speedrunInterval = null;
    let timeLeft = 60;
    let xp = 0;
    let scenarioType = 'AI generated';
    let isSpeedrun = false;
    let roundStartTime = 0;
    let totalSpeedrunTime = 0;

    // Configuration
    const CONFIG = {
        API_ENDPOINT: 'https://chatgpt.tobiasmue91.workers.dev/',
        API_TIMEOUT: 15000,
        NORMAL_TIME: 60,
        SPEEDRUN_TIME: 30,
        MAX_RETRIES: 2
    };

    // Data
    const backgrounds = [
        'bg-gray-900',
        'bg-blue-900',
        'bg-green-900',
        'bg-red-900',
        'bg-purple-900'
    ];

    const randomUsernames = [
        'SurvivalGuru', 'LuckyEscaper', 'DeathDefier', 'ChanceChaser',
        'FateChallenger', 'RiskTaker', 'DangerDodger', 'ThrillerThriver',
        'AdventureAce', 'PerilPro'
    ];

    const scenarioTopics = [
        'Natural Disaster', 'Wildlife Encounter', 'Urban Emergency', 'Historical Event',
        'Sci-Fi Situation', 'Supernatural Occurrence', 'Medical Crisis', 'Extreme Sport Accident',
        'Espionage Mission', 'Post-Apocalyptic Scenario', 'Ancient Civilization Discovery',
        'Virtual Reality Glitch', 'Time Travel Mishap', 'Underwater Exploration',
        'Space Exploration Crisis', 'Parallel Universe Incident', 'Mythological Creature Encounter',
        'Psychological Thriller', 'Haunted Location', 'Survival Game Show'
    ];

    const avatars = [
        'üòÄ', 'üòé', 'ü§†', 'üßê', 'ü•∏', 'ü§ì', 'üëª', 'üíÄ', 'üëΩ', 'ü§ñ',
        'ü¶∏', 'üßô', 'üßõ', 'üßü', 'ü•∑', 'ü¶π', 'üßë‚ÄçüöÄ', 'üßù', 'üßû', 'üßú'
    ];

    // Fallback scenarios for when API fails
    const fallbackScenarios = {
        easy: [
            "You're stuck in an elevator during a power outage.",
            "A small fire breaks out in your kitchen while cooking.",
            "You accidentally lock yourself out of your house in your pajamas.",
            "Your car breaks down on a quiet suburban street.",
            "You slip on ice and sprain your ankle in a populated area."
        ],
        medium: [
            "A tornado warning is issued and you're caught outside without shelter.",
            "You encounter a bear while hiking in a national park.",
            "Your boat engine fails 2 miles from shore in choppy waters.",
            "You're trapped in a subway tunnel during a blackout.",
            "A gas leak is detected in your apartment building."
        ],
        hard: [
            "Your plane makes an emergency landing in a remote jungle.",
            "You're caught in a building fire on the 15th floor.",
            "A poisonous snake bites you during a solo camping trip.",
            "Your parachute fails during a skydiving jump.",
            "You're trapped in a collapsing cave system."
        ],
        'certain death': [
            "You're floating in space after your tether to the spaceship breaks.",
            "A tsunami wave towers over you on a deserted beach.",
            "You're trapped in a sinking submarine with limited oxygen.",
            "A volcano erupts while you're hiking near the crater.",
            "You fall into a pool of quicksand in a remote jungle."
        ]
    };

    // Utility Functions
    function clearAllIntervals() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        if (speedrunInterval) {
            clearInterval(speedrunInterval);
            speedrunInterval = null;
        }
    }

    function getRandomElement(array) {
        return array[Math.floor(Math.random() * array.length)];
    }

    function getCurrentDifficulty() {
        if (difficulty === 'random') {
            return getRandomElement(['easy', 'medium', 'hard', 'certain death']);
        }
        return difficulty;
    }

    // API Functions with improved error handling
    async function makeAPICall(messages, retryCount = 0) {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), CONFIG.API_TIMEOUT);

        try {
            const response = await fetch(CONFIG.API_ENDPOINT, {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "*/*"
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    max_tokens: 150,
                    temperature: 0.7,
                    messages: messages
                }),
                signal: controller.signal
            });

            clearTimeout(timeout);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                throw new Error('Invalid API response structure');
            }

            return data.choices[0].message.content;
        } catch (error) {
            clearTimeout(timeout);
            console.error('API call error:', error);

            if (retryCount < CONFIG.MAX_RETRIES) {
                console.log(`Retrying... Attempt ${retryCount + 1}`);
                await new Promise(resolve => setTimeout(resolve, 1000));
                return makeAPICall(messages, retryCount + 1);
            }

            throw error;
        }
    }

    async function generateScenario() {
        showLoadingState("Generating scenario...");

        try {
            const randomTopic = getRandomElement(scenarioTopics);
            const currentDifficulty = getCurrentDifficulty();

            const messages = [
                {
                    role: "system",
                    content: `You are a creative scenario generator for a survival game. Generate a brief, challenging scenario based on the difficulty: ${currentDifficulty} and the topic: ${randomTopic}. The scenario should be a single sentence describing a dangerous situation. Keep it under 40 words.`
                },
                {
                    role: "user",
                    content: `Generate a ${currentDifficulty} scenario related to ${randomTopic}.`
                }
            ];

            const scenario = await makeAPICall(messages);
            return scenario.trim();
        } catch (error) {
            console.error('Error generating scenario:', error);
            // Use fallback scenario
            const currentDifficulty = getCurrentDifficulty();
            return getRandomElement(fallbackScenarios[currentDifficulty]);
        } finally {
            hideLoadingState();
        }
    }

    async function evaluatePrompt(scenario, prompt) {
        const currentDifficulty = getCurrentDifficulty();

        try {
            const messages = [
                {
                    role: "system",
                    content: `You are the AI judge in a game called 'Death by AI'. Your task is to determine if a player survives a given scenario based on their prompt. The current difficulty is ${currentDifficulty}. Respond ONLY with a valid JSON object containing 'survived' (boolean) and 'explanation' (string, max 150 characters). For 'easy' difficulty, be more lenient. For 'hard' difficulty, be more strict. For 'certain death', almost always result in death unless the solution is exceptionally clever. Example: {"survived": true, "explanation": "Your quick thinking saved you!"}`
                },
                {
                    role: "user",
                    content: `Scenario: ${scenario}\nPlayer's action: ${prompt}`
                }
            ];

            const response = await makeAPICall(messages);

            // Try to parse JSON, with fallback
            let fate;
            try {
                // Remove markdown code blocks if present
                const cleanResponse = response.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                fate = JSON.parse(cleanResponse);

                // Validate structure
                if (typeof fate.survived !== 'boolean' || typeof fate.explanation !== 'string') {
                    throw new Error('Invalid JSON structure');
                }
            } catch (parseError) {
                console.error('JSON parse error:', parseError);
                // Fallback evaluation based on difficulty and prompt length
                const promptQuality = prompt.length > 20 && prompt.length < 500;
                const survivalChance = {
                    'easy': 0.7,
                    'medium': 0.5,
                    'hard': 0.3,
                    'certain death': 0.1
                }[currentDifficulty];

                const survived = promptQuality && Math.random() < survivalChance;
                fate = {
                    survived: survived,
                    explanation: survived ?
                        "Your creative solution managed to work!" :
                        "Unfortunately, your plan wasn't enough to survive."
                };
            }

            return fate;
        } catch (error) {
            console.error('Error evaluating prompt:', error);
            // Final fallback - basic evaluation
            const promptLength = prompt.length;
            const hasDetail = promptLength > 30;
            const survivalChance = {
                'easy': 0.7,
                'medium': 0.5,
                'hard': 0.3,
                'certain death': 0.1
            }[currentDifficulty];

            const survived = hasDetail && Math.random() < survivalChance;
            return {
                survived: survived,
                explanation: survived ?
                    "Against the odds, you managed to survive!" :
                    "Your plan couldn't save you from this fate."
            };
        }
    }

    // Game Functions
    function startGame() {
        currentRound = 0;
        playerScore = 0;
        streak = 0;
        totalSpeedrunTime = 0;
        clearAllIntervals();
        renderCharacterCreation();
    }

    function renderCharacterCreation() {
        const unlockedAvatars = avatars.slice(0, Math.min(10 + Math.floor(xp / 100), avatars.length));

        appContainer.innerHTML = `
        <div class="text-center bg-gray-800 p-8 rounded-lg shadow-2xl fade-in">
            <h1 class="text-4xl mb-6 text-green-400 font-bold">üíÄ Death by AI</h1>
            <h2 class="text-2xl mb-6 text-gray-300">Create Your Character</h2>

            <div class="mb-6">
                <label class="block mb-2 font-semibold text-left">Player Name</label>
                <input
                    id="player-name"
                    class="bg-gray-700 text-white px-4 py-3 rounded focus:outline-none focus:ring-2 focus:ring-green-500 w-full"
                    placeholder="Enter your name (optional)"
                    value="${getRandomElement(randomUsernames)}"
                    maxlength="20"
                >
            </div>

            <div class="mb-6">
                <label class="block mb-2 font-semibold text-left">Choose Avatar</label>
                <div class="flex justify-center flex-wrap gap-2 bg-gray-700 p-4 rounded">
                    ${avatars.map((emoji, index) => `
                        <button
                            class="avatar-btn text-3xl p-3 rounded transition-all duration-200 ${emoji === playerAvatar ? 'bg-green-500 scale-110' : 'bg-gray-600 hover:bg-gray-500'}${index >= unlockedAvatars.length ? ' opacity-30 cursor-not-allowed' : ''}"
                            data-emoji="${emoji}"
                            ${index >= unlockedAvatars.length ? ' disabled title="Unlock at ' + (index * 100) + ' XP"' : ''}
                        >
                            ${index >= unlockedAvatars.length ? 'üîí' : emoji}
                        </button>
                    `).join('')}
                </div>
            </div>

            <div class="mb-6">
                <label class="block mb-2 font-semibold text-left">Scenario Type</label>
                <select
                    id="scenario-type"
                    class="bg-gray-700 text-white px-4 py-3 rounded focus:outline-none focus:ring-2 focus:ring-green-500 w-full cursor-pointer"
                >
                    <option value="AI generated">AI Generated</option>
                    <option value="Custom">Custom Scenario</option>
                </select>
            </div>

            <div class="mb-6">
                <label class="block mb-2 font-semibold text-left">Game Mode</label>
                <select
                    id="game-mode"
                    class="bg-gray-700 text-white px-4 py-3 rounded focus:outline-none focus:ring-2 focus:ring-green-500 w-full cursor-pointer"
                >
                    <option value="normal">Normal Mode (60s per round)</option>
                    <option value="speedrun">Speedrun Mode (30s per round)</option>
                </select>
            </div>

            <button
                id="start-game"
                class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded transition duration-300 ease-in-out transform hover:scale-105 w-full mb-3"
            >
                Start Game
            </button>

            <button
                id="how-to-play"
                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded transition duration-300 ease-in-out transform hover:scale-105 w-full"
            >
                How to Play
            </button>

            <div class="mt-6 flex justify-between items-center bg-gray-700 p-4 rounded">
                <div>
                    <p class="text-sm text-gray-400">Total XP</p>
                    <p class="text-2xl font-bold text-green-400">${xp}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">High Score</p>
                    <p class="text-2xl font-bold text-yellow-400">${localStorage.getItem('deathByAIHighScore') || '0'}/5</p>
                </div>
            </div>
        </div>
    `;

        // Event Listeners
        document.querySelectorAll('.avatar-btn:not([disabled])').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.avatar-btn').forEach(b => {
                    b.classList.remove('bg-green-500', 'scale-110');
                    b.classList.add('bg-gray-600');
                });
                e.target.classList.remove('bg-gray-600');
                e.target.classList.add('bg-green-500', 'scale-110');
                playerAvatar = e.target.dataset.emoji;
            });
        });

        document.getElementById('start-game').addEventListener('click', () => {
            playerName = document.getElementById('player-name').value.trim() || 'Player';
            scenarioType = document.getElementById('scenario-type').value;
            isSpeedrun = document.getElementById('game-mode').value === 'speedrun';
            renderDifficultySelection();
        });

        document.getElementById('how-to-play').addEventListener('click', showTutorial);
    }

    function renderDifficultySelection() {
        const difficulties = [
            {value: 'easy', color: 'green', description: 'Generous survival chances'},
            {value: 'medium', color: 'yellow', description: 'Balanced challenge'},
            {value: 'hard', color: 'orange', description: 'Tough survival odds'},
            {value: 'certain death', color: 'red', description: 'Nearly impossible'},
            {value: 'random', color: 'purple', description: 'Surprise difficulty!'}
        ];

        appContainer.innerHTML = `
        <div class="text-center bg-gray-800 p-8 rounded-lg shadow-2xl fade-in">
            <h2 class="text-3xl mb-6 text-green-400 font-bold">Select Difficulty</h2>
            <p class="text-gray-300 mb-6">Choose wisely - your survival depends on it!</p>

            <div class="space-y-3">
                ${difficulties.map(diff => `
                    <button
                        class="difficulty-btn bg-${diff.color}-500 hover:bg-${diff.color}-600 text-white font-bold py-4 px-6 rounded transition duration-300 ease-in-out transform hover:scale-105 w-full text-left flex justify-between items-center"
                        data-difficulty="${diff.value}"
                    >
                        <div>
                            <div class="text-xl">${diff.value.charAt(0).toUpperCase() + diff.value.slice(1)}</div>
                            <div class="text-sm opacity-75">${diff.description}</div>
                        </div>
                        <span class="text-2xl">‚Üí</span>
                    </button>
                `).join('')}
            </div>

            <button
                id="back-btn"
                class="mt-6 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded transition duration-300 w-full"
            >
                ‚Üê Back
            </button>
        </div>
    `;

        document.querySelectorAll('.difficulty-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                difficulty = e.currentTarget.dataset.difficulty;
                nextRound();
            });
        });

        document.getElementById('back-btn').addEventListener('click', startGame);
    }

    async function nextRound() {
        if (currentRound < 5) {
            currentRound++;
            clearAllIntervals();

            let scenario;
            if (scenarioType === 'Custom') {
                scenario = await promptForCustomScenario();
            } else {
                scenario = await generateScenario();
            }

            renderPromptInput(scenario);
        } else {
            renderScoreboard();
        }
    }

    async function promptForCustomScenario() {
        return new Promise((resolve) => {
            appContainer.innerHTML = `
            <div class="text-center bg-gray-800 p-8 rounded-lg shadow-2xl fade-in">
                <h2 class="text-3xl mb-6 text-green-400 font-bold">Custom Scenario</h2>
                <p class="text-gray-300 mb-4">Create your own dangerous situation!</p>

                <textarea
                    id="custom-scenario"
                    class="bg-gray-700 text-white px-4 py-3 rounded focus:outline-none focus:ring-2 focus:ring-green-500 w-full h-40 mb-4 resize-none"
                    placeholder="Enter your custom scenario... Make it dangerous!"
                    maxlength="200"
                ></textarea>

                <div class="text-right text-sm text-gray-400 mb-4">
                    <span id="char-count">0</span>/200 characters
                </div>

                <button
                    id="submit-scenario"
                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded transition duration-300 ease-in-out transform hover:scale-105 w-full"
                >
                    Use This Scenario
                </button>
            </div>
        `;

            const textarea = document.getElementById('custom-scenario');
            const charCount = document.getElementById('char-count');

            textarea.addEventListener('input', () => {
                charCount.textContent = textarea.value.length;
            });

            document.getElementById('submit-scenario').addEventListener('click', () => {
                const scenario = textarea.value.trim();
                resolve(scenario || "You find yourself in a mysterious and dangerous situation.");
            });
        });
    }

    function renderPromptInput(scenario) {
        timeLeft = isSpeedrun ? CONFIG.SPEEDRUN_TIME : CONFIG.NORMAL_TIME;
        roundStartTime = Date.now();

        appContainer.innerHTML = `
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl text-green-400 font-bold">Round ${currentRound}/5</h2>
                <div class="text-right">
                    <div class="text-sm text-gray-400">Difficulty</div>
                    <div class="text-lg font-bold">${difficulty === 'random' ? 'Random' : difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}</div>
                </div>
            </div>

            <div class="bg-gray-700 p-6 rounded-lg mb-6">
                <p class="text-lg leading-relaxed">${scenario}</p>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-700 p-4 rounded text-center">
                    <div class="text-sm text-gray-400">Score</div>
                    <div class="text-2xl font-bold text-green-400">${playerScore}/5</div>
                </div>
                <div class="bg-gray-700 p-4 rounded text-center">
                    <div class="text-sm text-gray-400">Streak</div>
                    <div class="text-2xl font-bold text-yellow-400">${streak} üî•</div>
                </div>
            </div>

            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-semibold">Time Remaining</span>
                    <span id="timer" class="text-2xl font-bold ${timeLeft <= 10 ? 'text-red-500 animate-pulse' : 'text-green-400'}">${timeLeft}s</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="timer-bar" class="bg-green-500 h-2 rounded-full transition-all duration-1000" style="width: 100%"></div>
                </div>
            </div>

            ${isSpeedrun ? `
                <div class="bg-purple-900 bg-opacity-50 p-4 rounded mb-6 text-center">
                    <div class="text-sm text-purple-300">Total Speedrun Time</div>
                    <div id="speedrun-timer" class="text-2xl font-bold text-purple-400">${totalSpeedrunTime.toFixed(2)}s</div>
                </div>
            ` : ''}

            <div class="mb-4">
                <label class="block mb-2 font-semibold">Your Escape Plan</label>
                <textarea
                    id="prompt-input"
                    class="bg-gray-700 text-white px-4 py-3 rounded focus:outline-none focus:ring-2 focus:ring-green-500 w-full h-32 resize-none"
                    placeholder="Describe how you'll survive this situation... Be creative and detailed!"
                    maxlength="500"
                ></textarea>
                <div class="text-right text-sm text-gray-400 mt-1">
                    <span id="prompt-char-count">0</span>/500 characters
                </div>
            </div>

            <button
                id="submit-prompt"
                class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded transition duration-300 ease-in-out transform hover:scale-105 w-full"
            >
                Submit Escape Plan
            </button>
        </div>
    `;

        const promptInput = document.getElementById('prompt-input');
        const charCount = document.getElementById('prompt-char-count');

        promptInput.addEventListener('input', () => {
            charCount.textContent = promptInput.value.length;
        });

        // Focus on textarea
        promptInput.focus();

        const maxTime = isSpeedrun ? CONFIG.SPEEDRUN_TIME : CONFIG.NORMAL_TIME;

        timerInterval = setInterval(() => {
            timeLeft--;
            const timerEl = document.getElementById('timer');
            const timerBar = document.getElementById('timer-bar');

            if (timerEl) {
                timerEl.textContent = `${timeLeft}s`;
                if (timeLeft <= 10) {
                    timerEl.classList.add('text-red-500', 'animate-pulse');
                    timerEl.classList.remove('text-green-400');
                }
            }

            if (timerBar) {
                const percentage = (timeLeft / maxTime) * 100;
                timerBar.style.width = `${percentage}%`;

                if (timeLeft <= 10) {
                    timerBar.classList.remove('bg-green-500');
                    timerBar.classList.add('bg-red-500');
                }
            }

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitPrompt(scenario);
            }
        }, 1000);

        if (isSpeedrun) {
            speedrunInterval = setInterval(updateSpeedrunTime, 10);
        }

        document.getElementById('submit-prompt').addEventListener('click', () => {
            submitPrompt(scenario);
        });

        // Allow Enter to submit (with Shift+Enter for new lines)
        promptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitPrompt(scenario);
            }
        });
    }

    function updateSpeedrunTime() {
        const speedrunTimerEl = document.getElementById('speedrun-timer');
        if (speedrunTimerEl) {
            const currentTime = Date.now();
            const elapsedTime = (currentTime - roundStartTime) / 1000;
            const displayTime = totalSpeedrunTime + elapsedTime;
            speedrunTimerEl.textContent = `${displayTime.toFixed(2)}s`;
        }
    }

    async function submitPrompt(scenario) {
        clearAllIntervals();

        let roundTime = 0;
        if (isSpeedrun) {
            const endTime = Date.now();
            roundTime = (endTime - roundStartTime) / 1000;
            totalSpeedrunTime += roundTime;
        }

        const promptInput = document.getElementById('prompt-input');
        const prompt = promptInput ? promptInput.value.trim() : '';

        if (!prompt) {
            showTemporaryMessage("You must enter an escape plan!", "error");
            renderPromptInput(scenario);
            return;
        }

        showLoadingState("The AI is deciding your fate...");

        try {
            const fate = await evaluatePrompt(scenario, prompt);

            // Update game state
            if (fate.survived) {
                playerScore++;
                streak++;
                xp += 10 * (streak + 1);
            } else {
                streak = 0;
                xp += 5;
            }

            localStorage.setItem('deathByAIXP', xp.toString());

            // Render result
            renderFateResult(fate, scenario, roundTime);
        } catch (error) {
            console.error('Critical error in submitPrompt:', error);
            hideLoadingState();
            showErrorScreen(scenario);
        }
    }

    function renderFateResult(fate, scenario, roundTime) {
        hideLoadingState();

        const resultColor = fate.survived ? 'green' : 'red';
        const resultIcon = fate.survived ? '‚úÖ' : 'üíÄ';
        const resultText = fate.survived ? 'You Survived!' : 'You Died!';

        appContainer.innerHTML = `
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl fade-in">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">${resultIcon}</div>
                <h2 class="text-4xl mb-2 text-${resultColor}-400 font-bold">${resultText}</h2>
            </div>

            <div class="bg-gray-700 p-6 rounded-lg mb-6">
                <h3 class="text-lg font-semibold mb-2 text-gray-300">What Happened:</h3>
                <p class="text-lg leading-relaxed">${fate.explanation}</p>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-700 p-4 rounded text-center">
                    <div class="text-sm text-gray-400">Score</div>
                    <div class="text-2xl font-bold text-green-400">${playerScore}/5</div>
                </div>
                <div class="bg-gray-700 p-4 rounded text-center">
                    <div class="text-sm text-gray-400">Streak</div>
                    <div class="text-2xl font-bold text-yellow-400">${streak} üî•</div>
                </div>
                <div class="bg-gray-700 p-4 rounded text-center">
                    <div class="text-sm text-gray-400">XP Gained</div>
                    <div class="text-2xl font-bold text-purple-400">+${fate.survived ? 10 * streak : 5}</div>
                </div>
                <div class="bg-gray-700 p-4 rounded text-center">
                    <div class="text-sm text-gray-400">Round</div>
                    <div class="text-2xl font-bold text-blue-400">${currentRound}/5</div>
                </div>
            </div>

            ${isSpeedrun ? `
                <div class="bg-purple-900 bg-opacity-50 p-4 rounded mb-6">
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <div class="text-sm text-purple-300">Round Time</div>
                            <div class="text-xl font-bold text-purple-400">${roundTime.toFixed(2)}s</div>
                        </div>
                        <div>
                            <div class="text-sm text-purple-300">Total Time</div>
                            <div class="text-xl font-bold text-purple-400">${totalSpeedrunTime.toFixed(2)}s</div>
                        </div>
                    </div>
                </div>
            ` : ''}

            <button
                id="next-round"
                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded transition duration-300 ease-in-out transform hover:scale-105 w-full"
            >
                ${currentRound < 5 ? 'Next Round ‚Üí' : 'View Final Score'}
            </button>
        </div>
    `;

        document.getElementById('next-round').addEventListener('click', nextRound);
    }

    function showErrorScreen(scenario) {
        appContainer.innerHTML = `
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl fade-in">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                <h2 class="text-3xl mb-2 text-yellow-400 font-bold">Connection Issue</h2>
            </div>

            <div class="bg-gray-700 p-6 rounded-lg mb-6">
                <p class="text-lg leading-relaxed mb-4">
                    We're having trouble connecting to the AI service. This might be due to:
                </p>
                <ul class="list-disc list-inside space-y-2 text-gray-300">
                    <li>Network connectivity issues</li>
                    <li>API service temporarily unavailable</li>
                    <li>High server load</li>
                </ul>
            </div>

            <div class="space-y-3">
                <button
                    id="retry"
                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded transition duration-300 w-full"
                >
                    Try Again
                </button>

                <button
                    id="skip-round"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded transition duration-300 w-full"
                >
                    Skip This Round
                </button>

                <button
                    id="end-game"
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded transition duration-300 w-full"
                >
                    End Game
                </button>
            </div>
        </div>
    `;

        document.getElementById('retry').addEventListener('click', () => {
            renderPromptInput(scenario);
        });

        document.getElementById('skip-round').addEventListener('click', () => {
            nextRound();
        });

        document.getElementById('end-game').addEventListener('click', () => {
            renderScoreboard();
        });
    }

    function renderScoreboard() {
        const highScore = Math.max(playerScore, parseInt(localStorage.getItem('deathByAIHighScore') || '0'));
        localStorage.setItem('deathByAIHighScore', highScore.toString());

        let speedrunHighScore = parseFloat(localStorage.getItem('deathByAISpeedrunHighScore') || '999999');
        let isNewSpeedrunRecord = false;

        if (isSpeedrun && playerScore === 5 && totalSpeedrunTime < speedrunHighScore) {
            speedrunHighScore = totalSpeedrunTime;
            localStorage.setItem('deathByAISpeedrunHighScore', speedrunHighScore.toString());
            isNewSpeedrunRecord = true;
        }

        const isNewHighScore = playerScore > parseInt(localStorage.getItem('deathByAIHighScore') || '0') - playerScore;

        let performanceRating = '';
        let performanceColor = '';
        if (playerScore === 5) {
            performanceRating = 'Perfect Run!';
            performanceColor = 'text-yellow-400';
        } else if (playerScore >= 4) {
            performanceRating = 'Excellent!';
            performanceColor = 'text-green-400';
        } else if (playerScore >= 3) {
            performanceRating = 'Good Job!';
            performanceColor = 'text-blue-400';
        } else if (playerScore >= 2) {
            performanceRating = 'Not Bad!';
            performanceColor = 'text-purple-400';
        } else {
            performanceRating = 'Keep Trying!';
            performanceColor = 'text-gray-400';
        }

        appContainer.innerHTML = `
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl fade-in">
            <div class="text-center mb-6">
                <h2 class="text-4xl mb-2 text-green-400 font-bold">Game Over</h2>
                <p class="text-2xl ${performanceColor} font-semibold">${performanceRating}</p>
            </div>

            ${isNewHighScore ? `
                <div class="bg-yellow-900 bg-opacity-50 border-2 border-yellow-400 p-4 rounded-lg mb-6 text-center animate-pulse">
                    <p class="text-xl text-yellow-400 font-bold">üéâ NEW HIGH SCORE! üéâ</p>
                </div>
            ` : ''}

            ${isNewSpeedrunRecord ? `
                <div class="bg-purple-900 bg-opacity-50 border-2 border-purple-400 p-4 rounded-lg mb-6 text-center animate-pulse">
                    <p class="text-xl text-purple-400 font-bold">‚ö° NEW SPEEDRUN RECORD! ‚ö°</p>
                </div>
            ` : ''}

            <div class="bg-gray-700 p-6 rounded-lg mb-6">
                <div class="flex items-center justify-center mb-4">
                    <span class="text-4xl mr-3">${playerAvatar}</span>
                    <span class="text-2xl font-bold">${playerName}</span>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="text-center">
                        <div class="text-sm text-gray-400">Final Score</div>
                        <div class="text-3xl font-bold text-green-400">${playerScore}/5</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm text-gray-400">High Score</div>
                        <div class="text-3xl font-bold text-yellow-400">${highScore}/5</div>
                    </div>
                </div>

                ${isSpeedrun ? `
                    <div class="bg-purple-900 bg-opacity-50 p-4 rounded mt-4">
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <div class="text-sm text-purple-300">Your Time</div>
                                <div class="text-2xl font-bold text-purple-400">${totalSpeedrunTime.toFixed(2)}s</div>
                            </div>
                            <div>
                                <div class="text-sm text-purple-300">Best Time</div>
                                <div class="text-2xl font-bold text-purple-400">${speedrunHighScore === 999999 ? 'N/A' : speedrunHighScore.toFixed(2) + 's'}</div>
                            </div>
                        </div>
                    </div>
                ` : ''}
            </div>

            <div class="bg-purple-900 bg-opacity-50 p-6 rounded-lg mb-6 text-center">
                <div class="text-sm text-purple-300 mb-1">Total Experience</div>
                <div class="text-4xl font-bold text-purple-400">${xp} XP</div>
                <div class="w-full bg-gray-700 rounded-full h-3 mt-4">
                    <div class="bg-purple-500 h-3 rounded-full" style="width: ${(xp % 100)}%"></div>
                </div>
                <p class="text-sm text-gray-400 mt-2">${100 - (xp % 100)} XP until next unlock</p>
            </div>

            <div class="space-y-3">
                <button
                    id="new-game"
                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded transition duration-300 ease-in-out transform hover:scale-105 w-full"
                >
                    Play Again
                </button>

                <button
                    id="how-to-play"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded transition duration-300 ease-in-out transform hover:scale-105 w-full"
                >
                    How to Play
                </button>
            </div>
        </div>
    `;

        document.getElementById('new-game').addEventListener('click', startGame);
        document.getElementById('how-to-play').addEventListener('click', showTutorial);
    }

    function showTutorial() {
        appContainer.innerHTML = `
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl fade-in">
            <h2 class="text-3xl mb-6 text-green-400 font-bold text-center">How to Play</h2>

            <div class="bg-gray-700 p-6 rounded-lg mb-6">
                <h3 class="text-xl font-semibold mb-4 text-green-400">Game Rules</h3>
                <ol class="space-y-3 list-decimal list-inside">
                    <li class="text-gray-300">Create your character and choose your settings</li>
                    <li class="text-gray-300">Select a difficulty level (or random for variety)</li>
                    <li class="text-gray-300">Face 5 unique dangerous scenarios</li>
                    <li class="text-gray-300">Write your escape plan within the time limit</li>
                    <li class="text-gray-300">The AI judges if you survive based on your creativity</li>
                    <li class="text-gray-300">Try to survive all 5 rounds!</li>
                </ol>
            </div>

            <div class="bg-gray-700 p-6 rounded-lg mb-6">
                <h3 class="text-xl font-semibold mb-4 text-blue-400">Tips for Success</h3>
                <ul class="space-y-2">
                    <li class="text-gray-300">‚úì Be creative and detailed in your escape plans</li>
                    <li class="text-gray-300">‚úì Consider the difficulty when crafting responses</li>
                    <li class="text-gray-300">‚úì Build survival streaks for bonus XP</li>
                    <li class="text-gray-300">‚úì Think logically about the scenario's physics</li>
                    <li class="text-gray-300">‚úì Use available resources in your plan</li>
                </ul>
            </div>

            <div class="bg-gray-700 p-6 rounded-lg mb-6">
                <h3 class="text-xl font-semibold mb-4 text-purple-400">Progression System</h3>
                <ul class="space-y-2">
                    <li class="text-gray-300">üåü Earn XP by surviving scenarios</li>
                    <li class="text-gray-300">üî• Build streaks for bonus XP multipliers</li>
                    <li class="text-gray-300">üîì Unlock new avatars every 100 XP</li>
                    <li class="text-gray-300">‚ö° Try speedrun mode for faster challenges</li>
                </ul>
            </div>

            <button
                id="back-to-menu"
                class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded transition duration-300 ease-in-out transform hover:scale-105 w-full"
            >
                Back to Menu
            </button>
        </div>
    `;

        document.getElementById('back-to-menu').addEventListener('click', startGame);
    }

    function showLoadingState(message) {
        const loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'loading-overlay';
        loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50';
        loadingOverlay.innerHTML = `
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl text-white text-center max-w-md">
            <div class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-green-500 mx-auto mb-6"></div>
            <p class="text-xl font-semibold">${message}</p>
            <p class="text-sm text-gray-400 mt-2">This may take a few seconds...</p>
        </div>
    `;
        document.body.appendChild(loadingOverlay);
    }

    function hideLoadingState() {
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
            loadingOverlay.remove();
        }
    }

    function showTemporaryMessage(message, type = 'info') {
        const colors = {
            'error': 'bg-red-500',
            'success': 'bg-green-500',
            'info': 'bg-blue-500'
        };

        const messageDiv = document.createElement('div');
        messageDiv.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`;
        messageDiv.textContent = message;
        document.body.appendChild(messageDiv);

        setTimeout(() => {
            messageDiv.remove();
        }, 3000);
    }

    // Initialize game
    function initGame() {
        xp = parseInt(localStorage.getItem('deathByAIXP') || '0');
        const bgClass = backgrounds[Math.min(Math.floor(xp / 500), backgrounds.length - 1)];
        document.body.className = `${bgClass} text-white min-h-screen flex items-center justify-center`;
        startGame();
    }

    // Start the game when page loads
    initGame();
</script>
<script src="../logo.js"></script>
</body>
</html>