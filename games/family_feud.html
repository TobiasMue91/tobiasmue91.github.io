<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</text></svg>">
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
    <title>Family Feud Online</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/json5/2.2.3/index.min.js"
            integrity="sha512-44jdhc+R2TFfzBflS3/dGNEABiNUxBkkrqwO7GWTvGsj3HkQNr3GESvI9PUvAxmqxSnTosR0Ij9y3+o+6J1hig=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: #f3f4f6;
            color: #1f2937;
            line-height: 1.6
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px
        }

        .header {
            text-align: center;
            margin-bottom: 30px
        }

        .header h1 {
            color: #1e3a8a;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700
        }

        .card {
            background: #fff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px
        }

        .topic-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center
        }

        .topic-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%
        }

        .topic-controls select, .topic-controls input {
            flex: 1;
            min-width: 150px;
            max-width: 200px;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s
        }

        .topic-controls select:focus, .topic-controls input:focus {
            outline: none;
            border-color: #1e3a8a
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit
        }

        .btn-primary {
            background: #1e3a8a;
            color: #fff
        }

        .btn-primary:hover:not(:disabled) {
            background: #1e40af;
            transform: translateY(-1px)
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed
        }

        .btn-secondary {
            background: #6b7280;
            color: #fff
        }

        .btn-secondary:hover {
            background: #4b5563
        }

        .btn-success {
            background: #10b981;
            color: #fff
        }

        .btn-success:hover {
            background: #059669
        }

        .btn-danger {
            background: #ef4444;
            color: #fff
        }

        .btn-danger:hover {
            background: #dc2626
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px
        }

        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px
        }

        .info-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500
        }

        .info-value {
            font-size: 24px;
            font-weight: 700;
            color: #1e3a8a
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            position: relative
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            font-size: 14px
        }

        .question-card {
            text-align: center;
            font-size: 1.4rem;
            font-weight: 500;
            color: #1f2937;
            padding: 20px;
            background: #fef3c7;
            border-radius: 8px;
            border-left: 4px solid #f59e0b
        }

        .board {
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .answer-slot {
            display: flex;
            align-items: center;
            height: 60px;
            background: #1e3a8a;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative
        }

        .answer-slot:hover:not(.revealed) {
            background: #1e40af
        }

        .answer-slot.revealed {
            background: #10b981;
            cursor: default;
            animation: revealPulse 0.5s
        }

        .answer-number {
            width: 60px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            background: rgba(0, 0, 0, 0.2);
            border-right: 2px solid rgba(255, 255, 255, 0.1)
        }

        .answer-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 20px;
            font-weight: 500;
            padding: 0 20px
        }

        .answer-slot:not(.revealed) .answer-content {
            color: transparent;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5)
        }

        .answer-input-section {
            display: flex;
            gap: 10px;
            margin-top: 20px
        }

        .answer-input-section input {
            flex: 1;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 18px;
            transition: border-color 0.3s
        }

        .answer-input-section input:focus {
            outline: none;
            border-color: #1e3a8a
        }

        .message {
            padding: 15px 20px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            margin-bottom: 20px;
            transition: all 0.3s
        }

        .message.info {
            background: #dbeafe;
            color: #1e3a8a;
            border-left: 4px solid #3b82f6
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444
        }

        .message.warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b
        }

        .strikes {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center
        }

        .strike {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s
        }

        .strike.active {
            background: #ef4444;
            animation: strikeShake 0.5s
        }

        .wrong-answers-section {
            margin-top: 20px
        }

        .wrong-answers-title {
            font-weight: 700;
            color: #ef4444;
            margin-bottom: 10px;
            font-size: 18px
        }

        .wrong-answers-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px
        }

        .wrong-answer-tag {
            background: #fee2e2;
            color: #991b1b;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap
        }

        .game-mode {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 15px
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none
        }

        .checkbox-label input {
            width: 18px;
            height: 18px;
            cursor: pointer
        }

        .hint-section {
            text-align: center;
            margin-top: 15px
        }

        .hint-text {
            font-size: 18px;
            color: #6b7280;
            font-weight: 500
        }

        .about {
            margin-top: 40px;
            text-align: center;
            color: #6b7280;
            font-size: 14px;
            line-height: 1.8
        }

        .about h3 {
            color: #1e3a8a;
            margin-bottom: 10px
        }

        @keyframes revealPulse {
            0%, 100% {
                transform: scale(1)
            }
            50% {
                transform: scale(1.02)
            }
        }

        @keyframes strikeShake {
            0%, 100% {
                transform: rotate(0)
            }
            25% {
                transform: rotate(-10deg)
            }
            75% {
                transform: rotate(10deg)
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px)
            }
            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem
            }

            .question-card {
                font-size: 1.2rem
            }

            .answer-content {
                font-size: 18px
            }

            .answer-number {
                font-size: 20px;
                width: 50px
            }

            .topic-controls {
                flex-direction: column
            }

            .topic-controls select, .topic-controls input {
                max-width: 100%
            }

            .game-info {
                justify-content: center
            }
        }

        .hidden {
            display: none !important
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üéÆ Family Feud Online</h1>
    </div>
    <div class="card" id="setup-card">
        <div class="message info">Select a topic or enter your own. Leave empty for random questions. Try different
            languages!
        </div>
        <div class="topic-section">
            <div class="topic-controls">
                <select id="topic-select">
                    <option value="random">Random</option>
                    <option value="food">Food</option>
                    <option value="movies">Movies</option>
                    <option value="gaming">Gaming</option>
                    <option value="sports">Sports</option>
                    <option value="music">Music</option>
                    <option value="tv shows">TV Shows</option>
                    <option value="travel">Travel</option>
                    <option value="technology">Technology</option>
                    <option value="animals">Animals</option>
                </select>
                <input type="text" id="topic-input" placeholder="Custom Topic" maxlength="50"/>
            </div>
            <div class="game-mode">
                <label class="checkbox-label">
                    <input type="checkbox" id="strikes-mode"/>
                    <span>3 Strikes Mode</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="hints-enabled"/>
                    <span>Enable Hints</span>
                </label>
            </div>
            <button class="btn btn-primary" id="start-btn">Start Game</button>
        </div>
    </div>
    <div class="card hidden" id="game-card">
        <div class="game-info">
            <div class="info-item">
                <span class="info-label">Score</span>
                <span class="info-value" id="score-display">0/100</span>
            </div>
            <div class="info-item">
                <span class="info-label">Found</span>
                <span class="info-value" id="found-display">0/8</span>
            </div>
            <div class="info-item" id="strikes-display" style="display:none">
                <span class="info-label">Strikes</span>
                <div class="strikes" id="strikes-container"></div>
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill">0%</div>
        </div>
    </div>
    <div class="card hidden" id="question-card">
        <div class="question-card" id="question-text"></div>
    </div>
    <div class="card hidden" id="board-card">
        <div class="board" id="board"></div>
        <div class="answer-input-section">
            <input type="text" id="answer-input" placeholder="Type your answer..." autocomplete="off"/>
            <button class="btn btn-primary" id="submit-btn">Submit</button>
        </div>
        <div class="hint-section hidden" id="hint-section">
            <div class="hint-text" id="hint-text"></div>
        </div>
    </div>
    <div class="card hidden" id="wrong-answers-card">
        <div class="wrong-answers-section">
            <div class="wrong-answers-title">‚ùå Wrong Answers</div>
            <div class="wrong-answers-list" id="wrong-answers-list"></div>
        </div>
    </div>
    <div class="card hidden" id="message-card">
        <div class="message info" id="game-message"></div>
    </div>
    <div class="controls hidden" id="game-controls">
        <button class="btn btn-secondary" id="hint-btn">Get Hint</button>
        <button class="btn btn-danger" id="reveal-btn">Reveal Answers</button>
        <button class="btn btn-success" id="save-btn">Save & Share</button>
        <button class="btn btn-primary" id="play-again-btn">Play Again</button>
    </div>
    <div class="about">
        <h3>About Family Feud Online</h3>
        <p>Guess the top answers from our survey! Each correct answer earns points. Reach 100 points to win. Play solo
            or with friends. Enable 3 Strikes Mode for an extra challenge!</p>
    </div>
</div>
<script src="js/fireworks.js"></script>
<script type="module">
    const CONSTANTS = {MAX_SCORE: 100, ANSWER_COUNT: 8, MAX_STRIKES: 3, LEVENSHTEIN_THRESHOLD: 0.3};
    const state = {
        question: '',
        answers: [],
        correctAnswers: '',
        score: 0,
        foundCount: 0,
        wrongAnswers: [],
        strikes: 0,
        gameStarted: false,
        gameFinished: false,
        strikesMode: false,
        hintsEnabled: false,
        hintsUsed: []
    };
    const elements = {
        setupCard: document.getElementById('setup-card'),
        gameCard: document.getElementById('game-card'),
        questionCard: document.getElementById('question-card'),
        boardCard: document.getElementById('board-card'),
        wrongAnswersCard: document.getElementById('wrong-answers-card'),
        messageCard: document.getElementById('message-card'),
        gameControls: document.getElementById('game-controls'),
        topicSelect: document.getElementById('topic-select'),
        topicInput: document.getElementById('topic-input'),
        startBtn: document.getElementById('start-btn'),
        board: document.getElementById('board'),
        questionText: document.getElementById('question-text'),
        answerInput: document.getElementById('answer-input'),
        submitBtn: document.getElementById('submit-btn'),
        scoreDisplay: document.getElementById('score-display'),
        foundDisplay: document.getElementById('found-display'),
        progressFill: document.getElementById('progress-fill'),
        wrongAnswersList: document.getElementById('wrong-answers-list'),
        gameMessage: document.getElementById('game-message'),
        strikesContainer: document.getElementById('strikes-container'),
        strikesDisplay: document.getElementById('strikes-display'),
        hintBtn: document.getElementById('hint-btn'),
        revealBtn: document.getElementById('reveal-btn'),
        saveBtn: document.getElementById('save-btn'),
        playAgainBtn: document.getElementById('play-again-btn'),
        strikesMode: document.getElementById('strikes-mode'),
        hintsEnabled: document.getElementById('hints-enabled'),
        hintSection: document.getElementById('hint-section'),
        hintText: document.getElementById('hint-text')
    };
    import {db} from '../firebase.js';
    import {doc, setDoc, getDoc} from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

    function showMessage(text, type = 'info') {
        elements.gameMessage.textContent = text;
        elements.gameMessage.className = `message ${type}`;
        elements.messageCard.classList.remove('hidden')
    }

    function updateUI() {
        elements.scoreDisplay.textContent = `${state.score}/${CONSTANTS.MAX_SCORE}`;
        elements.foundDisplay.textContent = `${state.foundCount}/${CONSTANTS.ANSWER_COUNT}`;
        const progress = Math.min((state.score / CONSTANTS.MAX_SCORE) * 100, 100);
        elements.progressFill.style.width = `${progress}%`;
        elements.progressFill.textContent = `${Math.round(progress)}%`;
        if (state.strikesMode) {
            elements.strikesDisplay.style.display = 'block';
            elements.strikesContainer.innerHTML = '';
            for (let i = 0; i < CONSTANTS.MAX_STRIKES; i++) {
                const strike = document.createElement('div');
                strike.className = `strike ${i < state.strikes ? 'active' : ''}`;
                strike.textContent = i < state.strikes ? '‚úñ' : '';
                elements.strikesContainer.appendChild(strike)
            }
        }
    }

    function createBoard() {
        elements.board.innerHTML = '';
        let total = 0;
        state.answers.forEach((answer, index) => {
            total += answer.value;
            const slot = document.createElement('div');
            slot.className = 'answer-slot';
            slot.dataset.index = index;
            slot.innerHTML = `<div class="answer-number">${answer.value}</div><div class="answer-content"></div>`;
            answer.element = slot;
            elements.board.appendChild(slot)
        });
        if (total < CONSTANTS.MAX_SCORE) {
            const diff = CONSTANTS.MAX_SCORE - total;
            state.answers[0].value += diff;
            state.answers[0].element.querySelector('.answer-number').textContent = state.answers[0].value
        }
    }

    function levenshteinDistance(a, b) {
        if (a.length === 0) return b.length;
        if (b.length === 0) return a.length;
        const matrix = [];
        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                matrix[i][j] = b.charAt(i - 1) === a.charAt(j - 1) ? matrix[i - 1][j - 1] : Math.min(matrix[i - 1][j - 1] + 1, Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1))
            }
        }
        return matrix[b.length][a.length]
    }

    function validateAnswer(userInput) {
        const normalized = userInput.toLowerCase().trim();
        for (let i = 0; i < state.answers.length; i++) {
            if (state.answers[i].revealed) continue;
            const validAnswer = state.answers[i].answer.toLowerCase();
            const distance = levenshteinDistance(normalized, validAnswer);
            if (distance <= Math.round(validAnswer.length * CONSTANTS.LEVENSHTEIN_THRESHOLD)) return i;
            const words = validAnswer.split(/[^a-z-]+/);
            for (const word of words) {
                if (word.length < 3) continue;
                const wordDist = levenshteinDistance(normalized, word);
                if (wordDist <= Math.round(word.length * CONSTANTS.LEVENSHTEIN_THRESHOLD)) return i
            }
        }
        return -1
    }

    function revealAnswer(index) {
        const answer = state.answers[index];
        answer.revealed = true;
        const content = answer.element.querySelector('.answer-content');
        content.textContent = answer.answer;
        answer.element.classList.add('revealed');
        state.score += answer.value;
        state.foundCount++;
        updateUI();
        if (state.score >= CONSTANTS.MAX_SCORE) {
            endGame(true)
        } else {
            showMessage(`Correct! +${answer.value} points`, 'success')
        }
    }

    function handleWrongAnswer(userAnswer) {
        state.wrongAnswers.push(userAnswer);
        const tag = document.createElement('div');
        tag.className = 'wrong-answer-tag fade-in';
        tag.textContent = userAnswer;
        elements.wrongAnswersList.appendChild(tag);
        elements.wrongAnswersCard.classList.remove('hidden');
        if (state.strikesMode) {
            state.strikes++;
            updateUI();
            if (state.strikes >= CONSTANTS.MAX_STRIKES) {
                endGame(false);
                return
            }
        }
        showMessage('Wrong answer! Try again.', 'error')
    }

    function checkAnswer() {
        const answer = elements.answerInput.value.trim();
        if (!answer) return;
        const index = validateAnswer(answer);
        if (index >= 0) {
            revealAnswer(index)
        } else {
            handleWrongAnswer(answer)
        }
        elements.answerInput.value = '';
        elements.answerInput.focus()
    }

    function getHint() {
        const unrevealed = state.answers.filter((a, i) => !a.revealed && !state.hintsUsed.includes(i));
        if (unrevealed.length === 0) return;
        const randomAnswer = unrevealed[Math.floor(Math.random() * unrevealed.length)];
        const index = state.answers.indexOf(randomAnswer);
        state.hintsUsed.push(index);
        const firstLetter = randomAnswer.answer.charAt(0).toUpperCase();
        const length = randomAnswer.answer.length;
        elements.hintText.textContent = `üí° Hint: Starts with "${firstLetter}" (${length} letters)`;
        elements.hintSection.classList.remove('hidden')
    }

    function revealAllAnswers() {
        state.answers.forEach((answer, index) => {
            if (!answer.revealed) {
                const content = answer.element.querySelector('.answer-content');
                content.textContent = answer.answer;
                answer.element.classList.add('revealed');
                answer.revealed = true
            }
        });
        showMessage('All answers revealed!', 'warning');
        state.gameFinished = true;
        elements.gameControls.classList.remove('hidden')
    }

    function endGame(won) {
        state.gameFinished = true;
        if (won) {
            showMessage(`üéâ Congratulations! You won with ${state.score} points!`, 'success');
            playFirework()
        } else {
            showMessage(`Game Over! You got ${state.strikes} strikes. Final score: ${state.score}`, 'error');
            revealAllAnswers()
        }
        elements.answerInput.disabled = true;
        elements.submitBtn.disabled = true;
        elements.gameControls.classList.remove('hidden')
    }

    async function saveCombination() {
        try {
            const answers = JSON.parse(state.correctAnswers).map(a => ({answer: a.answer, value: a.value}));
            const id = Date.now().toString() + Math.floor(Math.random() * 1000000);
            await setDoc(doc(db, 'combinations', id), {question: state.question, answers});
            const url = `${window.location.href.split('?')[0]}?combinationId=${id}`;
            showMessage(`Saved! Share: <a href="${url}" target="_blank" style="color:#1e3a8a;font-weight:700">${url}</a>`, 'success');
            elements.messageCard.querySelector('.message').innerHTML = `Saved! Share: <a href="${url}" target="_blank" style="color:#1e3a8a;font-weight:700">${url}</a>`;
            elements.saveBtn.style.display = 'none'
        } catch (e) {
            showMessage('Error saving. Please try again.', 'error')
        }
    }

    async function startGame() {
        const topic = elements.topicInput.value || elements.topicSelect.value || 'random';
        state.strikesMode = elements.strikesMode.checked;
        state.hintsEnabled = elements.hintsEnabled.checked;
        elements.startBtn.disabled = true;
        showMessage('Loading question... Please wait...');
        try {
            const response = await fetch('https://chatgpt.tobiasmue91.workers.dev/', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    max_tokens: 2048,
                    messages: [{
                        role: 'assistant',
                        content: "As an API for a Family Feud game, I will receive one input parameter called 'topic' and create a random question in the style of Family Feud based on that topic. If the topic is 'random', I will create a random question for a random topic. If the topic is in a language other than English, the resulting question and answers will be in that language too. I will create 8 answers with appropriate values that represent the number of (imaginary) people who voted for that answer. The answers will represent answers that would realistically be given by common people.\nThe response will be in JSON format. E.g.:\n```\n{\n  'question': 'Name a popular pizza topping.',\n  'answers': [\n    {'answer': 'Pepperoni', 'value': 35},\n    {'answer': 'Cheese', 'value': 20},\n    {'answer': 'Sausage', 'value': 15},\n    {'answer': 'Mushrooms', 'value': 10},\n    {'answer': 'Onions', 'value': 5},\n    {'answer': 'Ham', 'value': 5},\n    {'answer': 'Pineapple', 'value': 5},\n    {'answer': 'Olives', 'value': 5}\n  ]\n}\n```\n\nPlease provide a topic.\n\n"
                    }, {role: 'user', content: `Topic: ${topic}.`}],
                    temperature: 0.7,
                    top_p: 0.3
                })
            });
            const data = await response.json();
            const content = data.choices[0].message.content;
            const jsonStr = content.substring(content.indexOf('{'), content.lastIndexOf('}') + 1);
            const jsonData = JSON5.parse(jsonStr);
            state.question = jsonData.question;
            state.answers = jsonData.answers.map(a => ({...a, revealed: false}));
            state.correctAnswers = JSON.stringify(state.answers);
            state.score = 0;
            state.foundCount = 0;
            state.wrongAnswers = [];
            state.strikes = 0;
            state.hintsUsed = [];
            state.gameStarted = true;
            state.gameFinished = false;
            elements.setupCard.classList.add('hidden');
            elements.gameCard.classList.remove('hidden');
            elements.questionCard.classList.remove('hidden');
            elements.boardCard.classList.remove('hidden');
            elements.gameControls.classList.remove('hidden');
            elements.questionText.textContent = state.question;
            createBoard();
            updateUI();
            showMessage('Type your answer and click Submit!', 'info');
            elements.answerInput.focus();
            if (!state.hintsEnabled) elements.hintBtn.style.display = 'none'
        } catch (error) {
            showMessage('Error loading question. Please try again.', 'error');
            elements.startBtn.disabled = false
        }
    }

    async function loadSavedCombination(id) {
        try {
            const docSnap = await getDoc(doc(db, 'combinations', id));
            if (!docSnap.exists()) {
                showMessage('Saved combination not found.', 'error');
                return
            }
            const data = docSnap.data();
            state.question = data.question;
            state.answers = data.answers.map(a => ({...a, revealed: false}));
            state.correctAnswers = JSON.stringify(data.answers);
            state.score = 0;
            state.foundCount = 0;
            state.wrongAnswers = [];
            state.strikes = 0;
            state.hintsUsed = [];
            state.gameStarted = true;
            state.gameFinished = false;
            state.strikesMode = elements.strikesMode.checked;
            state.hintsEnabled = elements.hintsEnabled.checked;
            elements.setupCard.classList.add('hidden');
            elements.gameCard.classList.remove('hidden');
            elements.questionCard.classList.remove('hidden');
            elements.boardCard.classList.remove('hidden');
            elements.gameControls.classList.remove('hidden');
            elements.questionText.textContent = state.question;
            createBoard();
            updateUI();
            showMessage('Type your answer and click Submit!', 'info');
            elements.answerInput.focus();
            if (!state.hintsEnabled) elements.hintBtn.style.display = 'none'
        } catch (error) {
            showMessage('Error loading saved game.', 'error')
        }
    }

    elements.startBtn.addEventListener('click', startGame);
    elements.submitBtn.addEventListener('click', checkAnswer);
    elements.hintBtn.addEventListener('click', getHint);
    elements.revealBtn.addEventListener('click', revealAllAnswers);
    elements.saveBtn.addEventListener('click', saveCombination);
    elements.playAgainBtn.addEventListener('click', () => window.location.reload());
    elements.answerInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') checkAnswer()
    });
    elements.topicInput.addEventListener('keypress', e => {
        if (e.key === 'Enter' && !elements.startBtn.disabled) startGame()
    });
    window.addEventListener('load', async () => {
        const params = new URLSearchParams(window.location.search);
        const topic = params.get('topic');
        const combinationId = params.get('combinationId');
        if (combinationId) {
            await loadSavedCombination(combinationId)
        } else if (topic) {
            elements.topicInput.value = topic
        }
    });
</script>
<script src="../logo.js"></script>
</body>
</html>